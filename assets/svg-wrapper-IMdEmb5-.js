import{a as ve,j as d,P as Ae,B as Lt,D as Ft,ae as Me,a3 as Pe}from"./chakra-BZH9ddpD.js";import{c as kt,e as X,A as ie,aN as Yt,aO as ke,ab as Ut,aG as ae,a8 as ce,w as Pt,x as pt,y as mt,aP as Wt,z as wt,a1 as xt,aQ as le,aR as U,a0 as vt,aS as Kt,t as Nt,aT as Vt,aU as Ne,L as tt,p as dt,aV as gt,aW as Ht,n as Mt,aX as Ce,d as de,r as Ct,E as jt,q as ct,aY as _t,aZ as je,a_ as De,a$ as Ee,aK as Dt,G as Ot,H as Bt,aJ as St,b0 as Gt,b1 as Zt,aF as qt,F as ue,S as _e,b2 as Jt,b3 as ze,b4 as Xt,b5 as Le,B as he,D as Tt,b6 as Ie,b7 as $e,b8 as Te,b9 as We,ba as Re,bb as Oe,bc as Be,bd as Qt,be as Fe,bf as Xe,bg as Ye,bh as Ke,am as At,aB as Ve,aC as He,ad as Ue,a9 as Ge}from"./index-FhKndiR_.js";import{s as bt,v as Ze,b as Et,f as fe,e as qe,g as Je}from"./misc-nodes-BkknBNEU.js";import{b as D,h as ye,u as Qe}from"./react-CLIJjNOF.js";import{u as B}from"./useEvent-D-PagYbH.js";import{e as Rt}from"./change-types-DawB6dz5.js";const zt=5,xe=(t,e)=>[...e].filter(i=>t.hasNode(i)),ge=(t,e)=>{const i=e.map(S=>t.getNodeAttribute(S,"x")),a=e.map(S=>t.getNodeAttribute(S,"y")),s=Math.min(...i),n=Math.max(...i),g=Math.min(...a),x=Math.max(...a);return{cx:(s+n)/2,cy:(g+x)/2}},pe=(t,e,i)=>{const a=xe(t,e);if(a.length===0)return!1;const{cx:s,cy:n}=ge(t,a),g=i*Math.PI/180,x=Math.sin(g),S=Math.cos(g);return a.forEach(r=>{const o=t.getNodeAttribute(r,"x"),u=t.getNodeAttribute(r,"y"),l=o-s,f=u-n,y=s+l*S-f*x,b=n+l*x+f*S;t.mergeNodeAttributes(r,{x:Number(y.toFixed(2)),y:Number(b.toFixed(2))})}),!0},tn=(t,e,i)=>{const a=xe(t,e);if(a.length===0)return!1;const{cx:s,cy:n}=ge(t,a);return a.forEach(g=>{const x=t.getNodeAttribute(g,"x"),S=t.getNodeAttribute(g,"y");let r=x,o=S;switch(i){case"vertical":r=2*s-x;break;case"horizontal":o=2*n-S;break;case"diagonal45":{const u=x-s,l=S-n;r=s+l,o=n+u;break}case"diagonal135":{const u=x-s,l=S-n;r=s-l,o=n-u;break}}t.mergeNodeAttributes(g,{x:Number(r.toFixed(2)),y:Number(o.toFixed(2))})}),!0},en={[Ut.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ut.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},nn=t=>{const e=en[t];return e.at(Math.floor(Math.random()*e.length))},te=ye("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:a})=>{const{token:s}=e().account;if(!s){i(Yt({cityName:t,names:[]}));return}const n=await fetch("".concat(ke,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(s)}});if(!n.ok)return ie.warn("Failed to fetch random station names",n.statusText),a(n.statusText);const g=await n.json();i(Yt({cityName:t,names:g}))}),ee=ye("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var x;const{stationNames:a}=e().runtime,s=a[t];if(((x=s==null?void 0:s.length)!=null?x:0)==0)return ie.debug("No random station names in cache, using fallback"),i(te({cityName:t})),Object.values(nn(t));const n=structuredClone(s),g=n.shift();return i(Yt({cityName:t,names:n})),n.length<3&&i(te({cityName:t})),Object.values(g)}),me=()=>{const t=kt(),{activeSubscriptions:e}=X(s=>s.account),{preference:{randomStationsNames:i}}=X(s=>s.app),a=!e.RMP_CLOUD||i==="none";return D.useCallback(async s=>{const n=bt[s].defaultAttrs.names;if(!a){const g=await t(ee(i));if(ee.fulfilled.match(g)){const x=g.payload;return n.length>x.length?x.push(...Array(n.length-x.length).fill(x.at(-1))):n.length<x.length&&x.splice(n.length),x}}return structuredClone(n)},[t,a,i])},sn=({isOpen:t,position:e,onClose:i})=>{const{t:a}=Qe(),s=kt(),n=D.useRef(window.graph),{activeSubscriptions:g}=X(A=>A.account),{preference:{autoParallel:x}}=X(A=>A.app),{svgViewBoxZoom:S,svgViewBoxMin:r}=X(A=>A.param),{selected:o,count:{masters:u,lines:l}}=X(A=>A.runtime),f=!g.RMP_CLOUD&&u+1>ae,y=!x||x&&!g.RMP_CLOUD&&l+1>ce,b=o.size>0,m=D.useMemo(()=>[...o].filter(A=>n.current.hasNode(A)).length>1,[o]),N=D.useRef(null);ve({ref:N,handler:i,enabled:t});const p=D.useCallback(()=>{s(Pt(n.current.export())),s(pt()),s(mt())},[s]),M=B(()=>{if(o.size>0){const A=Wt(n.current,o);navigator.clipboard.writeText(A)}}),c=B(()=>{if(o.size>0){const A=Wt(n.current,o);navigator.clipboard.writeText(A),s(wt()),o.forEach(O=>{n.current.hasNode(O)?n.current.dropNode(O):n.current.hasEdge(O)&&n.current.dropEdge(O)}),p()}}),v=B(async()=>{try{const A=await navigator.clipboard.readText(),{x:O,y:st}=xt(e.x,e.y,S,r),{nodes:ht,edges:ft}=le(A,n.current,f,y,U(O,5),U(st,5));p();const _=structuredClone(ht);ft.forEach(Y=>_.add(Y)),s(vt(_))}catch(A){console.warn("Failed to read clipboard:",A)}}),E=B(()=>{o.size>0&&(s(wt()),o.forEach(A=>{n.current.hasNode(A)?n.current.dropNode(A):n.current.hasEdge(A)&&n.current.dropEdge(A)}),p())}),W=B(()=>{s(pt()),s(mt())}),$=B(A=>{if(o.size>0){const O=Math.min(Math.max(A,-10),10);o.forEach(st=>{n.current.hasNode(st)&&n.current.setNodeAttribute(st,"zIndex",O),n.current.hasEdge(st)&&n.current.setEdgeAttribute(st,"zIndex",O)}),p()}}),Q=B(()=>{if(o.size>0){const[A]=o,O=n.current.hasNode(A)?n.current.getNodeAttribute(A,"zIndex"):n.current.hasEdge(A)?n.current.getEdgeAttribute(A,"zIndex"):0;$(O+1)}}),et=B(()=>{if(o.size>0){const[A]=o;let O=0;n.current.hasNode(A)?O=n.current.getNodeAttribute(A,"zIndex"):n.current.hasEdge(A)&&(O=n.current.getEdgeAttribute(A,"zIndex")),$(O-1)}}),R=B(A=>{pe(n.current,o,A)&&p()}),nt=B(A=>{tn(n.current,o,A)&&p()});return t?d.jsx(Ae,{children:d.jsxs(Lt,{ref:N,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,display:"flex",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[d.jsxs(Lt,{minW:"150px",children:[d.jsx(J,{onClick:()=>{W(),i()},children:a("contextMenu.refresh")}),d.jsx(Ft,{}),d.jsx(J,{onClick:()=>{M(),i()},isDisabled:!b,children:a("contextMenu.copy")}),d.jsx(J,{onClick:()=>{c(),i()},isDisabled:!b,children:a("contextMenu.cut")}),d.jsx(J,{onClick:()=>{v(),i()},children:a("contextMenu.paste")}),d.jsx(J,{onClick:()=>{E(),i()},isDisabled:!b,children:a("contextMenu.delete")}),d.jsx(Ft,{}),d.jsx(J,{onClick:()=>{$(10),i()},isDisabled:!b,children:a("contextMenu.placeTop")}),d.jsx(J,{onClick:()=>{$(-10),i()},isDisabled:!b,children:a("contextMenu.placeBottom")}),d.jsx(J,{onClick:()=>{$(0),i()},isDisabled:!b,children:a("contextMenu.placeDefault")})]}),d.jsx(Lt,{width:"0.5px",bg:"gray.200",alignSelf:"stretch",_dark:{bg:"gray.600"}}),d.jsxs(Lt,{minW:"150px",children:[d.jsx(J,{onClick:()=>{Q(),i()},isDisabled:!b,children:a("contextMenu.placeUp")}),d.jsx(J,{onClick:()=>{et(),i()},isDisabled:!b,children:a("contextMenu.placeDown")}),d.jsx(Ft,{}),d.jsx(J,{onClick:()=>{R(45),i()},isDisabled:!m,children:a("contextMenu.rotateCW")}),d.jsx(J,{onClick:()=>{R(-45),i()},isDisabled:!m,children:a("contextMenu.rotateCCW")}),d.jsx(J,{onClick:()=>{nt("vertical"),i()},isDisabled:!m,children:a("contextMenu.flipVertical")}),d.jsx(J,{onClick:()=>{nt("horizontal"),i()},isDisabled:!m,children:a("contextMenu.flipHorizontal")}),d.jsx(J,{onClick:()=>{nt("diagonal45"),i()},isDisabled:!m,children:a("contextMenu.flipDiagonal45")}),d.jsx(J,{onClick:()=>{nt("diagonal135"),i()},isDisabled:!m,children:a("contextMenu.flipDiagonal135")})]})]})}):null},J=({children:t,onClick:e,isDisabled:i=!1})=>d.jsx(Lt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),on=D.memo(t=>{const{gridLineOffset:{x:e,y:i,zoom:a},svgWidth:s,svgHeight:n}=t,g={x:e,y:i},{preference:{toolsPanel:{expand:x}}}=X(M=>M.app),r=Me().colorMode==="light"?"#666464":"#D3D3D4",o=Kt(g,a,s,n),u=x?410*a/100:0,l=a>30?a>120?50:25:5,f=a/200,y={startX:U(o.xMin+u-l,l),endX:U(o.xMax+u+l,l),startY:U(o.yMin-l,l),endY:U(o.yMax+l,l)},b=Array.from({length:(y.endX-y.startX)/l+1},(M,c)=>{const v=y.startX+c*l,E=v%(l*5)===0?2*f:f;return d.jsx("line",{x1:v,y1:y.startY,x2:v,y2:y.endY,strokeWidth:E,stroke:r,opacity:"0.5"},"grid_vl_".concat(v))}),m=Array.from({length:(y.endY-y.startY)/l+1},(M,c)=>{const v=y.startY+c*l,E=v%(l*5)===0?2*f:f;return d.jsx("line",{x1:y.startX,y1:v,x2:y.endX,y2:v,strokeWidth:E,stroke:r,opacity:"0.5"},"grid_hl_".concat(v))}),N=Array.from({length:(y.endX-y.startX)/l/5+1},(M,c)=>{const v=U(y.startX,5*l)+c*5*l;return d.jsx("text",{x:v,y:o.yMin+a/5,fontSize:f*25,fill:r,textAnchor:"middle",opacity:"0.5",children:v},"grid_vc_".concat(v))}),p=Array.from({length:(y.endY-y.startY)/l/5+1},(M,c)=>{const v=U(y.startY,5*l)+c*5*l;return d.jsx("text",{x:o.xMin+a/8+u,y:v,fontSize:f*25,fill:r,textAnchor:"start",opacity:"0.5",children:v},"grid_hc_".concat(v))});return d.jsxs("g",{id:"grid-lines",className:"removeMe",children:[b,m,N,p]})},(t,e)=>t.gridLineOffset.x===e.gridLineOffset.x&&t.gridLineOffset.y===e.gridLineOffset.y&&t.gridLineOffset.zoom===e.gridLineOffset.zoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),rn=Ze.component,ne=Vt.generatePath,se=Ne.component,$t=10,an=()=>{var ft;const t=kt(),e=()=>{t(Pt(window.graph.export())),t(pt()),t(mt())},{activeSubscriptions:i}=X(_=>_.account),{telemetry:{project:a},preference:{autoParallel:s,randomStationsNames:n}}=X(_=>_.app),{selected:g,theme:x,count:{mostFrequentStationType:S},lastTool:r}=X(_=>_.runtime),o=me(),u=g.keys().next().value;if(!u.startsWith("stn")&&!u.startsWith("misc_node")||!window.graph.hasNode(u))return;const l=window.graph.neighbors(u);if(l.length===0)return;const f=window.graph.getNodeAttributes(u),y=l.reduce((_,Y)=>{const ot=window.graph.getNodeAttributes(Y);return{x:_.x+ot.x,y:_.y+ot.y}},{x:0,y:0}),b={x:y.x/l.length,y:y.y/l.length},m={x:f.x-b.x,y:f.y-b.y},N={x:f.x+m.x,y:f.y+m.y},p=Math.sign(m.x)===Math.sign(m.y),M={x:N.x-$t,y:N.y+$t*(p?1:-1)},c={x:N.x+$t,y:N.y+$t*(p?-1:1)},v=u.startsWith("stn_"),E=v?window.graph.getNodeAttribute(u,"type"):r!=null&&r.startsWith("station-")?r.slice(8):S,W=bt[E].component,$={visible:!0,zIndex:0,x:c.x,y:c.y,type:E,[E]:bt[E].defaultAttrs};if(v){const _=structuredClone(window.graph.getNodeAttribute(u,E));Object.assign($,{[E]:_})}const Q=window.graph.reduceEdges(u,(_,Y)=>{const ot=window.graph.getEdgeAttributes(Y),{style:yt}=ot;if(yt===Nt.SingleColor){const rt=JSON.stringify(ot[yt].color);rt in _?_[rt]+=1:_[rt]=1}return _},{}),et=(ft=Object.entries(Q).filter(([_,Y])=>Y%2!==0).reduce((_,[Y,ot])=>ot>_.count?{color:JSON.parse(Y),count:ot}:_,{color:null,count:0}).color)!=null?ft:x,R=m.x>0?!(m.x>Math.abs(m.y)):-m.x>Math.abs(m.y),nt=R?"from":"to",A=ne(f.x,M.x,f.y,M.y,{...Vt.defaultAttrs,startFrom:nt}),O=R?"to":"from",st=ne(f.x,c.x,f.y,c.y,{...Vt.defaultAttrs,startFrom:O}),ht=async(_,Y)=>{Y.stopPropagation();const{x:ot,y:yt}=gt(Y);t(Ht({x:ot,y:yt}));const rt=Mt(10),lt=Ce.has(_),V=lt?"stn_".concat(rt):"misc_node_".concat(rt),z=structuredClone(lt&&_===window.graph.getNodeAttribute(u,"type")?window.graph.getNodeAttribute(u,_):{...bt,...Et}[_].defaultAttrs);de.has(_)&&(z.color=x);const I=!i.RMP_CLOUD||n==="none";lt&&!I&&(z.names=await o(_)),window.graph.addNode(V,{visible:!0,zIndex:0,x:lt?c.x:M.x,y:lt?c.y:M.y,type:_,[_]:z}),a&&Ct.event(jt.ADD_STATION,{type:_});const G=tt.Diagonal,it="line_".concat(Mt(10)),[q,Z]=[u,V],H=s?0:-1,K=lt?O:nt;window.graph.addDirectedEdgeWithKey(it,q,Z,{visible:!0,zIndex:0,type:G,[G]:{...structuredClone(ct[G].defaultAttrs),startFrom:K},style:Nt.SingleColor,[Nt.SingleColor]:{color:et},reconcileId:"",parallelIndex:H}),a&&Ct.event(jt.ADD_LINE,{type:G}),e(),t(_t(V)),t(vt(new Set([V])))};return d.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[d.jsx(se,{id:"line_prediction_1",type:tt.Diagonal,path:A,styleAttrs:{color:et},newLine:!0,handlePointerDown:()=>{}}),d.jsx(se,{id:"line_prediction_2",type:tt.Diagonal,path:st,styleAttrs:{color:et},newLine:!0,handlePointerDown:()=>{}}),d.jsx(rn,{id:"misc_node_virtual_prediction_1",attrs:{},x:M.x,y:M.y,handlePointerDown:(_,Y)=>{ht(dt.Virtual,Y)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),d.jsx(W,{id:"stn_virtual_prediction_2",attrs:$,x:c.x,y:c.y,handlePointerDown:(_,Y)=>{ht(E,Y)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},be=(t,e,i,a,s,n)=>{if(!("offsetFrom"in n)||!("offsetTo"in n)||Number.isNaN(n.offsetFrom)||Number.isNaN(n.offsetTo))return;if(n.offsetFrom===n.offsetTo)return oe(t,e,i,a,s)?{x1:e,y1:i,x2:a,y2:s,offset:n.offsetFrom}:void 0;const[g,x]=[n.offsetFrom,n.offsetTo];for(let S=0;S<Math.PI;S+=Math.PI/8)for(let r=S,o=0;o<2;o++,r+=Math.PI){const[u,l,f,y]=[Math.sin(S)*g,Math.cos(S)*g,Math.sin(r)*x,Math.cos(r)*x];if(oe(t,e+u,i+l,a+f,s+y))return{x1:e+u,y1:i+l,x2:a+f,y2:s+y,offset:0}}},cn=(t,e,i,a,s,n)=>t===i?{x1:t+5*n,y1:e,x2:i+5*n,y2:a,offset:s}:e===a?{x1:t,y1:e+5*n,x2:i,y2:a+5*n,offset:s}:{x1:t+5*Math.SQRT1_2*n,y1:e+5*Math.SQRT1_2*n,x2:i+5*Math.SQRT1_2*n,y2:a+5*Math.SQRT1_2*n,offset:s},oe=(t,e,i,a,s)=>!!((e===a||i===s)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((s-i)/(a-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),ln=(t,e)=>{const i=[],a=[];return Object.values(e).forEach(s=>{var N;if(s.length===1){a.push(...s.map(p=>p.edge));return}const n=t.getEdgeAttribute(s.at(0),"type");if(!s.every(p=>t.getEdgeAttribute(p,"type")===n)){a.push(...s.map(p=>p.edge));return}const g=t.getEdgeAttribute(s.at(0),"style");if(!s.every(p=>t.getEdgeAttribute(p,"style")===g)){a.push(...s.map(p=>p.edge));return}const x={},S=new Set,r=new Set,o=Object.fromEntries(s.map(p=>{var v,E;const[M,c]=t.extremities(p);return x[M]=((v=x[M])!=null?v:0)+1,x[c]=((E=x[c])!=null?E:0)+1,S.add(M),r.add(c),[M,[p.edge,c]]})),u=Array.from(S).filter(p=>x[p]===1),l=Array.from(r).filter(p=>x[p]===1);if(u.length!==1||l.length!==1){a.push(...s.map(p=>p.edge));return}const f=u[0],y=l[0];if(f===y){a.push(...s.map(p=>p.edge));return}const b=[o[f][0]];let m=o[f][1];for(let p=1;p<s.length;p=p+1){const M=(N=o[m])==null?void 0:N.at(1);if(!M){a.push(...s.map(c=>c.edge));return}b.push(o[m][0]),m=M}if(m!==y||b.length!==s.length){a.push(...s.map(p=>p.edge));return}i.push(b)}),{allReconciledLines:i,danglingLines:a}},dn=(t,e)=>{if(!e.every(s=>t.hasEdge(s)))return;const i=e.map(s=>{var l,f,y;const[n,g]=t.extremities(s),x=t.getNodeAttributes(n),S=t.getNodeAttributes(g),{type:r}=t.getEdgeAttributes(s),o=(l=t.getEdgeAttribute(s,r))!=null?l:ct[r].defaultAttrs,u=be(r,x.x,x.y,S.x,S.y,o);if(u){const{x1:b,y1:m,x2:N,y2:p,offset:M}=u;return ct[tt.Simple].generatePath(b,N,m,p,{offset:M})}return(y=(f=ct[r])==null?void 0:f.generatePath(x.x,S.x,x.y,S.y,o))!=null?y:"M ".concat(x.x," ").concat(x.y," L ").concat(S.x," ").concat(S.y)});let a="".concat(i[0]," ");for(let s=1;s<e.length;s=s+1)a+=i[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return a},un=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),hn=t=>{const e={},i={},a=[],s={},n=[];for(const r of t.edgeEntries()){const[o,u,l,f]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],y=r.attributes[r.attributes.type],b=be(r.attributes.type,o,u,l,f,y);i[r.edge]=b}for(const r of t.edgeEntries()){let o=i[r.edge];const{parallelIndex:u}=r.attributes;if(u>=0){const l=je(t,r.attributes.type,r.edge),f=i[l];if(!f){a.push(r);continue}if(u>0){const{x1:y,y1:b,x2:m,y2:N,offset:p}=f;o=cn(y,b,m,N,p,u)}}if(r.attributes.reconcileId!==""){const l=r.attributes.reconcileId;l in s?s[l].push(r):s[l]=[r];continue}if(o){const l=r.edge,f=r.attributes,{x1:y,y1:b,x2:m,y2:N,offset:p}=o;e[l]={attr:f,path:ct[tt.Simple].generatePath(y,m,b,N,{offset:p})};continue}n.push(r)}const g=new Set;for(;a.length;){const r=a.pop();if(g.has(r.edge))continue;const{parallel:o}=De(t,r);if(!o.length)continue;o.forEach(l=>g.add(l.edge));const u=Ee(o);for(const l of o){const f=l.edge;e[f]={attr:l.attributes,path:u[f]}}}const{allReconciledLines:x,danglingLines:S}=ln(t,s);for(const r of x){const o=dn(t,r);if(!o)continue;const u=r[0];e[u]={attr:t.getEdgeAttributes(u),path:o}}for(const r of S){const o=t.getEdgeAttributes(r),[u,l]=t.extremities(r),f=t.getNodeAttributes(u),y=t.getNodeAttributes(l);e[r]={attr:o,path:ct[tt.Simple].generatePath(f.x,y.x,f.y,y.y,ct[tt.Simple].defaultAttrs)}}for(const r of n){const o=r.edge,u=r.attributes.type,l=r.attributes,[f,y,b,m]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(u in ct)){e[o]={attr:l,path:"M ".concat(f," ").concat(y," L ").concat(b," ").concat(m)};continue}e[o]={attr:l,path:ct[u].generatePath(f,b,y,m,l[u])}}return Object.entries(e).map(([r,o])=>({id:r,type:"line",line:o}))},Se=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===dt.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===dt.Master&&e.getNodeAttributes(t)[dt.Master].nodeType==="Station",fn=(t,e)=>{const i=[];return e.filter(a=>Se(a,t)).forEach(a=>{const s=t.getNodeAttribute(a,"x"),n=t.getNodeAttribute(a,"y");i.push({a:1,b:0,c:-s,node:a,x:s,y:n}),i.push({a:0,b:1,c:-n,node:a,x:s,y:n}),i.push({a:1,b:-1,c:-s+n,node:a,x:s,y:n}),i.push({a:1,b:1,c:-s-n,node:a,x:s,y:n})}),i},we=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),yn=(t,e,i,a)=>{let s=1/0,n={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(g=>a.includes(g.node)).forEach(g=>{const x=we(g,t,e);x<s&&(s=x,n=g)}),{l:n,d:s}},xn=(t,e,i,a,s)=>{const n=e.filter(r=>{const o=t.getNodeAttribute(r,"x"),u=t.getNodeAttribute(r,"y");return Math.abs(s.a*o+s.b*u+s.c)<=.01}),g=[(r,o,u,l)=>[(r+u)/2,(o+l)/2],(r,o,u,l)=>[2*r-u,2*o-l],(r,o,u,l)=>[2*u-r,2*l-o]];let x=1/0,S={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<n.length;r++){const o=n[r],u=t.getNodeAttribute(o,"x"),l=t.getNodeAttribute(o,"y");for(let f=r+1;f<n.length;f++){const y=n[f],b=t.getNodeAttribute(y,"x"),m=t.getNodeAttribute(y,"y");g.forEach(N=>{const[p,M]=N(u,l,b,m),c=Math.hypot(i-p,a-M);c<x&&(x=c,S={x:p,y:M,originalNodesPos:[{x:u,y:l},{x:b,y:m}]})})}}return{snapPoint:S,distance:x}},gn=(t,e)=>{const{xMin:i,yMin:a,xMax:s,yMax:n}=e;if(t.a===0)return[i,s,-t.c/t.b,-t.c/t.b];if(t.b===0)return[-t.c/t.a,-t.c/t.a,a,n];{const g=-t.a/t.b,x=-t.c/t.b;return[i,s,g*i+x,g*s+x]}},pn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=X(l=>l.param),a=l=>{const y=[{x:l.x,y:l.y},...l.originalNodesPos].sort((m,N)=>m.x===N.x?m.y-N.y:m.x-N.x),b=(y[1].y-y[0].y)/(y[1].x-y[0].x);if(Math.abs(b)<=.01)return{original:y,offset:y.map(m=>({x:m.x,y:m.y+10})),rotate:0};if(Math.abs(b)>=1e10)return{original:y,offset:y.map(m=>({x:m.x+10,y:m.y})),rotate:90};{const N=-1/b,p=10/Math.sqrt(N*N+1),M=10*N/Math.sqrt(N*N+1);return{original:y,offset:y.map(c=>({x:c.x+p,y:c.y+M})),rotate:-Math.atan(N)*(180/Math.PI)}}},{original:s,offset:n,rotate:g}=a(e),x=l=>{const f=Math.sqrt(3)/2*l,y="0,0",b="".concat(-l/2,",").concat(f),m="".concat(l/2,",").concat(f);return"".concat(y," ").concat(b," ").concat(m)},S=i/75,r=8*S,o="#FC8181",u="".concat(S*5," ").concat(S*2);return d.jsxs(d.Fragment,{children:[d.jsx("line",{x1:n[0].x,y1:n[0].y,x2:n[1].x,y2:n[1].y,stroke:o,strokeWidth:S,strokeDasharray:u}),d.jsx("line",{x1:n[1].x,y1:n[1].y,x2:n[2].x,y2:n[2].y,stroke:o,strokeWidth:S,strokeDasharray:u}),d.jsx("line",{x1:s[0].x,y1:s[0].y,x2:n[0].x,y2:n[0].y,stroke:o,strokeWidth:S,strokeDasharray:u}),d.jsx("line",{x1:s[1].x,y1:s[1].y,x2:n[1].x,y2:n[1].y,stroke:o,strokeWidth:S,strokeDasharray:u}),d.jsx("line",{x1:s[2].x,y1:s[2].y,x2:n[2].x,y2:n[2].y,stroke:o,strokeWidth:S,strokeDasharray:u}),d.jsx("polygon",{points:x(r),transform:"translate(".concat(n[0].x,",").concat(n[0].y,") rotate(").concat((g+270)%360,")"),fill:o}),d.jsx("polygon",{points:x(r),transform:"translate(".concat(n[1].x,",").concat(n[1].y,") rotate(").concat((g+270)%360,")"),fill:o}),d.jsx("polygon",{points:x(r),transform:"translate(".concat(n[1].x,",").concat(n[1].y,") rotate(").concat((g+90)%360,")"),fill:o}),d.jsx("polygon",{points:x(r),transform:"translate(".concat(n[2].x,",").concat(n[2].y,") rotate(").concat((g+90)%360,")"),fill:o})]})},re=t=>{const{id:e,x:i,y:a,handlePointerDown:s,handlePointerMove:n,handlePointerUp:g}=t,x=D.useCallback(o=>s(e,o),[e,s]),S=D.useCallback(o=>n(e,o),[e,n]),r=D.useCallback(o=>g(e,o),[e,g]);return d.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(a-6.4,")scale(0.025)"),onPointerDown:x,onPointerMove:S,onPointerUp:r,style:{cursor:"move"},children:d.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},mn=t=>{const{id:e,path:i,handlePointerDown:a}=t,s=D.useCallback(n=>a(e,n),[e,a]);return d.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},bn=D.memo(t=>{var S,r,o,u,l,f,y,b,m,N,p,M;const{elements:e,handlePointerDown:i,handlePointerMove:a,handlePointerUp:s,handleEdgePointerDown:n}=t,g=Object.fromEntries(Array.from({length:21},(c,v)=>[v-10,{pre:[],main:[],post:[]}]));for(const c of e)if(c.type==="line"){const v=c.line.attr.type,E=c.line.attr.style,W=c.line.attr[E],$=(S=Dt[E])==null?void 0:S.preComponent;$&&g[c.line.attr.zIndex].pre.push(d.jsx($,{id:c.id,type:v,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:n},"".concat(c.id,".pre")));const Q=(o=(r=Dt[E])==null?void 0:r.component)!=null?o:mn;g[c.line.attr.zIndex].main.push(d.jsx(Q,{id:c.id,type:v,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:n},c.id));const et=(u=Dt[E])==null?void 0:u.postComponent;et&&g[c.line.attr.zIndex].post.push(d.jsx(et,{id:c.id,type:v,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:n},"".concat(c.id,".post")))}else if(c.type==="station"){const v=c.station,E=v.type,W=(l=bt[E])==null?void 0:l.preComponent;W&&g[c.station.zIndex].pre.push(d.jsx(W,{id:c.id,x:v.x,y:v.y,attrs:v,handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},"".concat(c.id,".pre")));const $=(y=(f=bt[E])==null?void 0:f.component)!=null?y:re;g[c.station.zIndex].main.push(d.jsx($,{id:c.id,x:v.x,y:v.y,attrs:v,handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},c.id));const Q=(b=bt[E])==null?void 0:b.postComponent;Q&&g[c.station.zIndex].post.push(d.jsx(Q,{id:c.id,x:v.x,y:v.y,attrs:v,handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},"".concat(c.id,".post")))}else if(c.type==="misc-node"){const v=c.miscNode,E=v.type,W=(m=Et[E])==null?void 0:m.preComponent;W&&g[c.miscNode.zIndex].pre.push(d.jsx(W,{id:c.id,x:v.x,y:v.y,attrs:v[E],handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},"".concat(c.id,".pre")));const $=(p=(N=Et[E])==null?void 0:N.component)!=null?p:re;g[c.miscNode.zIndex].main.push(d.jsx($,{id:c.id,x:v.x,y:v.y,attrs:v[E],handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},c.id));const Q=(M=Et[E])==null?void 0:M.postComponent;Q&&g[c.miscNode.zIndex].post.push(d.jsx(Q,{id:c.id,x:v.x,y:v.y,attrs:v[E],handlePointerDown:i,handlePointerMove:a,handlePointerUp:s},"".concat(c.id,".post")))}return Array.from({length:21},(c,v)=>(v-10).toString()).map(c=>[...g[c].pre,...g[c].main,...g[c].post]).flat()},(t,e)=>t.elements===e.elements),Sn=[...Object.values(_e),dt.Virtual,dt.Master,dt.Fill,dt.LondonArrow,dt.ChongqingRTNumLineBadge2021,dt.ChongqingRTTextLineBadge2021,dt.ChengduRTLineBadge,dt.GzmtrLineBadge],wn=()=>{const t=kt(),e=D.useRef(window.graph),i=()=>{t(Pt(e.current.export())),t(pt()),t(mt())},{telemetry:{project:a},preference:{autoParallel:s,snapLines:n,autoChangeStationType:g}}=X(z=>z.app),{svgViewBoxZoom:x,svgViewBoxMin:S}=X(z=>z.param),{selected:r,pointerPosition:o,active:u,refresh:{nodes:l,edges:f},mode:y,keepLastPath:b,theme:m}=X(z=>z.runtime),N=Ot(),{height:p,width:M}=Bt(N),[c,v]=D.useState({dx:0,dy:0}),[E,W]=D.useState([]),[$,Q]=D.useState([]),[et,R]=D.useState([]);D.useEffect(()=>{if(!o||!n)return;const z=Kt(S,x,M,p),I=fe(e.current,...Object.values(z));Q(I),W(fn(e.current,I))},[S,x,M,p,o]);const[nt,A]=D.useState(void 0),O=B((z,I)=>{I.stopPropagation(),I.currentTarget.setPointerCapture(I.pointerId);const{x:G,y:it}=gt(I);y==="select"&&t(St("free")),R([]),A(void 0),t(Ht({x:G,y:it})),t(_t(z)),I.shiftKey?r.has(z)?t(Gt(z)):t(Zt(z)):r.has(z)||t(vt(new Set([z])))}),st=B((z,I)=>{const{x:G,y:it}=gt(I);if(I.currentTarget.setPointerCapture(I.pointerId),y==="free"&&u===z){if(!I.altKey&&n){const q=e.current.getNodeAttribute(z,"x"),Z=e.current.getNodeAttribute(z,"y"),H=q-(o.x-G)*x/100,K=Z-(o.y-it)*x/100;let at=H,h=K;if(Se(z,e.current)){let w=et,k=nt;if(w.length!==0&&(w=w.filter(j=>we(j,H,K)<=6)),k&&(w.length===0||Math.hypot(H-k.x,K-k.y)>6)&&(k=void 0),!k&&w.length===1){const j=w[0],{snapPoint:L,distance:T}=xn(e.current,$.filter(F=>!r.has(F)),H,K,j);T<=3&&(k=L)}if(w.length===1&&!k||w.length===0){const{l:j,d:L}=yn(H,K,E,$.filter(F=>!r.has(F)&&!w.some(ut=>ut.node===F))),T=w.length===0||!w.some(F=>F.a===j.a&&F.b===j.b);L<3&&w.length<2&&T&&w.push(j)}if(w.length===1)if(k)at=k.x,h=k.y;else{const j=w[0];if(j.a==0)h=-j.c/j.b;else if(j.b==0)at=-j.c/j.a;else{const L=-j.a/j.b,T=-j.c/j.b;h=L*at+T}}else if(w.length===2){const j=w[0],L=w[1],T=j.a*L.b-L.a*j.b;T!==0&&(at=-(j.c*L.b-L.c*j.b)/T,h=-(j.a*L.c-L.a*j.c)/T)}R(w),A(k)}const P=at-q,C=h-Z;r.forEach(w=>{e.current.hasNode(w)&&e.current.updateNodeAttributes(w,k=>({...k,x:U(k.x+P,.01),y:U(k.y+C,.01)}))})}else R([]),A(void 0),r.forEach(q=>{e.current.hasNode(q)&&e.current.updateNodeAttributes(q,Z=>({...Z,x:U(Z.x-(o.x-G)*x/100,I.altKey?.01:zt),y:U(Z.y-(o.y-it)*x/100,I.altKey?.01:zt)}))});t(pt()),t(mt())}else y.startsWith("line")&&u&&v({dx:(o.x-G)*x/100,dy:(o.y-it)*x/100})}),ht=B((z,I)=>{var G,it,q;if(I.currentTarget.releasePointerCapture(I.pointerId),y.startsWith("line")){b||t(St("free"));const Z=e.current.hasNode(u)&&Sn.includes(e.current.getNodeAttribute(u,"type")),H=["stn_core_","virtual_circle_","misc_node_connectable_"],at=(q=(it=(G=document.elementsFromPoint(I.clientX,I.clientY).at(0))==null?void 0:G.attributes)==null?void 0:it.getNamedItem("id"))==null?void 0:q.value,h=H.find(P=>at==null?void 0:at.startsWith(P));if(Z&&h){const{path:P,style:C}=qt(y),[w,k]=[P,C],j="line_".concat(Mt(10)),[L,T]=[u,at.slice(h.length)];if(L!==T){const F=structuredClone(Dt[k].defaultAttrs);"color"in F&&k!==Nt.River&&(F.color=m);const ut=s?ue(e.current,w,L,T,"from"):-1;e.current.addDirectedEdgeWithKey(j,L,T,{visible:!0,zIndex:0,type:w,[w]:structuredClone(ct[w].defaultAttrs),style:k,[k]:F,reconcileId:"",parallelIndex:ut}),g&&L.startsWith("stn")&&Rt(e.current,L),g&&T.startsWith("stn")&&Rt(e.current,T),t(vt(new Set([j]))),a&&Ct.event(jt.ADD_LINE,{type:w}),t(Pt(e.current.export())),t(mt())}}}else if(y==="free"&&u){const{x:Z,y:H}=gt(I);o.x-Z===0&&o.y-H===0||(t(Pt(e.current.export())),t(pt()))}R([]),A(void 0),Ht(void 0),t(_t(void 0))}),ft=B((z,I)=>{if(I.stopPropagation(),I.shiftKey||t(wt()),I.shiftKey&&r.has(z)?t(Gt(z)):t(Zt(z)),y.startsWith("station")||y.startsWith("misc-node-virtual")||y.startsWith("misc-node-master")){const G=I.clientX-document.getElementById("canvas").getBoundingClientRect().left,it=I.clientY-document.getElementById("canvas").getBoundingClientRect().top,q=y.startsWith("station"),Z=Mt(10),H=q?"stn_".concat(Z):"misc_node_".concat(Z),K=q?y.slice(8):y.slice(10),{x:at,y:h}=xt(G,it,x,S),P=q?structuredClone(bt[K].defaultAttrs):structuredClone(Et[K].defaultAttrs);"color"in P&&(P.color=m),e.current.addNode(H,{visible:!0,zIndex:0,x:U(at,5),y:U(h,5),type:K,[K]:P});const C=e.current.getEdgeAttributes(z),{zIndex:w,type:k,style:j}=C,L=C[k],T=C[j],[F,ut]=e.current.extremities(z),It=s?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(Mt(10)),F,H,{visible:!0,zIndex:w,type:k,[k]:structuredClone(L),style:j,[j]:structuredClone(T),reconcileId:"",parallelIndex:It}),e.current.addDirectedEdgeWithKey("line_".concat(Mt(10)),H,ut,{visible:!0,zIndex:w,type:k,[k]:structuredClone(L),style:j,[j]:structuredClone(T),reconcileId:"",parallelIndex:It}),e.current.dropEdge(z),i(),a&&(Ct.event(jt.ADD_STATION,{type:K}),Ct.event(jt.ADD_LINE,{type:k})),t(St("free")),t(vt(new Set([H])))}}),_=D.useMemo(()=>[...hn(e.current),...un(e.current)],[f,l]),{path:Y,style:ot}=qt(y),yt=Y||tt.Diagonal,rt=ot||Nt.SingleColor,lt=Dt[rt].component,V=structuredClone(Dt[rt].defaultAttrs);return"color"in V&&rt!==Nt.River&&(V.color=m),d.jsxs(d.Fragment,{children:[d.jsx(bn,{elements:_,handlePointerDown:O,handlePointerMove:st,handlePointerUp:ht,handleEdgePointerDown:ft}),y.startsWith("line")&&u&&u!=="background"&&d.jsx(lt,{id:"line_create_in_progress___no_use",type:yt,path:ct[yt].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-c.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-c.dy,ct[yt].defaultAttrs),styleAttrs:V,newLine:!0,handlePointerDown:()=>{}}),et.length!==0&&et.map(z=>d.jsx("path",{d:ct[tt.Simple].generatePath(...gn(z,Kt(S,x,M,p)),ct[tt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:x/75},"snap_line_".concat(z.a,"_").concat(z.b,"_").concat(z.c,"_").concat(z.node))),nt&&d.jsx(pn,{activeSnapPoint:nt})]})},vn=()=>{const t=kt(),{svgViewBoxZoom:e,svgViewBoxMin:i}=X(f=>f.param),{radialTouchMenu:a}=X(f=>f.runtime),s=D.useRef(window.graph),[n,g]=D.useState(0),x=Ot(),{height:S,width:r}=Bt(x),o=B(f=>{var y;if(f.touches.length==1){if(g(0),a.visible){t(Jt());return}const b=f.touches[0],m=(y=document.getElementById("canvas"))==null?void 0:y.getBoundingClientRect();if(!m)return;const N=b.clientX-m.left,p=b.clientY-m.top,M=xt(N,p,e,i),c=ze(s.current,M,t);[...c[Xt.STATION],...c[Xt.MISC_NODE],...c[Xt.LINE]].length>0?t(Le({visible:!0,position:M,data:c})):(t(wt()),t(Jt()))}else if(f.touches.length==2){t(_t(void 0));const[b,m]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];g(b*b+m*m)}}),u=B(f=>{if(f.touches.length==2&&n>0){const[y,b]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],m=y*y+b*b;let N=e;m-n<0&&e+10<=390?N=e+10:m-n>0&&e-10>=10&&(N=e-10),t(he(N)),g(m);const p=f.currentTarget.getBoundingClientRect(),[M,c]=[(f.touches[0].clientX+f.touches[1].clientX)/2-p.left,(f.touches[0].clientY+f.touches[1].clientY)/2-p.top],[v,E]=[M/p.width,c/p.height];t(Tt({x:i.x+M*e/100-r*N/100*v,y:i.y+c*e/100-S*N/100*E}))}}),l=B(f=>{g(0)});return d.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:S*e/100,fill:a.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:o,onTouchMove:u,onTouchEnd:l})},An=()=>{const t=kt(),e=D.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:a}=X(c=>c.param),{selected:s}=X(c=>c.runtime),n=Ot(),{height:g,width:x}=Bt(n),S=D.useCallback(()=>{t(Pt(e.current.export())),t(pt()),t(mt())},[t]),r=D.useCallback((c,v,E)=>{c.stopPropagation(),s.size>0&&(s.forEach(W=>{e.current.hasNode(W)&&(e.current.updateNodeAttribute(W,"x",$=>($!=null?$:0)+v*zt),e.current.updateNodeAttribute(W,"y",$=>($!=null?$:0)+E*zt))}),S())},[s,S]),o=D.useCallback(c=>r(c,0,-1),[r]),u=D.useCallback(c=>r(c,0,1),[r]),l=D.useCallback(c=>r(c,-1,0),[r]),f=D.useCallback(c=>r(c,1,0),[r]),y=D.useCallback(()=>{if(s.size>0){const c=Wt(e.current,s);navigator.clipboard.writeText(c)}},[s]),b=D.useCallback(()=>{s.size>0&&(t(wt()),s.forEach(c=>{e.current.hasNode(c)?e.current.dropNode(c):e.current.hasEdge(c)&&e.current.dropEdge(c)}),S())},[s,t,S]),m=a.x+x*i/200,N=a.y+(g-100)*i/100,p=40,M=40;return d.jsxs("g",{transform:"translate(".concat(m,", ").concat(N,")scale(").concat(1.5*i/100,")"),children:[d.jsxs("g",{transform:"translate(0, -".concat(M,")"),children:[d.jsx("circle",{r:p/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:o}),d.jsx(Ie,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),d.jsxs("g",{transform:"translate(0, ".concat(M,")"),children:[d.jsx("circle",{r:p/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),d.jsx($e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),d.jsxs("g",{transform:"translate(-".concat(M,", 0)"),children:[d.jsx("circle",{r:p/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),d.jsx(Te,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),d.jsxs("g",{transform:"translate(".concat(M,", 0)"),children:[d.jsx("circle",{r:p/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),d.jsx(We,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),d.jsxs("g",{transform:"translate(".concat(M,", ").concat(M,")"),children:[d.jsx("circle",{r:p/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:y}),d.jsx(Re,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),d.jsxs("g",{transform:"translate(-".concat(M,", ").concat(M,")"),children:[d.jsx("circle",{r:p/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:b}),d.jsx(Oe,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Dn=()=>{const t=kt(),e=D.useRef(window.graph),i=D.useCallback(()=>{t(Pt(e.current.export())),t(pt()),t(mt())},[t]),{activeSubscriptions:a}=X(h=>h.account),{telemetry:{project:s},preference:{gridLines:n,snapLines:g,predictNextNode:x,autoParallel:S,autoChangeStationType:r}}=X(h=>h.app),{svgViewBoxZoom:o,svgViewBoxMin:u}=X(h=>h.param),{selected:l,active:f,isDetailsOpen:y,mode:b,lastTool:m,keepLastPath:N,theme:p,count:{masters:M,lines:c}}=X(h=>h.runtime),v=Ot(),{height:E,width:W}=Bt(v),$=!a.RMP_CLOUD&&M+1>ae,Q=!S||S&&!a.RMP_CLOUD&&c+1>ce,et=me();Be();const[R,nt]=D.useState({x:0,y:0}),[A,O]=D.useState({x:0,y:0}),[st,ht]=D.useState({isOpen:!1,position:{x:0,y:0}}),ft=D.useRef({x:0,y:0}),_=D.useRef({x:0,y:0}),Y=(h,P)=>{const C=h-ft.current.x,w=P-ft.current.y,k=C*o/100,j=w*o/100;return{x:_.current.x-k,y:_.current.y-j}},[ot,yt]=D.useState({x:0,y:0,zoom:1}),rt=D.useRef(null),lt=D.useCallback((h,P)=>{if(rt.current){const C=100/P,w=-h.x*C,k=-h.y*C;rt.current.setAttribute("transform","translate(".concat(w,", ").concat(k,") scale(").concat(C,")")),n&&yt({x:h.x,y:h.y,zoom:P})}},[n]);D.useLayoutEffect(()=>{lt(u,o)},[u,o,lt]);const V=D.useRef(null);D.useEffect(()=>()=>{V.current&&(cancelAnimationFrame(V.current),V.current=null)},[]);const z=B(async h=>{st.isOpen&&ht({isOpen:!1,position:{x:0,y:0}});const{x:P,y:C}=gt(h);if(b.startsWith("station")||b.startsWith("misc-node")){t(St("free"));const w=Mt(10),{x:k,y:j}=xt(P,C,o,u),L=b.startsWith("station"),T=L?"stn_".concat(w):"misc_node_".concat(w),F=L?b.slice(8):b.slice(10),ut=structuredClone({...bt,...Et}[F].defaultAttrs);de.has(F)&&(ut.color=p),L&&(ut.names=await et(F)),e.current.addNode(T,{visible:!0,zIndex:0,x:U(k,5),y:U(j,5),type:F,[F]:ut}),s&&Ct.event(jt.ADD_STATION,{type:F}),i(),t(vt(new Set([T])))}else b==="free"||b.startsWith("line")?(b.startsWith("line")&&(t(St("free")),N&&t(Ge(!1))),ft.current={x:P,y:C},_.current=u,h.shiftKey||(t(_t("background")),t(wt()))):b==="select"&&(nt(xt(P,C,o,u)),O(xt(P,C,o,u)))}),I=B(h=>{if(b==="select"){if(R.x!=0&&R.y!=0){const{x:P,y:C}=gt(h);O(xt(P,C,o,u))}}else if(f==="background"){const{x:P,y:C}=gt(h);V.current||(V.current=requestAnimationFrame(()=>{const w=Y(P,C);lt(w,o),V.current=null}))}}),G=B(h=>{const{x:P,y:C}=gt(h);if(b==="select"){const{x:w,y:k}=xt(P,C,o,u),j=fe(e.current,R.x,R.y,w,k),L=Je(e.current,new Set(j));t(vt(new Set([...h.shiftKey?l:[],...j,...L]))),t(St("free")),nt({x:0,y:0}),O({x:0,y:0})}if(f==="background"&&!h.shiftKey){V.current&&(cancelAnimationFrame(V.current),V.current=null);const w=Y(P,C);t(Tt(w)),t(_t(void 0))}}),it=B(h=>{let P=o;h.deltaY>0&&o+10<400?P=o+10:h.deltaY<0&&o-10>0&&(P=o-10);const{x:C,y:w}=gt(h),k=h.currentTarget.getBoundingClientRect(),[j,L]=[C/k.width,w/k.height],T={x:u.x+C*o/100-W*P/100*j,y:u.y+w*o/100-E*P/100*L};t(he(P)),t(Tt(T))}),q=B(h=>{h.preventDefault(),gt(h),ht({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),Z=B(()=>{ht({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),H=B(async h=>{if(At?h.key==="Backspace":h.key==="Delete")l.size>0&&(l.forEach(P=>{if(e.current.hasNode(P))e.current.dropNode(P);else if(e.current.hasEdge(P)){const[C,w]=e.current.extremities(P);e.current.dropEdge(P),r&&C.startsWith("stn")&&Rt(e.current,C),r&&w.startsWith("stn")&&Rt(e.current,w)}}),t(wt()),i());else if(h.key.startsWith("Arrow")){const C=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,w=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(Tt(xt(100*C,100*w,o,u)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const P=(h.key==="j"?-1:h.key==="l"?1:0)*zt,C=(h.key==="i"?-1:h.key==="k"?1:0)*zt;l.size>0&&l.forEach(w=>{e.current.hasNode(w)&&(e.current.updateNodeAttribute(w,"x",k=>(k!=null?k:0)+P),e.current.updateNodeAttribute(w,"y",k=>(k!=null?k:0)+C),i())})}else if(h.key==="f"&&m)t(St(m));else if(h.key==="z"&&(At?h.metaKey&&!h.shiftKey:h.ctrlKey))At&&h.preventDefault(),t(Ve()),t(pt()),t(mt());else if(h.key==="s")t(St("select"));else if((h.key==="c"||h.key==="x")&&(At?h.metaKey&&!h.shiftKey:h.ctrlKey)){const P=Wt(e.current,l);navigator.clipboard.writeText(P),h.key==="x"&&(t(wt()),l.forEach(C=>{e.current.hasNode(C)?e.current.dropNode(C):e.current.hasEdge(C)&&e.current.dropEdge(C)}),i())}else if(h.key==="v"&&(At?h.metaKey&&!h.shiftKey:h.ctrlKey)){const P=await navigator.clipboard.readText(),{x:C,y:w}=xt(W/2,E/2,o,u),{nodes:k,edges:j}=le(P,e.current,$,Q,U(C,5),U(w,5));i();const L=structuredClone(k);j.forEach(T=>L.add(T)),t(vt(L))}else if(At&&h.key==="z"&&h.metaKey&&h.shiftKey||!At&&h.key==="y"&&h.ctrlKey)t(He());else if(h.key==="c")t(Ue(!g));else if(h.key==="r"){const P=h.altKey?5:45;pe(e.current,l,P)&&i()}else if(h.key==="e"){const[P]=l;if(l.size===1&&e.current.hasEdge(P)){const C=e.current.getEdgeAttributes(P),{type:w}=C;if(w!==tt.Simple&&C[w]){const k=C[w],L=(k.startFrom||"from")==="from"?"to":"from";let T=C.parallelIndex;if(S){const[ut,It]=e.current.extremities(P);T=ue(e.current,w,ut,It,L)}const F={...k,startFrom:L};e.current.mergeEdgeAttributes(P,{[w]:F,parallelIndex:T}),i()}}}}),[K,at]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{at({sx:R.x<=A.x?R.x:A.x,ex:R.x>A.x?R.x:A.x,sy:R.y<=A.y?R.y:A.y,ey:R.y>A.y?R.y:A.y})},[A.x,A.y]),d.jsxs(d.Fragment,{children:[d.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:E,width:W,viewBox:"0 0 ".concat(W," ").concat(E),onPointerDown:z,onPointerMove:I,onPointerUp:G,onWheel:it,onContextMenu:q,tabIndex:0,onKeyDown:H,children:[d.jsx("defs",{children:d.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[d.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),d.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),d.jsxs("g",{ref:rt,children:[n&&d.jsx(on,{gridLineOffset:ot,svgWidth:W,svgHeight:E}),Qt()&&b==="free"&&d.jsx(vn,{}),x&&l.size===1&&b==="free"&&d.jsx(an,{}),d.jsx(qe.SvgAssetsContextProvider,{children:d.jsx(wn,{})}),b==="select"&&R.x!=0&&R.y!=0&&d.jsx("rect",{x:K.sx,y:K.sy,width:K.ex-K.sx,height:K.ey-K.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Qt()&&[...l].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&d.jsx(An,{}),d.jsx(Fe,{})]})]}),d.jsx(sn,{isOpen:st.isOpen,position:st.position,onClose:Z}),Xe()&&y==="hide"&&d.jsx(Pe,{"aria-label":"open details panel",icon:d.jsx(Ke,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(Ye()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Dn as default};

import{ad as te,j as w}from"./chakra-CSR0Uih-.js";import{c as Mt,e as Q,a4 as Et,x as Vt,au as Lt,av as ee,o as bt,aw as jt,ax as Ot,L as J,ay as dt,az as Dt,n as ft,aA as ne,d as Yt,r as pt,E as xt,m as $t,p as Z,aB as mt,V as gt,t as At,v as St,w as vt,aC as se,aD as oe,aE as re,aF as Nt,q as Ut,aG as ht,aH as It,aI as Tt,B as Ct,S as ie,aJ as ae,a1 as ce,aK as le,F as kt,ar as de,as as ue,a6 as he,D as Wt,a2 as ye}from"./index-CJORWRND.js";import{s as ct,b as zt,r as Y,e as at,g as qt,f as Gt,h as fe,j as ge,k as pe,l as xe,n as me,p as ut,o as Se,q as ve,i as yt,t as we}from"./master-manager-CSQmmZDv.js";import{b as I,k as Zt}from"./react-eFT_xHYJ.js";import{u as et,e as be,i as Ae}from"./clipboard-Vj8heA0B.js";import{v as Pe,m as wt}from"./misc-nodes-CY3X8Wk7.js";const ke={[Et.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Et.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},_e=t=>{const e=ke[t];return e.at(Math.floor(Math.random()*e.length))},Bt=Zt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:h})=>{const{token:r}=e().account;if(!r){u(Lt({cityName:t,names:[]}));return}const i=await fetch("".concat(ee,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!i.ok)return Vt.warn("Failed to fetch random station names",i.statusText),h(i.statusText);const b=await i.json();u(Lt({cityName:t,names:b}))}),Ht=Zt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var y;const{stationNames:h}=e().runtime,r=h[t];if(((y=r==null?void 0:r.length)!=null?y:0)==0)return Vt.debug("No random station names in cache, using fallback"),u(Bt({cityName:t})),Object.values(_e(t));const i=structuredClone(r),b=i.shift();return u(Lt({cityName:t,names:i})),i.length<3&&u(Bt({cityName:t})),Object.values(b)}),Jt=()=>{const t=Mt(),{activeSubscriptions:e}=Q(r=>r.account),{preference:{randomStationsNames:u}}=Q(r=>r.app),h=!e.RMP_CLOUD||u==="none";return I.useCallback(async r=>{const i=ct[r].defaultAttrs.names;if(!h){const b=await t(Ht(Et.Shmetro));if(Ht.fulfilled.match(b)){const y=b.payload;return i.length>y.length?y.push(...Array(i.length-y.length).fill(y.at(-1))):i.length<y.length&&y.splice(i.length),y}}return structuredClone(i)},[t,h])},Ce=I.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:h,svgHeight:r}=t,{preference:{toolsPanel:{expand:i}}}=Q(_=>_.app),y=te().colorMode==="light"?"#666464":"#D3D3D4",p=zt(e,u,h,r),n=i?410*u/100:0,s=u>30?u>120?50:25:5,c=u/200,d={startX:Y(p.xMin+n-s,s),endX:Y(p.xMax+n+s,s),startY:Y(p.yMin-s,s),endY:Y(p.yMax+s,s)},S=Array.from({length:(d.endX-d.startX)/s+1},(_,f)=>{const C=d.startX+f*s,l=C%(s*5)===0?2*c:c;return w.jsx("line",{x1:C,y1:d.startY,x2:C,y2:d.endY,strokeWidth:l,stroke:y,opacity:"0.5"},"grid_vl_".concat(C))}),a=Array.from({length:(d.endY-d.startY)/s+1},(_,f)=>{const C=d.startY+f*s,l=C%(s*5)===0?2*c:c;return w.jsx("line",{x1:d.startX,y1:C,x2:d.endX,y2:C,strokeWidth:l,stroke:y,opacity:"0.5"},"grid_hl_".concat(C))}),E=Array.from({length:(d.endX-d.startX)/s/5+1},(_,f)=>{const C=Y(d.startX,5*s)+f*5*s;return w.jsx("text",{x:C,y:p.yMin+u/5,fontSize:c*25,fill:y,textAnchor:"middle",opacity:"0.5",children:C},"grid_vc_".concat(C))}),A=Array.from({length:(d.endY-d.startY)/s/5+1},(_,f)=>{const C=Y(d.startY,5*s)+f*5*s;return w.jsx("text",{x:p.xMin+u/8+n,y:C,fontSize:c*25,fill:y,textAnchor:"start",opacity:"0.5",children:C},"grid_hc_".concat(C))});return w.jsxs("g",{id:"grid-lines",className:"removeMe",children:[S,a,E,A]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Me=Pe.component,Rt=jt.generatePath,Xt=Ot.component,_t=10,Ne=()=>{var ot;const t=Mt(),e=()=>{t(At(window.graph.export())),t(St()),t(vt())},{telemetry:{project:u},preference:{autoParallel:h}}=Q(j=>j.app),{selected:r,theme:i,count:{mostFrequentStationType:b}}=Q(j=>j.runtime),y=Jt(),p=r.keys().next().value;if(!p.startsWith("stn")&&!p.startsWith("misc_node")||!window.graph.hasNode(p))return;const n=window.graph.neighbors(p);if(n.length===0)return;const s=window.graph.getNodeAttributes(p),c=n.reduce((j,H)=>{const q=window.graph.getNodeAttributes(H);return{x:j.x+q.x,y:j.y+q.y}},{x:0,y:0}),d={x:c.x/n.length,y:c.y/n.length},S={x:s.x-d.x,y:s.y-d.y},a={x:s.x+S.x,y:s.y+S.y},E=Math.sign(S.x)===Math.sign(S.y),A={x:a.x-_t,y:a.y+_t*(E?1:-1)},_={x:a.x+_t,y:a.y+_t*(E?-1:1)},f=p.startsWith("stn_")?window.graph.getNodeAttribute(p,"type"):b,C=ct[f].component,l={visible:!0,zIndex:0,x:_.x,y:_.y,type:f,[f]:ct[f].defaultAttrs},k=window.graph.reduceEdges(p,(j,H)=>{const q=window.graph.getEdgeAttributes(H),{style:lt}=q;if(lt===bt.SingleColor){const rt=JSON.stringify(q[lt].color);rt in j?j[rt]+=1:j[rt]=1}return j},{}),D=(ot=Object.entries(k).filter(([j,H])=>H%2!==0).reduce((j,[H,q])=>q>j.count?{color:JSON.parse(H),count:q}:j,{color:null,count:0}).color)!=null?ot:i,V=S.x>0?!(S.x>Math.abs(S.y)):-S.x>Math.abs(S.y),U=V?"from":"to",z=Rt(s.x,A.x,s.y,A.y,{...jt.defaultAttrs,startFrom:U}),tt=V?"to":"from",F=Rt(s.x,_.x,s.y,_.y,{...jt.defaultAttrs,startFrom:tt}),st=async(j,H)=>{H.stopPropagation();const{x:q,y:lt}=at(H);t(Dt({x:q,y:lt}));const rt=ft(10),it=ne.has(j),M=it?"stn_".concat(rt):"misc_node_".concat(rt),N=structuredClone({...ct,...wt}[j].defaultAttrs);Yt.has(j)&&(N.color=i),it&&(N.names=await y(j)),window.graph.addNode(M,{visible:!0,zIndex:0,x:it?_.x:A.x,y:it?_.y:A.y,type:j,[j]:N}),u&&pt.event(xt.ADD_STATION,{type:j});const T=J.Diagonal,O="line_".concat(ft(10)),[K,R]=[p,M],X=h?$t(window.graph,T,K,R,"from"):-1,W=it?tt:U;window.graph.addDirectedEdgeWithKey(O,K,R,{visible:!0,zIndex:0,type:T,[T]:{...structuredClone(Z[T].defaultAttrs),startFrom:W},style:bt.SingleColor,[bt.SingleColor]:{color:D},reconcileId:"",parallelIndex:X}),u&&pt.event(xt.ADD_LINE,{type:T}),e(),t(mt(M)),t(gt(new Set([M])))};return w.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[w.jsx(Xt,{id:"line_prediction_1",type:J.Diagonal,path:z,styleAttrs:{color:D},newLine:!0,handlePointerDown:()=>{}}),w.jsx(Xt,{id:"line_prediction_2",type:J.Diagonal,path:F,styleAttrs:{color:D},newLine:!0,handlePointerDown:()=>{}}),w.jsx(Me,{id:"misc_node_virtual_prediction_1",attrs:{},x:A.x,y:A.y,handlePointerDown:(j,H)=>{st(dt.Virtual,H)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),w.jsx(C,{id:"stn_virtual_prediction_2",attrs:l,x:_.x,y:_.y,handlePointerDown:(j,H)=>{st(b,H)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Qt=(t,e,u,h,r,i)=>{if(!("offsetFrom"in i)||!("offsetTo"in i)||Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return Ft(t,e,u,h,r)?{x1:e,y1:u,x2:h,y2:r,offset:i.offsetFrom}:void 0;const[b,y]=[i.offsetFrom,i.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let n=p,s=0;s<2;s++,n+=Math.PI){const[c,d,S,a]=[Math.sin(p)*b,Math.cos(p)*b,Math.sin(n)*y,Math.cos(n)*y];if(Ft(t,e+c,u+d,h+S,r+a))return{x1:e+c,y1:u+d,x2:h+S,y2:r+a,offset:0}}},Ee=(t,e,u,h,r,i)=>t===u?{x1:t+5*i,y1:e,x2:u+5*i,y2:h,offset:r}:e===h?{x1:t,y1:e+5*i,x2:u,y2:h+5*i,offset:r}:{x1:t+5*Math.SQRT1_2*i,y1:e+5*Math.SQRT1_2*i,x2:u+5*Math.SQRT1_2*i,y2:h+5*Math.SQRT1_2*i,offset:r},Ft=(t,e,u,h,r)=>!!((e===h||u===r)&&[J.Diagonal,J.Perpendicular].includes(t)||Math.abs((r-u)/(h-e))===1&&[J.Diagonal,J.RotatePerpendicular].includes(t)),Le=(t,e)=>{const u=[],h=[];return Object.values(e).forEach(r=>{var _;if(r.length===1){h.push(...r.map(f=>f.edge));return}const i=t.getEdgeAttribute(r.at(0),"type");if(!r.every(f=>t.getEdgeAttribute(f,"type")===i)){h.push(...r.map(f=>f.edge));return}const b=t.getEdgeAttribute(r.at(0),"style");if(!r.every(f=>t.getEdgeAttribute(f,"style")===b)){h.push(...r.map(f=>f.edge));return}const y={},p=new Set,n=new Set,s=Object.fromEntries(r.map(f=>{var k,D;const[C,l]=t.extremities(f);return y[C]=((k=y[C])!=null?k:0)+1,y[l]=((D=y[l])!=null?D:0)+1,p.add(C),n.add(l),[C,[f.edge,l]]})),c=Array.from(p).filter(f=>y[f]===1),d=Array.from(n).filter(f=>y[f]===1);if(c.length!==1||d.length!==1){h.push(...r.map(f=>f.edge));return}const S=c[0],a=d[0];if(S===a){h.push(...r.map(f=>f.edge));return}const E=[s[S][0]];let A=s[S][1];for(let f=1;f<r.length;f=f+1){const C=(_=s[A])==null?void 0:_.at(1);if(!C){h.push(...r.map(l=>l.edge));return}E.push(s[A][0]),A=C}if(A!==a||E.length!==r.length){h.push(...r.map(f=>f.edge));return}u.push(E)}),{allReconciledLines:u,danglingLines:h}},je=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const u=e.map(r=>{var d,S,a;const[i,b]=t.extremities(r),y=t.getNodeAttributes(i),p=t.getNodeAttributes(b),{type:n}=t.getEdgeAttributes(r),s=(d=t.getEdgeAttribute(r,n))!=null?d:Z[n].defaultAttrs,c=Qt(n,y.x,y.y,p.x,p.y,s);if(c){const{x1:E,y1:A,x2:_,y2:f,offset:C}=c;return Z[J.Simple].generatePath(E,_,A,f,{offset:C})}return(a=(S=Z[n])==null?void 0:S.generatePath(y.x,p.x,y.y,p.y,s))!=null?a:"M ".concat(y.x," ").concat(y.y," L ").concat(p.x," ").concat(p.y)});let h="".concat(u[0]," ");for(let r=1;r<e.length;r=r+1)h+=u[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return h},De=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ze=t=>{const e={},u={},h=[],r={},i=[];for(const n of t.edgeEntries()){const[s,c,d,S]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y],a=n.attributes[n.attributes.type],E=Qt(n.attributes.type,s,c,d,S,a);u[n.edge]=E}for(const n of t.edgeEntries()){let s=u[n.edge];const{parallelIndex:c}=n.attributes;if(c>=0){const d=se(t,n.attributes.type,n.edge),S=u[d];if(!S){h.push(n);continue}if(c>0){const{x1:a,y1:E,x2:A,y2:_,offset:f}=S;s=Ee(a,E,A,_,f,c)}}if(n.attributes.reconcileId!==""){const d=n.attributes.reconcileId;d in r?r[d].push(n):r[d]=[n];continue}if(s){const d=n.edge,S=n.attributes,{x1:a,y1:E,x2:A,y2:_,offset:f}=s;e[d]={attr:S,path:Z[J.Simple].generatePath(a,A,E,_,{offset:f})};continue}i.push(n)}const b=new Set;for(;h.length;){const n=h.pop();if(b.has(n.edge))continue;const{parallel:s}=oe(t,n);if(!s.length)continue;s.forEach(d=>b.add(d.edge));const c=re(s);for(const d of s){const S=d.edge;e[S]={attr:d.attributes,path:c[S]}}}const{allReconciledLines:y,danglingLines:p}=Le(t,r);for(const n of y){const s=je(t,n);if(!s)continue;const c=n[0];e[c]={attr:t.getEdgeAttributes(c),path:s}}for(const n of p){const s=t.getEdgeAttributes(n),[c,d]=t.extremities(n),S=t.getNodeAttributes(c),a=t.getNodeAttributes(d);e[n]={attr:s,path:Z[J.Simple].generatePath(S.x,a.x,S.y,a.y,Z[J.Simple].defaultAttrs)}}for(const n of i){const s=n.edge,c=n.attributes.type,d=n.attributes,[S,a,E,A]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y];if(!(c in Z)){e[s]={attr:d,path:"M ".concat(S," ").concat(a," L ").concat(E," ").concat(A)};continue}e[s]={attr:d,path:Z[c].generatePath(S,E,a,A,d[c])}}return Object.entries(e).map(([n,s])=>({id:n,type:"line",line:s}))},$e=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=Q(d=>d.param),h=d=>{const a=[{x:d.x,y:d.y},...d.originalNodesPos].sort((A,_)=>A.x===_.x?A.y-_.y:A.x-_.x),E=(a[1].y-a[0].y)/(a[1].x-a[0].x);if(Math.abs(E)<=.01)return{original:a,offset:a.map(A=>({x:A.x,y:A.y+10})),rotate:0};if(Math.abs(E)>=1e10)return{original:a,offset:a.map(A=>({x:A.x+10,y:A.y})),rotate:90};{const _=-1/E,f=10/Math.sqrt(_*_+1),C=10*_/Math.sqrt(_*_+1);return{original:a,offset:a.map(l=>({x:l.x+f,y:l.y+C})),rotate:-Math.atan(_)*(180/Math.PI)}}},{original:r,offset:i,rotate:b}=h(e),y=d=>{const S=Math.sqrt(3)/2*d,a="0,0",E="".concat(-d/2,",").concat(S),A="".concat(d/2,",").concat(S);return"".concat(a," ").concat(E," ").concat(A)},p=u/75,n=8*p,s="#FC8181",c="".concat(p*5," ").concat(p*2);return w.jsxs(w.Fragment,{children:[w.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,stroke:s,strokeWidth:p,strokeDasharray:c}),w.jsx("line",{x1:i[1].x,y1:i[1].y,x2:i[2].x,y2:i[2].y,stroke:s,strokeWidth:p,strokeDasharray:c}),w.jsx("line",{x1:r[0].x,y1:r[0].y,x2:i[0].x,y2:i[0].y,stroke:s,strokeWidth:p,strokeDasharray:c}),w.jsx("line",{x1:r[1].x,y1:r[1].y,x2:i[1].x,y2:i[1].y,stroke:s,strokeWidth:p,strokeDasharray:c}),w.jsx("line",{x1:r[2].x,y1:r[2].y,x2:i[2].x,y2:i[2].y,stroke:s,strokeWidth:p,strokeDasharray:c}),w.jsx("polygon",{points:y(n),transform:"translate(".concat(i[0].x,",").concat(i[0].y,") rotate(").concat((b+270)%360,")"),fill:s}),w.jsx("polygon",{points:y(n),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((b+270)%360,")"),fill:s}),w.jsx("polygon",{points:y(n),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((b+90)%360,")"),fill:s}),w.jsx("polygon",{points:y(n),transform:"translate(".concat(i[2].x,",").concat(i[2].y,") rotate(").concat((b+90)%360,")"),fill:s})]})},Kt=t=>{const{id:e,x:u,y:h,handlePointerDown:r,handlePointerMove:i,handlePointerUp:b}=t,y=I.useCallback(s=>r(e,s),[e,r]),p=I.useCallback(s=>i(e,s),[e,i]),n=I.useCallback(s=>b(e,s),[e,b]);return w.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(h-6.4,")scale(0.025)"),onPointerDown:y,onPointerMove:p,onPointerUp:n,style:{cursor:"move"},children:w.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Ie=t=>{const{id:e,path:u,handlePointerDown:h}=t,r=I.useCallback(i=>h(e,i),[e,h]);return w.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Te=I.memo(t=>{var p,n,s,c,d,S,a,E,A,_,f,C;const{elements:e,handlePointerDown:u,handlePointerMove:h,handlePointerUp:r,handleEdgePointerDown:i}=t,b=Object.fromEntries(Array.from({length:21},(l,k)=>[k-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const k=l.line.attr.type,D=l.line.attr.style,V=l.line.attr[D],U=(p=Nt[D])==null?void 0:p.preComponent;U&&b[l.line.attr.zIndex].pre.push(w.jsx(U,{id:l.id,type:k,path:l.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},"".concat(l.id,".pre")));const z=(s=(n=Nt[D])==null?void 0:n.component)!=null?s:Ie;b[l.line.attr.zIndex].main.push(w.jsx(z,{id:l.id,type:k,path:l.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},l.id));const tt=(c=Nt[D])==null?void 0:c.postComponent;tt&&b[l.line.attr.zIndex].post.push(w.jsx(tt,{id:l.id,type:k,path:l.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},"".concat(l.id,".post")))}else if(l.type==="station"){const k=l.station,D=k.type,V=(d=ct[D])==null?void 0:d.preComponent;V&&b[l.station.zIndex].pre.push(w.jsx(V,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".pre")));const U=(a=(S=ct[D])==null?void 0:S.component)!=null?a:Kt;b[l.station.zIndex].main.push(w.jsx(U,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},l.id));const z=(E=ct[D])==null?void 0:E.postComponent;z&&b[l.station.zIndex].post.push(w.jsx(z,{id:l.id,x:k.x,y:k.y,attrs:k,handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const k=l.miscNode,D=k.type,V=(A=wt[D])==null?void 0:A.preComponent;V&&b[l.miscNode.zIndex].pre.push(w.jsx(V,{id:l.id,x:k.x,y:k.y,attrs:k[D],handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".pre")));const U=(f=(_=wt[D])==null?void 0:_.component)!=null?f:Kt;b[l.miscNode.zIndex].main.push(w.jsx(U,{id:l.id,x:k.x,y:k.y,attrs:k[D],handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},l.id));const z=(C=wt[D])==null?void 0:C.postComponent;z&&b[l.miscNode.zIndex].post.push(w.jsx(z,{id:l.id,x:k.x,y:k.y,attrs:k[D],handlePointerDown:u,handlePointerMove:h,handlePointerUp:r},"".concat(l.id,".post")))}return Array.from({length:21},(l,k)=>(k-10).toString()).map(l=>[...b[l].pre,...b[l].main,...b[l].post]).flat()},(t,e)=>t.elements===e.elements),We=[...Object.values(ie),dt.Virtual,dt.Master,dt.LondonArrow,dt.ChongqingRTNumLineBadge2021,dt.ChongqingRTTextLineBadge2021,dt.ChengduRTLineBadge,dt.GzmtrLineBadge],Be=()=>{const t=Mt(),e=I.useRef(window.graph),u=()=>{t(At(e.current.export())),t(St()),t(vt())},{telemetry:{project:h},preference:{autoParallel:r,gridLines:i,snapLines:b}}=Q(M=>M.app),{svgViewBoxZoom:y,svgViewBoxMin:p}=Q(M=>M.param),{selected:n,pointerPosition:s,active:c,refresh:{nodes:d,edges:S},mode:a,keepLastPath:E,theme:A}=Q(M=>M.runtime),_=Ut(),{height:f,width:C}=qt(_),[l,k]=I.useState({dx:0,dy:0}),[D,V]=I.useState([]),[U,z]=I.useState([]),[tt,F]=I.useState([]);I.useEffect(()=>{if(!s||!b)return;const M=zt(p,y,C,f),N=Gt(e.current,...Object.values(M));z(N),V(fe(e.current,N))},[p,y,C,f,s]);const[st,ot]=I.useState(void 0),j=et((M,N)=>{N.stopPropagation(),N.currentTarget.setPointerCapture(N.pointerId);const{x:T,y:O}=at(N);a==="select"&&t(ht("free")),F([]),ot(void 0),t(Dt({x:T,y:O})),t(mt(M)),N.shiftKey?n.has(M)?t(It(M)):t(Tt(M)):n.has(M)||t(gt(new Set([M])))}),H=et((M,N)=>{const{x:T,y:O}=at(N);if(N.currentTarget.setPointerCapture(N.pointerId),a==="free"&&c===M){if(!N.altKey&&b){const K=e.current.getNodeAttribute(M,"x"),R=e.current.getNodeAttribute(M,"y"),X=K-(s.x-T)*y/100,W=R-(s.y-O)*y/100;let G=X,o=W;if(ge(M,e.current)){let x=tt,v=st;if(x.length!==0&&(x=x.filter(g=>pe(g,X,W)<=6)),v&&(x.length===0||Math.hypot(X-v.x,W-v.y)>6)&&(v=void 0),!v&&x.length===1){const g=x[0],{snapPoint:L,distance:$}=xe(e.current,U.filter(B=>!n.has(B)),X,W,g);$<=3&&(v=L)}if(x.length===1&&!v||x.length===0){const{l:g,d:L}=me(X,W,D,U.filter(B=>!n.has(B)&&!x.some(nt=>nt.node===B))),$=x.length===0||!x.some(B=>B.a===g.a&&B.b===g.b);L<3&&x.length<2&&$&&x.push(g)}if(x.length===1)if(v)G=v.x,o=v.y;else{const g=x[0];if(g.a==0)o=-g.c/g.b;else if(g.b==0)G=-g.c/g.a;else{const L=-g.a/g.b,$=-g.c/g.b;o=L*G+$}}else if(x.length===2){const g=x[0],L=x[1],$=g.a*L.b-L.a*g.b;$!==0&&(G=-(g.c*L.b-L.c*g.b)/$,o=-(g.a*L.c-L.a*g.c)/$)}F(x),ot(v)}const m=G-K,P=o-R;n.forEach(x=>{e.current.hasNode(x)&&e.current.updateNodeAttributes(x,v=>({...v,x:Y(v.x+m,.01),y:Y(v.y+P,.01)}))})}else F([]),ot(void 0),n.forEach(K=>{e.current.hasNode(K)&&e.current.updateNodeAttributes(K,R=>({...R,x:Y(R.x-(s.x-T)*y/100,N.altKey?.01:5),y:Y(R.y-(s.y-O)*y/100,N.altKey?.01:5)}))});t(St()),t(vt())}else a.startsWith("line")&&c&&k({dx:(s.x-T)*y/100,dy:(s.y-O)*y/100})}),q=et((M,N)=>{var T,O,K;if(N.currentTarget.releasePointerCapture(N.pointerId),a.startsWith("line")){E||t(ht("free"));const R=e.current.hasNode(c)&&We.includes(e.current.getNodeAttribute(c,"type")),X=["stn_core_","virtual_circle_","misc_node_connectable_"],G=(K=(O=(T=document.elementsFromPoint(N.clientX,N.clientY).at(0))==null?void 0:T.attributes)==null?void 0:O.getNamedItem("id"))==null?void 0:K.value,o=X.find(m=>G==null?void 0:G.startsWith(m));if(R&&o){const m=a.slice(5),P="line_".concat(ft(10)),[x,v]=[c,G.slice(o.length)];if(x!==v){const g=r?$t(e.current,m,x,v,"from"):-1;e.current.addDirectedEdgeWithKey(P,x,v,{visible:!0,zIndex:0,type:m,[m]:structuredClone(Z[m].defaultAttrs),style:bt.SingleColor,[bt.SingleColor]:{color:A},reconcileId:"",parallelIndex:g}),t(gt(new Set([P]))),h&&pt.event(xt.ADD_LINE,{type:m}),t(At(e.current.export())),t(vt())}}}else if(a==="free"&&c){const{x:R,y:X}=at(N);s.x-R===0&&s.y-X===0||(t(At(e.current.export())),t(St()))}F([]),ot(void 0),Dt(void 0),t(mt(void 0))}),lt=et((M,N)=>{if(N.stopPropagation(),N.shiftKey||t(Ct()),N.shiftKey&&n.has(M)?t(It(M)):t(Tt(M)),a.startsWith("station")||a.startsWith("misc-node-virtual")||a.startsWith("misc-node-master")){const T=N.clientX-document.getElementById("canvas").getBoundingClientRect().left,O=N.clientY-document.getElementById("canvas").getBoundingClientRect().top,K=a.startsWith("station"),R=ft(10),X=K?"stn_".concat(R):"misc_node_".concat(R),W=K?a.slice(8):a.slice(10),{x:G,y:o}=ut(T,O,y,p),m=K?structuredClone(ct[W].defaultAttrs):structuredClone(wt[W].defaultAttrs);"color"in m&&(m.color=A),e.current.addNode(X,{visible:!0,zIndex:0,x:Y(G,5),y:Y(o,5),type:W,[W]:m});const P=e.current.getEdgeAttributes(M),{zIndex:x,type:v,style:g}=P,L=P[v],$=P[g],[B,nt]=e.current.extremities(M),Pt=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(ft(10)),B,X,{visible:!0,zIndex:x,type:v,[v]:structuredClone(L),style:g,[g]:structuredClone($),reconcileId:"",parallelIndex:Pt}),e.current.addDirectedEdgeWithKey("line_".concat(ft(10)),X,nt,{visible:!0,zIndex:x,type:v,[v]:structuredClone(L),style:g,[g]:structuredClone($),reconcileId:"",parallelIndex:Pt}),e.current.dropEdge(M),u(),h&&(pt.event(xt.ADD_STATION,{type:W}),pt.event(xt.ADD_LINE,{type:v})),t(ht("free")),t(gt(new Set([X])))}}),rt=I.useMemo(()=>[...ze(e.current),...De(e.current)],[S,d]),it=Ot.component;return w.jsxs(w.Fragment,{children:[w.jsx(Te,{elements:rt,handlePointerDown:j,handlePointerMove:H,handlePointerUp:q,handleEdgePointerDown:lt}),a.startsWith("line")&&c&&c!=="background"&&w.jsx(it,{id:"line_create_in_progress___no_use",type:a.slice(5),path:Z[a.slice(5)].generatePath(e.current.getNodeAttribute(c,"x"),e.current.getNodeAttribute(c,"x")-l.dx,e.current.getNodeAttribute(c,"y"),e.current.getNodeAttribute(c,"y")-l.dy,Z[a.slice(5)].defaultAttrs),styleAttrs:{color:A},newLine:!0,handlePointerDown:()=>{}}),tt.length!==0&&tt.map(M=>w.jsx("path",{d:Z[J.Simple].generatePath(...Se(M,zt(p,y,C,f)),Z[J.Simple].defaultAttrs),stroke:"cyan",strokeWidth:y/75},"snap_line_".concat(M.a,"_").concat(M.b,"_").concat(M.c,"_").concat(M.node))),st&&w.jsx($e,{activeSnapPoint:st})]})},Oe=()=>{const t=Mt(),e=I.useRef(window.graph),u=()=>{t(At(e.current.export())),t(St()),t(vt())},{activeSubscriptions:h}=Q(o=>o.account),{telemetry:{project:r},preference:{gridLines:i,snapLines:b,predictNextNode:y,autoParallel:p}}=Q(o=>o.app),{svgViewBoxZoom:n,svgViewBoxMin:s}=Q(o=>o.param),{mode:c,lastTool:d,active:S,selected:a,keepLastPath:E,theme:A,count:{masters:_,lines:f}}=Q(o=>o.runtime),C=Ut(),{height:l,width:k}=qt(C),D=!h.RMP_CLOUD&&_+1>ae,V=!h.RMP_CLOUD&&f+1>ce,U=Jt();le();const[z,tt]=I.useState({x:0,y:0}),[F,st]=I.useState({x:0,y:0}),[ot,j]=I.useState({x:0,y:0}),[H,q]=I.useState({x:0,y:0}),lt=et(async o=>{const{x:m,y:P}=at(o);if(c.startsWith("station")||c.startsWith("misc-node")){t(ht("free"));const x=ft(10),{x:v,y:g}=ut(m,P,n,s),L=c.startsWith("station"),$=L?"stn_".concat(x):"misc_node_".concat(x),B=L?c.slice(8):c.slice(10),nt=structuredClone({...ct,...wt}[B].defaultAttrs);Yt.has(B)&&(nt.color=A),L&&(nt.names=await U(B)),e.current.addNode($,{visible:!0,zIndex:0,x:Y(v,5),y:Y(g,5),type:B,[B]:nt}),r&&pt.event(xt.ADD_STATION,{type:B}),u(),t(gt(new Set([$])))}else c==="free"||c.startsWith("line")?(c.startsWith("line")&&(t(ht("free")),E&&t(ye(!1))),j({x:m,y:P}),q(s),o.shiftKey||(t(mt("background")),t(Ct()))):c==="select"&&(tt(ut(m,P,n,s)),st(ut(m,P,n,s)))}),rt=et(o=>{if(c==="select"){if(z.x!=0&&z.y!=0){const{x:m,y:P}=at(o);st(ut(m,P,n,s))}}else if(S==="background"){const{x:m,y:P}=at(o);t(kt({x:H.x+(ot.x-m)*n/100,y:H.y+(ot.y-P)*n/100}))}}),it=et(o=>{if(c==="select"){const{x:m,y:P}=at(o),{x,y:v}=ut(m,P,n,s),g=Gt(e.current,z.x,z.y,x,v),L=we(e.current,new Set(g));t(gt(new Set([...o.shiftKey?a:[],...g,...L]))),t(ht("free")),tt({x:0,y:0}),st({x:0,y:0})}S==="background"&&!o.shiftKey&&t(mt(void 0))}),M=et(o=>{let m=n;o.deltaY>0&&n+10<400?m=n+10:o.deltaY<0&&n-10>0&&(m=n-10),t(Wt(m));const{x:P,y:x}=at(o),v=o.currentTarget.getBoundingClientRect(),[g,L]=[P/v.width,x/v.height];t(kt({x:s.x+P*n/100-k*m/100*g,y:s.y+x*n/100-l*m/100*L}))}),N=et(async o=>{if(yt?o.key==="Backspace":o.key==="Delete")a.size>0&&(a.forEach(m=>{e.current.hasNode(m)?e.current.dropNode(m):e.current.hasEdge(m)&&e.current.dropEdge(m)}),t(Ct()),u());else if(o.key.startsWith("Arrow")){const P=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,x=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;t(kt(ut(100*P,100*x,n,s)))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const P=(o.key==="j"?-1:o.key==="l"?1:0)*10,x=(o.key==="i"?-1:o.key==="k"?1:0)*10;a.size>0&&a.forEach(v=>{e.current.hasNode(v)&&(e.current.updateNodeAttribute(v,"x",g=>(g!=null?g:0)+P),e.current.updateNodeAttribute(v,"y",g=>(g!=null?g:0)+x),u())})}else if(o.key==="f"&&d)t(ht(d));else if(o.key==="z"&&(yt?o.metaKey&&!o.shiftKey:o.ctrlKey))yt&&o.preventDefault(),t(de()),t(St()),t(vt());else if(o.key==="s")t(ht("select"));else if((o.key==="c"||o.key==="x")&&(yt?o.metaKey&&!o.shiftKey:o.ctrlKey)){const m=be(e.current,a);navigator.clipboard.writeText(m),o.key==="x"&&(t(Ct()),a.forEach(P=>{e.current.hasNode(P)?e.current.dropNode(P):e.current.hasEdge(P)&&e.current.dropEdge(P)}),u())}else if(o.key==="v"&&(yt?o.metaKey&&!o.shiftKey:o.ctrlKey)){const m=await navigator.clipboard.readText(),{x:P,y:x}=ut(k/2,l/2,n,s),{nodes:v,edges:g}=Ae(m,e.current,D,V,Y(P,5),Y(x,5));u();const L=structuredClone(v);g.forEach($=>L.add($)),t(gt(L))}else if(yt&&o.key==="z"&&o.metaKey&&o.shiftKey||!yt&&o.key==="y"&&o.ctrlKey)t(ue());else if(o.key==="c")t(he(!b));else if(o.key==="e"){const[m]=a;if(a.size===1&&e.current.hasEdge(m)){const P=e.current.getEdgeAttributes(m),{type:x}=P;if(x!==J.Simple&&P[x]){const v=P[x],L=(v.startFrom||"from")==="from"?"to":"from";let $=P.parallelIndex;if(p){const[nt,Pt]=e.current.extremities(m);$=$t(e.current,x,nt,Pt,L)}const B={...v,startFrom:L};e.current.mergeEdgeAttributes(m,{[x]:B,parallelIndex:$}),u()}}}}),[T,O]=I.useState(0),K=et(o=>{if(o.touches.length===2){t(mt(void 0));const[m,P]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY];O(m*m+P*P)}}),R=et(o=>{if(T!==0&&o.touches.length===2){const[m,P]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY],x=m*m+P*P;let v=n;x-T<0&&n+10<=390?v=n+10:x-T>0&&n-10>=10&&(v=n-10),t(Wt(v)),O(x);const g=o.currentTarget.getBoundingClientRect(),[L,$]=[(o.touches[0].clientX+o.touches[1].clientX)/2-g.left,(o.touches[0].clientY+o.touches[1].clientY)/2-g.top],[B,nt]=[L/g.width,$/g.height];t(kt({x:s.x+L*n/100-k*v/100*B,y:s.y+$*n/100-l*v/100*nt}))}}),X=et(o=>{T!==0&&O(0)}),[W,G]=I.useState({sx:0,sy:0,ex:0,ey:0});return I.useEffect(()=>{G({sx:z.x<=F.x?z.x:F.x,ex:z.x>F.x?z.x:F.x,sy:z.y<=F.y?z.y:F.y,ey:z.y>F.y?z.y:F.y})},[F.x,F.y]),w.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:l,width:k,viewBox:"".concat(s.x," ").concat(s.y," ").concat(k*n/100," ").concat(l*n/100),onPointerDown:lt,onPointerMove:rt,onPointerUp:it,onTouchStart:K,onTouchMove:R,onTouchEnd:X,onWheel:M,tabIndex:0,onKeyDown:N,children:[i&&w.jsx(Ce,{svgViewBoxMin:s,svgViewBoxZoom:n,svgWidth:k,svgHeight:l}),y&&a.size===1&&w.jsx(Ne,{}),w.jsx(ve.SvgAssetsContextProvider,{children:w.jsx(Be,{})}),c==="select"&&z.x!=0&&z.y!=0&&w.jsx("rect",{x:W.sx,y:W.sy,width:W.ex-W.sx,height:W.ey-W.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),w.jsx("defs",{children:w.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[w.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),w.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Oe as default};

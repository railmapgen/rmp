import{ad as ee,j as m,a2 as ne}from"./chakra-DYCfT-V9.js";import{c as Mt,e as tt,a7 as Lt,z as Kt,ay as jt,az as se,aA as Et,aB as Y,p as At,aC as Dt,aD as Ot,L as Q,aE as ut,aF as ct,aG as zt,n as gt,aH as oe,d as Vt,r as xt,E as mt,q as Z,aI as St,X as pt,w as Pt,x as vt,y as bt,aJ as re,aK as ie,aL as ae,aM as Nt,t as Yt,v as Ut,aN as yt,aO as $t,aP as It,o as Gt,F as Ct,Y as ht,aQ as ce,S as le,aR as de,a4 as ue,aS as he,aT as ye,aU as fe,aV as ge,ag as ft,H as kt,av as pe,aw as xe,a9 as me,G as Tt,a5 as Se}from"./index-B3nzb3c0.js";import{s as lt,f as qt,g as ve,c as be,e as we,h as Ae,j as Pe,k as ke,l as _e}from"./master-manager-C36H3RXB.js";import{b as $,k as Zt}from"./react-D3eaEgC1.js";import{u as nt,e as Ce,i as Me}from"./clipboard-C6S46_xz.js";import{v as Ne,m as wt}from"./misc-nodes-CN0YQrV-.js";const Le={[Lt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Lt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},je=t=>{const e=Le[t];return e.at(Math.floor(Math.random()*e.length))},Wt=Zt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:h,rejectWithValue:y})=>{const{token:r}=e().account;if(!r){h(jt({cityName:t,names:[]}));return}const i=await fetch("".concat(se,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!i.ok)return Kt.warn("Failed to fetch random station names",i.statusText),y(i.statusText);const w=await i.json();h(jt({cityName:t,names:w}))}),Bt=Zt("runtime/getOneStationName",async(t,{getState:e,dispatch:h})=>{var f;const{stationNames:y}=e().runtime,r=y[t];if(((f=r==null?void 0:r.length)!=null?f:0)==0)return Kt.debug("No random station names in cache, using fallback"),h(Wt({cityName:t})),Object.values(je(t));const i=structuredClone(r),w=i.shift();return h(jt({cityName:t,names:i})),i.length<3&&h(Wt({cityName:t})),Object.values(w)}),Qt=()=>{const t=Mt(),{activeSubscriptions:e}=tt(r=>r.account),{preference:{randomStationsNames:h}}=tt(r=>r.app),y=!e.RMP_CLOUD||h==="none";return $.useCallback(async r=>{const i=lt[r].defaultAttrs.names;if(!y){const w=await t(Bt(Lt.Shmetro));if(Bt.fulfilled.match(w)){const f=w.payload;return i.length>f.length?f.push(...Array(i.length-f.length).fill(f.at(-1))):i.length<f.length&&f.splice(i.length),f}}return structuredClone(i)},[t,y])},Ee=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:h,svgWidth:y,svgHeight:r}=t,{preference:{toolsPanel:{expand:i}}}=tt(k=>k.app),f=ee().colorMode==="light"?"#666464":"#D3D3D4",p=Et(e,h,y,r),n=i?410*h/100:0,s=h>30?h>120?50:25:5,c=h/200,l={startX:Y(p.xMin+n-s,s),endX:Y(p.xMax+n+s,s),startY:Y(p.yMin-s,s),endY:Y(p.yMax+s,s)},v=Array.from({length:(l.endX-l.startX)/s+1},(k,g)=>{const _=l.startX+g*s,d=_%(s*5)===0?2*c:c;return m.jsx("line",{x1:_,y1:l.startY,x2:_,y2:l.endY,strokeWidth:d,stroke:f,opacity:"0.5"},"grid_vl_".concat(_))}),a=Array.from({length:(l.endY-l.startY)/s+1},(k,g)=>{const _=l.startY+g*s,d=_%(s*5)===0?2*c:c;return m.jsx("line",{x1:l.startX,y1:_,x2:l.endX,y2:_,strokeWidth:d,stroke:f,opacity:"0.5"},"grid_hl_".concat(_))}),N=Array.from({length:(l.endX-l.startX)/s/5+1},(k,g)=>{const _=Y(l.startX,5*s)+g*5*s;return m.jsx("text",{x:_,y:p.yMin+h/5,fontSize:c*25,fill:f,textAnchor:"middle",opacity:"0.5",children:_},"grid_vc_".concat(_))}),A=Array.from({length:(l.endY-l.startY)/s/5+1},(k,g)=>{const _=Y(l.startY,5*s)+g*5*s;return m.jsx("text",{x:p.xMin+h/8+n,y:_,fontSize:c*25,fill:f,textAnchor:"start",opacity:"0.5",children:_},"grid_hc_".concat(_))});return m.jsxs("g",{id:"grid-lines",className:"removeMe",children:[v,a,N,A]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),De=Ne.component,Rt=Dt.generatePath,Ht=Ot.component,_t=10,ze=()=>{var st;const t=Mt(),e=()=>{t(Pt(window.graph.export())),t(vt()),t(bt())},{telemetry:{project:h},preference:{autoParallel:y}}=tt(E=>E.app),{selected:r,theme:i,count:{mostFrequentStationType:w}}=tt(E=>E.runtime),f=Qt(),p=r.keys().next().value;if(!p.startsWith("stn")&&!p.startsWith("misc_node")||!window.graph.hasNode(p))return;const n=window.graph.neighbors(p);if(n.length===0)return;const s=window.graph.getNodeAttributes(p),c=n.reduce((E,W)=>{const U=window.graph.getNodeAttributes(W);return{x:E.x+U.x,y:E.y+U.y}},{x:0,y:0}),l={x:c.x/n.length,y:c.y/n.length},v={x:s.x-l.x,y:s.y-l.y},a={x:s.x+v.x,y:s.y+v.y},N=Math.sign(v.x)===Math.sign(v.y),A={x:a.x-_t,y:a.y+_t*(N?1:-1)},k={x:a.x+_t,y:a.y+_t*(N?-1:1)},g=p.startsWith("stn_")?window.graph.getNodeAttribute(p,"type"):w,_=lt[g].component,d={visible:!0,zIndex:0,x:k.x,y:k.y,type:g,[g]:lt[g].defaultAttrs},P=window.graph.reduceEdges(p,(E,W)=>{const U=window.graph.getEdgeAttributes(W),{style:dt}=U;if(dt===At.SingleColor){const ot=JSON.stringify(U[dt].color);ot in E?E[ot]+=1:E[ot]=1}return E},{}),j=(st=Object.entries(P).filter(([E,W])=>W%2!==0).reduce((E,[W,U])=>U>E.count?{color:JSON.parse(W),count:U}:E,{color:null,count:0}).color)!=null?st:i,O=v.x>0?!(v.x>Math.abs(v.y)):-v.x>Math.abs(v.y),G=O?"from":"to",J=Rt(s.x,A.x,s.y,A.y,{...Dt.defaultAttrs,startFrom:G}),z=O?"to":"from",it=Rt(s.x,k.x,s.y,k.y,{...Dt.defaultAttrs,startFrom:z}),H=async(E,W)=>{W.stopPropagation();const{x:U,y:dt}=ct(W);t(zt({x:U,y:dt}));const ot=gt(10),at=oe.has(E),C=at?"stn_".concat(ot):"misc_node_".concat(ot),L=structuredClone({...lt,...wt}[E].defaultAttrs);Vt.has(E)&&(L.color=i),at&&(L.names=await f(E)),window.graph.addNode(C,{visible:!0,zIndex:0,x:at?k.x:A.x,y:at?k.y:A.y,type:E,[E]:L}),h&&xt.event(mt.ADD_STATION,{type:E});const X=Q.Diagonal,F="line_".concat(gt(10)),[B,K]=[p,C],R=y?0:-1,V=at?z:G;window.graph.addDirectedEdgeWithKey(F,B,K,{visible:!0,zIndex:0,type:X,[X]:{...structuredClone(Z[X].defaultAttrs),startFrom:V},style:At.SingleColor,[At.SingleColor]:{color:j},reconcileId:"",parallelIndex:R}),h&&xt.event(mt.ADD_LINE,{type:X}),e(),t(St(C)),t(pt(new Set([C])))};return m.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[m.jsx(Ht,{id:"line_prediction_1",type:Q.Diagonal,path:J,styleAttrs:{color:j},newLine:!0,handlePointerDown:()=>{}}),m.jsx(Ht,{id:"line_prediction_2",type:Q.Diagonal,path:it,styleAttrs:{color:j},newLine:!0,handlePointerDown:()=>{}}),m.jsx(De,{id:"misc_node_virtual_prediction_1",attrs:{},x:A.x,y:A.y,handlePointerDown:(E,W)=>{H(ut.Virtual,W)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),m.jsx(_,{id:"stn_virtual_prediction_2",attrs:d,x:k.x,y:k.y,handlePointerDown:(E,W)=>{H(w,W)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Jt=(t,e,h,y,r,i)=>{if(!("offsetFrom"in i)||!("offsetTo"in i)||Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return Xt(t,e,h,y,r)?{x1:e,y1:h,x2:y,y2:r,offset:i.offsetFrom}:void 0;const[w,f]=[i.offsetFrom,i.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let n=p,s=0;s<2;s++,n+=Math.PI){const[c,l,v,a]=[Math.sin(p)*w,Math.cos(p)*w,Math.sin(n)*f,Math.cos(n)*f];if(Xt(t,e+c,h+l,y+v,r+a))return{x1:e+c,y1:h+l,x2:y+v,y2:r+a,offset:0}}},$e=(t,e,h,y,r,i)=>t===h?{x1:t+5*i,y1:e,x2:h+5*i,y2:y,offset:r}:e===y?{x1:t,y1:e+5*i,x2:h,y2:y+5*i,offset:r}:{x1:t+5*Math.SQRT1_2*i,y1:e+5*Math.SQRT1_2*i,x2:h+5*Math.SQRT1_2*i,y2:y+5*Math.SQRT1_2*i,offset:r},Xt=(t,e,h,y,r)=>!!((e===y||h===r)&&[Q.Diagonal,Q.Perpendicular].includes(t)||Math.abs((r-h)/(y-e))===1&&[Q.Diagonal,Q.RotatePerpendicular].includes(t)),Ie=(t,e)=>{const h=[],y=[];return Object.values(e).forEach(r=>{var k;if(r.length===1){y.push(...r.map(g=>g.edge));return}const i=t.getEdgeAttribute(r.at(0),"type");if(!r.every(g=>t.getEdgeAttribute(g,"type")===i)){y.push(...r.map(g=>g.edge));return}const w=t.getEdgeAttribute(r.at(0),"style");if(!r.every(g=>t.getEdgeAttribute(g,"style")===w)){y.push(...r.map(g=>g.edge));return}const f={},p=new Set,n=new Set,s=Object.fromEntries(r.map(g=>{var P,j;const[_,d]=t.extremities(g);return f[_]=((P=f[_])!=null?P:0)+1,f[d]=((j=f[d])!=null?j:0)+1,p.add(_),n.add(d),[_,[g.edge,d]]})),c=Array.from(p).filter(g=>f[g]===1),l=Array.from(n).filter(g=>f[g]===1);if(c.length!==1||l.length!==1){y.push(...r.map(g=>g.edge));return}const v=c[0],a=l[0];if(v===a){y.push(...r.map(g=>g.edge));return}const N=[s[v][0]];let A=s[v][1];for(let g=1;g<r.length;g=g+1){const _=(k=s[A])==null?void 0:k.at(1);if(!_){y.push(...r.map(d=>d.edge));return}N.push(s[A][0]),A=_}if(A!==a||N.length!==r.length){y.push(...r.map(g=>g.edge));return}h.push(N)}),{allReconciledLines:h,danglingLines:y}},Te=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const h=e.map(r=>{var l,v,a;const[i,w]=t.extremities(r),f=t.getNodeAttributes(i),p=t.getNodeAttributes(w),{type:n}=t.getEdgeAttributes(r),s=(l=t.getEdgeAttribute(r,n))!=null?l:Z[n].defaultAttrs,c=Jt(n,f.x,f.y,p.x,p.y,s);if(c){const{x1:N,y1:A,x2:k,y2:g,offset:_}=c;return Z[Q.Simple].generatePath(N,k,A,g,{offset:_})}return(a=(v=Z[n])==null?void 0:v.generatePath(f.x,p.x,f.y,p.y,s))!=null?a:"M ".concat(f.x," ").concat(f.y," L ").concat(p.x," ").concat(p.y)});let y="".concat(h[0]," ");for(let r=1;r<e.length;r=r+1)y+=h[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return y},We=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Be=t=>{const e={},h={},y=[],r={},i=[];for(const n of t.edgeEntries()){const[s,c,l,v]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y],a=n.attributes[n.attributes.type],N=Jt(n.attributes.type,s,c,l,v,a);h[n.edge]=N}for(const n of t.edgeEntries()){let s=h[n.edge];const{parallelIndex:c}=n.attributes;if(c>=0){const l=re(t,n.attributes.type,n.edge),v=h[l];if(!v){y.push(n);continue}if(c>0){const{x1:a,y1:N,x2:A,y2:k,offset:g}=v;s=$e(a,N,A,k,g,c)}}if(n.attributes.reconcileId!==""){const l=n.attributes.reconcileId;l in r?r[l].push(n):r[l]=[n];continue}if(s){const l=n.edge,v=n.attributes,{x1:a,y1:N,x2:A,y2:k,offset:g}=s;e[l]={attr:v,path:Z[Q.Simple].generatePath(a,A,N,k,{offset:g})};continue}i.push(n)}const w=new Set;for(;y.length;){const n=y.pop();if(w.has(n.edge))continue;const{parallel:s}=ie(t,n);if(!s.length)continue;s.forEach(l=>w.add(l.edge));const c=ae(s);for(const l of s){const v=l.edge;e[v]={attr:l.attributes,path:c[v]}}}const{allReconciledLines:f,danglingLines:p}=Ie(t,r);for(const n of f){const s=Te(t,n);if(!s)continue;const c=n[0];e[c]={attr:t.getEdgeAttributes(c),path:s}}for(const n of p){const s=t.getEdgeAttributes(n),[c,l]=t.extremities(n),v=t.getNodeAttributes(c),a=t.getNodeAttributes(l);e[n]={attr:s,path:Z[Q.Simple].generatePath(v.x,a.x,v.y,a.y,Z[Q.Simple].defaultAttrs)}}for(const n of i){const s=n.edge,c=n.attributes.type,l=n.attributes,[v,a,N,A]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y];if(!(c in Z)){e[s]={attr:l,path:"M ".concat(v," ").concat(a," L ").concat(N," ").concat(A)};continue}e[s]={attr:l,path:Z[c].generatePath(v,N,a,A,l[c])}}return Object.entries(e).map(([n,s])=>({id:n,type:"line",line:s}))},Re=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:h}=tt(l=>l.param),y=l=>{const a=[{x:l.x,y:l.y},...l.originalNodesPos].sort((A,k)=>A.x===k.x?A.y-k.y:A.x-k.x),N=(a[1].y-a[0].y)/(a[1].x-a[0].x);if(Math.abs(N)<=.01)return{original:a,offset:a.map(A=>({x:A.x,y:A.y+10})),rotate:0};if(Math.abs(N)>=1e10)return{original:a,offset:a.map(A=>({x:A.x+10,y:A.y})),rotate:90};{const k=-1/N,g=10/Math.sqrt(k*k+1),_=10*k/Math.sqrt(k*k+1);return{original:a,offset:a.map(d=>({x:d.x+g,y:d.y+_})),rotate:-Math.atan(k)*(180/Math.PI)}}},{original:r,offset:i,rotate:w}=y(e),f=l=>{const v=Math.sqrt(3)/2*l,a="0,0",N="".concat(-l/2,",").concat(v),A="".concat(l/2,",").concat(v);return"".concat(a," ").concat(N," ").concat(A)},p=h/75,n=8*p,s="#FC8181",c="".concat(p*5," ").concat(p*2);return m.jsxs(m.Fragment,{children:[m.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,stroke:s,strokeWidth:p,strokeDasharray:c}),m.jsx("line",{x1:i[1].x,y1:i[1].y,x2:i[2].x,y2:i[2].y,stroke:s,strokeWidth:p,strokeDasharray:c}),m.jsx("line",{x1:r[0].x,y1:r[0].y,x2:i[0].x,y2:i[0].y,stroke:s,strokeWidth:p,strokeDasharray:c}),m.jsx("line",{x1:r[1].x,y1:r[1].y,x2:i[1].x,y2:i[1].y,stroke:s,strokeWidth:p,strokeDasharray:c}),m.jsx("line",{x1:r[2].x,y1:r[2].y,x2:i[2].x,y2:i[2].y,stroke:s,strokeWidth:p,strokeDasharray:c}),m.jsx("polygon",{points:f(n),transform:"translate(".concat(i[0].x,",").concat(i[0].y,") rotate(").concat((w+270)%360,")"),fill:s}),m.jsx("polygon",{points:f(n),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((w+270)%360,")"),fill:s}),m.jsx("polygon",{points:f(n),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((w+90)%360,")"),fill:s}),m.jsx("polygon",{points:f(n),transform:"translate(".concat(i[2].x,",").concat(i[2].y,") rotate(").concat((w+90)%360,")"),fill:s})]})},Ft=t=>{const{id:e,x:h,y,handlePointerDown:r,handlePointerMove:i,handlePointerUp:w}=t,f=$.useCallback(s=>r(e,s),[e,r]),p=$.useCallback(s=>i(e,s),[e,i]),n=$.useCallback(s=>w(e,s),[e,w]);return m.jsx("g",{id:e,transform:"translate(".concat(h-6.4," ").concat(y-6.4,")scale(0.025)"),onPointerDown:f,onPointerMove:p,onPointerUp:n,style:{cursor:"move"},children:m.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},He=t=>{const{id:e,path:h,handlePointerDown:y}=t,r=$.useCallback(i=>y(e,i),[e,y]);return m.jsx("path",{id:e,d:h,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Xe=$.memo(t=>{var p,n,s,c,l,v,a,N,A,k,g,_;const{elements:e,handlePointerDown:h,handlePointerMove:y,handlePointerUp:r,handleEdgePointerDown:i}=t,w=Object.fromEntries(Array.from({length:21},(d,P)=>[P-10,{pre:[],main:[],post:[]}]));for(const d of e)if(d.type==="line"){const P=d.line.attr.type,j=d.line.attr.style,O=d.line.attr[j],G=(p=Nt[j])==null?void 0:p.preComponent;G&&w[d.line.attr.zIndex].pre.push(m.jsx(G,{id:d.id,type:P,path:d.line.path,styleAttrs:O,newLine:!1,handlePointerDown:i},"".concat(d.id,".pre")));const J=(s=(n=Nt[j])==null?void 0:n.component)!=null?s:He;w[d.line.attr.zIndex].main.push(m.jsx(J,{id:d.id,type:P,path:d.line.path,styleAttrs:O,newLine:!1,handlePointerDown:i},d.id));const z=(c=Nt[j])==null?void 0:c.postComponent;z&&w[d.line.attr.zIndex].post.push(m.jsx(z,{id:d.id,type:P,path:d.line.path,styleAttrs:O,newLine:!1,handlePointerDown:i},"".concat(d.id,".post")))}else if(d.type==="station"){const P=d.station,j=P.type,O=(l=lt[j])==null?void 0:l.preComponent;O&&w[d.station.zIndex].pre.push(m.jsx(O,{id:d.id,x:P.x,y:P.y,attrs:P,handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},"".concat(d.id,".pre")));const G=(a=(v=lt[j])==null?void 0:v.component)!=null?a:Ft;w[d.station.zIndex].main.push(m.jsx(G,{id:d.id,x:P.x,y:P.y,attrs:P,handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},d.id));const J=(N=lt[j])==null?void 0:N.postComponent;J&&w[d.station.zIndex].post.push(m.jsx(J,{id:d.id,x:P.x,y:P.y,attrs:P,handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},"".concat(d.id,".post")))}else if(d.type==="misc-node"){const P=d.miscNode,j=P.type,O=(A=wt[j])==null?void 0:A.preComponent;O&&w[d.miscNode.zIndex].pre.push(m.jsx(O,{id:d.id,x:P.x,y:P.y,attrs:P[j],handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},"".concat(d.id,".pre")));const G=(g=(k=wt[j])==null?void 0:k.component)!=null?g:Ft;w[d.miscNode.zIndex].main.push(m.jsx(G,{id:d.id,x:P.x,y:P.y,attrs:P[j],handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},d.id));const J=(_=wt[j])==null?void 0:_.postComponent;J&&w[d.miscNode.zIndex].post.push(m.jsx(J,{id:d.id,x:P.x,y:P.y,attrs:P[j],handlePointerDown:h,handlePointerMove:y,handlePointerUp:r},"".concat(d.id,".post")))}return Array.from({length:21},(d,P)=>(P-10).toString()).map(d=>[...w[d].pre,...w[d].main,...w[d].post]).flat()},(t,e)=>t.elements===e.elements),Fe=[...Object.values(le),ut.Virtual,ut.Master,ut.LondonArrow,ut.ChongqingRTNumLineBadge2021,ut.ChongqingRTTextLineBadge2021,ut.ChengduRTLineBadge,ut.GzmtrLineBadge],Ke=()=>{const t=Mt(),e=$.useRef(window.graph),h=()=>{t(Pt(e.current.export())),t(vt()),t(bt())},{telemetry:{project:y},preference:{autoParallel:r,gridLines:i,snapLines:w}}=tt(C=>C.app),{svgViewBoxZoom:f,svgViewBoxMin:p}=tt(C=>C.param),{selected:n,pointerPosition:s,active:c,refresh:{nodes:l,edges:v},mode:a,keepLastPath:N,theme:A}=tt(C=>C.runtime),k=Yt(),{height:g,width:_}=Ut(k),[d,P]=$.useState({dx:0,dy:0}),[j,O]=$.useState([]),[G,J]=$.useState([]),[z,it]=$.useState([]);$.useEffect(()=>{if(!s||!w)return;const C=Et(p,f,_,g),L=qt(e.current,...Object.values(C));J(L),O(ve(e.current,L))},[p,f,_,g,s]);const[H,st]=$.useState(void 0),E=nt((C,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:X,y:F}=ct(L);a==="select"&&t(yt("free")),it([]),st(void 0),t(zt({x:X,y:F})),t(St(C)),L.shiftKey?n.has(C)?t($t(C)):t(It(C)):n.has(C)||t(pt(new Set([C])))}),W=nt((C,L)=>{const{x:X,y:F}=ct(L);if(L.currentTarget.setPointerCapture(L.pointerId),a==="free"&&c===C){if(!L.altKey&&w){const B=e.current.getNodeAttribute(C,"x"),K=e.current.getNodeAttribute(C,"y"),R=B-(s.x-X)*f/100,V=K-(s.y-F)*f/100;let T=R,et=V;if(be(C,e.current)){let u=z,S=H;if(u.length!==0&&(u=u.filter(x=>we(x,R,V)<=6)),S&&(u.length===0||Math.hypot(R-S.x,V-S.y)>6)&&(S=void 0),!S&&u.length===1){const x=u[0],{snapPoint:M,distance:D}=Ae(e.current,G.filter(I=>!n.has(I)),R,V,x);D<=3&&(S=M)}if(u.length===1&&!S||u.length===0){const{l:x,d:M}=Pe(R,V,j,G.filter(I=>!n.has(I)&&!u.some(q=>q.node===I))),D=u.length===0||!u.some(I=>I.a===x.a&&I.b===x.b);M<3&&u.length<2&&D&&u.push(x)}if(u.length===1)if(S)T=S.x,et=S.y;else{const x=u[0];if(x.a==0)et=-x.c/x.b;else if(x.b==0)T=-x.c/x.a;else{const M=-x.a/x.b,D=-x.c/x.b;et=M*T+D}}else if(u.length===2){const x=u[0],M=u[1],D=x.a*M.b-M.a*x.b;D!==0&&(T=-(x.c*M.b-M.c*x.b)/D,et=-(x.a*M.c-M.a*x.c)/D)}it(u),st(S)}const o=T-B,b=et-K;n.forEach(u=>{e.current.hasNode(u)&&e.current.updateNodeAttributes(u,S=>({...S,x:Y(S.x+o,.01),y:Y(S.y+b,.01)}))})}else it([]),st(void 0),n.forEach(B=>{e.current.hasNode(B)&&e.current.updateNodeAttributes(B,K=>({...K,x:Y(K.x-(s.x-X)*f/100,L.altKey?.01:5),y:Y(K.y-(s.y-F)*f/100,L.altKey?.01:5)}))});t(vt()),t(bt())}else a.startsWith("line")&&c&&P({dx:(s.x-X)*f/100,dy:(s.y-F)*f/100})}),U=nt((C,L)=>{var X,F,B;if(L.currentTarget.releasePointerCapture(L.pointerId),a.startsWith("line")){N||t(yt("free"));const K=e.current.hasNode(c)&&Fe.includes(e.current.getNodeAttribute(c,"type")),R=["stn_core_","virtual_circle_","misc_node_connectable_"],T=(B=(F=(X=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:X.attributes)==null?void 0:F.getNamedItem("id"))==null?void 0:B.value,et=R.find(o=>T==null?void 0:T.startsWith(o));if(K&&et){const o=a.slice(5),b="line_".concat(gt(10)),[u,S]=[c,T.slice(et.length)];if(u!==S){const x=r?Gt(e.current,o,u,S,"from"):-1;e.current.addDirectedEdgeWithKey(b,u,S,{visible:!0,zIndex:0,type:o,[o]:structuredClone(Z[o].defaultAttrs),style:At.SingleColor,[At.SingleColor]:{color:A},reconcileId:"",parallelIndex:x}),t(pt(new Set([b]))),y&&xt.event(mt.ADD_LINE,{type:o}),t(Pt(e.current.export())),t(bt())}}}else if(a==="free"&&c){const{x:K,y:R}=ct(L);s.x-K===0&&s.y-R===0||(t(Pt(e.current.export())),t(vt()))}it([]),st(void 0),zt(void 0),t(St(void 0))}),dt=nt((C,L)=>{if(L.stopPropagation(),L.shiftKey||t(Ct()),L.shiftKey&&n.has(C)?t($t(C)):t(It(C)),a.startsWith("station")||a.startsWith("misc-node-virtual")||a.startsWith("misc-node-master")){const X=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,F=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,B=a.startsWith("station"),K=gt(10),R=B?"stn_".concat(K):"misc_node_".concat(K),V=B?a.slice(8):a.slice(10),{x:T,y:et}=ht(X,F,f,p),o=B?structuredClone(lt[V].defaultAttrs):structuredClone(wt[V].defaultAttrs);"color"in o&&(o.color=A),e.current.addNode(R,{visible:!0,zIndex:0,x:Y(T,5),y:Y(et,5),type:V,[V]:o});const b=e.current.getEdgeAttributes(C),{zIndex:u,type:S,style:x}=b,M=b[S],D=b[x],[I,q]=e.current.extremities(C),rt=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(gt(10)),I,R,{visible:!0,zIndex:u,type:S,[S]:structuredClone(M),style:x,[x]:structuredClone(D),reconcileId:"",parallelIndex:rt}),e.current.addDirectedEdgeWithKey("line_".concat(gt(10)),R,q,{visible:!0,zIndex:u,type:S,[S]:structuredClone(M),style:x,[x]:structuredClone(D),reconcileId:"",parallelIndex:rt}),e.current.dropEdge(C),h(),y&&(xt.event(mt.ADD_STATION,{type:V}),xt.event(mt.ADD_LINE,{type:S})),t(yt("free")),t(pt(new Set([R])))}}),ot=$.useMemo(()=>[...Be(e.current),...We(e.current)],[v,l]),at=Ot.component;return m.jsxs(m.Fragment,{children:[m.jsx(Xe,{elements:ot,handlePointerDown:E,handlePointerMove:W,handlePointerUp:U,handleEdgePointerDown:dt}),a.startsWith("line")&&c&&c!=="background"&&m.jsx(at,{id:"line_create_in_progress___no_use",type:a.slice(5),path:Z[a.slice(5)].generatePath(e.current.getNodeAttribute(c,"x"),e.current.getNodeAttribute(c,"x")-d.dx,e.current.getNodeAttribute(c,"y"),e.current.getNodeAttribute(c,"y")-d.dy,Z[a.slice(5)].defaultAttrs),styleAttrs:{color:A},newLine:!0,handlePointerDown:()=>{}}),z.length!==0&&z.map(C=>m.jsx("path",{d:Z[Q.Simple].generatePath(...ce(C,Et(p,f,_,g)),Z[Q.Simple].defaultAttrs),stroke:"cyan",strokeWidth:f/75},"snap_line_".concat(C.a,"_").concat(C.b,"_").concat(C.c,"_").concat(C.node))),H&&m.jsx(Re,{activeSnapPoint:H})]})},Ze=()=>{const t=Mt(),e=$.useRef(window.graph),h=()=>{t(Pt(e.current.export())),t(vt()),t(bt())},{activeSubscriptions:y}=tt(o=>o.account),{telemetry:{project:r},preference:{gridLines:i,snapLines:w,predictNextNode:f,autoParallel:p}}=tt(o=>o.app),{svgViewBoxZoom:n,svgViewBoxMin:s}=tt(o=>o.param),{selected:c,active:l,isDetailsOpen:v,mode:a,lastTool:N,keepLastPath:A,theme:k,count:{masters:g,lines:_}}=tt(o=>o.runtime),d=Yt(),{height:P,width:j}=Ut(d),O=!y.RMP_CLOUD&&g+1>de,G=!y.RMP_CLOUD&&_+1>ue,J=Qt();he();const[z,it]=$.useState({x:0,y:0}),[H,st]=$.useState({x:0,y:0}),[E,W]=$.useState({x:0,y:0}),[U,dt]=$.useState({x:0,y:0}),ot=nt(async o=>{const{x:b,y:u}=ct(o);if(a.startsWith("station")||a.startsWith("misc-node")){t(yt("free"));const S=gt(10),{x,y:M}=ht(b,u,n,s),D=a.startsWith("station"),I=D?"stn_".concat(S):"misc_node_".concat(S),q=D?a.slice(8):a.slice(10),rt=structuredClone({...lt,...wt}[q].defaultAttrs);Vt.has(q)&&(rt.color=k),D&&(rt.names=await J(q)),e.current.addNode(I,{visible:!0,zIndex:0,x:Y(x,5),y:Y(M,5),type:q,[q]:rt}),r&&xt.event(mt.ADD_STATION,{type:q}),h(),t(pt(new Set([I])))}else a==="free"||a.startsWith("line")?(a.startsWith("line")&&(t(yt("free")),A&&t(Se(!1))),W({x:b,y:u}),dt(s),o.shiftKey||(t(St("background")),t(Ct()))):a==="select"&&(it(ht(b,u,n,s)),st(ht(b,u,n,s)))}),at=nt(o=>{if(a==="select"){if(z.x!=0&&z.y!=0){const{x:b,y:u}=ct(o);st(ht(b,u,n,s))}}else if(l==="background"){const{x:b,y:u}=ct(o);t(kt({x:U.x+(E.x-b)*n/100,y:U.y+(E.y-u)*n/100}))}}),C=nt(o=>{if(a==="select"){const{x:b,y:u}=ct(o),{x:S,y:x}=ht(b,u,n,s),M=qt(e.current,z.x,z.y,S,x),D=_e(e.current,new Set(M));t(pt(new Set([...o.shiftKey?c:[],...M,...D]))),t(yt("free")),it({x:0,y:0}),st({x:0,y:0})}l==="background"&&!o.shiftKey&&t(St(void 0))}),L=nt(o=>{let b=n;o.deltaY>0&&n+10<400?b=n+10:o.deltaY<0&&n-10>0&&(b=n-10),t(Tt(b));const{x:u,y:S}=ct(o),x=o.currentTarget.getBoundingClientRect(),[M,D]=[u/x.width,S/x.height];t(kt({x:s.x+u*n/100-j*b/100*M,y:s.y+S*n/100-P*b/100*D}))}),X=nt(async o=>{if(ft?o.key==="Backspace":o.key==="Delete")c.size>0&&(c.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),t(Ct()),h());else if(o.key.startsWith("Arrow")){const u=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,S=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;t(kt(ht(100*u,100*S,n,s)))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const u=(o.key==="j"?-1:o.key==="l"?1:0)*10,S=(o.key==="i"?-1:o.key==="k"?1:0)*10;c.size>0&&c.forEach(x=>{e.current.hasNode(x)&&(e.current.updateNodeAttribute(x,"x",M=>(M!=null?M:0)+u),e.current.updateNodeAttribute(x,"y",M=>(M!=null?M:0)+S),h())})}else if(o.key==="f"&&N)t(yt(N));else if(o.key==="z"&&(ft?o.metaKey&&!o.shiftKey:o.ctrlKey))ft&&o.preventDefault(),t(pe()),t(vt()),t(bt());else if(o.key==="s")t(yt("select"));else if((o.key==="c"||o.key==="x")&&(ft?o.metaKey&&!o.shiftKey:o.ctrlKey)){const b=Ce(e.current,c);navigator.clipboard.writeText(b),o.key==="x"&&(t(Ct()),c.forEach(u=>{e.current.hasNode(u)?e.current.dropNode(u):e.current.hasEdge(u)&&e.current.dropEdge(u)}),h())}else if(o.key==="v"&&(ft?o.metaKey&&!o.shiftKey:o.ctrlKey)){const b=await navigator.clipboard.readText(),{x:u,y:S}=ht(j/2,P/2,n,s),{nodes:x,edges:M}=Me(b,e.current,O,G,Y(u,5),Y(S,5));h();const D=structuredClone(x);M.forEach(I=>D.add(I)),t(pt(D))}else if(ft&&o.key==="z"&&o.metaKey&&o.shiftKey||!ft&&o.key==="y"&&o.ctrlKey)t(xe());else if(o.key==="c")t(me(!w));else if(o.key==="e"){const[b]=c;if(c.size===1&&e.current.hasEdge(b)){const u=e.current.getEdgeAttributes(b),{type:S}=u;if(S!==Q.Simple&&u[S]){const x=u[S],D=(x.startFrom||"from")==="from"?"to":"from";let I=u.parallelIndex;if(p){const[rt,te]=e.current.extremities(b);I=Gt(e.current,S,rt,te,D)}const q={...x,startFrom:D};e.current.mergeEdgeAttributes(b,{[S]:q,parallelIndex:I}),h()}}}}),[F,B]=$.useState(0),K=nt(o=>{if(o.touches.length===2){t(St(void 0));const[b,u]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY];B(b*b+u*u)}}),R=nt(o=>{if(F!==0&&o.touches.length===2){const[b,u]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY],S=b*b+u*u;let x=n;S-F<0&&n+10<=390?x=n+10:S-F>0&&n-10>=10&&(x=n-10),t(Tt(x)),B(S);const M=o.currentTarget.getBoundingClientRect(),[D,I]=[(o.touches[0].clientX+o.touches[1].clientX)/2-M.left,(o.touches[0].clientY+o.touches[1].clientY)/2-M.top],[q,rt]=[D/M.width,I/M.height];t(kt({x:s.x+D*n/100-j*x/100*q,y:s.y+I*n/100-P*x/100*rt}))}}),V=nt(o=>{F!==0&&B(0)}),[T,et]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{et({sx:z.x<=H.x?z.x:H.x,ex:z.x>H.x?z.x:H.x,sy:z.y<=H.y?z.y:H.y,ey:z.y>H.y?z.y:H.y})},[H.x,H.y]),m.jsxs(m.Fragment,{children:[m.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:P,width:j,viewBox:"".concat(s.x," ").concat(s.y," ").concat(j*n/100," ").concat(P*n/100),onPointerDown:ot,onPointerMove:at,onPointerUp:C,onTouchStart:K,onTouchMove:R,onTouchEnd:V,onWheel:L,tabIndex:0,onKeyDown:X,children:[m.jsx("defs",{children:m.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[m.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),m.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),i&&m.jsx(Ee,{svgViewBoxMin:s,svgViewBoxZoom:n,svgWidth:j,svgHeight:P}),f&&c.size===1&&a==="free"&&m.jsx(ze,{}),m.jsx(ke.SvgAssetsContextProvider,{children:m.jsx(Ke,{})}),a==="select"&&z.x!=0&&z.y!=0&&m.jsx("rect",{x:T.sx,y:T.sy,width:T.ex-T.sx,height:T.ey-T.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"})]}),ye()&&v==="hide"&&m.jsx(ne,{"aria-label":"open details panel",icon:m.jsx(ge,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(fe()),style:{position:"fixed",bottom:20,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Ze as default};

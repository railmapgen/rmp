import{j as b,ad as Vt}from"./chakra-BujJOmjW.js";import{N as Wt,ar as Ct,as as Ft,a3 as Et,k as G,o as F,at as Ut,au as qt,av as Gt,aw as Mt,d as J,c as Ht,p as Rt,ax as _t,ay as Q,az as tt,aA as dt,T as it,aB as jt,aC as Nt,aD as B,q as ut,t as ct,aE as rt,n as at,m as Zt,l as zt,r as ht,E as ft,v as xt,y as mt,U as Z,aF as Qt,aG as Jt,S as te,aH as ee,a0 as ne,ab as ot,A as pt,ao as se,ap as oe,z as Dt,a1 as ie}from"./index-C1_QaR8j.js";import{s as yt,u as Xt,f as Kt,g as re,b as ae,c as ce,e as le,h as de,j as ue,F as he,l as fe,S as ye,k as ge}from"./master-manager-DJwVrWaw.js";import{j as Yt,b as z}from"./react-D4c9atUM.js";import{u as q,e as pe,i as xe}from"./clipboard-DYgqIeM4.js";import{m as gt}from"./misc-nodes-BiZ6tjVl.js";const me={[Et.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Et.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ve=t=>{const e=me[t];return e.at(Math.floor(Math.random()*e.length))},$t=Yt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:f})=>{const{token:i}=e().account;if(!i){u(Ct({cityName:t,names:[]}));return}const c=await fetch("".concat(Ft,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(i)}});if(!c.ok)return Wt.warn("Failed to fetch random station names",c.statusText),f(c.statusText);const P=await c.json();u(Ct({cityName:t,names:P}))}),Tt=Yt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var a;const{stationNames:f}=e().runtime,i=f[t];if(((a=i==null?void 0:i.length)!=null?a:0)==0)return Wt.debug("No random station names in cache, using fallback"),u($t({cityName:t})),Object.values(ve(t));const c=structuredClone(i),P=c.shift();return u(Ct({cityName:t,names:c})),c.length<3&&u($t({cityName:t})),Object.values(P)}),Ot=(t,e,u,f,i,c)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return It(t,e,u,f,i)?{x1:e,y1:u,x2:f,y2:i,offset:c.offsetFrom}:void 0;const[P,a]=[c.offsetFrom,c.offsetTo];for(let d=0;d<Math.PI;d+=Math.PI/8)for(let s=d,r=0;r<2;r++,s+=Math.PI){const[v,o,x,A]=[Math.sin(d)*P,Math.cos(d)*P,Math.sin(s)*a,Math.cos(s)*a];if(It(t,e+v,u+o,f+x,i+A))return{x1:e+v,y1:u+o,x2:f+x,y2:i+A,offset:0}}},Se=(t,e,u,f,i,c)=>t===u?{x1:t+5*c,y1:e,x2:u+5*c,y2:f,offset:i}:e===f?{x1:t,y1:e+5*c,x2:u,y2:f+5*c,offset:i}:{x1:t+5*Math.SQRT1_2*c,y1:e+5*Math.SQRT1_2*c,x2:u+5*Math.SQRT1_2*c,y2:f+5*Math.SQRT1_2*c,offset:i},It=(t,e,u,f,i)=>!!((e===f||u===i)&&[G.Diagonal,G.Perpendicular].includes(t)||Math.abs((i-u)/(f-e))===1&&[G.Diagonal,G.RotatePerpendicular].includes(t)),be=(t,e)=>{const u=[],f=[];return Object.values(e).forEach(i=>{var E;if(i.length===1){f.push(...i.map(y=>y.edge));return}const c=t.getEdgeAttribute(i.at(0),"type");if(!i.every(y=>t.getEdgeAttribute(y,"type")===c)){f.push(...i.map(y=>y.edge));return}const P=t.getEdgeAttribute(i.at(0),"style");if(!i.every(y=>t.getEdgeAttribute(y,"style")===P)){f.push(...i.map(y=>y.edge));return}const a={},d=new Set,s=new Set,r=Object.fromEntries(i.map(y=>{var M,$;const[g,l]=t.extremities(y);return a[g]=((M=a[g])!=null?M:0)+1,a[l]=(($=a[l])!=null?$:0)+1,d.add(g),s.add(l),[g,[y.edge,l]]})),v=Array.from(d).filter(y=>a[y]===1),o=Array.from(s).filter(y=>a[y]===1);if(v.length!==1||o.length!==1){f.push(...i.map(y=>y.edge));return}const x=v[0],A=o[0];if(x===A){f.push(...i.map(y=>y.edge));return}const _=[r[x][0]];let C=r[x][1];for(let y=1;y<i.length;y=y+1){const g=(E=r[C])==null?void 0:E.at(1);if(!g){f.push(...i.map(l=>l.edge));return}_.push(r[C][0]),C=g}if(C!==A||_.length!==i.length){f.push(...i.map(y=>y.edge));return}u.push(_)}),{allReconciledLines:u,danglingLines:f}},Ae=(t,e)=>{if(!e.every(i=>t.hasEdge(i)))return;const u=e.map(i=>{var o,x,A;const[c,P]=t.extremities(i),a=t.getNodeAttributes(c),d=t.getNodeAttributes(P),{type:s}=t.getEdgeAttributes(i),r=(o=t.getEdgeAttribute(i,s))!=null?o:F[s].defaultAttrs,v=Ot(s,a.x,a.y,d.x,d.y,r);if(v){const{x1:_,y1:C,x2:E,y2:y,offset:g}=v;return F[G.Simple].generatePath(_,E,C,y,{offset:g})}return(A=(x=F[s])==null?void 0:x.generatePath(a.x,d.x,a.y,d.y,r))!=null?A:"M ".concat(a.x," ").concat(a.y," L ").concat(d.x," ").concat(d.y)});let f="".concat(u[0]," ");for(let i=1;i<e.length;i=i+1)f+=u[i].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return f},we=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Pe=t=>{const e={},u={},f=[],i={},c=[];for(const s of t.edgeEntries()){const[r,v,o,x]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],A=s.attributes[s.attributes.type],_=Ot(s.attributes.type,r,v,o,x,A);u[s.edge]=_}for(const s of t.edgeEntries()){let r=u[s.edge];const{parallelIndex:v}=s.attributes;if(v>=0){const o=Ut(t,s.attributes.type,s.edge),x=u[o];if(!x){f.push(s);continue}if(v>0){const{x1:A,y1:_,x2:C,y2:E,offset:y}=x;r=Se(A,_,C,E,y,v)}}if(s.attributes.reconcileId!==""){const o=s.attributes.reconcileId;o in i?i[o].push(s):i[o]=[s];continue}if(r){const o=s.edge,x=s.attributes,{x1:A,y1:_,x2:C,y2:E,offset:y}=r;e[o]={attr:x,path:F[G.Simple].generatePath(A,C,_,E,{offset:y})};continue}c.push(s)}const P=new Set;for(;f.length;){const s=f.pop();if(P.has(s.edge))continue;const{parallel:r}=qt(t,s);if(!r.length)continue;r.forEach(o=>P.add(o.edge));const v=Gt(r);for(const o of r){const x=o.edge;e[x]={attr:o.attributes,path:v[x]}}}const{allReconciledLines:a,danglingLines:d}=be(t,i);for(const s of a){const r=Ae(t,s);if(!r)continue;const v=s[0];e[v]={attr:t.getEdgeAttributes(v),path:r}}for(const s of d){const r=t.getEdgeAttributes(s),[v,o]=t.extremities(s),x=t.getNodeAttributes(v),A=t.getNodeAttributes(o);e[s]={attr:r,path:F[G.Simple].generatePath(x.x,A.x,x.y,A.y,F[G.Simple].defaultAttrs)}}for(const s of c){const r=s.edge,v=s.attributes.type,o=s.attributes,[x,A,_,C]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(v in F)){e[r]={attr:o,path:"M ".concat(x," ").concat(A," L ").concat(_," ").concat(C)};continue}e[r]={attr:o,path:F[v].generatePath(x,_,A,C,o[v])}}return Object.entries(e).map(([s,r])=>({id:s,type:"line",line:r}))},Bt=t=>{const{id:e,x:u,y:f,handlePointerDown:i,handlePointerMove:c,handlePointerUp:P}=t,a=z.useCallback(r=>i(e,r),[e,i]),d=z.useCallback(r=>c(e,r),[e,c]),s=z.useCallback(r=>P(e,r),[e,P]);return b.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(f-6.4,")scale(0.025)"),onPointerDown:a,onPointerMove:d,onPointerUp:s,style:{cursor:"move"},children:b.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ke=t=>{const{id:e,path:u,handlePointerDown:f}=t,i=z.useCallback(c=>f(e,c),[e,f]);return b.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},Me=z.memo(t=>{var d,s,r,v,o,x,A,_,C,E,y,g;const{elements:e,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i,handleEdgePointerDown:c}=t,P=Object.fromEntries(Array.from({length:21},(l,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const M=l.line.attr.type,$=l.line.attr.style,Y=l.line.attr[$],D=(d=Mt[$])==null?void 0:d.preComponent;D&&P[l.line.attr.zIndex].pre.push(b.jsx(D,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},"".concat(l.id,".pre")));const O=(r=(s=Mt[$])==null?void 0:s.component)!=null?r:ke;P[l.line.attr.zIndex].main.push(b.jsx(O,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},l.id));const K=(v=Mt[$])==null?void 0:v.postComponent;K&&P[l.line.attr.zIndex].post.push(b.jsx(K,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},"".concat(l.id,".post")))}else if(l.type==="station"){const M=l.station,$=M.type,Y=(o=yt[$])==null?void 0:o.preComponent;Y&&P[l.station.zIndex].pre.push(b.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".pre")));const D=(A=(x=yt[$])==null?void 0:x.component)!=null?A:Bt;P[l.station.zIndex].main.push(b.jsx(D,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},l.id));const O=(_=yt[$])==null?void 0:_.postComponent;O&&P[l.station.zIndex].post.push(b.jsx(O,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const M=l.miscNode,$=M.type,Y=(C=gt[$])==null?void 0:C.preComponent;Y&&P[l.miscNode.zIndex].pre.push(b.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".pre")));const D=(y=(E=gt[$])==null?void 0:E.component)!=null?y:Bt;P[l.miscNode.zIndex].main.push(b.jsx(D,{id:l.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},l.id));const O=(g=gt[$])==null?void 0:g.postComponent;O&&P[l.miscNode.zIndex].post.push(b.jsx(O,{id:l.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".post")))}return Array.from({length:21},(l,M)=>(M-10).toString()).map(l=>[...P[l].pre,...P[l].main,...P[l].post]).flat()},(t,e)=>t.elements===e.elements),Ce=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=J(o=>o.param),f=o=>{const A=[{x:o.x,y:o.y},...o.originalNodesPos].sort((C,E)=>C.x===E.x?C.y-E.y:C.x-E.x),_=(A[1].y-A[0].y)/(A[1].x-A[0].x);if(Math.abs(_)<=.01)return{original:A,offset:A.map(C=>({x:C.x,y:C.y+10})),rotate:0};if(Math.abs(_)>=1e10)return{original:A,offset:A.map(C=>({x:C.x+10,y:C.y})),rotate:90};{const E=-1/_,y=10/Math.sqrt(E*E+1),g=10*E/Math.sqrt(E*E+1);return{original:A,offset:A.map(l=>({x:l.x+y,y:l.y+g})),rotate:-Math.atan(E)*(180/Math.PI)}}},{original:i,offset:c,rotate:P}=f(e),a=o=>{const x=Math.sqrt(3)/2*o,A="0,0",_="".concat(-o/2,",").concat(x),C="".concat(o/2,",").concat(x);return"".concat(A," ").concat(_," ").concat(C)},d=u/75,s=8*d,r="#FC8181",v="".concat(d*5," ").concat(d*2);return b.jsxs(b.Fragment,{children:[b.jsx("line",{x1:c[0].x,y1:c[0].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:v}),b.jsx("line",{x1:c[1].x,y1:c[1].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:v}),b.jsx("line",{x1:i[0].x,y1:i[0].y,x2:c[0].x,y2:c[0].y,stroke:r,strokeWidth:d,strokeDasharray:v}),b.jsx("line",{x1:i[1].x,y1:i[1].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:v}),b.jsx("line",{x1:i[2].x,y1:i[2].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:v}),b.jsx("polygon",{points:a(s),transform:"translate(".concat(c[0].x,",").concat(c[0].y,") rotate(").concat((P+270)%360,")"),fill:r}),b.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((P+270)%360,")"),fill:r}),b.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((P+90)%360,")"),fill:r}),b.jsx("polygon",{points:a(s),transform:"translate(".concat(c[2].x,",").concat(c[2].y,") rotate(").concat((P+90)%360,")"),fill:r})]})},Ee=[...Object.values(te),rt.Virtual,rt.Master,rt.LondonArrow,rt.ChongqingRTNumLineBadge2021,rt.ChongqingRTTextLineBadge2021,rt.ChengduRTLineBadge],_e=()=>{const t=Ht(),e=z.useRef(window.graph),u=()=>{t(ut()),t(ct()),t(xt(e.current.export()))},{telemetry:{project:f},preference:{autoParallel:i,gridLines:c,snapLines:P}}=J(k=>k.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=J(k=>k.param),{selected:s,refresh:{nodes:r,edges:v},mode:o,active:x,keepLastPath:A,theme:_}=J(k=>k.runtime),C=Xt(),{height:E,width:y}=Rt(C),[g,l]=z.useState(),[M,$]=z.useState({dx:0,dy:0}),[Y,D]=z.useState([]),[O,K]=z.useState([]),[et,nt]=z.useState([]);z.useEffect(()=>{if(!g||!P)return;const k=_t(d,a,y,E),N=Kt(e.current,...Object.values(k));K(N),D(re(e.current,N))},[d,a,y,E,g]);const[lt,st]=z.useState(void 0),vt=q((k,N)=>{N.stopPropagation(),o==="select"&&t(Q("free"));const V=N.currentTarget,{x:U,y:X}=tt(N);V.setPointerCapture(N.pointerId),nt([]),st(void 0),l({x:U,y:X}),t(dt(k)),N.shiftKey?s.has(k)?t(jt(k)):t(Nt(k)):s.has(k)||t(it(new Set([k])))}),St=q((k,N)=>{const{x:V,y:U}=tt(N);if(o==="free"&&x===k){if(!N.altKey&&P){const X=e.current.getNodeAttribute(k,"x"),W=e.current.getNodeAttribute(k,"y"),H=X-(g.x-V)*a/100,n=W-(g.y-U)*a/100;let p=H,S=n;if(ae(k,e.current)){let h=et,m=lt;if(h.length!==0&&(h=h.filter(w=>ce(w,H,n)<=6)),m&&(h.length===0||Math.hypot(H-m.x,n-m.y)>6)&&(m=void 0),!m&&h.length===1){const w=h[0],{snapPoint:T,distance:R}=le(e.current,O.filter(I=>!s.has(I)),H,n,w);R<=3&&(m=T)}if(h.length===1&&!m||h.length===0){const{l:w,d:T}=de(H,n,Y,O.filter(I=>!s.has(I)&&!h.some(kt=>kt.node===I))),R=h.length===0||!h.some(I=>I.a===w.a&&I.b===w.b);T<3&&h.length<2&&R&&h.push(w)}if(h.length===1)if(m)p=m.x,S=m.y;else{const w=h[0];if(w.a==0)S=-w.c/w.b;else if(w.b==0)p=-w.c/w.a;else{const T=-w.a/w.b,R=-w.c/w.b;S=T*p+R}}else if(h.length===2){const w=h[0],T=h[1],R=w.a*T.b-T.a*w.b;R!==0&&(p=-(w.c*T.b-T.c*w.b)/R,S=-(w.a*T.c-T.a*w.c)/R)}nt(h),st(m)}const j=p-X,L=S-W;s.forEach(h=>{e.current.hasNode(h)&&e.current.updateNodeAttributes(h,m=>({...m,x:B(m.x+j,.01),y:B(m.y+L,.01)}))})}else nt([]),st(void 0),s.forEach(X=>{e.current.hasNode(X)&&e.current.updateNodeAttributes(X,W=>({...W,x:B(W.x-(g.x-V)*a/100,N.altKey?.01:5),y:B(W.y-(g.y-U)*a/100,N.altKey?.01:5)}))});t(ut()),t(ct())}else o.startsWith("line")&&$({dx:(g.x-V)*a/100,dy:(g.y-U)*a/100})}),bt=q((k,N)=>{if(o.startsWith("line")){A||t(Q("free"));const V=e.current.hasNode(x)&&Ee.includes(e.current.getNodeAttribute(x,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(X=>{var p,S;const H=(S=(p=document.elementsFromPoint(N.clientX,N.clientY)[0].attributes)==null?void 0:p.getNamedItem("id"))==null?void 0:S.value,n=H==null?void 0:H.startsWith(X);if(V&&n){const j=o.slice(5),L="line_".concat(at(10)),[h,m]=[x,H.slice(X.length)],w=i?Zt(e.current,j,h,m,"from"):-1;e.current.addDirectedEdgeWithKey(L,h,m,{visible:!0,zIndex:0,type:j,[j]:structuredClone(F[j].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:_},reconcileId:"",parallelIndex:w}),t(it(new Set([L]))),f&&ht.event(ft.ADD_LINE,{type:j})}}),t(ct()),t(xt(e.current.export()))}else if(o==="free"&&x){const{x:V,y:U}=tt(N);g.x-V===0&&g.y-U===0||t(xt(e.current.export()))}nt([]),st(void 0),l(void 0),t(dt(void 0))}),At=q((k,N)=>{if(N.stopPropagation(),N.shiftKey||t(mt()),N.shiftKey&&s.has(k)?t(jt(k)):t(Nt(k)),o.startsWith("station")||o.startsWith("misc-node-virtual")||o.startsWith("misc-node-master")){const V=N.clientX-document.getElementById("canvas").getBoundingClientRect().left,U=N.clientY-document.getElementById("canvas").getBoundingClientRect().top,X=o.startsWith("station"),W=at(10),H=X?"stn_".concat(W):"misc_node_".concat(W),n=X?o.slice(8):o.slice(10),{x:p,y:S}=Z(V,U,a,d),j=X?structuredClone(yt[n].defaultAttrs):structuredClone(gt[n].defaultAttrs);"color"in j&&(j.color=_),e.current.addNode(H,{visible:!0,zIndex:0,x:B(p,5),y:B(S,5),type:n,[n]:j});const L=e.current.getEdgeAttributes(k),{zIndex:h,type:m,style:w}=L,T=L[m],R=L[w],[I,kt]=e.current.extremities(k),Lt=i?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(at(10)),I,H,{visible:!0,zIndex:h,type:m,[m]:structuredClone(T),style:w,[w]:structuredClone(R),reconcileId:"",parallelIndex:Lt}),e.current.addDirectedEdgeWithKey("line_".concat(at(10)),H,kt,{visible:!0,zIndex:h,type:m,[m]:structuredClone(T),style:w,[w]:structuredClone(R),reconcileId:"",parallelIndex:Lt}),e.current.dropEdge(k),u(),f&&(ht.event(ft.ADD_STATION,{type:n}),ht.event(ft.ADD_LINE,{type:m})),t(Q("free")),t(it(new Set([H])))}}),wt=z.useMemo(()=>[...Pe(e.current),...we(e.current)],[v,r]),Pt=Qt.component;return b.jsxs(b.Fragment,{children:[b.jsx(Me,{elements:wt,handlePointerDown:vt,handlePointerMove:St,handlePointerUp:bt,handleEdgePointerDown:At}),o.startsWith("line")&&x&&x!=="background"&&b.jsx(Pt,{id:"line_create_in_progress___no_use",type:o.slice(5),path:F[o.slice(5)].generatePath(e.current.getNodeAttribute(x,"x"),e.current.getNodeAttribute(x,"x")-M.dx,e.current.getNodeAttribute(x,"y"),e.current.getNodeAttribute(x,"y")-M.dy,F[o.slice(5)].defaultAttrs),styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),et.length!==0&&et.map(k=>b.jsx("path",{d:F[G.Simple].generatePath(...Jt(k,_t(d,a,y,E)),F[G.Simple].defaultAttrs),stroke:"cyan",strokeWidth:a/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),lt&&b.jsx(Ce,{activeSnapPoint:lt})]})},Le=z.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:f,svgHeight:i}=t,{preference:{toolsPanel:{expand:c}}}=J(E=>E.app),a=Vt().colorMode==="light"?"#666464":"#D3D3D4",d=_t(e,u,f,i),s=c?410*u/100:0,r=u>30?u>120?50:25:5,v=u/200,o={startX:B(d.xMin+s-r,r),endX:B(d.xMax+s+r,r),startY:B(d.yMin-r,r),endY:B(d.yMax+r,r)},x=Array.from({length:(o.endX-o.startX)/r+1},(E,y)=>{const g=o.startX+y*r,l=g%(r*5)===0?2*v:v;return b.jsx("line",{x1:g,y1:o.startY,x2:g,y2:o.endY,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_vl_".concat(g))}),A=Array.from({length:(o.endY-o.startY)/r+1},(E,y)=>{const g=o.startY+y*r,l=g%(r*5)===0?2*v:v;return b.jsx("line",{x1:o.startX,y1:g,x2:o.endX,y2:g,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_hl_".concat(g))}),_=Array.from({length:(o.endX-o.startX)/r/5+1},(E,y)=>{const g=B(o.startX,5*r)+y*5*r;return b.jsx("text",{x:g,y:d.yMin+u/5,fontSize:v*25,fill:a,textAnchor:"middle",opacity:"0.5",children:g},"grid_vc_".concat(g))}),C=Array.from({length:(o.endY-o.startY)/r/5+1},(E,y)=>{const g=B(o.startY,5*r)+y*5*r;return b.jsx("text",{x:d.xMin+u/8+s,y:g,fontSize:v*25,fill:a,textAnchor:"start",opacity:"0.5",children:g},"grid_hc_".concat(g))});return b.jsxs("g",{id:"grid-lines",className:"removeMe",children:[x,A,_,C]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Ie=()=>{const t=Ht(),e=z.useRef(window.graph),u=()=>{t(ut()),t(ct()),t(xt(e.current.export()))},{activeSubscriptions:f}=J(n=>n.account),{telemetry:{project:i},preference:{randomStationsNames:c,gridLines:P}}=J(n=>n.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=J(n=>n.param),{mode:s,lastTool:r,active:v,selected:o,keepLastPath:x,theme:A,refresh:{nodes:_},masterNodesCount:C,parallelLinesCount:E}=J(n=>n.runtime),y=Xt(),{height:g,width:l}=Rt(y),M=!f.RMP_CLOUD&&C+1>ee,$=!f.RMP_CLOUD&&E+1>ne,Y=!f.RMP_CLOUD||c==="none";z.useEffect(()=>{const n=ue(e.current);Object.entries(n).filter(([p,S])=>S&&p in he).forEach(([p])=>fe(p))},[_]);const[D,O]=z.useState({x:0,y:0}),[K,et]=z.useState({x:0,y:0}),[nt,lt]=z.useState({x:0,y:0}),[st,vt]=z.useState({x:0,y:0}),St=q(async n=>{const{x:p,y:S}=tt(n);if(s.startsWith("station")){t(Q("free"));const j=at(10),L="stn_".concat(j),h=s.slice(8),m=structuredClone(yt[h].defaultAttrs);if("color"in m&&(m.color=A),!Y){const R=await t(Tt(Et.Shmetro));if(Tt.fulfilled.match(R)){const I=R.payload;m.names.length>I.length?I.push(...Array(m.names.length-I.length).fill(I.at(-1))):m.names.length<I.length&&I.splice(m.names.length,I.length-m.names.length),m.names=I}}const{x:w,y:T}=Z(p,S,a,d);e.current.addNode(L,{visible:!0,zIndex:0,x:B(w,5),y:B(T,5),type:h,[h]:m}),u(),i&&ht.event(ft.ADD_STATION,{type:h}),t(it(new Set([L])))}else if(s.startsWith("misc-node")){t(Q("free"));const j=at(10),L="misc_node_".concat(j),h=s.slice(10),{x:m,y:w}=Z(p,S,a,d);e.current.addNode(L,{visible:!0,zIndex:0,x:B(m,5),y:B(w,5),type:h,[h]:structuredClone(gt[h].defaultAttrs)}),u(),i&&ht.event(ft.ADD_STATION,{type:h}),t(it(new Set([L])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(Q("free")),x&&t(ie(!1))),lt({x:p,y:S}),vt(d),n.shiftKey||(t(dt("background")),t(mt()))):s==="select"&&(O(Z(p,S,a,d)),et(Z(p,S,a,d)))}),bt=q(n=>{if(s==="select"){if(D.x!=0&&D.y!=0){const{x:p,y:S}=tt(n);et(Z(p,S,a,d))}}else if(v==="background"){const{x:p,y:S}=tt(n);t(pt({x:st.x+(nt.x-p)*a/100,y:st.y+(nt.y-S)*a/100}))}}),At=q(n=>{if(s==="select"){const{x:p,y:S}=tt(n),{x:j,y:L}=Z(p,S,a,d),h=Kt(e.current,D.x,D.y,j,L),m=ge(e.current,new Set(h));t(it(new Set([...n.shiftKey?o:[],...h,...m]))),t(Q("free")),O({x:0,y:0}),et({x:0,y:0})}v==="background"&&!n.shiftKey&&t(dt(void 0))}),wt=q(n=>{let p=a;n.deltaY>0&&a+10<400?p=a+10:n.deltaY<0&&a-10>0&&(p=a-10),t(Dt(p));const{x:S,y:j}=tt(n),L=n.currentTarget.getBoundingClientRect(),[h,m]=[S/L.width,j/L.height];t(pt({x:d.x+S*a/100-l*p/100*h,y:d.y+j*a/100-g*p/100*m}))}),Pt=q(async n=>{if(ot?n.key==="Backspace":n.key==="Delete")o.size>0&&(o.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(mt()),u());else if(n.key.startsWith("Arrow")){const S=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,j=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(Z(100*S,100*j,a,d)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const S=(n.key==="j"?-1:n.key==="l"?1:0)*10,j=(n.key==="i"?-1:n.key==="k"?1:0)*10;o.size>0&&o.forEach(L=>{e.current.hasNode(L)&&(e.current.updateNodeAttribute(L,"x",h=>(h!=null?h:0)+S),e.current.updateNodeAttribute(L,"y",h=>(h!=null?h:0)+j),u())})}else if(n.key==="f"&&r)t(Q(r));else if(n.key==="z"&&(ot?n.metaKey&&!n.shiftKey:n.ctrlKey))ot&&n.preventDefault(),t(se()),t(ut()),t(ct());else if(n.key==="s")t(Q("select"));else if((n.key==="c"||n.key==="x")&&(ot?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=pe(e.current,o);navigator.clipboard.writeText(p),n.key==="x"&&(t(mt()),o.forEach(S=>{e.current.hasNode(S)?e.current.dropNode(S):e.current.hasEdge(S)&&e.current.dropEdge(S)}),u())}else if(n.key==="v"&&(ot?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x:S,y:j}=Z(l/2,g/2,a,d),{nodes:L,edges:h}=xe(p,e.current,M,$,B(S,5),B(j,5));u();const m=structuredClone(L);h.forEach(w=>m.add(w)),t(it(m))}else(ot&&n.key==="z"&&n.metaKey&&n.shiftKey||!ot&&n.key==="y"&&n.ctrlKey)&&(t(oe()),t(ut()),t(ct()))}),[k,N]=z.useState(0),V=q(n=>{if(n.touches.length===2){t(dt(void 0));const[p,S]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];N(p*p+S*S)}}),U=q(n=>{if(k!==0&&n.touches.length===2){const[p,S]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],j=p*p+S*S;let L=a;j-k<0&&a+10<=390?L=a+10:j-k>0&&a-10>=10&&(L=a-10),t(Dt(L)),N(j);const h=n.currentTarget.getBoundingClientRect(),[m,w]=[(n.touches[0].clientX+n.touches[1].clientX)/2-h.left,(n.touches[0].clientY+n.touches[1].clientY)/2-h.top],[T,R]=[m/h.width,w/h.height];t(pt({x:d.x+m*a/100-l*L/100*T,y:d.y+w*a/100-g*L/100*R}))}}),X=q(n=>{k!==0&&N(0)}),[W,H]=z.useState({sx:0,sy:0,ex:0,ey:0});return z.useEffect(()=>{H({sx:D.x<=K.x?D.x:K.x,ex:D.x>K.x?D.x:K.x,sy:D.y<=K.y?D.y:K.y,ey:D.y>K.y?D.y:K.y})},[K.x,K.y]),b.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:g,width:l,viewBox:"".concat(d.x," ").concat(d.y," ").concat(l*a/100," ").concat(g*a/100),onPointerDown:St,onPointerMove:bt,onPointerUp:At,onTouchStart:V,onTouchMove:U,onTouchEnd:X,onWheel:wt,tabIndex:0,onKeyDown:Pt,children:[P&&b.jsx(Le,{svgViewBoxMin:d,svgViewBoxZoom:a,svgWidth:l,svgHeight:g}),b.jsx(ye,{children:b.jsx(_e,{})}),s==="select"&&D.x!=0&&D.y!=0&&b.jsx("rect",{x:W.sx,y:W.sy,width:W.ex-W.sx,height:W.ey-W.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),b.jsx("defs",{children:b.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[b.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),b.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ie as default};

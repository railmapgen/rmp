import{a as Se,j as u,P as Ae,B as re,D as Bt,ae as Me,a3 as Pe}from"./chakra-BZH9ddpD.js";import{c as Pt,e as F,A as ie,aN as Xt,aO as ke,ab as Ht,aG as ae,a8 as ce,w as Mt,x as gt,y as pt,aP as $t,z as vt,a1 as ft,aQ as le,aR as Z,a0 as wt,aS as Ft,t as kt,aT as Vt,aU as Ne,L as tt,p as ct,aV as xt,aW as Yt,n as At,aX as Ce,d as de,r as Nt,E as Ct,q as rt,aY as Et,aZ as je,a_ as De,a$ as Ee,aK as jt,G as Wt,H as Rt,aJ as bt,b0 as Ut,b1 as Zt,aF as qt,F as ue,S as _e,b2 as Gt,b3 as ze,b4 as Ot,b5 as Le,B as he,D as It,b6 as Ie,b7 as $e,b8 as Te,b9 as We,ba as Re,bb as Be,bc as Oe,bd as Jt,be as Xe,bf as Fe,bg as Ve,bh as Ye,am as St,aB as Ke,aC as He,ad as Ue,a9 as Ze}from"./index-5Ozg5G4U.js";import{s as mt,v as qe,b as Dt,f as fe,e as Ge,g as Je}from"./misc-nodes-p_8ijZxO.js";import{b as E,h as xe,u as Qe}from"./react-CLIJjNOF.js";import{u as O}from"./useEvent-D-PagYbH.js";import{e as Tt}from"./change-types-BToxuAfr.js";const _t=5,ye=(t,e)=>[...e].filter(r=>t.hasNode(r)),ge=(t,e)=>{const r=e.map(p=>t.getNodeAttribute(p,"x")),a=e.map(p=>t.getNodeAttribute(p,"y")),o=Math.min(...r),s=Math.max(...r),g=Math.min(...a),f=Math.max(...a);return{cx:(o+s)/2,cy:(g+f)/2}},pe=(t,e,r)=>{const a=ye(t,e);if(a.length===0)return!1;const{cx:o,cy:s}=ge(t,a),g=-r*Math.PI/180,f=Math.sin(g),p=Math.cos(g);return a.forEach(i=>{const n=t.getNodeAttribute(i,"x"),l=t.getNodeAttribute(i,"y"),d=n-o,x=l-s,m=o+d*p-x*f,v=s+d*f+x*p;t.mergeNodeAttributes(i,{x:Number(m.toFixed(2)),y:Number(v.toFixed(2))})}),!0},tn=(t,e,r)=>{const a=ye(t,e);if(a.length===0)return!1;const{cx:o,cy:s}=ge(t,a);return a.forEach(g=>{const f=t.getNodeAttribute(g,"x"),p=t.getNodeAttribute(g,"y");let i=f,n=p;switch(r){case"vertical":i=2*o-f;break;case"horizontal":n=2*s-p;break;case"diagonal45":{const l=f-o,d=p-s;i=o+d,n=s+l;break}case"diagonal135":{const l=f-o,d=p-s;i=o-d,n=s-l;break}}t.mergeNodeAttributes(g,{x:Number(i.toFixed(2)),y:Number(n.toFixed(2))})}),!0},en={[Ht.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ht.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},nn=t=>{const e=en[t];return e.at(Math.floor(Math.random()*e.length))},Qt=xe("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:r,rejectWithValue:a})=>{const{token:o}=e().account;if(!o){r(Xt({cityName:t,names:[]}));return}const s=await fetch("".concat(ke,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return ie.warn("Failed to fetch random station names",s.statusText),a(s.statusText);const g=await s.json();r(Xt({cityName:t,names:g}))}),te=xe("runtime/getOneStationName",async(t,{getState:e,dispatch:r})=>{var f;const{stationNames:a}=e().runtime,o=a[t];if(((f=o==null?void 0:o.length)!=null?f:0)==0)return ie.debug("No random station names in cache, using fallback"),r(Qt({cityName:t})),Object.values(nn(t));const s=structuredClone(o),g=s.shift();return r(Xt({cityName:t,names:s})),s.length<3&&r(Qt({cityName:t})),Object.values(g)}),me=()=>{const t=Pt(),{activeSubscriptions:e}=F(o=>o.account),{preference:{randomStationsNames:r}}=F(o=>o.app),a=!e.RMP_CLOUD||r==="none";return E.useCallback(async o=>{const s=mt[o].defaultAttrs.names;if(!a){const g=await t(te(r));if(te.fulfilled.match(g)){const f=g.payload;return s.length>f.length?f.push(...Array(s.length-f.length).fill(f.at(-1))):s.length<f.length&&f.splice(s.length),f}}return structuredClone(s)},[t,a,r])},sn=({isOpen:t,position:e,onClose:r})=>{const{t:a}=Qe(),o=Pt(),s=E.useRef(window.graph),{activeSubscriptions:g}=F(S=>S.account),{preference:{autoParallel:f}}=F(S=>S.app),{svgViewBoxZoom:p,svgViewBoxMin:i}=F(S=>S.param),{selected:n,count:{masters:l,lines:d}}=F(S=>S.runtime),x=!g.RMP_CLOUD&&l+1>ae,m=!f||f&&!g.RMP_CLOUD&&d+1>ce,v=n.size>0,b=E.useMemo(()=>[...n].filter(S=>s.current.hasNode(S)).length>1,[n]),M=E.useRef(null);Se({ref:M,handler:r,enabled:t});const y=E.useCallback(()=>{o(Mt(s.current.export())),o(gt()),o(pt())},[o]),w=O(()=>{if(n.size>0){const S=$t(s.current,n);navigator.clipboard.writeText(S)}}),c=O(()=>{if(n.size>0){const S=$t(s.current,n);navigator.clipboard.writeText(S),o(vt()),n.forEach(B=>{s.current.hasNode(B)?s.current.dropNode(B):s.current.hasEdge(B)&&s.current.dropEdge(B)}),y()}}),k=O(async()=>{try{const S=await navigator.clipboard.readText(),{x:B,y:st}=ft(e.x,e.y,p,i),{nodes:lt,edges:yt}=le(S,s.current,x,m,Z(B,5),Z(st,5));y();const _=structuredClone(lt);yt.forEach(V=>_.add(V)),o(wt(_))}catch(S){console.warn("Failed to read clipboard:",S)}}),N=O(()=>{n.size>0&&(o(vt()),n.forEach(S=>{s.current.hasNode(S)?s.current.dropNode(S):s.current.hasEdge(S)&&s.current.dropEdge(S)}),y())}),W=O(()=>{o(gt()),o(pt())}),T=O(S=>{if(n.size>0){const B=Math.min(Math.max(S,-10),10);n.forEach(st=>{s.current.hasNode(st)&&s.current.setNodeAttribute(st,"zIndex",B),s.current.hasEdge(st)&&s.current.setEdgeAttribute(st,"zIndex",B)}),y()}}),Q=O(()=>{if(n.size>0){const[S]=n,B=s.current.hasNode(S)?s.current.getNodeAttribute(S,"zIndex"):s.current.hasEdge(S)?s.current.getEdgeAttribute(S,"zIndex"):0;T(B+1)}}),et=O(()=>{if(n.size>0){const[S]=n;let B=0;s.current.hasNode(S)?B=s.current.getNodeAttribute(S,"zIndex"):s.current.hasEdge(S)&&(B=s.current.getEdgeAttribute(S,"zIndex")),T(B-1)}}),R=O(S=>{pe(s.current,n,S)&&y()}),nt=O(S=>{tn(s.current,n,S)&&y()});return t?u.jsx(Ae,{children:u.jsxs(re,{ref:M,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[u.jsx(J,{onClick:()=>{W(),r()},children:a("contextMenu.refresh")}),u.jsx(Bt,{}),u.jsx(J,{onClick:()=>{w(),r()},isDisabled:!v,children:a("contextMenu.copy")}),u.jsx(J,{onClick:()=>{c(),r()},isDisabled:!v,children:a("contextMenu.cut")}),u.jsx(J,{onClick:()=>{k(),r()},children:a("contextMenu.paste")}),u.jsx(J,{onClick:()=>{N(),r()},isDisabled:!v,children:a("contextMenu.delete")}),u.jsx(Bt,{}),u.jsx(J,{onClick:()=>{T(10),r()},isDisabled:!v,children:a("contextMenu.placeTop")}),u.jsx(J,{onClick:()=>{T(-10),r()},isDisabled:!v,children:a("contextMenu.placeBottom")}),u.jsx(J,{onClick:()=>{T(0),r()},isDisabled:!v,children:a("contextMenu.placeDefault")}),u.jsx(J,{onClick:()=>{Q(),r()},isDisabled:!v,children:a("contextMenu.placeUp")}),u.jsx(J,{onClick:()=>{et(),r()},isDisabled:!v,children:a("contextMenu.placeDown")}),u.jsx(Bt,{}),u.jsx(J,{onClick:()=>{R(45),r()},isDisabled:!b,children:a("contextMenu.rotateCW")}),u.jsx(J,{onClick:()=>{R(-45),r()},isDisabled:!b,children:a("contextMenu.rotateCCW")}),u.jsx(J,{onClick:()=>{nt("vertical"),r()},isDisabled:!b,children:a("contextMenu.flipVertical")}),u.jsx(J,{onClick:()=>{nt("horizontal"),r()},isDisabled:!b,children:a("contextMenu.flipHorizontal")}),u.jsx(J,{onClick:()=>{nt("diagonal45"),r()},isDisabled:!b,children:a("contextMenu.flipDiagonal45")}),u.jsx(J,{onClick:()=>{nt("diagonal135"),r()},isDisabled:!b,children:a("contextMenu.flipDiagonal135")})]})}):null},J=({children:t,onClick:e,isDisabled:r=!1})=>u.jsx(re,{px:3,py:2,cursor:r?"not-allowed":"pointer",opacity:r?.5:1,_hover:r?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:r?void 0:e,fontSize:"sm",children:t}),on=E.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:r,svgWidth:a,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=F(M=>M.app),f=Me().colorMode==="light"?"#666464":"#D3D3D4",p=Ft(e,r,a,o),i=s?410*r/100:0,n=r>30?r>120?50:25:5,l=r/200,d={startX:Z(p.xMin+i-n,n),endX:Z(p.xMax+i+n,n),startY:Z(p.yMin-n,n),endY:Z(p.yMax+n,n)},x=Array.from({length:(d.endX-d.startX)/n+1},(M,y)=>{const w=d.startX+y*n,c=w%(n*5)===0?2*l:l;return u.jsx("line",{x1:w,y1:d.startY,x2:w,y2:d.endY,strokeWidth:c,stroke:f,opacity:"0.5"},"grid_vl_".concat(w))}),m=Array.from({length:(d.endY-d.startY)/n+1},(M,y)=>{const w=d.startY+y*n,c=w%(n*5)===0?2*l:l;return u.jsx("line",{x1:d.startX,y1:w,x2:d.endX,y2:w,strokeWidth:c,stroke:f,opacity:"0.5"},"grid_hl_".concat(w))}),v=Array.from({length:(d.endX-d.startX)/n/5+1},(M,y)=>{const w=Z(d.startX,5*n)+y*5*n;return u.jsx("text",{x:w,y:p.yMin+r/5,fontSize:l*25,fill:f,textAnchor:"middle",opacity:"0.5",children:w},"grid_vc_".concat(w))}),b=Array.from({length:(d.endY-d.startY)/n/5+1},(M,y)=>{const w=Z(d.startY,5*n)+y*5*n;return u.jsx("text",{x:p.xMin+r/8+i,y:w,fontSize:l*25,fill:f,textAnchor:"start",opacity:"0.5",children:w},"grid_hc_".concat(w))});return u.jsxs("g",{id:"grid-lines",className:"removeMe",children:[x,m,v,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),rn=qe.component,ee=Vt.generatePath,ne=Ne.component,Lt=10,an=()=>{var yt;const t=Pt(),e=()=>{t(Mt(window.graph.export())),t(gt()),t(pt())},{activeSubscriptions:r}=F(_=>_.account),{telemetry:{project:a},preference:{autoParallel:o,randomStationsNames:s}}=F(_=>_.app),{selected:g,theme:f,count:{mostFrequentStationType:p},lastTool:i}=F(_=>_.runtime),n=me(),l=g.keys().next().value;if(!l.startsWith("stn")&&!l.startsWith("misc_node")||!window.graph.hasNode(l))return;const d=window.graph.neighbors(l);if(d.length===0)return;const x=window.graph.getNodeAttributes(l),m=d.reduce((_,V)=>{const ot=window.graph.getNodeAttributes(V);return{x:_.x+ot.x,y:_.y+ot.y}},{x:0,y:0}),v={x:m.x/d.length,y:m.y/d.length},b={x:x.x-v.x,y:x.y-v.y},M={x:x.x+b.x,y:x.y+b.y},y=Math.sign(b.x)===Math.sign(b.y),w={x:M.x-Lt,y:M.y+Lt*(y?1:-1)},c={x:M.x+Lt,y:M.y+Lt*(y?-1:1)},k=l.startsWith("stn_"),N=k?window.graph.getNodeAttribute(l,"type"):i!=null&&i.startsWith("station-")?i.slice(8):p,W=mt[N].component,T={visible:!0,zIndex:0,x:c.x,y:c.y,type:N,[N]:mt[N].defaultAttrs};if(k){const _=structuredClone(window.graph.getNodeAttribute(l,N));Object.assign(T,{[N]:_})}const Q=window.graph.reduceEdges(l,(_,V)=>{const ot=window.graph.getEdgeAttributes(V),{style:dt}=ot;if(dt===kt.SingleColor){const at=JSON.stringify(ot[dt].color);at in _?_[at]+=1:_[at]=1}return _},{}),et=(yt=Object.entries(Q).filter(([_,V])=>V%2!==0).reduce((_,[V,ot])=>ot>_.count?{color:JSON.parse(V),count:ot}:_,{color:null,count:0}).color)!=null?yt:f,R=b.x>0?!(b.x>Math.abs(b.y)):-b.x>Math.abs(b.y),nt=R?"from":"to",S=ee(x.x,w.x,x.y,w.y,{...Vt.defaultAttrs,startFrom:nt}),B=R?"to":"from",st=ee(x.x,c.x,x.y,c.y,{...Vt.defaultAttrs,startFrom:B}),lt=async(_,V)=>{V.stopPropagation();const{x:ot,y:dt}=xt(V);t(Yt({x:ot,y:dt}));const at=At(10),ut=Ce.has(_),ht=ut?"stn_".concat(at):"misc_node_".concat(at),j=structuredClone(ut&&_===window.graph.getNodeAttribute(l,"type")?window.graph.getNodeAttribute(l,_):{...mt,...Dt}[_].defaultAttrs);de.has(_)&&(j.color=f);const I=!r.RMP_CLOUD||s==="none";ut&&!I&&(j.names=await n(_)),window.graph.addNode(ht,{visible:!0,zIndex:0,x:ut?c.x:w.x,y:ut?c.y:w.y,type:_,[_]:j}),a&&Nt.event(Ct.ADD_STATION,{type:_});const q=tt.Diagonal,K="line_".concat(At(10)),[G,h]=[l,ht],A=o?0:-1,P=ut?B:nt;window.graph.addDirectedEdgeWithKey(K,G,h,{visible:!0,zIndex:0,type:q,[q]:{...structuredClone(rt[q].defaultAttrs),startFrom:P},style:kt.SingleColor,[kt.SingleColor]:{color:et},reconcileId:"",parallelIndex:A}),a&&Nt.event(Ct.ADD_LINE,{type:q}),e(),t(Et(ht)),t(wt(new Set([ht])))};return u.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[u.jsx(ne,{id:"line_prediction_1",type:tt.Diagonal,path:S,styleAttrs:{color:et},newLine:!0,handlePointerDown:()=>{}}),u.jsx(ne,{id:"line_prediction_2",type:tt.Diagonal,path:st,styleAttrs:{color:et},newLine:!0,handlePointerDown:()=>{}}),u.jsx(rn,{id:"misc_node_virtual_prediction_1",attrs:{},x:w.x,y:w.y,handlePointerDown:(_,V)=>{lt(ct.Virtual,V)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),u.jsx(W,{id:"stn_virtual_prediction_2",attrs:T,x:c.x,y:c.y,handlePointerDown:(_,V)=>{lt(N,V)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},be=(t,e,r,a,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return se(t,e,r,a,o)?{x1:e,y1:r,x2:a,y2:o,offset:s.offsetFrom}:void 0;const[g,f]=[s.offsetFrom,s.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let i=p,n=0;n<2;n++,i+=Math.PI){const[l,d,x,m]=[Math.sin(p)*g,Math.cos(p)*g,Math.sin(i)*f,Math.cos(i)*f];if(se(t,e+l,r+d,a+x,o+m))return{x1:e+l,y1:r+d,x2:a+x,y2:o+m,offset:0}}},cn=(t,e,r,a,o,s)=>t===r?{x1:t+5*s,y1:e,x2:r+5*s,y2:a,offset:o}:e===a?{x1:t,y1:e+5*s,x2:r,y2:a+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:r+5*Math.SQRT1_2*s,y2:a+5*Math.SQRT1_2*s,offset:o},se=(t,e,r,a,o)=>!!((e===a||r===o)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((o-r)/(a-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),ln=(t,e)=>{const r=[],a=[];return Object.values(e).forEach(o=>{var M;if(o.length===1){a.push(...o.map(y=>y.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(y=>t.getEdgeAttribute(y,"type")===s)){a.push(...o.map(y=>y.edge));return}const g=t.getEdgeAttribute(o.at(0),"style");if(!o.every(y=>t.getEdgeAttribute(y,"style")===g)){a.push(...o.map(y=>y.edge));return}const f={},p=new Set,i=new Set,n=Object.fromEntries(o.map(y=>{var k,N;const[w,c]=t.extremities(y);return f[w]=((k=f[w])!=null?k:0)+1,f[c]=((N=f[c])!=null?N:0)+1,p.add(w),i.add(c),[w,[y.edge,c]]})),l=Array.from(p).filter(y=>f[y]===1),d=Array.from(i).filter(y=>f[y]===1);if(l.length!==1||d.length!==1){a.push(...o.map(y=>y.edge));return}const x=l[0],m=d[0];if(x===m){a.push(...o.map(y=>y.edge));return}const v=[n[x][0]];let b=n[x][1];for(let y=1;y<o.length;y=y+1){const w=(M=n[b])==null?void 0:M.at(1);if(!w){a.push(...o.map(c=>c.edge));return}v.push(n[b][0]),b=w}if(b!==m||v.length!==o.length){a.push(...o.map(y=>y.edge));return}r.push(v)}),{allReconciledLines:r,danglingLines:a}},dn=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const r=e.map(o=>{var d,x,m;const[s,g]=t.extremities(o),f=t.getNodeAttributes(s),p=t.getNodeAttributes(g),{type:i}=t.getEdgeAttributes(o),n=(d=t.getEdgeAttribute(o,i))!=null?d:rt[i].defaultAttrs,l=be(i,f.x,f.y,p.x,p.y,n);if(l){const{x1:v,y1:b,x2:M,y2:y,offset:w}=l;return rt[tt.Simple].generatePath(v,M,b,y,{offset:w})}return(m=(x=rt[i])==null?void 0:x.generatePath(f.x,p.x,f.y,p.y,n))!=null?m:"M ".concat(f.x," ").concat(f.y," L ").concat(p.x," ").concat(p.y)});let a="".concat(r[0]," ");for(let o=1;o<e.length;o=o+1)a+=r[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return a},un=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),hn=t=>{const e={},r={},a=[],o={},s=[];for(const i of t.edgeEntries()){const[n,l,d,x]=[i.sourceAttributes.x,i.sourceAttributes.y,i.targetAttributes.x,i.targetAttributes.y],m=i.attributes[i.attributes.type],v=be(i.attributes.type,n,l,d,x,m);r[i.edge]=v}for(const i of t.edgeEntries()){let n=r[i.edge];const{parallelIndex:l}=i.attributes;if(l>=0){const d=je(t,i.attributes.type,i.edge),x=r[d];if(!x){a.push(i);continue}if(l>0){const{x1:m,y1:v,x2:b,y2:M,offset:y}=x;n=cn(m,v,b,M,y,l)}}if(i.attributes.reconcileId!==""){const d=i.attributes.reconcileId;d in o?o[d].push(i):o[d]=[i];continue}if(n){const d=i.edge,x=i.attributes,{x1:m,y1:v,x2:b,y2:M,offset:y}=n;e[d]={attr:x,path:rt[tt.Simple].generatePath(m,b,v,M,{offset:y})};continue}s.push(i)}const g=new Set;for(;a.length;){const i=a.pop();if(g.has(i.edge))continue;const{parallel:n}=De(t,i);if(!n.length)continue;n.forEach(d=>g.add(d.edge));const l=Ee(n);for(const d of n){const x=d.edge;e[x]={attr:d.attributes,path:l[x]}}}const{allReconciledLines:f,danglingLines:p}=ln(t,o);for(const i of f){const n=dn(t,i);if(!n)continue;const l=i[0];e[l]={attr:t.getEdgeAttributes(l),path:n}}for(const i of p){const n=t.getEdgeAttributes(i),[l,d]=t.extremities(i),x=t.getNodeAttributes(l),m=t.getNodeAttributes(d);e[i]={attr:n,path:rt[tt.Simple].generatePath(x.x,m.x,x.y,m.y,rt[tt.Simple].defaultAttrs)}}for(const i of s){const n=i.edge,l=i.attributes.type,d=i.attributes,[x,m,v,b]=[i.sourceAttributes.x,i.sourceAttributes.y,i.targetAttributes.x,i.targetAttributes.y];if(!(l in rt)){e[n]={attr:d,path:"M ".concat(x," ").concat(m," L ").concat(v," ").concat(b)};continue}e[n]={attr:d,path:rt[l].generatePath(x,v,m,b,d[l])}}return Object.entries(e).map(([i,n])=>({id:i,type:"line",line:n}))},ve=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ct.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ct.Master&&e.getNodeAttributes(t)[ct.Master].nodeType==="Station",fn=(t,e)=>{const r=[];return e.filter(a=>ve(a,t)).forEach(a=>{const o=t.getNodeAttribute(a,"x"),s=t.getNodeAttribute(a,"y");r.push({a:1,b:0,c:-o,node:a,x:o,y:s}),r.push({a:0,b:1,c:-s,node:a,x:o,y:s}),r.push({a:1,b:-1,c:-o+s,node:a,x:o,y:s}),r.push({a:1,b:1,c:-o-s,node:a,x:o,y:s})}),r},we=(t,e,r)=>Math.abs(t.a*e+t.b*r+t.c)/Math.sqrt(t.a**2+t.b**2),xn=(t,e,r,a)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return r.filter(g=>a.includes(g.node)).forEach(g=>{const f=we(g,t,e);f<o&&(o=f,s=g)}),{l:s,d:o}},yn=(t,e,r,a,o)=>{const s=e.filter(i=>{const n=t.getNodeAttribute(i,"x"),l=t.getNodeAttribute(i,"y");return Math.abs(o.a*n+o.b*l+o.c)<=.01}),g=[(i,n,l,d)=>[(i+l)/2,(n+d)/2],(i,n,l,d)=>[2*i-l,2*n-d],(i,n,l,d)=>[2*l-i,2*d-n]];let f=1/0,p={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let i=0;i<s.length;i++){const n=s[i],l=t.getNodeAttribute(n,"x"),d=t.getNodeAttribute(n,"y");for(let x=i+1;x<s.length;x++){const m=s[x],v=t.getNodeAttribute(m,"x"),b=t.getNodeAttribute(m,"y");g.forEach(M=>{const[y,w]=M(l,d,v,b),c=Math.hypot(r-y,a-w);c<f&&(f=c,p={x:y,y:w,originalNodesPos:[{x:l,y:d},{x:v,y:b}]})})}}return{snapPoint:p,distance:f}},gn=(t,e)=>{const{xMin:r,yMin:a,xMax:o,yMax:s}=e;if(t.a===0)return[r,o,-t.c/t.b,-t.c/t.b];if(t.b===0)return[-t.c/t.a,-t.c/t.a,a,s];{const g=-t.a/t.b,f=-t.c/t.b;return[r,o,g*r+f,g*o+f]}},pn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:r}=F(d=>d.param),a=d=>{const m=[{x:d.x,y:d.y},...d.originalNodesPos].sort((b,M)=>b.x===M.x?b.y-M.y:b.x-M.x),v=(m[1].y-m[0].y)/(m[1].x-m[0].x);if(Math.abs(v)<=.01)return{original:m,offset:m.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(v)>=1e10)return{original:m,offset:m.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const M=-1/v,y=10/Math.sqrt(M*M+1),w=10*M/Math.sqrt(M*M+1);return{original:m,offset:m.map(c=>({x:c.x+y,y:c.y+w})),rotate:-Math.atan(M)*(180/Math.PI)}}},{original:o,offset:s,rotate:g}=a(e),f=d=>{const x=Math.sqrt(3)/2*d,m="0,0",v="".concat(-d/2,",").concat(x),b="".concat(d/2,",").concat(x);return"".concat(m," ").concat(v," ").concat(b)},p=r/75,i=8*p,n="#FC8181",l="".concat(p*5," ").concat(p*2);return u.jsxs(u.Fragment,{children:[u.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:l}),u.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:l}),u.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:n,strokeWidth:p,strokeDasharray:l}),u.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:l}),u.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:l}),u.jsx("polygon",{points:f(i),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((g+270)%360,")"),fill:n}),u.jsx("polygon",{points:f(i),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((g+270)%360,")"),fill:n}),u.jsx("polygon",{points:f(i),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((g+90)%360,")"),fill:n}),u.jsx("polygon",{points:f(i),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((g+90)%360,")"),fill:n})]})},oe=t=>{const{id:e,x:r,y:a,handlePointerDown:o,handlePointerMove:s,handlePointerUp:g}=t,f=E.useCallback(n=>o(e,n),[e,o]),p=E.useCallback(n=>s(e,n),[e,s]),i=E.useCallback(n=>g(e,n),[e,g]);return u.jsx("g",{id:e,transform:"translate(".concat(r-6.4," ").concat(a-6.4,")scale(0.025)"),onPointerDown:f,onPointerMove:p,onPointerUp:i,style:{cursor:"move"},children:u.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},mn=t=>{const{id:e,path:r,handlePointerDown:a}=t,o=E.useCallback(s=>a(e,s),[e,a]);return u.jsx("path",{id:e,d:r,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},bn=E.memo(t=>{var p,i,n,l,d,x,m,v,b,M,y,w;const{elements:e,handlePointerDown:r,handlePointerMove:a,handlePointerUp:o,handleEdgePointerDown:s}=t,g=Object.fromEntries(Array.from({length:21},(c,k)=>[k-10,{pre:[],main:[],post:[]}]));for(const c of e)if(c.type==="line"){const k=c.line.attr.type,N=c.line.attr.style,W=c.line.attr[N],T=(p=jt[N])==null?void 0:p.preComponent;T&&g[c.line.attr.zIndex].pre.push(u.jsx(T,{id:c.id,type:k,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(c.id,".pre")));const Q=(n=(i=jt[N])==null?void 0:i.component)!=null?n:mn;g[c.line.attr.zIndex].main.push(u.jsx(Q,{id:c.id,type:k,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},c.id));const et=(l=jt[N])==null?void 0:l.postComponent;et&&g[c.line.attr.zIndex].post.push(u.jsx(et,{id:c.id,type:k,path:c.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(c.id,".post")))}else if(c.type==="station"){const k=c.station,N=k.type,W=(d=mt[N])==null?void 0:d.preComponent;W&&g[c.station.zIndex].pre.push(u.jsx(W,{id:c.id,x:k.x,y:k.y,attrs:k,handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},"".concat(c.id,".pre")));const T=(m=(x=mt[N])==null?void 0:x.component)!=null?m:oe;g[c.station.zIndex].main.push(u.jsx(T,{id:c.id,x:k.x,y:k.y,attrs:k,handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},c.id));const Q=(v=mt[N])==null?void 0:v.postComponent;Q&&g[c.station.zIndex].post.push(u.jsx(Q,{id:c.id,x:k.x,y:k.y,attrs:k,handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},"".concat(c.id,".post")))}else if(c.type==="misc-node"){const k=c.miscNode,N=k.type,W=(b=Dt[N])==null?void 0:b.preComponent;W&&g[c.miscNode.zIndex].pre.push(u.jsx(W,{id:c.id,x:k.x,y:k.y,attrs:k[N],handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},"".concat(c.id,".pre")));const T=(y=(M=Dt[N])==null?void 0:M.component)!=null?y:oe;g[c.miscNode.zIndex].main.push(u.jsx(T,{id:c.id,x:k.x,y:k.y,attrs:k[N],handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},c.id));const Q=(w=Dt[N])==null?void 0:w.postComponent;Q&&g[c.miscNode.zIndex].post.push(u.jsx(Q,{id:c.id,x:k.x,y:k.y,attrs:k[N],handlePointerDown:r,handlePointerMove:a,handlePointerUp:o},"".concat(c.id,".post")))}return Array.from({length:21},(c,k)=>(k-10).toString()).map(c=>[...g[c].pre,...g[c].main,...g[c].post]).flat()},(t,e)=>t.elements===e.elements),vn=[...Object.values(_e),ct.Virtual,ct.Master,ct.Fill,ct.LondonArrow,ct.ChongqingRTNumLineBadge2021,ct.ChongqingRTTextLineBadge2021,ct.ChengduRTLineBadge,ct.GzmtrLineBadge],wn=()=>{const t=Pt(),e=E.useRef(window.graph),r=()=>{t(Mt(e.current.export())),t(gt()),t(pt())},{telemetry:{project:a},preference:{autoParallel:o,snapLines:s,autoChangeStationType:g}}=F(j=>j.app),{svgViewBoxZoom:f,svgViewBoxMin:p}=F(j=>j.param),{selected:i,pointerPosition:n,active:l,refresh:{nodes:d,edges:x},mode:m,keepLastPath:v,theme:b}=F(j=>j.runtime),M=Wt(),{height:y,width:w}=Rt(M),[c,k]=E.useState({dx:0,dy:0}),[N,W]=E.useState([]),[T,Q]=E.useState([]),[et,R]=E.useState([]);E.useEffect(()=>{if(!n||!s)return;const j=Ft(p,f,w,y),I=fe(e.current,...Object.values(j));Q(I),W(fn(e.current,I))},[p,f,w,y,n]);const[nt,S]=E.useState(void 0),B=O((j,I)=>{I.stopPropagation(),I.currentTarget.setPointerCapture(I.pointerId);const{x:q,y:K}=xt(I);m==="select"&&t(bt("free")),R([]),S(void 0),t(Yt({x:q,y:K})),t(Et(j)),I.shiftKey?i.has(j)?t(Ut(j)):t(Zt(j)):i.has(j)||t(wt(new Set([j])))}),st=O((j,I)=>{const{x:q,y:K}=xt(I);if(I.currentTarget.setPointerCapture(I.pointerId),m==="free"&&l===j){if(!I.altKey&&s){const G=e.current.getNodeAttribute(j,"x"),h=e.current.getNodeAttribute(j,"y"),A=G-(n.x-q)*f/100,P=h-(n.y-K)*f/100;let z=A,$=P;if(ve(j,e.current)){let D=et,L=nt;if(D.length!==0&&(D=D.filter(C=>we(C,A,P)<=6)),L&&(D.length===0||Math.hypot(A-L.x,P-L.y)>6)&&(L=void 0),!L&&D.length===1){const C=D[0],{snapPoint:X,distance:U}=yn(e.current,T.filter(it=>!i.has(it)),A,P,C);U<=3&&(L=X)}if(D.length===1&&!L||D.length===0){const{l:C,d:X}=xn(A,P,N,T.filter(it=>!i.has(it)&&!D.some(zt=>zt.node===it))),U=D.length===0||!D.some(it=>it.a===C.a&&it.b===C.b);X<3&&D.length<2&&U&&D.push(C)}if(D.length===1)if(L)z=L.x,$=L.y;else{const C=D[0];if(C.a==0)$=-C.c/C.b;else if(C.b==0)z=-C.c/C.a;else{const X=-C.a/C.b,U=-C.c/C.b;$=X*z+U}}else if(D.length===2){const C=D[0],X=D[1],U=C.a*X.b-X.a*C.b;U!==0&&(z=-(C.c*X.b-X.c*C.b)/U,$=-(C.a*X.c-X.a*C.c)/U)}R(D),S(L)}const H=z-G,Y=$-h;i.forEach(D=>{e.current.hasNode(D)&&e.current.updateNodeAttributes(D,L=>({...L,x:Z(L.x+H,.01),y:Z(L.y+Y,.01)}))})}else R([]),S(void 0),i.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,h=>({...h,x:Z(h.x-(n.x-q)*f/100,I.altKey?.01:_t),y:Z(h.y-(n.y-K)*f/100,I.altKey?.01:_t)}))});t(gt()),t(pt())}else m.startsWith("line")&&l&&k({dx:(n.x-q)*f/100,dy:(n.y-K)*f/100})}),lt=O((j,I)=>{var q,K,G;if(I.currentTarget.releasePointerCapture(I.pointerId),m.startsWith("line")){v||t(bt("free"));const h=e.current.hasNode(l)&&vn.includes(e.current.getNodeAttribute(l,"type")),A=["stn_core_","virtual_circle_","misc_node_connectable_"],z=(G=(K=(q=document.elementsFromPoint(I.clientX,I.clientY).at(0))==null?void 0:q.attributes)==null?void 0:K.getNamedItem("id"))==null?void 0:G.value,$=A.find(H=>z==null?void 0:z.startsWith(H));if(h&&$){const{path:H,style:Y}=qt(m),[D,L]=[H,Y],C="line_".concat(At(10)),[X,U]=[l,z.slice($.length)];if(X!==U){const it=structuredClone(jt[L].defaultAttrs);"color"in it&&L!==kt.River&&(it.color=b);const zt=o?ue(e.current,D,X,U,"from"):-1;e.current.addDirectedEdgeWithKey(C,X,U,{visible:!0,zIndex:0,type:D,[D]:structuredClone(rt[D].defaultAttrs),style:L,[L]:it,reconcileId:"",parallelIndex:zt}),g&&X.startsWith("stn")&&Tt(e.current,X),g&&U.startsWith("stn")&&Tt(e.current,U),t(wt(new Set([C]))),a&&Nt.event(Ct.ADD_LINE,{type:D}),t(Mt(e.current.export())),t(pt())}}}else if(m==="free"&&l){const{x:h,y:A}=xt(I);n.x-h===0&&n.y-A===0||(t(Mt(e.current.export())),t(gt()))}R([]),S(void 0),Yt(void 0),t(Et(void 0))}),yt=O((j,I)=>{if(I.stopPropagation(),I.shiftKey||t(vt()),I.shiftKey&&i.has(j)?t(Ut(j)):t(Zt(j)),m.startsWith("station")||m.startsWith("misc-node-virtual")||m.startsWith("misc-node-master")){const q=I.clientX-document.getElementById("canvas").getBoundingClientRect().left,K=I.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=m.startsWith("station"),h=At(10),A=G?"stn_".concat(h):"misc_node_".concat(h),P=G?m.slice(8):m.slice(10),{x:z,y:$}=ft(q,K,f,p),H=G?structuredClone(mt[P].defaultAttrs):structuredClone(Dt[P].defaultAttrs);"color"in H&&(H.color=b),e.current.addNode(A,{visible:!0,zIndex:0,x:Z(z,5),y:Z($,5),type:P,[P]:H});const Y=e.current.getEdgeAttributes(j),{zIndex:D,type:L,style:C}=Y,X=Y[L],U=Y[C],[it,zt]=e.current.extremities(j),Kt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(At(10)),it,A,{visible:!0,zIndex:D,type:L,[L]:structuredClone(X),style:C,[C]:structuredClone(U),reconcileId:"",parallelIndex:Kt}),e.current.addDirectedEdgeWithKey("line_".concat(At(10)),A,zt,{visible:!0,zIndex:D,type:L,[L]:structuredClone(X),style:C,[C]:structuredClone(U),reconcileId:"",parallelIndex:Kt}),e.current.dropEdge(j),r(),a&&(Nt.event(Ct.ADD_STATION,{type:P}),Nt.event(Ct.ADD_LINE,{type:L})),t(bt("free")),t(wt(new Set([A])))}}),_=E.useMemo(()=>[...hn(e.current),...un(e.current)],[x,d]),{path:V,style:ot}=qt(m),dt=V||tt.Diagonal,at=ot||kt.SingleColor,ut=jt[at].component,ht=structuredClone(jt[at].defaultAttrs);return"color"in ht&&at!==kt.River&&(ht.color=b),u.jsxs(u.Fragment,{children:[u.jsx(bn,{elements:_,handlePointerDown:B,handlePointerMove:st,handlePointerUp:lt,handleEdgePointerDown:yt}),m.startsWith("line")&&l&&l!=="background"&&u.jsx(ut,{id:"line_create_in_progress___no_use",type:dt,path:rt[dt].generatePath(e.current.getNodeAttribute(l,"x"),e.current.getNodeAttribute(l,"x")-c.dx,e.current.getNodeAttribute(l,"y"),e.current.getNodeAttribute(l,"y")-c.dy,rt[dt].defaultAttrs),styleAttrs:ht,newLine:!0,handlePointerDown:()=>{}}),et.length!==0&&et.map(j=>u.jsx("path",{d:rt[tt.Simple].generatePath(...gn(j,Ft(p,f,w,y)),rt[tt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:f/75},"snap_line_".concat(j.a,"_").concat(j.b,"_").concat(j.c,"_").concat(j.node))),nt&&u.jsx(pn,{activeSnapPoint:nt})]})},Sn=()=>{const t=Pt(),{svgViewBoxZoom:e,svgViewBoxMin:r}=F(x=>x.param),{radialTouchMenu:a}=F(x=>x.runtime),o=E.useRef(window.graph),[s,g]=E.useState(0),f=Wt(),{height:p,width:i}=Rt(f),n=O(x=>{var m;if(x.touches.length==1){if(g(0),a.visible){t(Gt());return}const v=x.touches[0],b=(m=document.getElementById("canvas"))==null?void 0:m.getBoundingClientRect();if(!b)return;const M=v.clientX-b.left,y=v.clientY-b.top,w=ft(M,y,e,r),c=ze(o.current,w,t);[...c[Ot.STATION],...c[Ot.MISC_NODE],...c[Ot.LINE]].length>0?t(Le({visible:!0,position:w,data:c})):(t(vt()),t(Gt()))}else if(x.touches.length==2){t(Et(void 0));const[v,b]=[x.touches[0].clientX-x.touches[1].clientX,x.touches[0].clientY-x.touches[1].clientY];g(v*v+b*b)}}),l=O(x=>{if(x.touches.length==2&&s>0){const[m,v]=[x.touches[0].clientX-x.touches[1].clientX,x.touches[0].clientY-x.touches[1].clientY],b=m*m+v*v;let M=e;b-s<0&&e+10<=390?M=e+10:b-s>0&&e-10>=10&&(M=e-10),t(he(M)),g(b);const y=x.currentTarget.getBoundingClientRect(),[w,c]=[(x.touches[0].clientX+x.touches[1].clientX)/2-y.left,(x.touches[0].clientY+x.touches[1].clientY)/2-y.top],[k,N]=[w/y.width,c/y.height];t(It({x:r.x+w*e/100-i*M/100*k,y:r.y+c*e/100-p*M/100*N}))}}),d=O(x=>{g(0)});return u.jsx("rect",{className:"removeMe",x:r.x,y:r.y,width:i*e/100,height:p*e/100,fill:a.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:n,onTouchMove:l,onTouchEnd:d})},An=()=>{const t=Pt(),e=E.useRef(window.graph),{svgViewBoxZoom:r,svgViewBoxMin:a}=F(c=>c.param),{selected:o}=F(c=>c.runtime),s=Wt(),{height:g,width:f}=Rt(s),p=E.useCallback(()=>{t(Mt(e.current.export())),t(gt()),t(pt())},[t]),i=E.useCallback((c,k,N)=>{c.stopPropagation(),o.size>0&&(o.forEach(W=>{e.current.hasNode(W)&&(e.current.updateNodeAttribute(W,"x",T=>(T!=null?T:0)+k*_t),e.current.updateNodeAttribute(W,"y",T=>(T!=null?T:0)+N*_t))}),p())},[o,p]),n=E.useCallback(c=>i(c,0,-1),[i]),l=E.useCallback(c=>i(c,0,1),[i]),d=E.useCallback(c=>i(c,-1,0),[i]),x=E.useCallback(c=>i(c,1,0),[i]),m=E.useCallback(()=>{if(o.size>0){const c=$t(e.current,o);navigator.clipboard.writeText(c)}},[o]),v=E.useCallback(()=>{o.size>0&&(t(vt()),o.forEach(c=>{e.current.hasNode(c)?e.current.dropNode(c):e.current.hasEdge(c)&&e.current.dropEdge(c)}),p())},[o,t,p]),b=a.x+f*r/200,M=a.y+(g-100)*r/100,y=40,w=40;return u.jsxs("g",{transform:"translate(".concat(b,", ").concat(M,")scale(").concat(1.5*r/100,")"),children:[u.jsxs("g",{transform:"translate(0, -".concat(w,")"),children:[u.jsx("circle",{r:y/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:n}),u.jsx(Ie,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(0, ".concat(w,")"),children:[u.jsx("circle",{r:y/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),u.jsx($e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(w,", 0)"),children:[u.jsx("circle",{r:y/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:d}),u.jsx(Te,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(w,", 0)"),children:[u.jsx("circle",{r:y/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:x}),u.jsx(We,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(w,", ").concat(w,")"),children:[u.jsx("circle",{r:y/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:m}),u.jsx(Re,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(w,", ").concat(w,")"),children:[u.jsx("circle",{r:y/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:v}),u.jsx(Be,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Dn=()=>{const t=Pt(),e=E.useRef(window.graph),r=E.useCallback(()=>{t(Mt(e.current.export())),t(gt()),t(pt())},[t]),{activeSubscriptions:a}=F(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:g,predictNextNode:f,autoParallel:p,autoChangeStationType:i}}=F(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:l}=F(h=>h.param),{selected:d,active:x,isDetailsOpen:m,mode:v,lastTool:b,keepLastPath:M,theme:y,count:{masters:w,lines:c}}=F(h=>h.runtime),k=Wt(),{height:N,width:W}=Rt(k),T=!a.RMP_CLOUD&&w+1>ae,Q=!p||p&&!a.RMP_CLOUD&&c+1>ce,et=me();Oe();const[R,nt]=E.useState({x:0,y:0}),[S,B]=E.useState({x:0,y:0}),[st,lt]=E.useState({isOpen:!1,position:{x:0,y:0}}),[yt,_]=E.useState({x:0,y:0}),[V,ot]=E.useState({x:0,y:0}),dt=O(async h=>{st.isOpen&&lt({isOpen:!1,position:{x:0,y:0}});const{x:A,y:P}=xt(h);if(v.startsWith("station")||v.startsWith("misc-node")){t(bt("free"));const z=At(10),{x:$,y:H}=ft(A,P,n,l),Y=v.startsWith("station"),D=Y?"stn_".concat(z):"misc_node_".concat(z),L=Y?v.slice(8):v.slice(10),C=structuredClone({...mt,...Dt}[L].defaultAttrs);de.has(L)&&(C.color=y),Y&&(C.names=await et(L)),e.current.addNode(D,{visible:!0,zIndex:0,x:Z($,5),y:Z(H,5),type:L,[L]:C}),o&&Nt.event(Ct.ADD_STATION,{type:L}),r(),t(wt(new Set([D])))}else v==="free"||v.startsWith("line")?(v.startsWith("line")&&(t(bt("free")),M&&t(Ze(!1))),_({x:A,y:P}),ot(l),h.shiftKey||(t(Et("background")),t(vt()))):v==="select"&&(nt(ft(A,P,n,l)),B(ft(A,P,n,l)))}),at=O(h=>{if(v==="select"){if(R.x!=0&&R.y!=0){const{x:A,y:P}=xt(h);B(ft(A,P,n,l))}}else if(x==="background"){const{x:A,y:P}=xt(h);t(It({x:V.x+(yt.x-A)*n/100,y:V.y+(yt.y-P)*n/100}))}}),ut=O(h=>{if(v==="select"){const{x:A,y:P}=xt(h),{x:z,y:$}=ft(A,P,n,l),H=fe(e.current,R.x,R.y,z,$),Y=Je(e.current,new Set(H));t(wt(new Set([...h.shiftKey?d:[],...H,...Y]))),t(bt("free")),nt({x:0,y:0}),B({x:0,y:0})}x==="background"&&!h.shiftKey&&t(Et(void 0))}),ht=O(h=>{let A=n;h.deltaY>0&&n+10<400?A=n+10:h.deltaY<0&&n-10>0&&(A=n-10),t(he(A));const{x:P,y:z}=xt(h),$=h.currentTarget.getBoundingClientRect(),[H,Y]=[P/$.width,z/$.height];t(It({x:l.x+P*n/100-W*A/100*H,y:l.y+z*n/100-N*A/100*Y}))}),j=O(h=>{h.preventDefault(),xt(h),lt({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),I=O(()=>{lt({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),q=O(async h=>{if(St?h.key==="Backspace":h.key==="Delete")d.size>0&&(d.forEach(A=>{if(e.current.hasNode(A))e.current.dropNode(A);else if(e.current.hasEdge(A)){const[P,z]=e.current.extremities(A);e.current.dropEdge(A),i&&P.startsWith("stn")&&Tt(e.current,P),i&&z.startsWith("stn")&&Tt(e.current,z)}}),t(vt()),r());else if(h.key.startsWith("Arrow")){const P=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,z=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(It(ft(100*P,100*z,n,l)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const A=(h.key==="j"?-1:h.key==="l"?1:0)*_t,P=(h.key==="i"?-1:h.key==="k"?1:0)*_t;d.size>0&&d.forEach(z=>{e.current.hasNode(z)&&(e.current.updateNodeAttribute(z,"x",$=>($!=null?$:0)+A),e.current.updateNodeAttribute(z,"y",$=>($!=null?$:0)+P),r())})}else if(h.key==="f"&&b)t(bt(b));else if(h.key==="z"&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey))St&&h.preventDefault(),t(Ke()),t(gt()),t(pt());else if(h.key==="s")t(bt("select"));else if((h.key==="c"||h.key==="x")&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey)){const A=$t(e.current,d);navigator.clipboard.writeText(A),h.key==="x"&&(t(vt()),d.forEach(P=>{e.current.hasNode(P)?e.current.dropNode(P):e.current.hasEdge(P)&&e.current.dropEdge(P)}),r())}else if(h.key==="v"&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey)){const A=await navigator.clipboard.readText(),{x:P,y:z}=ft(W/2,N/2,n,l),{nodes:$,edges:H}=le(A,e.current,T,Q,Z(P,5),Z(z,5));r();const Y=structuredClone($);H.forEach(D=>Y.add(D)),t(wt(Y))}else if(St&&h.key==="z"&&h.metaKey&&h.shiftKey||!St&&h.key==="y"&&h.ctrlKey)t(He());else if(h.key==="c")t(Ue(!g));else if(h.key==="r"){const A=h.altKey?5:45;pe(e.current,d,A)&&r()}else if(h.key==="e"){const[A]=d;if(d.size===1&&e.current.hasEdge(A)){const P=e.current.getEdgeAttributes(A),{type:z}=P;if(z!==tt.Simple&&P[z]){const $=P[z],Y=($.startFrom||"from")==="from"?"to":"from";let D=P.parallelIndex;if(p){const[C,X]=e.current.extremities(A);D=ue(e.current,z,C,X,Y)}const L={...$,startFrom:Y};e.current.mergeEdgeAttributes(A,{[z]:L,parallelIndex:D}),r()}}}}),[K,G]=E.useState({sx:0,sy:0,ex:0,ey:0});return E.useEffect(()=>{G({sx:R.x<=S.x?R.x:S.x,ex:R.x>S.x?R.x:S.x,sy:R.y<=S.y?R.y:S.y,ey:R.y>S.y?R.y:S.y})},[S.x,S.y]),u.jsxs(u.Fragment,{children:[u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:N,width:W,viewBox:"".concat(l.x," ").concat(l.y," ").concat(W*n/100," ").concat(N*n/100),onPointerDown:dt,onPointerMove:at,onPointerUp:ut,onWheel:ht,onContextMenu:j,tabIndex:0,onKeyDown:q,children:[u.jsx("defs",{children:u.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[u.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),u.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&u.jsx(on,{svgViewBoxMin:l,svgViewBoxZoom:n,svgWidth:W,svgHeight:N}),Jt()&&v==="free"&&u.jsx(Sn,{}),f&&d.size===1&&v==="free"&&u.jsx(an,{}),u.jsx(Ge.SvgAssetsContextProvider,{children:u.jsx(wn,{})}),v==="select"&&R.x!=0&&R.y!=0&&u.jsx("rect",{x:K.sx,y:K.sy,width:K.ex-K.sx,height:K.ey-K.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Jt()&&[...d].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&u.jsx(An,{}),u.jsx(Xe,{})]}),u.jsx(sn,{isOpen:st.isOpen,position:st.position,onClose:I}),Fe()&&m==="hide"&&u.jsx(Pe,{"aria-label":"open details panel",icon:u.jsx(Ye,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(Ve()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Dn as default};

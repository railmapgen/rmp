!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-nkaI-069.js","./index-legacy-y9YJzdkr.js","./master-manager-legacy-Dh1z9Ct_.js","./react-legacy-BK_l0oMH.js","./clipboard-legacy-BZb8m0e7.js","./misc-nodes-legacy-Dra3H4Vc.js"],(function(e,n){"use strict";var r,o,i,s,a,l,c,d,u,h,y,x,p,g,f,m,v,b,w,P,j,A,k,N,S,D,M,_,z,$,C,E,I,W,O,T,H,L,R,B,K,X,Y,F,U,V,q,Q,Z,J,G,ee,te,ne,re,oe,ie,se,ae,le,ce,de,ue,he,ye,xe,pe,ge,fe,me,ve,be;return{setters:[e=>{r=e.ad,o=e.j,i=e.a2},e=>{s=e.c,a=e.e,l=e.a7,c=e.z,d=e.ay,u=e.az,h=e.aA,y=e.aB,x=e.p,p=e.aC,g=e.aD,f=e.L,m=e.aE,v=e.aF,b=e.aG,w=e.n,P=e.aH,j=e.d,A=e.r,k=e.E,N=e.q,S=e.aI,D=e.X,M=e.w,_=e.x,z=e.y,$=e.aJ,C=e.aK,E=e.aL,I=e.aM,W=e.t,O=e.v,T=e.aN,H=e.aO,L=e.aP,R=e.o,B=e.F,K=e.Y,X=e.aQ,Y=e.S,F=e.aR,U=e.a4,V=e.aS,q=e.aT,Q=e.aU,Z=e.aV,J=e.ag,G=e.H,ee=e.av,te=e.aw,ne=e.a9,re=e.G,oe=e.a5},e=>{ie=e.s,se=e.f,ae=e.g,le=e.c,ce=e.e,de=e.h,ue=e.j,he=e.k,ye=e.l},e=>{xe=e.b,pe=e.k},e=>{ge=e.u,fe=e.e,me=e.i},e=>{ve=e.v,be=e.m}],execute:function(){const n={[l.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[l.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},we=pe("runtime/getStationNames",(async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:o}=t().account;if(!o)return void n(d({cityName:e,names:[]}));const i=await fetch(`${u}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o}`}});if(!i.ok)return c.warn("Failed to fetch random station names",i.statusText),r(i.statusText);const s=await i.json();n(d({cityName:e,names:s}))})),Pe=pe("runtime/getOneStationName",(async(e,{getState:t,dispatch:r})=>{var o;const{stationNames:i}=t().runtime,s=i[e];if(0==(null!==(o=null==s?void 0:s.length)&&void 0!==o?o:0))return c.debug("No random station names in cache, using fallback"),r(we({cityName:e})),Object.values((e=>{const t=n[e];return t.at(Math.floor(Math.random()*t.length))})(e));const a=structuredClone(s),l=a.shift();return r(d({cityName:e,names:a})),a.length<3&&r(we({cityName:e})),Object.values(l)})),je=()=>{const e=s(),{activeSubscriptions:t}=a((e=>e.account)),{preference:{randomStationsNames:n}}=a((e=>e.app)),r=!t.RMP_CLOUD||"none"===n;return xe.useCallback((async t=>{const n=ie[t].defaultAttrs.names;if(!r){const t=await e(Pe(l.Shmetro));if(Pe.fulfilled.match(t)){const e=t.payload;return n.length>e.length?e.push(...Array(n.length-e.length).fill(e.at(-1))):n.length<e.length&&e.splice(n.length),e}}return structuredClone(n)}),[e,r])},Ae=xe.memo((e=>{const{svgViewBoxMin:t,svgViewBoxZoom:n,svgWidth:i,svgHeight:s}=e,{preference:{toolsPanel:{expand:l}}}=a((e=>e.app)),c="light"===r().colorMode?"#666464":"#D3D3D4",d=h(t,n,i,s),u=l?410*n/100:0,x=n>30?n>120?50:25:5,p=n/200,g={startX:y(d.xMin+u-x,x),endX:y(d.xMax+u+x,x),startY:y(d.yMin-x,x),endY:y(d.yMax+x,x)},f=Array.from({length:(g.endX-g.startX)/x+1},((e,t)=>{const n=g.startX+t*x,r=n%(5*x)==0?2*p:p;return o.jsx("line",{x1:n,y1:g.startY,x2:n,y2:g.endY,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_vl_${n}`)})),m=Array.from({length:(g.endY-g.startY)/x+1},((e,t)=>{const n=g.startY+t*x,r=n%(5*x)==0?2*p:p;return o.jsx("line",{x1:g.startX,y1:n,x2:g.endX,y2:n,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_hl_${n}`)})),v=Array.from({length:(g.endX-g.startX)/x/5+1},((e,t)=>{const r=y(g.startX,5*x)+5*t*x;return o.jsx("text",{x:r,y:d.yMin+n/5,fontSize:25*p,fill:c,textAnchor:"middle",opacity:"0.5",children:r},`grid_vc_${r}`)})),b=Array.from({length:(g.endY-g.startY)/x/5+1},((e,t)=>{const r=y(g.startY,5*x)+5*t*x;return o.jsx("text",{x:d.xMin+n/8+u,y:r,fontSize:25*p,fill:c,textAnchor:"start",opacity:"0.5",children:r},`grid_hc_${r}`)}));return o.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,m,v,b]})}),((e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight)),ke=ve.component,Ne=p.generatePath,Se=g.component,De=()=>{var e;const n=s(),{telemetry:{project:r},preference:{autoParallel:i}}=a((e=>e.app)),{selected:l,theme:c,count:{mostFrequentStationType:d}}=a((e=>e.runtime)),u=je(),h=l.keys().next().value;if(!h.startsWith("stn")&&!h.startsWith("misc_node"))return;if(!window.graph.hasNode(h))return;const y=window.graph.neighbors(h);if(0===y.length)return;const g=window.graph.getNodeAttributes(h),$=y.reduce(((e,t)=>{const n=window.graph.getNodeAttributes(t);return{x:e.x+n.x,y:e.y+n.y}}),{x:0,y:0}),C=$.x/y.length,E=$.y/y.length,I={x:g.x-C,y:g.y-E},W=g.x+I.x,O=g.y+I.y,T=Math.sign(I.x)===Math.sign(I.y),H={x:W-10,y:O+10*(T?1:-1)},L={x:W+10,y:O+10*(T?-1:1)},R=h.startsWith("stn_")?window.graph.getNodeAttribute(h,"type"):d,B=ie[R].component,K={visible:!0,zIndex:0,x:L.x,y:L.y,type:R,[R]:ie[R].defaultAttrs},X=window.graph.reduceEdges(h,((e,t)=>{const n=window.graph.getEdgeAttributes(t),{style:r}=n;if(r===x.SingleColor){const t=JSON.stringify(n[r].color);t in e?e[t]+=1:e[t]=1}return e}),{}),Y=null!==(e=Object.entries(X).filter((([e,t])=>t%2!=0)).reduce(((e,[t,n])=>n>e.count?{color:JSON.parse(t),count:n}:e),{color:null,count:0}).color)&&void 0!==e?e:c,F=I.x>0?!(I.x>Math.abs(I.y)):-I.x>Math.abs(I.y),U=F?"from":"to",V=Ne(g.x,H.x,g.y,H.y,t(t({},p.defaultAttrs),{},{startFrom:U})),q=F?"to":"from",Q=Ne(g.x,L.x,g.y,L.y,t(t({},p.defaultAttrs),{},{startFrom:q})),Z=async(e,o)=>{o.stopPropagation();const{x:s,y:a}=v(o);n(b({x:s,y:a}));const l=w(10),d=P.has(e),y=d?`stn_${l}`:`misc_node_${l}`,p=structuredClone(t(t({},ie),be)[e].defaultAttrs);j.has(e)&&(p.color=c),d&&(p.names=await u(e)),window.graph.addNode(y,{visible:!0,zIndex:0,x:d?L.x:H.x,y:d?L.y:H.y,type:e,[e]:p}),r&&A.event(k.ADD_STATION,{type:e});const g=f.Diagonal,m=`line_${w(10)}`,[$,C]=[h,y],E=i?0:-1,I=d?q:U;window.graph.addDirectedEdgeWithKey(m,$,C,{visible:!0,zIndex:0,type:g,[g]:t(t({},structuredClone(N[g].defaultAttrs)),{},{startFrom:I}),style:x.SingleColor,[x.SingleColor]:{color:Y},reconcileId:"",parallelIndex:E}),r&&A.event(k.ADD_LINE,{type:g}),n(M(window.graph.export())),n(_()),n(z()),n(S(y)),n(D(new Set([y])))};return o.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[o.jsx(Se,{id:"line_prediction_1",type:f.Diagonal,path:V,styleAttrs:{color:Y},newLine:!0,handlePointerDown:()=>{}}),o.jsx(Se,{id:"line_prediction_2",type:f.Diagonal,path:Q,styleAttrs:{color:Y},newLine:!0,handlePointerDown:()=>{}}),o.jsx(ke,{id:"misc_node_virtual_prediction_1",attrs:{},x:H.x,y:H.y,handlePointerDown:(e,t)=>{Z(m.Virtual,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),o.jsx(B,{id:"stn_virtual_prediction_2",attrs:K,x:L.x,y:L.y,handlePointerDown:(e,t)=>{Z(d,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Me=(e,t,n,r,o,i)=>{if(!("offsetFrom"in i)||!("offsetTo"in i))return;if(Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return ze(e,t,n,r,o)?{x1:t,y1:n,x2:r,y2:o,offset:i.offsetFrom}:void 0;const[s,a]=[i.offsetFrom,i.offsetTo];for(let l=0;l<Math.PI;l+=Math.PI/8)for(let i=l,c=0;c<2;c++,i+=Math.PI){const[c,d,u,h]=[Math.sin(l)*s,Math.cos(l)*s,Math.sin(i)*a,Math.cos(i)*a];if(ze(e,t+c,n+d,r+u,o+h))return{x1:t+c,y1:n+d,x2:r+u,y2:o+h,offset:0}}},_e=(e,t,n,r,o,i)=>e===n?{x1:e+5*i,y1:t,x2:n+5*i,y2:r,offset:o}:t===r?{x1:e,y1:t+5*i,x2:n,y2:r+5*i,offset:o}:{x1:e+5*Math.SQRT1_2*i,y1:t+5*Math.SQRT1_2*i,x2:n+5*Math.SQRT1_2*i,y2:r+5*Math.SQRT1_2*i,offset:o},ze=(e,t,n,r,o)=>!(t!==r&&n!==o||![f.Diagonal,f.Perpendicular].includes(e))||!(1!==Math.abs((o-n)/(r-t))||![f.Diagonal,f.RotatePerpendicular].includes(e)),$e=(e,t)=>{if(!t.every((t=>e.hasEdge(t))))return;const n=t.map((t=>{var n,r,o;const[i,s]=e.extremities(t),a=e.getNodeAttributes(i),l=e.getNodeAttributes(s),{type:c}=e.getEdgeAttributes(t),d=null!==(n=e.getEdgeAttribute(t,c))&&void 0!==n?n:N[c].defaultAttrs,u=Me(c,a.x,a.y,l.x,l.y,d);if(u){const{x1:e,y1:t,x2:n,y2:r,offset:o}=u;return N[f.Simple].generatePath(e,n,t,r,{offset:o})}return null!==(r=null===(o=N[c])||void 0===o?void 0:o.generatePath(a.x,l.x,a.y,l.y,d))&&void 0!==r?r:`M ${a.x} ${a.y} L ${l.x} ${l.y}`}));let r=`${n[0]} `;for(let o=1;o<t.length;o+=1)r+=n[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},Ce=e=>[...e.nodeEntries()].map((e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes})),Ee=e=>{const t={},n={},r=[],o={},i=[];for(const c of e.edgeEntries()){const[e,t,r,o]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y],i=c.attributes[c.attributes.type],s=Me(c.attributes.type,e,t,r,o,i);n[c.edge]=s}for(const c of e.edgeEntries()){let s=n[c.edge];const{parallelIndex:a}=c.attributes;if(a>=0){const t=n[$(e,c.attributes.type,c.edge)];if(!t){r.push(c);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:o,offset:i}=t;s=_e(e,n,r,o,i,a)}}if(""===c.attributes.reconcileId)if(s){const e=c.edge,n=c.attributes,{x1:r,y1:o,x2:i,y2:a,offset:l}=s;t[e]={attr:n,path:N[f.Simple].generatePath(r,i,o,a,{offset:l})}}else i.push(c);else{const e=c.attributes.reconcileId;e in o?o[e].push(c):o[e]=[c]}}const s=new Set;for(;r.length;){const n=r.pop();if(s.has(n.edge))continue;const{parallel:o}=C(e,n);if(!o.length)continue;o.forEach((e=>s.add(e.edge)));const i=E(o);for(const e of o){const n=e.edge;t[n]={attr:e.attributes,path:i[n]}}}const{allReconciledLines:a,danglingLines:l}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach((t=>{if(1===t.length)return void r.push(...t.map((e=>e.edge)));const o=e.getEdgeAttribute(t.at(0),"type");if(!t.every((t=>e.getEdgeAttribute(t,"type")===o)))return void r.push(...t.map((e=>e.edge)));const i=e.getEdgeAttribute(t.at(0),"style");if(!t.every((t=>e.getEdgeAttribute(t,"style")===i)))return void r.push(...t.map((e=>e.edge)));const s={},a=new Set,l=new Set,c=Object.fromEntries(t.map((t=>{var n,r;const[o,i]=e.extremities(t);return s[o]=(null!==(n=s[o])&&void 0!==n?n:0)+1,s[i]=(null!==(r=s[i])&&void 0!==r?r:0)+1,a.add(o),l.add(i),[o,[t.edge,i]]}))),d=Array.from(a).filter((e=>1===s[e])),u=Array.from(l).filter((e=>1===s[e]));if(1!==d.length||1!==u.length)return void r.push(...t.map((e=>e.edge)));const h=d[0],y=u[0];if(h===y)return void r.push(...t.map((e=>e.edge)));const x=[c[h][0]];let p=c[h][1];for(let e=1;e<t.length;e+=1){var g;const e=null===(g=c[p])||void 0===g?void 0:g.at(1);if(!e)return void r.push(...t.map((e=>e.edge)));x.push(c[p][0]),p=e}p===y&&x.length===t.length?n.push(x):r.push(...t.map((e=>e.edge)))})),{allReconciledLines:n,danglingLines:r}})(e,o);for(const c of a){const n=$e(e,c);if(!n)continue;const r=c[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const c of l){const n=e.getEdgeAttributes(c),[r,o]=e.extremities(c),i=e.getNodeAttributes(r),s=e.getNodeAttributes(o);t[c]={attr:n,path:N[f.Simple].generatePath(i.x,s.x,i.y,s.y,N[f.Simple].defaultAttrs)}}for(const c of i){const e=c.edge,n=c.attributes.type,r=c.attributes,[o,i,s,a]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y];n in N?t[e]={attr:r,path:N[n].generatePath(o,s,i,a,r[n])}:t[e]={attr:r,path:`M ${o} ${i} L ${s} ${a}`}}return Object.entries(t).map((([e,t])=>({id:e,type:"line",line:t})))},Ie=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=a((e=>e.param)),{original:r,offset:i,rotate:s}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort(((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x)),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map((e=>({x:e.x,y:e.y+10}))),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map((e=>({x:e.x+10,y:e.y}))),rotate:90};{const e=10,r=-1/n,o=e/Math.sqrt(r*r+1),i=e*r/Math.sqrt(r*r+1);return{original:t,offset:t.map((e=>({x:e.x+o,y:e.y+i}))),rotate:-Math.atan(r)*(180/Math.PI)}}})(t),l=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${`${-e/2},${t}`} ${`${e/2},${t}`}`},c=n/75,d=8*c,u="#FC8181",h=`${5*c} ${2*c}`;return o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,stroke:u,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:i[1].x,y1:i[1].y,x2:i[2].x,y2:i[2].y,stroke:u,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[0].x,y1:r[0].y,x2:i[0].x,y2:i[0].y,stroke:u,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[1].x,y1:r[1].y,x2:i[1].x,y2:i[1].y,stroke:u,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[2].x,y1:r[2].y,x2:i[2].x,y2:i[2].y,stroke:u,strokeWidth:c,strokeDasharray:h}),o.jsx("polygon",{points:l(d),transform:`translate(${i[0].x},${i[0].y}) rotate(${(s+270)%360})`,fill:u}),o.jsx("polygon",{points:l(d),transform:`translate(${i[1].x},${i[1].y}) rotate(${(s+270)%360})`,fill:u}),o.jsx("polygon",{points:l(d),transform:`translate(${i[1].x},${i[1].y}) rotate(${(s+90)%360})`,fill:u}),o.jsx("polygon",{points:l(d),transform:`translate(${i[2].x},${i[2].y}) rotate(${(s+90)%360})`,fill:u})]})},We=e=>{const{id:t,x:n,y:r,handlePointerDown:i,handlePointerMove:s,handlePointerUp:a}=e,l=xe.useCallback((e=>i(t,e)),[t,i]),c=xe.useCallback((e=>s(t,e)),[t,s]),d=xe.useCallback((e=>a(t,e)),[t,a]);return o.jsx("g",{id:t,transform:`translate(${n-6.4} ${r-6.4})scale(0.025)`,onPointerDown:l,onPointerMove:c,onPointerUp:d,style:{cursor:"move"},children:o.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Oe=e=>{const{id:t,path:n,handlePointerDown:r}=e,i=xe.useCallback((e=>r(t,e)),[t,r]);return o.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},Te=xe.memo((e=>{const{elements:t,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i,handleEdgePointerDown:s}=e,a=Object.fromEntries(Array.from({length:21},((e,t)=>[t-10,{pre:[],main:[],post:[]}])));for(const b of t)if("line"===b.type){var l,c,d,u;const e=b.line.attr.type,t=b.line.attr.style,n=b.line.attr[t],r=null===(l=I[t])||void 0===l?void 0:l.preComponent;r&&a[b.line.attr.zIndex].pre.push(o.jsx(r,{id:b.id,type:e,path:b.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${b.id}.pre`));const i=null!==(c=null===(d=I[t])||void 0===d?void 0:d.component)&&void 0!==c?c:Oe;a[b.line.attr.zIndex].main.push(o.jsx(i,{id:b.id,type:e,path:b.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},b.id));const h=null===(u=I[t])||void 0===u?void 0:u.postComponent;h&&a[b.line.attr.zIndex].post.push(o.jsx(h,{id:b.id,type:e,path:b.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${b.id}.post`))}else if("station"===b.type){var h,y,x,p;const e=b.station,t=e.type,s=null===(h=ie[t])||void 0===h?void 0:h.preComponent;s&&a[b.station.zIndex].pre.push(o.jsx(s,{id:b.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${b.id}.pre`));const l=null!==(y=null===(x=ie[t])||void 0===x?void 0:x.component)&&void 0!==y?y:We;a[b.station.zIndex].main.push(o.jsx(l,{id:b.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},b.id));const c=null===(p=ie[t])||void 0===p?void 0:p.postComponent;c&&a[b.station.zIndex].post.push(o.jsx(c,{id:b.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${b.id}.post`))}else if("misc-node"===b.type){var g,f,m,v;const e=b.miscNode,t=e.type,s=null===(g=be[t])||void 0===g?void 0:g.preComponent;s&&a[b.miscNode.zIndex].pre.push(o.jsx(s,{id:b.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${b.id}.pre`));const l=null!==(f=null===(m=be[t])||void 0===m?void 0:m.component)&&void 0!==f?f:We;a[b.miscNode.zIndex].main.push(o.jsx(l,{id:b.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},b.id));const c=null===(v=be[t])||void 0===v?void 0:v.postComponent;c&&a[b.miscNode.zIndex].post.push(o.jsx(c,{id:b.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${b.id}.post`))}return Array.from({length:21},((e,t)=>(t-10).toString())).map((e=>[...a[e].pre,...a[e].main,...a[e].post])).flat()}),((e,t)=>e.elements===t.elements)),He=[...Object.values(Y),m.Virtual,m.Master,m.LondonArrow,m.ChongqingRTNumLineBadge2021,m.ChongqingRTTextLineBadge2021,m.ChengduRTLineBadge,m.GzmtrLineBadge],Le=()=>{const e=s(),n=xe.useRef(window.graph),{telemetry:{project:r},preference:{autoParallel:i,gridLines:l,snapLines:c}}=a((e=>e.app)),{svgViewBoxZoom:d,svgViewBoxMin:u}=a((e=>e.param)),{selected:p,pointerPosition:m,active:P,refresh:{nodes:j,edges:$},mode:C,keepLastPath:E,theme:I}=a((e=>e.runtime)),Y=W(),{height:F,width:U}=O(Y),[V,q]=xe.useState({dx:0,dy:0}),[Q,Z]=xe.useState([]),[J,G]=xe.useState([]),[ee,te]=xe.useState([]);xe.useEffect((()=>{if(!m||!c)return;const e=h(u,d,U,F),t=se(n.current,...Object.values(e));G(t),Z(ae(n.current,t))}),[u,d,U,F,m]);const[ne,re]=xe.useState(void 0),oe=ge(((t,n)=>{n.stopPropagation(),n.currentTarget.setPointerCapture(n.pointerId);const{x:r,y:o}=v(n);"select"===C&&e(T("free")),te([]),re(void 0),e(b({x:r,y:o})),e(S(t)),n.shiftKey?p.has(t)?e(H(t)):e(L(t)):p.has(t)||e(D(new Set([t])))})),he=ge(((r,o)=>{const{x:i,y:s}=v(o);if(o.currentTarget.setPointerCapture(o.pointerId),"free"===C&&P===r){if(!o.altKey&&c){const e=n.current.getNodeAttribute(r,"x"),o=n.current.getNodeAttribute(r,"y"),a=e-(m.x-i)*d/100,l=o-(m.y-s)*d/100;let c=a,u=l;if(le(r,n.current)){let e=ee,t=ne;if(0!==e.length&&(e=e.filter((e=>ce(e,a,l)<=6))),t&&(0===e.length||Math.hypot(a-t.x,l-t.y)>6)&&(t=void 0),!t&&1===e.length){const r=e[0],{snapPoint:o,distance:i}=de(n.current,J.filter((e=>!p.has(e))),a,l,r);i<=3&&(t=o)}if(1===e.length&&!t||0===e.length){const{l:t,d:n}=ue(a,l,Q,J.filter((t=>!p.has(t)&&!e.some((e=>e.node===t))))),r=0===e.length||!e.some((e=>e.a===t.a&&e.b===t.b));n<3&&e.length<2&&r&&e.push(t)}if(1===e.length)if(t)c=t.x,u=t.y;else{const t=e[0];if(0==t.a)u=-t.c/t.b;else if(0==t.b)c=-t.c/t.a;else{u=-t.a/t.b*c+-t.c/t.b}}else if(2===e.length){const t=e[0],n=e[1],r=t.a*n.b-n.a*t.b;0!==r&&(c=-(t.c*n.b-n.c*t.b)/r,u=-(t.a*n.c-n.a*t.c)/r)}te(e),re(t)}const h=c-e,x=u-o;p.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:y(e.x+h,.01),y:y(e.y+x,.01)})))}))}else te([]),re(void 0),p.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:y(e.x-(m.x-i)*d/100,o.altKey?.01:5),y:y(e.y-(m.y-s)*d/100,o.altKey?.01:5)})))}));e(_()),e(z())}else C.startsWith("line")&&P&&q({dx:(m.x-i)*d/100,dy:(m.y-s)*d/100})})),ye=ge(((t,o)=>{if(o.currentTarget.releasePointerCapture(o.pointerId),C.startsWith("line")){var s;E||e(T("free"));const t=n.current.hasNode(P)&&He.includes(n.current.getNodeAttribute(P,"type")),a=["stn_core_","virtual_circle_","misc_node_connectable_"],l=null===(s=document.elementsFromPoint(o.clientX,o.clientY).at(0))||void 0===s||null===(s=s.attributes)||void 0===s||null===(s=s.getNamedItem("id"))||void 0===s?void 0:s.value,c=a.find((e=>null==l?void 0:l.startsWith(e)));if(t&&c){const t=C.slice(5),o=`line_${w(10)}`,[s,a]=[P,l.slice(c.length)];if(s!==a){const l=i?R(n.current,t,s,a,"from"):-1;n.current.addDirectedEdgeWithKey(o,s,a,{visible:!0,zIndex:0,type:t,[t]:structuredClone(N[t].defaultAttrs),style:x.SingleColor,[x.SingleColor]:{color:I},reconcileId:"",parallelIndex:l}),e(D(new Set([o]))),r&&A.event(k.ADD_LINE,{type:t}),e(M(n.current.export())),e(z())}}}else if("free"===C&&P){const{x:t,y:r}=v(o);m.x-t==0&&m.y-r==0||(e(M(n.current.export())),e(_()))}te([]),re(void 0),b(void 0),e(S(void 0))})),pe=ge(((t,o)=>{if(o.stopPropagation(),o.shiftKey||e(B()),o.shiftKey&&p.has(t)?e(H(t)):e(L(t)),C.startsWith("station")||C.startsWith("misc-node-virtual")||C.startsWith("misc-node-master")){const s=o.clientX-document.getElementById("canvas").getBoundingClientRect().left,a=o.clientY-document.getElementById("canvas").getBoundingClientRect().top,l=C.startsWith("station"),c=w(10),h=l?`stn_${c}`:`misc_node_${c}`,x=l?C.slice(8):C.slice(10),{x:p,y:g}=K(s,a,d,u),f=l?structuredClone(ie[x].defaultAttrs):structuredClone(be[x].defaultAttrs);"color"in f&&(f.color=I),n.current.addNode(h,{visible:!0,zIndex:0,x:y(p,5),y:y(g,5),type:x,[x]:f});const m=n.current.getEdgeAttributes(t),{zIndex:v,type:b,style:P}=m,j=m[b],N=m[P],[S,$]=n.current.extremities(t),E=i?0:-1;n.current.addDirectedEdgeWithKey(`line_${w(10)}`,S,h,{visible:!0,zIndex:v,type:b,[b]:structuredClone(j),style:P,[P]:structuredClone(N),reconcileId:"",parallelIndex:E}),n.current.addDirectedEdgeWithKey(`line_${w(10)}`,h,$,{visible:!0,zIndex:v,type:b,[b]:structuredClone(j),style:P,[P]:structuredClone(N),reconcileId:"",parallelIndex:E}),n.current.dropEdge(t),e(M(n.current.export())),e(_()),e(z()),r&&(A.event(k.ADD_STATION,{type:x}),A.event(k.ADD_LINE,{type:b})),e(T("free")),e(D(new Set([h])))}})),fe=xe.useMemo((()=>[...Ee(n.current),...Ce(n.current)]),[$,j]),me=g.component;return o.jsxs(o.Fragment,{children:[o.jsx(Te,{elements:fe,handlePointerDown:oe,handlePointerMove:he,handlePointerUp:ye,handleEdgePointerDown:pe}),C.startsWith("line")&&P&&"background"!==P&&o.jsx(me,{id:"line_create_in_progress___no_use",type:C.slice(5),path:N[C.slice(5)].generatePath(n.current.getNodeAttribute(P,"x"),n.current.getNodeAttribute(P,"x")-V.dx,n.current.getNodeAttribute(P,"y"),n.current.getNodeAttribute(P,"y")-V.dy,N[C.slice(5)].defaultAttrs),styleAttrs:{color:I},newLine:!0,handlePointerDown:()=>{}}),0!==ee.length&&ee.map((e=>o.jsx("path",{d:N[f.Simple].generatePath(...X(e,h(u,d,U,F)),N[f.Simple].defaultAttrs),stroke:"cyan",strokeWidth:d/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`))),ne&&o.jsx(Ie,{activeSnapPoint:ne})]})};e("default",(()=>{const e=s(),n=xe.useRef(window.graph),r=()=>{e(M(n.current.export())),e(_()),e(z())},{activeSubscriptions:l}=a((e=>e.account)),{telemetry:{project:c},preference:{gridLines:d,snapLines:u,predictNextNode:h,autoParallel:x}}=a((e=>e.app)),{svgViewBoxZoom:p,svgViewBoxMin:g}=a((e=>e.param)),{selected:m,active:b,isDetailsOpen:P,mode:N,lastTool:$,keepLastPath:C,theme:E,count:{masters:I,lines:H}}=a((e=>e.runtime)),L=W(),{height:X,width:Y}=O(L),ae=!l.RMP_CLOUD&&I+1>F,le=!l.RMP_CLOUD&&H+1>U,ce=je();V();const[de,ue]=xe.useState({x:0,y:0}),[pe,ve]=xe.useState({x:0,y:0}),[we,Pe]=xe.useState({x:0,y:0}),[ke,Ne]=xe.useState({x:0,y:0}),Se=ge((async o=>{const{x:i,y:s}=v(o);if(N.startsWith("station")||N.startsWith("misc-node")){e(T("free"));const o=w(10),{x:a,y:l}=K(i,s,p,g),d=N.startsWith("station"),u=d?`stn_${o}`:`misc_node_${o}`,h=d?N.slice(8):N.slice(10),x=structuredClone(t(t({},ie),be)[h].defaultAttrs);j.has(h)&&(x.color=E),d&&(x.names=await ce(h)),n.current.addNode(u,{visible:!0,zIndex:0,x:y(a,5),y:y(l,5),type:h,[h]:x}),c&&A.event(k.ADD_STATION,{type:h}),r(),e(D(new Set([u])))}else"free"===N||N.startsWith("line")?(N.startsWith("line")&&(e(T("free")),C&&e(oe(!1))),Pe({x:i,y:s}),Ne(g),o.shiftKey||(e(S("background")),e(B()))):"select"===N&&(ue(K(i,s,p,g)),ve(K(i,s,p,g)))})),Me=ge((t=>{if("select"===N){if(0!=de.x&&0!=de.y){const{x:e,y:n}=v(t);ve(K(e,n,p,g))}}else if("background"===b){const{x:n,y:r}=v(t);e(G({x:ke.x+(we.x-n)*p/100,y:ke.y+(we.y-r)*p/100}))}})),_e=ge((t=>{if("select"===N){const{x:r,y:o}=v(t),{x:i,y:s}=K(r,o,p,g),a=se(n.current,de.x,de.y,i,s),l=ye(n.current,new Set(a));e(D(new Set([...t.shiftKey?m:[],...a,...l]))),e(T("free")),ue({x:0,y:0}),ve({x:0,y:0})}"background"!==b||t.shiftKey||e(S(void 0))})),ze=ge((t=>{let n=p;t.deltaY>0&&p+10<400?n=p+10:t.deltaY<0&&p-10>0&&(n=p-10),e(re(n));const{x:r,y:o}=v(t),i=t.currentTarget.getBoundingClientRect(),[s,a]=[r/i.width,o/i.height];e(G({x:g.x+r*p/100-Y*n/100*s,y:g.y+o*p/100-X*n/100*a}))})),$e=ge((async o=>{if(J?"Backspace"===o.key:"Delete"===o.key)m.size>0&&(m.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),e(B()),r());else if(o.key.startsWith("Arrow")){const t=100,n=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,r=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(G(K(t*n,t*r,p,g)))}else if("i"===o.key||"j"===o.key||"k"===o.key||"l"===o.key){const e=10,t=("j"===o.key?-1:"l"===o.key?1:0)*e,i=("i"===o.key?-1:"k"===o.key?1:0)*e;m.size>0&&m.forEach((e=>{n.current.hasNode(e)&&(n.current.updateNodeAttribute(e,"x",(e=>(null!=e?e:0)+t)),n.current.updateNodeAttribute(e,"y",(e=>(null!=e?e:0)+i)),r())}))}else if("f"===o.key&&$)e(T($));else if("z"===o.key&&(J?o.metaKey&&!o.shiftKey:o.ctrlKey))J&&o.preventDefault(),e(ee()),e(_()),e(z());else if("s"===o.key)e(T("select"));else if("c"!==o.key&&"x"!==o.key||!(J?o.metaKey&&!o.shiftKey:o.ctrlKey)){if("v"===o.key&&(J?o.metaKey&&!o.shiftKey:o.ctrlKey)){const t=await navigator.clipboard.readText(),{x:o,y:i}=K(Y/2,X/2,p,g),{nodes:s,edges:a}=me(t,n.current,ae,le,y(o,5),y(i,5));r();const l=structuredClone(s);a.forEach((e=>l.add(e))),e(D(l))}else if(J&&"z"===o.key&&o.metaKey&&o.shiftKey||!J&&"y"===o.key&&o.ctrlKey)e(te());else if("c"===o.key)e(ne(!u));else if("e"===o.key){const[e]=m;if(1===m.size&&n.current.hasEdge(e)){const o=n.current.getEdgeAttributes(e),{type:i}=o;if(i!==f.Simple&&o[i]){const s=o[i],a="from"===(s.startFrom||"from")?"to":"from";let l=o.parallelIndex;if(x){const[t,r]=n.current.extremities(e);l=R(n.current,i,t,r,a)}const c=t(t({},s),{},{startFrom:a});n.current.mergeEdgeAttributes(e,{[i]:c,parallelIndex:l}),r()}}}}else{const t=fe(n.current,m);navigator.clipboard.writeText(t),"x"===o.key&&(e(B()),m.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),r())}})),[Ce,Ee]=xe.useState(0),Ie=ge((t=>{if(2===t.touches.length){e(S(void 0));const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];Ee(n*n+r*r)}})),We=ge((t=>{if(0!==Ce&&2===t.touches.length){const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],o=n*n+r*r;let i=p;o-Ce<0&&p+10<=390?i=p+10:o-Ce>0&&p-10>=10&&(i=p-10),e(re(i)),Ee(o);const s=t.currentTarget.getBoundingClientRect(),[a,l]=[(t.touches[0].clientX+t.touches[1].clientX)/2-s.left,(t.touches[0].clientY+t.touches[1].clientY)/2-s.top],[c,d]=[a/s.width,l/s.height];e(G({x:g.x+a*p/100-Y*i/100*c,y:g.y+l*p/100-X*i/100*d}))}})),Oe=ge((e=>{0!==Ce&&Ee(0)})),[Te,He]=xe.useState({sx:0,sy:0,ex:0,ey:0});return xe.useEffect((()=>{He({sx:de.x<=pe.x?de.x:pe.x,ex:de.x>pe.x?de.x:pe.x,sy:de.y<=pe.y?de.y:pe.y,ey:de.y>pe.y?de.y:pe.y})}),[pe.x,pe.y]),o.jsxs(o.Fragment,{children:[o.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:X,width:Y,viewBox:`${g.x} ${g.y} ${Y*p/100} ${X*p/100}`,onPointerDown:Se,onPointerMove:Me,onPointerUp:_e,onTouchStart:Ie,onTouchMove:We,onTouchEnd:Oe,onWheel:ze,tabIndex:0,onKeyDown:$e,children:[o.jsx("defs",{children:o.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[o.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),o.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),d&&o.jsx(Ae,{svgViewBoxMin:g,svgViewBoxZoom:p,svgWidth:Y,svgHeight:X}),h&&1===m.size&&"free"===N&&o.jsx(De,{}),o.jsx(he.SvgAssetsContextProvider,{children:o.jsx(Le,{})}),"select"===N&&0!=de.x&&0!=de.y&&o.jsx("rect",{x:Te.sx,y:Te.sy,width:Te.ex-Te.sx,height:Te.ey-Te.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"})]}),q()&&"hide"===P&&o.jsx(i,{"aria-label":"open details panel",icon:o.jsx(Z,{style:{transform:"rotate(180deg)"}}),onClick:()=>e(Q()),style:{position:"fixed",bottom:20,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})}))}}}))}();

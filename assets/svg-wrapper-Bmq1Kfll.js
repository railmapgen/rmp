import{a as ge,j as c,P as xe,B as Qt,D as Ot,ad as pe,a2 as me}from"./chakra-C1zJvDsN.js";import{c as St,e as O,a7 as Tt,z as te,aA as $t,aB as be,aC as ee,a4 as ne,w as wt,x as ht,y as ft,aD as Nt,F as pt,Y as lt,aE as se,aF as H,X as mt,aG as Wt,p as Ct,aH as Bt,aI as oe,L as nt,aJ as rt,aK as dt,aL as Rt,n as vt,aM as ve,d as re,r as At,E as Pt,q as et,aN as Mt,aO as we,aP as Se,aQ as Ae,aR as Lt,t as _t,v as zt,aS as xt,aT as Xt,aU as Vt,o as ie,aV as Pe,S as ke,aW as Ft,aX as Me,aY as It,aZ as Ce,G as ae,H as Et,a_ as je,a$ as Ee,b0 as Ne,b1 as De,b2 as _e,b3 as ze,b4 as Le,b5 as Ie,b6 as Yt,b7 as Te,b8 as $e,b9 as We,ai as bt,ax as Be,ay as Re,a9 as Oe,a5 as Xe}from"./index-BL30Ijl5.js";import{s as yt,f as ce,c as Ve,e as Fe}from"./master-manager-BsNqKI5c.js";import{b as N,k as le,u as Ye}from"./react-BpF4RbzH.js";import{u as R}from"./useEvent-LzhclC4A.js";import{c as Dt}from"./change-types-juHgGnBV.js";import{v as He,m as kt}from"./misc-nodes-NNvEQV7e.js";const Ke={[Tt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Tt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ue=t=>{const e=Ke[t];return e.at(Math.floor(Math.random()*e.length))},Ht=le("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:d})=>{const{token:o}=e().account;if(!o){i($t({cityName:t,names:[]}));return}const s=await fetch("".concat(be,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return te.warn("Failed to fetch random station names",s.statusText),d(s.statusText);const w=await s.json();i($t({cityName:t,names:w}))}),Kt=le("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var x;const{stationNames:d}=e().runtime,o=d[t];if(((x=o==null?void 0:o.length)!=null?x:0)==0)return te.debug("No random station names in cache, using fallback"),i(Ht({cityName:t})),Object.values(Ue(t));const s=structuredClone(o),w=s.shift();return i($t({cityName:t,names:s})),s.length<3&&i(Ht({cityName:t})),Object.values(w)}),de=()=>{const t=St(),{activeSubscriptions:e}=O(o=>o.account),{preference:{randomStationsNames:i}}=O(o=>o.app),d=!e.RMP_CLOUD||i==="none";return N.useCallback(async o=>{const s=yt[o].defaultAttrs.names;if(!d){const w=await t(Kt(Tt.Shmetro));if(Kt.fulfilled.match(w)){const x=w.payload;return s.length>x.length?x.push(...Array(s.length-x.length).fill(x.at(-1))):s.length<x.length&&x.splice(s.length),x}}return structuredClone(s)},[t,d])},Ze=({isOpen:t,position:e,onClose:i})=>{const{t:d}=Ye(),o=St(),s=N.useRef(window.graph),{activeSubscriptions:w}=O(C=>C.account),{preference:{autoParallel:x}}=O(C=>C.app),{svgViewBoxZoom:p,svgViewBoxMin:r}=O(C=>C.param),{selected:n,count:{masters:u,lines:l}}=O(C=>C.runtime),f=!w.RMP_CLOUD&&u+1>ee,y=!x||x&&!w.RMP_CLOUD&&l+1>ne,m=n.size>0,b=N.useRef(null);ge({ref:b,handler:i,enabled:t});const A=N.useCallback(()=>{o(wt(s.current.export())),o(ht()),o(ft())},[o]),g=R(()=>{if(n.size>0){const C=Nt(s.current,n);navigator.clipboard.writeText(C)}}),S=R(()=>{if(n.size>0){const C=Nt(s.current,n);navigator.clipboard.writeText(C),o(pt()),n.forEach(_=>{s.current.hasNode(_)?s.current.dropNode(_):s.current.hasEdge(_)&&s.current.dropEdge(_)}),A()}}),a=R(async()=>{try{const C=await navigator.clipboard.readText(),{x:_,y:q}=lt(e.x,e.y,p,r),{nodes:X,edges:z}=se(C,s.current,f,y,H(_,5),H(q,5));A();const B=structuredClone(X);z.forEach(F=>B.add(F)),o(mt(B))}catch(C){console.warn("Failed to read clipboard:",C)}}),M=R(()=>{n.size>0&&(o(pt()),n.forEach(C=>{s.current.hasNode(C)?s.current.dropNode(C):s.current.hasEdge(C)&&s.current.dropEdge(C)}),A())}),D=R(()=>{o(ht()),o(ft())}),T=R(C=>{if(n.size>0){const _=Math.min(Math.max(C,-10),10);n.forEach(q=>{s.current.hasNode(q)&&s.current.setNodeAttribute(q,"zIndex",_),s.current.hasEdge(q)&&s.current.setEdgeAttribute(q,"zIndex",_)}),A()}}),W=R(()=>{if(n.size>0){const[C]=n,_=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;T(_+1)}}),Q=R(()=>{if(n.size>0){const[C]=n,_=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;T(_-1)}});return t?c.jsx(xe,{children:c.jsxs(Qt,{ref:b,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[c.jsx(ct,{onClick:()=>{D(),i()},children:d("contextMenu.refresh")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{g(),i()},isDisabled:!m,children:d("contextMenu.copy")}),c.jsx(ct,{onClick:()=>{S(),i()},isDisabled:!m,children:d("contextMenu.cut")}),c.jsx(ct,{onClick:()=>{a(),i()},children:d("contextMenu.paste")}),c.jsx(ct,{onClick:()=>{M(),i()},isDisabled:!m,children:d("contextMenu.delete")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{T(10),i()},isDisabled:!m,children:d("contextMenu.placeTop")}),c.jsx(ct,{onClick:()=>{T(-10),i()},isDisabled:!m,children:d("contextMenu.placeBottom")}),c.jsx(ct,{onClick:()=>{T(0),i()},isDisabled:!m,children:d("contextMenu.placeDefault")}),c.jsx(ct,{onClick:()=>{W(),i()},isDisabled:!m,children:d("contextMenu.placeUp")}),c.jsx(ct,{onClick:()=>{Q(),i()},isDisabled:!m,children:d("contextMenu.placeDown")})]})}):null},ct=({children:t,onClick:e,isDisabled:i=!1})=>c.jsx(Qt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),qe=N.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:d,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=O(A=>A.app),x=pe().colorMode==="light"?"#666464":"#D3D3D4",p=Wt(e,i,d,o),r=s?410*i/100:0,n=i>30?i>120?50:25:5,u=i/200,l={startX:H(p.xMin+r-n,n),endX:H(p.xMax+r+n,n),startY:H(p.yMin-n,n),endY:H(p.yMax+n,n)},f=Array.from({length:(l.endX-l.startX)/n+1},(A,g)=>{const S=l.startX+g*n,a=S%(n*5)===0?2*u:u;return c.jsx("line",{x1:S,y1:l.startY,x2:S,y2:l.endY,strokeWidth:a,stroke:x,opacity:"0.5"},"grid_vl_".concat(S))}),y=Array.from({length:(l.endY-l.startY)/n+1},(A,g)=>{const S=l.startY+g*n,a=S%(n*5)===0?2*u:u;return c.jsx("line",{x1:l.startX,y1:S,x2:l.endX,y2:S,strokeWidth:a,stroke:x,opacity:"0.5"},"grid_hl_".concat(S))}),m=Array.from({length:(l.endX-l.startX)/n/5+1},(A,g)=>{const S=H(l.startX,5*n)+g*5*n;return c.jsx("text",{x:S,y:p.yMin+i/5,fontSize:u*25,fill:x,textAnchor:"middle",opacity:"0.5",children:S},"grid_vc_".concat(S))}),b=Array.from({length:(l.endY-l.startY)/n/5+1},(A,g)=>{const S=H(l.startY,5*n)+g*5*n;return c.jsx("text",{x:p.xMin+i/8+r,y:S,fontSize:u*25,fill:x,textAnchor:"start",opacity:"0.5",children:S},"grid_hc_".concat(S))});return c.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,y,m,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Ge=He.component,Ut=Bt.generatePath,Zt=oe.component,jt=10,Je=()=>{var X;const t=St(),e=()=>{t(wt(window.graph.export())),t(ht()),t(ft())},{telemetry:{project:i},preference:{autoParallel:d}}=O(z=>z.app),{selected:o,theme:s,count:{mostFrequentStationType:w}}=O(z=>z.runtime),x=de(),p=o.keys().next().value;if(!p.startsWith("stn")&&!p.startsWith("misc_node")||!window.graph.hasNode(p))return;const r=window.graph.neighbors(p);if(r.length===0)return;const n=window.graph.getNodeAttributes(p),u=r.reduce((z,B)=>{const F=window.graph.getNodeAttributes(B);return{x:z.x+F.x,y:z.y+F.y}},{x:0,y:0}),l={x:u.x/r.length,y:u.y/r.length},f={x:n.x-l.x,y:n.y-l.y},y={x:n.x+f.x,y:n.y+f.y},m=Math.sign(f.x)===Math.sign(f.y),b={x:y.x-jt,y:y.y+jt*(m?1:-1)},A={x:y.x+jt,y:y.y+jt*(m?-1:1)},g=p.startsWith("stn_")?window.graph.getNodeAttribute(p,"type"):w,S=yt[g].component,a={visible:!0,zIndex:0,x:A.x,y:A.y,type:g,[g]:yt[g].defaultAttrs},M=window.graph.reduceEdges(p,(z,B)=>{const F=window.graph.getEdgeAttributes(B),{style:ut}=F;if(ut===Ct.SingleColor){const it=JSON.stringify(F[ut].color);it in z?z[it]+=1:z[it]=1}return z},{}),D=(X=Object.entries(M).filter(([z,B])=>B%2!==0).reduce((z,[B,F])=>F>z.count?{color:JSON.parse(B),count:F}:z,{color:null,count:0}).color)!=null?X:s,T=f.x>0?!(f.x>Math.abs(f.y)):-f.x>Math.abs(f.y),W=T?"from":"to",Q=Ut(n.x,b.x,n.y,b.y,{...Bt.defaultAttrs,startFrom:W}),C=T?"to":"from",_=Ut(n.x,A.x,n.y,A.y,{...Bt.defaultAttrs,startFrom:C}),q=async(z,B)=>{B.stopPropagation();const{x:F,y:ut}=dt(B);t(Rt({x:F,y:ut}));const it=vt(10),at=ve.has(z),E=at?"stn_".concat(it):"misc_node_".concat(it),L=structuredClone({...yt,...kt}[z].defaultAttrs);re.has(z)&&(L.color=s),at&&(L.names=await x(z)),window.graph.addNode(E,{visible:!0,zIndex:0,x:at?A.x:b.x,y:at?A.y:b.y,type:z,[z]:L}),i&&At.event(Pt.ADD_STATION,{type:z});const K=nt.Diagonal,tt="line_".concat(vt(10)),[G,U]=[p,E],Y=d?0:-1,J=at?C:W;window.graph.addDirectedEdgeWithKey(tt,G,U,{visible:!0,zIndex:0,type:K,[K]:{...structuredClone(et[K].defaultAttrs),startFrom:J},style:Ct.SingleColor,[Ct.SingleColor]:{color:D},reconcileId:"",parallelIndex:Y}),i&&At.event(Pt.ADD_LINE,{type:K}),e(),t(Mt(E)),t(mt(new Set([E])))};return c.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[c.jsx(Zt,{id:"line_prediction_1",type:nt.Diagonal,path:Q,styleAttrs:{color:D},newLine:!0,handlePointerDown:()=>{}}),c.jsx(Zt,{id:"line_prediction_2",type:nt.Diagonal,path:_,styleAttrs:{color:D},newLine:!0,handlePointerDown:()=>{}}),c.jsx(Ge,{id:"misc_node_virtual_prediction_1",attrs:{},x:b.x,y:b.y,handlePointerDown:(z,B)=>{q(rt.Virtual,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),c.jsx(S,{id:"stn_virtual_prediction_2",attrs:a,x:A.x,y:A.y,handlePointerDown:(z,B)=>{q(w,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},ue=(t,e,i,d,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return qt(t,e,i,d,o)?{x1:e,y1:i,x2:d,y2:o,offset:s.offsetFrom}:void 0;const[w,x]=[s.offsetFrom,s.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let r=p,n=0;n<2;n++,r+=Math.PI){const[u,l,f,y]=[Math.sin(p)*w,Math.cos(p)*w,Math.sin(r)*x,Math.cos(r)*x];if(qt(t,e+u,i+l,d+f,o+y))return{x1:e+u,y1:i+l,x2:d+f,y2:o+y,offset:0}}},Qe=(t,e,i,d,o,s)=>t===i?{x1:t+5*s,y1:e,x2:i+5*s,y2:d,offset:o}:e===d?{x1:t,y1:e+5*s,x2:i,y2:d+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:i+5*Math.SQRT1_2*s,y2:d+5*Math.SQRT1_2*s,offset:o},qt=(t,e,i,d,o)=>!!((e===d||i===o)&&[nt.Diagonal,nt.Perpendicular].includes(t)||Math.abs((o-i)/(d-e))===1&&[nt.Diagonal,nt.RotatePerpendicular].includes(t)),tn=(t,e)=>{const i=[],d=[];return Object.values(e).forEach(o=>{var A;if(o.length===1){d.push(...o.map(g=>g.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(g=>t.getEdgeAttribute(g,"type")===s)){d.push(...o.map(g=>g.edge));return}const w=t.getEdgeAttribute(o.at(0),"style");if(!o.every(g=>t.getEdgeAttribute(g,"style")===w)){d.push(...o.map(g=>g.edge));return}const x={},p=new Set,r=new Set,n=Object.fromEntries(o.map(g=>{var M,D;const[S,a]=t.extremities(g);return x[S]=((M=x[S])!=null?M:0)+1,x[a]=((D=x[a])!=null?D:0)+1,p.add(S),r.add(a),[S,[g.edge,a]]})),u=Array.from(p).filter(g=>x[g]===1),l=Array.from(r).filter(g=>x[g]===1);if(u.length!==1||l.length!==1){d.push(...o.map(g=>g.edge));return}const f=u[0],y=l[0];if(f===y){d.push(...o.map(g=>g.edge));return}const m=[n[f][0]];let b=n[f][1];for(let g=1;g<o.length;g=g+1){const S=(A=n[b])==null?void 0:A.at(1);if(!S){d.push(...o.map(a=>a.edge));return}m.push(n[b][0]),b=S}if(b!==y||m.length!==o.length){d.push(...o.map(g=>g.edge));return}i.push(m)}),{allReconciledLines:i,danglingLines:d}},en=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var l,f,y;const[s,w]=t.extremities(o),x=t.getNodeAttributes(s),p=t.getNodeAttributes(w),{type:r}=t.getEdgeAttributes(o),n=(l=t.getEdgeAttribute(o,r))!=null?l:et[r].defaultAttrs,u=ue(r,x.x,x.y,p.x,p.y,n);if(u){const{x1:m,y1:b,x2:A,y2:g,offset:S}=u;return et[nt.Simple].generatePath(m,A,b,g,{offset:S})}return(y=(f=et[r])==null?void 0:f.generatePath(x.x,p.x,x.y,p.y,n))!=null?y:"M ".concat(x.x," ").concat(x.y," L ").concat(p.x," ").concat(p.y)});let d="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)d+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},nn=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),sn=t=>{const e={},i={},d=[],o={},s=[];for(const r of t.edgeEntries()){const[n,u,l,f]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],y=r.attributes[r.attributes.type],m=ue(r.attributes.type,n,u,l,f,y);i[r.edge]=m}for(const r of t.edgeEntries()){let n=i[r.edge];const{parallelIndex:u}=r.attributes;if(u>=0){const l=we(t,r.attributes.type,r.edge),f=i[l];if(!f){d.push(r);continue}if(u>0){const{x1:y,y1:m,x2:b,y2:A,offset:g}=f;n=Qe(y,m,b,A,g,u)}}if(r.attributes.reconcileId!==""){const l=r.attributes.reconcileId;l in o?o[l].push(r):o[l]=[r];continue}if(n){const l=r.edge,f=r.attributes,{x1:y,y1:m,x2:b,y2:A,offset:g}=n;e[l]={attr:f,path:et[nt.Simple].generatePath(y,b,m,A,{offset:g})};continue}s.push(r)}const w=new Set;for(;d.length;){const r=d.pop();if(w.has(r.edge))continue;const{parallel:n}=Se(t,r);if(!n.length)continue;n.forEach(l=>w.add(l.edge));const u=Ae(n);for(const l of n){const f=l.edge;e[f]={attr:l.attributes,path:u[f]}}}const{allReconciledLines:x,danglingLines:p}=tn(t,o);for(const r of x){const n=en(t,r);if(!n)continue;const u=r[0];e[u]={attr:t.getEdgeAttributes(u),path:n}}for(const r of p){const n=t.getEdgeAttributes(r),[u,l]=t.extremities(r),f=t.getNodeAttributes(u),y=t.getNodeAttributes(l);e[r]={attr:n,path:et[nt.Simple].generatePath(f.x,y.x,f.y,y.y,et[nt.Simple].defaultAttrs)}}for(const r of s){const n=r.edge,u=r.attributes.type,l=r.attributes,[f,y,m,b]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(u in et)){e[n]={attr:l,path:"M ".concat(f," ").concat(y," L ").concat(m," ").concat(b)};continue}e[n]={attr:l,path:et[u].generatePath(f,m,y,b,l[u])}}return Object.entries(e).map(([r,n])=>({id:r,type:"line",line:n}))},he=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Master&&e.getNodeAttributes(t)[rt.Master].nodeType==="Station",on=(t,e)=>{const i=[];return e.filter(d=>he(d,t)).forEach(d=>{const o=t.getNodeAttribute(d,"x"),s=t.getNodeAttribute(d,"y");i.push({a:1,b:0,c:-o,node:d,x:o,y:s}),i.push({a:0,b:1,c:-s,node:d,x:o,y:s}),i.push({a:1,b:-1,c:-o+s,node:d,x:o,y:s}),i.push({a:1,b:1,c:-o-s,node:d,x:o,y:s})}),i},fe=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),rn=(t,e,i,d)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(w=>d.includes(w.node)).forEach(w=>{const x=fe(w,t,e);x<o&&(o=x,s=w)}),{l:s,d:o}},an=(t,e,i,d,o)=>{const s=e.filter(r=>{const n=t.getNodeAttribute(r,"x"),u=t.getNodeAttribute(r,"y");return Math.abs(o.a*n+o.b*u+o.c)<=.01}),w=[(r,n,u,l)=>[(r+u)/2,(n+l)/2],(r,n,u,l)=>[2*r-u,2*n-l],(r,n,u,l)=>[2*u-r,2*l-n]];let x=1/0,p={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<s.length;r++){const n=s[r],u=t.getNodeAttribute(n,"x"),l=t.getNodeAttribute(n,"y");for(let f=r+1;f<s.length;f++){const y=s[f],m=t.getNodeAttribute(y,"x"),b=t.getNodeAttribute(y,"y");w.forEach(A=>{const[g,S]=A(u,l,m,b),a=Math.hypot(i-g,d-S);a<x&&(x=a,p={x:g,y:S,originalNodesPos:[{x:u,y:l},{x:m,y:b}]})})}}return{snapPoint:p,distance:x}},cn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=O(l=>l.param),d=l=>{const y=[{x:l.x,y:l.y},...l.originalNodesPos].sort((b,A)=>b.x===A.x?b.y-A.y:b.x-A.x),m=(y[1].y-y[0].y)/(y[1].x-y[0].x);if(Math.abs(m)<=.01)return{original:y,offset:y.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(m)>=1e10)return{original:y,offset:y.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const A=-1/m,g=10/Math.sqrt(A*A+1),S=10*A/Math.sqrt(A*A+1);return{original:y,offset:y.map(a=>({x:a.x+g,y:a.y+S})),rotate:-Math.atan(A)*(180/Math.PI)}}},{original:o,offset:s,rotate:w}=d(e),x=l=>{const f=Math.sqrt(3)/2*l,y="0,0",m="".concat(-l/2,",").concat(f),b="".concat(l/2,",").concat(f);return"".concat(y," ").concat(m," ").concat(b)},p=i/75,r=8*p,n="#FC8181",u="".concat(p*5," ").concat(p*2);return c.jsxs(c.Fragment,{children:[c.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("polygon",{points:x(r),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((w+270)%360,")"),fill:n}),c.jsx("polygon",{points:x(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((w+270)%360,")"),fill:n}),c.jsx("polygon",{points:x(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((w+90)%360,")"),fill:n}),c.jsx("polygon",{points:x(r),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((w+90)%360,")"),fill:n})]})},Gt=t=>{const{id:e,x:i,y:d,handlePointerDown:o,handlePointerMove:s,handlePointerUp:w}=t,x=N.useCallback(n=>o(e,n),[e,o]),p=N.useCallback(n=>s(e,n),[e,s]),r=N.useCallback(n=>w(e,n),[e,w]);return c.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(d-6.4,")scale(0.025)"),onPointerDown:x,onPointerMove:p,onPointerUp:r,style:{cursor:"move"},children:c.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ln=t=>{const{id:e,path:i,handlePointerDown:d}=t,o=N.useCallback(s=>d(e,s),[e,d]);return c.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},dn=N.memo(t=>{var p,r,n,u,l,f,y,m,b,A,g,S;const{elements:e,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o,handleEdgePointerDown:s}=t,w=Object.fromEntries(Array.from({length:21},(a,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const M=a.line.attr.type,D=a.line.attr.style,T=a.line.attr[D],W=(p=Lt[D])==null?void 0:p.preComponent;W&&w[a.line.attr.zIndex].pre.push(c.jsx(W,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const Q=(n=(r=Lt[D])==null?void 0:r.component)!=null?n:ln;w[a.line.attr.zIndex].main.push(c.jsx(Q,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},a.id));const C=(u=Lt[D])==null?void 0:u.postComponent;C&&w[a.line.attr.zIndex].post.push(c.jsx(C,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const M=a.station,D=M.type,T=(l=yt[D])==null?void 0:l.preComponent;T&&w[a.station.zIndex].pre.push(c.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const W=(y=(f=yt[D])==null?void 0:f.component)!=null?y:Gt;w[a.station.zIndex].main.push(c.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(m=yt[D])==null?void 0:m.postComponent;Q&&w[a.station.zIndex].post.push(c.jsx(Q,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const M=a.miscNode,D=M.type,T=(b=kt[D])==null?void 0:b.preComponent;T&&w[a.miscNode.zIndex].pre.push(c.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M[D],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const W=(g=(A=kt[D])==null?void 0:A.component)!=null?g:Gt;w[a.miscNode.zIndex].main.push(c.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M[D],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(S=kt[D])==null?void 0:S.postComponent;Q&&w[a.miscNode.zIndex].post.push(c.jsx(Q,{id:a.id,x:M.x,y:M.y,attrs:M[D],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,M)=>(M-10).toString()).map(a=>[...w[a].pre,...w[a].main,...w[a].post]).flat()},(t,e)=>t.elements===e.elements),un=[...Object.values(ke),rt.Virtual,rt.Master,rt.Fill,rt.LondonArrow,rt.ChongqingRTNumLineBadge2021,rt.ChongqingRTTextLineBadge2021,rt.ChengduRTLineBadge,rt.GzmtrLineBadge],hn=()=>{const t=St(),e=N.useRef(window.graph),i=()=>{t(wt(e.current.export())),t(ht()),t(ft())},{telemetry:{project:d},preference:{autoParallel:o,snapLines:s,autoChangeStationType:w}}=O(E=>E.app),{svgViewBoxZoom:x,svgViewBoxMin:p}=O(E=>E.param),{selected:r,pointerPosition:n,active:u,refresh:{nodes:l,edges:f},mode:y,keepLastPath:m,theme:b}=O(E=>E.runtime),A=_t(),{height:g,width:S}=zt(A),[a,M]=N.useState({dx:0,dy:0}),[D,T]=N.useState([]),[W,Q]=N.useState([]),[C,_]=N.useState([]);N.useEffect(()=>{if(!n||!s)return;const E=Wt(p,x,S,g),L=ce(e.current,...Object.values(E));Q(L),T(on(e.current,L))},[p,x,S,g,n]);const[q,X]=N.useState(void 0),z=R((E,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:K,y:tt}=dt(L);y==="select"&&t(xt("free")),_([]),X(void 0),t(Rt({x:K,y:tt})),t(Mt(E)),L.shiftKey?r.has(E)?t(Xt(E)):t(Vt(E)):r.has(E)||t(mt(new Set([E])))}),B=R((E,L)=>{const{x:K,y:tt}=dt(L);if(L.currentTarget.setPointerCapture(L.pointerId),y==="free"&&u===E){if(!L.altKey&&s){const G=e.current.getNodeAttribute(E,"x"),U=e.current.getNodeAttribute(E,"y"),Y=G-(n.x-K)*x/100,J=U-(n.y-tt)*x/100;let V=Y,st=J;if(he(E,e.current)){let v=C,P=q;if(v.length!==0&&(v=v.filter(k=>fe(k,Y,J)<=6)),P&&(v.length===0||Math.hypot(Y-P.x,J-P.y)>6)&&(P=void 0),!P&&v.length===1){const k=v[0],{snapPoint:I,distance:$}=an(e.current,W.filter(Z=>!r.has(Z)),Y,J,k);$<=3&&(P=I)}if(v.length===1&&!P||v.length===0){const{l:k,d:I}=rn(Y,J,D,W.filter(Z=>!r.has(Z)&&!v.some(ot=>ot.node===Z))),$=v.length===0||!v.some(Z=>Z.a===k.a&&Z.b===k.b);I<3&&v.length<2&&$&&v.push(k)}if(v.length===1)if(P)V=P.x,st=P.y;else{const k=v[0];if(k.a==0)st=-k.c/k.b;else if(k.b==0)V=-k.c/k.a;else{const I=-k.a/k.b,$=-k.c/k.b;st=I*V+$}}else if(v.length===2){const k=v[0],I=v[1],$=k.a*I.b-I.a*k.b;$!==0&&(V=-(k.c*I.b-I.c*k.b)/$,st=-(k.a*I.c-I.a*k.c)/$)}_(v),X(P)}const h=V-G,j=st-U;r.forEach(v=>{e.current.hasNode(v)&&e.current.updateNodeAttributes(v,P=>({...P,x:H(P.x+h,.01),y:H(P.y+j,.01)}))})}else _([]),X(void 0),r.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,U=>({...U,x:H(U.x-(n.x-K)*x/100,L.altKey?.01:5),y:H(U.y-(n.y-tt)*x/100,L.altKey?.01:5)}))});t(ht()),t(ft())}else y.startsWith("line")&&u&&M({dx:(n.x-K)*x/100,dy:(n.y-tt)*x/100})}),F=R((E,L)=>{var K,tt,G;if(L.currentTarget.releasePointerCapture(L.pointerId),y.startsWith("line")){m||t(xt("free"));const U=e.current.hasNode(u)&&un.includes(e.current.getNodeAttribute(u,"type")),Y=["stn_core_","virtual_circle_","misc_node_connectable_"],V=(G=(tt=(K=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:K.attributes)==null?void 0:tt.getNamedItem("id"))==null?void 0:G.value,st=Y.find(h=>V==null?void 0:V.startsWith(h));if(U&&st){const h=y.slice(5),j="line_".concat(vt(10)),[v,P]=[u,V.slice(st.length)];if(v!==P){const k=o?ie(e.current,h,v,P,"from"):-1;e.current.addDirectedEdgeWithKey(j,v,P,{visible:!0,zIndex:0,type:h,[h]:structuredClone(et[h].defaultAttrs),style:Ct.SingleColor,[Ct.SingleColor]:{color:b},reconcileId:"",parallelIndex:k}),w&&v.startsWith("stn")&&Dt(e.current,v),w&&P.startsWith("stn")&&Dt(e.current,P),t(mt(new Set([j]))),d&&At.event(Pt.ADD_LINE,{type:h}),t(wt(e.current.export())),t(ft())}}}else if(y==="free"&&u){const{x:U,y:Y}=dt(L);n.x-U===0&&n.y-Y===0||(t(wt(e.current.export())),t(ht()))}_([]),X(void 0),Rt(void 0),t(Mt(void 0))}),ut=R((E,L)=>{if(L.stopPropagation(),L.shiftKey||t(pt()),L.shiftKey&&r.has(E)?t(Xt(E)):t(Vt(E)),y.startsWith("station")||y.startsWith("misc-node-virtual")||y.startsWith("misc-node-master")){const K=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,tt=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=y.startsWith("station"),U=vt(10),Y=G?"stn_".concat(U):"misc_node_".concat(U),J=G?y.slice(8):y.slice(10),{x:V,y:st}=lt(K,tt,x,p),h=G?structuredClone(yt[J].defaultAttrs):structuredClone(kt[J].defaultAttrs);"color"in h&&(h.color=b),e.current.addNode(Y,{visible:!0,zIndex:0,x:H(V,5),y:H(st,5),type:J,[J]:h});const j=e.current.getEdgeAttributes(E),{zIndex:v,type:P,style:k}=j,I=j[P],$=j[k],[Z,ot]=e.current.extremities(E),gt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Z,Y,{visible:!0,zIndex:v,type:P,[P]:structuredClone(I),style:k,[k]:structuredClone($),reconcileId:"",parallelIndex:gt}),e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Y,ot,{visible:!0,zIndex:v,type:P,[P]:structuredClone(I),style:k,[k]:structuredClone($),reconcileId:"",parallelIndex:gt}),e.current.dropEdge(E),i(),d&&(At.event(Pt.ADD_STATION,{type:J}),At.event(Pt.ADD_LINE,{type:P})),t(xt("free")),t(mt(new Set([Y])))}}),it=N.useMemo(()=>[...sn(e.current),...nn(e.current)],[f,l]),at=oe.component;return c.jsxs(c.Fragment,{children:[c.jsx(dn,{elements:it,handlePointerDown:z,handlePointerMove:B,handlePointerUp:F,handleEdgePointerDown:ut}),y.startsWith("line")&&u&&u!=="background"&&c.jsx(at,{id:"line_create_in_progress___no_use",type:y.slice(5),path:et[y.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-a.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-a.dy,et[y.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}}),C.length!==0&&C.map(E=>c.jsx("path",{d:et[nt.Simple].generatePath(...Pe(E,Wt(p,x,S,g)),et[nt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:x/75},"snap_line_".concat(E.a,"_").concat(E.b,"_").concat(E.c,"_").concat(E.node))),q&&c.jsx(cn,{activeSnapPoint:q})]})},fn=()=>{const t=St(),{svgViewBoxZoom:e,svgViewBoxMin:i}=O(f=>f.param),{radialTouchMenu:d}=O(f=>f.runtime),o=N.useRef(window.graph),[s,w]=N.useState(0),x=_t(),{height:p,width:r}=zt(x),n=R(f=>{var y;if(f.touches.length==1){if(w(0),d.visible){t(Ft());return}const m=f.touches[0],b=(y=document.getElementById("canvas"))==null?void 0:y.getBoundingClientRect();if(!b)return;const A=m.clientX-b.left,g=m.clientY-b.top,S=lt(A,g,e,i),a=Me(o.current,S,t);[...a[It.STATION],...a[It.MISC_NODE],...a[It.LINE]].length>0?t(Ce({visible:!0,position:S,data:a})):(t(pt()),t(Ft()))}else if(f.touches.length==2){t(Mt(void 0));const[m,b]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];w(m*m+b*b)}}),u=R(f=>{if(f.touches.length==2&&s>0){const[y,m]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],b=y*y+m*m;let A=e;b-s<0&&e+10<=390?A=e+10:b-s>0&&e-10>=10&&(A=e-10),t(ae(A)),w(b);const g=f.currentTarget.getBoundingClientRect(),[S,a]=[(f.touches[0].clientX+f.touches[1].clientX)/2-g.left,(f.touches[0].clientY+f.touches[1].clientY)/2-g.top],[M,D]=[S/g.width,a/g.height];t(Et({x:i.x+S*e/100-r*A/100*M,y:i.y+a*e/100-p*A/100*D}))}}),l=R(f=>{w(0)});return c.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:p*e/100,fill:d.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:n,onTouchMove:u,onTouchEnd:l})},Jt=10,yn=()=>{const t=St(),e=N.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:d}=O(a=>a.param),{selected:o}=O(a=>a.runtime),s=_t(),{height:w,width:x}=zt(s),p=N.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),r=N.useCallback((a,M,D)=>{a.stopPropagation(),o.size>0&&(o.forEach(T=>{e.current.hasNode(T)&&(e.current.updateNodeAttribute(T,"x",W=>(W!=null?W:0)+M*Jt),e.current.updateNodeAttribute(T,"y",W=>(W!=null?W:0)+D*Jt))}),p())},[o,p]),n=N.useCallback(a=>r(a,0,-1),[r]),u=N.useCallback(a=>r(a,0,1),[r]),l=N.useCallback(a=>r(a,-1,0),[r]),f=N.useCallback(a=>r(a,1,0),[r]),y=N.useCallback(()=>{if(o.size>0){const a=Nt(e.current,o);navigator.clipboard.writeText(a)}},[o]),m=N.useCallback(()=>{o.size>0&&(t(pt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),p())},[o,t,p]),b=d.x+x*i/200,A=d.y+(w-100)*i/100,g=40,S=40;return c.jsxs("g",{transform:"translate(".concat(b,", ").concat(A,")scale(").concat(1.5*i/100,")"),children:[c.jsxs("g",{transform:"translate(0, -".concat(S,")"),children:[c.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:n}),c.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(0, ".concat(S,")"),children:[c.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),c.jsx(Ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", 0)"),children:[c.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),c.jsx(Ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", 0)"),children:[c.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),c.jsx(De,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:y}),c.jsx(_e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:m}),c.jsx(ze,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Sn=()=>{const t=St(),e=N.useRef(window.graph),i=N.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),{activeSubscriptions:d}=O(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:w,predictNextNode:x,autoParallel:p,autoChangeStationType:r}}=O(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:u}=O(h=>h.param),{selected:l,active:f,isDetailsOpen:y,mode:m,lastTool:b,keepLastPath:A,theme:g,count:{masters:S,lines:a}}=O(h=>h.runtime),M=_t(),{height:D,width:T}=zt(M),W=!d.RMP_CLOUD&&S+1>ee,Q=!p||p&&!d.RMP_CLOUD&&a+1>ne,C=de();Le();const[_,q]=N.useState({x:0,y:0}),[X,z]=N.useState({x:0,y:0}),[B,F]=N.useState({isOpen:!1,position:{x:0,y:0}}),[ut,it]=N.useState({x:0,y:0}),[at,E]=N.useState({x:0,y:0}),L=R(async h=>{B.isOpen&&F({isOpen:!1,position:{x:0,y:0}});const{x:j,y:v}=dt(h);if(m.startsWith("station")||m.startsWith("misc-node")){t(xt("free"));const P=vt(10),{x:k,y:I}=lt(j,v,n,u),$=m.startsWith("station"),Z=$?"stn_".concat(P):"misc_node_".concat(P),ot=$?m.slice(8):m.slice(10),gt=structuredClone({...yt,...kt}[ot].defaultAttrs);re.has(ot)&&(gt.color=g),$&&(gt.names=await C(ot)),e.current.addNode(Z,{visible:!0,zIndex:0,x:H(k,5),y:H(I,5),type:ot,[ot]:gt}),o&&At.event(Pt.ADD_STATION,{type:ot}),i(),t(mt(new Set([Z])))}else m==="free"||m.startsWith("line")?(m.startsWith("line")&&(t(xt("free")),A&&t(Xe(!1))),it({x:j,y:v}),E(u),h.shiftKey||(t(Mt("background")),t(pt()))):m==="select"&&(q(lt(j,v,n,u)),z(lt(j,v,n,u)))}),K=R(h=>{if(m==="select"){if(_.x!=0&&_.y!=0){const{x:j,y:v}=dt(h);z(lt(j,v,n,u))}}else if(f==="background"){const{x:j,y:v}=dt(h);t(Et({x:at.x+(ut.x-j)*n/100,y:at.y+(ut.y-v)*n/100}))}}),tt=R(h=>{if(m==="select"){const{x:j,y:v}=dt(h),{x:P,y:k}=lt(j,v,n,u),I=ce(e.current,_.x,_.y,P,k),$=Fe(e.current,new Set(I));t(mt(new Set([...h.shiftKey?l:[],...I,...$]))),t(xt("free")),q({x:0,y:0}),z({x:0,y:0})}f==="background"&&!h.shiftKey&&t(Mt(void 0))}),G=R(h=>{let j=n;h.deltaY>0&&n+10<400?j=n+10:h.deltaY<0&&n-10>0&&(j=n-10),t(ae(j));const{x:v,y:P}=dt(h),k=h.currentTarget.getBoundingClientRect(),[I,$]=[v/k.width,P/k.height];t(Et({x:u.x+v*n/100-T*j/100*I,y:u.y+P*n/100-D*j/100*$}))}),U=R(h=>{h.preventDefault(),dt(h),F({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),Y=R(()=>{F({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),J=R(async h=>{if(bt?h.key==="Backspace":h.key==="Delete")l.size>0&&(l.forEach(j=>{if(e.current.hasNode(j))e.current.dropNode(j);else if(e.current.hasEdge(j)){const[v,P]=e.current.extremities(j);e.current.dropEdge(j),r&&v.startsWith("stn")&&Dt(e.current,v),r&&P.startsWith("stn")&&Dt(e.current,P)}}),t(pt()),i());else if(h.key.startsWith("Arrow")){const v=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,P=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(Et(lt(100*v,100*P,n,u)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const v=(h.key==="j"?-1:h.key==="l"?1:0)*10,P=(h.key==="i"?-1:h.key==="k"?1:0)*10;l.size>0&&l.forEach(k=>{e.current.hasNode(k)&&(e.current.updateNodeAttribute(k,"x",I=>(I!=null?I:0)+v),e.current.updateNodeAttribute(k,"y",I=>(I!=null?I:0)+P),i())})}else if(h.key==="f"&&b)t(xt(b));else if(h.key==="z"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey))bt&&h.preventDefault(),t(Be()),t(ht()),t(ft());else if(h.key==="s")t(xt("select"));else if((h.key==="c"||h.key==="x")&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=Nt(e.current,l);navigator.clipboard.writeText(j),h.key==="x"&&(t(pt()),l.forEach(v=>{e.current.hasNode(v)?e.current.dropNode(v):e.current.hasEdge(v)&&e.current.dropEdge(v)}),i())}else if(h.key==="v"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=await navigator.clipboard.readText(),{x:v,y:P}=lt(T/2,D/2,n,u),{nodes:k,edges:I}=se(j,e.current,W,Q,H(v,5),H(P,5));i();const $=structuredClone(k);I.forEach(Z=>$.add(Z)),t(mt($))}else if(bt&&h.key==="z"&&h.metaKey&&h.shiftKey||!bt&&h.key==="y"&&h.ctrlKey)t(Re());else if(h.key==="c")t(Oe(!w));else if(h.key==="e"){const[j]=l;if(l.size===1&&e.current.hasEdge(j)){const v=e.current.getEdgeAttributes(j),{type:P}=v;if(P!==nt.Simple&&v[P]){const k=v[P],$=(k.startFrom||"from")==="from"?"to":"from";let Z=v.parallelIndex;if(p){const[gt,ye]=e.current.extremities(j);Z=ie(e.current,P,gt,ye,$)}const ot={...k,startFrom:$};e.current.mergeEdgeAttributes(j,{[P]:ot,parallelIndex:Z}),i()}}}}),[V,st]=N.useState({sx:0,sy:0,ex:0,ey:0});return N.useEffect(()=>{st({sx:_.x<=X.x?_.x:X.x,ex:_.x>X.x?_.x:X.x,sy:_.y<=X.y?_.y:X.y,ey:_.y>X.y?_.y:X.y})},[X.x,X.y]),c.jsxs(c.Fragment,{children:[c.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:D,width:T,viewBox:"".concat(u.x," ").concat(u.y," ").concat(T*n/100," ").concat(D*n/100),onPointerDown:L,onPointerMove:K,onPointerUp:tt,onWheel:G,onContextMenu:U,tabIndex:0,onKeyDown:J,children:[c.jsx("defs",{children:c.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[c.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),c.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&c.jsx(qe,{svgViewBoxMin:u,svgViewBoxZoom:n,svgWidth:T,svgHeight:D}),Yt()&&m==="free"&&c.jsx(fn,{}),x&&l.size===1&&m==="free"&&c.jsx(Je,{}),c.jsx(Ve.SvgAssetsContextProvider,{children:c.jsx(hn,{})}),m==="select"&&_.x!=0&&_.y!=0&&c.jsx("rect",{x:V.sx,y:V.sy,width:V.ex-V.sx,height:V.ey-V.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Yt()&&[...l].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&c.jsx(yn,{}),c.jsx(Te,{})]}),c.jsx(Ze,{isOpen:B.isOpen,position:B.position,onClose:Y}),Ie()&&y==="hide"&&c.jsx(me,{"aria-label":"open details panel",icon:c.jsx(We,{style:{transform:"rotate(180deg)"}}),onClick:()=>t($e()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Sn as default};

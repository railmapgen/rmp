import{a as be,j as u,P as ve,B as re,D as Yt,ae as we,a3 as Se}from"./chakra-BZH9ddpD.js";import{c as Mt,e as V,A as ie,aN as Ot,aO as Ae,ab as Ht,aG as ae,a8 as ce,w as Pt,x as gt,y as xt,aP as $t,z as bt,a1 as ft,aQ as le,aR as Z,a0 as vt,aS as Vt,t as kt,aT as Xt,aU as Pe,L as tt,p as rt,aV as yt,aW as Ft,n as At,aX as Me,d as de,r as Ct,E as Nt,q as nt,aY as Dt,aZ as ke,a_ as Ce,a$ as Ne,aK as jt,G as Wt,H as Bt,aJ as mt,b0 as Ut,b1 as Zt,aF as qt,F as ue,S as je,b2 as Gt,b3 as Ee,b4 as Rt,b5 as De,B as he,D as It,b6 as _e,b7 as ze,b8 as Le,b9 as Ie,ba as $e,bb as Te,bc as We,bd as Jt,be as Be,bf as Re,bg as Oe,bh as Ve,am as St,aB as Xe,aC as Fe,ad as Ke,a9 as Ye}from"./index-D02JJVEe.js";import{s as pt,v as He,b as Et,f as fe,e as Ue,g as Ze}from"./misc-nodes-Cha3-rp5.js";import{b as D,h as ye,u as qe}from"./react-CLIJjNOF.js";import{u as O}from"./useEvent-D-PagYbH.js";import{e as Tt}from"./change-types-D4BQj9mQ.js";const _t=5,Ge={[Ht.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ht.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Je=t=>{const e=Ge[t];return e.at(Math.floor(Math.random()*e.length))},Qt=ye("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:d})=>{const{token:o}=e().account;if(!o){i(Ot({cityName:t,names:[]}));return}const s=await fetch("".concat(Ae,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return ie.warn("Failed to fetch random station names",s.statusText),d(s.statusText);const b=await s.json();i(Ot({cityName:t,names:b}))}),te=ye("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var y;const{stationNames:d}=e().runtime,o=d[t];if(((y=o==null?void 0:o.length)!=null?y:0)==0)return ie.debug("No random station names in cache, using fallback"),i(Qt({cityName:t})),Object.values(Je(t));const s=structuredClone(o),b=s.shift();return i(Ot({cityName:t,names:s})),s.length<3&&i(Qt({cityName:t})),Object.values(b)}),ge=()=>{const t=Mt(),{activeSubscriptions:e}=V(o=>o.account),{preference:{randomStationsNames:i}}=V(o=>o.app),d=!e.RMP_CLOUD||i==="none";return D.useCallback(async o=>{const s=pt[o].defaultAttrs.names;if(!d){const b=await t(te(i));if(te.fulfilled.match(b)){const y=b.payload;return s.length>y.length?y.push(...Array(s.length-y.length).fill(y.at(-1))):s.length<y.length&&y.splice(s.length),y}}return structuredClone(s)},[t,d,i])},Qe=({isOpen:t,position:e,onClose:i})=>{const{t:d}=qe(),o=Mt(),s=D.useRef(window.graph),{activeSubscriptions:b}=V(k=>k.account),{preference:{autoParallel:y}}=V(k=>k.app),{svgViewBoxZoom:w,svgViewBoxMin:r}=V(k=>k.param),{selected:n,count:{masters:c,lines:l}}=V(k=>k.runtime),f=!b.RMP_CLOUD&&c+1>ae,x=!y||y&&!b.RMP_CLOUD&&l+1>ce,p=n.size>0,m=D.useRef(null);be({ref:m,handler:i,enabled:t});const S=D.useCallback(()=>{o(Pt(s.current.export())),o(gt()),o(xt())},[o]),g=O(()=>{if(n.size>0){const k=$t(s.current,n);navigator.clipboard.writeText(k)}}),v=O(()=>{if(n.size>0){const k=$t(s.current,n);navigator.clipboard.writeText(k),o(bt()),n.forEach(L=>{s.current.hasNode(L)?s.current.dropNode(L):s.current.hasEdge(L)&&s.current.dropEdge(L)}),S()}}),a=O(async()=>{try{const k=await navigator.clipboard.readText(),{x:L,y:G}=ft(e.x,e.y,w,r),{nodes:F,edges:it}=le(k,s.current,f,x,Z(L,5),Z(G,5));S();const at=structuredClone(F);it.forEach(ct=>at.add(ct)),o(vt(at))}catch(k){console.warn("Failed to read clipboard:",k)}}),M=O(()=>{n.size>0&&(o(bt()),n.forEach(k=>{s.current.hasNode(k)?s.current.dropNode(k):s.current.hasEdge(k)&&s.current.dropEdge(k)}),S())}),C=O(()=>{o(gt()),o(xt())}),W=O(k=>{if(n.size>0){const L=Math.min(Math.max(k,-10),10);n.forEach(G=>{s.current.hasNode(G)&&s.current.setNodeAttribute(G,"zIndex",L),s.current.hasEdge(G)&&s.current.setEdgeAttribute(G,"zIndex",L)}),S()}}),B=O(()=>{if(n.size>0){const[k]=n,L=s.current.hasNode(k)?s.current.getNodeAttribute(k,"zIndex"):s.current.hasEdge(k)?s.current.getEdgeAttribute(k,"zIndex"):0;W(L+1)}}),Q=O(()=>{if(n.size>0){const[k]=n,L=s.current.hasNode(k)?s.current.getNodeAttribute(k,"zIndex"):s.current.hasEdge(k)?s.current.getEdgeAttribute(k,"zIndex"):0;W(L-1)}});return t?u.jsx(ve,{children:u.jsxs(re,{ref:m,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[u.jsx(ht,{onClick:()=>{C(),i()},children:d("contextMenu.refresh")}),u.jsx(Yt,{}),u.jsx(ht,{onClick:()=>{g(),i()},isDisabled:!p,children:d("contextMenu.copy")}),u.jsx(ht,{onClick:()=>{v(),i()},isDisabled:!p,children:d("contextMenu.cut")}),u.jsx(ht,{onClick:()=>{a(),i()},children:d("contextMenu.paste")}),u.jsx(ht,{onClick:()=>{M(),i()},isDisabled:!p,children:d("contextMenu.delete")}),u.jsx(Yt,{}),u.jsx(ht,{onClick:()=>{W(10),i()},isDisabled:!p,children:d("contextMenu.placeTop")}),u.jsx(ht,{onClick:()=>{W(-10),i()},isDisabled:!p,children:d("contextMenu.placeBottom")}),u.jsx(ht,{onClick:()=>{W(0),i()},isDisabled:!p,children:d("contextMenu.placeDefault")}),u.jsx(ht,{onClick:()=>{B(),i()},isDisabled:!p,children:d("contextMenu.placeUp")}),u.jsx(ht,{onClick:()=>{Q(),i()},isDisabled:!p,children:d("contextMenu.placeDown")})]})}):null},ht=({children:t,onClick:e,isDisabled:i=!1})=>u.jsx(re,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),tn=D.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:d,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=V(S=>S.app),y=we().colorMode==="light"?"#666464":"#D3D3D4",w=Vt(e,i,d,o),r=s?410*i/100:0,n=i>30?i>120?50:25:5,c=i/200,l={startX:Z(w.xMin+r-n,n),endX:Z(w.xMax+r+n,n),startY:Z(w.yMin-n,n),endY:Z(w.yMax+n,n)},f=Array.from({length:(l.endX-l.startX)/n+1},(S,g)=>{const v=l.startX+g*n,a=v%(n*5)===0?2*c:c;return u.jsx("line",{x1:v,y1:l.startY,x2:v,y2:l.endY,strokeWidth:a,stroke:y,opacity:"0.5"},"grid_vl_".concat(v))}),x=Array.from({length:(l.endY-l.startY)/n+1},(S,g)=>{const v=l.startY+g*n,a=v%(n*5)===0?2*c:c;return u.jsx("line",{x1:l.startX,y1:v,x2:l.endX,y2:v,strokeWidth:a,stroke:y,opacity:"0.5"},"grid_hl_".concat(v))}),p=Array.from({length:(l.endX-l.startX)/n/5+1},(S,g)=>{const v=Z(l.startX,5*n)+g*5*n;return u.jsx("text",{x:v,y:w.yMin+i/5,fontSize:c*25,fill:y,textAnchor:"middle",opacity:"0.5",children:v},"grid_vc_".concat(v))}),m=Array.from({length:(l.endY-l.startY)/n/5+1},(S,g)=>{const v=Z(l.startY,5*n)+g*5*n;return u.jsx("text",{x:w.xMin+i/8+r,y:v,fontSize:c*25,fill:y,textAnchor:"start",opacity:"0.5",children:v},"grid_hc_".concat(v))});return u.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,x,p,m]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),en=He.component,ee=Xt.generatePath,ne=Pe.component,Lt=10,nn=()=>{var wt;const t=Mt(),e=()=>{t(Pt(window.graph.export())),t(gt()),t(xt())},{activeSubscriptions:i}=V(I=>I.account),{telemetry:{project:d},preference:{autoParallel:o,randomStationsNames:s}}=V(I=>I.app),{selected:b,theme:y,count:{mostFrequentStationType:w},lastTool:r}=V(I=>I.runtime),n=ge(),c=b.keys().next().value;if(!c.startsWith("stn")&&!c.startsWith("misc_node")||!window.graph.hasNode(c))return;const l=window.graph.neighbors(c);if(l.length===0)return;const f=window.graph.getNodeAttributes(c),x=l.reduce((I,K)=>{const et=window.graph.getNodeAttributes(K);return{x:I.x+et.x,y:I.y+et.y}},{x:0,y:0}),p={x:x.x/l.length,y:x.y/l.length},m={x:f.x-p.x,y:f.y-p.y},S={x:f.x+m.x,y:f.y+m.y},g=Math.sign(m.x)===Math.sign(m.y),v={x:S.x-Lt,y:S.y+Lt*(g?1:-1)},a={x:S.x+Lt,y:S.y+Lt*(g?-1:1)},M=c.startsWith("stn_"),C=M?window.graph.getNodeAttribute(c,"type"):r!=null&&r.startsWith("station-")?r.slice(8):w,W=pt[C].component,B={visible:!0,zIndex:0,x:a.x,y:a.y,type:C,[C]:pt[C].defaultAttrs};if(M){const I=structuredClone(window.graph.getNodeAttribute(c,C));Object.assign(B,{[C]:I})}const Q=window.graph.reduceEdges(c,(I,K)=>{const et=window.graph.getEdgeAttributes(K),{style:lt}=et;if(lt===kt.SingleColor){const ot=JSON.stringify(et[lt].color);ot in I?I[ot]+=1:I[ot]=1}return I},{}),k=(wt=Object.entries(Q).filter(([I,K])=>K%2!==0).reduce((I,[K,et])=>et>I.count?{color:JSON.parse(K),count:et}:I,{color:null,count:0}).color)!=null?wt:y,L=m.x>0?!(m.x>Math.abs(m.y)):-m.x>Math.abs(m.y),G=L?"from":"to",F=ee(f.x,v.x,f.y,v.y,{...Xt.defaultAttrs,startFrom:G}),it=L?"to":"from",at=ee(f.x,a.x,f.y,a.y,{...Xt.defaultAttrs,startFrom:it}),ct=async(I,K)=>{K.stopPropagation();const{x:et,y:lt}=yt(K);t(Ft({x:et,y:lt}));const ot=At(10),dt=Me.has(I),ut=dt?"stn_".concat(ot):"misc_node_".concat(ot),j=structuredClone(dt&&I===window.graph.getNodeAttribute(c,"type")?window.graph.getNodeAttribute(c,I):{...pt,...Et}[I].defaultAttrs);de.has(I)&&(j.color=y);const $=!i.RMP_CLOUD||s==="none";dt&&!$&&(j.names=await n(I)),window.graph.addNode(ut,{visible:!0,zIndex:0,x:dt?a.x:v.x,y:dt?a.y:v.y,type:I,[I]:j}),d&&Ct.event(Nt.ADD_STATION,{type:I});const q=tt.Diagonal,Y="line_".concat(At(10)),[J,h]=[c,ut],A=o?0:-1,P=dt?it:G;window.graph.addDirectedEdgeWithKey(Y,J,h,{visible:!0,zIndex:0,type:q,[q]:{...structuredClone(nt[q].defaultAttrs),startFrom:P},style:kt.SingleColor,[kt.SingleColor]:{color:k},reconcileId:"",parallelIndex:A}),d&&Ct.event(Nt.ADD_LINE,{type:q}),e(),t(Dt(ut)),t(vt(new Set([ut])))};return u.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[u.jsx(ne,{id:"line_prediction_1",type:tt.Diagonal,path:F,styleAttrs:{color:k},newLine:!0,handlePointerDown:()=>{}}),u.jsx(ne,{id:"line_prediction_2",type:tt.Diagonal,path:at,styleAttrs:{color:k},newLine:!0,handlePointerDown:()=>{}}),u.jsx(en,{id:"misc_node_virtual_prediction_1",attrs:{},x:v.x,y:v.y,handlePointerDown:(I,K)=>{ct(rt.Virtual,K)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),u.jsx(W,{id:"stn_virtual_prediction_2",attrs:B,x:a.x,y:a.y,handlePointerDown:(I,K)=>{ct(C,K)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},xe=(t,e,i,d,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return se(t,e,i,d,o)?{x1:e,y1:i,x2:d,y2:o,offset:s.offsetFrom}:void 0;const[b,y]=[s.offsetFrom,s.offsetTo];for(let w=0;w<Math.PI;w+=Math.PI/8)for(let r=w,n=0;n<2;n++,r+=Math.PI){const[c,l,f,x]=[Math.sin(w)*b,Math.cos(w)*b,Math.sin(r)*y,Math.cos(r)*y];if(se(t,e+c,i+l,d+f,o+x))return{x1:e+c,y1:i+l,x2:d+f,y2:o+x,offset:0}}},sn=(t,e,i,d,o,s)=>t===i?{x1:t+5*s,y1:e,x2:i+5*s,y2:d,offset:o}:e===d?{x1:t,y1:e+5*s,x2:i,y2:d+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:i+5*Math.SQRT1_2*s,y2:d+5*Math.SQRT1_2*s,offset:o},se=(t,e,i,d,o)=>!!((e===d||i===o)&&[tt.Diagonal,tt.Perpendicular].includes(t)||Math.abs((o-i)/(d-e))===1&&[tt.Diagonal,tt.RotatePerpendicular].includes(t)),on=(t,e)=>{const i=[],d=[];return Object.values(e).forEach(o=>{var S;if(o.length===1){d.push(...o.map(g=>g.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(g=>t.getEdgeAttribute(g,"type")===s)){d.push(...o.map(g=>g.edge));return}const b=t.getEdgeAttribute(o.at(0),"style");if(!o.every(g=>t.getEdgeAttribute(g,"style")===b)){d.push(...o.map(g=>g.edge));return}const y={},w=new Set,r=new Set,n=Object.fromEntries(o.map(g=>{var M,C;const[v,a]=t.extremities(g);return y[v]=((M=y[v])!=null?M:0)+1,y[a]=((C=y[a])!=null?C:0)+1,w.add(v),r.add(a),[v,[g.edge,a]]})),c=Array.from(w).filter(g=>y[g]===1),l=Array.from(r).filter(g=>y[g]===1);if(c.length!==1||l.length!==1){d.push(...o.map(g=>g.edge));return}const f=c[0],x=l[0];if(f===x){d.push(...o.map(g=>g.edge));return}const p=[n[f][0]];let m=n[f][1];for(let g=1;g<o.length;g=g+1){const v=(S=n[m])==null?void 0:S.at(1);if(!v){d.push(...o.map(a=>a.edge));return}p.push(n[m][0]),m=v}if(m!==x||p.length!==o.length){d.push(...o.map(g=>g.edge));return}i.push(p)}),{allReconciledLines:i,danglingLines:d}},rn=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var l,f,x;const[s,b]=t.extremities(o),y=t.getNodeAttributes(s),w=t.getNodeAttributes(b),{type:r}=t.getEdgeAttributes(o),n=(l=t.getEdgeAttribute(o,r))!=null?l:nt[r].defaultAttrs,c=xe(r,y.x,y.y,w.x,w.y,n);if(c){const{x1:p,y1:m,x2:S,y2:g,offset:v}=c;return nt[tt.Simple].generatePath(p,S,m,g,{offset:v})}return(x=(f=nt[r])==null?void 0:f.generatePath(y.x,w.x,y.y,w.y,n))!=null?x:"M ".concat(y.x," ").concat(y.y," L ").concat(w.x," ").concat(w.y)});let d="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)d+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},an=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),cn=t=>{const e={},i={},d=[],o={},s=[];for(const r of t.edgeEntries()){const[n,c,l,f]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],x=r.attributes[r.attributes.type],p=xe(r.attributes.type,n,c,l,f,x);i[r.edge]=p}for(const r of t.edgeEntries()){let n=i[r.edge];const{parallelIndex:c}=r.attributes;if(c>=0){const l=ke(t,r.attributes.type,r.edge),f=i[l];if(!f){d.push(r);continue}if(c>0){const{x1:x,y1:p,x2:m,y2:S,offset:g}=f;n=sn(x,p,m,S,g,c)}}if(r.attributes.reconcileId!==""){const l=r.attributes.reconcileId;l in o?o[l].push(r):o[l]=[r];continue}if(n){const l=r.edge,f=r.attributes,{x1:x,y1:p,x2:m,y2:S,offset:g}=n;e[l]={attr:f,path:nt[tt.Simple].generatePath(x,m,p,S,{offset:g})};continue}s.push(r)}const b=new Set;for(;d.length;){const r=d.pop();if(b.has(r.edge))continue;const{parallel:n}=Ce(t,r);if(!n.length)continue;n.forEach(l=>b.add(l.edge));const c=Ne(n);for(const l of n){const f=l.edge;e[f]={attr:l.attributes,path:c[f]}}}const{allReconciledLines:y,danglingLines:w}=on(t,o);for(const r of y){const n=rn(t,r);if(!n)continue;const c=r[0];e[c]={attr:t.getEdgeAttributes(c),path:n}}for(const r of w){const n=t.getEdgeAttributes(r),[c,l]=t.extremities(r),f=t.getNodeAttributes(c),x=t.getNodeAttributes(l);e[r]={attr:n,path:nt[tt.Simple].generatePath(f.x,x.x,f.y,x.y,nt[tt.Simple].defaultAttrs)}}for(const r of s){const n=r.edge,c=r.attributes.type,l=r.attributes,[f,x,p,m]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(c in nt)){e[n]={attr:l,path:"M ".concat(f," ").concat(x," L ").concat(p," ").concat(m)};continue}e[n]={attr:l,path:nt[c].generatePath(f,p,x,m,l[c])}}return Object.entries(e).map(([r,n])=>({id:r,type:"line",line:n}))},pe=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Master&&e.getNodeAttributes(t)[rt.Master].nodeType==="Station",ln=(t,e)=>{const i=[];return e.filter(d=>pe(d,t)).forEach(d=>{const o=t.getNodeAttribute(d,"x"),s=t.getNodeAttribute(d,"y");i.push({a:1,b:0,c:-o,node:d,x:o,y:s}),i.push({a:0,b:1,c:-s,node:d,x:o,y:s}),i.push({a:1,b:-1,c:-o+s,node:d,x:o,y:s}),i.push({a:1,b:1,c:-o-s,node:d,x:o,y:s})}),i},me=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),dn=(t,e,i,d)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(b=>d.includes(b.node)).forEach(b=>{const y=me(b,t,e);y<o&&(o=y,s=b)}),{l:s,d:o}},un=(t,e,i,d,o)=>{const s=e.filter(r=>{const n=t.getNodeAttribute(r,"x"),c=t.getNodeAttribute(r,"y");return Math.abs(o.a*n+o.b*c+o.c)<=.01}),b=[(r,n,c,l)=>[(r+c)/2,(n+l)/2],(r,n,c,l)=>[2*r-c,2*n-l],(r,n,c,l)=>[2*c-r,2*l-n]];let y=1/0,w={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<s.length;r++){const n=s[r],c=t.getNodeAttribute(n,"x"),l=t.getNodeAttribute(n,"y");for(let f=r+1;f<s.length;f++){const x=s[f],p=t.getNodeAttribute(x,"x"),m=t.getNodeAttribute(x,"y");b.forEach(S=>{const[g,v]=S(c,l,p,m),a=Math.hypot(i-g,d-v);a<y&&(y=a,w={x:g,y:v,originalNodesPos:[{x:c,y:l},{x:p,y:m}]})})}}return{snapPoint:w,distance:y}},hn=(t,e)=>{const{xMin:i,yMin:d,xMax:o,yMax:s}=e;if(t.a===0)return[i,o,-t.c/t.b,-t.c/t.b];if(t.b===0)return[-t.c/t.a,-t.c/t.a,d,s];{const b=-t.a/t.b,y=-t.c/t.b;return[i,o,b*i+y,b*o+y]}},fn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=V(l=>l.param),d=l=>{const x=[{x:l.x,y:l.y},...l.originalNodesPos].sort((m,S)=>m.x===S.x?m.y-S.y:m.x-S.x),p=(x[1].y-x[0].y)/(x[1].x-x[0].x);if(Math.abs(p)<=.01)return{original:x,offset:x.map(m=>({x:m.x,y:m.y+10})),rotate:0};if(Math.abs(p)>=1e10)return{original:x,offset:x.map(m=>({x:m.x+10,y:m.y})),rotate:90};{const S=-1/p,g=10/Math.sqrt(S*S+1),v=10*S/Math.sqrt(S*S+1);return{original:x,offset:x.map(a=>({x:a.x+g,y:a.y+v})),rotate:-Math.atan(S)*(180/Math.PI)}}},{original:o,offset:s,rotate:b}=d(e),y=l=>{const f=Math.sqrt(3)/2*l,x="0,0",p="".concat(-l/2,",").concat(f),m="".concat(l/2,",").concat(f);return"".concat(x," ").concat(p," ").concat(m)},w=i/75,r=8*w,n="#FC8181",c="".concat(w*5," ").concat(w*2);return u.jsxs(u.Fragment,{children:[u.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:w,strokeDasharray:c}),u.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:w,strokeDasharray:c}),u.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:n,strokeWidth:w,strokeDasharray:c}),u.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:w,strokeDasharray:c}),u.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:w,strokeDasharray:c}),u.jsx("polygon",{points:y(r),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((b+270)%360,")"),fill:n}),u.jsx("polygon",{points:y(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((b+270)%360,")"),fill:n}),u.jsx("polygon",{points:y(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((b+90)%360,")"),fill:n}),u.jsx("polygon",{points:y(r),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((b+90)%360,")"),fill:n})]})},oe=t=>{const{id:e,x:i,y:d,handlePointerDown:o,handlePointerMove:s,handlePointerUp:b}=t,y=D.useCallback(n=>o(e,n),[e,o]),w=D.useCallback(n=>s(e,n),[e,s]),r=D.useCallback(n=>b(e,n),[e,b]);return u.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(d-6.4,")scale(0.025)"),onPointerDown:y,onPointerMove:w,onPointerUp:r,style:{cursor:"move"},children:u.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},yn=t=>{const{id:e,path:i,handlePointerDown:d}=t,o=D.useCallback(s=>d(e,s),[e,d]);return u.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},gn=D.memo(t=>{var w,r,n,c,l,f,x,p,m,S,g,v;const{elements:e,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o,handleEdgePointerDown:s}=t,b=Object.fromEntries(Array.from({length:21},(a,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const M=a.line.attr.type,C=a.line.attr.style,W=a.line.attr[C],B=(w=jt[C])==null?void 0:w.preComponent;B&&b[a.line.attr.zIndex].pre.push(u.jsx(B,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const Q=(n=(r=jt[C])==null?void 0:r.component)!=null?n:yn;b[a.line.attr.zIndex].main.push(u.jsx(Q,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},a.id));const k=(c=jt[C])==null?void 0:c.postComponent;k&&b[a.line.attr.zIndex].post.push(u.jsx(k,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const M=a.station,C=M.type,W=(l=pt[C])==null?void 0:l.preComponent;W&&b[a.station.zIndex].pre.push(u.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const B=(x=(f=pt[C])==null?void 0:f.component)!=null?x:oe;b[a.station.zIndex].main.push(u.jsx(B,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(p=pt[C])==null?void 0:p.postComponent;Q&&b[a.station.zIndex].post.push(u.jsx(Q,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const M=a.miscNode,C=M.type,W=(m=Et[C])==null?void 0:m.preComponent;W&&b[a.miscNode.zIndex].pre.push(u.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M[C],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const B=(g=(S=Et[C])==null?void 0:S.component)!=null?g:oe;b[a.miscNode.zIndex].main.push(u.jsx(B,{id:a.id,x:M.x,y:M.y,attrs:M[C],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(v=Et[C])==null?void 0:v.postComponent;Q&&b[a.miscNode.zIndex].post.push(u.jsx(Q,{id:a.id,x:M.x,y:M.y,attrs:M[C],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,M)=>(M-10).toString()).map(a=>[...b[a].pre,...b[a].main,...b[a].post]).flat()},(t,e)=>t.elements===e.elements),xn=[...Object.values(je),rt.Virtual,rt.Master,rt.Fill,rt.LondonArrow,rt.ChongqingRTNumLineBadge2021,rt.ChongqingRTTextLineBadge2021,rt.ChengduRTLineBadge,rt.GzmtrLineBadge],pn=()=>{const t=Mt(),e=D.useRef(window.graph),i=()=>{t(Pt(e.current.export())),t(gt()),t(xt())},{telemetry:{project:d},preference:{autoParallel:o,snapLines:s,autoChangeStationType:b}}=V(j=>j.app),{svgViewBoxZoom:y,svgViewBoxMin:w}=V(j=>j.param),{selected:r,pointerPosition:n,active:c,refresh:{nodes:l,edges:f},mode:x,keepLastPath:p,theme:m}=V(j=>j.runtime),S=Wt(),{height:g,width:v}=Bt(S),[a,M]=D.useState({dx:0,dy:0}),[C,W]=D.useState([]),[B,Q]=D.useState([]),[k,L]=D.useState([]);D.useEffect(()=>{if(!n||!s)return;const j=Vt(w,y,v,g),$=fe(e.current,...Object.values(j));Q($),W(ln(e.current,$))},[w,y,v,g,n]);const[G,F]=D.useState(void 0),it=O((j,$)=>{$.stopPropagation(),$.currentTarget.setPointerCapture($.pointerId);const{x:q,y:Y}=yt($);x==="select"&&t(mt("free")),L([]),F(void 0),t(Ft({x:q,y:Y})),t(Dt(j)),$.shiftKey?r.has(j)?t(Ut(j)):t(Zt(j)):r.has(j)||t(vt(new Set([j])))}),at=O((j,$)=>{const{x:q,y:Y}=yt($);if($.currentTarget.setPointerCapture($.pointerId),x==="free"&&c===j){if(!$.altKey&&s){const J=e.current.getNodeAttribute(j,"x"),h=e.current.getNodeAttribute(j,"y"),A=J-(n.x-q)*y/100,P=h-(n.y-Y)*y/100;let _=A,T=P;if(pe(j,e.current)){let E=k,z=G;if(E.length!==0&&(E=E.filter(N=>me(N,A,P)<=6)),z&&(E.length===0||Math.hypot(A-z.x,P-z.y)>6)&&(z=void 0),!z&&E.length===1){const N=E[0],{snapPoint:R,distance:U}=un(e.current,B.filter(st=>!r.has(st)),A,P,N);U<=3&&(z=R)}if(E.length===1&&!z||E.length===0){const{l:N,d:R}=dn(A,P,C,B.filter(st=>!r.has(st)&&!E.some(zt=>zt.node===st))),U=E.length===0||!E.some(st=>st.a===N.a&&st.b===N.b);R<3&&E.length<2&&U&&E.push(N)}if(E.length===1)if(z)_=z.x,T=z.y;else{const N=E[0];if(N.a==0)T=-N.c/N.b;else if(N.b==0)_=-N.c/N.a;else{const R=-N.a/N.b,U=-N.c/N.b;T=R*_+U}}else if(E.length===2){const N=E[0],R=E[1],U=N.a*R.b-R.a*N.b;U!==0&&(_=-(N.c*R.b-R.c*N.b)/U,T=-(N.a*R.c-R.a*N.c)/U)}L(E),F(z)}const H=_-J,X=T-h;r.forEach(E=>{e.current.hasNode(E)&&e.current.updateNodeAttributes(E,z=>({...z,x:Z(z.x+H,.01),y:Z(z.y+X,.01)}))})}else L([]),F(void 0),r.forEach(J=>{e.current.hasNode(J)&&e.current.updateNodeAttributes(J,h=>({...h,x:Z(h.x-(n.x-q)*y/100,$.altKey?.01:_t),y:Z(h.y-(n.y-Y)*y/100,$.altKey?.01:_t)}))});t(gt()),t(xt())}else x.startsWith("line")&&c&&M({dx:(n.x-q)*y/100,dy:(n.y-Y)*y/100})}),ct=O((j,$)=>{var q,Y,J;if($.currentTarget.releasePointerCapture($.pointerId),x.startsWith("line")){p||t(mt("free"));const h=e.current.hasNode(c)&&xn.includes(e.current.getNodeAttribute(c,"type")),A=["stn_core_","virtual_circle_","misc_node_connectable_"],_=(J=(Y=(q=document.elementsFromPoint($.clientX,$.clientY).at(0))==null?void 0:q.attributes)==null?void 0:Y.getNamedItem("id"))==null?void 0:J.value,T=A.find(H=>_==null?void 0:_.startsWith(H));if(h&&T){const{path:H,style:X}=qt(x),[E,z]=[H,X],N="line_".concat(At(10)),[R,U]=[c,_.slice(T.length)];if(R!==U){const st=structuredClone(jt[z].defaultAttrs);"color"in st&&z!==kt.River&&(st.color=m);const zt=o?ue(e.current,E,R,U,"from"):-1;e.current.addDirectedEdgeWithKey(N,R,U,{visible:!0,zIndex:0,type:E,[E]:structuredClone(nt[E].defaultAttrs),style:z,[z]:st,reconcileId:"",parallelIndex:zt}),b&&R.startsWith("stn")&&Tt(e.current,R),b&&U.startsWith("stn")&&Tt(e.current,U),t(vt(new Set([N]))),d&&Ct.event(Nt.ADD_LINE,{type:E}),t(Pt(e.current.export())),t(xt())}}}else if(x==="free"&&c){const{x:h,y:A}=yt($);n.x-h===0&&n.y-A===0||(t(Pt(e.current.export())),t(gt()))}L([]),F(void 0),Ft(void 0),t(Dt(void 0))}),wt=O((j,$)=>{if($.stopPropagation(),$.shiftKey||t(bt()),$.shiftKey&&r.has(j)?t(Ut(j)):t(Zt(j)),x.startsWith("station")||x.startsWith("misc-node-virtual")||x.startsWith("misc-node-master")){const q=$.clientX-document.getElementById("canvas").getBoundingClientRect().left,Y=$.clientY-document.getElementById("canvas").getBoundingClientRect().top,J=x.startsWith("station"),h=At(10),A=J?"stn_".concat(h):"misc_node_".concat(h),P=J?x.slice(8):x.slice(10),{x:_,y:T}=ft(q,Y,y,w),H=J?structuredClone(pt[P].defaultAttrs):structuredClone(Et[P].defaultAttrs);"color"in H&&(H.color=m),e.current.addNode(A,{visible:!0,zIndex:0,x:Z(_,5),y:Z(T,5),type:P,[P]:H});const X=e.current.getEdgeAttributes(j),{zIndex:E,type:z,style:N}=X,R=X[z],U=X[N],[st,zt]=e.current.extremities(j),Kt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(At(10)),st,A,{visible:!0,zIndex:E,type:z,[z]:structuredClone(R),style:N,[N]:structuredClone(U),reconcileId:"",parallelIndex:Kt}),e.current.addDirectedEdgeWithKey("line_".concat(At(10)),A,zt,{visible:!0,zIndex:E,type:z,[z]:structuredClone(R),style:N,[N]:structuredClone(U),reconcileId:"",parallelIndex:Kt}),e.current.dropEdge(j),i(),d&&(Ct.event(Nt.ADD_STATION,{type:P}),Ct.event(Nt.ADD_LINE,{type:z})),t(mt("free")),t(vt(new Set([A])))}}),I=D.useMemo(()=>[...cn(e.current),...an(e.current)],[f,l]),{path:K,style:et}=qt(x),lt=K||tt.Diagonal,ot=et||kt.SingleColor,dt=jt[ot].component,ut=structuredClone(jt[ot].defaultAttrs);return"color"in ut&&ot!==kt.River&&(ut.color=m),u.jsxs(u.Fragment,{children:[u.jsx(gn,{elements:I,handlePointerDown:it,handlePointerMove:at,handlePointerUp:ct,handleEdgePointerDown:wt}),x.startsWith("line")&&c&&c!=="background"&&u.jsx(dt,{id:"line_create_in_progress___no_use",type:lt,path:nt[lt].generatePath(e.current.getNodeAttribute(c,"x"),e.current.getNodeAttribute(c,"x")-a.dx,e.current.getNodeAttribute(c,"y"),e.current.getNodeAttribute(c,"y")-a.dy,nt[lt].defaultAttrs),styleAttrs:ut,newLine:!0,handlePointerDown:()=>{}}),k.length!==0&&k.map(j=>u.jsx("path",{d:nt[tt.Simple].generatePath(...hn(j,Vt(w,y,v,g)),nt[tt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:y/75},"snap_line_".concat(j.a,"_").concat(j.b,"_").concat(j.c,"_").concat(j.node))),G&&u.jsx(fn,{activeSnapPoint:G})]})},mn=()=>{const t=Mt(),{svgViewBoxZoom:e,svgViewBoxMin:i}=V(f=>f.param),{radialTouchMenu:d}=V(f=>f.runtime),o=D.useRef(window.graph),[s,b]=D.useState(0),y=Wt(),{height:w,width:r}=Bt(y),n=O(f=>{var x;if(f.touches.length==1){if(b(0),d.visible){t(Gt());return}const p=f.touches[0],m=(x=document.getElementById("canvas"))==null?void 0:x.getBoundingClientRect();if(!m)return;const S=p.clientX-m.left,g=p.clientY-m.top,v=ft(S,g,e,i),a=Ee(o.current,v,t);[...a[Rt.STATION],...a[Rt.MISC_NODE],...a[Rt.LINE]].length>0?t(De({visible:!0,position:v,data:a})):(t(bt()),t(Gt()))}else if(f.touches.length==2){t(Dt(void 0));const[p,m]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];b(p*p+m*m)}}),c=O(f=>{if(f.touches.length==2&&s>0){const[x,p]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],m=x*x+p*p;let S=e;m-s<0&&e+10<=390?S=e+10:m-s>0&&e-10>=10&&(S=e-10),t(he(S)),b(m);const g=f.currentTarget.getBoundingClientRect(),[v,a]=[(f.touches[0].clientX+f.touches[1].clientX)/2-g.left,(f.touches[0].clientY+f.touches[1].clientY)/2-g.top],[M,C]=[v/g.width,a/g.height];t(It({x:i.x+v*e/100-r*S/100*M,y:i.y+a*e/100-w*S/100*C}))}}),l=O(f=>{b(0)});return u.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:w*e/100,fill:d.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:n,onTouchMove:c,onTouchEnd:l})},bn=()=>{const t=Mt(),e=D.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:d}=V(a=>a.param),{selected:o}=V(a=>a.runtime),s=Wt(),{height:b,width:y}=Bt(s),w=D.useCallback(()=>{t(Pt(e.current.export())),t(gt()),t(xt())},[t]),r=D.useCallback((a,M,C)=>{a.stopPropagation(),o.size>0&&(o.forEach(W=>{e.current.hasNode(W)&&(e.current.updateNodeAttribute(W,"x",B=>(B!=null?B:0)+M*_t),e.current.updateNodeAttribute(W,"y",B=>(B!=null?B:0)+C*_t))}),w())},[o,w]),n=D.useCallback(a=>r(a,0,-1),[r]),c=D.useCallback(a=>r(a,0,1),[r]),l=D.useCallback(a=>r(a,-1,0),[r]),f=D.useCallback(a=>r(a,1,0),[r]),x=D.useCallback(()=>{if(o.size>0){const a=$t(e.current,o);navigator.clipboard.writeText(a)}},[o]),p=D.useCallback(()=>{o.size>0&&(t(bt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),w())},[o,t,w]),m=d.x+y*i/200,S=d.y+(b-100)*i/100,g=40,v=40;return u.jsxs("g",{transform:"translate(".concat(m,", ").concat(S,")scale(").concat(1.5*i/100,")"),children:[u.jsxs("g",{transform:"translate(0, -".concat(v,")"),children:[u.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:n}),u.jsx(_e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(0, ".concat(v,")"),children:[u.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:c}),u.jsx(ze,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(v,", 0)"),children:[u.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),u.jsx(Le,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(v,", 0)"),children:[u.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),u.jsx(Ie,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(v,", ").concat(v,")"),children:[u.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:x}),u.jsx($e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(v,", ").concat(v,")"),children:[u.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:p}),u.jsx(Te,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},kn=()=>{const t=Mt(),e=D.useRef(window.graph),i=D.useCallback(()=>{t(Pt(e.current.export())),t(gt()),t(xt())},[t]),{activeSubscriptions:d}=V(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:b,predictNextNode:y,autoParallel:w,autoChangeStationType:r}}=V(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:c}=V(h=>h.param),{selected:l,active:f,isDetailsOpen:x,mode:p,lastTool:m,keepLastPath:S,theme:g,count:{masters:v,lines:a}}=V(h=>h.runtime),M=Wt(),{height:C,width:W}=Bt(M),B=!d.RMP_CLOUD&&v+1>ae,Q=!w||w&&!d.RMP_CLOUD&&a+1>ce,k=ge();We();const[L,G]=D.useState({x:0,y:0}),[F,it]=D.useState({x:0,y:0}),[at,ct]=D.useState({isOpen:!1,position:{x:0,y:0}}),[wt,I]=D.useState({x:0,y:0}),[K,et]=D.useState({x:0,y:0}),lt=O(async h=>{at.isOpen&&ct({isOpen:!1,position:{x:0,y:0}});const{x:A,y:P}=yt(h);if(p.startsWith("station")||p.startsWith("misc-node")){t(mt("free"));const _=At(10),{x:T,y:H}=ft(A,P,n,c),X=p.startsWith("station"),E=X?"stn_".concat(_):"misc_node_".concat(_),z=X?p.slice(8):p.slice(10),N=structuredClone({...pt,...Et}[z].defaultAttrs);de.has(z)&&(N.color=g),X&&(N.names=await k(z)),e.current.addNode(E,{visible:!0,zIndex:0,x:Z(T,5),y:Z(H,5),type:z,[z]:N}),o&&Ct.event(Nt.ADD_STATION,{type:z}),i(),t(vt(new Set([E])))}else p==="free"||p.startsWith("line")?(p.startsWith("line")&&(t(mt("free")),S&&t(Ye(!1))),I({x:A,y:P}),et(c),h.shiftKey||(t(Dt("background")),t(bt()))):p==="select"&&(G(ft(A,P,n,c)),it(ft(A,P,n,c)))}),ot=O(h=>{if(p==="select"){if(L.x!=0&&L.y!=0){const{x:A,y:P}=yt(h);it(ft(A,P,n,c))}}else if(f==="background"){const{x:A,y:P}=yt(h);t(It({x:K.x+(wt.x-A)*n/100,y:K.y+(wt.y-P)*n/100}))}}),dt=O(h=>{if(p==="select"){const{x:A,y:P}=yt(h),{x:_,y:T}=ft(A,P,n,c),H=fe(e.current,L.x,L.y,_,T),X=Ze(e.current,new Set(H));t(vt(new Set([...h.shiftKey?l:[],...H,...X]))),t(mt("free")),G({x:0,y:0}),it({x:0,y:0})}f==="background"&&!h.shiftKey&&t(Dt(void 0))}),ut=O(h=>{let A=n;h.deltaY>0&&n+10<400?A=n+10:h.deltaY<0&&n-10>0&&(A=n-10),t(he(A));const{x:P,y:_}=yt(h),T=h.currentTarget.getBoundingClientRect(),[H,X]=[P/T.width,_/T.height];t(It({x:c.x+P*n/100-W*A/100*H,y:c.y+_*n/100-C*A/100*X}))}),j=O(h=>{h.preventDefault(),yt(h),ct({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),$=O(()=>{ct({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),q=O(async h=>{if(St?h.key==="Backspace":h.key==="Delete")l.size>0&&(l.forEach(A=>{if(e.current.hasNode(A))e.current.dropNode(A);else if(e.current.hasEdge(A)){const[P,_]=e.current.extremities(A);e.current.dropEdge(A),r&&P.startsWith("stn")&&Tt(e.current,P),r&&_.startsWith("stn")&&Tt(e.current,_)}}),t(bt()),i());else if(h.key.startsWith("Arrow")){const P=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,_=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(It(ft(100*P,100*_,n,c)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const A=(h.key==="j"?-1:h.key==="l"?1:0)*_t,P=(h.key==="i"?-1:h.key==="k"?1:0)*_t;l.size>0&&l.forEach(_=>{e.current.hasNode(_)&&(e.current.updateNodeAttribute(_,"x",T=>(T!=null?T:0)+A),e.current.updateNodeAttribute(_,"y",T=>(T!=null?T:0)+P),i())})}else if(h.key==="f"&&m)t(mt(m));else if(h.key==="z"&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey))St&&h.preventDefault(),t(Xe()),t(gt()),t(xt());else if(h.key==="s")t(mt("select"));else if((h.key==="c"||h.key==="x")&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey)){const A=$t(e.current,l);navigator.clipboard.writeText(A),h.key==="x"&&(t(bt()),l.forEach(P=>{e.current.hasNode(P)?e.current.dropNode(P):e.current.hasEdge(P)&&e.current.dropEdge(P)}),i())}else if(h.key==="v"&&(St?h.metaKey&&!h.shiftKey:h.ctrlKey)){const A=await navigator.clipboard.readText(),{x:P,y:_}=ft(W/2,C/2,n,c),{nodes:T,edges:H}=le(A,e.current,B,Q,Z(P,5),Z(_,5));i();const X=structuredClone(T);H.forEach(E=>X.add(E)),t(vt(X))}else if(St&&h.key==="z"&&h.metaKey&&h.shiftKey||!St&&h.key==="y"&&h.ctrlKey)t(Fe());else if(h.key==="c")t(Ke(!b));else if(h.key==="e"){const[A]=l;if(l.size===1&&e.current.hasEdge(A)){const P=e.current.getEdgeAttributes(A),{type:_}=P;if(_!==tt.Simple&&P[_]){const T=P[_],X=(T.startFrom||"from")==="from"?"to":"from";let E=P.parallelIndex;if(w){const[N,R]=e.current.extremities(A);E=ue(e.current,_,N,R,X)}const z={...T,startFrom:X};e.current.mergeEdgeAttributes(A,{[_]:z,parallelIndex:E}),i()}}}}),[Y,J]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{J({sx:L.x<=F.x?L.x:F.x,ex:L.x>F.x?L.x:F.x,sy:L.y<=F.y?L.y:F.y,ey:L.y>F.y?L.y:F.y})},[F.x,F.y]),u.jsxs(u.Fragment,{children:[u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:C,width:W,viewBox:"".concat(c.x," ").concat(c.y," ").concat(W*n/100," ").concat(C*n/100),onPointerDown:lt,onPointerMove:ot,onPointerUp:dt,onWheel:ut,onContextMenu:j,tabIndex:0,onKeyDown:q,children:[u.jsx("defs",{children:u.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[u.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),u.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&u.jsx(tn,{svgViewBoxMin:c,svgViewBoxZoom:n,svgWidth:W,svgHeight:C}),Jt()&&p==="free"&&u.jsx(mn,{}),y&&l.size===1&&p==="free"&&u.jsx(nn,{}),u.jsx(Ue.SvgAssetsContextProvider,{children:u.jsx(pn,{})}),p==="select"&&L.x!=0&&L.y!=0&&u.jsx("rect",{x:Y.sx,y:Y.sy,width:Y.ex-Y.sx,height:Y.ey-Y.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Jt()&&[...l].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&u.jsx(bn,{}),u.jsx(Be,{})]}),u.jsx(Qe,{isOpen:at.isOpen,position:at.position,onClose:$}),Re()&&x==="hide"&&u.jsx(Se,{"aria-label":"open details panel",icon:u.jsx(Ve,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(Oe()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{kn as default};

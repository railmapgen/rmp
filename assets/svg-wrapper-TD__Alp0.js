import{ad as te,j as m}from"./chakra-CSR0Uih-.js";import{c as _t,e as J,a4 as Nt,x as Vt,au as Lt,av as ee,o as wt,aw as jt,ax as Ot,L as Q,ay as lt,az as Dt,n as yt,aA as ne,d as Yt,r as gt,E as pt,m as Ft,p as Z,aB as xt,V as ft,t as bt,v as mt,w as St,aC as se,aD as oe,aE as re,aF as Mt,q as Ut,aG as ut,aH as $t,aI as It,B as kt,S as ie,aJ as ae,a1 as ce,aK as le,F as Pt,ar as de,as as ue,a6 as he,D as Tt,a2 as ye}from"./index-DrvbLxbz.js";import{s as at,b as Et,r as Y,e as it,g as qt,f as Gt,h as fe,j as ge,k as pe,l as xe,n as me,p as dt,o as Se,q as ve,i as ht,t as we}from"./master-manager-hGCjmF-j.js";import{b as T,k as Zt}from"./react-eFT_xHYJ.js";import{u as tt,e as be,i as Pe}from"./clipboard-CqFmkCzQ.js";import{v as Ae,m as vt}from"./misc-nodes-BqJUGiXx.js";const ke={[Nt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Nt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},_e=t=>{const e=ke[t];return e.at(Math.floor(Math.random()*e.length))},Wt=Zt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:d,rejectWithValue:y})=>{const{token:r}=e().account;if(!r){d(Lt({cityName:t,names:[]}));return}const i=await fetch("".concat(ee,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!i.ok)return Vt.warn("Failed to fetch random station names",i.statusText),y(i.statusText);const w=await i.json();d(Lt({cityName:t,names:w}))}),Bt=Zt("runtime/getOneStationName",async(t,{getState:e,dispatch:d})=>{var f;const{stationNames:y}=e().runtime,r=y[t];if(((f=r==null?void 0:r.length)!=null?f:0)==0)return Vt.debug("No random station names in cache, using fallback"),d(Wt({cityName:t})),Object.values(_e(t));const i=structuredClone(r),w=i.shift();return d(Lt({cityName:t,names:i})),i.length<3&&d(Wt({cityName:t})),Object.values(w)}),Jt=()=>{const t=_t(),{activeSubscriptions:e}=J(r=>r.account),{preference:{randomStationsNames:d}}=J(r=>r.app),y=!e.RMP_CLOUD||d==="none";return T.useCallback(async r=>{const i=at[r].defaultAttrs.names;if(!y){const w=await t(Bt(Nt.Shmetro));if(Bt.fulfilled.match(w)){const f=w.payload;return i.length>f.length?f.push(...Array(i.length-f.length).fill(f.at(-1))):i.length<f.length&&f.splice(i.length),f}}return structuredClone(i)},[t,y])},Ce=T.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:d,svgWidth:y,svgHeight:r}=t,{preference:{toolsPanel:{expand:i}}}=J(_=>_.app),f=te().colorMode==="light"?"#666464":"#D3D3D4",a=Et(e,d,y,r),s=i?410*d/100:0,n=d>30?d>120?50:25:5,h=d/200,l={startX:Y(a.xMin+s-n,n),endX:Y(a.xMax+s+n,n),startY:Y(a.yMin-n,n),endY:Y(a.yMax+n,n)},p=Array.from({length:(l.endX-l.startX)/n+1},(_,g)=>{const b=l.startX+g*n,c=b%(n*5)===0?2*h:h;return m.jsx("line",{x1:b,y1:l.startY,x2:b,y2:l.endY,strokeWidth:c,stroke:f,opacity:"0.5"},"grid_vl_".concat(b))}),u=Array.from({length:(l.endY-l.startY)/n+1},(_,g)=>{const b=l.startY+g*n,c=b%(n*5)===0?2*h:h;return m.jsx("line",{x1:l.startX,y1:b,x2:l.endX,y2:b,strokeWidth:c,stroke:f,opacity:"0.5"},"grid_hl_".concat(b))}),L=Array.from({length:(l.endX-l.startX)/n/5+1},(_,g)=>{const b=Y(l.startX,5*n)+g*5*n;return m.jsx("text",{x:b,y:a.yMin+d/5,fontSize:h*25,fill:f,textAnchor:"middle",opacity:"0.5",children:b},"grid_vc_".concat(b))}),P=Array.from({length:(l.endY-l.startY)/n/5+1},(_,g)=>{const b=Y(l.startY,5*n)+g*5*n;return m.jsx("text",{x:a.xMin+d/8+s,y:b,fontSize:h*25,fill:f,textAnchor:"start",opacity:"0.5",children:b},"grid_hc_".concat(b))});return m.jsxs("g",{id:"grid-lines",className:"removeMe",children:[p,u,L,P]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Me=Ae.component,Ht=jt.generatePath,Rt=Ot.component,At=10,Ne=()=>{var ot;const t=_t(),e=()=>{t(bt(window.graph.export())),t(mt()),t(St())},{telemetry:{project:d},preference:{autoParallel:y}}=J(j=>j.app),{selected:r,theme:i,count:{mostFrequentStationType:w}}=J(j=>j.runtime),f=Jt(),a=r.keys().next().value;if(!a.startsWith("stn")&&!a.startsWith("misc_node")||!window.graph.hasNode(a))return;const s=window.graph.neighbors(a);if(s.length===0)return;const n=window.graph.getNodeAttributes(a),h=s.reduce((j,R)=>{const q=window.graph.getNodeAttributes(R);return{x:j.x+q.x,y:j.y+q.y}},{x:0,y:0}),l={x:h.x/s.length,y:h.y/s.length},p={x:n.x-l.x,y:n.y-l.y},u={x:n.x+p.x,y:n.y+p.y},L=Math.sign(p.x)===Math.sign(p.y),P={x:u.x-At,y:u.y+At*(L?1:-1)},_={x:u.x+At,y:u.y+At*(L?-1:1)},g=a.startsWith("stn_")?window.graph.getNodeAttribute(a,"type"):w,b=at[g].component,c={visible:!0,zIndex:0,x:_.x,y:_.y,type:g,[g]:at[g].defaultAttrs},M=window.graph.reduceEdges(a,(j,R)=>{const q=window.graph.getEdgeAttributes(R),{style:ct}=q;if(ct===wt.SingleColor){const nt=JSON.stringify(q[ct].color);nt in j?j[nt]+=1:j[nt]=1}return j},{}),E=(ot=Object.entries(M).filter(([j,R])=>R%2!==0).reduce((j,[R,q])=>q>j.count?{color:JSON.parse(R),count:q}:j,{color:null,count:0}).color)!=null?ot:i,V=p.x>0?!(p.x>Math.abs(p.y)):-p.x>Math.abs(p.y),D=V?"from":"to",U=Ht(n.x,P.x,n.y,P.y,{...jt.defaultAttrs,startFrom:D}),B=V?"to":"from",et=Ht(n.x,_.x,n.y,_.y,{...jt.defaultAttrs,startFrom:B}),st=async(j,R)=>{R.stopPropagation();const{x:q,y:ct}=it(R);t(Dt({x:q,y:ct}));const nt=yt(10),rt=ne.has(j),C=rt?"stn_".concat(nt):"misc_node_".concat(nt),N=structuredClone({...at,...vt}[j].defaultAttrs);Yt.has(j)&&(N.color=i),rt&&(N.names=await f(j)),window.graph.addNode(C,{visible:!0,zIndex:0,x:rt?_.x:P.x,y:rt?_.y:P.y,type:j,[j]:N}),d&&gt.event(pt.ADD_STATION,{type:j});const H=Q.Diagonal,G="line_".concat(yt(10)),[K,X]=[a,C],$=y?Ft(window.graph,H,K,X,"from"):-1,O=rt?B:D;window.graph.addDirectedEdgeWithKey(G,K,X,{visible:!0,zIndex:0,type:H,[H]:{...structuredClone(Z[H].defaultAttrs),startFrom:O},style:wt.SingleColor,[wt.SingleColor]:{color:E},reconcileId:"",parallelIndex:$}),d&&gt.event(pt.ADD_LINE,{type:H}),e(),t(xt(C)),t(ft(new Set([C])))};return m.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[m.jsx(Rt,{id:"line_prediction_1",type:Q.Diagonal,path:U,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),m.jsx(Rt,{id:"line_prediction_2",type:Q.Diagonal,path:et,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),m.jsx(Me,{id:"misc_node_virtual_prediction_1",attrs:{},x:P.x,y:P.y,handlePointerDown:(j,R)=>{st(lt.Virtual,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),m.jsx(b,{id:"stn_virtual_prediction_2",attrs:c,x:_.x,y:_.y,handlePointerDown:(j,R)=>{st(w,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Qt=(t,e,d,y,r,i)=>{if(!("offsetFrom"in i)||!("offsetTo"in i)||Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return Xt(t,e,d,y,r)?{x1:e,y1:d,x2:y,y2:r,offset:i.offsetFrom}:void 0;const[w,f]=[i.offsetFrom,i.offsetTo];for(let a=0;a<Math.PI;a+=Math.PI/8)for(let s=a,n=0;n<2;n++,s+=Math.PI){const[h,l,p,u]=[Math.sin(a)*w,Math.cos(a)*w,Math.sin(s)*f,Math.cos(s)*f];if(Xt(t,e+h,d+l,y+p,r+u))return{x1:e+h,y1:d+l,x2:y+p,y2:r+u,offset:0}}},Le=(t,e,d,y,r,i)=>t===d?{x1:t+5*i,y1:e,x2:d+5*i,y2:y,offset:r}:e===y?{x1:t,y1:e+5*i,x2:d,y2:y+5*i,offset:r}:{x1:t+5*Math.SQRT1_2*i,y1:e+5*Math.SQRT1_2*i,x2:d+5*Math.SQRT1_2*i,y2:y+5*Math.SQRT1_2*i,offset:r},Xt=(t,e,d,y,r)=>!!((e===y||d===r)&&[Q.Diagonal,Q.Perpendicular].includes(t)||Math.abs((r-d)/(y-e))===1&&[Q.Diagonal,Q.RotatePerpendicular].includes(t)),je=(t,e)=>{const d=[],y=[];return Object.values(e).forEach(r=>{var _;if(r.length===1){y.push(...r.map(g=>g.edge));return}const i=t.getEdgeAttribute(r.at(0),"type");if(!r.every(g=>t.getEdgeAttribute(g,"type")===i)){y.push(...r.map(g=>g.edge));return}const w=t.getEdgeAttribute(r.at(0),"style");if(!r.every(g=>t.getEdgeAttribute(g,"style")===w)){y.push(...r.map(g=>g.edge));return}const f={},a=new Set,s=new Set,n=Object.fromEntries(r.map(g=>{var M,E;const[b,c]=t.extremities(g);return f[b]=((M=f[b])!=null?M:0)+1,f[c]=((E=f[c])!=null?E:0)+1,a.add(b),s.add(c),[b,[g.edge,c]]})),h=Array.from(a).filter(g=>f[g]===1),l=Array.from(s).filter(g=>f[g]===1);if(h.length!==1||l.length!==1){y.push(...r.map(g=>g.edge));return}const p=h[0],u=l[0];if(p===u){y.push(...r.map(g=>g.edge));return}const L=[n[p][0]];let P=n[p][1];for(let g=1;g<r.length;g=g+1){const b=(_=n[P])==null?void 0:_.at(1);if(!b){y.push(...r.map(c=>c.edge));return}L.push(n[P][0]),P=b}if(P!==u||L.length!==r.length){y.push(...r.map(g=>g.edge));return}d.push(L)}),{allReconciledLines:d,danglingLines:y}},De=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const d=e.map(r=>{var l,p,u;const[i,w]=t.extremities(r),f=t.getNodeAttributes(i),a=t.getNodeAttributes(w),{type:s}=t.getEdgeAttributes(r),n=(l=t.getEdgeAttribute(r,s))!=null?l:Z[s].defaultAttrs,h=Qt(s,f.x,f.y,a.x,a.y,n);if(h){const{x1:L,y1:P,x2:_,y2:g,offset:b}=h;return Z[Q.Simple].generatePath(L,_,P,g,{offset:b})}return(u=(p=Z[s])==null?void 0:p.generatePath(f.x,a.x,f.y,a.y,n))!=null?u:"M ".concat(f.x," ").concat(f.y," L ").concat(a.x," ").concat(a.y)});let y="".concat(d[0]," ");for(let r=1;r<e.length;r=r+1)y+=d[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return y},Ee=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ze=t=>{const e={},d={},y=[],r={},i=[];for(const s of t.edgeEntries()){const[n,h,l,p]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],u=s.attributes[s.attributes.type],L=Qt(s.attributes.type,n,h,l,p,u);d[s.edge]=L}for(const s of t.edgeEntries()){let n=d[s.edge];const{parallelIndex:h}=s.attributes;if(h>=0){const l=se(t,s.attributes.type,s.edge),p=d[l];if(!p){y.push(s);continue}if(h>0){const{x1:u,y1:L,x2:P,y2:_,offset:g}=p;n=Le(u,L,P,_,g,h)}}if(s.attributes.reconcileId!==""){const l=s.attributes.reconcileId;l in r?r[l].push(s):r[l]=[s];continue}if(n){const l=s.edge,p=s.attributes,{x1:u,y1:L,x2:P,y2:_,offset:g}=n;e[l]={attr:p,path:Z[Q.Simple].generatePath(u,P,L,_,{offset:g})};continue}i.push(s)}const w=new Set;for(;y.length;){const s=y.pop();if(w.has(s.edge))continue;const{parallel:n}=oe(t,s);if(!n.length)continue;n.forEach(l=>w.add(l.edge));const h=re(n);for(const l of n){const p=l.edge;e[p]={attr:l.attributes,path:h[p]}}}const{allReconciledLines:f,danglingLines:a}=je(t,r);for(const s of f){const n=De(t,s);if(!n)continue;const h=s[0];e[h]={attr:t.getEdgeAttributes(h),path:n}}for(const s of a){const n=t.getEdgeAttributes(s),[h,l]=t.extremities(s),p=t.getNodeAttributes(h),u=t.getNodeAttributes(l);e[s]={attr:n,path:Z[Q.Simple].generatePath(p.x,u.x,p.y,u.y,Z[Q.Simple].defaultAttrs)}}for(const s of i){const n=s.edge,h=s.attributes.type,l=s.attributes,[p,u,L,P]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(h in Z)){e[n]={attr:l,path:"M ".concat(p," ").concat(u," L ").concat(L," ").concat(P)};continue}e[n]={attr:l,path:Z[h].generatePath(p,L,u,P,l[h])}}return Object.entries(e).map(([s,n])=>({id:s,type:"line",line:n}))},$e=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:d}=J(l=>l.param),y=l=>{const u=[{x:l.x,y:l.y},...l.originalNodesPos].sort((P,_)=>P.x===_.x?P.y-_.y:P.x-_.x),L=(u[1].y-u[0].y)/(u[1].x-u[0].x);if(Math.abs(L)<=.01)return{original:u,offset:u.map(P=>({x:P.x,y:P.y+10})),rotate:0};if(Math.abs(L)>=1e10)return{original:u,offset:u.map(P=>({x:P.x+10,y:P.y})),rotate:90};{const _=-1/L,g=10/Math.sqrt(_*_+1),b=10*_/Math.sqrt(_*_+1);return{original:u,offset:u.map(c=>({x:c.x+g,y:c.y+b})),rotate:-Math.atan(_)*(180/Math.PI)}}},{original:r,offset:i,rotate:w}=y(e),f=l=>{const p=Math.sqrt(3)/2*l,u="0,0",L="".concat(-l/2,",").concat(p),P="".concat(l/2,",").concat(p);return"".concat(u," ").concat(L," ").concat(P)},a=d/75,s=8*a,n="#FC8181",h="".concat(a*5," ").concat(a*2);return m.jsxs(m.Fragment,{children:[m.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,stroke:n,strokeWidth:a,strokeDasharray:h}),m.jsx("line",{x1:i[1].x,y1:i[1].y,x2:i[2].x,y2:i[2].y,stroke:n,strokeWidth:a,strokeDasharray:h}),m.jsx("line",{x1:r[0].x,y1:r[0].y,x2:i[0].x,y2:i[0].y,stroke:n,strokeWidth:a,strokeDasharray:h}),m.jsx("line",{x1:r[1].x,y1:r[1].y,x2:i[1].x,y2:i[1].y,stroke:n,strokeWidth:a,strokeDasharray:h}),m.jsx("line",{x1:r[2].x,y1:r[2].y,x2:i[2].x,y2:i[2].y,stroke:n,strokeWidth:a,strokeDasharray:h}),m.jsx("polygon",{points:f(s),transform:"translate(".concat(i[0].x,",").concat(i[0].y,") rotate(").concat((w+270)%360,")"),fill:n}),m.jsx("polygon",{points:f(s),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((w+270)%360,")"),fill:n}),m.jsx("polygon",{points:f(s),transform:"translate(".concat(i[1].x,",").concat(i[1].y,") rotate(").concat((w+90)%360,")"),fill:n}),m.jsx("polygon",{points:f(s),transform:"translate(".concat(i[2].x,",").concat(i[2].y,") rotate(").concat((w+90)%360,")"),fill:n})]})},Kt=t=>{const{id:e,x:d,y,handlePointerDown:r,handlePointerMove:i,handlePointerUp:w}=t,f=T.useCallback(n=>r(e,n),[e,r]),a=T.useCallback(n=>i(e,n),[e,i]),s=T.useCallback(n=>w(e,n),[e,w]);return m.jsx("g",{id:e,transform:"translate(".concat(d-6.4," ").concat(y-6.4,")scale(0.025)"),onPointerDown:f,onPointerMove:a,onPointerUp:s,style:{cursor:"move"},children:m.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Ie=t=>{const{id:e,path:d,handlePointerDown:y}=t,r=T.useCallback(i=>y(e,i),[e,y]);return m.jsx("path",{id:e,d,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Te=T.memo(t=>{var a,s,n,h,l,p,u,L,P,_,g,b;const{elements:e,handlePointerDown:d,handlePointerMove:y,handlePointerUp:r,handleEdgePointerDown:i}=t,w=Object.fromEntries(Array.from({length:21},(c,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const c of e)if(c.type==="line"){const M=c.line.attr.type,E=c.line.attr.style,V=c.line.attr[E],D=(a=Mt[E])==null?void 0:a.preComponent;D&&w[c.line.attr.zIndex].pre.push(m.jsx(D,{id:c.id,type:M,path:c.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},"".concat(c.id,".pre")));const U=(n=(s=Mt[E])==null?void 0:s.component)!=null?n:Ie;w[c.line.attr.zIndex].main.push(m.jsx(U,{id:c.id,type:M,path:c.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},c.id));const B=(h=Mt[E])==null?void 0:h.postComponent;B&&w[c.line.attr.zIndex].post.push(m.jsx(B,{id:c.id,type:M,path:c.line.path,styleAttrs:V,newLine:!1,handlePointerDown:i},"".concat(c.id,".post")))}else if(c.type==="station"){const M=c.station,E=M.type,V=(l=at[E])==null?void 0:l.preComponent;V&&w[c.station.zIndex].pre.push(m.jsx(V,{id:c.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},"".concat(c.id,".pre")));const D=(u=(p=at[E])==null?void 0:p.component)!=null?u:Kt;w[c.station.zIndex].main.push(m.jsx(D,{id:c.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},c.id));const U=(L=at[E])==null?void 0:L.postComponent;U&&w[c.station.zIndex].post.push(m.jsx(U,{id:c.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},"".concat(c.id,".post")))}else if(c.type==="misc-node"){const M=c.miscNode,E=M.type,V=(P=vt[E])==null?void 0:P.preComponent;V&&w[c.miscNode.zIndex].pre.push(m.jsx(V,{id:c.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},"".concat(c.id,".pre")));const D=(g=(_=vt[E])==null?void 0:_.component)!=null?g:Kt;w[c.miscNode.zIndex].main.push(m.jsx(D,{id:c.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},c.id));const U=(b=vt[E])==null?void 0:b.postComponent;U&&w[c.miscNode.zIndex].post.push(m.jsx(U,{id:c.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:d,handlePointerMove:y,handlePointerUp:r},"".concat(c.id,".post")))}return Array.from({length:21},(c,M)=>(M-10).toString()).map(c=>[...w[c].pre,...w[c].main,...w[c].post]).flat()},(t,e)=>t.elements===e.elements),We=[...Object.values(ie),lt.Virtual,lt.Master,lt.LondonArrow,lt.ChongqingRTNumLineBadge2021,lt.ChongqingRTTextLineBadge2021,lt.ChengduRTLineBadge,lt.GzmtrLineBadge],Be=()=>{const t=_t(),e=T.useRef(window.graph),d=()=>{t(bt(e.current.export())),t(mt()),t(St())},{telemetry:{project:y},preference:{autoParallel:r,gridLines:i,snapLines:w}}=J(C=>C.app),{svgViewBoxZoom:f,svgViewBoxMin:a}=J(C=>C.param),{selected:s,pointerPosition:n,active:h,refresh:{nodes:l,edges:p},mode:u,keepLastPath:L,theme:P}=J(C=>C.runtime),_=Ut(),{height:g,width:b}=qt(_),[c,M]=T.useState({dx:0,dy:0}),[E,V]=T.useState([]),[D,U]=T.useState([]),[B,et]=T.useState([]);T.useEffect(()=>{if(!n||!w)return;const C=Et(a,f,b,g),N=Gt(e.current,...Object.values(C));U(N),V(fe(e.current,N))},[a,f,b,g,n]);const[st,ot]=T.useState(void 0),j=tt((C,N)=>{N.stopPropagation(),N.currentTarget.setPointerCapture(N.pointerId);const{x:H,y:G}=it(N);u==="select"&&t(ut("free")),et([]),ot(void 0),t(Dt({x:H,y:G})),t(xt(C)),N.shiftKey?s.has(C)?t($t(C)):t(It(C)):s.has(C)||t(ft(new Set([C])))}),R=tt((C,N)=>{const{x:H,y:G}=it(N);if(N.currentTarget.setPointerCapture(N.pointerId),u==="free"&&h===C){if(!N.altKey&&w){const K=e.current.getNodeAttribute(C,"x"),X=e.current.getNodeAttribute(C,"y"),$=K-(n.x-H)*f/100,O=X-(n.y-G)*f/100;let o=$,A=O;if(ge(C,e.current)){let S=B,x=st;if(S.length!==0&&(S=S.filter(v=>pe(v,$,O)<=6)),x&&(S.length===0||Math.hypot($-x.x,O-x.y)>6)&&(x=void 0),!x&&S.length===1){const v=S[0],{snapPoint:I,distance:W}=xe(e.current,D.filter(F=>!s.has(F)),$,O,v);W<=3&&(x=I)}if(S.length===1&&!x||S.length===0){const{l:v,d:I}=me($,O,E,D.filter(F=>!s.has(F)&&!S.some(Ct=>Ct.node===F))),W=S.length===0||!S.some(F=>F.a===v.a&&F.b===v.b);I<3&&S.length<2&&W&&S.push(v)}if(S.length===1)if(x)o=x.x,A=x.y;else{const v=S[0];if(v.a==0)A=-v.c/v.b;else if(v.b==0)o=-v.c/v.a;else{const I=-v.a/v.b,W=-v.c/v.b;A=I*o+W}}else if(S.length===2){const v=S[0],I=S[1],W=v.a*I.b-I.a*v.b;W!==0&&(o=-(v.c*I.b-I.c*v.b)/W,A=-(v.a*I.c-I.a*v.c)/W)}et(S),ot(x)}const k=o-K,z=A-X;s.forEach(S=>{e.current.hasNode(S)&&e.current.updateNodeAttributes(S,x=>({...x,x:Y(x.x+k,.01),y:Y(x.y+z,.01)}))})}else et([]),ot(void 0),s.forEach(K=>{e.current.hasNode(K)&&e.current.updateNodeAttributes(K,X=>({...X,x:Y(X.x-(n.x-H)*f/100,N.altKey?.01:5),y:Y(X.y-(n.y-G)*f/100,N.altKey?.01:5)}))});t(mt()),t(St())}else u.startsWith("line")&&h&&M({dx:(n.x-H)*f/100,dy:(n.y-G)*f/100})}),q=tt((C,N)=>{var H,G,K;if(N.currentTarget.releasePointerCapture(N.pointerId),u.startsWith("line")){L||t(ut("free"));const X=e.current.hasNode(h)&&We.includes(e.current.getNodeAttribute(h,"type")),$=["stn_core_","virtual_circle_","misc_node_connectable_"],o=(K=(G=(H=document.elementsFromPoint(N.clientX,N.clientY).at(0))==null?void 0:H.attributes)==null?void 0:G.getNamedItem("id"))==null?void 0:K.value,A=$.find(k=>o==null?void 0:o.startsWith(k));if(X&&A){const k=u.slice(5),z="line_".concat(yt(10)),[S,x]=[h,o.slice(A.length)];if(S!==x){const v=r?Ft(e.current,k,S,x,"from"):-1;e.current.addDirectedEdgeWithKey(z,S,x,{visible:!0,zIndex:0,type:k,[k]:structuredClone(Z[k].defaultAttrs),style:wt.SingleColor,[wt.SingleColor]:{color:P},reconcileId:"",parallelIndex:v}),t(ft(new Set([z]))),y&&gt.event(pt.ADD_LINE,{type:k}),t(bt(e.current.export())),t(St())}}}else if(u==="free"&&h){const{x:X,y:$}=it(N);n.x-X===0&&n.y-$===0||(t(bt(e.current.export())),t(mt()))}et([]),ot(void 0),Dt(void 0),t(xt(void 0))}),ct=tt((C,N)=>{if(N.stopPropagation(),N.shiftKey||t(kt()),N.shiftKey&&s.has(C)?t($t(C)):t(It(C)),u.startsWith("station")||u.startsWith("misc-node-virtual")||u.startsWith("misc-node-master")){const H=N.clientX-document.getElementById("canvas").getBoundingClientRect().left,G=N.clientY-document.getElementById("canvas").getBoundingClientRect().top,K=u.startsWith("station"),X=yt(10),$=K?"stn_".concat(X):"misc_node_".concat(X),O=K?u.slice(8):u.slice(10),{x:o,y:A}=dt(H,G,f,a),k=K?structuredClone(at[O].defaultAttrs):structuredClone(vt[O].defaultAttrs);"color"in k&&(k.color=P),e.current.addNode($,{visible:!0,zIndex:0,x:Y(o,5),y:Y(A,5),type:O,[O]:k});const z=e.current.getEdgeAttributes(C),{zIndex:S,type:x,style:v}=z,I=z[x],W=z[v],[F,Ct]=e.current.extremities(C),zt=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(yt(10)),F,$,{visible:!0,zIndex:S,type:x,[x]:structuredClone(I),style:v,[v]:structuredClone(W),reconcileId:"",parallelIndex:zt}),e.current.addDirectedEdgeWithKey("line_".concat(yt(10)),$,Ct,{visible:!0,zIndex:S,type:x,[x]:structuredClone(I),style:v,[v]:structuredClone(W),reconcileId:"",parallelIndex:zt}),e.current.dropEdge(C),d(),y&&(gt.event(pt.ADD_STATION,{type:O}),gt.event(pt.ADD_LINE,{type:x})),t(ut("free")),t(ft(new Set([$])))}}),nt=T.useMemo(()=>[...ze(e.current),...Ee(e.current)],[p,l]),rt=Ot.component;return m.jsxs(m.Fragment,{children:[m.jsx(Te,{elements:nt,handlePointerDown:j,handlePointerMove:R,handlePointerUp:q,handleEdgePointerDown:ct}),u.startsWith("line")&&h&&h!=="background"&&m.jsx(rt,{id:"line_create_in_progress___no_use",type:u.slice(5),path:Z[u.slice(5)].generatePath(e.current.getNodeAttribute(h,"x"),e.current.getNodeAttribute(h,"x")-c.dx,e.current.getNodeAttribute(h,"y"),e.current.getNodeAttribute(h,"y")-c.dy,Z[u.slice(5)].defaultAttrs),styleAttrs:{color:P},newLine:!0,handlePointerDown:()=>{}}),B.length!==0&&B.map(C=>m.jsx("path",{d:Z[Q.Simple].generatePath(...Se(C,Et(a,f,b,g)),Z[Q.Simple].defaultAttrs),stroke:"cyan",strokeWidth:f/75},"snap_line_".concat(C.a,"_").concat(C.b,"_").concat(C.c,"_").concat(C.node))),st&&m.jsx($e,{activeSnapPoint:st})]})},Ye=()=>{const t=_t(),e=T.useRef(window.graph),d=()=>{t(bt(e.current.export())),t(mt()),t(St())},{activeSubscriptions:y}=J(o=>o.account),{telemetry:{project:r},preference:{gridLines:i,snapLines:w,predictNextNode:f}}=J(o=>o.app),{svgViewBoxZoom:a,svgViewBoxMin:s}=J(o=>o.param),{mode:n,lastTool:h,active:l,selected:p,keepLastPath:u,theme:L,count:{masters:P,lines:_}}=J(o=>o.runtime),g=Ut(),{height:b,width:c}=qt(g),M=!y.RMP_CLOUD&&P+1>ae,E=!y.RMP_CLOUD&&_+1>ce,V=Jt();le();const[D,U]=T.useState({x:0,y:0}),[B,et]=T.useState({x:0,y:0}),[st,ot]=T.useState({x:0,y:0}),[j,R]=T.useState({x:0,y:0}),q=tt(async o=>{const{x:A,y:k}=it(o);if(n.startsWith("station")||n.startsWith("misc-node")){t(ut("free"));const z=yt(10),{x:S,y:x}=dt(A,k,a,s),v=n.startsWith("station"),I=v?"stn_".concat(z):"misc_node_".concat(z),W=v?n.slice(8):n.slice(10),F=structuredClone({...at,...vt}[W].defaultAttrs);Yt.has(W)&&(F.color=L),v&&(F.names=await V(W)),e.current.addNode(I,{visible:!0,zIndex:0,x:Y(S,5),y:Y(x,5),type:W,[W]:F}),r&&gt.event(pt.ADD_STATION,{type:W}),d(),t(ft(new Set([I])))}else n==="free"||n.startsWith("line")?(n.startsWith("line")&&(t(ut("free")),u&&t(ye(!1))),ot({x:A,y:k}),R(s),o.shiftKey||(t(xt("background")),t(kt()))):n==="select"&&(U(dt(A,k,a,s)),et(dt(A,k,a,s)))}),ct=tt(o=>{if(n==="select"){if(D.x!=0&&D.y!=0){const{x:A,y:k}=it(o);et(dt(A,k,a,s))}}else if(l==="background"){const{x:A,y:k}=it(o);t(Pt({x:j.x+(st.x-A)*a/100,y:j.y+(st.y-k)*a/100}))}}),nt=tt(o=>{if(n==="select"){const{x:A,y:k}=it(o),{x:z,y:S}=dt(A,k,a,s),x=Gt(e.current,D.x,D.y,z,S),v=we(e.current,new Set(x));t(ft(new Set([...o.shiftKey?p:[],...x,...v]))),t(ut("free")),U({x:0,y:0}),et({x:0,y:0})}l==="background"&&!o.shiftKey&&t(xt(void 0))}),rt=tt(o=>{let A=a;o.deltaY>0&&a+10<400?A=a+10:o.deltaY<0&&a-10>0&&(A=a-10),t(Tt(A));const{x:k,y:z}=it(o),S=o.currentTarget.getBoundingClientRect(),[x,v]=[k/S.width,z/S.height];t(Pt({x:s.x+k*a/100-c*A/100*x,y:s.y+z*a/100-b*A/100*v}))}),C=tt(async o=>{if(ht?o.key==="Backspace":o.key==="Delete")p.size>0&&(p.forEach(A=>{e.current.hasNode(A)?e.current.dropNode(A):e.current.hasEdge(A)&&e.current.dropEdge(A)}),t(kt()),d());else if(o.key.startsWith("Arrow")){const k=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,z=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;t(Pt(dt(100*k,100*z,a,s)))}else if(o.key==="i"||o.key==="j"||o.key==="k"||o.key==="l"){const k=(o.key==="j"?-1:o.key==="l"?1:0)*10,z=(o.key==="i"?-1:o.key==="k"?1:0)*10;p.size>0&&p.forEach(S=>{e.current.hasNode(S)&&(e.current.updateNodeAttribute(S,"x",x=>(x!=null?x:0)+k),e.current.updateNodeAttribute(S,"y",x=>(x!=null?x:0)+z),d())})}else if(o.key==="f"&&h)t(ut(h));else if(o.key==="z"&&(ht?o.metaKey&&!o.shiftKey:o.ctrlKey))ht&&o.preventDefault(),t(de()),t(mt()),t(St());else if(o.key==="s")t(ut("select"));else if((o.key==="c"||o.key==="x")&&(ht?o.metaKey&&!o.shiftKey:o.ctrlKey)){const A=be(e.current,p);navigator.clipboard.writeText(A),o.key==="x"&&(t(kt()),p.forEach(k=>{e.current.hasNode(k)?e.current.dropNode(k):e.current.hasEdge(k)&&e.current.dropEdge(k)}),d())}else if(o.key==="v"&&(ht?o.metaKey&&!o.shiftKey:o.ctrlKey)){const A=await navigator.clipboard.readText(),{x:k,y:z}=dt(c/2,b/2,a,s),{nodes:S,edges:x}=Pe(A,e.current,M,E,Y(k,5),Y(z,5));d();const v=structuredClone(S);x.forEach(I=>v.add(I)),t(ft(v))}else ht&&o.key==="z"&&o.metaKey&&o.shiftKey||!ht&&o.key==="y"&&o.ctrlKey?t(ue()):o.key==="c"&&t(he(!w))}),[N,H]=T.useState(0),G=tt(o=>{if(o.touches.length===2){t(xt(void 0));const[A,k]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY];H(A*A+k*k)}}),K=tt(o=>{if(N!==0&&o.touches.length===2){const[A,k]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY],z=A*A+k*k;let S=a;z-N<0&&a+10<=390?S=a+10:z-N>0&&a-10>=10&&(S=a-10),t(Tt(S)),H(z);const x=o.currentTarget.getBoundingClientRect(),[v,I]=[(o.touches[0].clientX+o.touches[1].clientX)/2-x.left,(o.touches[0].clientY+o.touches[1].clientY)/2-x.top],[W,F]=[v/x.width,I/x.height];t(Pt({x:s.x+v*a/100-c*S/100*W,y:s.y+I*a/100-b*S/100*F}))}}),X=tt(o=>{N!==0&&H(0)}),[$,O]=T.useState({sx:0,sy:0,ex:0,ey:0});return T.useEffect(()=>{O({sx:D.x<=B.x?D.x:B.x,ex:D.x>B.x?D.x:B.x,sy:D.y<=B.y?D.y:B.y,ey:D.y>B.y?D.y:B.y})},[B.x,B.y]),m.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:b,width:c,viewBox:"".concat(s.x," ").concat(s.y," ").concat(c*a/100," ").concat(b*a/100),onPointerDown:q,onPointerMove:ct,onPointerUp:nt,onTouchStart:G,onTouchMove:K,onTouchEnd:X,onWheel:rt,tabIndex:0,onKeyDown:C,children:[i&&m.jsx(Ce,{svgViewBoxMin:s,svgViewBoxZoom:a,svgWidth:c,svgHeight:b}),f&&p.size===1&&m.jsx(Ne,{}),m.jsx(ve.SvgAssetsContextProvider,{children:m.jsx(Be,{})}),n==="select"&&D.x!=0&&D.y!=0&&m.jsx("rect",{x:$.sx,y:$.sy,width:$.ex-$.sx,height:$.ey-$.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),m.jsx("defs",{children:m.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[m.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),m.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ye as default};

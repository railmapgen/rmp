import{a as ge,j as c,P as xe,B as Qt,D as Ot,ad as pe,a2 as me}from"./chakra-B1xyVt4l.js";import{c as St,e as O,a8 as Tt,A as te,aB as $t,aC as be,aD as ee,a5 as ne,x as wt,y as ht,z as ft,aE as Nt,G as pt,_ as lt,aF as se,aG as K,Z as mt,aH as Wt,q as Ct,aI as Bt,aJ as oe,L as nt,aK as rt,aL as dt,aM as Rt,n as vt,aN as ve,d as re,r as At,E as Pt,t as et,aO as kt,aP as we,aQ as Se,aR as Ae,aS as Lt,v as Dt,w as zt,aT as xt,aU as Vt,aV as Xt,p as ie,S as Pe,aW as Ft,aX as Me,aY as It,aZ as ke,H as ae,I as Et,a_ as Ce,a$ as je,b0 as Ee,b1 as Ne,b2 as _e,b3 as De,b4 as ze,b5 as Le,b6 as Ht,b7 as Ie,b8 as Te,b9 as $e,aj as bt,ay as We,az as Be,aa as Re,a6 as Oe}from"./index-CXR348Pd.js";import{s as yt,f as ce,c as Ve,e as Xe}from"./master-manager-BRX28JX3.js";import{b as N,k as le,u as Fe}from"./react-BpF4RbzH.js";import{u as R}from"./useEvent-LzhclC4A.js";import{c as _t}from"./change-types-DMQLb4XR.js";import{v as He,m as Mt}from"./misc-nodes-BA62Xe00.js";const Ke={[Tt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Tt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ye=t=>{const e=Ke[t];return e.at(Math.floor(Math.random()*e.length))},Kt=le("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:l})=>{const{token:o}=e().account;if(!o){i($t({cityName:t,names:[]}));return}const s=await fetch("".concat(be,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return te.warn("Failed to fetch random station names",s.statusText),l(s.statusText);const b=await s.json();i($t({cityName:t,names:b}))}),Yt=le("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var y;const{stationNames:l}=e().runtime,o=l[t];if(((y=o==null?void 0:o.length)!=null?y:0)==0)return te.debug("No random station names in cache, using fallback"),i(Kt({cityName:t})),Object.values(Ye(t));const s=structuredClone(o),b=s.shift();return i($t({cityName:t,names:s})),s.length<3&&i(Kt({cityName:t})),Object.values(b)}),de=()=>{const t=St(),{activeSubscriptions:e}=O(o=>o.account),{preference:{randomStationsNames:i}}=O(o=>o.app),l=!e.RMP_CLOUD||i==="none";return N.useCallback(async o=>{const s=yt[o].defaultAttrs.names;if(!l){const b=await t(Yt(Tt.Shmetro));if(Yt.fulfilled.match(b)){const y=b.payload;return s.length>y.length?y.push(...Array(s.length-y.length).fill(y.at(-1))):s.length<y.length&&y.splice(s.length),y}}return structuredClone(s)},[t,l])},Ue=({isOpen:t,position:e,onClose:i})=>{const{t:l}=Fe(),o=St(),s=N.useRef(window.graph),{activeSubscriptions:b}=O(C=>C.account),{preference:{autoParallel:y}}=O(C=>C.app),{svgViewBoxZoom:p,svgViewBoxMin:r}=O(C=>C.param),{selected:n,count:{masters:u,lines:d}}=O(C=>C.runtime),f=!b.RMP_CLOUD&&u+1>ee,g=!y||y&&!b.RMP_CLOUD&&d+1>ne,m=n.size>0,v=N.useRef(null);ge({ref:v,handler:i,enabled:t});const A=N.useCallback(()=>{o(wt(s.current.export())),o(ht()),o(ft())},[o]),x=R(()=>{if(n.size>0){const C=Nt(s.current,n);navigator.clipboard.writeText(C)}}),S=R(()=>{if(n.size>0){const C=Nt(s.current,n);navigator.clipboard.writeText(C),o(pt()),n.forEach(D=>{s.current.hasNode(D)?s.current.dropNode(D):s.current.hasEdge(D)&&s.current.dropEdge(D)}),A()}}),a=R(async()=>{try{const C=await navigator.clipboard.readText(),{x:D,y:q}=lt(e.x,e.y,p,r),{nodes:V,edges:z}=se(C,s.current,f,g,K(D,5),K(q,5));A();const B=structuredClone(V);z.forEach(F=>B.add(F)),o(mt(B))}catch(C){console.warn("Failed to read clipboard:",C)}}),k=R(()=>{n.size>0&&(o(pt()),n.forEach(C=>{s.current.hasNode(C)?s.current.dropNode(C):s.current.hasEdge(C)&&s.current.dropEdge(C)}),A())}),_=R(()=>{o(ht()),o(ft())}),T=R(C=>{if(n.size>0){const D=Math.min(Math.max(C,-10),10);n.forEach(q=>{s.current.hasNode(q)&&s.current.setNodeAttribute(q,"zIndex",D),s.current.hasEdge(q)&&s.current.setEdgeAttribute(q,"zIndex",D)}),A()}}),W=R(()=>{if(n.size>0){const[C]=n,D=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;T(D+1)}}),Q=R(()=>{if(n.size>0){const[C]=n,D=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;T(D-1)}});return t?c.jsx(xe,{children:c.jsxs(Qt,{ref:v,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[c.jsx(ct,{onClick:()=>{_(),i()},children:l("contextMenu.refresh")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{x(),i()},isDisabled:!m,children:l("contextMenu.copy")}),c.jsx(ct,{onClick:()=>{S(),i()},isDisabled:!m,children:l("contextMenu.cut")}),c.jsx(ct,{onClick:()=>{a(),i()},children:l("contextMenu.paste")}),c.jsx(ct,{onClick:()=>{k(),i()},isDisabled:!m,children:l("contextMenu.delete")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{T(10),i()},isDisabled:!m,children:l("contextMenu.placeTop")}),c.jsx(ct,{onClick:()=>{T(-10),i()},isDisabled:!m,children:l("contextMenu.placeBottom")}),c.jsx(ct,{onClick:()=>{T(0),i()},isDisabled:!m,children:l("contextMenu.placeDefault")}),c.jsx(ct,{onClick:()=>{W(),i()},isDisabled:!m,children:l("contextMenu.placeUp")}),c.jsx(ct,{onClick:()=>{Q(),i()},isDisabled:!m,children:l("contextMenu.placeDown")})]})}):null},ct=({children:t,onClick:e,isDisabled:i=!1})=>c.jsx(Qt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),Ze=N.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:l,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=O(A=>A.app),y=pe().colorMode==="light"?"#666464":"#D3D3D4",p=Wt(e,i,l,o),r=s?410*i/100:0,n=i>30?i>120?50:25:5,u=i/200,d={startX:K(p.xMin+r-n,n),endX:K(p.xMax+r+n,n),startY:K(p.yMin-n,n),endY:K(p.yMax+n,n)},f=Array.from({length:(d.endX-d.startX)/n+1},(A,x)=>{const S=d.startX+x*n,a=S%(n*5)===0?2*u:u;return c.jsx("line",{x1:S,y1:d.startY,x2:S,y2:d.endY,strokeWidth:a,stroke:y,opacity:"0.5"},"grid_vl_".concat(S))}),g=Array.from({length:(d.endY-d.startY)/n+1},(A,x)=>{const S=d.startY+x*n,a=S%(n*5)===0?2*u:u;return c.jsx("line",{x1:d.startX,y1:S,x2:d.endX,y2:S,strokeWidth:a,stroke:y,opacity:"0.5"},"grid_hl_".concat(S))}),m=Array.from({length:(d.endX-d.startX)/n/5+1},(A,x)=>{const S=K(d.startX,5*n)+x*5*n;return c.jsx("text",{x:S,y:p.yMin+i/5,fontSize:u*25,fill:y,textAnchor:"middle",opacity:"0.5",children:S},"grid_vc_".concat(S))}),v=Array.from({length:(d.endY-d.startY)/n/5+1},(A,x)=>{const S=K(d.startY,5*n)+x*5*n;return c.jsx("text",{x:p.xMin+i/8+r,y:S,fontSize:u*25,fill:y,textAnchor:"start",opacity:"0.5",children:S},"grid_hc_".concat(S))});return c.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,g,m,v]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),qe=He.component,Ut=Bt.generatePath,Zt=oe.component,jt=10,Ge=()=>{var V;const t=St(),e=()=>{t(wt(window.graph.export())),t(ht()),t(ft())},{telemetry:{project:i},preference:{autoParallel:l}}=O(z=>z.app),{selected:o,theme:s,count:{mostFrequentStationType:b}}=O(z=>z.runtime),y=de(),p=o.keys().next().value;if(!p.startsWith("stn")&&!p.startsWith("misc_node")||!window.graph.hasNode(p))return;const r=window.graph.neighbors(p);if(r.length===0)return;const n=window.graph.getNodeAttributes(p),u=r.reduce((z,B)=>{const F=window.graph.getNodeAttributes(B);return{x:z.x+F.x,y:z.y+F.y}},{x:0,y:0}),d={x:u.x/r.length,y:u.y/r.length},f={x:n.x-d.x,y:n.y-d.y},g={x:n.x+f.x,y:n.y+f.y},m=Math.sign(f.x)===Math.sign(f.y),v={x:g.x-jt,y:g.y+jt*(m?1:-1)},A={x:g.x+jt,y:g.y+jt*(m?-1:1)},x=p.startsWith("stn_")?window.graph.getNodeAttribute(p,"type"):b,S=yt[x].component,a={visible:!0,zIndex:0,x:A.x,y:A.y,type:x,[x]:yt[x].defaultAttrs},k=window.graph.reduceEdges(p,(z,B)=>{const F=window.graph.getEdgeAttributes(B),{style:ut}=F;if(ut===Ct.SingleColor){const it=JSON.stringify(F[ut].color);it in z?z[it]+=1:z[it]=1}return z},{}),_=(V=Object.entries(k).filter(([z,B])=>B%2!==0).reduce((z,[B,F])=>F>z.count?{color:JSON.parse(B),count:F}:z,{color:null,count:0}).color)!=null?V:s,T=f.x>0?!(f.x>Math.abs(f.y)):-f.x>Math.abs(f.y),W=T?"from":"to",Q=Ut(n.x,v.x,n.y,v.y,{...Bt.defaultAttrs,startFrom:W}),C=T?"to":"from",D=Ut(n.x,A.x,n.y,A.y,{...Bt.defaultAttrs,startFrom:C}),q=async(z,B)=>{B.stopPropagation();const{x:F,y:ut}=dt(B);t(Rt({x:F,y:ut}));const it=vt(10),at=ve.has(z),E=at?"stn_".concat(it):"misc_node_".concat(it),L=structuredClone({...yt,...Mt}[z].defaultAttrs);re.has(z)&&(L.color=s),at&&(L.names=await y(z)),window.graph.addNode(E,{visible:!0,zIndex:0,x:at?A.x:v.x,y:at?A.y:v.y,type:z,[z]:L}),i&&At.event(Pt.ADD_STATION,{type:z});const Y=nt.Diagonal,tt="line_".concat(vt(10)),[G,U]=[p,E],H=l?0:-1,J=at?C:W;window.graph.addDirectedEdgeWithKey(tt,G,U,{visible:!0,zIndex:0,type:Y,[Y]:{...structuredClone(et[Y].defaultAttrs),startFrom:J},style:Ct.SingleColor,[Ct.SingleColor]:{color:_},reconcileId:"",parallelIndex:H}),i&&At.event(Pt.ADD_LINE,{type:Y}),e(),t(kt(E)),t(mt(new Set([E])))};return c.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[c.jsx(Zt,{id:"line_prediction_1",type:nt.Diagonal,path:Q,styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),c.jsx(Zt,{id:"line_prediction_2",type:nt.Diagonal,path:D,styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),c.jsx(qe,{id:"misc_node_virtual_prediction_1",attrs:{},x:v.x,y:v.y,handlePointerDown:(z,B)=>{q(rt.Virtual,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),c.jsx(S,{id:"stn_virtual_prediction_2",attrs:a,x:A.x,y:A.y,handlePointerDown:(z,B)=>{q(b,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},ue=(t,e,i,l,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return qt(t,e,i,l,o)?{x1:e,y1:i,x2:l,y2:o,offset:s.offsetFrom}:void 0;const[b,y]=[s.offsetFrom,s.offsetTo];for(let p=0;p<Math.PI;p+=Math.PI/8)for(let r=p,n=0;n<2;n++,r+=Math.PI){const[u,d,f,g]=[Math.sin(p)*b,Math.cos(p)*b,Math.sin(r)*y,Math.cos(r)*y];if(qt(t,e+u,i+d,l+f,o+g))return{x1:e+u,y1:i+d,x2:l+f,y2:o+g,offset:0}}},Je=(t,e,i,l,o,s)=>t===i?{x1:t+5*s,y1:e,x2:i+5*s,y2:l,offset:o}:e===l?{x1:t,y1:e+5*s,x2:i,y2:l+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:i+5*Math.SQRT1_2*s,y2:l+5*Math.SQRT1_2*s,offset:o},qt=(t,e,i,l,o)=>!!((e===l||i===o)&&[nt.Diagonal,nt.Perpendicular].includes(t)||Math.abs((o-i)/(l-e))===1&&[nt.Diagonal,nt.RotatePerpendicular].includes(t)),Qe=(t,e)=>{const i=[],l=[];return Object.values(e).forEach(o=>{var A;if(o.length===1){l.push(...o.map(x=>x.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(x=>t.getEdgeAttribute(x,"type")===s)){l.push(...o.map(x=>x.edge));return}const b=t.getEdgeAttribute(o.at(0),"style");if(!o.every(x=>t.getEdgeAttribute(x,"style")===b)){l.push(...o.map(x=>x.edge));return}const y={},p=new Set,r=new Set,n=Object.fromEntries(o.map(x=>{var k,_;const[S,a]=t.extremities(x);return y[S]=((k=y[S])!=null?k:0)+1,y[a]=((_=y[a])!=null?_:0)+1,p.add(S),r.add(a),[S,[x.edge,a]]})),u=Array.from(p).filter(x=>y[x]===1),d=Array.from(r).filter(x=>y[x]===1);if(u.length!==1||d.length!==1){l.push(...o.map(x=>x.edge));return}const f=u[0],g=d[0];if(f===g){l.push(...o.map(x=>x.edge));return}const m=[n[f][0]];let v=n[f][1];for(let x=1;x<o.length;x=x+1){const S=(A=n[v])==null?void 0:A.at(1);if(!S){l.push(...o.map(a=>a.edge));return}m.push(n[v][0]),v=S}if(v!==g||m.length!==o.length){l.push(...o.map(x=>x.edge));return}i.push(m)}),{allReconciledLines:i,danglingLines:l}},tn=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var d,f,g;const[s,b]=t.extremities(o),y=t.getNodeAttributes(s),p=t.getNodeAttributes(b),{type:r}=t.getEdgeAttributes(o),n=(d=t.getEdgeAttribute(o,r))!=null?d:et[r].defaultAttrs,u=ue(r,y.x,y.y,p.x,p.y,n);if(u){const{x1:m,y1:v,x2:A,y2:x,offset:S}=u;return et[nt.Simple].generatePath(m,A,v,x,{offset:S})}return(g=(f=et[r])==null?void 0:f.generatePath(y.x,p.x,y.y,p.y,n))!=null?g:"M ".concat(y.x," ").concat(y.y," L ").concat(p.x," ").concat(p.y)});let l="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)l+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return l},en=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),nn=t=>{const e={},i={},l=[],o={},s=[];for(const r of t.edgeEntries()){const[n,u,d,f]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],g=r.attributes[r.attributes.type],m=ue(r.attributes.type,n,u,d,f,g);i[r.edge]=m}for(const r of t.edgeEntries()){let n=i[r.edge];const{parallelIndex:u}=r.attributes;if(u>=0){const d=we(t,r.attributes.type,r.edge),f=i[d];if(!f){l.push(r);continue}if(u>0){const{x1:g,y1:m,x2:v,y2:A,offset:x}=f;n=Je(g,m,v,A,x,u)}}if(r.attributes.reconcileId!==""){const d=r.attributes.reconcileId;d in o?o[d].push(r):o[d]=[r];continue}if(n){const d=r.edge,f=r.attributes,{x1:g,y1:m,x2:v,y2:A,offset:x}=n;e[d]={attr:f,path:et[nt.Simple].generatePath(g,v,m,A,{offset:x})};continue}s.push(r)}const b=new Set;for(;l.length;){const r=l.pop();if(b.has(r.edge))continue;const{parallel:n}=Se(t,r);if(!n.length)continue;n.forEach(d=>b.add(d.edge));const u=Ae(n);for(const d of n){const f=d.edge;e[f]={attr:d.attributes,path:u[f]}}}const{allReconciledLines:y,danglingLines:p}=Qe(t,o);for(const r of y){const n=tn(t,r);if(!n)continue;const u=r[0];e[u]={attr:t.getEdgeAttributes(u),path:n}}for(const r of p){const n=t.getEdgeAttributes(r),[u,d]=t.extremities(r),f=t.getNodeAttributes(u),g=t.getNodeAttributes(d);e[r]={attr:n,path:et[nt.Simple].generatePath(f.x,g.x,f.y,g.y,et[nt.Simple].defaultAttrs)}}for(const r of s){const n=r.edge,u=r.attributes.type,d=r.attributes,[f,g,m,v]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(u in et)){e[n]={attr:d,path:"M ".concat(f," ").concat(g," L ").concat(m," ").concat(v)};continue}e[n]={attr:d,path:et[u].generatePath(f,m,g,v,d[u])}}return Object.entries(e).map(([r,n])=>({id:r,type:"line",line:n}))},he=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===rt.Master&&e.getNodeAttributes(t)[rt.Master].nodeType==="Station",sn=(t,e)=>{const i=[];return e.filter(l=>he(l,t)).forEach(l=>{const o=t.getNodeAttribute(l,"x"),s=t.getNodeAttribute(l,"y");i.push({a:1,b:0,c:-o,node:l,x:o,y:s}),i.push({a:0,b:1,c:-s,node:l,x:o,y:s}),i.push({a:1,b:-1,c:-o+s,node:l,x:o,y:s}),i.push({a:1,b:1,c:-o-s,node:l,x:o,y:s})}),i},fe=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),on=(t,e,i,l)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(b=>l.includes(b.node)).forEach(b=>{const y=fe(b,t,e);y<o&&(o=y,s=b)}),{l:s,d:o}},rn=(t,e,i,l,o)=>{const s=e.filter(r=>{const n=t.getNodeAttribute(r,"x"),u=t.getNodeAttribute(r,"y");return Math.abs(o.a*n+o.b*u+o.c)<=.01}),b=[(r,n,u,d)=>[(r+u)/2,(n+d)/2],(r,n,u,d)=>[2*r-u,2*n-d],(r,n,u,d)=>[2*u-r,2*d-n]];let y=1/0,p={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<s.length;r++){const n=s[r],u=t.getNodeAttribute(n,"x"),d=t.getNodeAttribute(n,"y");for(let f=r+1;f<s.length;f++){const g=s[f],m=t.getNodeAttribute(g,"x"),v=t.getNodeAttribute(g,"y");b.forEach(A=>{const[x,S]=A(u,d,m,v),a=Math.hypot(i-x,l-S);a<y&&(y=a,p={x,y:S,originalNodesPos:[{x:u,y:d},{x:m,y:v}]})})}}return{snapPoint:p,distance:y}},an=(t,e)=>{const{xMin:i,yMin:l,xMax:o,yMax:s}=e;if(t.a===0)return[i,o,-t.c/t.b,-t.c/t.b];if(t.b===0)return[-t.c/t.a,-t.c/t.a,l,s];{const b=-t.a/t.b,y=-t.c/t.b;return[i,o,b*i+y,b*o+y]}},cn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=O(d=>d.param),l=d=>{const g=[{x:d.x,y:d.y},...d.originalNodesPos].sort((v,A)=>v.x===A.x?v.y-A.y:v.x-A.x),m=(g[1].y-g[0].y)/(g[1].x-g[0].x);if(Math.abs(m)<=.01)return{original:g,offset:g.map(v=>({x:v.x,y:v.y+10})),rotate:0};if(Math.abs(m)>=1e10)return{original:g,offset:g.map(v=>({x:v.x+10,y:v.y})),rotate:90};{const A=-1/m,x=10/Math.sqrt(A*A+1),S=10*A/Math.sqrt(A*A+1);return{original:g,offset:g.map(a=>({x:a.x+x,y:a.y+S})),rotate:-Math.atan(A)*(180/Math.PI)}}},{original:o,offset:s,rotate:b}=l(e),y=d=>{const f=Math.sqrt(3)/2*d,g="0,0",m="".concat(-d/2,",").concat(f),v="".concat(d/2,",").concat(f);return"".concat(g," ").concat(m," ").concat(v)},p=i/75,r=8*p,n="#FC8181",u="".concat(p*5," ").concat(p*2);return c.jsxs(c.Fragment,{children:[c.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:p,strokeDasharray:u}),c.jsx("polygon",{points:y(r),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((b+270)%360,")"),fill:n}),c.jsx("polygon",{points:y(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((b+270)%360,")"),fill:n}),c.jsx("polygon",{points:y(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((b+90)%360,")"),fill:n}),c.jsx("polygon",{points:y(r),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((b+90)%360,")"),fill:n})]})},Gt=t=>{const{id:e,x:i,y:l,handlePointerDown:o,handlePointerMove:s,handlePointerUp:b}=t,y=N.useCallback(n=>o(e,n),[e,o]),p=N.useCallback(n=>s(e,n),[e,s]),r=N.useCallback(n=>b(e,n),[e,b]);return c.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(l-6.4,")scale(0.025)"),onPointerDown:y,onPointerMove:p,onPointerUp:r,style:{cursor:"move"},children:c.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ln=t=>{const{id:e,path:i,handlePointerDown:l}=t,o=N.useCallback(s=>l(e,s),[e,l]);return c.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},dn=N.memo(t=>{var p,r,n,u,d,f,g,m,v,A,x,S;const{elements:e,handlePointerDown:i,handlePointerMove:l,handlePointerUp:o,handleEdgePointerDown:s}=t,b=Object.fromEntries(Array.from({length:21},(a,k)=>[k-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const k=a.line.attr.type,_=a.line.attr.style,T=a.line.attr[_],W=(p=Lt[_])==null?void 0:p.preComponent;W&&b[a.line.attr.zIndex].pre.push(c.jsx(W,{id:a.id,type:k,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const Q=(n=(r=Lt[_])==null?void 0:r.component)!=null?n:ln;b[a.line.attr.zIndex].main.push(c.jsx(Q,{id:a.id,type:k,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},a.id));const C=(u=Lt[_])==null?void 0:u.postComponent;C&&b[a.line.attr.zIndex].post.push(c.jsx(C,{id:a.id,type:k,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const k=a.station,_=k.type,T=(d=yt[_])==null?void 0:d.preComponent;T&&b[a.station.zIndex].pre.push(c.jsx(T,{id:a.id,x:k.x,y:k.y,attrs:k,handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".pre")));const W=(g=(f=yt[_])==null?void 0:f.component)!=null?g:Gt;b[a.station.zIndex].main.push(c.jsx(W,{id:a.id,x:k.x,y:k.y,attrs:k,handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},a.id));const Q=(m=yt[_])==null?void 0:m.postComponent;Q&&b[a.station.zIndex].post.push(c.jsx(Q,{id:a.id,x:k.x,y:k.y,attrs:k,handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const k=a.miscNode,_=k.type,T=(v=Mt[_])==null?void 0:v.preComponent;T&&b[a.miscNode.zIndex].pre.push(c.jsx(T,{id:a.id,x:k.x,y:k.y,attrs:k[_],handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".pre")));const W=(x=(A=Mt[_])==null?void 0:A.component)!=null?x:Gt;b[a.miscNode.zIndex].main.push(c.jsx(W,{id:a.id,x:k.x,y:k.y,attrs:k[_],handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},a.id));const Q=(S=Mt[_])==null?void 0:S.postComponent;Q&&b[a.miscNode.zIndex].post.push(c.jsx(Q,{id:a.id,x:k.x,y:k.y,attrs:k[_],handlePointerDown:i,handlePointerMove:l,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,k)=>(k-10).toString()).map(a=>[...b[a].pre,...b[a].main,...b[a].post]).flat()},(t,e)=>t.elements===e.elements),un=[...Object.values(Pe),rt.Virtual,rt.Master,rt.Fill,rt.LondonArrow,rt.ChongqingRTNumLineBadge2021,rt.ChongqingRTTextLineBadge2021,rt.ChengduRTLineBadge,rt.GzmtrLineBadge],hn=()=>{const t=St(),e=N.useRef(window.graph),i=()=>{t(wt(e.current.export())),t(ht()),t(ft())},{telemetry:{project:l},preference:{autoParallel:o,snapLines:s,autoChangeStationType:b}}=O(E=>E.app),{svgViewBoxZoom:y,svgViewBoxMin:p}=O(E=>E.param),{selected:r,pointerPosition:n,active:u,refresh:{nodes:d,edges:f},mode:g,keepLastPath:m,theme:v}=O(E=>E.runtime),A=Dt(),{height:x,width:S}=zt(A),[a,k]=N.useState({dx:0,dy:0}),[_,T]=N.useState([]),[W,Q]=N.useState([]),[C,D]=N.useState([]);N.useEffect(()=>{if(!n||!s)return;const E=Wt(p,y,S,x),L=ce(e.current,...Object.values(E));Q(L),T(sn(e.current,L))},[p,y,S,x,n]);const[q,V]=N.useState(void 0),z=R((E,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:Y,y:tt}=dt(L);g==="select"&&t(xt("free")),D([]),V(void 0),t(Rt({x:Y,y:tt})),t(kt(E)),L.shiftKey?r.has(E)?t(Vt(E)):t(Xt(E)):r.has(E)||t(mt(new Set([E])))}),B=R((E,L)=>{const{x:Y,y:tt}=dt(L);if(L.currentTarget.setPointerCapture(L.pointerId),g==="free"&&u===E){if(!L.altKey&&s){const G=e.current.getNodeAttribute(E,"x"),U=e.current.getNodeAttribute(E,"y"),H=G-(n.x-Y)*y/100,J=U-(n.y-tt)*y/100;let X=H,st=J;if(he(E,e.current)){let w=C,P=q;if(w.length!==0&&(w=w.filter(M=>fe(M,H,J)<=6)),P&&(w.length===0||Math.hypot(H-P.x,J-P.y)>6)&&(P=void 0),!P&&w.length===1){const M=w[0],{snapPoint:I,distance:$}=rn(e.current,W.filter(Z=>!r.has(Z)),H,J,M);$<=3&&(P=I)}if(w.length===1&&!P||w.length===0){const{l:M,d:I}=on(H,J,_,W.filter(Z=>!r.has(Z)&&!w.some(ot=>ot.node===Z))),$=w.length===0||!w.some(Z=>Z.a===M.a&&Z.b===M.b);I<3&&w.length<2&&$&&w.push(M)}if(w.length===1)if(P)X=P.x,st=P.y;else{const M=w[0];if(M.a==0)st=-M.c/M.b;else if(M.b==0)X=-M.c/M.a;else{const I=-M.a/M.b,$=-M.c/M.b;st=I*X+$}}else if(w.length===2){const M=w[0],I=w[1],$=M.a*I.b-I.a*M.b;$!==0&&(X=-(M.c*I.b-I.c*M.b)/$,st=-(M.a*I.c-I.a*M.c)/$)}D(w),V(P)}const h=X-G,j=st-U;r.forEach(w=>{e.current.hasNode(w)&&e.current.updateNodeAttributes(w,P=>({...P,x:K(P.x+h,.01),y:K(P.y+j,.01)}))})}else D([]),V(void 0),r.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,U=>({...U,x:K(U.x-(n.x-Y)*y/100,L.altKey?.01:5),y:K(U.y-(n.y-tt)*y/100,L.altKey?.01:5)}))});t(ht()),t(ft())}else g.startsWith("line")&&u&&k({dx:(n.x-Y)*y/100,dy:(n.y-tt)*y/100})}),F=R((E,L)=>{var Y,tt,G;if(L.currentTarget.releasePointerCapture(L.pointerId),g.startsWith("line")){m||t(xt("free"));const U=e.current.hasNode(u)&&un.includes(e.current.getNodeAttribute(u,"type")),H=["stn_core_","virtual_circle_","misc_node_connectable_"],X=(G=(tt=(Y=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:Y.attributes)==null?void 0:tt.getNamedItem("id"))==null?void 0:G.value,st=H.find(h=>X==null?void 0:X.startsWith(h));if(U&&st){const h=g.slice(5),j="line_".concat(vt(10)),[w,P]=[u,X.slice(st.length)];if(w!==P){const M=o?ie(e.current,h,w,P,"from"):-1;e.current.addDirectedEdgeWithKey(j,w,P,{visible:!0,zIndex:0,type:h,[h]:structuredClone(et[h].defaultAttrs),style:Ct.SingleColor,[Ct.SingleColor]:{color:v},reconcileId:"",parallelIndex:M}),b&&w.startsWith("stn")&&_t(e.current,w),b&&P.startsWith("stn")&&_t(e.current,P),t(mt(new Set([j]))),l&&At.event(Pt.ADD_LINE,{type:h}),t(wt(e.current.export())),t(ft())}}}else if(g==="free"&&u){const{x:U,y:H}=dt(L);n.x-U===0&&n.y-H===0||(t(wt(e.current.export())),t(ht()))}D([]),V(void 0),Rt(void 0),t(kt(void 0))}),ut=R((E,L)=>{if(L.stopPropagation(),L.shiftKey||t(pt()),L.shiftKey&&r.has(E)?t(Vt(E)):t(Xt(E)),g.startsWith("station")||g.startsWith("misc-node-virtual")||g.startsWith("misc-node-master")){const Y=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,tt=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=g.startsWith("station"),U=vt(10),H=G?"stn_".concat(U):"misc_node_".concat(U),J=G?g.slice(8):g.slice(10),{x:X,y:st}=lt(Y,tt,y,p),h=G?structuredClone(yt[J].defaultAttrs):structuredClone(Mt[J].defaultAttrs);"color"in h&&(h.color=v),e.current.addNode(H,{visible:!0,zIndex:0,x:K(X,5),y:K(st,5),type:J,[J]:h});const j=e.current.getEdgeAttributes(E),{zIndex:w,type:P,style:M}=j,I=j[P],$=j[M],[Z,ot]=e.current.extremities(E),gt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Z,H,{visible:!0,zIndex:w,type:P,[P]:structuredClone(I),style:M,[M]:structuredClone($),reconcileId:"",parallelIndex:gt}),e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),H,ot,{visible:!0,zIndex:w,type:P,[P]:structuredClone(I),style:M,[M]:structuredClone($),reconcileId:"",parallelIndex:gt}),e.current.dropEdge(E),i(),l&&(At.event(Pt.ADD_STATION,{type:J}),At.event(Pt.ADD_LINE,{type:P})),t(xt("free")),t(mt(new Set([H])))}}),it=N.useMemo(()=>[...nn(e.current),...en(e.current)],[f,d]),at=oe.component;return c.jsxs(c.Fragment,{children:[c.jsx(dn,{elements:it,handlePointerDown:z,handlePointerMove:B,handlePointerUp:F,handleEdgePointerDown:ut}),g.startsWith("line")&&u&&u!=="background"&&c.jsx(at,{id:"line_create_in_progress___no_use",type:g.slice(5),path:et[g.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-a.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-a.dy,et[g.slice(5)].defaultAttrs),styleAttrs:{color:v},newLine:!0,handlePointerDown:()=>{}}),C.length!==0&&C.map(E=>c.jsx("path",{d:et[nt.Simple].generatePath(...an(E,Wt(p,y,S,x)),et[nt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:y/75},"snap_line_".concat(E.a,"_").concat(E.b,"_").concat(E.c,"_").concat(E.node))),q&&c.jsx(cn,{activeSnapPoint:q})]})},fn=()=>{const t=St(),{svgViewBoxZoom:e,svgViewBoxMin:i}=O(f=>f.param),{radialTouchMenu:l}=O(f=>f.runtime),o=N.useRef(window.graph),[s,b]=N.useState(0),y=Dt(),{height:p,width:r}=zt(y),n=R(f=>{var g;if(f.touches.length==1){if(b(0),l.visible){t(Ft());return}const m=f.touches[0],v=(g=document.getElementById("canvas"))==null?void 0:g.getBoundingClientRect();if(!v)return;const A=m.clientX-v.left,x=m.clientY-v.top,S=lt(A,x,e,i),a=Me(o.current,S,t);[...a[It.STATION],...a[It.MISC_NODE],...a[It.LINE]].length>0?t(ke({visible:!0,position:S,data:a})):(t(pt()),t(Ft()))}else if(f.touches.length==2){t(kt(void 0));const[m,v]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];b(m*m+v*v)}}),u=R(f=>{if(f.touches.length==2&&s>0){const[g,m]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],v=g*g+m*m;let A=e;v-s<0&&e+10<=390?A=e+10:v-s>0&&e-10>=10&&(A=e-10),t(ae(A)),b(v);const x=f.currentTarget.getBoundingClientRect(),[S,a]=[(f.touches[0].clientX+f.touches[1].clientX)/2-x.left,(f.touches[0].clientY+f.touches[1].clientY)/2-x.top],[k,_]=[S/x.width,a/x.height];t(Et({x:i.x+S*e/100-r*A/100*k,y:i.y+a*e/100-p*A/100*_}))}}),d=R(f=>{b(0)});return c.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:p*e/100,fill:l.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:n,onTouchMove:u,onTouchEnd:d})},Jt=10,yn=()=>{const t=St(),e=N.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:l}=O(a=>a.param),{selected:o}=O(a=>a.runtime),s=Dt(),{height:b,width:y}=zt(s),p=N.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),r=N.useCallback((a,k,_)=>{a.stopPropagation(),o.size>0&&(o.forEach(T=>{e.current.hasNode(T)&&(e.current.updateNodeAttribute(T,"x",W=>(W!=null?W:0)+k*Jt),e.current.updateNodeAttribute(T,"y",W=>(W!=null?W:0)+_*Jt))}),p())},[o,p]),n=N.useCallback(a=>r(a,0,-1),[r]),u=N.useCallback(a=>r(a,0,1),[r]),d=N.useCallback(a=>r(a,-1,0),[r]),f=N.useCallback(a=>r(a,1,0),[r]),g=N.useCallback(()=>{if(o.size>0){const a=Nt(e.current,o);navigator.clipboard.writeText(a)}},[o]),m=N.useCallback(()=>{o.size>0&&(t(pt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),p())},[o,t,p]),v=l.x+y*i/200,A=l.y+(b-100)*i/100,x=40,S=40;return c.jsxs("g",{transform:"translate(".concat(v,", ").concat(A,")scale(").concat(1.5*i/100,")"),children:[c.jsxs("g",{transform:"translate(0, -".concat(S,")"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:n}),c.jsx(Ce,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(0, ".concat(S,")"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),c.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", 0)"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:d}),c.jsx(Ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", 0)"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),c.jsx(Ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:g}),c.jsx(_e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:m}),c.jsx(De,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Sn=()=>{const t=St(),e=N.useRef(window.graph),i=N.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),{activeSubscriptions:l}=O(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:b,predictNextNode:y,autoParallel:p,autoChangeStationType:r}}=O(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:u}=O(h=>h.param),{selected:d,active:f,isDetailsOpen:g,mode:m,lastTool:v,keepLastPath:A,theme:x,count:{masters:S,lines:a}}=O(h=>h.runtime),k=Dt(),{height:_,width:T}=zt(k),W=!l.RMP_CLOUD&&S+1>ee,Q=!p||p&&!l.RMP_CLOUD&&a+1>ne,C=de();ze();const[D,q]=N.useState({x:0,y:0}),[V,z]=N.useState({x:0,y:0}),[B,F]=N.useState({isOpen:!1,position:{x:0,y:0}}),[ut,it]=N.useState({x:0,y:0}),[at,E]=N.useState({x:0,y:0}),L=R(async h=>{B.isOpen&&F({isOpen:!1,position:{x:0,y:0}});const{x:j,y:w}=dt(h);if(m.startsWith("station")||m.startsWith("misc-node")){t(xt("free"));const P=vt(10),{x:M,y:I}=lt(j,w,n,u),$=m.startsWith("station"),Z=$?"stn_".concat(P):"misc_node_".concat(P),ot=$?m.slice(8):m.slice(10),gt=structuredClone({...yt,...Mt}[ot].defaultAttrs);re.has(ot)&&(gt.color=x),$&&(gt.names=await C(ot)),e.current.addNode(Z,{visible:!0,zIndex:0,x:K(M,5),y:K(I,5),type:ot,[ot]:gt}),o&&At.event(Pt.ADD_STATION,{type:ot}),i(),t(mt(new Set([Z])))}else m==="free"||m.startsWith("line")?(m.startsWith("line")&&(t(xt("free")),A&&t(Oe(!1))),it({x:j,y:w}),E(u),h.shiftKey||(t(kt("background")),t(pt()))):m==="select"&&(q(lt(j,w,n,u)),z(lt(j,w,n,u)))}),Y=R(h=>{if(m==="select"){if(D.x!=0&&D.y!=0){const{x:j,y:w}=dt(h);z(lt(j,w,n,u))}}else if(f==="background"){const{x:j,y:w}=dt(h);t(Et({x:at.x+(ut.x-j)*n/100,y:at.y+(ut.y-w)*n/100}))}}),tt=R(h=>{if(m==="select"){const{x:j,y:w}=dt(h),{x:P,y:M}=lt(j,w,n,u),I=ce(e.current,D.x,D.y,P,M),$=Xe(e.current,new Set(I));t(mt(new Set([...h.shiftKey?d:[],...I,...$]))),t(xt("free")),q({x:0,y:0}),z({x:0,y:0})}f==="background"&&!h.shiftKey&&t(kt(void 0))}),G=R(h=>{let j=n;h.deltaY>0&&n+10<400?j=n+10:h.deltaY<0&&n-10>0&&(j=n-10),t(ae(j));const{x:w,y:P}=dt(h),M=h.currentTarget.getBoundingClientRect(),[I,$]=[w/M.width,P/M.height];t(Et({x:u.x+w*n/100-T*j/100*I,y:u.y+P*n/100-_*j/100*$}))}),U=R(h=>{h.preventDefault(),dt(h),F({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),H=R(()=>{F({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),J=R(async h=>{if(bt?h.key==="Backspace":h.key==="Delete")d.size>0&&(d.forEach(j=>{if(e.current.hasNode(j))e.current.dropNode(j);else if(e.current.hasEdge(j)){const[w,P]=e.current.extremities(j);e.current.dropEdge(j),r&&w.startsWith("stn")&&_t(e.current,w),r&&P.startsWith("stn")&&_t(e.current,P)}}),t(pt()),i());else if(h.key.startsWith("Arrow")){const w=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,P=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(Et(lt(100*w,100*P,n,u)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const w=(h.key==="j"?-1:h.key==="l"?1:0)*10,P=(h.key==="i"?-1:h.key==="k"?1:0)*10;d.size>0&&d.forEach(M=>{e.current.hasNode(M)&&(e.current.updateNodeAttribute(M,"x",I=>(I!=null?I:0)+w),e.current.updateNodeAttribute(M,"y",I=>(I!=null?I:0)+P),i())})}else if(h.key==="f"&&v)t(xt(v));else if(h.key==="z"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey))bt&&h.preventDefault(),t(We()),t(ht()),t(ft());else if(h.key==="s")t(xt("select"));else if((h.key==="c"||h.key==="x")&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=Nt(e.current,d);navigator.clipboard.writeText(j),h.key==="x"&&(t(pt()),d.forEach(w=>{e.current.hasNode(w)?e.current.dropNode(w):e.current.hasEdge(w)&&e.current.dropEdge(w)}),i())}else if(h.key==="v"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=await navigator.clipboard.readText(),{x:w,y:P}=lt(T/2,_/2,n,u),{nodes:M,edges:I}=se(j,e.current,W,Q,K(w,5),K(P,5));i();const $=structuredClone(M);I.forEach(Z=>$.add(Z)),t(mt($))}else if(bt&&h.key==="z"&&h.metaKey&&h.shiftKey||!bt&&h.key==="y"&&h.ctrlKey)t(Be());else if(h.key==="c")t(Re(!b));else if(h.key==="e"){const[j]=d;if(d.size===1&&e.current.hasEdge(j)){const w=e.current.getEdgeAttributes(j),{type:P}=w;if(P!==nt.Simple&&w[P]){const M=w[P],$=(M.startFrom||"from")==="from"?"to":"from";let Z=w.parallelIndex;if(p){const[gt,ye]=e.current.extremities(j);Z=ie(e.current,P,gt,ye,$)}const ot={...M,startFrom:$};e.current.mergeEdgeAttributes(j,{[P]:ot,parallelIndex:Z}),i()}}}}),[X,st]=N.useState({sx:0,sy:0,ex:0,ey:0});return N.useEffect(()=>{st({sx:D.x<=V.x?D.x:V.x,ex:D.x>V.x?D.x:V.x,sy:D.y<=V.y?D.y:V.y,ey:D.y>V.y?D.y:V.y})},[V.x,V.y]),c.jsxs(c.Fragment,{children:[c.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:_,width:T,viewBox:"".concat(u.x," ").concat(u.y," ").concat(T*n/100," ").concat(_*n/100),onPointerDown:L,onPointerMove:Y,onPointerUp:tt,onWheel:G,onContextMenu:U,tabIndex:0,onKeyDown:J,children:[c.jsx("defs",{children:c.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[c.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),c.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&c.jsx(Ze,{svgViewBoxMin:u,svgViewBoxZoom:n,svgWidth:T,svgHeight:_}),Ht()&&m==="free"&&c.jsx(fn,{}),y&&d.size===1&&m==="free"&&c.jsx(Ge,{}),c.jsx(Ve.SvgAssetsContextProvider,{children:c.jsx(hn,{})}),m==="select"&&D.x!=0&&D.y!=0&&c.jsx("rect",{x:X.sx,y:X.sy,width:X.ex-X.sx,height:X.ey-X.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Ht()&&[...d].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&c.jsx(yn,{}),c.jsx(Ie,{})]}),c.jsx(Ue,{isOpen:B.isOpen,position:B.position,onClose:H}),Le()&&g==="hide"&&c.jsx(me,{"aria-label":"open details panel",icon:c.jsx($e,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(Te()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Sn as default};

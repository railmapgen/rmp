import{ad as te,j as x}from"./chakra-CSR0Uih-.js";import{c as _t,e as Z,a4 as Lt,x as Vt,at as Nt,au as ee,o as wt,av as jt,aw as Ot,L as J,ax as lt,ay as Dt,n as yt,az as ne,d as Yt,r as gt,E as pt,m as Ft,p as q,aA as xt,V as ft,t as bt,v as mt,w as St,aB as se,aC as oe,aD as re,aE as Mt,q as Ut,aF as ut,aG as $t,aH as It,B as kt,S as ie,aI as ae,a1 as ce,aJ as le,F as Pt,aq as de,ar as ue,a6 as he,D as Tt,a2 as ye}from"./index-BT1WLdqB.js";import{s as it,b as Et,r as O,e as rt,g as qt,f as Gt,h as fe,j as ge,k as pe,l as xe,n as me,p as dt,o as Se,q as ve,i as ht,t as we}from"./master-manager-7IdN6Ccd.js";import{b as W,k as Zt}from"./react-eFT_xHYJ.js";import{u as Q,e as be,i as Pe}from"./clipboard-kMbRQJBD.js";import{v as Ae,m as vt}from"./misc-nodes-B6FHp3iy.js";const ke={[Lt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Lt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},_e=t=>{const e=ke[t];return e.at(Math.floor(Math.random()*e.length))},Wt=Zt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:g})=>{const{token:r}=e().account;if(!r){u(Nt({cityName:t,names:[]}));return}const a=await fetch("".concat(ee,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!a.ok)return Vt.warn("Failed to fetch random station names",a.statusText),g(a.statusText);const S=await a.json();u(Nt({cityName:t,names:S}))}),Bt=Zt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var i;const{stationNames:g}=e().runtime,r=g[t];if(((i=r==null?void 0:r.length)!=null?i:0)==0)return Vt.debug("No random station names in cache, using fallback"),u(Wt({cityName:t})),Object.values(_e(t));const a=structuredClone(r),S=a.shift();return u(Nt({cityName:t,names:a})),a.length<3&&u(Wt({cityName:t})),Object.values(S)}),Jt=()=>{const t=_t(),{activeSubscriptions:e}=Z(r=>r.account),{preference:{randomStationsNames:u}}=Z(r=>r.app),g=!e.RMP_CLOUD||u==="none";return W.useCallback(async r=>{const a=it[r].defaultAttrs.names;if(!g){const S=await t(Bt(Lt.Shmetro));if(Bt.fulfilled.match(S)){const i=S.payload;return a.length>i.length?i.push(...Array(a.length-i.length).fill(i.at(-1))):a.length<i.length&&i.splice(a.length),i}}return a},[t,g])},Ce=W.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:g,svgHeight:r}=t,{preference:{toolsPanel:{expand:a}}}=Z(A=>A.app),i=te().colorMode==="light"?"#666464":"#D3D3D4",l=Et(e,u,g,r),o=a?410*u/100:0,n=u>30?u>120?50:25:5,f=u/200,c={startX:O(l.xMin+o-n,n),endX:O(l.xMax+o+n,n),startY:O(l.yMin-n,n),endY:O(l.yMax+n,n)},m=Array.from({length:(c.endX-c.startX)/n+1},(A,y)=>{const w=c.startX+y*n,d=w%(n*5)===0?2*f:f;return x.jsx("line",{x1:w,y1:c.startY,x2:w,y2:c.endY,strokeWidth:d,stroke:i,opacity:"0.5"},"grid_vl_".concat(w))}),h=Array.from({length:(c.endY-c.startY)/n+1},(A,y)=>{const w=c.startY+y*n,d=w%(n*5)===0?2*f:f;return x.jsx("line",{x1:c.startX,y1:w,x2:c.endX,y2:w,strokeWidth:d,stroke:i,opacity:"0.5"},"grid_hl_".concat(w))}),N=Array.from({length:(c.endX-c.startX)/n/5+1},(A,y)=>{const w=O(c.startX,5*n)+y*5*n;return x.jsx("text",{x:w,y:l.yMin+u/5,fontSize:f*25,fill:i,textAnchor:"middle",opacity:"0.5",children:w},"grid_vc_".concat(w))}),b=Array.from({length:(c.endY-c.startY)/n/5+1},(A,y)=>{const w=O(c.startY,5*n)+y*5*n;return x.jsx("text",{x:l.xMin+u/8+o,y:w,fontSize:f*25,fill:i,textAnchor:"start",opacity:"0.5",children:w},"grid_hc_".concat(w))});return x.jsxs("g",{id:"grid-lines",className:"removeMe",children:[m,h,N,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Me=Ae.component,Ht=jt.generatePath,Rt=Ot.component,At=10,Le=()=>{var tt;const t=_t(),e=()=>{t(bt(window.graph.export())),t(mt()),t(St())},{telemetry:{project:u},preference:{autoParallel:g}}=Z(E=>E.app),{selected:r,theme:a,count:{mostFrequentStationType:S}}=Z(E=>E.runtime),i=Jt();if(r.size!==1)return;const l=r.keys().next().value;if(!l.startsWith("stn")&&!l.startsWith("misc_node")||!window.graph.hasNode(l))return;const o=window.graph.neighbors(l);if(o.length===0)return;const n=window.graph.getNodeAttributes(l),f=o.reduce((E,H)=>{const F=window.graph.getNodeAttributes(H);return{x:E.x+F.x,y:E.y+F.y}},{x:0,y:0}),c={x:f.x/o.length,y:f.y/o.length},m={x:n.x-c.x,y:n.y-c.y},h={x:n.x+m.x,y:n.y+m.y},N=Math.sign(m.x)===Math.sign(m.y),b={x:h.x-At,y:h.y+At*(N?1:-1)},A={x:h.x+At,y:h.y+At*(N?-1:1)},y=l.startsWith("stn_")?window.graph.getNodeAttribute(l,"type"):S,w=it[y].component,d={visible:!0,zIndex:0,x:A.x,y:A.y,type:y,[y]:it[y].defaultAttrs},M=window.graph.reduceEdges(l,(E,H)=>{const F=window.graph.getEdgeAttributes(H),{style:ct}=F;if(ct===wt.SingleColor){const et=JSON.stringify(F[ct].color);et in E?E[et]+=1:E[et]=1}return E},{}),$=(tt=Object.entries(M).filter(([E,H])=>H%2!==0).reduce((E,[H,F])=>F>E.count?{color:JSON.parse(H),count:F}:E,{color:null,count:0}).color)!=null?tt:a,D=m.x>0?!(m.x>Math.abs(m.y)):-m.x>Math.abs(m.y),Y=D?"from":"to",B=Ht(n.x,b.x,n.y,b.y,{...jt.defaultAttrs,startFrom:Y}),G=D?"to":"from",nt=Ht(n.x,A.x,n.y,A.y,{...jt.defaultAttrs,startFrom:G}),at=async(E,H)=>{H.stopPropagation();const{x:F,y:ct}=rt(H);t(Dt({x:F,y:ct}));const et=yt(10),st=ne.has(E),P=st?"stn_".concat(et):"misc_node_".concat(et),L=structuredClone({...it,...vt}[E].defaultAttrs);Yt.has(E)&&(L.color=a),st&&(L.names=await i(E)),window.graph.addNode(P,{visible:!0,zIndex:0,x:st?A.x:b.x,y:st?A.y:b.y,type:E,[E]:L}),u&&gt.event(pt.ADD_STATION,{type:E});const R=J.Diagonal,U="line_".concat(yt(10)),[V,T]=[l,P],X=g?Ft(window.graph,R,V,T,"from"):-1,s=st?G:Y;window.graph.addDirectedEdgeWithKey(U,V,T,{visible:!0,zIndex:0,type:R,[R]:{...structuredClone(q[R].defaultAttrs),startFrom:s},style:wt.SingleColor,[wt.SingleColor]:{color:$},reconcileId:"",parallelIndex:X}),u&&gt.event(pt.ADD_LINE,{type:R}),e(),t(xt(P)),t(ft(new Set([P])))};return x.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[x.jsx(Rt,{id:"line_prediction_1",type:J.Diagonal,path:B,styleAttrs:{color:$},newLine:!0,handlePointerDown:()=>{}}),x.jsx(Rt,{id:"line_prediction_2",type:J.Diagonal,path:nt,styleAttrs:{color:$},newLine:!0,handlePointerDown:()=>{}}),x.jsx(Me,{id:"misc_node_virtual_prediction_1",attrs:{},x:b.x,y:b.y,handlePointerDown:(E,H)=>{at(lt.Virtual,H)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),x.jsx(w,{id:"stn_virtual_prediction_2",attrs:d,x:A.x,y:A.y,handlePointerDown:(E,H)=>{at(S,H)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Qt=(t,e,u,g,r,a)=>{if(!("offsetFrom"in a)||!("offsetTo"in a)||Number.isNaN(a.offsetFrom)||Number.isNaN(a.offsetTo))return;if(a.offsetFrom===a.offsetTo)return Xt(t,e,u,g,r)?{x1:e,y1:u,x2:g,y2:r,offset:a.offsetFrom}:void 0;const[S,i]=[a.offsetFrom,a.offsetTo];for(let l=0;l<Math.PI;l+=Math.PI/8)for(let o=l,n=0;n<2;n++,o+=Math.PI){const[f,c,m,h]=[Math.sin(l)*S,Math.cos(l)*S,Math.sin(o)*i,Math.cos(o)*i];if(Xt(t,e+f,u+c,g+m,r+h))return{x1:e+f,y1:u+c,x2:g+m,y2:r+h,offset:0}}},Ne=(t,e,u,g,r,a)=>t===u?{x1:t+5*a,y1:e,x2:u+5*a,y2:g,offset:r}:e===g?{x1:t,y1:e+5*a,x2:u,y2:g+5*a,offset:r}:{x1:t+5*Math.SQRT1_2*a,y1:e+5*Math.SQRT1_2*a,x2:u+5*Math.SQRT1_2*a,y2:g+5*Math.SQRT1_2*a,offset:r},Xt=(t,e,u,g,r)=>!!((e===g||u===r)&&[J.Diagonal,J.Perpendicular].includes(t)||Math.abs((r-u)/(g-e))===1&&[J.Diagonal,J.RotatePerpendicular].includes(t)),je=(t,e)=>{const u=[],g=[];return Object.values(e).forEach(r=>{var A;if(r.length===1){g.push(...r.map(y=>y.edge));return}const a=t.getEdgeAttribute(r.at(0),"type");if(!r.every(y=>t.getEdgeAttribute(y,"type")===a)){g.push(...r.map(y=>y.edge));return}const S=t.getEdgeAttribute(r.at(0),"style");if(!r.every(y=>t.getEdgeAttribute(y,"style")===S)){g.push(...r.map(y=>y.edge));return}const i={},l=new Set,o=new Set,n=Object.fromEntries(r.map(y=>{var M,$;const[w,d]=t.extremities(y);return i[w]=((M=i[w])!=null?M:0)+1,i[d]=(($=i[d])!=null?$:0)+1,l.add(w),o.add(d),[w,[y.edge,d]]})),f=Array.from(l).filter(y=>i[y]===1),c=Array.from(o).filter(y=>i[y]===1);if(f.length!==1||c.length!==1){g.push(...r.map(y=>y.edge));return}const m=f[0],h=c[0];if(m===h){g.push(...r.map(y=>y.edge));return}const N=[n[m][0]];let b=n[m][1];for(let y=1;y<r.length;y=y+1){const w=(A=n[b])==null?void 0:A.at(1);if(!w){g.push(...r.map(d=>d.edge));return}N.push(n[b][0]),b=w}if(b!==h||N.length!==r.length){g.push(...r.map(y=>y.edge));return}u.push(N)}),{allReconciledLines:u,danglingLines:g}},De=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const u=e.map(r=>{var c,m,h;const[a,S]=t.extremities(r),i=t.getNodeAttributes(a),l=t.getNodeAttributes(S),{type:o}=t.getEdgeAttributes(r),n=(c=t.getEdgeAttribute(r,o))!=null?c:q[o].defaultAttrs,f=Qt(o,i.x,i.y,l.x,l.y,n);if(f){const{x1:N,y1:b,x2:A,y2:y,offset:w}=f;return q[J.Simple].generatePath(N,A,b,y,{offset:w})}return(h=(m=q[o])==null?void 0:m.generatePath(i.x,l.x,i.y,l.y,n))!=null?h:"M ".concat(i.x," ").concat(i.y," L ").concat(l.x," ").concat(l.y)});let g="".concat(u[0]," ");for(let r=1;r<e.length;r=r+1)g+=u[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return g},Ee=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ze=t=>{const e={},u={},g=[],r={},a=[];for(const o of t.edgeEntries()){const[n,f,c,m]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y],h=o.attributes[o.attributes.type],N=Qt(o.attributes.type,n,f,c,m,h);u[o.edge]=N}for(const o of t.edgeEntries()){let n=u[o.edge];const{parallelIndex:f}=o.attributes;if(f>=0){const c=se(t,o.attributes.type,o.edge),m=u[c];if(!m){g.push(o);continue}if(f>0){const{x1:h,y1:N,x2:b,y2:A,offset:y}=m;n=Ne(h,N,b,A,y,f)}}if(o.attributes.reconcileId!==""){const c=o.attributes.reconcileId;c in r?r[c].push(o):r[c]=[o];continue}if(n){const c=o.edge,m=o.attributes,{x1:h,y1:N,x2:b,y2:A,offset:y}=n;e[c]={attr:m,path:q[J.Simple].generatePath(h,b,N,A,{offset:y})};continue}a.push(o)}const S=new Set;for(;g.length;){const o=g.pop();if(S.has(o.edge))continue;const{parallel:n}=oe(t,o);if(!n.length)continue;n.forEach(c=>S.add(c.edge));const f=re(n);for(const c of n){const m=c.edge;e[m]={attr:c.attributes,path:f[m]}}}const{allReconciledLines:i,danglingLines:l}=je(t,r);for(const o of i){const n=De(t,o);if(!n)continue;const f=o[0];e[f]={attr:t.getEdgeAttributes(f),path:n}}for(const o of l){const n=t.getEdgeAttributes(o),[f,c]=t.extremities(o),m=t.getNodeAttributes(f),h=t.getNodeAttributes(c);e[o]={attr:n,path:q[J.Simple].generatePath(m.x,h.x,m.y,h.y,q[J.Simple].defaultAttrs)}}for(const o of a){const n=o.edge,f=o.attributes.type,c=o.attributes,[m,h,N,b]=[o.sourceAttributes.x,o.sourceAttributes.y,o.targetAttributes.x,o.targetAttributes.y];if(!(f in q)){e[n]={attr:c,path:"M ".concat(m," ").concat(h," L ").concat(N," ").concat(b)};continue}e[n]={attr:c,path:q[f].generatePath(m,N,h,b,c[f])}}return Object.entries(e).map(([o,n])=>({id:o,type:"line",line:n}))},$e=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=Z(c=>c.param),g=c=>{const h=[{x:c.x,y:c.y},...c.originalNodesPos].sort((b,A)=>b.x===A.x?b.y-A.y:b.x-A.x),N=(h[1].y-h[0].y)/(h[1].x-h[0].x);if(Math.abs(N)<=.01)return{original:h,offset:h.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(N)>=1e10)return{original:h,offset:h.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const A=-1/N,y=10/Math.sqrt(A*A+1),w=10*A/Math.sqrt(A*A+1);return{original:h,offset:h.map(d=>({x:d.x+y,y:d.y+w})),rotate:-Math.atan(A)*(180/Math.PI)}}},{original:r,offset:a,rotate:S}=g(e),i=c=>{const m=Math.sqrt(3)/2*c,h="0,0",N="".concat(-c/2,",").concat(m),b="".concat(c/2,",").concat(m);return"".concat(h," ").concat(N," ").concat(b)},l=u/75,o=8*l,n="#FC8181",f="".concat(l*5," ").concat(l*2);return x.jsxs(x.Fragment,{children:[x.jsx("line",{x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y,stroke:n,strokeWidth:l,strokeDasharray:f}),x.jsx("line",{x1:a[1].x,y1:a[1].y,x2:a[2].x,y2:a[2].y,stroke:n,strokeWidth:l,strokeDasharray:f}),x.jsx("line",{x1:r[0].x,y1:r[0].y,x2:a[0].x,y2:a[0].y,stroke:n,strokeWidth:l,strokeDasharray:f}),x.jsx("line",{x1:r[1].x,y1:r[1].y,x2:a[1].x,y2:a[1].y,stroke:n,strokeWidth:l,strokeDasharray:f}),x.jsx("line",{x1:r[2].x,y1:r[2].y,x2:a[2].x,y2:a[2].y,stroke:n,strokeWidth:l,strokeDasharray:f}),x.jsx("polygon",{points:i(o),transform:"translate(".concat(a[0].x,",").concat(a[0].y,") rotate(").concat((S+270)%360,")"),fill:n}),x.jsx("polygon",{points:i(o),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((S+270)%360,")"),fill:n}),x.jsx("polygon",{points:i(o),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((S+90)%360,")"),fill:n}),x.jsx("polygon",{points:i(o),transform:"translate(".concat(a[2].x,",").concat(a[2].y,") rotate(").concat((S+90)%360,")"),fill:n})]})},Kt=t=>{const{id:e,x:u,y:g,handlePointerDown:r,handlePointerMove:a,handlePointerUp:S}=t,i=W.useCallback(n=>r(e,n),[e,r]),l=W.useCallback(n=>a(e,n),[e,a]),o=W.useCallback(n=>S(e,n),[e,S]);return x.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(g-6.4,")scale(0.025)"),onPointerDown:i,onPointerMove:l,onPointerUp:o,style:{cursor:"move"},children:x.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Ie=t=>{const{id:e,path:u,handlePointerDown:g}=t,r=W.useCallback(a=>g(e,a),[e,g]);return x.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Te=W.memo(t=>{var l,o,n,f,c,m,h,N,b,A,y,w;const{elements:e,handlePointerDown:u,handlePointerMove:g,handlePointerUp:r,handleEdgePointerDown:a}=t,S=Object.fromEntries(Array.from({length:21},(d,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const d of e)if(d.type==="line"){const M=d.line.attr.type,$=d.line.attr.style,D=d.line.attr[$],Y=(l=Mt[$])==null?void 0:l.preComponent;Y&&S[d.line.attr.zIndex].pre.push(x.jsx(Y,{id:d.id,type:M,path:d.line.path,styleAttrs:D,newLine:!1,handlePointerDown:a},"".concat(d.id,".pre")));const B=(n=(o=Mt[$])==null?void 0:o.component)!=null?n:Ie;S[d.line.attr.zIndex].main.push(x.jsx(B,{id:d.id,type:M,path:d.line.path,styleAttrs:D,newLine:!1,handlePointerDown:a},d.id));const G=(f=Mt[$])==null?void 0:f.postComponent;G&&S[d.line.attr.zIndex].post.push(x.jsx(G,{id:d.id,type:M,path:d.line.path,styleAttrs:D,newLine:!1,handlePointerDown:a},"".concat(d.id,".post")))}else if(d.type==="station"){const M=d.station,$=M.type,D=(c=it[$])==null?void 0:c.preComponent;D&&S[d.station.zIndex].pre.push(x.jsx(D,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},"".concat(d.id,".pre")));const Y=(h=(m=it[$])==null?void 0:m.component)!=null?h:Kt;S[d.station.zIndex].main.push(x.jsx(Y,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},d.id));const B=(N=it[$])==null?void 0:N.postComponent;B&&S[d.station.zIndex].post.push(x.jsx(B,{id:d.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},"".concat(d.id,".post")))}else if(d.type==="misc-node"){const M=d.miscNode,$=M.type,D=(b=vt[$])==null?void 0:b.preComponent;D&&S[d.miscNode.zIndex].pre.push(x.jsx(D,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},"".concat(d.id,".pre")));const Y=(y=(A=vt[$])==null?void 0:A.component)!=null?y:Kt;S[d.miscNode.zIndex].main.push(x.jsx(Y,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},d.id));const B=(w=vt[$])==null?void 0:w.postComponent;B&&S[d.miscNode.zIndex].post.push(x.jsx(B,{id:d.id,x:M.x,y:M.y,attrs:M[$],handlePointerDown:u,handlePointerMove:g,handlePointerUp:r},"".concat(d.id,".post")))}return Array.from({length:21},(d,M)=>(M-10).toString()).map(d=>[...S[d].pre,...S[d].main,...S[d].post]).flat()},(t,e)=>t.elements===e.elements),We=[...Object.values(ie),lt.Virtual,lt.Master,lt.LondonArrow,lt.ChongqingRTNumLineBadge2021,lt.ChongqingRTTextLineBadge2021,lt.ChengduRTLineBadge,lt.GzmtrLineBadge],Be=()=>{const t=_t(),e=W.useRef(window.graph),u=()=>{t(bt(e.current.export())),t(mt()),t(St())},{telemetry:{project:g},preference:{autoParallel:r,gridLines:a,snapLines:S}}=Z(P=>P.app),{svgViewBoxZoom:i,svgViewBoxMin:l}=Z(P=>P.param),{selected:o,pointerPosition:n,active:f,refresh:{nodes:c,edges:m},mode:h,keepLastPath:N,theme:b}=Z(P=>P.runtime),A=Ut(),{height:y,width:w}=qt(A),[d,M]=W.useState({dx:0,dy:0}),[$,D]=W.useState([]),[Y,B]=W.useState([]),[G,nt]=W.useState([]);W.useEffect(()=>{if(!n||!S)return;const P=Et(l,i,w,y),L=Gt(e.current,...Object.values(P));B(L),D(fe(e.current,L))},[l,i,w,y,n]);const[at,tt]=W.useState(void 0),E=Q((P,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:R,y:U}=rt(L);h==="select"&&t(ut("free")),nt([]),tt(void 0),t(Dt({x:R,y:U})),t(xt(P)),L.shiftKey?o.has(P)?t($t(P)):t(It(P)):o.has(P)||t(ft(new Set([P])))}),H=Q((P,L)=>{const{x:R,y:U}=rt(L);if(L.currentTarget.setPointerCapture(L.pointerId),h==="free"&&f===P){if(!L.altKey&&S){const V=e.current.getNodeAttribute(P,"x"),T=e.current.getNodeAttribute(P,"y"),X=V-(n.x-R)*i/100,s=T-(n.y-U)*i/100;let v=X,k=s;if(ge(P,e.current)){let p=G,_=at;if(p.length!==0&&(p=p.filter(C=>pe(C,X,s)<=6)),_&&(p.length===0||Math.hypot(X-_.x,s-_.y)>6)&&(_=void 0),!_&&p.length===1){const C=p[0],{snapPoint:I,distance:K}=xe(e.current,Y.filter(ot=>!o.has(ot)),X,s,C);K<=3&&(_=I)}if(p.length===1&&!_||p.length===0){const{l:C,d:I}=me(X,s,$,Y.filter(ot=>!o.has(ot)&&!p.some(Ct=>Ct.node===ot))),K=p.length===0||!p.some(ot=>ot.a===C.a&&ot.b===C.b);I<3&&p.length<2&&K&&p.push(C)}if(p.length===1)if(_)v=_.x,k=_.y;else{const C=p[0];if(C.a==0)k=-C.c/C.b;else if(C.b==0)v=-C.c/C.a;else{const I=-C.a/C.b,K=-C.c/C.b;k=I*v+K}}else if(p.length===2){const C=p[0],I=p[1],K=C.a*I.b-I.a*C.b;K!==0&&(v=-(C.c*I.b-I.c*C.b)/K,k=-(C.a*I.c-I.a*C.c)/K)}nt(p),tt(_)}const j=v-V,z=k-T;o.forEach(p=>{e.current.hasNode(p)&&e.current.updateNodeAttributes(p,_=>({..._,x:O(_.x+j,.01),y:O(_.y+z,.01)}))})}else nt([]),tt(void 0),o.forEach(V=>{e.current.hasNode(V)&&e.current.updateNodeAttributes(V,T=>({...T,x:O(T.x-(n.x-R)*i/100,L.altKey?.01:5),y:O(T.y-(n.y-U)*i/100,L.altKey?.01:5)}))});t(mt()),t(St())}else h.startsWith("line")&&f&&M({dx:(n.x-R)*i/100,dy:(n.y-U)*i/100})}),F=Q((P,L)=>{var R,U,V;if(L.currentTarget.releasePointerCapture(L.pointerId),h.startsWith("line")){N||t(ut("free"));const T=e.current.hasNode(f)&&We.includes(e.current.getNodeAttribute(f,"type")),X=["stn_core_","virtual_circle_","misc_node_connectable_"],v=(V=(U=(R=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:R.attributes)==null?void 0:U.getNamedItem("id"))==null?void 0:V.value,k=X.find(j=>v==null?void 0:v.startsWith(j));if(T&&k){const j=h.slice(5),z="line_".concat(yt(10)),[p,_]=[f,v.slice(k.length)];if(p!==_){const C=r?Ft(e.current,j,p,_,"from"):-1;e.current.addDirectedEdgeWithKey(z,p,_,{visible:!0,zIndex:0,type:j,[j]:structuredClone(q[j].defaultAttrs),style:wt.SingleColor,[wt.SingleColor]:{color:b},reconcileId:"",parallelIndex:C}),t(ft(new Set([z]))),g&&gt.event(pt.ADD_LINE,{type:j}),t(bt(e.current.export())),t(St())}}}else if(h==="free"&&f){const{x:T,y:X}=rt(L);n.x-T===0&&n.y-X===0||(t(bt(e.current.export())),t(mt()))}nt([]),tt(void 0),Dt(void 0),t(xt(void 0))}),ct=Q((P,L)=>{if(L.stopPropagation(),L.shiftKey||t(kt()),L.shiftKey&&o.has(P)?t($t(P)):t(It(P)),h.startsWith("station")||h.startsWith("misc-node-virtual")||h.startsWith("misc-node-master")){const R=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,U=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,V=h.startsWith("station"),T=yt(10),X=V?"stn_".concat(T):"misc_node_".concat(T),s=V?h.slice(8):h.slice(10),{x:v,y:k}=dt(R,U,i,l),j=V?structuredClone(it[s].defaultAttrs):structuredClone(vt[s].defaultAttrs);"color"in j&&(j.color=b),e.current.addNode(X,{visible:!0,zIndex:0,x:O(v,5),y:O(k,5),type:s,[s]:j});const z=e.current.getEdgeAttributes(P),{zIndex:p,type:_,style:C}=z,I=z[_],K=z[C],[ot,Ct]=e.current.extremities(P),zt=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(yt(10)),ot,X,{visible:!0,zIndex:p,type:_,[_]:structuredClone(I),style:C,[C]:structuredClone(K),reconcileId:"",parallelIndex:zt}),e.current.addDirectedEdgeWithKey("line_".concat(yt(10)),X,Ct,{visible:!0,zIndex:p,type:_,[_]:structuredClone(I),style:C,[C]:structuredClone(K),reconcileId:"",parallelIndex:zt}),e.current.dropEdge(P),u(),g&&(gt.event(pt.ADD_STATION,{type:s}),gt.event(pt.ADD_LINE,{type:_})),t(ut("free")),t(ft(new Set([X])))}}),et=W.useMemo(()=>[...ze(e.current),...Ee(e.current)],[m,c]),st=Ot.component;return x.jsxs(x.Fragment,{children:[x.jsx(Te,{elements:et,handlePointerDown:E,handlePointerMove:H,handlePointerUp:F,handleEdgePointerDown:ct}),h.startsWith("line")&&f&&f!=="background"&&x.jsx(st,{id:"line_create_in_progress___no_use",type:h.slice(5),path:q[h.slice(5)].generatePath(e.current.getNodeAttribute(f,"x"),e.current.getNodeAttribute(f,"x")-d.dx,e.current.getNodeAttribute(f,"y"),e.current.getNodeAttribute(f,"y")-d.dy,q[h.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}}),G.length!==0&&G.map(P=>x.jsx("path",{d:q[J.Simple].generatePath(...Se(P,Et(l,i,w,y)),q[J.Simple].defaultAttrs),stroke:"cyan",strokeWidth:i/75},"snap_line_".concat(P.a,"_").concat(P.b,"_").concat(P.c,"_").concat(P.node))),at&&x.jsx($e,{activeSnapPoint:at})]})},Ye=()=>{const t=_t(),e=W.useRef(window.graph),u=()=>{t(bt(e.current.export())),t(mt()),t(St())},{activeSubscriptions:g}=Z(s=>s.account),{telemetry:{project:r},preference:{gridLines:a,snapLines:S}}=Z(s=>s.app),{svgViewBoxZoom:i,svgViewBoxMin:l}=Z(s=>s.param),{mode:o,lastTool:n,active:f,selected:c,keepLastPath:m,theme:h,count:{masters:N,lines:b}}=Z(s=>s.runtime),A=Ut(),{height:y,width:w}=qt(A),d=!g.RMP_CLOUD&&N+1>ae,M=!g.RMP_CLOUD&&b+1>ce,$=Jt();le();const[D,Y]=W.useState({x:0,y:0}),[B,G]=W.useState({x:0,y:0}),[nt,at]=W.useState({x:0,y:0}),[tt,E]=W.useState({x:0,y:0}),H=Q(async s=>{const{x:v,y:k}=rt(s);if(o.startsWith("station")||o.startsWith("misc-node")){t(ut("free"));const j=yt(10),{x:z,y:p}=dt(v,k,i,l),_=o.startsWith("station"),C=_?"stn_".concat(j):"misc_node_".concat(j),I=_?o.slice(8):o.slice(10),K=structuredClone({...it,...vt}[I].defaultAttrs);Yt.has(I)&&(K.color=h),_&&(K.names=await $(I)),e.current.addNode(C,{visible:!0,zIndex:0,x:O(z,5),y:O(p,5),type:I,[I]:K}),r&&gt.event(pt.ADD_STATION,{type:I}),u(),t(ft(new Set([C])))}else o==="free"||o.startsWith("line")?(o.startsWith("line")&&(t(ut("free")),m&&t(ye(!1))),at({x:v,y:k}),E(l),s.shiftKey||(t(xt("background")),t(kt()))):o==="select"&&(Y(dt(v,k,i,l)),G(dt(v,k,i,l)))}),F=Q(s=>{if(o==="select"){if(D.x!=0&&D.y!=0){const{x:v,y:k}=rt(s);G(dt(v,k,i,l))}}else if(f==="background"){const{x:v,y:k}=rt(s);t(Pt({x:tt.x+(nt.x-v)*i/100,y:tt.y+(nt.y-k)*i/100}))}}),ct=Q(s=>{if(o==="select"){const{x:v,y:k}=rt(s),{x:j,y:z}=dt(v,k,i,l),p=Gt(e.current,D.x,D.y,j,z),_=we(e.current,new Set(p));t(ft(new Set([...s.shiftKey?c:[],...p,..._]))),t(ut("free")),Y({x:0,y:0}),G({x:0,y:0})}f==="background"&&!s.shiftKey&&t(xt(void 0))}),et=Q(s=>{let v=i;s.deltaY>0&&i+10<400?v=i+10:s.deltaY<0&&i-10>0&&(v=i-10),t(Tt(v));const{x:k,y:j}=rt(s),z=s.currentTarget.getBoundingClientRect(),[p,_]=[k/z.width,j/z.height];t(Pt({x:l.x+k*i/100-w*v/100*p,y:l.y+j*i/100-y*v/100*_}))}),st=Q(async s=>{if(ht?s.key==="Backspace":s.key==="Delete")c.size>0&&(c.forEach(v=>{e.current.hasNode(v)?e.current.dropNode(v):e.current.hasEdge(v)&&e.current.dropEdge(v)}),t(kt()),u());else if(s.key.startsWith("Arrow")){const k=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,j=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;t(Pt(dt(100*k,100*j,i,l)))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const k=(s.key==="j"?-1:s.key==="l"?1:0)*10,j=(s.key==="i"?-1:s.key==="k"?1:0)*10;c.size>0&&c.forEach(z=>{e.current.hasNode(z)&&(e.current.updateNodeAttribute(z,"x",p=>(p!=null?p:0)+k),e.current.updateNodeAttribute(z,"y",p=>(p!=null?p:0)+j),u())})}else if(s.key==="f"&&n)t(ut(n));else if(s.key==="z"&&(ht?s.metaKey&&!s.shiftKey:s.ctrlKey))ht&&s.preventDefault(),t(de()),t(mt()),t(St());else if(s.key==="s")t(ut("select"));else if((s.key==="c"||s.key==="x")&&(ht?s.metaKey&&!s.shiftKey:s.ctrlKey)){const v=be(e.current,c);navigator.clipboard.writeText(v),s.key==="x"&&(t(kt()),c.forEach(k=>{e.current.hasNode(k)?e.current.dropNode(k):e.current.hasEdge(k)&&e.current.dropEdge(k)}),u())}else if(s.key==="v"&&(ht?s.metaKey&&!s.shiftKey:s.ctrlKey)){const v=await navigator.clipboard.readText(),{x:k,y:j}=dt(w/2,y/2,i,l),{nodes:z,edges:p}=Pe(v,e.current,d,M,O(k,5),O(j,5));u();const _=structuredClone(z);p.forEach(C=>_.add(C)),t(ft(_))}else ht&&s.key==="z"&&s.metaKey&&s.shiftKey||!ht&&s.key==="y"&&s.ctrlKey?t(ue()):s.key==="c"&&t(he(!S))}),[P,L]=W.useState(0),R=Q(s=>{if(s.touches.length===2){t(xt(void 0));const[v,k]=[s.touches[0].clientX-s.touches[1].clientX,s.touches[0].clientY-s.touches[1].clientY];L(v*v+k*k)}}),U=Q(s=>{if(P!==0&&s.touches.length===2){const[v,k]=[s.touches[0].clientX-s.touches[1].clientX,s.touches[0].clientY-s.touches[1].clientY],j=v*v+k*k;let z=i;j-P<0&&i+10<=390?z=i+10:j-P>0&&i-10>=10&&(z=i-10),t(Tt(z)),L(j);const p=s.currentTarget.getBoundingClientRect(),[_,C]=[(s.touches[0].clientX+s.touches[1].clientX)/2-p.left,(s.touches[0].clientY+s.touches[1].clientY)/2-p.top],[I,K]=[_/p.width,C/p.height];t(Pt({x:l.x+_*i/100-w*z/100*I,y:l.y+C*i/100-y*z/100*K}))}}),V=Q(s=>{P!==0&&L(0)}),[T,X]=W.useState({sx:0,sy:0,ex:0,ey:0});return W.useEffect(()=>{X({sx:D.x<=B.x?D.x:B.x,ex:D.x>B.x?D.x:B.x,sy:D.y<=B.y?D.y:B.y,ey:D.y>B.y?D.y:B.y})},[B.x,B.y]),x.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:y,width:w,viewBox:"".concat(l.x," ").concat(l.y," ").concat(w*i/100," ").concat(y*i/100),onPointerDown:H,onPointerMove:F,onPointerUp:ct,onTouchStart:R,onTouchMove:U,onTouchEnd:V,onWheel:et,tabIndex:0,onKeyDown:st,children:[a&&x.jsx(Ce,{svgViewBoxMin:l,svgViewBoxZoom:i,svgWidth:w,svgHeight:y}),x.jsx(Le,{}),x.jsx(ve.SvgAssetsContextProvider,{children:x.jsx(Be,{})}),o==="select"&&D.x!=0&&D.y!=0&&x.jsx("rect",{x:T.sx,y:T.sy,width:T.ex-T.sx,height:T.ey-T.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),x.jsx("defs",{children:x.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[x.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),x.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Ye as default};

import{a as me,j as l,P as be,B as oe,D as Kt,ad as Se,a2 as ve}from"./chakra-C1zJvDsN.js";import{c as wt,e as Y,a7 as Rt,z as re,ay as Bt,az as we,aA as ie,a4 as ae,w as vt,x as ft,y as xt,F as mt,Y as lt,aB as U,X as at,aC as Ot,p as Nt,aD as Xt,aE as ce,L as st,aF as ot,aG as dt,aH as Yt,n as St,aI as Ae,d as le,r as At,E as Mt,q as nt,aJ as kt,aK as Me,aL as Pe,aM as ke,aN as zt,t as It,v as Lt,aO as gt,aP as Ut,aQ as Zt,o as de,aR as Ne,S as Ee,aS as Tt,aT as jt,aU as je,aV as Ce,aW as De,aX as _e,aY as $e,aZ as Ie,G as ue,H as _t,a_ as Le,a$ as ze,b0 as Te,b1 as We,b2 as Re,ag as bt,av as Be,aw as Oe,a9 as Xe,a5 as Ye}from"./index-v42gBtSe.js";import{s as yt,f as he,c as Ve,e as Fe}from"./master-manager-vzXltPC-.js";import{b as $,k as fe,u as He,r as qt}from"./react-BpF4RbzH.js";import{u as B,e as $t,i as Ht}from"./clipboard-BGmz7R4I.js";import{v as Ke,m as Pt}from"./misc-nodes-D1Y_haox.js";const Ue={[Rt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Rt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ze=t=>{const e=Ue[t];return e.at(Math.floor(Math.random()*e.length))},Gt=fe("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:h})=>{const{token:r}=e().account;if(!r){i(Bt({cityName:t,names:[]}));return}const o=await fetch("".concat(we,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!o.ok)return re.warn("Failed to fetch random station names",o.statusText),h(o.statusText);const y=await o.json();i(Bt({cityName:t,names:y}))}),Qt=fe("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var x;const{stationNames:h}=e().runtime,r=h[t];if(((x=r==null?void 0:r.length)!=null?x:0)==0)return re.debug("No random station names in cache, using fallback"),i(Gt({cityName:t})),Object.values(Ze(t));const o=structuredClone(r),y=o.shift();return i(Bt({cityName:t,names:o})),o.length<3&&i(Gt({cityName:t})),Object.values(y)}),xe=()=>{const t=wt(),{activeSubscriptions:e}=Y(r=>r.account),{preference:{randomStationsNames:i}}=Y(r=>r.app),h=!e.RMP_CLOUD||i==="none";return $.useCallback(async r=>{const o=yt[r].defaultAttrs.names;if(!h){const y=await t(Qt(Rt.Shmetro));if(Qt.fulfilled.match(y)){const x=y.payload;return o.length>x.length?x.push(...Array(o.length-x.length).fill(x.at(-1))):o.length<x.length&&x.splice(o.length),x}}return structuredClone(o)},[t,h])},qe=({isOpen:t,position:e,onClose:i})=>{const{t:h}=He(),r=wt(),o=$.useRef(window.graph),{selected:y,count:{masters:x,lines:m}}=Y(M=>M.runtime),{svgViewBoxZoom:n,svgViewBoxMin:s}=Y(M=>M.param),{activeSubscriptions:a}=Y(M=>M.account),u=!a.RMP_CLOUD&&x+1>ie,S=!a.RMP_CLOUD&&m+1>ae,c=y.size>0,w=$.useRef(null);me({ref:w,handler:i,enabled:t});const f=$.useCallback(()=>{r(vt(o.current.export())),r(ft()),r(xt())},[r]),v=B(()=>{if(y.size>0){const M=$t(o.current,y);navigator.clipboard.writeText(M)}}),g=B(()=>{if(y.size>0){const M=$t(o.current,y);navigator.clipboard.writeText(M),r(mt()),y.forEach(C=>{o.current.hasNode(C)?o.current.dropNode(C):o.current.hasEdge(C)&&o.current.dropEdge(C)}),f()}}),b=B(async()=>{try{const M=await navigator.clipboard.readText(),{x:C,y:F}=lt(e.x,e.y,n,s),{nodes:O,edges:Q}=Ht(M,o.current,u,S,U(C,5),U(F,5));f();const I=structuredClone(O);Q.forEach(R=>I.add(R)),r(at(I))}catch(M){console.warn("Failed to read clipboard:",M)}}),d=B(()=>{y.size>0&&(r(mt()),y.forEach(M=>{o.current.hasNode(M)?o.current.dropNode(M):o.current.hasEdge(M)&&o.current.dropEdge(M)}),f())}),A=B(()=>{r(ft()),r(xt())}),N=B(M=>{if(y.size>0){const C=Math.min(Math.max(M,-10),10);y.forEach(F=>{o.current.hasNode(F)&&o.current.setNodeAttribute(F,"zIndex",C),o.current.hasEdge(F)&&o.current.setEdgeAttribute(F,"zIndex",C)}),f()}}),z=B(()=>{if(y.size>0){const[M]=y,C=o.current.hasNode(M)?o.current.getNodeAttribute(M,"zIndex"):o.current.hasEdge(M)?o.current.getEdgeAttribute(M,"zIndex"):0;N(C+1)}}),W=B(()=>{if(y.size>0){const[M]=y,C=o.current.hasNode(M)?o.current.getNodeAttribute(M,"zIndex"):o.current.hasEdge(M)?o.current.getEdgeAttribute(M,"zIndex"):0;N(C-1)}});return t?l.jsx(be,{children:l.jsxs(oe,{ref:w,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[l.jsx(ct,{onClick:()=>{A(),i()},children:h("contextMenu.refresh")}),l.jsx(Kt,{}),l.jsx(ct,{onClick:()=>{v(),i()},isDisabled:!c,children:h("contextMenu.copy")}),l.jsx(ct,{onClick:()=>{g(),i()},isDisabled:!c,children:h("contextMenu.cut")}),l.jsx(ct,{onClick:()=>{b(),i()},children:h("contextMenu.paste")}),l.jsx(ct,{onClick:()=>{d(),i()},isDisabled:!c,children:h("contextMenu.delete")}),l.jsx(Kt,{}),l.jsx(ct,{onClick:()=>{N(10),i()},isDisabled:!c,children:h("contextMenu.placeTop")}),l.jsx(ct,{onClick:()=>{N(-10),i()},isDisabled:!c,children:h("contextMenu.placeBottom")}),l.jsx(ct,{onClick:()=>{N(0),i()},isDisabled:!c,children:h("contextMenu.placeDefault")}),l.jsx(ct,{onClick:()=>{z(),i()},isDisabled:!c,children:h("contextMenu.placeUp")}),l.jsx(ct,{onClick:()=>{W(),i()},isDisabled:!c,children:h("contextMenu.placeDown")})]})}):null},ct=({children:t,onClick:e,isDisabled:i=!1})=>l.jsx(oe,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),Ge=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:h,svgHeight:r}=t,{preference:{toolsPanel:{expand:o}}}=Y(v=>v.app),x=Se().colorMode==="light"?"#666464":"#D3D3D4",m=Ot(e,i,h,r),n=o?410*i/100:0,s=i>30?i>120?50:25:5,a=i/200,u={startX:U(m.xMin+n-s,s),endX:U(m.xMax+n+s,s),startY:U(m.yMin-s,s),endY:U(m.yMax+s,s)},S=Array.from({length:(u.endX-u.startX)/s+1},(v,g)=>{const b=u.startX+g*s,d=b%(s*5)===0?2*a:a;return l.jsx("line",{x1:b,y1:u.startY,x2:b,y2:u.endY,strokeWidth:d,stroke:x,opacity:"0.5"},"grid_vl_".concat(b))}),c=Array.from({length:(u.endY-u.startY)/s+1},(v,g)=>{const b=u.startY+g*s,d=b%(s*5)===0?2*a:a;return l.jsx("line",{x1:u.startX,y1:b,x2:u.endX,y2:b,strokeWidth:d,stroke:x,opacity:"0.5"},"grid_hl_".concat(b))}),w=Array.from({length:(u.endX-u.startX)/s/5+1},(v,g)=>{const b=U(u.startX,5*s)+g*5*s;return l.jsx("text",{x:b,y:m.yMin+i/5,fontSize:a*25,fill:x,textAnchor:"middle",opacity:"0.5",children:b},"grid_vc_".concat(b))}),f=Array.from({length:(u.endY-u.startY)/s/5+1},(v,g)=>{const b=U(u.startY,5*s)+g*5*s;return l.jsx("text",{x:m.xMin+i/8+n,y:b,fontSize:a*25,fill:x,textAnchor:"start",opacity:"0.5",children:b},"grid_hc_".concat(b))});return l.jsxs("g",{id:"grid-lines",className:"removeMe",children:[S,c,w,f]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Qe=Ke.component,Jt=Xt.generatePath,te=ce.component,Ct=10,Je=()=>{var Q;const t=wt(),e=()=>{t(vt(window.graph.export())),t(ft()),t(xt())},{telemetry:{project:i},preference:{autoParallel:h}}=Y(I=>I.app),{selected:r,theme:o,count:{mostFrequentStationType:y}}=Y(I=>I.runtime),x=xe(),m=r.keys().next().value;if(!m.startsWith("stn")&&!m.startsWith("misc_node")||!window.graph.hasNode(m))return;const n=window.graph.neighbors(m);if(n.length===0)return;const s=window.graph.getNodeAttributes(m),a=n.reduce((I,R)=>{const J=window.graph.getNodeAttributes(R);return{x:I.x+J.x,y:I.y+J.y}},{x:0,y:0}),u={x:a.x/n.length,y:a.y/n.length},S={x:s.x-u.x,y:s.y-u.y},c={x:s.x+S.x,y:s.y+S.y},w=Math.sign(S.x)===Math.sign(S.y),f={x:c.x-Ct,y:c.y+Ct*(w?1:-1)},v={x:c.x+Ct,y:c.y+Ct*(w?-1:1)},g=m.startsWith("stn_")?window.graph.getNodeAttribute(m,"type"):y,b=yt[g].component,d={visible:!0,zIndex:0,x:v.x,y:v.y,type:g,[g]:yt[g].defaultAttrs},A=window.graph.reduceEdges(m,(I,R)=>{const J=window.graph.getEdgeAttributes(R),{style:pt}=J;if(pt===Nt.SingleColor){const rt=JSON.stringify(J[pt].color);rt in I?I[rt]+=1:I[rt]=1}return I},{}),N=(Q=Object.entries(A).filter(([I,R])=>R%2!==0).reduce((I,[R,J])=>J>I.count?{color:JSON.parse(R),count:J}:I,{color:null,count:0}).color)!=null?Q:o,z=S.x>0?!(S.x>Math.abs(S.y)):-S.x>Math.abs(S.y),W=z?"from":"to",M=Jt(s.x,f.x,s.y,f.y,{...Xt.defaultAttrs,startFrom:W}),C=z?"to":"from",F=Jt(s.x,v.x,s.y,v.y,{...Xt.defaultAttrs,startFrom:C}),O=async(I,R)=>{R.stopPropagation();const{x:J,y:pt}=dt(R);t(Yt({x:J,y:pt}));const rt=St(10),ut=Ae.has(I),D=ut?"stn_".concat(rt):"misc_node_".concat(rt),L=structuredClone({...yt,...Pt}[I].defaultAttrs);le.has(I)&&(L.color=o),ut&&(L.names=await x(I)),window.graph.addNode(D,{visible:!0,zIndex:0,x:ut?v.x:f.x,y:ut?v.y:f.y,type:I,[I]:L}),i&&At.event(Mt.ADD_STATION,{type:I});const Z=st.Diagonal,tt="line_".concat(St(10)),[G,q]=[m,D],H=h?0:-1,X=ut?C:W;window.graph.addDirectedEdgeWithKey(tt,G,q,{visible:!0,zIndex:0,type:Z,[Z]:{...structuredClone(nt[Z].defaultAttrs),startFrom:X},style:Nt.SingleColor,[Nt.SingleColor]:{color:N},reconcileId:"",parallelIndex:H}),i&&At.event(Mt.ADD_LINE,{type:Z}),e(),t(kt(D)),t(at(new Set([D])))};return l.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[l.jsx(te,{id:"line_prediction_1",type:st.Diagonal,path:M,styleAttrs:{color:N},newLine:!0,handlePointerDown:()=>{}}),l.jsx(te,{id:"line_prediction_2",type:st.Diagonal,path:F,styleAttrs:{color:N},newLine:!0,handlePointerDown:()=>{}}),l.jsx(Qe,{id:"misc_node_virtual_prediction_1",attrs:{},x:f.x,y:f.y,handlePointerDown:(I,R)=>{O(ot.Virtual,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),l.jsx(b,{id:"stn_virtual_prediction_2",attrs:d,x:v.x,y:v.y,handlePointerDown:(I,R)=>{O(y,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},ye=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Master&&e.getNodeAttributes(t)[ot.Master].nodeType==="Station",tn=(t,e)=>{const i=[];return e.filter(h=>ye(h,t)).forEach(h=>{const r=t.getNodeAttribute(h,"x"),o=t.getNodeAttribute(h,"y");i.push({a:1,b:0,c:-r,node:h,x:r,y:o}),i.push({a:0,b:1,c:-o,node:h,x:r,y:o}),i.push({a:1,b:-1,c:-r+o,node:h,x:r,y:o}),i.push({a:1,b:1,c:-r-o,node:h,x:r,y:o})}),i},pe=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),en=(t,e,i,h)=>{let r=1/0,o={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(y=>h.includes(y.node)).forEach(y=>{const x=pe(y,t,e);x<r&&(r=x,o=y)}),{l:o,d:r}},nn=(t,e,i,h,r)=>{const o=e.filter(n=>{const s=t.getNodeAttribute(n,"x"),a=t.getNodeAttribute(n,"y");return Math.abs(r.a*s+r.b*a+r.c)<=.01}),y=[(n,s,a,u)=>[(n+a)/2,(s+u)/2],(n,s,a,u)=>[2*n-a,2*s-u],(n,s,a,u)=>[2*a-n,2*u-s]];let x=1/0,m={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let n=0;n<o.length;n++){const s=o[n],a=t.getNodeAttribute(s,"x"),u=t.getNodeAttribute(s,"y");for(let S=n+1;S<o.length;S++){const c=o[S],w=t.getNodeAttribute(c,"x"),f=t.getNodeAttribute(c,"y");y.forEach(v=>{const[g,b]=v(a,u,w,f),d=Math.hypot(i-g,h-b);d<x&&(x=d,m={x:g,y:b,originalNodesPos:[{x:a,y:u},{x:w,y:f}]})})}}return{snapPoint:m,distance:x}},ge=(t,e,i,h,r,o)=>{if(!("offsetFrom"in o)||!("offsetTo"in o)||Number.isNaN(o.offsetFrom)||Number.isNaN(o.offsetTo))return;if(o.offsetFrom===o.offsetTo)return ee(t,e,i,h,r)?{x1:e,y1:i,x2:h,y2:r,offset:o.offsetFrom}:void 0;const[y,x]=[o.offsetFrom,o.offsetTo];for(let m=0;m<Math.PI;m+=Math.PI/8)for(let n=m,s=0;s<2;s++,n+=Math.PI){const[a,u,S,c]=[Math.sin(m)*y,Math.cos(m)*y,Math.sin(n)*x,Math.cos(n)*x];if(ee(t,e+a,i+u,h+S,r+c))return{x1:e+a,y1:i+u,x2:h+S,y2:r+c,offset:0}}},sn=(t,e,i,h,r,o)=>t===i?{x1:t+5*o,y1:e,x2:i+5*o,y2:h,offset:r}:e===h?{x1:t,y1:e+5*o,x2:i,y2:h+5*o,offset:r}:{x1:t+5*Math.SQRT1_2*o,y1:e+5*Math.SQRT1_2*o,x2:i+5*Math.SQRT1_2*o,y2:h+5*Math.SQRT1_2*o,offset:r},ee=(t,e,i,h,r)=>!!((e===h||i===r)&&[st.Diagonal,st.Perpendicular].includes(t)||Math.abs((r-i)/(h-e))===1&&[st.Diagonal,st.RotatePerpendicular].includes(t)),on=(t,e)=>{const i=[],h=[];return Object.values(e).forEach(r=>{var v;if(r.length===1){h.push(...r.map(g=>g.edge));return}const o=t.getEdgeAttribute(r.at(0),"type");if(!r.every(g=>t.getEdgeAttribute(g,"type")===o)){h.push(...r.map(g=>g.edge));return}const y=t.getEdgeAttribute(r.at(0),"style");if(!r.every(g=>t.getEdgeAttribute(g,"style")===y)){h.push(...r.map(g=>g.edge));return}const x={},m=new Set,n=new Set,s=Object.fromEntries(r.map(g=>{var A,N;const[b,d]=t.extremities(g);return x[b]=((A=x[b])!=null?A:0)+1,x[d]=((N=x[d])!=null?N:0)+1,m.add(b),n.add(d),[b,[g.edge,d]]})),a=Array.from(m).filter(g=>x[g]===1),u=Array.from(n).filter(g=>x[g]===1);if(a.length!==1||u.length!==1){h.push(...r.map(g=>g.edge));return}const S=a[0],c=u[0];if(S===c){h.push(...r.map(g=>g.edge));return}const w=[s[S][0]];let f=s[S][1];for(let g=1;g<r.length;g=g+1){const b=(v=s[f])==null?void 0:v.at(1);if(!b){h.push(...r.map(d=>d.edge));return}w.push(s[f][0]),f=b}if(f!==c||w.length!==r.length){h.push(...r.map(g=>g.edge));return}i.push(w)}),{allReconciledLines:i,danglingLines:h}},rn=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const i=e.map(r=>{var u,S,c;const[o,y]=t.extremities(r),x=t.getNodeAttributes(o),m=t.getNodeAttributes(y),{type:n}=t.getEdgeAttributes(r),s=(u=t.getEdgeAttribute(r,n))!=null?u:nt[n].defaultAttrs,a=ge(n,x.x,x.y,m.x,m.y,s);if(a){const{x1:w,y1:f,x2:v,y2:g,offset:b}=a;return nt[st.Simple].generatePath(w,v,f,g,{offset:b})}return(c=(S=nt[n])==null?void 0:S.generatePath(x.x,m.x,x.y,m.y,s))!=null?c:"M ".concat(x.x," ").concat(x.y," L ").concat(m.x," ").concat(m.y)});let h="".concat(i[0]," ");for(let r=1;r<e.length;r=r+1)h+=i[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return h},an=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),cn=t=>{const e={},i={},h=[],r={},o=[];for(const n of t.edgeEntries()){const[s,a,u,S]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y],c=n.attributes[n.attributes.type],w=ge(n.attributes.type,s,a,u,S,c);i[n.edge]=w}for(const n of t.edgeEntries()){let s=i[n.edge];const{parallelIndex:a}=n.attributes;if(a>=0){const u=Me(t,n.attributes.type,n.edge),S=i[u];if(!S){h.push(n);continue}if(a>0){const{x1:c,y1:w,x2:f,y2:v,offset:g}=S;s=sn(c,w,f,v,g,a)}}if(n.attributes.reconcileId!==""){const u=n.attributes.reconcileId;u in r?r[u].push(n):r[u]=[n];continue}if(s){const u=n.edge,S=n.attributes,{x1:c,y1:w,x2:f,y2:v,offset:g}=s;e[u]={attr:S,path:nt[st.Simple].generatePath(c,f,w,v,{offset:g})};continue}o.push(n)}const y=new Set;for(;h.length;){const n=h.pop();if(y.has(n.edge))continue;const{parallel:s}=Pe(t,n);if(!s.length)continue;s.forEach(u=>y.add(u.edge));const a=ke(s);for(const u of s){const S=u.edge;e[S]={attr:u.attributes,path:a[S]}}}const{allReconciledLines:x,danglingLines:m}=on(t,r);for(const n of x){const s=rn(t,n);if(!s)continue;const a=n[0];e[a]={attr:t.getEdgeAttributes(a),path:s}}for(const n of m){const s=t.getEdgeAttributes(n),[a,u]=t.extremities(n),S=t.getNodeAttributes(a),c=t.getNodeAttributes(u);e[n]={attr:s,path:nt[st.Simple].generatePath(S.x,c.x,S.y,c.y,nt[st.Simple].defaultAttrs)}}for(const n of o){const s=n.edge,a=n.attributes.type,u=n.attributes,[S,c,w,f]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y];if(!(a in nt)){e[s]={attr:u,path:"M ".concat(S," ").concat(c," L ").concat(w," ").concat(f)};continue}e[s]={attr:u,path:nt[a].generatePath(S,w,c,f,u[a])}}return Object.entries(e).map(([n,s])=>({id:n,type:"line",line:s}))},ln=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=Y(u=>u.param),h=u=>{const c=[{x:u.x,y:u.y},...u.originalNodesPos].sort((f,v)=>f.x===v.x?f.y-v.y:f.x-v.x),w=(c[1].y-c[0].y)/(c[1].x-c[0].x);if(Math.abs(w)<=.01)return{original:c,offset:c.map(f=>({x:f.x,y:f.y+10})),rotate:0};if(Math.abs(w)>=1e10)return{original:c,offset:c.map(f=>({x:f.x+10,y:f.y})),rotate:90};{const v=-1/w,g=10/Math.sqrt(v*v+1),b=10*v/Math.sqrt(v*v+1);return{original:c,offset:c.map(d=>({x:d.x+g,y:d.y+b})),rotate:-Math.atan(v)*(180/Math.PI)}}},{original:r,offset:o,rotate:y}=h(e),x=u=>{const S=Math.sqrt(3)/2*u,c="0,0",w="".concat(-u/2,",").concat(S),f="".concat(u/2,",").concat(S);return"".concat(c," ").concat(w," ").concat(f)},m=i/75,n=8*m,s="#FC8181",a="".concat(m*5," ").concat(m*2);return l.jsxs(l.Fragment,{children:[l.jsx("line",{x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y,stroke:s,strokeWidth:m,strokeDasharray:a}),l.jsx("line",{x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y,stroke:s,strokeWidth:m,strokeDasharray:a}),l.jsx("line",{x1:r[0].x,y1:r[0].y,x2:o[0].x,y2:o[0].y,stroke:s,strokeWidth:m,strokeDasharray:a}),l.jsx("line",{x1:r[1].x,y1:r[1].y,x2:o[1].x,y2:o[1].y,stroke:s,strokeWidth:m,strokeDasharray:a}),l.jsx("line",{x1:r[2].x,y1:r[2].y,x2:o[2].x,y2:o[2].y,stroke:s,strokeWidth:m,strokeDasharray:a}),l.jsx("polygon",{points:x(n),transform:"translate(".concat(o[0].x,",").concat(o[0].y,") rotate(").concat((y+270)%360,")"),fill:s}),l.jsx("polygon",{points:x(n),transform:"translate(".concat(o[1].x,",").concat(o[1].y,") rotate(").concat((y+270)%360,")"),fill:s}),l.jsx("polygon",{points:x(n),transform:"translate(".concat(o[1].x,",").concat(o[1].y,") rotate(").concat((y+90)%360,")"),fill:s}),l.jsx("polygon",{points:x(n),transform:"translate(".concat(o[2].x,",").concat(o[2].y,") rotate(").concat((y+90)%360,")"),fill:s})]})},ne=t=>{const{id:e,x:i,y:h,handlePointerDown:r,handlePointerMove:o,handlePointerUp:y}=t,x=$.useCallback(s=>r(e,s),[e,r]),m=$.useCallback(s=>o(e,s),[e,o]),n=$.useCallback(s=>y(e,s),[e,y]);return l.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(h-6.4,")scale(0.025)"),onPointerDown:x,onPointerMove:m,onPointerUp:n,style:{cursor:"move"},children:l.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},dn=t=>{const{id:e,path:i,handlePointerDown:h}=t,r=$.useCallback(o=>h(e,o),[e,h]);return l.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},un=$.memo(t=>{var m,n,s,a,u,S,c,w,f,v,g,b;const{elements:e,handlePointerDown:i,handlePointerMove:h,handlePointerUp:r,handleEdgePointerDown:o}=t,y=Object.fromEntries(Array.from({length:21},(d,A)=>[A-10,{pre:[],main:[],post:[]}]));for(const d of e)if(d.type==="line"){const A=d.line.attr.type,N=d.line.attr.style,z=d.line.attr[N],W=(m=zt[N])==null?void 0:m.preComponent;W&&y[d.line.attr.zIndex].pre.push(l.jsx(W,{id:d.id,type:A,path:d.line.path,styleAttrs:z,newLine:!1,handlePointerDown:o},"".concat(d.id,".pre")));const M=(s=(n=zt[N])==null?void 0:n.component)!=null?s:dn;y[d.line.attr.zIndex].main.push(l.jsx(M,{id:d.id,type:A,path:d.line.path,styleAttrs:z,newLine:!1,handlePointerDown:o},d.id));const C=(a=zt[N])==null?void 0:a.postComponent;C&&y[d.line.attr.zIndex].post.push(l.jsx(C,{id:d.id,type:A,path:d.line.path,styleAttrs:z,newLine:!1,handlePointerDown:o},"".concat(d.id,".post")))}else if(d.type==="station"){const A=d.station,N=A.type,z=(u=yt[N])==null?void 0:u.preComponent;z&&y[d.station.zIndex].pre.push(l.jsx(z,{id:d.id,x:A.x,y:A.y,attrs:A,handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},"".concat(d.id,".pre")));const W=(c=(S=yt[N])==null?void 0:S.component)!=null?c:ne;y[d.station.zIndex].main.push(l.jsx(W,{id:d.id,x:A.x,y:A.y,attrs:A,handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},d.id));const M=(w=yt[N])==null?void 0:w.postComponent;M&&y[d.station.zIndex].post.push(l.jsx(M,{id:d.id,x:A.x,y:A.y,attrs:A,handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},"".concat(d.id,".post")))}else if(d.type==="misc-node"){const A=d.miscNode,N=A.type,z=(f=Pt[N])==null?void 0:f.preComponent;z&&y[d.miscNode.zIndex].pre.push(l.jsx(z,{id:d.id,x:A.x,y:A.y,attrs:A[N],handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},"".concat(d.id,".pre")));const W=(g=(v=Pt[N])==null?void 0:v.component)!=null?g:ne;y[d.miscNode.zIndex].main.push(l.jsx(W,{id:d.id,x:A.x,y:A.y,attrs:A[N],handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},d.id));const M=(b=Pt[N])==null?void 0:b.postComponent;M&&y[d.miscNode.zIndex].post.push(l.jsx(M,{id:d.id,x:A.x,y:A.y,attrs:A[N],handlePointerDown:i,handlePointerMove:h,handlePointerUp:r},"".concat(d.id,".post")))}return Array.from({length:21},(d,A)=>(A-10).toString()).map(d=>[...y[d].pre,...y[d].main,...y[d].post]).flat()},(t,e)=>t.elements===e.elements),hn=[...Object.values(Ee),ot.Virtual,ot.Master,ot.Fill,ot.LondonArrow,ot.ChongqingRTNumLineBadge2021,ot.ChongqingRTTextLineBadge2021,ot.ChengduRTLineBadge,ot.GzmtrLineBadge],fn=()=>{const t=wt(),e=$.useRef(window.graph),i=()=>{t(vt(e.current.export())),t(ft()),t(xt())},{telemetry:{project:h},preference:{autoParallel:r,gridLines:o,snapLines:y}}=Y(D=>D.app),{svgViewBoxZoom:x,svgViewBoxMin:m}=Y(D=>D.param),{selected:n,pointerPosition:s,active:a,refresh:{nodes:u,edges:S},mode:c,keepLastPath:w,theme:f}=Y(D=>D.runtime),v=It(),{height:g,width:b}=Lt(v),[d,A]=$.useState({dx:0,dy:0}),[N,z]=$.useState([]),[W,M]=$.useState([]),[C,F]=$.useState([]);$.useEffect(()=>{if(!s||!y)return;const D=Ot(m,x,b,g),L=he(e.current,...Object.values(D));M(L),z(tn(e.current,L))},[m,x,b,g,s]);const[O,Q]=$.useState(void 0),I=B((D,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:Z,y:tt}=dt(L);c==="select"&&t(gt("free")),F([]),Q(void 0),t(Yt({x:Z,y:tt})),t(kt(D)),L.shiftKey?n.has(D)?t(Ut(D)):t(Zt(D)):n.has(D)||t(at(new Set([D])))}),R=B((D,L)=>{const{x:Z,y:tt}=dt(L);if(L.currentTarget.setPointerCapture(L.pointerId),c==="free"&&a===D){if(!L.altKey&&y){const G=e.current.getNodeAttribute(D,"x"),q=e.current.getNodeAttribute(D,"y"),H=G-(s.x-Z)*x/100,X=q-(s.y-tt)*x/100;let et=H,p=X;if(ye(D,e.current)){let k=C,j=O;if(k.length!==0&&(k=k.filter(P=>pe(P,H,X)<=6)),j&&(k.length===0||Math.hypot(H-j.x,X-j.y)>6)&&(j=void 0),!j&&k.length===1){const P=k[0],{snapPoint:T,distance:V}=nn(e.current,W.filter(K=>!n.has(K)),H,X,P);V<=3&&(j=T)}if(k.length===1&&!j||k.length===0){const{l:P,d:T}=en(H,X,N,W.filter(K=>!n.has(K)&&!k.some(ht=>ht.node===K))),V=k.length===0||!k.some(K=>K.a===P.a&&K.b===P.b);T<3&&k.length<2&&V&&k.push(P)}if(k.length===1)if(j)et=j.x,p=j.y;else{const P=k[0];if(P.a==0)p=-P.c/P.b;else if(P.b==0)et=-P.c/P.a;else{const T=-P.a/P.b,V=-P.c/P.b;p=T*et+V}}else if(k.length===2){const P=k[0],T=k[1],V=P.a*T.b-T.a*P.b;V!==0&&(et=-(P.c*T.b-T.c*P.b)/V,p=-(P.a*T.c-T.a*P.c)/V)}F(k),Q(j)}const E=et-G,_=p-q;n.forEach(k=>{e.current.hasNode(k)&&e.current.updateNodeAttributes(k,j=>({...j,x:U(j.x+E,.01),y:U(j.y+_,.01)}))})}else F([]),Q(void 0),n.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,q=>({...q,x:U(q.x-(s.x-Z)*x/100,L.altKey?.01:5),y:U(q.y-(s.y-tt)*x/100,L.altKey?.01:5)}))});t(ft()),t(xt())}else c.startsWith("line")&&a&&A({dx:(s.x-Z)*x/100,dy:(s.y-tt)*x/100})}),J=B((D,L)=>{var Z,tt,G;if(L.currentTarget.releasePointerCapture(L.pointerId),c.startsWith("line")){w||t(gt("free"));const q=e.current.hasNode(a)&&hn.includes(e.current.getNodeAttribute(a,"type")),H=["stn_core_","virtual_circle_","misc_node_connectable_"],et=(G=(tt=(Z=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:Z.attributes)==null?void 0:tt.getNamedItem("id"))==null?void 0:G.value,p=H.find(E=>et==null?void 0:et.startsWith(E));if(q&&p){const E=c.slice(5),_="line_".concat(St(10)),[k,j]=[a,et.slice(p.length)];if(k!==j){const P=r?de(e.current,E,k,j,"from"):-1;e.current.addDirectedEdgeWithKey(_,k,j,{visible:!0,zIndex:0,type:E,[E]:structuredClone(nt[E].defaultAttrs),style:Nt.SingleColor,[Nt.SingleColor]:{color:f},reconcileId:"",parallelIndex:P}),t(at(new Set([_]))),h&&At.event(Mt.ADD_LINE,{type:E}),t(vt(e.current.export())),t(xt())}}}else if(c==="free"&&a){const{x:q,y:H}=dt(L);s.x-q===0&&s.y-H===0||(t(vt(e.current.export())),t(ft()))}F([]),Q(void 0),Yt(void 0),t(kt(void 0))}),pt=B((D,L)=>{if(L.stopPropagation(),L.shiftKey||t(mt()),L.shiftKey&&n.has(D)?t(Ut(D)):t(Zt(D)),c.startsWith("station")||c.startsWith("misc-node-virtual")||c.startsWith("misc-node-master")){const Z=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,tt=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=c.startsWith("station"),q=St(10),H=G?"stn_".concat(q):"misc_node_".concat(q),X=G?c.slice(8):c.slice(10),{x:et,y:p}=lt(Z,tt,x,m),E=G?structuredClone(yt[X].defaultAttrs):structuredClone(Pt[X].defaultAttrs);"color"in E&&(E.color=f),e.current.addNode(H,{visible:!0,zIndex:0,x:U(et,5),y:U(p,5),type:X,[X]:E});const _=e.current.getEdgeAttributes(D),{zIndex:k,type:j,style:P}=_,T=_[j],V=_[P],[K,ht]=e.current.extremities(D),Et=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(St(10)),K,H,{visible:!0,zIndex:k,type:j,[j]:structuredClone(T),style:P,[P]:structuredClone(V),reconcileId:"",parallelIndex:Et}),e.current.addDirectedEdgeWithKey("line_".concat(St(10)),H,ht,{visible:!0,zIndex:k,type:j,[j]:structuredClone(T),style:P,[P]:structuredClone(V),reconcileId:"",parallelIndex:Et}),e.current.dropEdge(D),i(),h&&(At.event(Mt.ADD_STATION,{type:X}),At.event(Mt.ADD_LINE,{type:j})),t(gt("free")),t(at(new Set([H])))}}),rt=$.useMemo(()=>[...cn(e.current),...an(e.current)],[S,u]),ut=ce.component;return l.jsxs(l.Fragment,{children:[l.jsx(un,{elements:rt,handlePointerDown:I,handlePointerMove:R,handlePointerUp:J,handleEdgePointerDown:pt}),c.startsWith("line")&&a&&a!=="background"&&l.jsx(ut,{id:"line_create_in_progress___no_use",type:c.slice(5),path:nt[c.slice(5)].generatePath(e.current.getNodeAttribute(a,"x"),e.current.getNodeAttribute(a,"x")-d.dx,e.current.getNodeAttribute(a,"y"),e.current.getNodeAttribute(a,"y")-d.dy,nt[c.slice(5)].defaultAttrs),styleAttrs:{color:f},newLine:!0,handlePointerDown:()=>{}}),C.length!==0&&C.map(D=>l.jsx("path",{d:nt[st.Simple].generatePath(...Ne(D,Ot(m,x,b,g)),nt[st.Simple].defaultAttrs),stroke:"cyan",strokeWidth:x/75},"snap_line_".concat(D.a,"_").concat(D.b,"_").concat(D.c,"_").concat(D.node))),O&&l.jsx(ln,{activeSnapPoint:O})]})},Vt=30;var it=(t=>(t.STATION="station",t.MISC_NODE="misc-node",t.LINE="line",t.OPERATION="operation",t))(it||{});const Ft={station:[],"misc-node":[],line:[],operation:[]},xn=(t,e,i)=>{const h=structuredClone(Ft),r=t.filterNodes((n,s)=>n.startsWith("stn")?Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2))<=Vt:!1),o=t.filterNodes((n,s)=>n.startsWith("misc")?Math.sqrt(Math.pow(s.x-e.x,2)+Math.pow(s.y-e.y,2))<=Vt:!1),y=[...r,...o],x=[];if(y.length>0&&t.forEachEdge((n,s,a,u)=>{(y.includes(a)||y.includes(u))&&x.push(n)}),r.length>0){const n=r.slice(0,8).map(s=>{const a=t.getNodeAttribute(s,"type");return{label:t.getNodeAttribute(s,a).names[0],elementId:s,action:()=>i(at(new Set([s])))}});h.station=n}if(o.length>0){const n=o.slice(0,8).map(s=>{const a=t.getNodeAttribute(s,"type"),u=Tt(a);return{label:jt.t("panel.details.nodes.".concat(u,".displayName")),elementId:s,action:()=>i(at(new Set([s])))}});h["misc-node"]=n}if(x.length>0){const n=x.slice(0,6).map(s=>{const[a,u]=t.extremities(s),S=t.getNodeAttribute(a,"type"),c=t.getNodeAttribute(u,"type");let w="",f="";return a.startsWith("stn")?w=t.getNodeAttribute(a,S).names[0]:w=jt.t("panel.details.nodes.".concat(Tt(S),".displayName")),u.startsWith("stn")?f=t.getNodeAttribute(u,c).names[0]:f=jt.t("panel.details.nodes.".concat(Tt(c),".displayName")),{label:"".concat(w," - ").concat(f),elementId:s,action:()=>i(at(new Set([s])))}});h.line=n}const m=[];return m.push({label:jt.t("contextMenu.paste"),action:async()=>{try{const n=await navigator.clipboard.readText();Ht(n,t,!1,!1,e.x,e.y)}catch(n){console.error("Failed to paste from clipboard:",n)}},elementId:"operation-paste"}),h.operation=m,h},yn=5,Dt=Vt,Wt=40,pn=({data:t,position:e,onClose:i,visible:h})=>{const{svgViewBoxZoom:r}=Y(x=>x.param),o=[...t[it.STATION],...t[it.MISC_NODE],...t[it.LINE]];if(!h||o.length===0)return null;const y=(x,m)=>{x.stopPropagation(),m(),i()};return l.jsxs("g",{transform:"translate(".concat(e.x,", ").concat(e.y,")scale(").concat(.8*r/100,")"),children:[Object.entries(t).map(([x,m])=>{if(!m||m.length===0)return null;let n,s;switch(x){case it.STATION:n=Math.PI,s="hsl(220, 30%, 85%)";break;case it.LINE:n=Math.PI/2,s="hsl(120, 30%, 85%)";break;case it.MISC_NODE:n=3*Math.PI/2,s="hsl(60, 30%, 85%)";break;case it.OPERATION:n=2*Math.PI,s="hsl(0, 30%, 85%)";break;default:return null}const a=n+Math.PI/2;return l.jsx("g",{children:m.slice(0,yn+1).map((u,S)=>{const c=Dt+S*Wt,w=Dt+(S+1)*Wt,f=c*Math.cos(n),v=c*Math.sin(n),g=c*Math.cos(a),b=c*Math.sin(a),d=w*Math.cos(n),A=w*Math.sin(n),N=w*Math.cos(a),z=w*Math.sin(a),W="M ".concat(f," ").concat(v,"\n                                     L ").concat(d," ").concat(A,"\n                                     A ").concat(w," ").concat(w," 0 0 1 ").concat(N," ").concat(z,"\n                                     L ").concat(g," ").concat(b,"\n                                     A ").concat(c," ").concat(c," 0 0 0 ").concat(f," ").concat(v),M=Dt+(S+.5)*Wt,C=M*Math.cos(n),F=M*Math.sin(n),O=M*Math.cos(a),Q=M*Math.sin(a),I="M ".concat(C," ").concat(F," A ").concat(M," ").concat(M," 0 0 1 ").concat(O," ").concat(Q);return l.jsxs("g",{onPointerDown:R=>y(R,u.action),children:[l.jsx("path",{d:W,fill:s,stroke:"rgba(0,0,0,0.1)",strokeWidth:"1",fillRule:"evenodd"}),l.jsx("defs",{children:l.jsx("path",{id:u.label,d:I})}),l.jsx("text",{textAnchor:"middle",dominantBaseline:"middle",fontSize:"10",fill:"#333",style:{pointerEvents:"none",userSelect:"none"},children:l.jsx("textPath",{startOffset:"50%",href:"#".concat(u.label),children:u.label})})]},u.elementId)})},x)}),l.jsx("circle",{cx:0,cy:0,r:Dt,fill:"rgba(255, 255, 255, 0.3)",stroke:"rgba(0,0,0,0.2)",strokeWidth:"1",onPointerDown:i})]})},se=10,gn=()=>{const t=wt(),e=$.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:h}=Y(d=>d.param),{selected:r}=Y(d=>d.runtime),o=It(),{height:y,width:x}=Lt(o),m=$.useCallback(()=>{t(vt(e.current.export())),t(ft()),t(xt())},[t]),n=$.useCallback((d,A,N)=>{d.stopPropagation(),r.size>0&&(r.forEach(z=>{e.current.hasNode(z)&&(e.current.updateNodeAttribute(z,"x",W=>(W!=null?W:0)+A*se),e.current.updateNodeAttribute(z,"y",W=>(W!=null?W:0)+N*se))}),m())},[r,m]),s=$.useCallback(d=>n(d,0,-1),[n]),a=$.useCallback(d=>n(d,0,1),[n]),u=$.useCallback(d=>n(d,-1,0),[n]),S=$.useCallback(d=>n(d,1,0),[n]),c=$.useCallback(()=>{if(r.size>0){const d=$t(e.current,r);navigator.clipboard.writeText(d)}},[r]),w=$.useCallback(()=>{r.size>0&&(t(mt()),r.forEach(d=>{e.current.hasNode(d)?e.current.dropNode(d):e.current.hasEdge(d)&&e.current.dropEdge(d)}),m())},[r,t,m]),f=h.x+x*i/200,v=h.y+(y-100)*i/100,g=40,b=40;return l.jsxs("g",{transform:"translate(".concat(f,", ").concat(v,")scale(").concat(1.5*i/100,")"),children:[l.jsxs("g",{transform:"translate(0, -".concat(b,")"),children:[l.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:s}),l.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(0, ".concat(b,")"),children:[l.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:a}),l.jsx(Ce,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(-".concat(b,", 0)"),children:[l.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),l.jsx(De,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(".concat(b,", 0)"),children:[l.jsx("circle",{r:g/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:S}),l.jsx(_e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(".concat(b,", ").concat(b,")"),children:[l.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:c}),l.jsx($e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(-".concat(b,", ").concat(b,")"),children:[l.jsx("circle",{r:g/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:w}),l.jsx(Ie,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},mn=()=>{const t=wt(),{svgViewBoxZoom:e,svgViewBoxMin:i}=Y(f=>f.param),{selected:h}=Y(f=>f.runtime),r=$.useRef(window.graph),[o,y]=$.useState(0),x=It(),{height:m,width:n}=Lt(x),[s,a]=qt.useState({visible:!1,position:{x:0,y:0},data:Ft}),u=B(f=>{var v;if(f.touches.length==1){if(y(0),s.visible){w();return}const g=f.touches[0],b=(v=document.getElementById("canvas"))==null?void 0:v.getBoundingClientRect();if(!b)return;const d=g.clientX-b.left,A=g.clientY-b.top,N=lt(d,A,e,i),z=xn(r.current,N,t);[...z[it.STATION],...z[it.MISC_NODE],...z[it.LINE]].length>0?a({visible:!0,position:N,data:z}):(t(mt()),w())}else if(f.touches.length==2){t(kt(void 0));const[g,b]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];y(g*g+b*b)}}),S=B(f=>{if(f.touches.length==2&&o>0){const[v,g]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],b=v*v+g*g;let d=e;b-o<0&&e+10<=390?d=e+10:b-o>0&&e-10>=10&&(d=e-10),t(ue(d)),y(b);const A=f.currentTarget.getBoundingClientRect(),[N,z]=[(f.touches[0].clientX+f.touches[1].clientX)/2-A.left,(f.touches[0].clientY+f.touches[1].clientY)/2-A.top],[W,M]=[N/A.width,z/A.height];t(_t({x:i.x+N*e/100-n*d/100*W,y:i.y+z*e/100-m*d/100*M}))}}),c=B(f=>{y(0)}),w=qt.useCallback(()=>{a({visible:!1,position:{x:0,y:0},data:Ft})},[]);return l.jsxs("g",{className:"removeMe",children:[[...h].some(f=>f.startsWith("stn_")||f.startsWith("misc_node_"))?l.jsx(gn,{}):l.jsx("rect",{x:i.x,y:i.y,width:n*e/100,height:m*e/100,fill:s.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:u,onTouchMove:S,onTouchEnd:c}),l.jsx(pn,{data:s.data,position:s.position,onClose:w,visible:s.visible})]})},Pn=()=>{const t=wt(),e=$.useRef(window.graph),i=$.useCallback(()=>{t(vt(e.current.export())),t(ft()),t(xt())},[t]),{activeSubscriptions:h}=Y(p=>p.account),{telemetry:{project:r},preference:{gridLines:o,snapLines:y,predictNextNode:x,autoParallel:m}}=Y(p=>p.app),{svgViewBoxZoom:n,svgViewBoxMin:s}=Y(p=>p.param),{selected:a,active:u,isDetailsOpen:S,mode:c,lastTool:w,keepLastPath:f,theme:v,count:{masters:g,lines:b}}=Y(p=>p.runtime),d=It(),{height:A,width:N}=Lt(d),z=!h.RMP_CLOUD&&g+1>ie,W=!h.RMP_CLOUD&&b+1>ae,M=xe();Le();const[C,F]=$.useState({x:0,y:0}),[O,Q]=$.useState({x:0,y:0}),[I,R]=$.useState({isOpen:!1,position:{x:0,y:0}}),[J,pt]=$.useState({x:0,y:0}),[rt,ut]=$.useState({x:0,y:0}),D=B(async p=>{I.isOpen&&R({isOpen:!1,position:{x:0,y:0}});const{x:E,y:_}=dt(p);if(c.startsWith("station")||c.startsWith("misc-node")){t(gt("free"));const k=St(10),{x:j,y:P}=lt(E,_,n,s),T=c.startsWith("station"),V=T?"stn_".concat(k):"misc_node_".concat(k),K=T?c.slice(8):c.slice(10),ht=structuredClone({...yt,...Pt}[K].defaultAttrs);le.has(K)&&(ht.color=v),T&&(ht.names=await M(K)),e.current.addNode(V,{visible:!0,zIndex:0,x:U(j,5),y:U(P,5),type:K,[K]:ht}),r&&At.event(Mt.ADD_STATION,{type:K}),i(),t(at(new Set([V])))}else c==="free"||c.startsWith("line")?(c.startsWith("line")&&(t(gt("free")),f&&t(Ye(!1))),pt({x:E,y:_}),ut(s),p.shiftKey||(t(kt("background")),t(mt()))):c==="select"&&(F(lt(E,_,n,s)),Q(lt(E,_,n,s)))}),L=B(p=>{if(c==="select"){if(C.x!=0&&C.y!=0){const{x:E,y:_}=dt(p);Q(lt(E,_,n,s))}}else if(u==="background"){const{x:E,y:_}=dt(p);t(_t({x:rt.x+(J.x-E)*n/100,y:rt.y+(J.y-_)*n/100}))}}),Z=B(p=>{if(c==="select"){const{x:E,y:_}=dt(p),{x:k,y:j}=lt(E,_,n,s),P=he(e.current,C.x,C.y,k,j),T=Fe(e.current,new Set(P));t(at(new Set([...p.shiftKey?a:[],...P,...T]))),t(gt("free")),F({x:0,y:0}),Q({x:0,y:0})}u==="background"&&!p.shiftKey&&t(kt(void 0))}),tt=B(p=>{let E=n;p.deltaY>0&&n+10<400?E=n+10:p.deltaY<0&&n-10>0&&(E=n-10),t(ue(E));const{x:_,y:k}=dt(p),j=p.currentTarget.getBoundingClientRect(),[P,T]=[_/j.width,k/j.height];t(_t({x:s.x+_*n/100-N*E/100*P,y:s.y+k*n/100-A*E/100*T}))}),G=B(p=>{p.preventDefault(),dt(p),R({isOpen:!0,position:{x:p.clientX,y:p.clientY}})}),q=B(()=>{R({isOpen:!1,position:{x:0,y:0}});const p=document.getElementById("canvas");p&&p.focus()}),H=B(async p=>{if(bt?p.key==="Backspace":p.key==="Delete")a.size>0&&(a.forEach(E=>{e.current.hasNode(E)?e.current.dropNode(E):e.current.hasEdge(E)&&e.current.dropEdge(E)}),t(mt()),i());else if(p.key.startsWith("Arrow")){const _=p.key.endsWith("Left")?-1:p.key.endsWith("Right")?1:0,k=p.key.endsWith("Up")?-1:p.key.endsWith("Down")?1:0;t(_t(lt(100*_,100*k,n,s)))}else if(p.key==="i"||p.key==="j"||p.key==="k"||p.key==="l"){const _=(p.key==="j"?-1:p.key==="l"?1:0)*10,k=(p.key==="i"?-1:p.key==="k"?1:0)*10;a.size>0&&a.forEach(j=>{e.current.hasNode(j)&&(e.current.updateNodeAttribute(j,"x",P=>(P!=null?P:0)+_),e.current.updateNodeAttribute(j,"y",P=>(P!=null?P:0)+k),i())})}else if(p.key==="f"&&w)t(gt(w));else if(p.key==="z"&&(bt?p.metaKey&&!p.shiftKey:p.ctrlKey))bt&&p.preventDefault(),t(Be()),t(ft()),t(xt());else if(p.key==="s")t(gt("select"));else if((p.key==="c"||p.key==="x")&&(bt?p.metaKey&&!p.shiftKey:p.ctrlKey)){const E=$t(e.current,a);navigator.clipboard.writeText(E),p.key==="x"&&(t(mt()),a.forEach(_=>{e.current.hasNode(_)?e.current.dropNode(_):e.current.hasEdge(_)&&e.current.dropEdge(_)}),i())}else if(p.key==="v"&&(bt?p.metaKey&&!p.shiftKey:p.ctrlKey)){const E=await navigator.clipboard.readText(),{x:_,y:k}=lt(N/2,A/2,n,s),{nodes:j,edges:P}=Ht(E,e.current,z,W,U(_,5),U(k,5));i();const T=structuredClone(j);P.forEach(V=>T.add(V)),t(at(T))}else if(bt&&p.key==="z"&&p.metaKey&&p.shiftKey||!bt&&p.key==="y"&&p.ctrlKey)t(Oe());else if(p.key==="c")t(Xe(!y));else if(p.key==="e"){const[E]=a;if(a.size===1&&e.current.hasEdge(E)){const _=e.current.getEdgeAttributes(E),{type:k}=_;if(k!==st.Simple&&_[k]){const j=_[k],T=(j.startFrom||"from")==="from"?"to":"from";let V=_.parallelIndex;if(m){const[ht,Et]=e.current.extremities(E);V=de(e.current,k,ht,Et,T)}const K={...j,startFrom:T};e.current.mergeEdgeAttributes(E,{[k]:K,parallelIndex:V}),i()}}}}),[X,et]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{et({sx:C.x<=O.x?C.x:O.x,ex:C.x>O.x?C.x:O.x,sy:C.y<=O.y?C.y:O.y,ey:C.y>O.y?C.y:O.y})},[O.x,O.y]),l.jsxs(l.Fragment,{children:[l.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:A,width:N,viewBox:"".concat(s.x," ").concat(s.y," ").concat(N*n/100," ").concat(A*n/100),onPointerDown:D,onPointerMove:L,onPointerUp:Z,onWheel:tt,onContextMenu:G,tabIndex:0,onKeyDown:H,children:[l.jsx("defs",{children:l.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[l.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),l.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),o&&l.jsx(Ge,{svgViewBoxMin:s,svgViewBoxZoom:n,svgWidth:N,svgHeight:A}),x&&a.size===1&&c==="free"&&l.jsx(Je,{}),l.jsx(Ve.SvgAssetsContextProvider,{children:l.jsx(fn,{})}),c==="select"&&C.x!=0&&C.y!=0&&l.jsx("rect",{x:X.sx,y:X.sy,width:X.ex-X.sx,height:X.ey-X.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Te()&&c!=="select"&&!c.startsWith("line-")&&l.jsx(mn,{})]}),l.jsx(qe,{isOpen:I.isOpen,position:I.position,onClose:q}),ze()&&S==="hide"&&l.jsx(ve,{"aria-label":"open details panel",icon:l.jsx(Re,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(We()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Pn as default};

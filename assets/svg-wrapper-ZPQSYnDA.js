import{ad as Ot,j as m}from"./chakra-CSR0Uih-.js";import{x as Wt,at as Ct,au as Ft,a4 as Lt,e as Z,L as G,p as K,av as Ut,aw as qt,ax as Gt,ay as Mt,c as Rt,q as Ht,az as tt,aA as ft,V as lt,aB as jt,aC as zt,v as dt,w as ut,aD as nt,n as ht,m as Zt,o as Dt,r as xt,E as mt,t as vt,B as St,aE as Qt,S as Jt,aF as te,a1 as ee,aG as ne,F as pt,aq as se,ar as oe,D as Nt,d as ie,a2 as re}from"./index-Ghmx3Oyd.js";import{b as _t,r as H,s as yt,g as Xt,f as Kt,e as ae,h as et,j as ce,k as le,l as de,n as ue,p as J,o as he,q as fe,i as st,t as ye}from"./master-manager-Cz-3bNjL.js";import{k as Yt,b as $}from"./react-eFT_xHYJ.js";import{u as U,e as ge,i as pe}from"./clipboard-DdtHYxww.js";import{m as gt}from"./misc-nodes-CxxIUlFu.js";const xe={[Lt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Lt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},me=t=>{const e=xe[t];return e.at(Math.floor(Math.random()*e.length))},$t=Yt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:f})=>{const{token:i}=e().account;if(!i){u(Ct({cityName:t,names:[]}));return}const c=await fetch("".concat(Ft,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(i)}});if(!c.ok)return Wt.warn("Failed to fetch random station names",c.statusText),f(c.statusText);const w=await c.json();u(Ct({cityName:t,names:w}))}),Bt=Yt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var a;const{stationNames:f}=e().runtime,i=f[t];if(((a=i==null?void 0:i.length)!=null?a:0)==0)return Wt.debug("No random station names in cache, using fallback"),u($t({cityName:t})),Object.values(me(t));const c=structuredClone(i),w=c.shift();return u(Ct({cityName:t,names:c})),c.length<3&&u($t({cityName:t})),Object.values(w)}),ve=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:f,svgHeight:i}=t,{preference:{toolsPanel:{expand:c}}}=Z(C=>C.app),a=Ot().colorMode==="light"?"#666464":"#D3D3D4",d=_t(e,u,f,i),s=c?410*u/100:0,r=u>30?u>120?50:25:5,x=u/200,o={startX:H(d.xMin+s-r,r),endX:H(d.xMax+s+r,r),startY:H(d.yMin-r,r),endY:H(d.yMax+r,r)},g=Array.from({length:(o.endX-o.startX)/r+1},(C,h)=>{const y=o.startX+h*r,l=y%(r*5)===0?2*x:x;return m.jsx("line",{x1:y,y1:o.startY,x2:y,y2:o.endY,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_vl_".concat(y))}),v=Array.from({length:(o.endY-o.startY)/r+1},(C,h)=>{const y=o.startY+h*r,l=y%(r*5)===0?2*x:x;return m.jsx("line",{x1:o.startX,y1:y,x2:o.endX,y2:y,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_hl_".concat(y))}),_=Array.from({length:(o.endX-o.startX)/r/5+1},(C,h)=>{const y=H(o.startX,5*r)+h*5*r;return m.jsx("text",{x:y,y:d.yMin+u/5,fontSize:x*25,fill:a,textAnchor:"middle",opacity:"0.5",children:y},"grid_vc_".concat(y))}),M=Array.from({length:(o.endY-o.startY)/r/5+1},(C,h)=>{const y=H(o.startY,5*r)+h*5*r;return m.jsx("text",{x:d.xMin+u/8+s,y,fontSize:x*25,fill:a,textAnchor:"start",opacity:"0.5",children:y},"grid_hc_".concat(y))});return m.jsxs("g",{id:"grid-lines",className:"removeMe",children:[g,v,_,M]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Vt=(t,e,u,f,i,c)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return Tt(t,e,u,f,i)?{x1:e,y1:u,x2:f,y2:i,offset:c.offsetFrom}:void 0;const[w,a]=[c.offsetFrom,c.offsetTo];for(let d=0;d<Math.PI;d+=Math.PI/8)for(let s=d,r=0;r<2;r++,s+=Math.PI){const[x,o,g,v]=[Math.sin(d)*w,Math.cos(d)*w,Math.sin(s)*a,Math.cos(s)*a];if(Tt(t,e+x,u+o,f+g,i+v))return{x1:e+x,y1:u+o,x2:f+g,y2:i+v,offset:0}}},Se=(t,e,u,f,i,c)=>t===u?{x1:t+5*c,y1:e,x2:u+5*c,y2:f,offset:i}:e===f?{x1:t,y1:e+5*c,x2:u,y2:f+5*c,offset:i}:{x1:t+5*Math.SQRT1_2*c,y1:e+5*Math.SQRT1_2*c,x2:u+5*Math.SQRT1_2*c,y2:f+5*Math.SQRT1_2*c,offset:i},Tt=(t,e,u,f,i)=>!!((e===f||u===i)&&[G.Diagonal,G.Perpendicular].includes(t)||Math.abs((i-u)/(f-e))===1&&[G.Diagonal,G.RotatePerpendicular].includes(t)),be=(t,e)=>{const u=[],f=[];return Object.values(e).forEach(i=>{var C;if(i.length===1){f.push(...i.map(h=>h.edge));return}const c=t.getEdgeAttribute(i.at(0),"type");if(!i.every(h=>t.getEdgeAttribute(h,"type")===c)){f.push(...i.map(h=>h.edge));return}const w=t.getEdgeAttribute(i.at(0),"style");if(!i.every(h=>t.getEdgeAttribute(h,"style")===w)){f.push(...i.map(h=>h.edge));return}const a={},d=new Set,s=new Set,r=Object.fromEntries(i.map(h=>{var P,B;const[y,l]=t.extremities(h);return a[y]=((P=a[y])!=null?P:0)+1,a[l]=((B=a[l])!=null?B:0)+1,d.add(y),s.add(l),[y,[h.edge,l]]})),x=Array.from(d).filter(h=>a[h]===1),o=Array.from(s).filter(h=>a[h]===1);if(x.length!==1||o.length!==1){f.push(...i.map(h=>h.edge));return}const g=x[0],v=o[0];if(g===v){f.push(...i.map(h=>h.edge));return}const _=[r[g][0]];let M=r[g][1];for(let h=1;h<i.length;h=h+1){const y=(C=r[M])==null?void 0:C.at(1);if(!y){f.push(...i.map(l=>l.edge));return}_.push(r[M][0]),M=y}if(M!==v||_.length!==i.length){f.push(...i.map(h=>h.edge));return}u.push(_)}),{allReconciledLines:u,danglingLines:f}},Ae=(t,e)=>{if(!e.every(i=>t.hasEdge(i)))return;const u=e.map(i=>{var o,g,v;const[c,w]=t.extremities(i),a=t.getNodeAttributes(c),d=t.getNodeAttributes(w),{type:s}=t.getEdgeAttributes(i),r=(o=t.getEdgeAttribute(i,s))!=null?o:K[s].defaultAttrs,x=Vt(s,a.x,a.y,d.x,d.y,r);if(x){const{x1:_,y1:M,x2:C,y2:h,offset:y}=x;return K[G.Simple].generatePath(_,C,M,h,{offset:y})}return(v=(g=K[s])==null?void 0:g.generatePath(a.x,d.x,a.y,d.y,r))!=null?v:"M ".concat(a.x," ").concat(a.y," L ").concat(d.x," ").concat(d.y)});let f="".concat(u[0]," ");for(let i=1;i<e.length;i=i+1)f+=u[i].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return f},we=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Pe=t=>{const e={},u={},f=[],i={},c=[];for(const s of t.edgeEntries()){const[r,x,o,g]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],v=s.attributes[s.attributes.type],_=Vt(s.attributes.type,r,x,o,g,v);u[s.edge]=_}for(const s of t.edgeEntries()){let r=u[s.edge];const{parallelIndex:x}=s.attributes;if(x>=0){const o=Ut(t,s.attributes.type,s.edge),g=u[o];if(!g){f.push(s);continue}if(x>0){const{x1:v,y1:_,x2:M,y2:C,offset:h}=g;r=Se(v,_,M,C,h,x)}}if(s.attributes.reconcileId!==""){const o=s.attributes.reconcileId;o in i?i[o].push(s):i[o]=[s];continue}if(r){const o=s.edge,g=s.attributes,{x1:v,y1:_,x2:M,y2:C,offset:h}=r;e[o]={attr:g,path:K[G.Simple].generatePath(v,M,_,C,{offset:h})};continue}c.push(s)}const w=new Set;for(;f.length;){const s=f.pop();if(w.has(s.edge))continue;const{parallel:r}=qt(t,s);if(!r.length)continue;r.forEach(o=>w.add(o.edge));const x=Gt(r);for(const o of r){const g=o.edge;e[g]={attr:o.attributes,path:x[g]}}}const{allReconciledLines:a,danglingLines:d}=be(t,i);for(const s of a){const r=Ae(t,s);if(!r)continue;const x=s[0];e[x]={attr:t.getEdgeAttributes(x),path:r}}for(const s of d){const r=t.getEdgeAttributes(s),[x,o]=t.extremities(s),g=t.getNodeAttributes(x),v=t.getNodeAttributes(o);e[s]={attr:r,path:K[G.Simple].generatePath(g.x,v.x,g.y,v.y,K[G.Simple].defaultAttrs)}}for(const s of c){const r=s.edge,x=s.attributes.type,o=s.attributes,[g,v,_,M]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(x in K)){e[r]={attr:o,path:"M ".concat(g," ").concat(v," L ").concat(_," ").concat(M)};continue}e[r]={attr:o,path:K[x].generatePath(g,_,v,M,o[x])}}return Object.entries(e).map(([s,r])=>({id:s,type:"line",line:r}))},ke=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=Z(o=>o.param),f=o=>{const v=[{x:o.x,y:o.y},...o.originalNodesPos].sort((M,C)=>M.x===C.x?M.y-C.y:M.x-C.x),_=(v[1].y-v[0].y)/(v[1].x-v[0].x);if(Math.abs(_)<=.01)return{original:v,offset:v.map(M=>({x:M.x,y:M.y+10})),rotate:0};if(Math.abs(_)>=1e10)return{original:v,offset:v.map(M=>({x:M.x+10,y:M.y})),rotate:90};{const C=-1/_,h=10/Math.sqrt(C*C+1),y=10*C/Math.sqrt(C*C+1);return{original:v,offset:v.map(l=>({x:l.x+h,y:l.y+y})),rotate:-Math.atan(C)*(180/Math.PI)}}},{original:i,offset:c,rotate:w}=f(e),a=o=>{const g=Math.sqrt(3)/2*o,v="0,0",_="".concat(-o/2,",").concat(g),M="".concat(o/2,",").concat(g);return"".concat(v," ").concat(_," ").concat(M)},d=u/75,s=8*d,r="#FC8181",x="".concat(d*5," ").concat(d*2);return m.jsxs(m.Fragment,{children:[m.jsx("line",{x1:c[0].x,y1:c[0].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:x}),m.jsx("line",{x1:c[1].x,y1:c[1].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:x}),m.jsx("line",{x1:i[0].x,y1:i[0].y,x2:c[0].x,y2:c[0].y,stroke:r,strokeWidth:d,strokeDasharray:x}),m.jsx("line",{x1:i[1].x,y1:i[1].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:x}),m.jsx("line",{x1:i[2].x,y1:i[2].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:x}),m.jsx("polygon",{points:a(s),transform:"translate(".concat(c[0].x,",").concat(c[0].y,") rotate(").concat((w+270)%360,")"),fill:r}),m.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((w+270)%360,")"),fill:r}),m.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((w+90)%360,")"),fill:r}),m.jsx("polygon",{points:a(s),transform:"translate(".concat(c[2].x,",").concat(c[2].y,") rotate(").concat((w+90)%360,")"),fill:r})]})},It=t=>{const{id:e,x:u,y:f,handlePointerDown:i,handlePointerMove:c,handlePointerUp:w}=t,a=$.useCallback(r=>i(e,r),[e,i]),d=$.useCallback(r=>c(e,r),[e,c]),s=$.useCallback(r=>w(e,r),[e,w]);return m.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(f-6.4,")scale(0.025)"),onPointerDown:a,onPointerMove:d,onPointerUp:s,style:{cursor:"move"},children:m.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Me=t=>{const{id:e,path:u,handlePointerDown:f}=t,i=$.useCallback(c=>f(e,c),[e,f]);return m.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},Ce=$.memo(t=>{var d,s,r,x,o,g,v,_,M,C,h,y;const{elements:e,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i,handleEdgePointerDown:c}=t,w=Object.fromEntries(Array.from({length:21},(l,P)=>[P-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const P=l.line.attr.type,B=l.line.attr.style,D=l.line.attr[B],q=(d=Mt[B])==null?void 0:d.preComponent;q&&w[l.line.attr.zIndex].pre.push(m.jsx(q,{id:l.id,type:P,path:l.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},"".concat(l.id,".pre")));const I=(r=(s=Mt[B])==null?void 0:s.component)!=null?r:Me;w[l.line.attr.zIndex].main.push(m.jsx(I,{id:l.id,type:P,path:l.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},l.id));const Q=(x=Mt[B])==null?void 0:x.postComponent;Q&&w[l.line.attr.zIndex].post.push(m.jsx(Q,{id:l.id,type:P,path:l.line.path,styleAttrs:D,newLine:!1,handlePointerDown:c},"".concat(l.id,".post")))}else if(l.type==="station"){const P=l.station,B=P.type,D=(o=yt[B])==null?void 0:o.preComponent;D&&w[l.station.zIndex].pre.push(m.jsx(D,{id:l.id,x:P.x,y:P.y,attrs:P,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".pre")));const q=(v=(g=yt[B])==null?void 0:g.component)!=null?v:It;w[l.station.zIndex].main.push(m.jsx(q,{id:l.id,x:P.x,y:P.y,attrs:P,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},l.id));const I=(_=yt[B])==null?void 0:_.postComponent;I&&w[l.station.zIndex].post.push(m.jsx(I,{id:l.id,x:P.x,y:P.y,attrs:P,handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const P=l.miscNode,B=P.type,D=(M=gt[B])==null?void 0:M.preComponent;D&&w[l.miscNode.zIndex].pre.push(m.jsx(D,{id:l.id,x:P.x,y:P.y,attrs:P[B],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".pre")));const q=(h=(C=gt[B])==null?void 0:C.component)!=null?h:It;w[l.miscNode.zIndex].main.push(m.jsx(q,{id:l.id,x:P.x,y:P.y,attrs:P[B],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},l.id));const I=(y=gt[B])==null?void 0:y.postComponent;I&&w[l.miscNode.zIndex].post.push(m.jsx(I,{id:l.id,x:P.x,y:P.y,attrs:P[B],handlePointerDown:u,handlePointerMove:f,handlePointerUp:i},"".concat(l.id,".post")))}return Array.from({length:21},(l,P)=>(P-10).toString()).map(l=>[...w[l].pre,...w[l].main,...w[l].post]).flat()},(t,e)=>t.elements===e.elements),Le=[...Object.values(Jt),nt.Virtual,nt.Master,nt.LondonArrow,nt.ChongqingRTNumLineBadge2021,nt.ChongqingRTTextLineBadge2021,nt.ChengduRTLineBadge,nt.GzmtrLineBadge],_e=()=>{const t=Rt(),e=$.useRef(window.graph),u=()=>{t(vt(e.current.export())),t(dt()),t(ut())},{telemetry:{project:f},preference:{autoParallel:i,gridLines:c,snapLines:w}}=Z(k=>k.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=Z(k=>k.param),{selected:s,refresh:{nodes:r,edges:x},mode:o,active:g,keepLastPath:v,theme:_}=Z(k=>k.runtime),M=Ht(),{height:C,width:h}=Xt(M),[y,l]=$.useState(),[P,B]=$.useState({dx:0,dy:0}),[D,q]=$.useState([]),[I,Q]=$.useState([]),[ot,it]=$.useState([]);$.useEffect(()=>{if(!y||!w)return;const k=_t(d,a,h,C),N=Kt(e.current,...Object.values(k));Q(N),q(ae(e.current,N))},[d,a,h,C,y]);const[rt,at]=$.useState(void 0),bt=U((k,N)=>{N.stopPropagation(),o==="select"&&t(tt("free"));const X=N.currentTarget,{x:Y,y:W}=et(N);X.setPointerCapture(N.pointerId),it([]),at(void 0),l({x:Y,y:W}),t(ft(k)),N.shiftKey?s.has(k)?t(jt(k)):t(zt(k)):s.has(k)||t(lt(new Set([k])))}),At=U((k,N)=>{const{x:X,y:Y}=et(N);if(o==="free"&&g===k){if(!N.altKey&&w){const W=e.current.getNodeAttribute(k,"x"),V=e.current.getNodeAttribute(k,"y"),n=W-(y.x-X)*a/100,p=V-(y.y-Y)*a/100;let b=n,z=p;if(ce(k,e.current)){let S=ot,L=rt;if(S.length!==0&&(S=S.filter(A=>le(A,n,p)<=6)),L&&(S.length===0||Math.hypot(n-L.x,p-L.y)>6)&&(L=void 0),!L&&S.length===1){const A=S[0],{snapPoint:T,distance:R}=de(e.current,I.filter(O=>!s.has(O)),n,p,A);R<=3&&(L=T)}if(S.length===1&&!L||S.length===0){const{l:A,d:T}=ue(n,p,D,I.filter(O=>!s.has(O)&&!S.some(F=>F.node===O))),R=S.length===0||!S.some(O=>O.a===A.a&&O.b===A.b);T<3&&S.length<2&&R&&S.push(A)}if(S.length===1)if(L)b=L.x,z=L.y;else{const A=S[0];if(A.a==0)z=-A.c/A.b;else if(A.b==0)b=-A.c/A.a;else{const T=-A.a/A.b,R=-A.c/A.b;z=T*b+R}}else if(S.length===2){const A=S[0],T=S[1],R=A.a*T.b-T.a*A.b;R!==0&&(b=-(A.c*T.b-T.c*A.b)/R,z=-(A.a*T.c-T.a*A.c)/R)}it(S),at(L)}const E=b-W,j=z-V;s.forEach(S=>{e.current.hasNode(S)&&e.current.updateNodeAttributes(S,L=>({...L,x:H(L.x+E,.01),y:H(L.y+j,.01)}))})}else it([]),at(void 0),s.forEach(W=>{e.current.hasNode(W)&&e.current.updateNodeAttributes(W,V=>({...V,x:H(V.x-(y.x-X)*a/100,N.altKey?.01:5),y:H(V.y-(y.y-Y)*a/100,N.altKey?.01:5)}))});t(dt()),t(ut())}else o.startsWith("line")&&B({dx:(y.x-X)*a/100,dy:(y.y-Y)*a/100})}),wt=U((k,N)=>{if(o.startsWith("line")){v||t(tt("free"));const X=e.current.hasNode(g)&&Le.includes(e.current.getNodeAttribute(g,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(W=>{var b,z;const n=(z=(b=document.elementsFromPoint(N.clientX,N.clientY)[0].attributes)==null?void 0:b.getNamedItem("id"))==null?void 0:z.value,p=n==null?void 0:n.startsWith(W);if(X&&p){const E=o.slice(5),j="line_".concat(ht(10)),[S,L]=[g,n.slice(W.length)],A=i?Zt(e.current,E,S,L,"from"):-1;e.current.addDirectedEdgeWithKey(j,S,L,{visible:!0,zIndex:0,type:E,[E]:structuredClone(K[E].defaultAttrs),style:Dt.SingleColor,[Dt.SingleColor]:{color:_},reconcileId:"",parallelIndex:A}),t(lt(new Set([j]))),f&&xt.event(mt.ADD_LINE,{type:E})}}),t(vt(e.current.export())),t(ut())}else if(o==="free"&&g){const{x:X,y:Y}=et(N);y.x-X===0&&y.y-Y===0||(t(vt(e.current.export())),t(dt()))}it([]),at(void 0),l(void 0),t(ft(void 0))}),Pt=U((k,N)=>{if(N.stopPropagation(),N.shiftKey||t(St()),N.shiftKey&&s.has(k)?t(jt(k)):t(zt(k)),o.startsWith("station")||o.startsWith("misc-node-virtual")||o.startsWith("misc-node-master")){const X=N.clientX-document.getElementById("canvas").getBoundingClientRect().left,Y=N.clientY-document.getElementById("canvas").getBoundingClientRect().top,W=o.startsWith("station"),V=ht(10),n=W?"stn_".concat(V):"misc_node_".concat(V),p=W?o.slice(8):o.slice(10),{x:b,y:z}=J(X,Y,a,d),E=W?structuredClone(yt[p].defaultAttrs):structuredClone(gt[p].defaultAttrs);"color"in E&&(E.color=_),e.current.addNode(n,{visible:!0,zIndex:0,x:H(b,5),y:H(z,5),type:p,[p]:E});const j=e.current.getEdgeAttributes(k),{zIndex:S,type:L,style:A}=j,T=j[L],R=j[A],[O,F]=e.current.extremities(k),Et=i?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),O,n,{visible:!0,zIndex:S,type:L,[L]:structuredClone(T),style:A,[A]:structuredClone(R),reconcileId:"",parallelIndex:Et}),e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),n,F,{visible:!0,zIndex:S,type:L,[L]:structuredClone(T),style:A,[A]:structuredClone(R),reconcileId:"",parallelIndex:Et}),e.current.dropEdge(k),u(),f&&(xt.event(mt.ADD_STATION,{type:p}),xt.event(mt.ADD_LINE,{type:L})),t(tt("free")),t(lt(new Set([n])))}}),kt=$.useMemo(()=>[...Pe(e.current),...we(e.current)],[x,r]),ct=Qt.component;return m.jsxs(m.Fragment,{children:[m.jsx(Ce,{elements:kt,handlePointerDown:bt,handlePointerMove:At,handlePointerUp:wt,handleEdgePointerDown:Pt}),o.startsWith("line")&&g&&g!=="background"&&m.jsx(ct,{id:"line_create_in_progress___no_use",type:o.slice(5),path:K[o.slice(5)].generatePath(e.current.getNodeAttribute(g,"x"),e.current.getNodeAttribute(g,"x")-P.dx,e.current.getNodeAttribute(g,"y"),e.current.getNodeAttribute(g,"y")-P.dy,K[o.slice(5)].defaultAttrs),styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),ot.length!==0&&ot.map(k=>m.jsx("path",{d:K[G.Simple].generatePath(...he(k,_t(d,a,h,C)),K[G.Simple].defaultAttrs),stroke:"cyan",strokeWidth:a/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),rt&&m.jsx(ke,{activeSnapPoint:rt})]})},Be=()=>{const t=Rt(),e=$.useRef(window.graph),u=()=>{t(vt(e.current.export())),t(dt()),t(ut())},{activeSubscriptions:f}=Z(n=>n.account),{telemetry:{project:i},preference:{randomStationsNames:c,gridLines:w}}=Z(n=>n.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=Z(n=>n.param),{mode:s,lastTool:r,active:x,selected:o,keepLastPath:g,theme:v,count:{masters:_,lines:M}}=Z(n=>n.runtime),C=Ht(),{height:h,width:y}=Xt(C),l=!f.RMP_CLOUD&&_+1>te,P=!f.RMP_CLOUD&&M+1>ee,B=!f.RMP_CLOUD||c==="none";ne();const[D,q]=$.useState({x:0,y:0}),[I,Q]=$.useState({x:0,y:0}),[ot,it]=$.useState({x:0,y:0}),[rt,at]=$.useState({x:0,y:0}),bt=U(async n=>{const{x:p,y:b}=et(n);if(s.startsWith("station")||s.startsWith("misc-node")){t(tt("free"));const z=ht(10),{x:E,y:j}=J(p,b,a,d),S=s.startsWith("station"),L=S?"stn_".concat(z):"misc_node_".concat(z),A=S?s.slice(8):s.slice(10),T=structuredClone({...yt,...gt}[A].defaultAttrs);if(ie.has(A)&&(T.color=v),S&&!B){const R=T.names,O=await t(Bt(Lt.Shmetro));if(Bt.fulfilled.match(O)){const F=O.payload;R.length>F.length?F.push(...Array(R.length-F.length).fill(F.at(-1))):R.length<F.length&&F.splice(R.length,F.length-R.length),T.names=F}}e.current.addNode(L,{visible:!0,zIndex:0,x:H(E,5),y:H(j,5),type:A,[A]:T}),u(),i&&xt.event(mt.ADD_STATION,{type:A}),t(lt(new Set([L])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(tt("free")),g&&t(re(!1))),it({x:p,y:b}),at(d),n.shiftKey||(t(ft("background")),t(St()))):s==="select"&&(q(J(p,b,a,d)),Q(J(p,b,a,d)))}),At=U(n=>{if(s==="select"){if(D.x!=0&&D.y!=0){const{x:p,y:b}=et(n);Q(J(p,b,a,d))}}else if(x==="background"){const{x:p,y:b}=et(n);t(pt({x:rt.x+(ot.x-p)*a/100,y:rt.y+(ot.y-b)*a/100}))}}),wt=U(n=>{if(s==="select"){const{x:p,y:b}=et(n),{x:z,y:E}=J(p,b,a,d),j=Kt(e.current,D.x,D.y,z,E),S=ye(e.current,new Set(j));t(lt(new Set([...n.shiftKey?o:[],...j,...S]))),t(tt("free")),q({x:0,y:0}),Q({x:0,y:0})}x==="background"&&!n.shiftKey&&t(ft(void 0))}),Pt=U(n=>{let p=a;n.deltaY>0&&a+10<400?p=a+10:n.deltaY<0&&a-10>0&&(p=a-10),t(Nt(p));const{x:b,y:z}=et(n),E=n.currentTarget.getBoundingClientRect(),[j,S]=[b/E.width,z/E.height];t(pt({x:d.x+b*a/100-y*p/100*j,y:d.y+z*a/100-h*p/100*S}))}),kt=U(async n=>{if(st?n.key==="Backspace":n.key==="Delete")o.size>0&&(o.forEach(p=>{e.current.hasNode(p)?e.current.dropNode(p):e.current.hasEdge(p)&&e.current.dropEdge(p)}),t(St()),u());else if(n.key.startsWith("Arrow")){const b=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,z=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(J(100*b,100*z,a,d)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const b=(n.key==="j"?-1:n.key==="l"?1:0)*10,z=(n.key==="i"?-1:n.key==="k"?1:0)*10;o.size>0&&o.forEach(E=>{e.current.hasNode(E)&&(e.current.updateNodeAttribute(E,"x",j=>(j!=null?j:0)+b),e.current.updateNodeAttribute(E,"y",j=>(j!=null?j:0)+z),u())})}else if(n.key==="f"&&r)t(tt(r));else if(n.key==="z"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey))st&&n.preventDefault(),t(se()),t(dt()),t(ut());else if(n.key==="s")t(tt("select"));else if((n.key==="c"||n.key==="x")&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=ge(e.current,o);navigator.clipboard.writeText(p),n.key==="x"&&(t(St()),o.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),u())}else if(n.key==="v"&&(st?n.metaKey&&!n.shiftKey:n.ctrlKey)){const p=await navigator.clipboard.readText(),{x:b,y:z}=J(y/2,h/2,a,d),{nodes:E,edges:j}=pe(p,e.current,l,P,H(b,5),H(z,5));u();const S=structuredClone(E);j.forEach(L=>S.add(L)),t(lt(S))}else(st&&n.key==="z"&&n.metaKey&&n.shiftKey||!st&&n.key==="y"&&n.ctrlKey)&&(t(oe()),t(dt()),t(ut()))}),[ct,k]=$.useState(0),N=U(n=>{if(n.touches.length===2){t(ft(void 0));const[p,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];k(p*p+b*b)}}),X=U(n=>{if(ct!==0&&n.touches.length===2){const[p,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],z=p*p+b*b;let E=a;z-ct<0&&a+10<=390?E=a+10:z-ct>0&&a-10>=10&&(E=a-10),t(Nt(E)),k(z);const j=n.currentTarget.getBoundingClientRect(),[S,L]=[(n.touches[0].clientX+n.touches[1].clientX)/2-j.left,(n.touches[0].clientY+n.touches[1].clientY)/2-j.top],[A,T]=[S/j.width,L/j.height];t(pt({x:d.x+S*a/100-y*E/100*A,y:d.y+L*a/100-h*E/100*T}))}}),Y=U(n=>{ct!==0&&k(0)}),[W,V]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{V({sx:D.x<=I.x?D.x:I.x,ex:D.x>I.x?D.x:I.x,sy:D.y<=I.y?D.y:I.y,ey:D.y>I.y?D.y:I.y})},[I.x,I.y]),m.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:h,width:y,viewBox:"".concat(d.x," ").concat(d.y," ").concat(y*a/100," ").concat(h*a/100),onPointerDown:bt,onPointerMove:At,onPointerUp:wt,onTouchStart:N,onTouchMove:X,onTouchEnd:Y,onWheel:Pt,tabIndex:0,onKeyDown:kt,children:[w&&m.jsx(ve,{svgViewBoxMin:d,svgViewBoxZoom:a,svgWidth:y,svgHeight:h}),m.jsx(fe.SvgAssetsContextProvider,{children:m.jsx(_e,{})}),s==="select"&&D.x!=0&&D.y!=0&&m.jsx("rect",{x:W.sx,y:W.sy,width:W.ex-W.sx,height:W.ey-W.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),m.jsx("defs",{children:m.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[m.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),m.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Be as default};

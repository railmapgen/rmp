import{a as ye,j as c,P as xe,B as Qt,D as Ot,ad as pe,a2 as me}from"./chakra-C1zJvDsN.js";import{c as St,e as V,a7 as Tt,z as te,az as $t,aA as be,aB as ee,a4 as ne,w as wt,x as ht,y as ft,aC as Nt,F as pt,Y as lt,aD as se,aE as H,X as mt,aF as Wt,p as Ct,aG as Bt,aH as oe,L as et,aI as ot,aJ as dt,aK as Rt,n as vt,aL as ve,d as re,r as At,E as Pt,q as tt,aM as Mt,aN as we,aO as Se,aP as Ae,aQ as Lt,t as _t,v as zt,aR as xt,aS as Xt,aT as Vt,o as ie,aU as Pe,S as ke,aV as Ft,aW as Me,aX as It,aY as Ce,G as ae,H as Et,aZ as je,a_ as Ee,a$ as Ne,b0 as De,b1 as _e,b2 as ze,b3 as Le,b4 as Ie,b5 as Yt,b6 as Te,b7 as $e,b8 as We,ah as bt,aw as Be,ax as Re,a9 as Oe,a5 as Xe}from"./index-CUQl9dyW.js";import{s as gt,f as ce,c as Ve,e as Fe}from"./master-manager-Bz9-EadW.js";import{b as D,k as le,u as Ye}from"./react-BpF4RbzH.js";import{u as O}from"./useEvent-LzhclC4A.js";import{c as Dt}from"./change-types-CGHT_Gys.js";import{v as He,m as kt}from"./misc-nodes-BIJY6djb.js";const Ke={[Tt.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Tt.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ue=t=>{const e=Ke[t];return e.at(Math.floor(Math.random()*e.length))},Ht=le("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:d})=>{const{token:o}=e().account;if(!o){i($t({cityName:t,names:[]}));return}const n=await fetch("".concat(be,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!n.ok)return te.warn("Failed to fetch random station names",n.statusText),d(n.statusText);const y=await n.json();i($t({cityName:t,names:y}))}),Kt=le("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var p;const{stationNames:d}=e().runtime,o=d[t];if(((p=o==null?void 0:o.length)!=null?p:0)==0)return te.debug("No random station names in cache, using fallback"),i(Ht({cityName:t})),Object.values(Ue(t));const n=structuredClone(o),y=n.shift();return i($t({cityName:t,names:n})),n.length<3&&i(Ht({cityName:t})),Object.values(y)}),de=()=>{const t=St(),{activeSubscriptions:e}=V(o=>o.account),{preference:{randomStationsNames:i}}=V(o=>o.app),d=!e.RMP_CLOUD||i==="none";return D.useCallback(async o=>{const n=gt[o].defaultAttrs.names;if(!d){const y=await t(Kt(Tt.Shmetro));if(Kt.fulfilled.match(y)){const p=y.payload;return n.length>p.length?p.push(...Array(n.length-p.length).fill(p.at(-1))):n.length<p.length&&p.splice(n.length),p}}return structuredClone(n)},[t,d])},Ze=({isOpen:t,position:e,onClose:i})=>{const{t:d}=Ye(),o=St(),n=D.useRef(window.graph),{selected:y,count:{masters:p,lines:m}}=V(C=>C.runtime),{svgViewBoxZoom:r,svgViewBoxMin:s}=V(C=>C.param),{activeSubscriptions:u}=V(C=>C.account),l=!u.RMP_CLOUD&&p+1>ee,g=!u.RMP_CLOUD&&m+1>ne,f=y.size>0,w=D.useRef(null);ye({ref:w,handler:i,enabled:t});const b=D.useCallback(()=>{o(wt(n.current.export())),o(ht()),o(ft())},[o]),A=O(()=>{if(y.size>0){const C=Nt(n.current,y);navigator.clipboard.writeText(C)}}),x=O(()=>{if(y.size>0){const C=Nt(n.current,y);navigator.clipboard.writeText(C),o(pt()),y.forEach(W=>{n.current.hasNode(W)?n.current.dropNode(W):n.current.hasEdge(W)&&n.current.dropEdge(W)}),b()}}),S=O(async()=>{try{const C=await navigator.clipboard.readText(),{x:W,y:I}=lt(e.x,e.y,r,s),{nodes:rt,edges:X}=se(C,n.current,l,g,H(W,5),H(I,5));b();const _=structuredClone(rt);X.forEach(R=>_.add(R)),o(mt(_))}catch(C){console.warn("Failed to read clipboard:",C)}}),a=O(()=>{y.size>0&&(o(pt()),y.forEach(C=>{n.current.hasNode(C)?n.current.dropNode(C):n.current.hasEdge(C)&&n.current.dropEdge(C)}),b())}),M=O(()=>{o(ht()),o(ft())}),E=O(C=>{if(y.size>0){const W=Math.min(Math.max(C,-10),10);y.forEach(I=>{n.current.hasNode(I)&&n.current.setNodeAttribute(I,"zIndex",W),n.current.hasEdge(I)&&n.current.setEdgeAttribute(I,"zIndex",W)}),b()}}),T=O(()=>{if(y.size>0){const[C]=y,W=n.current.hasNode(C)?n.current.getNodeAttribute(C,"zIndex"):n.current.hasEdge(C)?n.current.getEdgeAttribute(C,"zIndex"):0;E(W+1)}}),B=O(()=>{if(y.size>0){const[C]=y,W=n.current.hasNode(C)?n.current.getNodeAttribute(C,"zIndex"):n.current.hasEdge(C)?n.current.getEdgeAttribute(C,"zIndex"):0;E(W-1)}});return t?c.jsx(xe,{children:c.jsxs(Qt,{ref:w,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[c.jsx(ct,{onClick:()=>{M(),i()},children:d("contextMenu.refresh")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{A(),i()},isDisabled:!f,children:d("contextMenu.copy")}),c.jsx(ct,{onClick:()=>{x(),i()},isDisabled:!f,children:d("contextMenu.cut")}),c.jsx(ct,{onClick:()=>{S(),i()},children:d("contextMenu.paste")}),c.jsx(ct,{onClick:()=>{a(),i()},isDisabled:!f,children:d("contextMenu.delete")}),c.jsx(Ot,{}),c.jsx(ct,{onClick:()=>{E(10),i()},isDisabled:!f,children:d("contextMenu.placeTop")}),c.jsx(ct,{onClick:()=>{E(-10),i()},isDisabled:!f,children:d("contextMenu.placeBottom")}),c.jsx(ct,{onClick:()=>{E(0),i()},isDisabled:!f,children:d("contextMenu.placeDefault")}),c.jsx(ct,{onClick:()=>{T(),i()},isDisabled:!f,children:d("contextMenu.placeUp")}),c.jsx(ct,{onClick:()=>{B(),i()},isDisabled:!f,children:d("contextMenu.placeDown")})]})}):null},ct=({children:t,onClick:e,isDisabled:i=!1})=>c.jsx(Qt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),qe=D.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:d,svgHeight:o}=t,{preference:{toolsPanel:{expand:n}}}=V(A=>A.app),p=pe().colorMode==="light"?"#666464":"#D3D3D4",m=Wt(e,i,d,o),r=n?410*i/100:0,s=i>30?i>120?50:25:5,u=i/200,l={startX:H(m.xMin+r-s,s),endX:H(m.xMax+r+s,s),startY:H(m.yMin-s,s),endY:H(m.yMax+s,s)},g=Array.from({length:(l.endX-l.startX)/s+1},(A,x)=>{const S=l.startX+x*s,a=S%(s*5)===0?2*u:u;return c.jsx("line",{x1:S,y1:l.startY,x2:S,y2:l.endY,strokeWidth:a,stroke:p,opacity:"0.5"},"grid_vl_".concat(S))}),f=Array.from({length:(l.endY-l.startY)/s+1},(A,x)=>{const S=l.startY+x*s,a=S%(s*5)===0?2*u:u;return c.jsx("line",{x1:l.startX,y1:S,x2:l.endX,y2:S,strokeWidth:a,stroke:p,opacity:"0.5"},"grid_hl_".concat(S))}),w=Array.from({length:(l.endX-l.startX)/s/5+1},(A,x)=>{const S=H(l.startX,5*s)+x*5*s;return c.jsx("text",{x:S,y:m.yMin+i/5,fontSize:u*25,fill:p,textAnchor:"middle",opacity:"0.5",children:S},"grid_vc_".concat(S))}),b=Array.from({length:(l.endY-l.startY)/s/5+1},(A,x)=>{const S=H(l.startY,5*s)+x*5*s;return c.jsx("text",{x:m.xMin+i/8+r,y:S,fontSize:u*25,fill:p,textAnchor:"start",opacity:"0.5",children:S},"grid_hc_".concat(S))});return c.jsxs("g",{id:"grid-lines",className:"removeMe",children:[g,f,w,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Ge=He.component,Ut=Bt.generatePath,Zt=oe.component,jt=10,Je=()=>{var X;const t=St(),e=()=>{t(wt(window.graph.export())),t(ht()),t(ft())},{telemetry:{project:i},preference:{autoParallel:d}}=V(_=>_.app),{selected:o,theme:n,count:{mostFrequentStationType:y}}=V(_=>_.runtime),p=de(),m=o.keys().next().value;if(!m.startsWith("stn")&&!m.startsWith("misc_node")||!window.graph.hasNode(m))return;const r=window.graph.neighbors(m);if(r.length===0)return;const s=window.graph.getNodeAttributes(m),u=r.reduce((_,R)=>{const q=window.graph.getNodeAttributes(R);return{x:_.x+q.x,y:_.y+q.y}},{x:0,y:0}),l={x:u.x/r.length,y:u.y/r.length},g={x:s.x-l.x,y:s.y-l.y},f={x:s.x+g.x,y:s.y+g.y},w=Math.sign(g.x)===Math.sign(g.y),b={x:f.x-jt,y:f.y+jt*(w?1:-1)},A={x:f.x+jt,y:f.y+jt*(w?-1:1)},x=m.startsWith("stn_")?window.graph.getNodeAttribute(m,"type"):y,S=gt[x].component,a={visible:!0,zIndex:0,x:A.x,y:A.y,type:x,[x]:gt[x].defaultAttrs},M=window.graph.reduceEdges(m,(_,R)=>{const q=window.graph.getEdgeAttributes(R),{style:ut}=q;if(ut===Ct.SingleColor){const it=JSON.stringify(q[ut].color);it in _?_[it]+=1:_[it]=1}return _},{}),E=(X=Object.entries(M).filter(([_,R])=>R%2!==0).reduce((_,[R,q])=>q>_.count?{color:JSON.parse(R),count:q}:_,{color:null,count:0}).color)!=null?X:n,T=g.x>0?!(g.x>Math.abs(g.y)):-g.x>Math.abs(g.y),B=T?"from":"to",C=Ut(s.x,b.x,s.y,b.y,{...Bt.defaultAttrs,startFrom:B}),W=T?"to":"from",I=Ut(s.x,A.x,s.y,A.y,{...Bt.defaultAttrs,startFrom:W}),rt=async(_,R)=>{R.stopPropagation();const{x:q,y:ut}=dt(R);t(Rt({x:q,y:ut}));const it=vt(10),at=ve.has(_),N=at?"stn_".concat(it):"misc_node_".concat(it),z=structuredClone({...gt,...kt}[_].defaultAttrs);re.has(_)&&(z.color=n),at&&(z.names=await p(_)),window.graph.addNode(N,{visible:!0,zIndex:0,x:at?A.x:b.x,y:at?A.y:b.y,type:_,[_]:z}),i&&At.event(Pt.ADD_STATION,{type:_});const K=et.Diagonal,Q="line_".concat(vt(10)),[G,U]=[m,N],Y=d?0:-1,J=at?W:B;window.graph.addDirectedEdgeWithKey(Q,G,U,{visible:!0,zIndex:0,type:K,[K]:{...structuredClone(tt[K].defaultAttrs),startFrom:J},style:Ct.SingleColor,[Ct.SingleColor]:{color:E},reconcileId:"",parallelIndex:Y}),i&&At.event(Pt.ADD_LINE,{type:K}),e(),t(Mt(N)),t(mt(new Set([N])))};return c.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[c.jsx(Zt,{id:"line_prediction_1",type:et.Diagonal,path:C,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),c.jsx(Zt,{id:"line_prediction_2",type:et.Diagonal,path:I,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),c.jsx(Ge,{id:"misc_node_virtual_prediction_1",attrs:{},x:b.x,y:b.y,handlePointerDown:(_,R)=>{rt(ot.Virtual,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),c.jsx(S,{id:"stn_virtual_prediction_2",attrs:a,x:A.x,y:A.y,handlePointerDown:(_,R)=>{rt(y,R)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},ue=(t,e,i,d,o,n)=>{if(!("offsetFrom"in n)||!("offsetTo"in n)||Number.isNaN(n.offsetFrom)||Number.isNaN(n.offsetTo))return;if(n.offsetFrom===n.offsetTo)return qt(t,e,i,d,o)?{x1:e,y1:i,x2:d,y2:o,offset:n.offsetFrom}:void 0;const[y,p]=[n.offsetFrom,n.offsetTo];for(let m=0;m<Math.PI;m+=Math.PI/8)for(let r=m,s=0;s<2;s++,r+=Math.PI){const[u,l,g,f]=[Math.sin(m)*y,Math.cos(m)*y,Math.sin(r)*p,Math.cos(r)*p];if(qt(t,e+u,i+l,d+g,o+f))return{x1:e+u,y1:i+l,x2:d+g,y2:o+f,offset:0}}},Qe=(t,e,i,d,o,n)=>t===i?{x1:t+5*n,y1:e,x2:i+5*n,y2:d,offset:o}:e===d?{x1:t,y1:e+5*n,x2:i,y2:d+5*n,offset:o}:{x1:t+5*Math.SQRT1_2*n,y1:e+5*Math.SQRT1_2*n,x2:i+5*Math.SQRT1_2*n,y2:d+5*Math.SQRT1_2*n,offset:o},qt=(t,e,i,d,o)=>!!((e===d||i===o)&&[et.Diagonal,et.Perpendicular].includes(t)||Math.abs((o-i)/(d-e))===1&&[et.Diagonal,et.RotatePerpendicular].includes(t)),tn=(t,e)=>{const i=[],d=[];return Object.values(e).forEach(o=>{var A;if(o.length===1){d.push(...o.map(x=>x.edge));return}const n=t.getEdgeAttribute(o.at(0),"type");if(!o.every(x=>t.getEdgeAttribute(x,"type")===n)){d.push(...o.map(x=>x.edge));return}const y=t.getEdgeAttribute(o.at(0),"style");if(!o.every(x=>t.getEdgeAttribute(x,"style")===y)){d.push(...o.map(x=>x.edge));return}const p={},m=new Set,r=new Set,s=Object.fromEntries(o.map(x=>{var M,E;const[S,a]=t.extremities(x);return p[S]=((M=p[S])!=null?M:0)+1,p[a]=((E=p[a])!=null?E:0)+1,m.add(S),r.add(a),[S,[x.edge,a]]})),u=Array.from(m).filter(x=>p[x]===1),l=Array.from(r).filter(x=>p[x]===1);if(u.length!==1||l.length!==1){d.push(...o.map(x=>x.edge));return}const g=u[0],f=l[0];if(g===f){d.push(...o.map(x=>x.edge));return}const w=[s[g][0]];let b=s[g][1];for(let x=1;x<o.length;x=x+1){const S=(A=s[b])==null?void 0:A.at(1);if(!S){d.push(...o.map(a=>a.edge));return}w.push(s[b][0]),b=S}if(b!==f||w.length!==o.length){d.push(...o.map(x=>x.edge));return}i.push(w)}),{allReconciledLines:i,danglingLines:d}},en=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var l,g,f;const[n,y]=t.extremities(o),p=t.getNodeAttributes(n),m=t.getNodeAttributes(y),{type:r}=t.getEdgeAttributes(o),s=(l=t.getEdgeAttribute(o,r))!=null?l:tt[r].defaultAttrs,u=ue(r,p.x,p.y,m.x,m.y,s);if(u){const{x1:w,y1:b,x2:A,y2:x,offset:S}=u;return tt[et.Simple].generatePath(w,A,b,x,{offset:S})}return(f=(g=tt[r])==null?void 0:g.generatePath(p.x,m.x,p.y,m.y,s))!=null?f:"M ".concat(p.x," ").concat(p.y," L ").concat(m.x," ").concat(m.y)});let d="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)d+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},nn=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),sn=t=>{const e={},i={},d=[],o={},n=[];for(const r of t.edgeEntries()){const[s,u,l,g]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],f=r.attributes[r.attributes.type],w=ue(r.attributes.type,s,u,l,g,f);i[r.edge]=w}for(const r of t.edgeEntries()){let s=i[r.edge];const{parallelIndex:u}=r.attributes;if(u>=0){const l=we(t,r.attributes.type,r.edge),g=i[l];if(!g){d.push(r);continue}if(u>0){const{x1:f,y1:w,x2:b,y2:A,offset:x}=g;s=Qe(f,w,b,A,x,u)}}if(r.attributes.reconcileId!==""){const l=r.attributes.reconcileId;l in o?o[l].push(r):o[l]=[r];continue}if(s){const l=r.edge,g=r.attributes,{x1:f,y1:w,x2:b,y2:A,offset:x}=s;e[l]={attr:g,path:tt[et.Simple].generatePath(f,b,w,A,{offset:x})};continue}n.push(r)}const y=new Set;for(;d.length;){const r=d.pop();if(y.has(r.edge))continue;const{parallel:s}=Se(t,r);if(!s.length)continue;s.forEach(l=>y.add(l.edge));const u=Ae(s);for(const l of s){const g=l.edge;e[g]={attr:l.attributes,path:u[g]}}}const{allReconciledLines:p,danglingLines:m}=tn(t,o);for(const r of p){const s=en(t,r);if(!s)continue;const u=r[0];e[u]={attr:t.getEdgeAttributes(u),path:s}}for(const r of m){const s=t.getEdgeAttributes(r),[u,l]=t.extremities(r),g=t.getNodeAttributes(u),f=t.getNodeAttributes(l);e[r]={attr:s,path:tt[et.Simple].generatePath(g.x,f.x,g.y,f.y,tt[et.Simple].defaultAttrs)}}for(const r of n){const s=r.edge,u=r.attributes.type,l=r.attributes,[g,f,w,b]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(u in tt)){e[s]={attr:l,path:"M ".concat(g," ").concat(f," L ").concat(w," ").concat(b)};continue}e[s]={attr:l,path:tt[u].generatePath(g,w,f,b,l[u])}}return Object.entries(e).map(([r,s])=>({id:r,type:"line",line:s}))},he=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Master&&e.getNodeAttributes(t)[ot.Master].nodeType==="Station",on=(t,e)=>{const i=[];return e.filter(d=>he(d,t)).forEach(d=>{const o=t.getNodeAttribute(d,"x"),n=t.getNodeAttribute(d,"y");i.push({a:1,b:0,c:-o,node:d,x:o,y:n}),i.push({a:0,b:1,c:-n,node:d,x:o,y:n}),i.push({a:1,b:-1,c:-o+n,node:d,x:o,y:n}),i.push({a:1,b:1,c:-o-n,node:d,x:o,y:n})}),i},fe=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),rn=(t,e,i,d)=>{let o=1/0,n={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(y=>d.includes(y.node)).forEach(y=>{const p=fe(y,t,e);p<o&&(o=p,n=y)}),{l:n,d:o}},an=(t,e,i,d,o)=>{const n=e.filter(r=>{const s=t.getNodeAttribute(r,"x"),u=t.getNodeAttribute(r,"y");return Math.abs(o.a*s+o.b*u+o.c)<=.01}),y=[(r,s,u,l)=>[(r+u)/2,(s+l)/2],(r,s,u,l)=>[2*r-u,2*s-l],(r,s,u,l)=>[2*u-r,2*l-s]];let p=1/0,m={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<n.length;r++){const s=n[r],u=t.getNodeAttribute(s,"x"),l=t.getNodeAttribute(s,"y");for(let g=r+1;g<n.length;g++){const f=n[g],w=t.getNodeAttribute(f,"x"),b=t.getNodeAttribute(f,"y");y.forEach(A=>{const[x,S]=A(u,l,w,b),a=Math.hypot(i-x,d-S);a<p&&(p=a,m={x,y:S,originalNodesPos:[{x:u,y:l},{x:w,y:b}]})})}}return{snapPoint:m,distance:p}},cn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=V(l=>l.param),d=l=>{const f=[{x:l.x,y:l.y},...l.originalNodesPos].sort((b,A)=>b.x===A.x?b.y-A.y:b.x-A.x),w=(f[1].y-f[0].y)/(f[1].x-f[0].x);if(Math.abs(w)<=.01)return{original:f,offset:f.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(w)>=1e10)return{original:f,offset:f.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const A=-1/w,x=10/Math.sqrt(A*A+1),S=10*A/Math.sqrt(A*A+1);return{original:f,offset:f.map(a=>({x:a.x+x,y:a.y+S})),rotate:-Math.atan(A)*(180/Math.PI)}}},{original:o,offset:n,rotate:y}=d(e),p=l=>{const g=Math.sqrt(3)/2*l,f="0,0",w="".concat(-l/2,",").concat(g),b="".concat(l/2,",").concat(g);return"".concat(f," ").concat(w," ").concat(b)},m=i/75,r=8*m,s="#FC8181",u="".concat(m*5," ").concat(m*2);return c.jsxs(c.Fragment,{children:[c.jsx("line",{x1:n[0].x,y1:n[0].y,x2:n[1].x,y2:n[1].y,stroke:s,strokeWidth:m,strokeDasharray:u}),c.jsx("line",{x1:n[1].x,y1:n[1].y,x2:n[2].x,y2:n[2].y,stroke:s,strokeWidth:m,strokeDasharray:u}),c.jsx("line",{x1:o[0].x,y1:o[0].y,x2:n[0].x,y2:n[0].y,stroke:s,strokeWidth:m,strokeDasharray:u}),c.jsx("line",{x1:o[1].x,y1:o[1].y,x2:n[1].x,y2:n[1].y,stroke:s,strokeWidth:m,strokeDasharray:u}),c.jsx("line",{x1:o[2].x,y1:o[2].y,x2:n[2].x,y2:n[2].y,stroke:s,strokeWidth:m,strokeDasharray:u}),c.jsx("polygon",{points:p(r),transform:"translate(".concat(n[0].x,",").concat(n[0].y,") rotate(").concat((y+270)%360,")"),fill:s}),c.jsx("polygon",{points:p(r),transform:"translate(".concat(n[1].x,",").concat(n[1].y,") rotate(").concat((y+270)%360,")"),fill:s}),c.jsx("polygon",{points:p(r),transform:"translate(".concat(n[1].x,",").concat(n[1].y,") rotate(").concat((y+90)%360,")"),fill:s}),c.jsx("polygon",{points:p(r),transform:"translate(".concat(n[2].x,",").concat(n[2].y,") rotate(").concat((y+90)%360,")"),fill:s})]})},Gt=t=>{const{id:e,x:i,y:d,handlePointerDown:o,handlePointerMove:n,handlePointerUp:y}=t,p=D.useCallback(s=>o(e,s),[e,o]),m=D.useCallback(s=>n(e,s),[e,n]),r=D.useCallback(s=>y(e,s),[e,y]);return c.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(d-6.4,")scale(0.025)"),onPointerDown:p,onPointerMove:m,onPointerUp:r,style:{cursor:"move"},children:c.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ln=t=>{const{id:e,path:i,handlePointerDown:d}=t,o=D.useCallback(n=>d(e,n),[e,d]);return c.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},dn=D.memo(t=>{var m,r,s,u,l,g,f,w,b,A,x,S;const{elements:e,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o,handleEdgePointerDown:n}=t,y=Object.fromEntries(Array.from({length:21},(a,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const M=a.line.attr.type,E=a.line.attr.style,T=a.line.attr[E],B=(m=Lt[E])==null?void 0:m.preComponent;B&&y[a.line.attr.zIndex].pre.push(c.jsx(B,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:n},"".concat(a.id,".pre")));const C=(s=(r=Lt[E])==null?void 0:r.component)!=null?s:ln;y[a.line.attr.zIndex].main.push(c.jsx(C,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:n},a.id));const W=(u=Lt[E])==null?void 0:u.postComponent;W&&y[a.line.attr.zIndex].post.push(c.jsx(W,{id:a.id,type:M,path:a.line.path,styleAttrs:T,newLine:!1,handlePointerDown:n},"".concat(a.id,".post")))}else if(a.type==="station"){const M=a.station,E=M.type,T=(l=gt[E])==null?void 0:l.preComponent;T&&y[a.station.zIndex].pre.push(c.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const B=(f=(g=gt[E])==null?void 0:g.component)!=null?f:Gt;y[a.station.zIndex].main.push(c.jsx(B,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const C=(w=gt[E])==null?void 0:w.postComponent;C&&y[a.station.zIndex].post.push(c.jsx(C,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const M=a.miscNode,E=M.type,T=(b=kt[E])==null?void 0:b.preComponent;T&&y[a.miscNode.zIndex].pre.push(c.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const B=(x=(A=kt[E])==null?void 0:A.component)!=null?x:Gt;y[a.miscNode.zIndex].main.push(c.jsx(B,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const C=(S=kt[E])==null?void 0:S.postComponent;C&&y[a.miscNode.zIndex].post.push(c.jsx(C,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,M)=>(M-10).toString()).map(a=>[...y[a].pre,...y[a].main,...y[a].post]).flat()},(t,e)=>t.elements===e.elements),un=[...Object.values(ke),ot.Virtual,ot.Master,ot.Fill,ot.LondonArrow,ot.ChongqingRTNumLineBadge2021,ot.ChongqingRTTextLineBadge2021,ot.ChengduRTLineBadge,ot.GzmtrLineBadge],hn=()=>{const t=St(),e=D.useRef(window.graph),i=()=>{t(wt(e.current.export())),t(ht()),t(ft())},{telemetry:{project:d},preference:{autoParallel:o,snapLines:n,autoChangeStationType:y}}=V(N=>N.app),{svgViewBoxZoom:p,svgViewBoxMin:m}=V(N=>N.param),{selected:r,pointerPosition:s,active:u,refresh:{nodes:l,edges:g},mode:f,keepLastPath:w,theme:b}=V(N=>N.runtime),A=_t(),{height:x,width:S}=zt(A),[a,M]=D.useState({dx:0,dy:0}),[E,T]=D.useState([]),[B,C]=D.useState([]),[W,I]=D.useState([]);D.useEffect(()=>{if(!s||!n)return;const N=Wt(m,p,S,x),z=ce(e.current,...Object.values(N));C(z),T(on(e.current,z))},[m,p,S,x,s]);const[rt,X]=D.useState(void 0),_=O((N,z)=>{z.stopPropagation(),z.currentTarget.setPointerCapture(z.pointerId);const{x:K,y:Q}=dt(z);f==="select"&&t(xt("free")),I([]),X(void 0),t(Rt({x:K,y:Q})),t(Mt(N)),z.shiftKey?r.has(N)?t(Xt(N)):t(Vt(N)):r.has(N)||t(mt(new Set([N])))}),R=O((N,z)=>{const{x:K,y:Q}=dt(z);if(z.currentTarget.setPointerCapture(z.pointerId),f==="free"&&u===N){if(!z.altKey&&n){const G=e.current.getNodeAttribute(N,"x"),U=e.current.getNodeAttribute(N,"y"),Y=G-(s.x-K)*p/100,J=U-(s.y-Q)*p/100;let F=Y,nt=J;if(he(N,e.current)){let v=W,P=rt;if(v.length!==0&&(v=v.filter(k=>fe(k,Y,J)<=6)),P&&(v.length===0||Math.hypot(Y-P.x,J-P.y)>6)&&(P=void 0),!P&&v.length===1){const k=v[0],{snapPoint:L,distance:$}=an(e.current,B.filter(Z=>!r.has(Z)),Y,J,k);$<=3&&(P=L)}if(v.length===1&&!P||v.length===0){const{l:k,d:L}=rn(Y,J,E,B.filter(Z=>!r.has(Z)&&!v.some(st=>st.node===Z))),$=v.length===0||!v.some(Z=>Z.a===k.a&&Z.b===k.b);L<3&&v.length<2&&$&&v.push(k)}if(v.length===1)if(P)F=P.x,nt=P.y;else{const k=v[0];if(k.a==0)nt=-k.c/k.b;else if(k.b==0)F=-k.c/k.a;else{const L=-k.a/k.b,$=-k.c/k.b;nt=L*F+$}}else if(v.length===2){const k=v[0],L=v[1],$=k.a*L.b-L.a*k.b;$!==0&&(F=-(k.c*L.b-L.c*k.b)/$,nt=-(k.a*L.c-L.a*k.c)/$)}I(v),X(P)}const h=F-G,j=nt-U;r.forEach(v=>{e.current.hasNode(v)&&e.current.updateNodeAttributes(v,P=>({...P,x:H(P.x+h,.01),y:H(P.y+j,.01)}))})}else I([]),X(void 0),r.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,U=>({...U,x:H(U.x-(s.x-K)*p/100,z.altKey?.01:5),y:H(U.y-(s.y-Q)*p/100,z.altKey?.01:5)}))});t(ht()),t(ft())}else f.startsWith("line")&&u&&M({dx:(s.x-K)*p/100,dy:(s.y-Q)*p/100})}),q=O((N,z)=>{var K,Q,G;if(z.currentTarget.releasePointerCapture(z.pointerId),f.startsWith("line")){w||t(xt("free"));const U=e.current.hasNode(u)&&un.includes(e.current.getNodeAttribute(u,"type")),Y=["stn_core_","virtual_circle_","misc_node_connectable_"],F=(G=(Q=(K=document.elementsFromPoint(z.clientX,z.clientY).at(0))==null?void 0:K.attributes)==null?void 0:Q.getNamedItem("id"))==null?void 0:G.value,nt=Y.find(h=>F==null?void 0:F.startsWith(h));if(U&&nt){const h=f.slice(5),j="line_".concat(vt(10)),[v,P]=[u,F.slice(nt.length)];if(v!==P){const k=o?ie(e.current,h,v,P,"from"):-1;e.current.addDirectedEdgeWithKey(j,v,P,{visible:!0,zIndex:0,type:h,[h]:structuredClone(tt[h].defaultAttrs),style:Ct.SingleColor,[Ct.SingleColor]:{color:b},reconcileId:"",parallelIndex:k}),y&&v.startsWith("stn")&&Dt(e.current,v),y&&P.startsWith("stn")&&Dt(e.current,P),t(mt(new Set([j]))),d&&At.event(Pt.ADD_LINE,{type:h}),t(wt(e.current.export())),t(ft())}}}else if(f==="free"&&u){const{x:U,y:Y}=dt(z);s.x-U===0&&s.y-Y===0||(t(wt(e.current.export())),t(ht()))}I([]),X(void 0),Rt(void 0),t(Mt(void 0))}),ut=O((N,z)=>{if(z.stopPropagation(),z.shiftKey||t(pt()),z.shiftKey&&r.has(N)?t(Xt(N)):t(Vt(N)),f.startsWith("station")||f.startsWith("misc-node-virtual")||f.startsWith("misc-node-master")){const K=z.clientX-document.getElementById("canvas").getBoundingClientRect().left,Q=z.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=f.startsWith("station"),U=vt(10),Y=G?"stn_".concat(U):"misc_node_".concat(U),J=G?f.slice(8):f.slice(10),{x:F,y:nt}=lt(K,Q,p,m),h=G?structuredClone(gt[J].defaultAttrs):structuredClone(kt[J].defaultAttrs);"color"in h&&(h.color=b),e.current.addNode(Y,{visible:!0,zIndex:0,x:H(F,5),y:H(nt,5),type:J,[J]:h});const j=e.current.getEdgeAttributes(N),{zIndex:v,type:P,style:k}=j,L=j[P],$=j[k],[Z,st]=e.current.extremities(N),yt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Z,Y,{visible:!0,zIndex:v,type:P,[P]:structuredClone(L),style:k,[k]:structuredClone($),reconcileId:"",parallelIndex:yt}),e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Y,st,{visible:!0,zIndex:v,type:P,[P]:structuredClone(L),style:k,[k]:structuredClone($),reconcileId:"",parallelIndex:yt}),e.current.dropEdge(N),i(),d&&(At.event(Pt.ADD_STATION,{type:J}),At.event(Pt.ADD_LINE,{type:P})),t(xt("free")),t(mt(new Set([Y])))}}),it=D.useMemo(()=>[...sn(e.current),...nn(e.current)],[g,l]),at=oe.component;return c.jsxs(c.Fragment,{children:[c.jsx(dn,{elements:it,handlePointerDown:_,handlePointerMove:R,handlePointerUp:q,handleEdgePointerDown:ut}),f.startsWith("line")&&u&&u!=="background"&&c.jsx(at,{id:"line_create_in_progress___no_use",type:f.slice(5),path:tt[f.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-a.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-a.dy,tt[f.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}}),W.length!==0&&W.map(N=>c.jsx("path",{d:tt[et.Simple].generatePath(...Pe(N,Wt(m,p,S,x)),tt[et.Simple].defaultAttrs),stroke:"cyan",strokeWidth:p/75},"snap_line_".concat(N.a,"_").concat(N.b,"_").concat(N.c,"_").concat(N.node))),rt&&c.jsx(cn,{activeSnapPoint:rt})]})},fn=()=>{const t=St(),{svgViewBoxZoom:e,svgViewBoxMin:i}=V(g=>g.param),{radialTouchMenu:d}=V(g=>g.runtime),o=D.useRef(window.graph),[n,y]=D.useState(0),p=_t(),{height:m,width:r}=zt(p),s=O(g=>{var f;if(g.touches.length==1){if(y(0),d.visible){t(Ft());return}const w=g.touches[0],b=(f=document.getElementById("canvas"))==null?void 0:f.getBoundingClientRect();if(!b)return;const A=w.clientX-b.left,x=w.clientY-b.top,S=lt(A,x,e,i),a=Me(o.current,S,t);[...a[It.STATION],...a[It.MISC_NODE],...a[It.LINE]].length>0?t(Ce({visible:!0,position:S,data:a})):(t(pt()),t(Ft()))}else if(g.touches.length==2){t(Mt(void 0));const[w,b]=[g.touches[0].clientX-g.touches[1].clientX,g.touches[0].clientY-g.touches[1].clientY];y(w*w+b*b)}}),u=O(g=>{if(g.touches.length==2&&n>0){const[f,w]=[g.touches[0].clientX-g.touches[1].clientX,g.touches[0].clientY-g.touches[1].clientY],b=f*f+w*w;let A=e;b-n<0&&e+10<=390?A=e+10:b-n>0&&e-10>=10&&(A=e-10),t(ae(A)),y(b);const x=g.currentTarget.getBoundingClientRect(),[S,a]=[(g.touches[0].clientX+g.touches[1].clientX)/2-x.left,(g.touches[0].clientY+g.touches[1].clientY)/2-x.top],[M,E]=[S/x.width,a/x.height];t(Et({x:i.x+S*e/100-r*A/100*M,y:i.y+a*e/100-m*A/100*E}))}}),l=O(g=>{y(0)});return c.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:m*e/100,fill:d.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:s,onTouchMove:u,onTouchEnd:l})},Jt=10,gn=()=>{const t=St(),e=D.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:d}=V(a=>a.param),{selected:o}=V(a=>a.runtime),n=_t(),{height:y,width:p}=zt(n),m=D.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),r=D.useCallback((a,M,E)=>{a.stopPropagation(),o.size>0&&(o.forEach(T=>{e.current.hasNode(T)&&(e.current.updateNodeAttribute(T,"x",B=>(B!=null?B:0)+M*Jt),e.current.updateNodeAttribute(T,"y",B=>(B!=null?B:0)+E*Jt))}),m())},[o,m]),s=D.useCallback(a=>r(a,0,-1),[r]),u=D.useCallback(a=>r(a,0,1),[r]),l=D.useCallback(a=>r(a,-1,0),[r]),g=D.useCallback(a=>r(a,1,0),[r]),f=D.useCallback(()=>{if(o.size>0){const a=Nt(e.current,o);navigator.clipboard.writeText(a)}},[o]),w=D.useCallback(()=>{o.size>0&&(t(pt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),m())},[o,t,m]),b=d.x+p*i/200,A=d.y+(y-100)*i/100,x=40,S=40;return c.jsxs("g",{transform:"translate(".concat(b,", ").concat(A,")scale(").concat(1.5*i/100,")"),children:[c.jsxs("g",{transform:"translate(0, -".concat(S,")"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:s}),c.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(0, ".concat(S,")"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),c.jsx(Ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", 0)"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),c.jsx(Ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", 0)"),children:[c.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:g}),c.jsx(De,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),c.jsx(_e,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),c.jsxs("g",{transform:"translate(-".concat(S,", ").concat(S,")"),children:[c.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:w}),c.jsx(ze,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Sn=()=>{const t=St(),e=D.useRef(window.graph),i=D.useCallback(()=>{t(wt(e.current.export())),t(ht()),t(ft())},[t]),{activeSubscriptions:d}=V(h=>h.account),{telemetry:{project:o},preference:{gridLines:n,snapLines:y,predictNextNode:p,autoParallel:m,autoChangeStationType:r}}=V(h=>h.app),{svgViewBoxZoom:s,svgViewBoxMin:u}=V(h=>h.param),{selected:l,active:g,isDetailsOpen:f,mode:w,lastTool:b,keepLastPath:A,theme:x,count:{masters:S,lines:a}}=V(h=>h.runtime),M=_t(),{height:E,width:T}=zt(M),B=!d.RMP_CLOUD&&S+1>ee,C=!d.RMP_CLOUD&&a+1>ne,W=de();Le();const[I,rt]=D.useState({x:0,y:0}),[X,_]=D.useState({x:0,y:0}),[R,q]=D.useState({isOpen:!1,position:{x:0,y:0}}),[ut,it]=D.useState({x:0,y:0}),[at,N]=D.useState({x:0,y:0}),z=O(async h=>{R.isOpen&&q({isOpen:!1,position:{x:0,y:0}});const{x:j,y:v}=dt(h);if(w.startsWith("station")||w.startsWith("misc-node")){t(xt("free"));const P=vt(10),{x:k,y:L}=lt(j,v,s,u),$=w.startsWith("station"),Z=$?"stn_".concat(P):"misc_node_".concat(P),st=$?w.slice(8):w.slice(10),yt=structuredClone({...gt,...kt}[st].defaultAttrs);re.has(st)&&(yt.color=x),$&&(yt.names=await W(st)),e.current.addNode(Z,{visible:!0,zIndex:0,x:H(k,5),y:H(L,5),type:st,[st]:yt}),o&&At.event(Pt.ADD_STATION,{type:st}),i(),t(mt(new Set([Z])))}else w==="free"||w.startsWith("line")?(w.startsWith("line")&&(t(xt("free")),A&&t(Xe(!1))),it({x:j,y:v}),N(u),h.shiftKey||(t(Mt("background")),t(pt()))):w==="select"&&(rt(lt(j,v,s,u)),_(lt(j,v,s,u)))}),K=O(h=>{if(w==="select"){if(I.x!=0&&I.y!=0){const{x:j,y:v}=dt(h);_(lt(j,v,s,u))}}else if(g==="background"){const{x:j,y:v}=dt(h);t(Et({x:at.x+(ut.x-j)*s/100,y:at.y+(ut.y-v)*s/100}))}}),Q=O(h=>{if(w==="select"){const{x:j,y:v}=dt(h),{x:P,y:k}=lt(j,v,s,u),L=ce(e.current,I.x,I.y,P,k),$=Fe(e.current,new Set(L));t(mt(new Set([...h.shiftKey?l:[],...L,...$]))),t(xt("free")),rt({x:0,y:0}),_({x:0,y:0})}g==="background"&&!h.shiftKey&&t(Mt(void 0))}),G=O(h=>{let j=s;h.deltaY>0&&s+10<400?j=s+10:h.deltaY<0&&s-10>0&&(j=s-10),t(ae(j));const{x:v,y:P}=dt(h),k=h.currentTarget.getBoundingClientRect(),[L,$]=[v/k.width,P/k.height];t(Et({x:u.x+v*s/100-T*j/100*L,y:u.y+P*s/100-E*j/100*$}))}),U=O(h=>{h.preventDefault(),dt(h),q({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),Y=O(()=>{q({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),J=O(async h=>{if(bt?h.key==="Backspace":h.key==="Delete")l.size>0&&(l.forEach(j=>{if(e.current.hasNode(j))e.current.dropNode(j);else if(e.current.hasEdge(j)){const[v,P]=e.current.extremities(j);e.current.dropEdge(j),r&&v.startsWith("stn")&&Dt(e.current,v),r&&P.startsWith("stn")&&Dt(e.current,P)}}),t(pt()),i());else if(h.key.startsWith("Arrow")){const v=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,P=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(Et(lt(100*v,100*P,s,u)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const v=(h.key==="j"?-1:h.key==="l"?1:0)*10,P=(h.key==="i"?-1:h.key==="k"?1:0)*10;l.size>0&&l.forEach(k=>{e.current.hasNode(k)&&(e.current.updateNodeAttribute(k,"x",L=>(L!=null?L:0)+v),e.current.updateNodeAttribute(k,"y",L=>(L!=null?L:0)+P),i())})}else if(h.key==="f"&&b)t(xt(b));else if(h.key==="z"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey))bt&&h.preventDefault(),t(Be()),t(ht()),t(ft());else if(h.key==="s")t(xt("select"));else if((h.key==="c"||h.key==="x")&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=Nt(e.current,l);navigator.clipboard.writeText(j),h.key==="x"&&(t(pt()),l.forEach(v=>{e.current.hasNode(v)?e.current.dropNode(v):e.current.hasEdge(v)&&e.current.dropEdge(v)}),i())}else if(h.key==="v"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=await navigator.clipboard.readText(),{x:v,y:P}=lt(T/2,E/2,s,u),{nodes:k,edges:L}=se(j,e.current,B,C,H(v,5),H(P,5));i();const $=structuredClone(k);L.forEach(Z=>$.add(Z)),t(mt($))}else if(bt&&h.key==="z"&&h.metaKey&&h.shiftKey||!bt&&h.key==="y"&&h.ctrlKey)t(Re());else if(h.key==="c")t(Oe(!y));else if(h.key==="e"){const[j]=l;if(l.size===1&&e.current.hasEdge(j)){const v=e.current.getEdgeAttributes(j),{type:P}=v;if(P!==et.Simple&&v[P]){const k=v[P],$=(k.startFrom||"from")==="from"?"to":"from";let Z=v.parallelIndex;if(m){const[yt,ge]=e.current.extremities(j);Z=ie(e.current,P,yt,ge,$)}const st={...k,startFrom:$};e.current.mergeEdgeAttributes(j,{[P]:st,parallelIndex:Z}),i()}}}}),[F,nt]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{nt({sx:I.x<=X.x?I.x:X.x,ex:I.x>X.x?I.x:X.x,sy:I.y<=X.y?I.y:X.y,ey:I.y>X.y?I.y:X.y})},[X.x,X.y]),c.jsxs(c.Fragment,{children:[c.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:E,width:T,viewBox:"".concat(u.x," ").concat(u.y," ").concat(T*s/100," ").concat(E*s/100),onPointerDown:z,onPointerMove:K,onPointerUp:Q,onWheel:G,onContextMenu:U,tabIndex:0,onKeyDown:J,children:[c.jsx("defs",{children:c.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[c.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),c.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),n&&c.jsx(qe,{svgViewBoxMin:u,svgViewBoxZoom:s,svgWidth:T,svgHeight:E}),Yt()&&w==="free"&&c.jsx(fn,{}),p&&l.size===1&&w==="free"&&c.jsx(Je,{}),c.jsx(Ve.SvgAssetsContextProvider,{children:c.jsx(hn,{})}),w==="select"&&I.x!=0&&I.y!=0&&c.jsx("rect",{x:F.sx,y:F.sy,width:F.ex-F.sx,height:F.ey-F.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Yt()&&[...l].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&c.jsx(gn,{}),c.jsx(Te,{})]}),c.jsx(Ze,{isOpen:R.isOpen,position:R.position,onClose:Y}),Ie()&&f==="hide"&&c.jsx(me,{"aria-label":"open details panel",icon:c.jsx(We,{style:{transform:"rotate(180deg)"}}),onClick:()=>t($e()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Sn as default};

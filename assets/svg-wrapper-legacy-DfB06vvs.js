!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach(function(e){n(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-nXMG1WKf.js","./index-legacy-CAqtN8Pk.js","./misc-nodes-legacy-BjPCBSFr.js","./react-legacy-n6CMfwan.js","./useEvent-legacy-D1mmFtZM.js","./change-types-legacy-BaFISoY6.js"],function(e,n){"use strict";var r,o,i,s,a,c,l,d,u,h,y,x,g,p,f,b,m,v,w,j,k,A,N,P,M,C,D,z,E,_,S,$,W,O,I,T,R,L,H,B,F,K,X,U,Y,V,q,Q,Z,J,G,ee,te,ne,re,oe,ie,se,ae,ce,le,de,ue,he,ye,xe,ge,pe,fe,be,me,ve,we,je,ke,Ae,Ne,Pe,Me,Ce,De,ze,Ee,_e,Se;return{setters:[e=>{r=e.a,o=e.j,i=e.P,s=e.B,a=e.D,c=e.ae,l=e.a3},e=>{d=e.c,u=e.e,h=e.A,y=e.aN,x=e.aO,g=e.ab,p=e.aG,f=e.a8,b=e.w,m=e.x,v=e.y,w=e.aP,j=e.z,k=e.a1,A=e.aQ,N=e.aR,P=e.a0,M=e.aS,C=e.t,D=e.aT,z=e.aU,E=e.L,_=e.p,S=e.aV,$=e.aW,W=e.n,O=e.aX,I=e.d,T=e.r,R=e.E,L=e.q,H=e.aY,B=e.aZ,F=e.a_,K=e.a$,X=e.aK,U=e.G,Y=e.H,V=e.aJ,q=e.b0,Q=e.b1,Z=e.aF,J=e.F,G=e.S,ee=e.b2,te=e.b3,ne=e.b4,re=e.b5,oe=e.B,ie=e.D,se=e.b6,ae=e.b7,ce=e.b8,le=e.b9,de=e.ba,ue=e.bb,he=e.bc,ye=e.bd,xe=e.be,ge=e.bf,pe=e.bg,fe=e.bh,be=e.am,me=e.aB,ve=e.aC,we=e.ad,je=e.a9},e=>{ke=e.s,Ae=e.v,Ne=e.b,Pe=e.f,Me=e.e,Ce=e.g},e=>{De=e.b,ze=e.h,Ee=e.u},e=>{_e=e.u},e=>{Se=e.e}],execute:function(){const n=(e,t)=>[...t].filter(t=>e.hasNode(t)),$e=(e,t)=>{const n=t.map(t=>e.getNodeAttribute(t,"x")),r=t.map(t=>e.getNodeAttribute(t,"y"));return{cx:(Math.min(...n)+Math.max(...n))/2,cy:(Math.min(...r)+Math.max(...r))/2}},We=(e,t,r)=>{const o=n(e,t);if(0===o.length)return!1;const{cx:i,cy:s}=$e(e,o),a=r*Math.PI/180,c=Math.sin(a),l=Math.cos(a);return o.forEach(t=>{const n=e.getNodeAttribute(t,"x"),r=e.getNodeAttribute(t,"y"),o=n-i,a=r-s,d=i+o*l-a*c,u=s+o*c+a*l;e.mergeNodeAttributes(t,{x:Number(d.toFixed(2)),y:Number(u.toFixed(2))})}),!0},Oe={[g.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[g.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ie=ze("runtime/getStationNames",async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:o}=t().account;if(!o)return void n(y({cityName:e,names:[]}));const i=await fetch(`${x}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o}`}});if(!i.ok)return h.warn("Failed to fetch random station names",i.statusText),r(i.statusText);const s=await i.json();n(y({cityName:e,names:s}))}),Te=ze("runtime/getOneStationName",async(e,{getState:t,dispatch:n})=>{var r;const{stationNames:o}=t().runtime,i=o[e];if(0==(null!==(r=null==i?void 0:i.length)&&void 0!==r?r:0))return h.debug("No random station names in cache, using fallback"),n(Ie({cityName:e})),Object.values((e=>{const t=Oe[e];return t.at(Math.floor(Math.random()*t.length))})(e));const s=structuredClone(i),a=s.shift();return n(y({cityName:e,names:s})),s.length<3&&n(Ie({cityName:e})),Object.values(a)}),Re=()=>{const e=d(),{activeSubscriptions:t}=u(e=>e.account),{preference:{randomStationsNames:n}}=u(e=>e.app),r=!t.RMP_CLOUD||"none"===n;return De.useCallback(async t=>{const o=ke[t].defaultAttrs.names;if(!r){const t=await e(Te(n));if(Te.fulfilled.match(t)){const e=t.payload;return o.length>e.length?e.push(...Array(o.length-e.length).fill(e.at(-1))):o.length<e.length&&e.splice(o.length),e}}return structuredClone(o)},[e,r,n])},Le=({isOpen:e,position:t,onClose:c})=>{const{t:l}=Ee(),h=d(),y=De.useRef(window.graph),{activeSubscriptions:x}=u(e=>e.account),{preference:{autoParallel:g}}=u(e=>e.app),{svgViewBoxZoom:M,svgViewBoxMin:C}=u(e=>e.param),{selected:D,count:{masters:z,lines:E}}=u(e=>e.runtime),_=!x.RMP_CLOUD&&z+1>p,S=!g||g&&!x.RMP_CLOUD&&E+1>f,$=D.size>0,W=De.useMemo(()=>[...D].filter(e=>y.current.hasNode(e)).length>1,[D]),O=De.useRef(null);r({ref:O,handler:c,enabled:e});const I=De.useCallback(()=>{h(b(y.current.export())),h(m()),h(v())},[h]),T=_e(()=>{if(D.size>0){const e=w(y.current,D);navigator.clipboard.writeText(e)}}),R=_e(()=>{if(D.size>0){const e=w(y.current,D);navigator.clipboard.writeText(e),h(j()),D.forEach(e=>{y.current.hasNode(e)?y.current.dropNode(e):y.current.hasEdge(e)&&y.current.dropEdge(e)}),I()}}),L=_e(async()=>{try{const e=await navigator.clipboard.readText(),{x:n,y:r}=k(t.x,t.y,M,C),{nodes:o,edges:i}=A(e,y.current,_,S,N(n,5),N(r,5));I();const s=structuredClone(o);i.forEach(e=>s.add(e)),h(P(s))}catch(e){console.warn("Failed to read clipboard:",e)}}),H=_e(()=>{D.size>0&&(h(j()),D.forEach(e=>{y.current.hasNode(e)?y.current.dropNode(e):y.current.hasEdge(e)&&y.current.dropEdge(e)}),I())}),B=_e(()=>{h(m()),h(v())}),F=_e(e=>{if(D.size>0){const t=Math.min(Math.max(e,-10),10);D.forEach(e=>{y.current.hasNode(e)&&y.current.setNodeAttribute(e,"zIndex",t),y.current.hasEdge(e)&&y.current.setEdgeAttribute(e,"zIndex",t)}),I()}}),K=_e(()=>{if(D.size>0){const[e]=D,t=y.current.hasNode(e)?y.current.getNodeAttribute(e,"zIndex"):y.current.hasEdge(e)?y.current.getEdgeAttribute(e,"zIndex"):0;F(t+1)}}),X=_e(()=>{if(D.size>0){const[e]=D;let t=0;y.current.hasNode(e)?t=y.current.getNodeAttribute(e,"zIndex"):y.current.hasEdge(e)&&(t=y.current.getEdgeAttribute(e,"zIndex")),F(t-1)}}),U=_e(e=>{We(y.current,D,e)&&I()}),Y=_e(e=>{((e,t,r)=>{const o=n(e,t);if(0===o.length)return!1;const{cx:i,cy:s}=$e(e,o);return o.forEach(t=>{const n=e.getNodeAttribute(t,"x"),o=e.getNodeAttribute(t,"y");let a=n,c=o;switch(r){case"vertical":a=2*i-n;break;case"horizontal":c=2*s-o;break;case"diagonal45":a=i+(o-s),c=s+(n-i);break;case"diagonal135":a=i-(o-s),c=s-(n-i)}e.mergeNodeAttributes(t,{x:Number(a.toFixed(2)),y:Number(c.toFixed(2))})}),!0})(y.current,D,e)&&I()});return e?o.jsx(i,{children:o.jsxs(s,{ref:O,position:"fixed",left:t.x,top:t.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,display:"flex",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[o.jsxs(s,{minW:"150px",children:[o.jsx(He,{onClick:()=>{B(),c()},children:l("contextMenu.refresh")}),o.jsx(a,{}),o.jsx(He,{onClick:()=>{T(),c()},isDisabled:!$,children:l("contextMenu.copy")}),o.jsx(He,{onClick:()=>{R(),c()},isDisabled:!$,children:l("contextMenu.cut")}),o.jsx(He,{onClick:()=>{L(),c()},children:l("contextMenu.paste")}),o.jsx(He,{onClick:()=>{H(),c()},isDisabled:!$,children:l("contextMenu.delete")}),o.jsx(a,{}),o.jsx(He,{onClick:()=>{F(10),c()},isDisabled:!$,children:l("contextMenu.placeTop")}),o.jsx(He,{onClick:()=>{F(-10),c()},isDisabled:!$,children:l("contextMenu.placeBottom")}),o.jsx(He,{onClick:()=>{F(0),c()},isDisabled:!$,children:l("contextMenu.placeDefault")})]}),o.jsx(s,{width:"0.5px",bg:"gray.200",alignSelf:"stretch",_dark:{bg:"gray.600"}}),o.jsxs(s,{minW:"150px",children:[o.jsx(He,{onClick:()=>{K(),c()},isDisabled:!$,children:l("contextMenu.placeUp")}),o.jsx(He,{onClick:()=>{X(),c()},isDisabled:!$,children:l("contextMenu.placeDown")}),o.jsx(a,{}),o.jsx(He,{onClick:()=>{U(45),c()},isDisabled:!W,children:l("contextMenu.rotateCW")}),o.jsx(He,{onClick:()=>{U(-45),c()},isDisabled:!W,children:l("contextMenu.rotateCCW")}),o.jsx(He,{onClick:()=>{Y("vertical"),c()},isDisabled:!W,children:l("contextMenu.flipVertical")}),o.jsx(He,{onClick:()=>{Y("horizontal"),c()},isDisabled:!W,children:l("contextMenu.flipHorizontal")}),o.jsx(He,{onClick:()=>{Y("diagonal45"),c()},isDisabled:!W,children:l("contextMenu.flipDiagonal45")}),o.jsx(He,{onClick:()=>{Y("diagonal135"),c()},isDisabled:!W,children:l("contextMenu.flipDiagonal135")})]})]})}):null},He=({children:e,onClick:t,isDisabled:n=!1})=>o.jsx(s,{px:3,py:2,cursor:n?"not-allowed":"pointer",opacity:n?.5:1,_hover:n?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:n?void 0:t,fontSize:"sm",children:e}),Be=De.memo(e=>{const{gridLineOffset:{x:t,y:n,zoom:r},svgWidth:i,svgHeight:s}=e,a={x:t,y:n},{preference:{toolsPanel:{expand:l}}}=u(e=>e.app),d="light"===c().colorMode?"#666464":"#D3D3D4",h=M(a,r,i,s),y=l?410*r/100:0,x=r>30?r>120?50:25:5,g=r/200,p={startX:N(h.xMin+y-x,x),endX:N(h.xMax+y+x,x),startY:N(h.yMin-x,x),endY:N(h.yMax+x,x)},f=Array.from({length:(p.endX-p.startX)/x+1},(e,t)=>{const n=p.startX+t*x,r=n%(5*x)==0?2*g:g;return o.jsx("line",{x1:n,y1:p.startY,x2:n,y2:p.endY,strokeWidth:r,stroke:d,opacity:"0.5"},`grid_vl_${n}`)}),b=Array.from({length:(p.endY-p.startY)/x+1},(e,t)=>{const n=p.startY+t*x,r=n%(5*x)==0?2*g:g;return o.jsx("line",{x1:p.startX,y1:n,x2:p.endX,y2:n,strokeWidth:r,stroke:d,opacity:"0.5"},`grid_hl_${n}`)}),m=Array.from({length:(p.endX-p.startX)/x/5+1},(e,t)=>{const n=N(p.startX,5*x)+5*t*x;return o.jsx("text",{x:n,y:h.yMin+r/5,fontSize:25*g,fill:d,textAnchor:"middle",opacity:"0.5",children:n},`grid_vc_${n}`)}),v=Array.from({length:(p.endY-p.startY)/x/5+1},(e,t)=>{const n=N(p.startY,5*x)+5*t*x;return o.jsx("text",{x:h.xMin+r/8+y,y:n,fontSize:25*g,fill:d,textAnchor:"start",opacity:"0.5",children:n},`grid_hc_${n}`)});return o.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,b,m,v]})},(e,t)=>e.gridLineOffset.x===t.gridLineOffset.x&&e.gridLineOffset.y===t.gridLineOffset.y&&e.gridLineOffset.zoom===t.gridLineOffset.zoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight),Fe=Ae.component,Ke=D.generatePath,Xe=z.component,Ue=()=>{var e;const n=d(),{activeSubscriptions:r}=u(e=>e.account),{telemetry:{project:i},preference:{autoParallel:s,randomStationsNames:a}}=u(e=>e.app),{selected:c,theme:l,count:{mostFrequentStationType:h},lastTool:y}=u(e=>e.runtime),x=Re(),g=c.keys().next().value;if(!g.startsWith("stn")&&!g.startsWith("misc_node"))return;if(!window.graph.hasNode(g))return;const p=window.graph.neighbors(g);if(0===p.length)return;const f=window.graph.getNodeAttributes(g),w=p.reduce((e,t)=>{const n=window.graph.getNodeAttributes(t);return{x:e.x+n.x,y:e.y+n.y}},{x:0,y:0}),j=w.x/p.length,k=w.y/p.length,A={x:f.x-j,y:f.y-k},N=f.x+A.x,M=f.y+A.y,z=Math.sign(A.x)===Math.sign(A.y),B={x:N-10,y:M+10*(z?1:-1)},F={x:N+10,y:M+10*(z?-1:1)},K=g.startsWith("stn_"),X=K?window.graph.getNodeAttribute(g,"type"):null!=y&&y.startsWith("station-")?y.slice(8):h,U=ke[X].component,Y={visible:!0,zIndex:0,x:F.x,y:F.y,type:X,[X]:ke[X].defaultAttrs};if(K){const e=structuredClone(window.graph.getNodeAttribute(g,X));Object.assign(Y,{[X]:e})}const V=window.graph.reduceEdges(g,(e,t)=>{const n=window.graph.getEdgeAttributes(t),{style:r}=n;if(r===C.SingleColor){const t=JSON.stringify(n[r].color);t in e?e[t]+=1:e[t]=1}return e},{}),q=null!==(e=Object.entries(V).filter(([e,t])=>t%2!=0).reduce((e,[t,n])=>n>e.count?{color:JSON.parse(t),count:n}:e,{color:null,count:0}).color)&&void 0!==e?e:l,Q=A.x>0?!(A.x>Math.abs(A.y)):-A.x>Math.abs(A.y),Z=Q?"from":"to",J=Ke(f.x,B.x,f.y,B.y,t(t({},D.defaultAttrs),{},{startFrom:Z})),G=Q?"to":"from",ee=Ke(f.x,F.x,f.y,F.y,t(t({},D.defaultAttrs),{},{startFrom:G})),te=async(e,o)=>{o.stopPropagation();const{x:c,y:d}=S(o);n($({x:c,y:d}));const u=W(10),h=O.has(e),y=h?`stn_${u}`:`misc_node_${u}`,p=structuredClone(h&&e===window.graph.getNodeAttribute(g,"type")?window.graph.getNodeAttribute(g,e):t(t({},ke),Ne)[e].defaultAttrs);I.has(e)&&(p.color=l);const f=!r.RMP_CLOUD||"none"===a;h&&!f&&(p.names=await x(e)),window.graph.addNode(y,{visible:!0,zIndex:0,x:h?F.x:B.x,y:h?F.y:B.y,type:e,[e]:p}),i&&T.event(R.ADD_STATION,{type:e});const w=E.Diagonal,j=`line_${W(10)}`,[k,A]=[g,y],N=s?0:-1,M=h?G:Z;window.graph.addDirectedEdgeWithKey(j,k,A,{visible:!0,zIndex:0,type:w,[w]:t(t({},structuredClone(L[w].defaultAttrs)),{},{startFrom:M}),style:C.SingleColor,[C.SingleColor]:{color:q},reconcileId:"",parallelIndex:N}),i&&T.event(R.ADD_LINE,{type:w}),n(b(window.graph.export())),n(m()),n(v()),n(H(y)),n(P(new Set([y])))};return o.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[o.jsx(Xe,{id:"line_prediction_1",type:E.Diagonal,path:J,styleAttrs:{color:q},newLine:!0,handlePointerDown:()=>{}}),o.jsx(Xe,{id:"line_prediction_2",type:E.Diagonal,path:ee,styleAttrs:{color:q},newLine:!0,handlePointerDown:()=>{}}),o.jsx(Fe,{id:"misc_node_virtual_prediction_1",attrs:{},x:B.x,y:B.y,handlePointerDown:(e,t)=>{te(_.Virtual,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),o.jsx(U,{id:"stn_virtual_prediction_2",attrs:Y,x:F.x,y:F.y,handlePointerDown:(e,t)=>{te(X,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Ye=(e,t,n,r,o,i)=>{if(!("offsetFrom"in i)||!("offsetTo"in i))return;if(Number.isNaN(i.offsetFrom)||Number.isNaN(i.offsetTo))return;if(i.offsetFrom===i.offsetTo)return qe(e,t,n,r,o)?{x1:t,y1:n,x2:r,y2:o,offset:i.offsetFrom}:void 0;const[s,a]=[i.offsetFrom,i.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let i=c,l=0;l<2;l++,i+=Math.PI){const[l,d,u,h]=[Math.sin(c)*s,Math.cos(c)*s,Math.sin(i)*a,Math.cos(i)*a];if(qe(e,t+l,n+d,r+u,o+h))return{x1:t+l,y1:n+d,x2:r+u,y2:o+h,offset:0}}},Ve=(e,t,n,r,o,i)=>e===n?{x1:e+5*i,y1:t,x2:n+5*i,y2:r,offset:o}:t===r?{x1:e,y1:t+5*i,x2:n,y2:r+5*i,offset:o}:{x1:e+5*Math.SQRT1_2*i,y1:t+5*Math.SQRT1_2*i,x2:n+5*Math.SQRT1_2*i,y2:r+5*Math.SQRT1_2*i,offset:o},qe=(e,t,n,r,o)=>!(t!==r&&n!==o||![E.Diagonal,E.Perpendicular].includes(e))||!(1!==Math.abs((o-n)/(r-t))||![E.Diagonal,E.RotatePerpendicular].includes(e)),Qe=(e,t)=>{if(!t.every(t=>e.hasEdge(t)))return;const n=t.map(t=>{var n,r,o;const[i,s]=e.extremities(t),a=e.getNodeAttributes(i),c=e.getNodeAttributes(s),{type:l}=e.getEdgeAttributes(t),d=null!==(n=e.getEdgeAttribute(t,l))&&void 0!==n?n:L[l].defaultAttrs,u=Ye(l,a.x,a.y,c.x,c.y,d);if(u){const{x1:e,y1:t,x2:n,y2:r,offset:o}=u;return L[E.Simple].generatePath(e,n,t,r,{offset:o})}return null!==(r=null===(o=L[l])||void 0===o?void 0:o.generatePath(a.x,c.x,a.y,c.y,d))&&void 0!==r?r:`M ${a.x} ${a.y} L ${c.x} ${c.y}`});let r=`${n[0]} `;for(let o=1;o<t.length;o+=1)r+=n[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},Ze=e=>[...e.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Je=e=>{const t={},n={},r=[],o={},i=[];for(const l of e.edgeEntries()){const[e,t,r,o]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y],i=l.attributes[l.attributes.type],s=Ye(l.attributes.type,e,t,r,o,i);n[l.edge]=s}for(const l of e.edgeEntries()){let s=n[l.edge];const{parallelIndex:a}=l.attributes;if(a>=0){const t=n[B(e,l.attributes.type,l.edge)];if(!t){r.push(l);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:o,offset:i}=t;s=Ve(e,n,r,o,i,a)}}if(""!==l.attributes.reconcileId){const e=l.attributes.reconcileId;e in o?o[e].push(l):o[e]=[l];continue}if(s){const e=l.edge,n=l.attributes,{x1:r,y1:o,x2:i,y2:a,offset:c}=s;t[e]={attr:n,path:L[E.Simple].generatePath(r,i,o,a,{offset:c})};continue}i.push(l)}const s=new Set;for(;r.length;){const n=r.pop();if(s.has(n.edge))continue;const{parallel:o}=F(e,n);if(!o.length)continue;o.forEach(e=>s.add(e.edge));const i=K(o);for(const e of o){const n=e.edge;t[n]={attr:e.attributes,path:i[n]}}}const{allReconciledLines:a,danglingLines:c}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach(t=>{if(1===t.length)return void r.push(...t.map(e=>e.edge));const o=e.getEdgeAttribute(t.at(0),"type");if(!t.every(t=>e.getEdgeAttribute(t,"type")===o))return void r.push(...t.map(e=>e.edge));const i=e.getEdgeAttribute(t.at(0),"style");if(!t.every(t=>e.getEdgeAttribute(t,"style")===i))return void r.push(...t.map(e=>e.edge));const s={},a=new Set,c=new Set,l=Object.fromEntries(t.map(t=>{var n,r;const[o,i]=e.extremities(t);return s[o]=(null!==(n=s[o])&&void 0!==n?n:0)+1,s[i]=(null!==(r=s[i])&&void 0!==r?r:0)+1,a.add(o),c.add(i),[o,[t.edge,i]]})),d=Array.from(a).filter(e=>1===s[e]),u=Array.from(c).filter(e=>1===s[e]);if(1!==d.length||1!==u.length)return void r.push(...t.map(e=>e.edge));const h=d[0],y=u[0];if(h===y)return void r.push(...t.map(e=>e.edge));const x=[l[h][0]];let g=l[h][1];for(let e=1;e<t.length;e+=1){var p;const e=null===(p=l[g])||void 0===p?void 0:p.at(1);if(!e)return void r.push(...t.map(e=>e.edge));x.push(l[g][0]),g=e}g===y&&x.length===t.length?n.push(x):r.push(...t.map(e=>e.edge))}),{allReconciledLines:n,danglingLines:r}})(e,o);for(const l of a){const n=Qe(e,l);if(!n)continue;const r=l[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const l of c){const n=e.getEdgeAttributes(l),[r,o]=e.extremities(l),i=e.getNodeAttributes(r),s=e.getNodeAttributes(o);t[l]={attr:n,path:L[E.Simple].generatePath(i.x,s.x,i.y,s.y,L[E.Simple].defaultAttrs)}}for(const l of i){const e=l.edge,n=l.attributes.type,r=l.attributes,[o,i,s,a]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y];n in L?t[e]={attr:r,path:L[n].generatePath(o,s,i,a,r[n])}:t[e]={attr:r,path:`M ${o} ${i} L ${s} ${a}`}}return Object.entries(t).map(([e,t])=>({id:e,type:"line",line:t}))},Ge=(e,t)=>e.startsWith("stn")||e.startsWith("misc_node")&&t.getNodeAttribute(e,"type")===_.Virtual||e.startsWith("misc_node")&&t.getNodeAttribute(e,"type")===_.Master&&"Station"===t.getNodeAttributes(e)[_.Master].nodeType,et=(e,t,n)=>Math.abs(e.a*t+e.b*n+e.c)/Math.sqrt(e.a**2+e.b**2),tt=(e,t)=>{const{xMin:n,yMin:r,xMax:o,yMax:i}=t;if(0===e.a)return[n,o,-e.c/e.b,-e.c/e.b];if(0===e.b)return[-e.c/e.a,-e.c/e.a,r,i];{const t=-e.a/e.b,r=-e.c/e.b;return[n,o,t*n+r,t*o+r]}},nt=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=u(e=>e.param),{original:r,offset:i,rotate:s}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map(e=>({x:e.x,y:e.y+10})),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map(e=>({x:e.x+10,y:e.y})),rotate:90};{const e=10,r=-1/n,o=e/Math.sqrt(r*r+1),i=e*r/Math.sqrt(r*r+1);return{original:t,offset:t.map(e=>({x:e.x+o,y:e.y+i})),rotate:-Math.atan(r)*(180/Math.PI)}}})(t),a=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${`${-e/2},${t}`} ${`${e/2},${t}`}`},c=n/75,l=8*c,d="#FC8181",h=`${5*c} ${2*c}`;return o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:i[0].x,y1:i[0].y,x2:i[1].x,y2:i[1].y,stroke:d,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:i[1].x,y1:i[1].y,x2:i[2].x,y2:i[2].y,stroke:d,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[0].x,y1:r[0].y,x2:i[0].x,y2:i[0].y,stroke:d,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[1].x,y1:r[1].y,x2:i[1].x,y2:i[1].y,stroke:d,strokeWidth:c,strokeDasharray:h}),o.jsx("line",{x1:r[2].x,y1:r[2].y,x2:i[2].x,y2:i[2].y,stroke:d,strokeWidth:c,strokeDasharray:h}),o.jsx("polygon",{points:a(l),transform:`translate(${i[0].x},${i[0].y}) rotate(${(s+270)%360})`,fill:d}),o.jsx("polygon",{points:a(l),transform:`translate(${i[1].x},${i[1].y}) rotate(${(s+270)%360})`,fill:d}),o.jsx("polygon",{points:a(l),transform:`translate(${i[1].x},${i[1].y}) rotate(${(s+90)%360})`,fill:d}),o.jsx("polygon",{points:a(l),transform:`translate(${i[2].x},${i[2].y}) rotate(${(s+90)%360})`,fill:d})]})},rt=e=>{const{id:t,x:n,y:r,handlePointerDown:i,handlePointerMove:s,handlePointerUp:a}=e,c=De.useCallback(e=>i(t,e),[t,i]),l=De.useCallback(e=>s(t,e),[t,s]),d=De.useCallback(e=>a(t,e),[t,a]);return o.jsx("g",{id:t,transform:`translate(${n-6.4} ${r-6.4})scale(0.025)`,onPointerDown:c,onPointerMove:l,onPointerUp:d,style:{cursor:"move"},children:o.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ot=e=>{const{id:t,path:n,handlePointerDown:r}=e,i=De.useCallback(e=>r(t,e),[t,r]);return o.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},it=De.memo(e=>{const{elements:t,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i,handleEdgePointerDown:s}=e,a=Object.fromEntries(Array.from({length:21},(e,t)=>[t-10,{pre:[],main:[],post:[]}]));for(const v of t)if("line"===v.type){var c,l,d,u;const e=v.line.attr.type,t=v.line.attr.style,n=v.line.attr[t],r=null===(c=X[t])||void 0===c?void 0:c.preComponent;r&&a[v.line.attr.zIndex].pre.push(o.jsx(r,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${v.id}.pre`));const i=null!==(l=null===(d=X[t])||void 0===d?void 0:d.component)&&void 0!==l?l:ot;a[v.line.attr.zIndex].main.push(o.jsx(i,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},v.id));const h=null===(u=X[t])||void 0===u?void 0:u.postComponent;h&&a[v.line.attr.zIndex].post.push(o.jsx(h,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:s},`${v.id}.post`))}else if("station"===v.type){var h,y,x,g;const e=v.station,t=e.type,s=null===(h=ke[t])||void 0===h?void 0:h.preComponent;s&&a[v.station.zIndex].pre.push(o.jsx(s,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${v.id}.pre`));const c=null!==(y=null===(x=ke[t])||void 0===x?void 0:x.component)&&void 0!==y?y:rt;a[v.station.zIndex].main.push(o.jsx(c,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},v.id));const l=null===(g=ke[t])||void 0===g?void 0:g.postComponent;l&&a[v.station.zIndex].post.push(o.jsx(l,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${v.id}.post`))}else if("misc-node"===v.type){var p,f,b,m;const e=v.miscNode,t=e.type,s=null===(p=Ne[t])||void 0===p?void 0:p.preComponent;s&&a[v.miscNode.zIndex].pre.push(o.jsx(s,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${v.id}.pre`));const c=null!==(f=null===(b=Ne[t])||void 0===b?void 0:b.component)&&void 0!==f?f:rt;a[v.miscNode.zIndex].main.push(o.jsx(c,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},v.id));const l=null===(m=Ne[t])||void 0===m?void 0:m.postComponent;l&&a[v.miscNode.zIndex].post.push(o.jsx(l,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:i},`${v.id}.post`))}return Array.from({length:21},(e,t)=>(t-10).toString()).map(e=>[...a[e].pre,...a[e].main,...a[e].post]).flat()},(e,t)=>e.elements===t.elements),st=[...Object.values(G),_.Virtual,_.Master,_.Fill,_.LondonArrow,_.ChongqingRTNumLineBadge2021,_.ChongqingRTTextLineBadge2021,_.ChengduRTLineBadge,_.GzmtrLineBadge],at=()=>{const e=d(),n=De.useRef(window.graph),{telemetry:{project:r},preference:{autoParallel:i,snapLines:s,autoChangeStationType:a}}=u(e=>e.app),{svgViewBoxZoom:c,svgViewBoxMin:l}=u(e=>e.param),{selected:h,pointerPosition:y,active:x,refresh:{nodes:g,edges:p},mode:f,keepLastPath:w,theme:A}=u(e=>e.runtime),D=U(),{height:z,width:_}=Y(D),[O,I]=De.useState({dx:0,dy:0}),[B,F]=De.useState([]),[K,G]=De.useState([]),[ee,te]=De.useState([]);De.useEffect(()=>{if(!y||!s)return;const e=M(l,c,_,z),t=Pe(n.current,...Object.values(e));G(t),F(((e,t)=>{const n=[];return t.filter(t=>Ge(t,e)).forEach(t=>{const r=e.getNodeAttribute(t,"x"),o=e.getNodeAttribute(t,"y");n.push({a:1,b:0,c:-r,node:t,x:r,y:o}),n.push({a:0,b:1,c:-o,node:t,x:r,y:o}),n.push({a:1,b:-1,c:-r+o,node:t,x:r,y:o}),n.push({a:1,b:1,c:-r-o,node:t,x:r,y:o})}),n})(n.current,t))},[l,c,_,z,y]);const[ne,re]=De.useState(void 0),oe=_e((t,n)=>{n.stopPropagation(),n.currentTarget.setPointerCapture(n.pointerId);const{x:r,y:o}=S(n);"select"===f&&e(V("free")),te([]),re(void 0),e($({x:r,y:o})),e(H(t)),n.shiftKey?h.has(t)?e(q(t)):e(Q(t)):h.has(t)||e(P(new Set([t])))}),ie=_e((r,o)=>{const{x:i,y:a}=S(o);if(o.currentTarget.setPointerCapture(o.pointerId),"free"===f&&x===r){if(!o.altKey&&s){const e=n.current.getNodeAttribute(r,"x"),o=n.current.getNodeAttribute(r,"y"),s=e-(y.x-i)*c/100,l=o-(y.y-a)*c/100;let d=s,u=l;if(Ge(r,n.current)){let e=ee,t=ne;if(0!==e.length&&(e=e.filter(e=>et(e,s,l)<=6)),t&&(0===e.length||Math.hypot(s-t.x,l-t.y)>6)&&(t=void 0),!t&&1===e.length){const r=e[0],{snapPoint:o,distance:i}=((e,t,n,r,o)=>{const i=t.filter(t=>{const n=e.getNodeAttribute(t,"x"),r=e.getNodeAttribute(t,"y");return Math.abs(o.a*n+o.b*r+o.c)<=.01}),s=[(e,t,n,r)=>[(e+n)/2,(t+r)/2],(e,t,n,r)=>[2*e-n,2*t-r],(e,t,n,r)=>[2*n-e,2*r-t]];let a=1/0,c={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let l=0;l<i.length;l++){const t=i[l],o=e.getNodeAttribute(t,"x"),d=e.getNodeAttribute(t,"y");for(let u=l+1;u<i.length;u++){const t=i[u],l=e.getNodeAttribute(t,"x"),h=e.getNodeAttribute(t,"y");s.forEach(e=>{const[t,i]=e(o,d,l,h),s=Math.hypot(n-t,r-i);s<a&&(a=s,c={x:t,y:i,originalNodesPos:[{x:o,y:d},{x:l,y:h}]})})}}return{snapPoint:c,distance:a}})(n.current,K.filter(e=>!h.has(e)),s,l,r);i<=3&&(t=o)}if(1===e.length&&!t||0===e.length){const{l:t,d:n}=((e,t,n,r)=>{let o=1/0,i={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return n.filter(e=>r.includes(e.node)).forEach(n=>{const r=et(n,e,t);r<o&&(o=r,i=n)}),{l:i,d:o}})(s,l,B,K.filter(t=>!h.has(t)&&!e.some(e=>e.node===t))),r=0===e.length||!e.some(e=>e.a===t.a&&e.b===t.b);n<3&&e.length<2&&r&&e.push(t)}if(1===e.length)if(t)d=t.x,u=t.y;else{const t=e[0];if(0==t.a)u=-t.c/t.b;else if(0==t.b)d=-t.c/t.a;else{u=-t.a/t.b*d+-t.c/t.b}}else if(2===e.length){const t=e[0],n=e[1],r=t.a*n.b-n.a*t.b;0!==r&&(d=-(t.c*n.b-n.c*t.b)/r,u=-(t.a*n.c-n.a*t.c)/r)}te(e),re(t)}const x=d-e,g=u-o;h.forEach(e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,e=>t(t({},e),{},{x:N(e.x+x,.01),y:N(e.y+g,.01)}))})}else te([]),re(void 0),h.forEach(e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,e=>t(t({},e),{},{x:N(e.x-(y.x-i)*c/100,o.altKey?.01:5),y:N(e.y-(y.y-a)*c/100,o.altKey?.01:5)}))});e(m()),e(v())}else f.startsWith("line")&&x&&I({dx:(y.x-i)*c/100,dy:(y.y-a)*c/100})}),se=_e((t,o)=>{if(o.currentTarget.releasePointerCapture(o.pointerId),f.startsWith("line")){var s;w||e(V("free"));const t=n.current.hasNode(x)&&st.includes(n.current.getNodeAttribute(x,"type")),c=["stn_core_","virtual_circle_","misc_node_connectable_"],l=null===(s=document.elementsFromPoint(o.clientX,o.clientY).at(0))||void 0===s||null===(s=s.attributes)||void 0===s||null===(s=s.getNamedItem("id"))||void 0===s?void 0:s.value,d=c.find(e=>null==l?void 0:l.startsWith(e));if(t&&d){const{path:t,style:o}=Z(f),[s,c]=[t,o],u=`line_${W(10)}`,[h,y]=[x,l.slice(d.length)];if(h!==y){const t=structuredClone(X[c].defaultAttrs);"color"in t&&c!==C.River&&(t.color=A);const o=i?J(n.current,s,h,y,"from"):-1;n.current.addDirectedEdgeWithKey(u,h,y,{visible:!0,zIndex:0,type:s,[s]:structuredClone(L[s].defaultAttrs),style:c,[c]:t,reconcileId:"",parallelIndex:o}),a&&h.startsWith("stn")&&Se(n.current,h),a&&y.startsWith("stn")&&Se(n.current,y),e(P(new Set([u]))),r&&T.event(R.ADD_LINE,{type:s}),e(b(n.current.export())),e(v())}}}else if("free"===f&&x){const{x:t,y:r}=S(o);y.x-t===0&&y.y-r===0||(e(b(n.current.export())),e(m()))}te([]),re(void 0),$(void 0),e(H(void 0))}),ae=_e((t,o)=>{if(o.stopPropagation(),o.shiftKey||e(j()),o.shiftKey&&h.has(t)?e(q(t)):e(Q(t)),f.startsWith("station")||f.startsWith("misc-node-virtual")||f.startsWith("misc-node-master")){const s=o.clientX-document.getElementById("canvas").getBoundingClientRect().left,a=o.clientY-document.getElementById("canvas").getBoundingClientRect().top,d=f.startsWith("station"),u=W(10),h=d?`stn_${u}`:`misc_node_${u}`,y=d?f.slice(8):f.slice(10),{x:x,y:g}=k(s,a,c,l),p=d?structuredClone(ke[y].defaultAttrs):structuredClone(Ne[y].defaultAttrs);"color"in p&&(p.color=A),n.current.addNode(h,{visible:!0,zIndex:0,x:N(x,5),y:N(g,5),type:y,[y]:p});const w=n.current.getEdgeAttributes(t),{zIndex:j,type:M,style:C}=w,D=w[M],z=w[C],[E,_]=n.current.extremities(t),S=i?0:-1;n.current.addDirectedEdgeWithKey(`line_${W(10)}`,E,h,{visible:!0,zIndex:j,type:M,[M]:structuredClone(D),style:C,[C]:structuredClone(z),reconcileId:"",parallelIndex:S}),n.current.addDirectedEdgeWithKey(`line_${W(10)}`,h,_,{visible:!0,zIndex:j,type:M,[M]:structuredClone(D),style:C,[C]:structuredClone(z),reconcileId:"",parallelIndex:S}),n.current.dropEdge(t),e(b(n.current.export())),e(m()),e(v()),r&&(T.event(R.ADD_STATION,{type:y}),T.event(R.ADD_LINE,{type:M})),e(V("free")),e(P(new Set([h])))}}),ce=De.useMemo(()=>[...Je(n.current),...Ze(n.current)],[p,g]),{path:le,style:de}=Z(f),ue=le||E.Diagonal,he=de||C.SingleColor,ye=X[he].component,xe=structuredClone(X[he].defaultAttrs);return"color"in xe&&he!==C.River&&(xe.color=A),o.jsxs(o.Fragment,{children:[o.jsx(it,{elements:ce,handlePointerDown:oe,handlePointerMove:ie,handlePointerUp:se,handleEdgePointerDown:ae}),f.startsWith("line")&&x&&"background"!==x&&o.jsx(ye,{id:"line_create_in_progress___no_use",type:ue,path:L[ue].generatePath(n.current.getNodeAttribute(x,"x"),n.current.getNodeAttribute(x,"x")-O.dx,n.current.getNodeAttribute(x,"y"),n.current.getNodeAttribute(x,"y")-O.dy,L[ue].defaultAttrs),styleAttrs:xe,newLine:!0,handlePointerDown:()=>{}}),0!==ee.length&&ee.map(e=>o.jsx("path",{d:L[E.Simple].generatePath(...tt(e,M(l,c,_,z)),L[E.Simple].defaultAttrs),stroke:"cyan",strokeWidth:c/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`)),ne&&o.jsx(nt,{activeSnapPoint:ne})]})},ct=()=>{const e=d(),{svgViewBoxZoom:t,svgViewBoxMin:n}=u(e=>e.param),{radialTouchMenu:r}=u(e=>e.runtime),i=De.useRef(window.graph),[s,a]=De.useState(0),c=U(),{height:l,width:h}=Y(c),y=_e(o=>{if(1==o.touches.length){var s;if(a(0),r.visible)return void e(ee());const c=o.touches[0],l=null===(s=document.getElementById("canvas"))||void 0===s?void 0:s.getBoundingClientRect();if(!l)return;const d=c.clientX-l.left,u=c.clientY-l.top,h=k(d,u,t,n),y=te(i.current,h,e);[...y[ne.STATION],...y[ne.MISC_NODE],...y[ne.LINE]].length>0?e(re({visible:!0,position:h,data:y})):(e(j()),e(ee()))}else if(2==o.touches.length){e(H(void 0));const[t,n]=[o.touches[0].clientX-o.touches[1].clientX,o.touches[0].clientY-o.touches[1].clientY];a(t*t+n*n)}}),x=_e(r=>{if(2==r.touches.length&&s>0){const[o,i]=[r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY],c=o*o+i*i;let d=t;c-s<0&&t+10<=390?d=t+10:c-s>0&&t-10>=10&&(d=t-10),e(oe(d)),a(c);const u=r.currentTarget.getBoundingClientRect(),[y,x]=[(r.touches[0].clientX+r.touches[1].clientX)/2-u.left,(r.touches[0].clientY+r.touches[1].clientY)/2-u.top],[g,p]=[y/u.width,x/u.height];e(ie({x:n.x+y*t/100-h*d/100*g,y:n.y+x*t/100-l*d/100*p}))}}),g=_e(e=>{a(0)});return o.jsx("rect",{className:"removeMe",x:n.x,y:n.y,width:h*t/100,height:l*t/100,fill:r.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:y,onTouchMove:x,onTouchEnd:g})},lt=()=>{const e=d(),t=De.useRef(window.graph),{svgViewBoxZoom:n,svgViewBoxMin:r}=u(e=>e.param),{selected:i}=u(e=>e.runtime),s=U(),{height:a,width:c}=Y(s),l=De.useCallback(()=>{e(b(t.current.export())),e(m()),e(v())},[e]),h=De.useCallback((e,n,r)=>{e.stopPropagation(),i.size>0&&(i.forEach(e=>{t.current.hasNode(e)&&(t.current.updateNodeAttribute(e,"x",e=>(null!=e?e:0)+5*n),t.current.updateNodeAttribute(e,"y",e=>(null!=e?e:0)+5*r))}),l())},[i,l]),y=De.useCallback(e=>h(e,0,-1),[h]),x=De.useCallback(e=>h(e,0,1),[h]),g=De.useCallback(e=>h(e,-1,0),[h]),p=De.useCallback(e=>h(e,1,0),[h]),f=De.useCallback(()=>{if(i.size>0){const e=w(t.current,i);navigator.clipboard.writeText(e)}},[i]),k=De.useCallback(()=>{i.size>0&&(e(j()),i.forEach(e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)}),l())},[i,e,l]),A=r.x+c*n/200,N=r.y+(a-100)*n/100;return o.jsxs("g",{transform:`translate(${A}, ${N})scale(${1.5*n/100})`,children:[o.jsxs("g",{transform:"translate(0, -40)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:y}),o.jsx(se,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(0, 40)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:x}),o.jsx(ae,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(-40, 0)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:g}),o.jsx(ce,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(40, 0)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:p}),o.jsx(le,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(40, 40)",children:[o.jsx("circle",{r:16,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),o.jsx(de,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(-40, 40)",children:[o.jsx("circle",{r:16,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:k}),o.jsx(ue,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})};e("default",()=>{const e=d(),n=De.useRef(window.graph),r=De.useCallback(()=>{e(b(n.current.export())),e(m()),e(v())},[e]),{activeSubscriptions:i}=u(e=>e.account),{telemetry:{project:s},preference:{gridLines:a,snapLines:c,predictNextNode:h,autoParallel:y,autoChangeStationType:x}}=u(e=>e.app),{svgViewBoxZoom:g,svgViewBoxMin:M}=u(e=>e.param),{selected:C,active:D,isDetailsOpen:z,mode:_,lastTool:$,keepLastPath:O,theme:L,count:{masters:B,lines:F}}=u(e=>e.runtime),K=U(),{height:X,width:q}=Y(K),Q=!i.RMP_CLOUD&&B+1>p,Z=!y||y&&!i.RMP_CLOUD&&F+1>f,G=Re();he();const[ee,te]=De.useState({x:0,y:0}),[ne,re]=De.useState({x:0,y:0}),[se,ae]=De.useState({isOpen:!1,position:{x:0,y:0}}),ce=De.useRef({x:0,y:0}),le=De.useRef({x:0,y:0}),de=(e,t)=>{const n=e-ce.current.x,r=t-ce.current.y,o=n*g/100,i=r*g/100;return{x:le.current.x-o,y:le.current.y-i}},[ue,Ae]=De.useState({x:0,y:0,zoom:1}),ze=De.useRef(null),Ee=De.useCallback((e,t)=>{if(ze.current){const n=100/t,r=-e.x*n,o=-e.y*n;ze.current.setAttribute("transform",`translate(${r}, ${o}) scale(${n})`),a&&Ae({x:e.x,y:e.y,zoom:t})}},[a]);De.useLayoutEffect(()=>{Ee(M,g)},[M,g,Ee]);const $e=De.useRef(null);De.useEffect(()=>()=>{$e.current&&(cancelAnimationFrame($e.current),$e.current=null)},[]);const Oe=_e(async o=>{se.isOpen&&ae({isOpen:!1,position:{x:0,y:0}});const{x:i,y:a}=S(o);if(_.startsWith("station")||_.startsWith("misc-node")){e(V("free"));const o=W(10),{x:c,y:l}=k(i,a,g,M),d=_.startsWith("station"),u=d?`stn_${o}`:`misc_node_${o}`,h=d?_.slice(8):_.slice(10),y=structuredClone(t(t({},ke),Ne)[h].defaultAttrs);I.has(h)&&(y.color=L),d&&(y.names=await G(h)),n.current.addNode(u,{visible:!0,zIndex:0,x:N(c,5),y:N(l,5),type:h,[h]:y}),s&&T.event(R.ADD_STATION,{type:h}),r(),e(P(new Set([u])))}else"free"===_||_.startsWith("line")?(_.startsWith("line")&&(e(V("free")),O&&e(je(!1))),ce.current={x:i,y:a},le.current=M,o.shiftKey||(e(H("background")),e(j()))):"select"===_&&(te(k(i,a,g,M)),re(k(i,a,g,M)))}),Ie=_e(e=>{if("select"===_){if(0!=ee.x&&0!=ee.y){const{x:t,y:n}=S(e);re(k(t,n,g,M))}}else if("background"===D){const{x:t,y:n}=S(e);$e.current||($e.current=requestAnimationFrame(()=>{const e=de(t,n);Ee(e,g),$e.current=null}))}}),Te=_e(t=>{const{x:r,y:o}=S(t);if("select"===_){const{x:i,y:s}=k(r,o,g,M),a=Pe(n.current,ee.x,ee.y,i,s),c=Ce(n.current,new Set(a));e(P(new Set([...t.shiftKey?C:[],...a,...c]))),e(V("free")),te({x:0,y:0}),re({x:0,y:0})}if("background"===D&&!t.shiftKey){$e.current&&(cancelAnimationFrame($e.current),$e.current=null);const t=de(r,o);e(ie(t)),e(H(void 0))}}),He=_e(t=>{let n=g;t.deltaY>0&&g+10<400?n=g+10:t.deltaY<0&&g-10>0&&(n=g-10);const{x:r,y:o}=S(t),i=t.currentTarget.getBoundingClientRect(),[s,a]=[r/i.width,o/i.height],c={x:M.x+r*g/100-q*n/100*s,y:M.y+o*g/100-X*n/100*a};e(oe(n)),e(ie(c))}),Fe=_e(e=>{e.preventDefault(),S(e),ae({isOpen:!0,position:{x:e.clientX,y:e.clientY}})}),Ke=_e(()=>{ae({isOpen:!1,position:{x:0,y:0}});const e=document.getElementById("canvas");e&&e.focus()}),Xe=_e(async o=>{if(be?"Backspace"===o.key:"Delete"===o.key)C.size>0&&(C.forEach(e=>{if(n.current.hasNode(e))n.current.dropNode(e);else if(n.current.hasEdge(e)){const[t,r]=n.current.extremities(e);n.current.dropEdge(e),x&&t.startsWith("stn")&&Se(n.current,t),x&&r.startsWith("stn")&&Se(n.current,r)}}),e(j()),r());else if(o.key.startsWith("Arrow")){const t=100,n=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,r=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(ie(k(t*n,t*r,g,M)))}else if("i"===o.key||"j"===o.key||"k"===o.key||"l"===o.key){const e=5*("j"===o.key?-1:"l"===o.key?1:0),t=5*("i"===o.key?-1:"k"===o.key?1:0);C.size>0&&C.forEach(o=>{n.current.hasNode(o)&&(n.current.updateNodeAttribute(o,"x",t=>(null!=t?t:0)+e),n.current.updateNodeAttribute(o,"y",e=>(null!=e?e:0)+t),r())})}else if("f"===o.key&&$)e(V($));else if("z"===o.key&&(be?o.metaKey&&!o.shiftKey:o.ctrlKey))be&&o.preventDefault(),e(me()),e(m()),e(v());else if("s"===o.key)e(V("select"));else if("c"!==o.key&&"x"!==o.key||!(be?o.metaKey&&!o.shiftKey:o.ctrlKey)){if("v"===o.key&&(be?o.metaKey&&!o.shiftKey:o.ctrlKey)){const t=await navigator.clipboard.readText(),{x:o,y:i}=k(q/2,X/2,g,M),{nodes:s,edges:a}=A(t,n.current,Q,Z,N(o,5),N(i,5));r();const c=structuredClone(s);a.forEach(e=>c.add(e)),e(P(c))}else if(be&&"z"===o.key&&o.metaKey&&o.shiftKey||!be&&"y"===o.key&&o.ctrlKey)e(ve());else if("c"===o.key)e(we(!c));else if("r"===o.key){const e=o.altKey?5:45;We(n.current,C,e)&&r()}else if("e"===o.key){const[e]=C;if(1===C.size&&n.current.hasEdge(e)){const o=n.current.getEdgeAttributes(e),{type:i}=o;if(i!==E.Simple&&o[i]){const s=o[i],a="from"===(s.startFrom||"from")?"to":"from";let c=o.parallelIndex;if(y){const[t,r]=n.current.extremities(e);c=J(n.current,i,t,r,a)}const l=t(t({},s),{},{startFrom:a});n.current.mergeEdgeAttributes(e,{[i]:l,parallelIndex:c}),r()}}}}else{const t=w(n.current,C);navigator.clipboard.writeText(t),"x"===o.key&&(e(j()),C.forEach(e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)}),r())}}),[Ye,Ve]=De.useState({sx:0,sy:0,ex:0,ey:0});return De.useEffect(()=>{Ve({sx:ee.x<=ne.x?ee.x:ne.x,ex:ee.x>ne.x?ee.x:ne.x,sy:ee.y<=ne.y?ee.y:ne.y,ey:ee.y>ne.y?ee.y:ne.y})},[ne.x,ne.y]),o.jsxs(o.Fragment,{children:[o.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:X,width:q,viewBox:`0 0 ${q} ${X}`,onPointerDown:Oe,onPointerMove:Ie,onPointerUp:Te,onWheel:He,onContextMenu:Fe,tabIndex:0,onKeyDown:Xe,children:[o.jsx("defs",{children:o.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[o.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),o.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),o.jsxs("g",{ref:ze,children:[a&&o.jsx(Be,{gridLineOffset:ue,svgWidth:q,svgHeight:X}),ye()&&"free"===_&&o.jsx(ct,{}),h&&1===C.size&&"free"===_&&o.jsx(Ue,{}),o.jsx(Me.SvgAssetsContextProvider,{children:o.jsx(at,{})}),"select"===_&&0!=ee.x&&0!=ee.y&&o.jsx("rect",{x:Ye.sx,y:Ye.sy,width:Ye.ex-Ye.sx,height:Ye.ey-Ye.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),ye()&&[...C].some(e=>e.startsWith("stn_")||e.startsWith("misc_node_"))&&o.jsx(lt,{}),o.jsx(xe,{})]})]}),o.jsx(Le,{isOpen:se.isOpen,position:se.position,onClose:Ke}),ge()&&"hide"===z&&o.jsx(l,{"aria-label":"open details panel",icon:o.jsx(fe,{style:{transform:"rotate(180deg)"}}),onClick:()=>e(pe()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})})}}})}();

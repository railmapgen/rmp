import{a as fe,j as l,P as ge,B as Jt,D as Rt,ad as ye,a2 as xe}from"./chakra-C1zJvDsN.js";import{c as wt,e as V,a7 as It,z as Qt,ay as $t,az as pe,aA as te,a4 as ee,w as vt,x as ut,y as ht,aB as Nt,F as xt,Y as at,aC as ne,aD as K,X as pt,aE as Tt,p as kt,aF as Wt,aG as se,L as nt,aH as ot,aI as ct,aJ as Bt,n as bt,aK as me,d as oe,r as St,E as At,q as et,aL as Mt,aM as be,aN as ve,aO as we,aP as zt,t as Dt,v as _t,aQ as yt,aR as Ot,aS as Xt,o as re,aT as Se,S as Ae,aU as Vt,aV as Pe,aW as Lt,aX as Me,G as ie,H as Et,aY as ke,aZ as Ce,a_ as je,a$ as Ee,b0 as Ne,b1 as De,b2 as _e,b3 as ze,b4 as Ft,b5 as Le,b6 as Ie,b7 as $e,ag as mt,av as Te,aw as We,a9 as Be,a5 as Re}from"./index-BNZr8q4_.js";import{s as ft,f as ae,c as Oe,e as Xe}from"./master-manager-DodmvdYl.js";import{b as z,k as ce,u as Ve}from"./react-BpF4RbzH.js";import{u as R}from"./useEvent-LzhclC4A.js";import{v as Fe,m as Pt}from"./misc-nodes-D2zysB1O.js";const Ye={[It.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[It.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},He=t=>{const e=Ye[t];return e.at(Math.floor(Math.random()*e.length))},Yt=ce("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:d})=>{const{token:o}=e().account;if(!o){i($t({cityName:t,names:[]}));return}const s=await fetch("".concat(pe,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return Qt.warn("Failed to fetch random station names",s.statusText),d(s.statusText);const y=await s.json();i($t({cityName:t,names:y}))}),Ht=ce("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var p;const{stationNames:d}=e().runtime,o=d[t];if(((p=o==null?void 0:o.length)!=null?p:0)==0)return Qt.debug("No random station names in cache, using fallback"),i(Yt({cityName:t})),Object.values(He(t));const s=structuredClone(o),y=s.shift();return i($t({cityName:t,names:s})),s.length<3&&i(Yt({cityName:t})),Object.values(y)}),le=()=>{const t=wt(),{activeSubscriptions:e}=V(o=>o.account),{preference:{randomStationsNames:i}}=V(o=>o.app),d=!e.RMP_CLOUD||i==="none";return z.useCallback(async o=>{const s=ft[o].defaultAttrs.names;if(!d){const y=await t(Ht(It.Shmetro));if(Ht.fulfilled.match(y)){const p=y.payload;return s.length>p.length?p.push(...Array(s.length-p.length).fill(p.at(-1))):s.length<p.length&&p.splice(s.length),p}}return structuredClone(s)},[t,d])},Ke=({isOpen:t,position:e,onClose:i})=>{const{t:d}=Ve(),o=wt(),s=z.useRef(window.graph),{selected:y,count:{masters:p,lines:m}}=V(C=>C.runtime),{svgViewBoxZoom:n,svgViewBoxMin:r}=V(C=>C.param),{activeSubscriptions:u}=V(C=>C.account),f=!u.RMP_CLOUD&&p+1>te,g=!u.RMP_CLOUD&&m+1>ee,c=y.size>0,A=z.useRef(null);fe({ref:A,handler:i,enabled:t});const b=z.useCallback(()=>{o(vt(s.current.export())),o(ut()),o(ht())},[o]),w=R(()=>{if(y.size>0){const C=Nt(s.current,y);navigator.clipboard.writeText(C)}}),x=R(()=>{if(y.size>0){const C=Nt(s.current,y);navigator.clipboard.writeText(C),o(xt()),y.forEach(D=>{s.current.hasNode(D)?s.current.dropNode(D):s.current.hasEdge(D)&&s.current.dropEdge(D)}),b()}}),v=R(async()=>{try{const C=await navigator.clipboard.readText(),{x:D,y:q}=at(e.x,e.y,n,r),{nodes:F,edges:st}=ne(C,s.current,f,g,K(D,5),K(q,5));b();const L=structuredClone(F);st.forEach(B=>L.add(B)),o(pt(L))}catch(C){console.warn("Failed to read clipboard:",C)}}),a=R(()=>{y.size>0&&(o(xt()),y.forEach(C=>{s.current.hasNode(C)?s.current.dropNode(C):s.current.hasEdge(C)&&s.current.dropEdge(C)}),b())}),M=R(()=>{o(ut()),o(ht())}),E=R(C=>{if(y.size>0){const D=Math.min(Math.max(C,-10),10);y.forEach(q=>{s.current.hasNode(q)&&s.current.setNodeAttribute(q,"zIndex",D),s.current.hasEdge(q)&&s.current.setEdgeAttribute(q,"zIndex",D)}),b()}}),W=R(()=>{if(y.size>0){const[C]=y,D=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;E(D+1)}}),T=R(()=>{if(y.size>0){const[C]=y,D=s.current.hasNode(C)?s.current.getNodeAttribute(C,"zIndex"):s.current.hasEdge(C)?s.current.getEdgeAttribute(C,"zIndex"):0;E(D-1)}});return t?l.jsx(ge,{children:l.jsxs(Jt,{ref:A,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[l.jsx(it,{onClick:()=>{M(),i()},children:d("contextMenu.refresh")}),l.jsx(Rt,{}),l.jsx(it,{onClick:()=>{w(),i()},isDisabled:!c,children:d("contextMenu.copy")}),l.jsx(it,{onClick:()=>{x(),i()},isDisabled:!c,children:d("contextMenu.cut")}),l.jsx(it,{onClick:()=>{v(),i()},children:d("contextMenu.paste")}),l.jsx(it,{onClick:()=>{a(),i()},isDisabled:!c,children:d("contextMenu.delete")}),l.jsx(Rt,{}),l.jsx(it,{onClick:()=>{E(10),i()},isDisabled:!c,children:d("contextMenu.placeTop")}),l.jsx(it,{onClick:()=>{E(-10),i()},isDisabled:!c,children:d("contextMenu.placeBottom")}),l.jsx(it,{onClick:()=>{E(0),i()},isDisabled:!c,children:d("contextMenu.placeDefault")}),l.jsx(it,{onClick:()=>{W(),i()},isDisabled:!c,children:d("contextMenu.placeUp")}),l.jsx(it,{onClick:()=>{T(),i()},isDisabled:!c,children:d("contextMenu.placeDown")})]})}):null},it=({children:t,onClick:e,isDisabled:i=!1})=>l.jsx(Jt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),Ue=z.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:d,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=V(w=>w.app),p=ye().colorMode==="light"?"#666464":"#D3D3D4",m=Tt(e,i,d,o),n=s?410*i/100:0,r=i>30?i>120?50:25:5,u=i/200,f={startX:K(m.xMin+n-r,r),endX:K(m.xMax+n+r,r),startY:K(m.yMin-r,r),endY:K(m.yMax+r,r)},g=Array.from({length:(f.endX-f.startX)/r+1},(w,x)=>{const v=f.startX+x*r,a=v%(r*5)===0?2*u:u;return l.jsx("line",{x1:v,y1:f.startY,x2:v,y2:f.endY,strokeWidth:a,stroke:p,opacity:"0.5"},"grid_vl_".concat(v))}),c=Array.from({length:(f.endY-f.startY)/r+1},(w,x)=>{const v=f.startY+x*r,a=v%(r*5)===0?2*u:u;return l.jsx("line",{x1:f.startX,y1:v,x2:f.endX,y2:v,strokeWidth:a,stroke:p,opacity:"0.5"},"grid_hl_".concat(v))}),A=Array.from({length:(f.endX-f.startX)/r/5+1},(w,x)=>{const v=K(f.startX,5*r)+x*5*r;return l.jsx("text",{x:v,y:m.yMin+i/5,fontSize:u*25,fill:p,textAnchor:"middle",opacity:"0.5",children:v},"grid_vc_".concat(v))}),b=Array.from({length:(f.endY-f.startY)/r/5+1},(w,x)=>{const v=K(f.startY,5*r)+x*5*r;return l.jsx("text",{x:m.xMin+i/8+n,y:v,fontSize:u*25,fill:p,textAnchor:"start",opacity:"0.5",children:v},"grid_hc_".concat(v))});return l.jsxs("g",{id:"grid-lines",className:"removeMe",children:[g,c,A,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Ze=Fe.component,Kt=Wt.generatePath,Ut=se.component,jt=10,qe=()=>{var st;const t=wt(),e=()=>{t(vt(window.graph.export())),t(ut()),t(ht())},{telemetry:{project:i},preference:{autoParallel:d}}=V(L=>L.app),{selected:o,theme:s,count:{mostFrequentStationType:y}}=V(L=>L.runtime),p=le(),m=o.keys().next().value;if(!m.startsWith("stn")&&!m.startsWith("misc_node")||!window.graph.hasNode(m))return;const n=window.graph.neighbors(m);if(n.length===0)return;const r=window.graph.getNodeAttributes(m),u=n.reduce((L,B)=>{const J=window.graph.getNodeAttributes(B);return{x:L.x+J.x,y:L.y+J.y}},{x:0,y:0}),f={x:u.x/n.length,y:u.y/n.length},g={x:r.x-f.x,y:r.y-f.y},c={x:r.x+g.x,y:r.y+g.y},A=Math.sign(g.x)===Math.sign(g.y),b={x:c.x-jt,y:c.y+jt*(A?1:-1)},w={x:c.x+jt,y:c.y+jt*(A?-1:1)},x=m.startsWith("stn_")?window.graph.getNodeAttribute(m,"type"):y,v=ft[x].component,a={visible:!0,zIndex:0,x:w.x,y:w.y,type:x,[x]:ft[x].defaultAttrs},M=window.graph.reduceEdges(m,(L,B)=>{const J=window.graph.getEdgeAttributes(B),{style:gt}=J;if(gt===kt.SingleColor){const rt=JSON.stringify(J[gt].color);rt in L?L[rt]+=1:L[rt]=1}return L},{}),E=(st=Object.entries(M).filter(([L,B])=>B%2!==0).reduce((L,[B,J])=>J>L.count?{color:JSON.parse(B),count:J}:L,{color:null,count:0}).color)!=null?st:s,W=g.x>0?!(g.x>Math.abs(g.y)):-g.x>Math.abs(g.y),T=W?"from":"to",C=Kt(r.x,b.x,r.y,b.y,{...Wt.defaultAttrs,startFrom:T}),D=W?"to":"from",q=Kt(r.x,w.x,r.y,w.y,{...Wt.defaultAttrs,startFrom:D}),F=async(L,B)=>{B.stopPropagation();const{x:J,y:gt}=ct(B);t(Bt({x:J,y:gt}));const rt=bt(10),lt=me.has(L),N=lt?"stn_".concat(rt):"misc_node_".concat(rt),I=structuredClone({...ft,...Pt}[L].defaultAttrs);oe.has(L)&&(I.color=s),lt&&(I.names=await p(L)),window.graph.addNode(N,{visible:!0,zIndex:0,x:lt?w.x:b.x,y:lt?w.y:b.y,type:L,[L]:I}),i&&St.event(At.ADD_STATION,{type:L});const U=nt.Diagonal,Q="line_".concat(bt(10)),[G,Z]=[m,N],Y=d?0:-1,O=lt?D:T;window.graph.addDirectedEdgeWithKey(Q,G,Z,{visible:!0,zIndex:0,type:U,[U]:{...structuredClone(et[U].defaultAttrs),startFrom:O},style:kt.SingleColor,[kt.SingleColor]:{color:E},reconcileId:"",parallelIndex:Y}),i&&St.event(At.ADD_LINE,{type:U}),e(),t(Mt(N)),t(pt(new Set([N])))};return l.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[l.jsx(Ut,{id:"line_prediction_1",type:nt.Diagonal,path:C,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),l.jsx(Ut,{id:"line_prediction_2",type:nt.Diagonal,path:q,styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),l.jsx(Ze,{id:"misc_node_virtual_prediction_1",attrs:{},x:b.x,y:b.y,handlePointerDown:(L,B)=>{F(ot.Virtual,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),l.jsx(v,{id:"stn_virtual_prediction_2",attrs:a,x:w.x,y:w.y,handlePointerDown:(L,B)=>{F(y,B)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},de=(t,e,i,d,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return Zt(t,e,i,d,o)?{x1:e,y1:i,x2:d,y2:o,offset:s.offsetFrom}:void 0;const[y,p]=[s.offsetFrom,s.offsetTo];for(let m=0;m<Math.PI;m+=Math.PI/8)for(let n=m,r=0;r<2;r++,n+=Math.PI){const[u,f,g,c]=[Math.sin(m)*y,Math.cos(m)*y,Math.sin(n)*p,Math.cos(n)*p];if(Zt(t,e+u,i+f,d+g,o+c))return{x1:e+u,y1:i+f,x2:d+g,y2:o+c,offset:0}}},Ge=(t,e,i,d,o,s)=>t===i?{x1:t+5*s,y1:e,x2:i+5*s,y2:d,offset:o}:e===d?{x1:t,y1:e+5*s,x2:i,y2:d+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:i+5*Math.SQRT1_2*s,y2:d+5*Math.SQRT1_2*s,offset:o},Zt=(t,e,i,d,o)=>!!((e===d||i===o)&&[nt.Diagonal,nt.Perpendicular].includes(t)||Math.abs((o-i)/(d-e))===1&&[nt.Diagonal,nt.RotatePerpendicular].includes(t)),Je=(t,e)=>{const i=[],d=[];return Object.values(e).forEach(o=>{var w;if(o.length===1){d.push(...o.map(x=>x.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(x=>t.getEdgeAttribute(x,"type")===s)){d.push(...o.map(x=>x.edge));return}const y=t.getEdgeAttribute(o.at(0),"style");if(!o.every(x=>t.getEdgeAttribute(x,"style")===y)){d.push(...o.map(x=>x.edge));return}const p={},m=new Set,n=new Set,r=Object.fromEntries(o.map(x=>{var M,E;const[v,a]=t.extremities(x);return p[v]=((M=p[v])!=null?M:0)+1,p[a]=((E=p[a])!=null?E:0)+1,m.add(v),n.add(a),[v,[x.edge,a]]})),u=Array.from(m).filter(x=>p[x]===1),f=Array.from(n).filter(x=>p[x]===1);if(u.length!==1||f.length!==1){d.push(...o.map(x=>x.edge));return}const g=u[0],c=f[0];if(g===c){d.push(...o.map(x=>x.edge));return}const A=[r[g][0]];let b=r[g][1];for(let x=1;x<o.length;x=x+1){const v=(w=r[b])==null?void 0:w.at(1);if(!v){d.push(...o.map(a=>a.edge));return}A.push(r[b][0]),b=v}if(b!==c||A.length!==o.length){d.push(...o.map(x=>x.edge));return}i.push(A)}),{allReconciledLines:i,danglingLines:d}},Qe=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var f,g,c;const[s,y]=t.extremities(o),p=t.getNodeAttributes(s),m=t.getNodeAttributes(y),{type:n}=t.getEdgeAttributes(o),r=(f=t.getEdgeAttribute(o,n))!=null?f:et[n].defaultAttrs,u=de(n,p.x,p.y,m.x,m.y,r);if(u){const{x1:A,y1:b,x2:w,y2:x,offset:v}=u;return et[nt.Simple].generatePath(A,w,b,x,{offset:v})}return(c=(g=et[n])==null?void 0:g.generatePath(p.x,m.x,p.y,m.y,r))!=null?c:"M ".concat(p.x," ").concat(p.y," L ").concat(m.x," ").concat(m.y)});let d="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)d+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},tn=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),en=t=>{const e={},i={},d=[],o={},s=[];for(const n of t.edgeEntries()){const[r,u,f,g]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y],c=n.attributes[n.attributes.type],A=de(n.attributes.type,r,u,f,g,c);i[n.edge]=A}for(const n of t.edgeEntries()){let r=i[n.edge];const{parallelIndex:u}=n.attributes;if(u>=0){const f=be(t,n.attributes.type,n.edge),g=i[f];if(!g){d.push(n);continue}if(u>0){const{x1:c,y1:A,x2:b,y2:w,offset:x}=g;r=Ge(c,A,b,w,x,u)}}if(n.attributes.reconcileId!==""){const f=n.attributes.reconcileId;f in o?o[f].push(n):o[f]=[n];continue}if(r){const f=n.edge,g=n.attributes,{x1:c,y1:A,x2:b,y2:w,offset:x}=r;e[f]={attr:g,path:et[nt.Simple].generatePath(c,b,A,w,{offset:x})};continue}s.push(n)}const y=new Set;for(;d.length;){const n=d.pop();if(y.has(n.edge))continue;const{parallel:r}=ve(t,n);if(!r.length)continue;r.forEach(f=>y.add(f.edge));const u=we(r);for(const f of r){const g=f.edge;e[g]={attr:f.attributes,path:u[g]}}}const{allReconciledLines:p,danglingLines:m}=Je(t,o);for(const n of p){const r=Qe(t,n);if(!r)continue;const u=n[0];e[u]={attr:t.getEdgeAttributes(u),path:r}}for(const n of m){const r=t.getEdgeAttributes(n),[u,f]=t.extremities(n),g=t.getNodeAttributes(u),c=t.getNodeAttributes(f);e[n]={attr:r,path:et[nt.Simple].generatePath(g.x,c.x,g.y,c.y,et[nt.Simple].defaultAttrs)}}for(const n of s){const r=n.edge,u=n.attributes.type,f=n.attributes,[g,c,A,b]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y];if(!(u in et)){e[r]={attr:f,path:"M ".concat(g," ").concat(c," L ").concat(A," ").concat(b)};continue}e[r]={attr:f,path:et[u].generatePath(g,A,c,b,f[u])}}return Object.entries(e).map(([n,r])=>({id:n,type:"line",line:r}))},ue=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Master&&e.getNodeAttributes(t)[ot.Master].nodeType==="Station",nn=(t,e)=>{const i=[];return e.filter(d=>ue(d,t)).forEach(d=>{const o=t.getNodeAttribute(d,"x"),s=t.getNodeAttribute(d,"y");i.push({a:1,b:0,c:-o,node:d,x:o,y:s}),i.push({a:0,b:1,c:-s,node:d,x:o,y:s}),i.push({a:1,b:-1,c:-o+s,node:d,x:o,y:s}),i.push({a:1,b:1,c:-o-s,node:d,x:o,y:s})}),i},he=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),sn=(t,e,i,d)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(y=>d.includes(y.node)).forEach(y=>{const p=he(y,t,e);p<o&&(o=p,s=y)}),{l:s,d:o}},on=(t,e,i,d,o)=>{const s=e.filter(n=>{const r=t.getNodeAttribute(n,"x"),u=t.getNodeAttribute(n,"y");return Math.abs(o.a*r+o.b*u+o.c)<=.01}),y=[(n,r,u,f)=>[(n+u)/2,(r+f)/2],(n,r,u,f)=>[2*n-u,2*r-f],(n,r,u,f)=>[2*u-n,2*f-r]];let p=1/0,m={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let n=0;n<s.length;n++){const r=s[n],u=t.getNodeAttribute(r,"x"),f=t.getNodeAttribute(r,"y");for(let g=n+1;g<s.length;g++){const c=s[g],A=t.getNodeAttribute(c,"x"),b=t.getNodeAttribute(c,"y");y.forEach(w=>{const[x,v]=w(u,f,A,b),a=Math.hypot(i-x,d-v);a<p&&(p=a,m={x,y:v,originalNodesPos:[{x:u,y:f},{x:A,y:b}]})})}}return{snapPoint:m,distance:p}},rn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=V(f=>f.param),d=f=>{const c=[{x:f.x,y:f.y},...f.originalNodesPos].sort((b,w)=>b.x===w.x?b.y-w.y:b.x-w.x),A=(c[1].y-c[0].y)/(c[1].x-c[0].x);if(Math.abs(A)<=.01)return{original:c,offset:c.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(A)>=1e10)return{original:c,offset:c.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const w=-1/A,x=10/Math.sqrt(w*w+1),v=10*w/Math.sqrt(w*w+1);return{original:c,offset:c.map(a=>({x:a.x+x,y:a.y+v})),rotate:-Math.atan(w)*(180/Math.PI)}}},{original:o,offset:s,rotate:y}=d(e),p=f=>{const g=Math.sqrt(3)/2*f,c="0,0",A="".concat(-f/2,",").concat(g),b="".concat(f/2,",").concat(g);return"".concat(c," ").concat(A," ").concat(b)},m=i/75,n=8*m,r="#FC8181",u="".concat(m*5," ").concat(m*2);return l.jsxs(l.Fragment,{children:[l.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:r,strokeWidth:m,strokeDasharray:u}),l.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:r,strokeWidth:m,strokeDasharray:u}),l.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:r,strokeWidth:m,strokeDasharray:u}),l.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:r,strokeWidth:m,strokeDasharray:u}),l.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:r,strokeWidth:m,strokeDasharray:u}),l.jsx("polygon",{points:p(n),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((y+270)%360,")"),fill:r}),l.jsx("polygon",{points:p(n),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((y+270)%360,")"),fill:r}),l.jsx("polygon",{points:p(n),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((y+90)%360,")"),fill:r}),l.jsx("polygon",{points:p(n),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((y+90)%360,")"),fill:r})]})},qt=t=>{const{id:e,x:i,y:d,handlePointerDown:o,handlePointerMove:s,handlePointerUp:y}=t,p=z.useCallback(r=>o(e,r),[e,o]),m=z.useCallback(r=>s(e,r),[e,s]),n=z.useCallback(r=>y(e,r),[e,y]);return l.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(d-6.4,")scale(0.025)"),onPointerDown:p,onPointerMove:m,onPointerUp:n,style:{cursor:"move"},children:l.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},an=t=>{const{id:e,path:i,handlePointerDown:d}=t,o=z.useCallback(s=>d(e,s),[e,d]);return l.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},cn=z.memo(t=>{var m,n,r,u,f,g,c,A,b,w,x,v;const{elements:e,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o,handleEdgePointerDown:s}=t,y=Object.fromEntries(Array.from({length:21},(a,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const M=a.line.attr.type,E=a.line.attr.style,W=a.line.attr[E],T=(m=zt[E])==null?void 0:m.preComponent;T&&y[a.line.attr.zIndex].pre.push(l.jsx(T,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const C=(r=(n=zt[E])==null?void 0:n.component)!=null?r:an;y[a.line.attr.zIndex].main.push(l.jsx(C,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},a.id));const D=(u=zt[E])==null?void 0:u.postComponent;D&&y[a.line.attr.zIndex].post.push(l.jsx(D,{id:a.id,type:M,path:a.line.path,styleAttrs:W,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const M=a.station,E=M.type,W=(f=ft[E])==null?void 0:f.preComponent;W&&y[a.station.zIndex].pre.push(l.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const T=(c=(g=ft[E])==null?void 0:g.component)!=null?c:qt;y[a.station.zIndex].main.push(l.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const C=(A=ft[E])==null?void 0:A.postComponent;C&&y[a.station.zIndex].post.push(l.jsx(C,{id:a.id,x:M.x,y:M.y,attrs:M,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const M=a.miscNode,E=M.type,W=(b=Pt[E])==null?void 0:b.preComponent;W&&y[a.miscNode.zIndex].pre.push(l.jsx(W,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const T=(x=(w=Pt[E])==null?void 0:w.component)!=null?x:qt;y[a.miscNode.zIndex].main.push(l.jsx(T,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const C=(v=Pt[E])==null?void 0:v.postComponent;C&&y[a.miscNode.zIndex].post.push(l.jsx(C,{id:a.id,x:M.x,y:M.y,attrs:M[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,M)=>(M-10).toString()).map(a=>[...y[a].pre,...y[a].main,...y[a].post]).flat()},(t,e)=>t.elements===e.elements),ln=[...Object.values(Ae),ot.Virtual,ot.Master,ot.Fill,ot.LondonArrow,ot.ChongqingRTNumLineBadge2021,ot.ChongqingRTTextLineBadge2021,ot.ChengduRTLineBadge,ot.GzmtrLineBadge],dn=()=>{const t=wt(),e=z.useRef(window.graph),i=()=>{t(vt(e.current.export())),t(ut()),t(ht())},{telemetry:{project:d},preference:{autoParallel:o,gridLines:s,snapLines:y}}=V(N=>N.app),{svgViewBoxZoom:p,svgViewBoxMin:m}=V(N=>N.param),{selected:n,pointerPosition:r,active:u,refresh:{nodes:f,edges:g},mode:c,keepLastPath:A,theme:b}=V(N=>N.runtime),w=Dt(),{height:x,width:v}=_t(w),[a,M]=z.useState({dx:0,dy:0}),[E,W]=z.useState([]),[T,C]=z.useState([]),[D,q]=z.useState([]);z.useEffect(()=>{if(!r||!y)return;const N=Tt(m,p,v,x),I=ae(e.current,...Object.values(N));C(I),W(nn(e.current,I))},[m,p,v,x,r]);const[F,st]=z.useState(void 0),L=R((N,I)=>{I.stopPropagation(),I.currentTarget.setPointerCapture(I.pointerId);const{x:U,y:Q}=ct(I);c==="select"&&t(yt("free")),q([]),st(void 0),t(Bt({x:U,y:Q})),t(Mt(N)),I.shiftKey?n.has(N)?t(Ot(N)):t(Xt(N)):n.has(N)||t(pt(new Set([N])))}),B=R((N,I)=>{const{x:U,y:Q}=ct(I);if(I.currentTarget.setPointerCapture(I.pointerId),c==="free"&&u===N){if(!I.altKey&&y){const G=e.current.getNodeAttribute(N,"x"),Z=e.current.getNodeAttribute(N,"y"),Y=G-(r.x-U)*p/100,O=Z-(r.y-Q)*p/100;let tt=Y,h=O;if(ue(N,e.current)){let P=D,j=F;if(P.length!==0&&(P=P.filter(S=>he(S,Y,O)<=6)),j&&(P.length===0||Math.hypot(Y-j.x,O-j.y)>6)&&(j=void 0),!j&&P.length===1){const S=P[0],{snapPoint:$,distance:X}=on(e.current,T.filter(H=>!n.has(H)),Y,O,S);X<=3&&(j=$)}if(P.length===1&&!j||P.length===0){const{l:S,d:$}=sn(Y,O,E,T.filter(H=>!n.has(H)&&!P.some(dt=>dt.node===H))),X=P.length===0||!P.some(H=>H.a===S.a&&H.b===S.b);$<3&&P.length<2&&X&&P.push(S)}if(P.length===1)if(j)tt=j.x,h=j.y;else{const S=P[0];if(S.a==0)h=-S.c/S.b;else if(S.b==0)tt=-S.c/S.a;else{const $=-S.a/S.b,X=-S.c/S.b;h=$*tt+X}}else if(P.length===2){const S=P[0],$=P[1],X=S.a*$.b-$.a*S.b;X!==0&&(tt=-(S.c*$.b-$.c*S.b)/X,h=-(S.a*$.c-$.a*S.c)/X)}q(P),st(j)}const k=tt-G,_=h-Z;n.forEach(P=>{e.current.hasNode(P)&&e.current.updateNodeAttributes(P,j=>({...j,x:K(j.x+k,.01),y:K(j.y+_,.01)}))})}else q([]),st(void 0),n.forEach(G=>{e.current.hasNode(G)&&e.current.updateNodeAttributes(G,Z=>({...Z,x:K(Z.x-(r.x-U)*p/100,I.altKey?.01:5),y:K(Z.y-(r.y-Q)*p/100,I.altKey?.01:5)}))});t(ut()),t(ht())}else c.startsWith("line")&&u&&M({dx:(r.x-U)*p/100,dy:(r.y-Q)*p/100})}),J=R((N,I)=>{var U,Q,G;if(I.currentTarget.releasePointerCapture(I.pointerId),c.startsWith("line")){A||t(yt("free"));const Z=e.current.hasNode(u)&&ln.includes(e.current.getNodeAttribute(u,"type")),Y=["stn_core_","virtual_circle_","misc_node_connectable_"],tt=(G=(Q=(U=document.elementsFromPoint(I.clientX,I.clientY).at(0))==null?void 0:U.attributes)==null?void 0:Q.getNamedItem("id"))==null?void 0:G.value,h=Y.find(k=>tt==null?void 0:tt.startsWith(k));if(Z&&h){const k=c.slice(5),_="line_".concat(bt(10)),[P,j]=[u,tt.slice(h.length)];if(P!==j){const S=o?re(e.current,k,P,j,"from"):-1;e.current.addDirectedEdgeWithKey(_,P,j,{visible:!0,zIndex:0,type:k,[k]:structuredClone(et[k].defaultAttrs),style:kt.SingleColor,[kt.SingleColor]:{color:b},reconcileId:"",parallelIndex:S}),t(pt(new Set([_]))),d&&St.event(At.ADD_LINE,{type:k}),t(vt(e.current.export())),t(ht())}}}else if(c==="free"&&u){const{x:Z,y:Y}=ct(I);r.x-Z===0&&r.y-Y===0||(t(vt(e.current.export())),t(ut()))}q([]),st(void 0),Bt(void 0),t(Mt(void 0))}),gt=R((N,I)=>{if(I.stopPropagation(),I.shiftKey||t(xt()),I.shiftKey&&n.has(N)?t(Ot(N)):t(Xt(N)),c.startsWith("station")||c.startsWith("misc-node-virtual")||c.startsWith("misc-node-master")){const U=I.clientX-document.getElementById("canvas").getBoundingClientRect().left,Q=I.clientY-document.getElementById("canvas").getBoundingClientRect().top,G=c.startsWith("station"),Z=bt(10),Y=G?"stn_".concat(Z):"misc_node_".concat(Z),O=G?c.slice(8):c.slice(10),{x:tt,y:h}=at(U,Q,p,m),k=G?structuredClone(ft[O].defaultAttrs):structuredClone(Pt[O].defaultAttrs);"color"in k&&(k.color=b),e.current.addNode(Y,{visible:!0,zIndex:0,x:K(tt,5),y:K(h,5),type:O,[O]:k});const _=e.current.getEdgeAttributes(N),{zIndex:P,type:j,style:S}=_,$=_[j],X=_[S],[H,dt]=e.current.extremities(N),Ct=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(bt(10)),H,Y,{visible:!0,zIndex:P,type:j,[j]:structuredClone($),style:S,[S]:structuredClone(X),reconcileId:"",parallelIndex:Ct}),e.current.addDirectedEdgeWithKey("line_".concat(bt(10)),Y,dt,{visible:!0,zIndex:P,type:j,[j]:structuredClone($),style:S,[S]:structuredClone(X),reconcileId:"",parallelIndex:Ct}),e.current.dropEdge(N),i(),d&&(St.event(At.ADD_STATION,{type:O}),St.event(At.ADD_LINE,{type:j})),t(yt("free")),t(pt(new Set([Y])))}}),rt=z.useMemo(()=>[...en(e.current),...tn(e.current)],[g,f]),lt=se.component;return l.jsxs(l.Fragment,{children:[l.jsx(cn,{elements:rt,handlePointerDown:L,handlePointerMove:B,handlePointerUp:J,handleEdgePointerDown:gt}),c.startsWith("line")&&u&&u!=="background"&&l.jsx(lt,{id:"line_create_in_progress___no_use",type:c.slice(5),path:et[c.slice(5)].generatePath(e.current.getNodeAttribute(u,"x"),e.current.getNodeAttribute(u,"x")-a.dx,e.current.getNodeAttribute(u,"y"),e.current.getNodeAttribute(u,"y")-a.dy,et[c.slice(5)].defaultAttrs),styleAttrs:{color:b},newLine:!0,handlePointerDown:()=>{}}),D.length!==0&&D.map(N=>l.jsx("path",{d:et[nt.Simple].generatePath(...Se(N,Tt(m,p,v,x)),et[nt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:p/75},"snap_line_".concat(N.a,"_").concat(N.b,"_").concat(N.c,"_").concat(N.node))),F&&l.jsx(rn,{activeSnapPoint:F})]})},un=()=>{const t=wt(),{svgViewBoxZoom:e,svgViewBoxMin:i}=V(g=>g.param),{radialTouchMenu:d}=V(g=>g.runtime),o=z.useRef(window.graph),[s,y]=z.useState(0),p=Dt(),{height:m,width:n}=_t(p),r=R(g=>{var c;if(g.touches.length==1){if(y(0),d.visible){t(Vt());return}const A=g.touches[0],b=(c=document.getElementById("canvas"))==null?void 0:c.getBoundingClientRect();if(!b)return;const w=A.clientX-b.left,x=A.clientY-b.top,v=at(w,x,e,i),a=Pe(o.current,v,t);[...a[Lt.STATION],...a[Lt.MISC_NODE],...a[Lt.LINE]].length>0?t(Me({visible:!0,position:v,data:a})):(t(xt()),t(Vt()))}else if(g.touches.length==2){t(Mt(void 0));const[A,b]=[g.touches[0].clientX-g.touches[1].clientX,g.touches[0].clientY-g.touches[1].clientY];y(A*A+b*b)}}),u=R(g=>{if(g.touches.length==2&&s>0){const[c,A]=[g.touches[0].clientX-g.touches[1].clientX,g.touches[0].clientY-g.touches[1].clientY],b=c*c+A*A;let w=e;b-s<0&&e+10<=390?w=e+10:b-s>0&&e-10>=10&&(w=e-10),t(ie(w)),y(b);const x=g.currentTarget.getBoundingClientRect(),[v,a]=[(g.touches[0].clientX+g.touches[1].clientX)/2-x.left,(g.touches[0].clientY+g.touches[1].clientY)/2-x.top],[M,E]=[v/x.width,a/x.height];t(Et({x:i.x+v*e/100-n*w/100*M,y:i.y+a*e/100-m*w/100*E}))}}),f=R(g=>{y(0)});return l.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:n*e/100,height:m*e/100,fill:d.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:r,onTouchMove:u,onTouchEnd:f})},Gt=10,hn=()=>{const t=wt(),e=z.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:d}=V(a=>a.param),{selected:o}=V(a=>a.runtime),s=Dt(),{height:y,width:p}=_t(s),m=z.useCallback(()=>{t(vt(e.current.export())),t(ut()),t(ht())},[t]),n=z.useCallback((a,M,E)=>{a.stopPropagation(),o.size>0&&(o.forEach(W=>{e.current.hasNode(W)&&(e.current.updateNodeAttribute(W,"x",T=>(T!=null?T:0)+M*Gt),e.current.updateNodeAttribute(W,"y",T=>(T!=null?T:0)+E*Gt))}),m())},[o,m]),r=z.useCallback(a=>n(a,0,-1),[n]),u=z.useCallback(a=>n(a,0,1),[n]),f=z.useCallback(a=>n(a,-1,0),[n]),g=z.useCallback(a=>n(a,1,0),[n]),c=z.useCallback(()=>{if(o.size>0){const a=Nt(e.current,o);navigator.clipboard.writeText(a)}},[o]),A=z.useCallback(()=>{o.size>0&&(t(xt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),m())},[o,t,m]),b=d.x+p*i/200,w=d.y+(y-100)*i/100,x=40,v=40;return l.jsxs("g",{transform:"translate(".concat(b,", ").concat(w,")scale(").concat(1.5*i/100,")"),children:[l.jsxs("g",{transform:"translate(0, -".concat(v,")"),children:[l.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:r}),l.jsx(ke,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(0, ".concat(v,")"),children:[l.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:u}),l.jsx(Ce,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(-".concat(v,", 0)"),children:[l.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),l.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(".concat(v,", 0)"),children:[l.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:g}),l.jsx(Ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(".concat(v,", ").concat(v,")"),children:[l.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:c}),l.jsx(Ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),l.jsxs("g",{transform:"translate(-".concat(v,", ").concat(v,")"),children:[l.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:A}),l.jsx(De,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},bn=()=>{const t=wt(),e=z.useRef(window.graph),i=z.useCallback(()=>{t(vt(e.current.export())),t(ut()),t(ht())},[t]),{activeSubscriptions:d}=V(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:y,predictNextNode:p,autoParallel:m}}=V(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:r}=V(h=>h.param),{selected:u,active:f,isDetailsOpen:g,mode:c,lastTool:A,keepLastPath:b,theme:w,count:{masters:x,lines:v}}=V(h=>h.runtime),a=Dt(),{height:M,width:E}=_t(a),W=!d.RMP_CLOUD&&x+1>te,T=!d.RMP_CLOUD&&v+1>ee,C=le();_e();const[D,q]=z.useState({x:0,y:0}),[F,st]=z.useState({x:0,y:0}),[L,B]=z.useState({isOpen:!1,position:{x:0,y:0}}),[J,gt]=z.useState({x:0,y:0}),[rt,lt]=z.useState({x:0,y:0}),N=R(async h=>{L.isOpen&&B({isOpen:!1,position:{x:0,y:0}});const{x:k,y:_}=ct(h);if(c.startsWith("station")||c.startsWith("misc-node")){t(yt("free"));const P=bt(10),{x:j,y:S}=at(k,_,n,r),$=c.startsWith("station"),X=$?"stn_".concat(P):"misc_node_".concat(P),H=$?c.slice(8):c.slice(10),dt=structuredClone({...ft,...Pt}[H].defaultAttrs);oe.has(H)&&(dt.color=w),$&&(dt.names=await C(H)),e.current.addNode(X,{visible:!0,zIndex:0,x:K(j,5),y:K(S,5),type:H,[H]:dt}),o&&St.event(At.ADD_STATION,{type:H}),i(),t(pt(new Set([X])))}else c==="free"||c.startsWith("line")?(c.startsWith("line")&&(t(yt("free")),b&&t(Re(!1))),gt({x:k,y:_}),lt(r),h.shiftKey||(t(Mt("background")),t(xt()))):c==="select"&&(q(at(k,_,n,r)),st(at(k,_,n,r)))}),I=R(h=>{if(c==="select"){if(D.x!=0&&D.y!=0){const{x:k,y:_}=ct(h);st(at(k,_,n,r))}}else if(f==="background"){const{x:k,y:_}=ct(h);t(Et({x:rt.x+(J.x-k)*n/100,y:rt.y+(J.y-_)*n/100}))}}),U=R(h=>{if(c==="select"){const{x:k,y:_}=ct(h),{x:P,y:j}=at(k,_,n,r),S=ae(e.current,D.x,D.y,P,j),$=Xe(e.current,new Set(S));t(pt(new Set([...h.shiftKey?u:[],...S,...$]))),t(yt("free")),q({x:0,y:0}),st({x:0,y:0})}f==="background"&&!h.shiftKey&&t(Mt(void 0))}),Q=R(h=>{let k=n;h.deltaY>0&&n+10<400?k=n+10:h.deltaY<0&&n-10>0&&(k=n-10),t(ie(k));const{x:_,y:P}=ct(h),j=h.currentTarget.getBoundingClientRect(),[S,$]=[_/j.width,P/j.height];t(Et({x:r.x+_*n/100-E*k/100*S,y:r.y+P*n/100-M*k/100*$}))}),G=R(h=>{h.preventDefault(),ct(h),B({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),Z=R(()=>{B({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),Y=R(async h=>{if(mt?h.key==="Backspace":h.key==="Delete")u.size>0&&(u.forEach(k=>{e.current.hasNode(k)?e.current.dropNode(k):e.current.hasEdge(k)&&e.current.dropEdge(k)}),t(xt()),i());else if(h.key.startsWith("Arrow")){const _=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,P=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(Et(at(100*_,100*P,n,r)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const _=(h.key==="j"?-1:h.key==="l"?1:0)*10,P=(h.key==="i"?-1:h.key==="k"?1:0)*10;u.size>0&&u.forEach(j=>{e.current.hasNode(j)&&(e.current.updateNodeAttribute(j,"x",S=>(S!=null?S:0)+_),e.current.updateNodeAttribute(j,"y",S=>(S!=null?S:0)+P),i())})}else if(h.key==="f"&&A)t(yt(A));else if(h.key==="z"&&(mt?h.metaKey&&!h.shiftKey:h.ctrlKey))mt&&h.preventDefault(),t(Te()),t(ut()),t(ht());else if(h.key==="s")t(yt("select"));else if((h.key==="c"||h.key==="x")&&(mt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const k=Nt(e.current,u);navigator.clipboard.writeText(k),h.key==="x"&&(t(xt()),u.forEach(_=>{e.current.hasNode(_)?e.current.dropNode(_):e.current.hasEdge(_)&&e.current.dropEdge(_)}),i())}else if(h.key==="v"&&(mt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const k=await navigator.clipboard.readText(),{x:_,y:P}=at(E/2,M/2,n,r),{nodes:j,edges:S}=ne(k,e.current,W,T,K(_,5),K(P,5));i();const $=structuredClone(j);S.forEach(X=>$.add(X)),t(pt($))}else if(mt&&h.key==="z"&&h.metaKey&&h.shiftKey||!mt&&h.key==="y"&&h.ctrlKey)t(We());else if(h.key==="c")t(Be(!y));else if(h.key==="e"){const[k]=u;if(u.size===1&&e.current.hasEdge(k)){const _=e.current.getEdgeAttributes(k),{type:P}=_;if(P!==nt.Simple&&_[P]){const j=_[P],$=(j.startFrom||"from")==="from"?"to":"from";let X=_.parallelIndex;if(m){const[dt,Ct]=e.current.extremities(k);X=re(e.current,P,dt,Ct,$)}const H={...j,startFrom:$};e.current.mergeEdgeAttributes(k,{[P]:H,parallelIndex:X}),i()}}}}),[O,tt]=z.useState({sx:0,sy:0,ex:0,ey:0});return z.useEffect(()=>{tt({sx:D.x<=F.x?D.x:F.x,ex:D.x>F.x?D.x:F.x,sy:D.y<=F.y?D.y:F.y,ey:D.y>F.y?D.y:F.y})},[F.x,F.y]),l.jsxs(l.Fragment,{children:[l.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:M,width:E,viewBox:"".concat(r.x," ").concat(r.y," ").concat(E*n/100," ").concat(M*n/100),onPointerDown:N,onPointerMove:I,onPointerUp:U,onWheel:Q,onContextMenu:G,tabIndex:0,onKeyDown:Y,children:[l.jsx("defs",{children:l.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[l.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),l.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&l.jsx(Ue,{svgViewBoxMin:r,svgViewBoxZoom:n,svgWidth:E,svgHeight:M}),Ft()&&c==="free"&&l.jsx(un,{}),p&&u.size===1&&c==="free"&&l.jsx(qe,{}),l.jsx(Oe.SvgAssetsContextProvider,{children:l.jsx(dn,{})}),c==="select"&&D.x!=0&&D.y!=0&&l.jsx("rect",{x:O.sx,y:O.sy,width:O.ex-O.sx,height:O.ey-O.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Ft()&&[...u].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&l.jsx(hn,{}),l.jsx(Le,{})]}),l.jsx(Ke,{isOpen:L.isOpen,position:L.position,onClose:Z}),ze()&&g==="hide"&&l.jsx(xe,{"aria-label":"open details panel",icon:l.jsx($e,{style:{transform:"rotate(180deg)"}}),onClick:()=>t(Ie()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{bn as default};

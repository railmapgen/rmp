import{a as ye,j as u,P as xe,B as Qt,D as Rt,ad as pe,a2 as me}from"./chakra-B1xyVt4l.js";import{c as St,e as R,A as te,aB as $t,aC as be,a8 as Ot,aD as ee,a5 as ne,x as wt,y as ut,z as ht,aE as Et,G as xt,_ as lt,aF as se,aG as q,Z as pt,aH as Tt,q as Ct,aI as Wt,aJ as oe,L as nt,aK as ot,aL as dt,aM as Bt,n as vt,aN as ve,d as re,r as At,E as Pt,t as et,aO as kt,aP as we,aQ as Se,aR as Ae,aS as Lt,v as _t,w as zt,aT as yt,aU as Vt,aV as Xt,p as ie,S as Pe,aW as Ft,aX as Me,aY as It,aZ as ke,H as ae,I as jt,a_ as Ce,a$ as Ne,b0 as je,b1 as Ee,b2 as De,b3 as _e,b4 as ze,b5 as Le,b6 as Ht,b7 as Ie,b8 as $e,b9 as Te,aj as bt,ay as We,az as Be,aa as Re,a6 as Oe}from"./index-8YsgDcO8.js";import{s as ft,f as ce,c as Ve,e as Xe}from"./master-manager-DbSMjEXU.js";import{b as D,k as le,u as Fe}from"./react-BpF4RbzH.js";import{u as B}from"./useEvent-LzhclC4A.js";import{c as Dt}from"./change-types-CEOe5cCn.js";import{v as He,m as Mt}from"./misc-nodes-DUvKfETx.js";const Ke={[Ot.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[Ot.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ye=t=>{const e=Ke[t];return e.at(Math.floor(Math.random()*e.length))},Kt=le("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:i,rejectWithValue:d})=>{const{token:o}=e().account;if(!o){i($t({cityName:t,names:[]}));return}const s=await fetch("".concat(be,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!s.ok)return te.warn("Failed to fetch random station names",s.statusText),d(s.statusText);const v=await s.json();i($t({cityName:t,names:v}))}),Yt=le("runtime/getOneStationName",async(t,{getState:e,dispatch:i})=>{var g;const{stationNames:d}=e().runtime,o=d[t];if(((g=o==null?void 0:o.length)!=null?g:0)==0)return te.debug("No random station names in cache, using fallback"),i(Kt({cityName:t})),Object.values(Ye(t));const s=structuredClone(o),v=s.shift();return i($t({cityName:t,names:s})),s.length<3&&i(Kt({cityName:t})),Object.values(v)}),de=()=>{const t=St(),{activeSubscriptions:e}=R(o=>o.account),{preference:{randomStationsNames:i}}=R(o=>o.app),d=!e.RMP_CLOUD||i==="none";return D.useCallback(async o=>{const s=ft[o].defaultAttrs.names;if(!d){const v=await t(Yt(i));if(Yt.fulfilled.match(v)){const g=v.payload;return s.length>g.length?g.push(...Array(s.length-g.length).fill(g.at(-1))):s.length<g.length&&g.splice(s.length),g}}return structuredClone(s)},[t,d,i])},Ue=({isOpen:t,position:e,onClose:i})=>{const{t:d}=Fe(),o=St(),s=D.useRef(window.graph),{activeSubscriptions:v}=R(N=>N.account),{preference:{autoParallel:g}}=R(N=>N.app),{svgViewBoxZoom:S,svgViewBoxMin:r}=R(N=>N.param),{selected:n,count:{masters:c,lines:l}}=R(N=>N.runtime),f=!v.RMP_CLOUD&&c+1>ee,y=!g||g&&!v.RMP_CLOUD&&l+1>ne,p=n.size>0,m=D.useRef(null);ye({ref:m,handler:i,enabled:t});const A=D.useCallback(()=>{o(wt(s.current.export())),o(ut()),o(ht())},[o]),x=B(()=>{if(n.size>0){const N=Et(s.current,n);navigator.clipboard.writeText(N)}}),w=B(()=>{if(n.size>0){const N=Et(s.current,n);navigator.clipboard.writeText(N),o(xt()),n.forEach(_=>{s.current.hasNode(_)?s.current.dropNode(_):s.current.hasEdge(_)&&s.current.dropEdge(_)}),A()}}),a=B(async()=>{try{const N=await navigator.clipboard.readText(),{x:_,y:J}=lt(e.x,e.y,S,r),{nodes:V,edges:rt}=se(N,s.current,f,y,q(_,5),q(J,5));A();const it=structuredClone(V);rt.forEach(at=>it.add(at)),o(pt(it))}catch(N){console.warn("Failed to read clipboard:",N)}}),C=B(()=>{n.size>0&&(o(xt()),n.forEach(N=>{s.current.hasNode(N)?s.current.dropNode(N):s.current.hasEdge(N)&&s.current.dropEdge(N)}),A())}),E=B(()=>{o(ut()),o(ht())}),$=B(N=>{if(n.size>0){const _=Math.min(Math.max(N,-10),10);n.forEach(J=>{s.current.hasNode(J)&&s.current.setNodeAttribute(J,"zIndex",_),s.current.hasEdge(J)&&s.current.setEdgeAttribute(J,"zIndex",_)}),A()}}),W=B(()=>{if(n.size>0){const[N]=n,_=s.current.hasNode(N)?s.current.getNodeAttribute(N,"zIndex"):s.current.hasEdge(N)?s.current.getEdgeAttribute(N,"zIndex"):0;$(_+1)}}),Q=B(()=>{if(n.size>0){const[N]=n,_=s.current.hasNode(N)?s.current.getNodeAttribute(N,"zIndex"):s.current.hasEdge(N)?s.current.getEdgeAttribute(N,"zIndex"):0;$(_-1)}});return t?u.jsx(xe,{children:u.jsxs(Qt,{ref:m,position:"fixed",left:e.x,top:e.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[u.jsx(ct,{onClick:()=>{E(),i()},children:d("contextMenu.refresh")}),u.jsx(Rt,{}),u.jsx(ct,{onClick:()=>{x(),i()},isDisabled:!p,children:d("contextMenu.copy")}),u.jsx(ct,{onClick:()=>{w(),i()},isDisabled:!p,children:d("contextMenu.cut")}),u.jsx(ct,{onClick:()=>{a(),i()},children:d("contextMenu.paste")}),u.jsx(ct,{onClick:()=>{C(),i()},isDisabled:!p,children:d("contextMenu.delete")}),u.jsx(Rt,{}),u.jsx(ct,{onClick:()=>{$(10),i()},isDisabled:!p,children:d("contextMenu.placeTop")}),u.jsx(ct,{onClick:()=>{$(-10),i()},isDisabled:!p,children:d("contextMenu.placeBottom")}),u.jsx(ct,{onClick:()=>{$(0),i()},isDisabled:!p,children:d("contextMenu.placeDefault")}),u.jsx(ct,{onClick:()=>{W(),i()},isDisabled:!p,children:d("contextMenu.placeUp")}),u.jsx(ct,{onClick:()=>{Q(),i()},isDisabled:!p,children:d("contextMenu.placeDown")})]})}):null},ct=({children:t,onClick:e,isDisabled:i=!1})=>u.jsx(Qt,{px:3,py:2,cursor:i?"not-allowed":"pointer",opacity:i?.5:1,_hover:i?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:i?void 0:e,fontSize:"sm",children:t}),Ze=D.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:i,svgWidth:d,svgHeight:o}=t,{preference:{toolsPanel:{expand:s}}}=R(A=>A.app),g=pe().colorMode==="light"?"#666464":"#D3D3D4",S=Tt(e,i,d,o),r=s?410*i/100:0,n=i>30?i>120?50:25:5,c=i/200,l={startX:q(S.xMin+r-n,n),endX:q(S.xMax+r+n,n),startY:q(S.yMin-n,n),endY:q(S.yMax+n,n)},f=Array.from({length:(l.endX-l.startX)/n+1},(A,x)=>{const w=l.startX+x*n,a=w%(n*5)===0?2*c:c;return u.jsx("line",{x1:w,y1:l.startY,x2:w,y2:l.endY,strokeWidth:a,stroke:g,opacity:"0.5"},"grid_vl_".concat(w))}),y=Array.from({length:(l.endY-l.startY)/n+1},(A,x)=>{const w=l.startY+x*n,a=w%(n*5)===0?2*c:c;return u.jsx("line",{x1:l.startX,y1:w,x2:l.endX,y2:w,strokeWidth:a,stroke:g,opacity:"0.5"},"grid_hl_".concat(w))}),p=Array.from({length:(l.endX-l.startX)/n/5+1},(A,x)=>{const w=q(l.startX,5*n)+x*5*n;return u.jsx("text",{x:w,y:S.yMin+i/5,fontSize:c*25,fill:g,textAnchor:"middle",opacity:"0.5",children:w},"grid_vc_".concat(w))}),m=Array.from({length:(l.endY-l.startY)/n/5+1},(A,x)=>{const w=q(l.startY,5*n)+x*5*n;return u.jsx("text",{x:S.xMin+i/8+r,y:w,fontSize:c*25,fill:g,textAnchor:"start",opacity:"0.5",children:w},"grid_hc_".concat(w))});return u.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,y,p,m]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),qe=He.component,Ut=Wt.generatePath,Zt=oe.component,Nt=10,Ge=()=>{var mt;const t=St(),e=()=>{t(wt(window.graph.export())),t(ut()),t(ht())},{activeSubscriptions:i}=R(z=>z.account),{telemetry:{project:d},preference:{autoParallel:o,randomStationsNames:s}}=R(z=>z.app),{selected:v,theme:g,count:{mostFrequentStationType:S},lastTool:r}=R(z=>z.runtime),n=de(),c=v.keys().next().value;if(!c.startsWith("stn")&&!c.startsWith("misc_node")||!window.graph.hasNode(c))return;const l=window.graph.neighbors(c);if(l.length===0)return;const f=window.graph.getNodeAttributes(c),y=l.reduce((z,X)=>{const k=window.graph.getNodeAttributes(X);return{x:z.x+k.x,y:z.y+k.y}},{x:0,y:0}),p={x:y.x/l.length,y:y.y/l.length},m={x:f.x-p.x,y:f.y-p.y},A={x:f.x+m.x,y:f.y+m.y},x=Math.sign(m.x)===Math.sign(m.y),w={x:A.x-Nt,y:A.y+Nt*(x?1:-1)},a={x:A.x+Nt,y:A.y+Nt*(x?-1:1)},C=c.startsWith("stn_"),E=C?window.graph.getNodeAttribute(c,"type"):r!=null&&r.startsWith("station-")?r.slice(8):S,$=ft[E].component,W={visible:!0,zIndex:0,x:a.x,y:a.y,type:E,[E]:ft[E].defaultAttrs};if(C){const z=structuredClone(window.graph.getNodeAttribute(c,E));Object.assign(W,{[E]:z})}const Q=window.graph.reduceEdges(c,(z,X)=>{const k=window.graph.getEdgeAttributes(X),{style:L}=k;if(L===Ct.SingleColor){const F=JSON.stringify(k[L].color);F in z?z[F]+=1:z[F]=1}return z},{}),N=(mt=Object.entries(Q).filter(([z,X])=>X%2!==0).reduce((z,[X,k])=>k>z.count?{color:JSON.parse(X),count:k}:z,{color:null,count:0}).color)!=null?mt:g,_=m.x>0?!(m.x>Math.abs(m.y)):-m.x>Math.abs(m.y),J=_?"from":"to",V=Ut(f.x,w.x,f.y,w.y,{...Wt.defaultAttrs,startFrom:J}),rt=_?"to":"from",it=Ut(f.x,a.x,f.y,a.y,{...Wt.defaultAttrs,startFrom:rt}),at=async(z,X)=>{X.stopPropagation();const{x:k,y:L}=dt(X);t(Bt({x:k,y:L}));const F=vt(10),H=ve.has(z),K=H?"stn_".concat(F):"misc_node_".concat(F),Y=structuredClone(H&&z===window.graph.getNodeAttribute(c,"type")?window.graph.getNodeAttribute(c,z):{...ft,...Mt}[z].defaultAttrs);re.has(z)&&(Y.color=g);const Z=!i.RMP_CLOUD||s==="none";H&&!Z&&(Y.names=await n(z)),window.graph.addNode(K,{visible:!0,zIndex:0,x:H?a.x:w.x,y:H?a.y:w.y,type:z,[z]:Y}),d&&At.event(Pt.ADD_STATION,{type:z});const U=nt.Diagonal,O="line_".concat(vt(10)),[tt,h]=[c,K],j=o?0:-1,b=H?rt:J;window.graph.addDirectedEdgeWithKey(O,tt,h,{visible:!0,zIndex:0,type:U,[U]:{...structuredClone(et[U].defaultAttrs),startFrom:b},style:Ct.SingleColor,[Ct.SingleColor]:{color:N},reconcileId:"",parallelIndex:j}),d&&At.event(Pt.ADD_LINE,{type:U}),e(),t(kt(K)),t(pt(new Set([K])))};return u.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[u.jsx(Zt,{id:"line_prediction_1",type:nt.Diagonal,path:V,styleAttrs:{color:N},newLine:!0,handlePointerDown:()=>{}}),u.jsx(Zt,{id:"line_prediction_2",type:nt.Diagonal,path:it,styleAttrs:{color:N},newLine:!0,handlePointerDown:()=>{}}),u.jsx(qe,{id:"misc_node_virtual_prediction_1",attrs:{},x:w.x,y:w.y,handlePointerDown:(z,X)=>{at(ot.Virtual,X)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),u.jsx($,{id:"stn_virtual_prediction_2",attrs:W,x:a.x,y:a.y,handlePointerDown:(z,X)=>{at(E,X)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},ue=(t,e,i,d,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s)||Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return qt(t,e,i,d,o)?{x1:e,y1:i,x2:d,y2:o,offset:s.offsetFrom}:void 0;const[v,g]=[s.offsetFrom,s.offsetTo];for(let S=0;S<Math.PI;S+=Math.PI/8)for(let r=S,n=0;n<2;n++,r+=Math.PI){const[c,l,f,y]=[Math.sin(S)*v,Math.cos(S)*v,Math.sin(r)*g,Math.cos(r)*g];if(qt(t,e+c,i+l,d+f,o+y))return{x1:e+c,y1:i+l,x2:d+f,y2:o+y,offset:0}}},Je=(t,e,i,d,o,s)=>t===i?{x1:t+5*s,y1:e,x2:i+5*s,y2:d,offset:o}:e===d?{x1:t,y1:e+5*s,x2:i,y2:d+5*s,offset:o}:{x1:t+5*Math.SQRT1_2*s,y1:e+5*Math.SQRT1_2*s,x2:i+5*Math.SQRT1_2*s,y2:d+5*Math.SQRT1_2*s,offset:o},qt=(t,e,i,d,o)=>!!((e===d||i===o)&&[nt.Diagonal,nt.Perpendicular].includes(t)||Math.abs((o-i)/(d-e))===1&&[nt.Diagonal,nt.RotatePerpendicular].includes(t)),Qe=(t,e)=>{const i=[],d=[];return Object.values(e).forEach(o=>{var A;if(o.length===1){d.push(...o.map(x=>x.edge));return}const s=t.getEdgeAttribute(o.at(0),"type");if(!o.every(x=>t.getEdgeAttribute(x,"type")===s)){d.push(...o.map(x=>x.edge));return}const v=t.getEdgeAttribute(o.at(0),"style");if(!o.every(x=>t.getEdgeAttribute(x,"style")===v)){d.push(...o.map(x=>x.edge));return}const g={},S=new Set,r=new Set,n=Object.fromEntries(o.map(x=>{var C,E;const[w,a]=t.extremities(x);return g[w]=((C=g[w])!=null?C:0)+1,g[a]=((E=g[a])!=null?E:0)+1,S.add(w),r.add(a),[w,[x.edge,a]]})),c=Array.from(S).filter(x=>g[x]===1),l=Array.from(r).filter(x=>g[x]===1);if(c.length!==1||l.length!==1){d.push(...o.map(x=>x.edge));return}const f=c[0],y=l[0];if(f===y){d.push(...o.map(x=>x.edge));return}const p=[n[f][0]];let m=n[f][1];for(let x=1;x<o.length;x=x+1){const w=(A=n[m])==null?void 0:A.at(1);if(!w){d.push(...o.map(a=>a.edge));return}p.push(n[m][0]),m=w}if(m!==y||p.length!==o.length){d.push(...o.map(x=>x.edge));return}i.push(p)}),{allReconciledLines:i,danglingLines:d}},tn=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const i=e.map(o=>{var l,f,y;const[s,v]=t.extremities(o),g=t.getNodeAttributes(s),S=t.getNodeAttributes(v),{type:r}=t.getEdgeAttributes(o),n=(l=t.getEdgeAttribute(o,r))!=null?l:et[r].defaultAttrs,c=ue(r,g.x,g.y,S.x,S.y,n);if(c){const{x1:p,y1:m,x2:A,y2:x,offset:w}=c;return et[nt.Simple].generatePath(p,A,m,x,{offset:w})}return(y=(f=et[r])==null?void 0:f.generatePath(g.x,S.x,g.y,S.y,n))!=null?y:"M ".concat(g.x," ").concat(g.y," L ").concat(S.x," ").concat(S.y)});let d="".concat(i[0]," ");for(let o=1;o<e.length;o=o+1)d+=i[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return d},en=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),nn=t=>{const e={},i={},d=[],o={},s=[];for(const r of t.edgeEntries()){const[n,c,l,f]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y],y=r.attributes[r.attributes.type],p=ue(r.attributes.type,n,c,l,f,y);i[r.edge]=p}for(const r of t.edgeEntries()){let n=i[r.edge];const{parallelIndex:c}=r.attributes;if(c>=0){const l=we(t,r.attributes.type,r.edge),f=i[l];if(!f){d.push(r);continue}if(c>0){const{x1:y,y1:p,x2:m,y2:A,offset:x}=f;n=Je(y,p,m,A,x,c)}}if(r.attributes.reconcileId!==""){const l=r.attributes.reconcileId;l in o?o[l].push(r):o[l]=[r];continue}if(n){const l=r.edge,f=r.attributes,{x1:y,y1:p,x2:m,y2:A,offset:x}=n;e[l]={attr:f,path:et[nt.Simple].generatePath(y,m,p,A,{offset:x})};continue}s.push(r)}const v=new Set;for(;d.length;){const r=d.pop();if(v.has(r.edge))continue;const{parallel:n}=Se(t,r);if(!n.length)continue;n.forEach(l=>v.add(l.edge));const c=Ae(n);for(const l of n){const f=l.edge;e[f]={attr:l.attributes,path:c[f]}}}const{allReconciledLines:g,danglingLines:S}=Qe(t,o);for(const r of g){const n=tn(t,r);if(!n)continue;const c=r[0];e[c]={attr:t.getEdgeAttributes(c),path:n}}for(const r of S){const n=t.getEdgeAttributes(r),[c,l]=t.extremities(r),f=t.getNodeAttributes(c),y=t.getNodeAttributes(l);e[r]={attr:n,path:et[nt.Simple].generatePath(f.x,y.x,f.y,y.y,et[nt.Simple].defaultAttrs)}}for(const r of s){const n=r.edge,c=r.attributes.type,l=r.attributes,[f,y,p,m]=[r.sourceAttributes.x,r.sourceAttributes.y,r.targetAttributes.x,r.targetAttributes.y];if(!(c in et)){e[n]={attr:l,path:"M ".concat(f," ").concat(y," L ").concat(p," ").concat(m)};continue}e[n]={attr:l,path:et[c].generatePath(f,p,y,m,l[c])}}return Object.entries(e).map(([r,n])=>({id:r,type:"line",line:n}))},he=(t,e)=>t.startsWith("stn")||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Virtual||t.startsWith("misc_node")&&e.getNodeAttribute(t,"type")===ot.Master&&e.getNodeAttributes(t)[ot.Master].nodeType==="Station",sn=(t,e)=>{const i=[];return e.filter(d=>he(d,t)).forEach(d=>{const o=t.getNodeAttribute(d,"x"),s=t.getNodeAttribute(d,"y");i.push({a:1,b:0,c:-o,node:d,x:o,y:s}),i.push({a:0,b:1,c:-s,node:d,x:o,y:s}),i.push({a:1,b:-1,c:-o+s,node:d,x:o,y:s}),i.push({a:1,b:1,c:-o-s,node:d,x:o,y:s})}),i},fe=(t,e,i)=>Math.abs(t.a*e+t.b*i+t.c)/Math.sqrt(t.a**2+t.b**2),on=(t,e,i,d)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return i.filter(v=>d.includes(v.node)).forEach(v=>{const g=fe(v,t,e);g<o&&(o=g,s=v)}),{l:s,d:o}},rn=(t,e,i,d,o)=>{const s=e.filter(r=>{const n=t.getNodeAttribute(r,"x"),c=t.getNodeAttribute(r,"y");return Math.abs(o.a*n+o.b*c+o.c)<=.01}),v=[(r,n,c,l)=>[(r+c)/2,(n+l)/2],(r,n,c,l)=>[2*r-c,2*n-l],(r,n,c,l)=>[2*c-r,2*l-n]];let g=1/0,S={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let r=0;r<s.length;r++){const n=s[r],c=t.getNodeAttribute(n,"x"),l=t.getNodeAttribute(n,"y");for(let f=r+1;f<s.length;f++){const y=s[f],p=t.getNodeAttribute(y,"x"),m=t.getNodeAttribute(y,"y");v.forEach(A=>{const[x,w]=A(c,l,p,m),a=Math.hypot(i-x,d-w);a<g&&(g=a,S={x,y:w,originalNodesPos:[{x:c,y:l},{x:p,y:m}]})})}}return{snapPoint:S,distance:g}},an=(t,e)=>{const{xMin:i,yMin:d,xMax:o,yMax:s}=e;if(t.a===0)return[i,o,-t.c/t.b,-t.c/t.b];if(t.b===0)return[-t.c/t.a,-t.c/t.a,d,s];{const v=-t.a/t.b,g=-t.c/t.b;return[i,o,v*i+g,v*o+g]}},cn=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:i}=R(l=>l.param),d=l=>{const y=[{x:l.x,y:l.y},...l.originalNodesPos].sort((m,A)=>m.x===A.x?m.y-A.y:m.x-A.x),p=(y[1].y-y[0].y)/(y[1].x-y[0].x);if(Math.abs(p)<=.01)return{original:y,offset:y.map(m=>({x:m.x,y:m.y+10})),rotate:0};if(Math.abs(p)>=1e10)return{original:y,offset:y.map(m=>({x:m.x+10,y:m.y})),rotate:90};{const A=-1/p,x=10/Math.sqrt(A*A+1),w=10*A/Math.sqrt(A*A+1);return{original:y,offset:y.map(a=>({x:a.x+x,y:a.y+w})),rotate:-Math.atan(A)*(180/Math.PI)}}},{original:o,offset:s,rotate:v}=d(e),g=l=>{const f=Math.sqrt(3)/2*l,y="0,0",p="".concat(-l/2,",").concat(f),m="".concat(l/2,",").concat(f);return"".concat(y," ").concat(p," ").concat(m)},S=i/75,r=8*S,n="#FC8181",c="".concat(S*5," ").concat(S*2);return u.jsxs(u.Fragment,{children:[u.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:S,strokeDasharray:c}),u.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:S,strokeDasharray:c}),u.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:n,strokeWidth:S,strokeDasharray:c}),u.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:n,strokeWidth:S,strokeDasharray:c}),u.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:n,strokeWidth:S,strokeDasharray:c}),u.jsx("polygon",{points:g(r),transform:"translate(".concat(s[0].x,",").concat(s[0].y,") rotate(").concat((v+270)%360,")"),fill:n}),u.jsx("polygon",{points:g(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((v+270)%360,")"),fill:n}),u.jsx("polygon",{points:g(r),transform:"translate(".concat(s[1].x,",").concat(s[1].y,") rotate(").concat((v+90)%360,")"),fill:n}),u.jsx("polygon",{points:g(r),transform:"translate(".concat(s[2].x,",").concat(s[2].y,") rotate(").concat((v+90)%360,")"),fill:n})]})},Gt=t=>{const{id:e,x:i,y:d,handlePointerDown:o,handlePointerMove:s,handlePointerUp:v}=t,g=D.useCallback(n=>o(e,n),[e,o]),S=D.useCallback(n=>s(e,n),[e,s]),r=D.useCallback(n=>v(e,n),[e,v]);return u.jsx("g",{id:e,transform:"translate(".concat(i-6.4," ").concat(d-6.4,")scale(0.025)"),onPointerDown:g,onPointerMove:S,onPointerUp:r,style:{cursor:"move"},children:u.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ln=t=>{const{id:e,path:i,handlePointerDown:d}=t,o=D.useCallback(s=>d(e,s),[e,d]);return u.jsx("path",{id:e,d:i,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},dn=D.memo(t=>{var S,r,n,c,l,f,y,p,m,A,x,w;const{elements:e,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o,handleEdgePointerDown:s}=t,v=Object.fromEntries(Array.from({length:21},(a,C)=>[C-10,{pre:[],main:[],post:[]}]));for(const a of e)if(a.type==="line"){const C=a.line.attr.type,E=a.line.attr.style,$=a.line.attr[E],W=(S=Lt[E])==null?void 0:S.preComponent;W&&v[a.line.attr.zIndex].pre.push(u.jsx(W,{id:a.id,type:C,path:a.line.path,styleAttrs:$,newLine:!1,handlePointerDown:s},"".concat(a.id,".pre")));const Q=(n=(r=Lt[E])==null?void 0:r.component)!=null?n:ln;v[a.line.attr.zIndex].main.push(u.jsx(Q,{id:a.id,type:C,path:a.line.path,styleAttrs:$,newLine:!1,handlePointerDown:s},a.id));const N=(c=Lt[E])==null?void 0:c.postComponent;N&&v[a.line.attr.zIndex].post.push(u.jsx(N,{id:a.id,type:C,path:a.line.path,styleAttrs:$,newLine:!1,handlePointerDown:s},"".concat(a.id,".post")))}else if(a.type==="station"){const C=a.station,E=C.type,$=(l=ft[E])==null?void 0:l.preComponent;$&&v[a.station.zIndex].pre.push(u.jsx($,{id:a.id,x:C.x,y:C.y,attrs:C,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const W=(y=(f=ft[E])==null?void 0:f.component)!=null?y:Gt;v[a.station.zIndex].main.push(u.jsx(W,{id:a.id,x:C.x,y:C.y,attrs:C,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(p=ft[E])==null?void 0:p.postComponent;Q&&v[a.station.zIndex].post.push(u.jsx(Q,{id:a.id,x:C.x,y:C.y,attrs:C,handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}else if(a.type==="misc-node"){const C=a.miscNode,E=C.type,$=(m=Mt[E])==null?void 0:m.preComponent;$&&v[a.miscNode.zIndex].pre.push(u.jsx($,{id:a.id,x:C.x,y:C.y,attrs:C[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".pre")));const W=(x=(A=Mt[E])==null?void 0:A.component)!=null?x:Gt;v[a.miscNode.zIndex].main.push(u.jsx(W,{id:a.id,x:C.x,y:C.y,attrs:C[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},a.id));const Q=(w=Mt[E])==null?void 0:w.postComponent;Q&&v[a.miscNode.zIndex].post.push(u.jsx(Q,{id:a.id,x:C.x,y:C.y,attrs:C[E],handlePointerDown:i,handlePointerMove:d,handlePointerUp:o},"".concat(a.id,".post")))}return Array.from({length:21},(a,C)=>(C-10).toString()).map(a=>[...v[a].pre,...v[a].main,...v[a].post]).flat()},(t,e)=>t.elements===e.elements),un=[...Object.values(Pe),ot.Virtual,ot.Master,ot.Fill,ot.LondonArrow,ot.ChongqingRTNumLineBadge2021,ot.ChongqingRTTextLineBadge2021,ot.ChengduRTLineBadge,ot.GzmtrLineBadge],hn=()=>{const t=St(),e=D.useRef(window.graph),i=()=>{t(wt(e.current.export())),t(ut()),t(ht())},{telemetry:{project:d},preference:{autoParallel:o,snapLines:s,autoChangeStationType:v}}=R(k=>k.app),{svgViewBoxZoom:g,svgViewBoxMin:S}=R(k=>k.param),{selected:r,pointerPosition:n,active:c,refresh:{nodes:l,edges:f},mode:y,keepLastPath:p,theme:m}=R(k=>k.runtime),A=_t(),{height:x,width:w}=zt(A),[a,C]=D.useState({dx:0,dy:0}),[E,$]=D.useState([]),[W,Q]=D.useState([]),[N,_]=D.useState([]);D.useEffect(()=>{if(!n||!s)return;const k=Tt(S,g,w,x),L=ce(e.current,...Object.values(k));Q(L),$(sn(e.current,L))},[S,g,w,x,n]);const[J,V]=D.useState(void 0),rt=B((k,L)=>{L.stopPropagation(),L.currentTarget.setPointerCapture(L.pointerId);const{x:F,y:H}=dt(L);y==="select"&&t(yt("free")),_([]),V(void 0),t(Bt({x:F,y:H})),t(kt(k)),L.shiftKey?r.has(k)?t(Vt(k)):t(Xt(k)):r.has(k)||t(pt(new Set([k])))}),it=B((k,L)=>{const{x:F,y:H}=dt(L);if(L.currentTarget.setPointerCapture(L.pointerId),y==="free"&&c===k){if(!L.altKey&&s){const K=e.current.getNodeAttribute(k,"x"),Y=e.current.getNodeAttribute(k,"y"),Z=K-(n.x-F)*g/100,U=Y-(n.y-H)*g/100;let O=Z,tt=U;if(he(k,e.current)){let b=N,P=J;if(b.length!==0&&(b=b.filter(M=>fe(M,Z,U)<=6)),P&&(b.length===0||Math.hypot(Z-P.x,U-P.y)>6)&&(P=void 0),!P&&b.length===1){const M=b[0],{snapPoint:I,distance:T}=rn(e.current,W.filter(G=>!r.has(G)),Z,U,M);T<=3&&(P=I)}if(b.length===1&&!P||b.length===0){const{l:M,d:I}=on(Z,U,E,W.filter(G=>!r.has(G)&&!b.some(st=>st.node===G))),T=b.length===0||!b.some(G=>G.a===M.a&&G.b===M.b);I<3&&b.length<2&&T&&b.push(M)}if(b.length===1)if(P)O=P.x,tt=P.y;else{const M=b[0];if(M.a==0)tt=-M.c/M.b;else if(M.b==0)O=-M.c/M.a;else{const I=-M.a/M.b,T=-M.c/M.b;tt=I*O+T}}else if(b.length===2){const M=b[0],I=b[1],T=M.a*I.b-I.a*M.b;T!==0&&(O=-(M.c*I.b-I.c*M.b)/T,tt=-(M.a*I.c-I.a*M.c)/T)}_(b),V(P)}const h=O-K,j=tt-Y;r.forEach(b=>{e.current.hasNode(b)&&e.current.updateNodeAttributes(b,P=>({...P,x:q(P.x+h,.01),y:q(P.y+j,.01)}))})}else _([]),V(void 0),r.forEach(K=>{e.current.hasNode(K)&&e.current.updateNodeAttributes(K,Y=>({...Y,x:q(Y.x-(n.x-F)*g/100,L.altKey?.01:5),y:q(Y.y-(n.y-H)*g/100,L.altKey?.01:5)}))});t(ut()),t(ht())}else y.startsWith("line")&&c&&C({dx:(n.x-F)*g/100,dy:(n.y-H)*g/100})}),at=B((k,L)=>{var F,H,K;if(L.currentTarget.releasePointerCapture(L.pointerId),y.startsWith("line")){p||t(yt("free"));const Y=e.current.hasNode(c)&&un.includes(e.current.getNodeAttribute(c,"type")),Z=["stn_core_","virtual_circle_","misc_node_connectable_"],O=(K=(H=(F=document.elementsFromPoint(L.clientX,L.clientY).at(0))==null?void 0:F.attributes)==null?void 0:H.getNamedItem("id"))==null?void 0:K.value,tt=Z.find(h=>O==null?void 0:O.startsWith(h));if(Y&&tt){const h=y.slice(5),j="line_".concat(vt(10)),[b,P]=[c,O.slice(tt.length)];if(b!==P){const M=o?ie(e.current,h,b,P,"from"):-1;e.current.addDirectedEdgeWithKey(j,b,P,{visible:!0,zIndex:0,type:h,[h]:structuredClone(et[h].defaultAttrs),style:Ct.SingleColor,[Ct.SingleColor]:{color:m},reconcileId:"",parallelIndex:M}),v&&b.startsWith("stn")&&Dt(e.current,b),v&&P.startsWith("stn")&&Dt(e.current,P),t(pt(new Set([j]))),d&&At.event(Pt.ADD_LINE,{type:h}),t(wt(e.current.export())),t(ht())}}}else if(y==="free"&&c){const{x:Y,y:Z}=dt(L);n.x-Y===0&&n.y-Z===0||(t(wt(e.current.export())),t(ut()))}_([]),V(void 0),Bt(void 0),t(kt(void 0))}),mt=B((k,L)=>{if(L.stopPropagation(),L.shiftKey||t(xt()),L.shiftKey&&r.has(k)?t(Vt(k)):t(Xt(k)),y.startsWith("station")||y.startsWith("misc-node-virtual")||y.startsWith("misc-node-master")){const F=L.clientX-document.getElementById("canvas").getBoundingClientRect().left,H=L.clientY-document.getElementById("canvas").getBoundingClientRect().top,K=y.startsWith("station"),Y=vt(10),Z=K?"stn_".concat(Y):"misc_node_".concat(Y),U=K?y.slice(8):y.slice(10),{x:O,y:tt}=lt(F,H,g,S),h=K?structuredClone(ft[U].defaultAttrs):structuredClone(Mt[U].defaultAttrs);"color"in h&&(h.color=m),e.current.addNode(Z,{visible:!0,zIndex:0,x:q(O,5),y:q(tt,5),type:U,[U]:h});const j=e.current.getEdgeAttributes(k),{zIndex:b,type:P,style:M}=j,I=j[P],T=j[M],[G,st]=e.current.extremities(k),gt=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),G,Z,{visible:!0,zIndex:b,type:P,[P]:structuredClone(I),style:M,[M]:structuredClone(T),reconcileId:"",parallelIndex:gt}),e.current.addDirectedEdgeWithKey("line_".concat(vt(10)),Z,st,{visible:!0,zIndex:b,type:P,[P]:structuredClone(I),style:M,[M]:structuredClone(T),reconcileId:"",parallelIndex:gt}),e.current.dropEdge(k),i(),d&&(At.event(Pt.ADD_STATION,{type:U}),At.event(Pt.ADD_LINE,{type:P})),t(yt("free")),t(pt(new Set([Z])))}}),z=D.useMemo(()=>[...nn(e.current),...en(e.current)],[f,l]),X=oe.component;return u.jsxs(u.Fragment,{children:[u.jsx(dn,{elements:z,handlePointerDown:rt,handlePointerMove:it,handlePointerUp:at,handleEdgePointerDown:mt}),y.startsWith("line")&&c&&c!=="background"&&u.jsx(X,{id:"line_create_in_progress___no_use",type:y.slice(5),path:et[y.slice(5)].generatePath(e.current.getNodeAttribute(c,"x"),e.current.getNodeAttribute(c,"x")-a.dx,e.current.getNodeAttribute(c,"y"),e.current.getNodeAttribute(c,"y")-a.dy,et[y.slice(5)].defaultAttrs),styleAttrs:{color:m},newLine:!0,handlePointerDown:()=>{}}),N.length!==0&&N.map(k=>u.jsx("path",{d:et[nt.Simple].generatePath(...an(k,Tt(S,g,w,x)),et[nt.Simple].defaultAttrs),stroke:"cyan",strokeWidth:g/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),J&&u.jsx(cn,{activeSnapPoint:J})]})},fn=()=>{const t=St(),{svgViewBoxZoom:e,svgViewBoxMin:i}=R(f=>f.param),{radialTouchMenu:d}=R(f=>f.runtime),o=D.useRef(window.graph),[s,v]=D.useState(0),g=_t(),{height:S,width:r}=zt(g),n=B(f=>{var y;if(f.touches.length==1){if(v(0),d.visible){t(Ft());return}const p=f.touches[0],m=(y=document.getElementById("canvas"))==null?void 0:y.getBoundingClientRect();if(!m)return;const A=p.clientX-m.left,x=p.clientY-m.top,w=lt(A,x,e,i),a=Me(o.current,w,t);[...a[It.STATION],...a[It.MISC_NODE],...a[It.LINE]].length>0?t(ke({visible:!0,position:w,data:a})):(t(xt()),t(Ft()))}else if(f.touches.length==2){t(kt(void 0));const[p,m]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY];v(p*p+m*m)}}),c=B(f=>{if(f.touches.length==2&&s>0){const[y,p]=[f.touches[0].clientX-f.touches[1].clientX,f.touches[0].clientY-f.touches[1].clientY],m=y*y+p*p;let A=e;m-s<0&&e+10<=390?A=e+10:m-s>0&&e-10>=10&&(A=e-10),t(ae(A)),v(m);const x=f.currentTarget.getBoundingClientRect(),[w,a]=[(f.touches[0].clientX+f.touches[1].clientX)/2-x.left,(f.touches[0].clientY+f.touches[1].clientY)/2-x.top],[C,E]=[w/x.width,a/x.height];t(jt({x:i.x+w*e/100-r*A/100*C,y:i.y+a*e/100-S*A/100*E}))}}),l=B(f=>{v(0)});return u.jsx("rect",{className:"removeMe",x:i.x,y:i.y,width:r*e/100,height:S*e/100,fill:d.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:n,onTouchMove:c,onTouchEnd:l})},Jt=10,gn=()=>{const t=St(),e=D.useRef(window.graph),{svgViewBoxZoom:i,svgViewBoxMin:d}=R(a=>a.param),{selected:o}=R(a=>a.runtime),s=_t(),{height:v,width:g}=zt(s),S=D.useCallback(()=>{t(wt(e.current.export())),t(ut()),t(ht())},[t]),r=D.useCallback((a,C,E)=>{a.stopPropagation(),o.size>0&&(o.forEach($=>{e.current.hasNode($)&&(e.current.updateNodeAttribute($,"x",W=>(W!=null?W:0)+C*Jt),e.current.updateNodeAttribute($,"y",W=>(W!=null?W:0)+E*Jt))}),S())},[o,S]),n=D.useCallback(a=>r(a,0,-1),[r]),c=D.useCallback(a=>r(a,0,1),[r]),l=D.useCallback(a=>r(a,-1,0),[r]),f=D.useCallback(a=>r(a,1,0),[r]),y=D.useCallback(()=>{if(o.size>0){const a=Et(e.current,o);navigator.clipboard.writeText(a)}},[o]),p=D.useCallback(()=>{o.size>0&&(t(xt()),o.forEach(a=>{e.current.hasNode(a)?e.current.dropNode(a):e.current.hasEdge(a)&&e.current.dropEdge(a)}),S())},[o,t,S]),m=d.x+g*i/200,A=d.y+(v-100)*i/100,x=40,w=40;return u.jsxs("g",{transform:"translate(".concat(m,", ").concat(A,")scale(").concat(1.5*i/100,")"),children:[u.jsxs("g",{transform:"translate(0, -".concat(w,")"),children:[u.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:n}),u.jsx(Ce,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(0, ".concat(w,")"),children:[u.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:c}),u.jsx(Ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(w,", 0)"),children:[u.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:l}),u.jsx(je,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(w,", 0)"),children:[u.jsx("circle",{r:x/2,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),u.jsx(Ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(".concat(w,", ").concat(w,")"),children:[u.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:y}),u.jsx(De,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),u.jsxs("g",{transform:"translate(-".concat(w,", ").concat(w,")"),children:[u.jsx("circle",{r:x/2*.8,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:p}),u.jsx(_e,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},Sn=()=>{const t=St(),e=D.useRef(window.graph),i=D.useCallback(()=>{t(wt(e.current.export())),t(ut()),t(ht())},[t]),{activeSubscriptions:d}=R(h=>h.account),{telemetry:{project:o},preference:{gridLines:s,snapLines:v,predictNextNode:g,autoParallel:S,autoChangeStationType:r}}=R(h=>h.app),{svgViewBoxZoom:n,svgViewBoxMin:c}=R(h=>h.param),{selected:l,active:f,isDetailsOpen:y,mode:p,lastTool:m,keepLastPath:A,theme:x,count:{masters:w,lines:a}}=R(h=>h.runtime),C=_t(),{height:E,width:$}=zt(C),W=!d.RMP_CLOUD&&w+1>ee,Q=!S||S&&!d.RMP_CLOUD&&a+1>ne,N=de();ze();const[_,J]=D.useState({x:0,y:0}),[V,rt]=D.useState({x:0,y:0}),[it,at]=D.useState({isOpen:!1,position:{x:0,y:0}}),[mt,z]=D.useState({x:0,y:0}),[X,k]=D.useState({x:0,y:0}),L=B(async h=>{it.isOpen&&at({isOpen:!1,position:{x:0,y:0}});const{x:j,y:b}=dt(h);if(p.startsWith("station")||p.startsWith("misc-node")){t(yt("free"));const P=vt(10),{x:M,y:I}=lt(j,b,n,c),T=p.startsWith("station"),G=T?"stn_".concat(P):"misc_node_".concat(P),st=T?p.slice(8):p.slice(10),gt=structuredClone({...ft,...Mt}[st].defaultAttrs);re.has(st)&&(gt.color=x),T&&(gt.names=await N(st)),e.current.addNode(G,{visible:!0,zIndex:0,x:q(M,5),y:q(I,5),type:st,[st]:gt}),o&&At.event(Pt.ADD_STATION,{type:st}),i(),t(pt(new Set([G])))}else p==="free"||p.startsWith("line")?(p.startsWith("line")&&(t(yt("free")),A&&t(Oe(!1))),z({x:j,y:b}),k(c),h.shiftKey||(t(kt("background")),t(xt()))):p==="select"&&(J(lt(j,b,n,c)),rt(lt(j,b,n,c)))}),F=B(h=>{if(p==="select"){if(_.x!=0&&_.y!=0){const{x:j,y:b}=dt(h);rt(lt(j,b,n,c))}}else if(f==="background"){const{x:j,y:b}=dt(h);t(jt({x:X.x+(mt.x-j)*n/100,y:X.y+(mt.y-b)*n/100}))}}),H=B(h=>{if(p==="select"){const{x:j,y:b}=dt(h),{x:P,y:M}=lt(j,b,n,c),I=ce(e.current,_.x,_.y,P,M),T=Xe(e.current,new Set(I));t(pt(new Set([...h.shiftKey?l:[],...I,...T]))),t(yt("free")),J({x:0,y:0}),rt({x:0,y:0})}f==="background"&&!h.shiftKey&&t(kt(void 0))}),K=B(h=>{let j=n;h.deltaY>0&&n+10<400?j=n+10:h.deltaY<0&&n-10>0&&(j=n-10),t(ae(j));const{x:b,y:P}=dt(h),M=h.currentTarget.getBoundingClientRect(),[I,T]=[b/M.width,P/M.height];t(jt({x:c.x+b*n/100-$*j/100*I,y:c.y+P*n/100-E*j/100*T}))}),Y=B(h=>{h.preventDefault(),dt(h),at({isOpen:!0,position:{x:h.clientX,y:h.clientY}})}),Z=B(()=>{at({isOpen:!1,position:{x:0,y:0}});const h=document.getElementById("canvas");h&&h.focus()}),U=B(async h=>{if(bt?h.key==="Backspace":h.key==="Delete")l.size>0&&(l.forEach(j=>{if(e.current.hasNode(j))e.current.dropNode(j);else if(e.current.hasEdge(j)){const[b,P]=e.current.extremities(j);e.current.dropEdge(j),r&&b.startsWith("stn")&&Dt(e.current,b),r&&P.startsWith("stn")&&Dt(e.current,P)}}),t(xt()),i());else if(h.key.startsWith("Arrow")){const b=h.key.endsWith("Left")?-1:h.key.endsWith("Right")?1:0,P=h.key.endsWith("Up")?-1:h.key.endsWith("Down")?1:0;t(jt(lt(100*b,100*P,n,c)))}else if(h.key==="i"||h.key==="j"||h.key==="k"||h.key==="l"){const b=(h.key==="j"?-1:h.key==="l"?1:0)*10,P=(h.key==="i"?-1:h.key==="k"?1:0)*10;l.size>0&&l.forEach(M=>{e.current.hasNode(M)&&(e.current.updateNodeAttribute(M,"x",I=>(I!=null?I:0)+b),e.current.updateNodeAttribute(M,"y",I=>(I!=null?I:0)+P),i())})}else if(h.key==="f"&&m)t(yt(m));else if(h.key==="z"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey))bt&&h.preventDefault(),t(We()),t(ut()),t(ht());else if(h.key==="s")t(yt("select"));else if((h.key==="c"||h.key==="x")&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=Et(e.current,l);navigator.clipboard.writeText(j),h.key==="x"&&(t(xt()),l.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),i())}else if(h.key==="v"&&(bt?h.metaKey&&!h.shiftKey:h.ctrlKey)){const j=await navigator.clipboard.readText(),{x:b,y:P}=lt($/2,E/2,n,c),{nodes:M,edges:I}=se(j,e.current,W,Q,q(b,5),q(P,5));i();const T=structuredClone(M);I.forEach(G=>T.add(G)),t(pt(T))}else if(bt&&h.key==="z"&&h.metaKey&&h.shiftKey||!bt&&h.key==="y"&&h.ctrlKey)t(Be());else if(h.key==="c")t(Re(!v));else if(h.key==="e"){const[j]=l;if(l.size===1&&e.current.hasEdge(j)){const b=e.current.getEdgeAttributes(j),{type:P}=b;if(P!==nt.Simple&&b[P]){const M=b[P],T=(M.startFrom||"from")==="from"?"to":"from";let G=b.parallelIndex;if(S){const[gt,ge]=e.current.extremities(j);G=ie(e.current,P,gt,ge,T)}const st={...M,startFrom:T};e.current.mergeEdgeAttributes(j,{[P]:st,parallelIndex:G}),i()}}}}),[O,tt]=D.useState({sx:0,sy:0,ex:0,ey:0});return D.useEffect(()=>{tt({sx:_.x<=V.x?_.x:V.x,ex:_.x>V.x?_.x:V.x,sy:_.y<=V.y?_.y:V.y,ey:_.y>V.y?_.y:V.y})},[V.x,V.y]),u.jsxs(u.Fragment,{children:[u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:E,width:$,viewBox:"".concat(c.x," ").concat(c.y," ").concat($*n/100," ").concat(E*n/100),onPointerDown:L,onPointerMove:F,onPointerUp:H,onWheel:K,onContextMenu:Y,tabIndex:0,onKeyDown:U,children:[u.jsx("defs",{children:u.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[u.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),u.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),s&&u.jsx(Ze,{svgViewBoxMin:c,svgViewBoxZoom:n,svgWidth:$,svgHeight:E}),Ht()&&p==="free"&&u.jsx(fn,{}),g&&l.size===1&&p==="free"&&u.jsx(Ge,{}),u.jsx(Ve.SvgAssetsContextProvider,{children:u.jsx(hn,{})}),p==="select"&&_.x!=0&&_.y!=0&&u.jsx("rect",{x:O.sx,y:O.sy,width:O.ex-O.sx,height:O.ey-O.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),Ht()&&[...l].some(h=>h.startsWith("stn_")||h.startsWith("misc_node_"))&&u.jsx(gn,{}),u.jsx(Ie,{})]}),u.jsx(Ue,{isOpen:it.isOpen,position:it.position,onClose:Z}),Le()&&y==="hide"&&u.jsx(me,{"aria-label":"open details panel",icon:u.jsx(Te,{style:{transform:"rotate(180deg)"}}),onClick:()=>t($e()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})};export{Sn as default};

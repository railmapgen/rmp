import{ad as Ot,j as v}from"./chakra-BSDUEdZw.js";import{T as Wt,aw as Lt,ax as Ft,a7 as _t,e as Q,ay as Et,az as R,L as Z,q as F,aA as Ut,aB as Gt,aC as qt,aD as Ct,c as Ht,t as Rt,v as Xt,aE as tt,aF as et,aG as ht,X as ct,aH as jt,aI as Nt,w as ft,x as lt,aJ as it,n as ut,o as Zt,p as zt,r as xt,E as mt,y as vt,D as St,Y as J,aK as Qt,aL as Jt,S as te,aM as ee,a4 as ne,aN as se,af as rt,G as pt,at as oe,au as ie,F as Dt,d as re,a5 as ae}from"./index-SSdUUqJG.js";import{s as yt,f as Kt,g as ce,i as le,b as de,c as ue,e as he,h as fe,j as ye}from"./master-manager-BCMCRiFY.js";import{j as Yt,b as $}from"./react-BsdiJPLR.js";import{u as G,e as ge,i as pe}from"./clipboard-GkoI25G0.js";import{m as gt}from"./misc-nodes-zM5TUdm4.js";const xe={[_t.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[_t.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},me=t=>{const e=xe[t];return e.at(Math.floor(Math.random()*e.length))},$t=Yt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:u,rejectWithValue:h})=>{const{token:i}=e().account;if(!i){u(Lt({cityName:t,names:[]}));return}const c=await fetch("".concat(Ft,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(i)}});if(!c.ok)return Wt.warn("Failed to fetch random station names",c.statusText),h(c.statusText);const w=await c.json();u(Lt({cityName:t,names:w}))}),Tt=Yt("runtime/getOneStationName",async(t,{getState:e,dispatch:u})=>{var a;const{stationNames:h}=e().runtime,i=h[t];if(((a=i==null?void 0:i.length)!=null?a:0)==0)return Wt.debug("No random station names in cache, using fallback"),u($t({cityName:t})),Object.values(me(t));const c=structuredClone(i),w=c.shift();return u(Lt({cityName:t,names:c})),c.length<3&&u($t({cityName:t})),Object.values(w)}),ve=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:u,svgWidth:h,svgHeight:i}=t,{preference:{toolsPanel:{expand:c}}}=Q(L=>L.app),a=Ot().colorMode==="light"?"#666464":"#D3D3D4",d=Et(e,u,h,i),s=c?410*u/100:0,r=u>30?u>120?50:25:5,x=u/200,o={startX:R(d.xMin+s-r,r),endX:R(d.xMax+s+r,r),startY:R(d.yMin-r,r),endY:R(d.yMax+r,r)},p=Array.from({length:(o.endX-o.startX)/r+1},(L,f)=>{const y=o.startX+f*r,l=y%(r*5)===0?2*x:x;return v.jsx("line",{x1:y,y1:o.startY,x2:y,y2:o.endY,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_vl_".concat(y))}),S=Array.from({length:(o.endY-o.startY)/r+1},(L,f)=>{const y=o.startY+f*r,l=y%(r*5)===0?2*x:x;return v.jsx("line",{x1:o.startX,y1:y,x2:o.endX,y2:y,strokeWidth:l,stroke:a,opacity:"0.5"},"grid_hl_".concat(y))}),_=Array.from({length:(o.endX-o.startX)/r/5+1},(L,f)=>{const y=R(o.startX,5*r)+f*5*r;return v.jsx("text",{x:y,y:d.yMin+u/5,fontSize:x*25,fill:a,textAnchor:"middle",opacity:"0.5",children:y},"grid_vc_".concat(y))}),C=Array.from({length:(o.endY-o.startY)/r/5+1},(L,f)=>{const y=R(o.startY,5*r)+f*5*r;return v.jsx("text",{x:d.xMin+u/8+s,y,fontSize:x*25,fill:a,textAnchor:"start",opacity:"0.5",children:y},"grid_hc_".concat(y))});return v.jsxs("g",{id:"grid-lines",className:"removeMe",children:[p,S,_,C]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Vt=(t,e,u,h,i,c)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return It(t,e,u,h,i)?{x1:e,y1:u,x2:h,y2:i,offset:c.offsetFrom}:void 0;const[w,a]=[c.offsetFrom,c.offsetTo];for(let d=0;d<Math.PI;d+=Math.PI/8)for(let s=d,r=0;r<2;r++,s+=Math.PI){const[x,o,p,S]=[Math.sin(d)*w,Math.cos(d)*w,Math.sin(s)*a,Math.cos(s)*a];if(It(t,e+x,u+o,h+p,i+S))return{x1:e+x,y1:u+o,x2:h+p,y2:i+S,offset:0}}},Se=(t,e,u,h,i,c)=>t===u?{x1:t+5*c,y1:e,x2:u+5*c,y2:h,offset:i}:e===h?{x1:t,y1:e+5*c,x2:u,y2:h+5*c,offset:i}:{x1:t+5*Math.SQRT1_2*c,y1:e+5*Math.SQRT1_2*c,x2:u+5*Math.SQRT1_2*c,y2:h+5*Math.SQRT1_2*c,offset:i},It=(t,e,u,h,i)=>!!((e===h||u===i)&&[Z.Diagonal,Z.Perpendicular].includes(t)||Math.abs((i-u)/(h-e))===1&&[Z.Diagonal,Z.RotatePerpendicular].includes(t)),be=(t,e)=>{const u=[],h=[];return Object.values(e).forEach(i=>{var L;if(i.length===1){h.push(...i.map(f=>f.edge));return}const c=t.getEdgeAttribute(i.at(0),"type");if(!i.every(f=>t.getEdgeAttribute(f,"type")===c)){h.push(...i.map(f=>f.edge));return}const w=t.getEdgeAttribute(i.at(0),"style");if(!i.every(f=>t.getEdgeAttribute(f,"style")===w)){h.push(...i.map(f=>f.edge));return}const a={},d=new Set,s=new Set,r=Object.fromEntries(i.map(f=>{var M,T;const[y,l]=t.extremities(f);return a[y]=((M=a[y])!=null?M:0)+1,a[l]=((T=a[l])!=null?T:0)+1,d.add(y),s.add(l),[y,[f.edge,l]]})),x=Array.from(d).filter(f=>a[f]===1),o=Array.from(s).filter(f=>a[f]===1);if(x.length!==1||o.length!==1){h.push(...i.map(f=>f.edge));return}const p=x[0],S=o[0];if(p===S){h.push(...i.map(f=>f.edge));return}const _=[r[p][0]];let C=r[p][1];for(let f=1;f<i.length;f=f+1){const y=(L=r[C])==null?void 0:L.at(1);if(!y){h.push(...i.map(l=>l.edge));return}_.push(r[C][0]),C=y}if(C!==S||_.length!==i.length){h.push(...i.map(f=>f.edge));return}u.push(_)}),{allReconciledLines:u,danglingLines:h}},Ae=(t,e)=>{if(!e.every(i=>t.hasEdge(i)))return;const u=e.map(i=>{var o,p,S;const[c,w]=t.extremities(i),a=t.getNodeAttributes(c),d=t.getNodeAttributes(w),{type:s}=t.getEdgeAttributes(i),r=(o=t.getEdgeAttribute(i,s))!=null?o:F[s].defaultAttrs,x=Vt(s,a.x,a.y,d.x,d.y,r);if(x){const{x1:_,y1:C,x2:L,y2:f,offset:y}=x;return F[Z.Simple].generatePath(_,L,C,f,{offset:y})}return(S=(p=F[s])==null?void 0:p.generatePath(a.x,d.x,a.y,d.y,r))!=null?S:"M ".concat(a.x," ").concat(a.y," L ").concat(d.x," ").concat(d.y)});let h="".concat(u[0]," ");for(let i=1;i<e.length;i=i+1)h+=u[i].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return h},we=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Pe=t=>{const e={},u={},h=[],i={},c=[];for(const s of t.edgeEntries()){const[r,x,o,p]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],S=s.attributes[s.attributes.type],_=Vt(s.attributes.type,r,x,o,p,S);u[s.edge]=_}for(const s of t.edgeEntries()){let r=u[s.edge];const{parallelIndex:x}=s.attributes;if(x>=0){const o=Ut(t,s.attributes.type,s.edge),p=u[o];if(!p){h.push(s);continue}if(x>0){const{x1:S,y1:_,x2:C,y2:L,offset:f}=p;r=Se(S,_,C,L,f,x)}}if(s.attributes.reconcileId!==""){const o=s.attributes.reconcileId;o in i?i[o].push(s):i[o]=[s];continue}if(r){const o=s.edge,p=s.attributes,{x1:S,y1:_,x2:C,y2:L,offset:f}=r;e[o]={attr:p,path:F[Z.Simple].generatePath(S,C,_,L,{offset:f})};continue}c.push(s)}const w=new Set;for(;h.length;){const s=h.pop();if(w.has(s.edge))continue;const{parallel:r}=Gt(t,s);if(!r.length)continue;r.forEach(o=>w.add(o.edge));const x=qt(r);for(const o of r){const p=o.edge;e[p]={attr:o.attributes,path:x[p]}}}const{allReconciledLines:a,danglingLines:d}=be(t,i);for(const s of a){const r=Ae(t,s);if(!r)continue;const x=s[0];e[x]={attr:t.getEdgeAttributes(x),path:r}}for(const s of d){const r=t.getEdgeAttributes(s),[x,o]=t.extremities(s),p=t.getNodeAttributes(x),S=t.getNodeAttributes(o);e[s]={attr:r,path:F[Z.Simple].generatePath(p.x,S.x,p.y,S.y,F[Z.Simple].defaultAttrs)}}for(const s of c){const r=s.edge,x=s.attributes.type,o=s.attributes,[p,S,_,C]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(x in F)){e[r]={attr:o,path:"M ".concat(p," ").concat(S," L ").concat(_," ").concat(C)};continue}e[r]={attr:o,path:F[x].generatePath(p,_,S,C,o[x])}}return Object.entries(e).map(([s,r])=>({id:s,type:"line",line:r}))},Bt=t=>{const{id:e,x:u,y:h,handlePointerDown:i,handlePointerMove:c,handlePointerUp:w}=t,a=$.useCallback(r=>i(e,r),[e,i]),d=$.useCallback(r=>c(e,r),[e,c]),s=$.useCallback(r=>w(e,r),[e,w]);return v.jsx("g",{id:e,transform:"translate(".concat(u-6.4," ").concat(h-6.4,")scale(0.025)"),onPointerDown:a,onPointerMove:d,onPointerUp:s,style:{cursor:"move"},children:v.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},ke=t=>{const{id:e,path:u,handlePointerDown:h}=t,i=$.useCallback(c=>h(e,c),[e,h]);return v.jsx("path",{id:e,d:u,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:i})},Me=$.memo(t=>{var d,s,r,x,o,p,S,_,C,L,f,y;const{elements:e,handlePointerDown:u,handlePointerMove:h,handlePointerUp:i,handleEdgePointerDown:c}=t,w=Object.fromEntries(Array.from({length:21},(l,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const M=l.line.attr.type,T=l.line.attr.style,Y=l.line.attr[T],z=(d=Ct[T])==null?void 0:d.preComponent;z&&w[l.line.attr.zIndex].pre.push(v.jsx(z,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},"".concat(l.id,".pre")));const V=(r=(s=Ct[T])==null?void 0:s.component)!=null?r:ke;w[l.line.attr.zIndex].main.push(v.jsx(V,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},l.id));const X=(x=Ct[T])==null?void 0:x.postComponent;X&&w[l.line.attr.zIndex].post.push(v.jsx(X,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:c},"".concat(l.id,".post")))}else if(l.type==="station"){const M=l.station,T=M.type,Y=(o=yt[T])==null?void 0:o.preComponent;Y&&w[l.station.zIndex].pre.push(v.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},"".concat(l.id,".pre")));const z=(S=(p=yt[T])==null?void 0:p.component)!=null?S:Bt;w[l.station.zIndex].main.push(v.jsx(z,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},l.id));const V=(_=yt[T])==null?void 0:_.postComponent;V&&w[l.station.zIndex].post.push(v.jsx(V,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const M=l.miscNode,T=M.type,Y=(C=gt[T])==null?void 0:C.preComponent;Y&&w[l.miscNode.zIndex].pre.push(v.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M[T],handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},"".concat(l.id,".pre")));const z=(f=(L=gt[T])==null?void 0:L.component)!=null?f:Bt;w[l.miscNode.zIndex].main.push(v.jsx(z,{id:l.id,x:M.x,y:M.y,attrs:M[T],handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},l.id));const V=(y=gt[T])==null?void 0:y.postComponent;V&&w[l.miscNode.zIndex].post.push(v.jsx(V,{id:l.id,x:M.x,y:M.y,attrs:M[T],handlePointerDown:u,handlePointerMove:h,handlePointerUp:i},"".concat(l.id,".post")))}return Array.from({length:21},(l,M)=>(M-10).toString()).map(l=>[...w[l].pre,...w[l].main,...w[l].post]).flat()},(t,e)=>t.elements===e.elements),Ce=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:u}=Q(o=>o.param),h=o=>{const S=[{x:o.x,y:o.y},...o.originalNodesPos].sort((C,L)=>C.x===L.x?C.y-L.y:C.x-L.x),_=(S[1].y-S[0].y)/(S[1].x-S[0].x);if(Math.abs(_)<=.01)return{original:S,offset:S.map(C=>({x:C.x,y:C.y+10})),rotate:0};if(Math.abs(_)>=1e10)return{original:S,offset:S.map(C=>({x:C.x+10,y:C.y})),rotate:90};{const L=-1/_,f=10/Math.sqrt(L*L+1),y=10*L/Math.sqrt(L*L+1);return{original:S,offset:S.map(l=>({x:l.x+f,y:l.y+y})),rotate:-Math.atan(L)*(180/Math.PI)}}},{original:i,offset:c,rotate:w}=h(e),a=o=>{const p=Math.sqrt(3)/2*o,S="0,0",_="".concat(-o/2,",").concat(p),C="".concat(o/2,",").concat(p);return"".concat(S," ").concat(_," ").concat(C)},d=u/75,s=8*d,r="#FC8181",x="".concat(d*5," ").concat(d*2);return v.jsxs(v.Fragment,{children:[v.jsx("line",{x1:c[0].x,y1:c[0].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:x}),v.jsx("line",{x1:c[1].x,y1:c[1].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:x}),v.jsx("line",{x1:i[0].x,y1:i[0].y,x2:c[0].x,y2:c[0].y,stroke:r,strokeWidth:d,strokeDasharray:x}),v.jsx("line",{x1:i[1].x,y1:i[1].y,x2:c[1].x,y2:c[1].y,stroke:r,strokeWidth:d,strokeDasharray:x}),v.jsx("line",{x1:i[2].x,y1:i[2].y,x2:c[2].x,y2:c[2].y,stroke:r,strokeWidth:d,strokeDasharray:x}),v.jsx("polygon",{points:a(s),transform:"translate(".concat(c[0].x,",").concat(c[0].y,") rotate(").concat((w+270)%360,")"),fill:r}),v.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((w+270)%360,")"),fill:r}),v.jsx("polygon",{points:a(s),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((w+90)%360,")"),fill:r}),v.jsx("polygon",{points:a(s),transform:"translate(".concat(c[2].x,",").concat(c[2].y,") rotate(").concat((w+90)%360,")"),fill:r})]})},Le=[...Object.values(te),it.Virtual,it.Master,it.LondonArrow,it.ChongqingRTNumLineBadge2021,it.ChongqingRTTextLineBadge2021,it.ChengduRTLineBadge,it.GzmtrLineBadge],_e=()=>{const t=Ht(),e=$.useRef(window.graph),u=()=>{t(ft()),t(lt()),t(vt(e.current.export()))},{telemetry:{project:h},preference:{autoParallel:i,gridLines:c,snapLines:w}}=Q(k=>k.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=Q(k=>k.param),{selected:s,refresh:{nodes:r,edges:x},mode:o,active:p,keepLastPath:S,theme:_}=Q(k=>k.runtime),C=Rt(),{height:L,width:f}=Xt(C),[y,l]=$.useState(),[M,T]=$.useState({dx:0,dy:0}),[Y,z]=$.useState([]),[V,X]=$.useState([]),[nt,st]=$.useState([]);$.useEffect(()=>{if(!y||!w)return;const k=Et(d,a,f,L),j=Kt(e.current,...Object.values(k));X(j),z(ce(e.current,j))},[d,a,f,L,y]);const[dt,ot]=$.useState(void 0),bt=G((k,j)=>{j.stopPropagation(),o==="select"&&t(tt("free"));const O=j.currentTarget,{x:U,y:H}=et(j);O.setPointerCapture(j.pointerId),st([]),ot(void 0),l({x:U,y:H}),t(ht(k)),j.shiftKey?s.has(k)?t(jt(k)):t(Nt(k)):s.has(k)||t(ct(new Set([k])))}),At=G((k,j)=>{const{x:O,y:U}=et(j);if(o==="free"&&p===k){if(!j.altKey&&w){const H=e.current.getNodeAttribute(k,"x"),B=e.current.getNodeAttribute(k,"y"),W=H-(y.x-O)*a/100,n=B-(y.y-U)*a/100;let m=W,b=n;if(le(k,e.current)){let g=nt,P=dt;if(g.length!==0&&(g=g.filter(A=>de(A,W,n)<=6)),P&&(g.length===0||Math.hypot(W-P.x,n-P.y)>6)&&(P=void 0),!P&&g.length===1){const A=g[0],{snapPoint:D,distance:I}=ue(e.current,V.filter(K=>!s.has(K)),W,n,A);I<=3&&(P=D)}if(g.length===1&&!P||g.length===0){const{l:A,d:D}=he(W,n,Y,V.filter(K=>!s.has(K)&&!g.some(at=>at.node===K))),I=g.length===0||!g.some(K=>K.a===A.a&&K.b===A.b);D<3&&g.length<2&&I&&g.push(A)}if(g.length===1)if(P)m=P.x,b=P.y;else{const A=g[0];if(A.a==0)b=-A.c/A.b;else if(A.b==0)m=-A.c/A.a;else{const D=-A.a/A.b,I=-A.c/A.b;b=D*m+I}}else if(g.length===2){const A=g[0],D=g[1],I=A.a*D.b-D.a*A.b;I!==0&&(m=-(A.c*D.b-D.c*A.b)/I,b=-(A.a*D.c-D.a*A.c)/I)}st(g),ot(P)}const E=m-H,N=b-B;s.forEach(g=>{e.current.hasNode(g)&&e.current.updateNodeAttributes(g,P=>({...P,x:R(P.x+E,.01),y:R(P.y+N,.01)}))})}else st([]),ot(void 0),s.forEach(H=>{e.current.hasNode(H)&&e.current.updateNodeAttributes(H,B=>({...B,x:R(B.x-(y.x-O)*a/100,j.altKey?.01:5),y:R(B.y-(y.y-U)*a/100,j.altKey?.01:5)}))});t(ft()),t(lt())}else o.startsWith("line")&&T({dx:(y.x-O)*a/100,dy:(y.y-U)*a/100})}),wt=G((k,j)=>{if(o.startsWith("line")){S||t(tt("free"));const O=e.current.hasNode(p)&&Le.includes(e.current.getNodeAttribute(p,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(H=>{var m,b;const W=(b=(m=document.elementsFromPoint(j.clientX,j.clientY)[0].attributes)==null?void 0:m.getNamedItem("id"))==null?void 0:b.value,n=W==null?void 0:W.startsWith(H);if(O&&n){const E=o.slice(5),N="line_".concat(ut(10)),[g,P]=[p,W.slice(H.length)],A=i?Zt(e.current,E,g,P,"from"):-1;e.current.addDirectedEdgeWithKey(N,g,P,{visible:!0,zIndex:0,type:E,[E]:structuredClone(F[E].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:_},reconcileId:"",parallelIndex:A}),t(ct(new Set([N]))),h&&xt.event(mt.ADD_LINE,{type:E})}}),t(lt()),t(vt(e.current.export()))}else if(o==="free"&&p){const{x:O,y:U}=et(j);y.x-O===0&&y.y-U===0||t(vt(e.current.export()))}st([]),ot(void 0),l(void 0),t(ht(void 0))}),Pt=G((k,j)=>{if(j.stopPropagation(),j.shiftKey||t(St()),j.shiftKey&&s.has(k)?t(jt(k)):t(Nt(k)),o.startsWith("station")||o.startsWith("misc-node-virtual")||o.startsWith("misc-node-master")){const O=j.clientX-document.getElementById("canvas").getBoundingClientRect().left,U=j.clientY-document.getElementById("canvas").getBoundingClientRect().top,H=o.startsWith("station"),B=ut(10),W=H?"stn_".concat(B):"misc_node_".concat(B),n=H?o.slice(8):o.slice(10),{x:m,y:b}=J(O,U,a,d),E=H?structuredClone(yt[n].defaultAttrs):structuredClone(gt[n].defaultAttrs);"color"in E&&(E.color=_),e.current.addNode(W,{visible:!0,zIndex:0,x:R(m,5),y:R(b,5),type:n,[n]:E});const N=e.current.getEdgeAttributes(k),{zIndex:g,type:P,style:A}=N,D=N[P],I=N[A],[K,at]=e.current.extremities(k),q=i?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(ut(10)),K,W,{visible:!0,zIndex:g,type:P,[P]:structuredClone(D),style:A,[A]:structuredClone(I),reconcileId:"",parallelIndex:q}),e.current.addDirectedEdgeWithKey("line_".concat(ut(10)),W,at,{visible:!0,zIndex:g,type:P,[P]:structuredClone(D),style:A,[A]:structuredClone(I),reconcileId:"",parallelIndex:q}),e.current.dropEdge(k),u(),h&&(xt.event(mt.ADD_STATION,{type:n}),xt.event(mt.ADD_LINE,{type:P})),t(tt("free")),t(ct(new Set([W])))}}),kt=$.useMemo(()=>[...Pe(e.current),...we(e.current)],[x,r]),Mt=Qt.component;return v.jsxs(v.Fragment,{children:[v.jsx(Me,{elements:kt,handlePointerDown:bt,handlePointerMove:At,handlePointerUp:wt,handleEdgePointerDown:Pt}),o.startsWith("line")&&p&&p!=="background"&&v.jsx(Mt,{id:"line_create_in_progress___no_use",type:o.slice(5),path:F[o.slice(5)].generatePath(e.current.getNodeAttribute(p,"x"),e.current.getNodeAttribute(p,"x")-M.dx,e.current.getNodeAttribute(p,"y"),e.current.getNodeAttribute(p,"y")-M.dy,F[o.slice(5)].defaultAttrs),styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),nt.length!==0&&nt.map(k=>v.jsx("path",{d:F[Z.Simple].generatePath(...Jt(k,Et(d,a,f,L)),F[Z.Simple].defaultAttrs),stroke:"cyan",strokeWidth:a/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),dt&&v.jsx(Ce,{activeSnapPoint:dt})]})},Te=()=>{const t=Ht(),e=$.useRef(window.graph),u=()=>{t(ft()),t(lt()),t(vt(e.current.export()))},{activeSubscriptions:h}=Q(n=>n.account),{telemetry:{project:i},preference:{randomStationsNames:c,gridLines:w}}=Q(n=>n.app),{svgViewBoxZoom:a,svgViewBoxMin:d}=Q(n=>n.param),{mode:s,lastTool:r,active:x,selected:o,keepLastPath:p,theme:S,refresh:{nodes:_},count:{masters:C,lines:L}}=Q(n=>n.runtime),f=Rt(),{height:y,width:l}=Xt(f),M=!h.RMP_CLOUD&&C+1>ee,T=!h.RMP_CLOUD&&L+1>ne,Y=!h.RMP_CLOUD||c==="none";se();const[z,V]=$.useState({x:0,y:0}),[X,nt]=$.useState({x:0,y:0}),[st,dt]=$.useState({x:0,y:0}),[ot,bt]=$.useState({x:0,y:0}),At=G(async n=>{const{x:m,y:b}=et(n);if(s.startsWith("station")||s.startsWith("misc-node")){t(tt("free"));const E=ut(10),{x:N,y:g}=J(m,b,a,d),P=s.startsWith("station"),A=P?"stn_".concat(E):"misc_node_".concat(E),D=P?s.slice(8):s.slice(10),I=structuredClone({...yt,...gt}[D].defaultAttrs);if(re.has(D)&&(I.color=S),P&&!Y){const K=I.names,at=await t(Tt(_t.Shmetro));if(Tt.fulfilled.match(at)){const q=at.payload;K.length>q.length?q.push(...Array(K.length-q.length).fill(q.at(-1))):K.length<q.length&&q.splice(K.length,q.length-K.length),I.names=q}}e.current.addNode(A,{visible:!0,zIndex:0,x:R(N,5),y:R(g,5),type:D,[D]:I}),u(),i&&xt.event(mt.ADD_STATION,{type:D}),t(ct(new Set([A])))}else s==="free"||s.startsWith("line")?(s.startsWith("line")&&(t(tt("free")),p&&t(ae(!1))),dt({x:m,y:b}),bt(d),n.shiftKey||(t(ht("background")),t(St()))):s==="select"&&(V(J(m,b,a,d)),nt(J(m,b,a,d)))}),wt=G(n=>{if(s==="select"){if(z.x!=0&&z.y!=0){const{x:m,y:b}=et(n);nt(J(m,b,a,d))}}else if(x==="background"){const{x:m,y:b}=et(n);t(pt({x:ot.x+(st.x-m)*a/100,y:ot.y+(st.y-b)*a/100}))}}),Pt=G(n=>{if(s==="select"){const{x:m,y:b}=et(n),{x:E,y:N}=J(m,b,a,d),g=Kt(e.current,z.x,z.y,E,N),P=ye(e.current,new Set(g));t(ct(new Set([...n.shiftKey?o:[],...g,...P]))),t(tt("free")),V({x:0,y:0}),nt({x:0,y:0})}x==="background"&&!n.shiftKey&&t(ht(void 0))}),kt=G(n=>{let m=a;n.deltaY>0&&a+10<400?m=a+10:n.deltaY<0&&a-10>0&&(m=a-10),t(Dt(m));const{x:b,y:E}=et(n),N=n.currentTarget.getBoundingClientRect(),[g,P]=[b/N.width,E/N.height];t(pt({x:d.x+b*a/100-l*m/100*g,y:d.y+E*a/100-y*m/100*P}))}),Mt=G(async n=>{if(rt?n.key==="Backspace":n.key==="Delete")o.size>0&&(o.forEach(m=>{e.current.hasNode(m)?e.current.dropNode(m):e.current.hasEdge(m)&&e.current.dropEdge(m)}),t(St()),u());else if(n.key.startsWith("Arrow")){const b=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,E=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(J(100*b,100*E,a,d)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const b=(n.key==="j"?-1:n.key==="l"?1:0)*10,E=(n.key==="i"?-1:n.key==="k"?1:0)*10;o.size>0&&o.forEach(N=>{e.current.hasNode(N)&&(e.current.updateNodeAttribute(N,"x",g=>(g!=null?g:0)+b),e.current.updateNodeAttribute(N,"y",g=>(g!=null?g:0)+E),u())})}else if(n.key==="f"&&r)t(tt(r));else if(n.key==="z"&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey))rt&&n.preventDefault(),t(oe()),t(ft()),t(lt());else if(n.key==="s")t(tt("select"));else if((n.key==="c"||n.key==="x")&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const m=ge(e.current,o);navigator.clipboard.writeText(m),n.key==="x"&&(t(St()),o.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),u())}else if(n.key==="v"&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const m=await navigator.clipboard.readText(),{x:b,y:E}=J(l/2,y/2,a,d),{nodes:N,edges:g}=pe(m,e.current,M,T,R(b,5),R(E,5));u();const P=structuredClone(N);g.forEach(A=>P.add(A)),t(ct(P))}else(rt&&n.key==="z"&&n.metaKey&&n.shiftKey||!rt&&n.key==="y"&&n.ctrlKey)&&(t(ie()),t(ft()),t(lt()))}),[k,j]=$.useState(0),O=G(n=>{if(n.touches.length===2){t(ht(void 0));const[m,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];j(m*m+b*b)}}),U=G(n=>{if(k!==0&&n.touches.length===2){const[m,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],E=m*m+b*b;let N=a;E-k<0&&a+10<=390?N=a+10:E-k>0&&a-10>=10&&(N=a-10),t(Dt(N)),j(E);const g=n.currentTarget.getBoundingClientRect(),[P,A]=[(n.touches[0].clientX+n.touches[1].clientX)/2-g.left,(n.touches[0].clientY+n.touches[1].clientY)/2-g.top],[D,I]=[P/g.width,A/g.height];t(pt({x:d.x+P*a/100-l*N/100*D,y:d.y+A*a/100-y*N/100*I}))}}),H=G(n=>{k!==0&&j(0)}),[B,W]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{W({sx:z.x<=X.x?z.x:X.x,ex:z.x>X.x?z.x:X.x,sy:z.y<=X.y?z.y:X.y,ey:z.y>X.y?z.y:X.y})},[X.x,X.y]),v.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:y,width:l,viewBox:"".concat(d.x," ").concat(d.y," ").concat(l*a/100," ").concat(y*a/100),onPointerDown:At,onPointerMove:wt,onPointerUp:Pt,onTouchStart:O,onTouchMove:U,onTouchEnd:H,onWheel:kt,tabIndex:0,onKeyDown:Mt,children:[w&&v.jsx(ve,{svgViewBoxMin:d,svgViewBoxZoom:a,svgWidth:l,svgHeight:y}),v.jsx(fe.SvgAssetsContextProvider,{children:v.jsx(_e,{})}),s==="select"&&z.x!=0&&z.y!=0&&v.jsx("rect",{x:B.sx,y:B.sy,width:B.ex-B.sx,height:B.ey-B.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),v.jsx("defs",{children:v.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[v.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),v.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Te as default};

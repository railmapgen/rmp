!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach(function(e){n(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-DJB5Se8L.js","./index-legacy-BYyL8iko.js","./master-manager-legacy-DlWmFOBW.js","./react-legacy-BN3K1j7S.js","./clipboard-legacy-Da1cEAGF.js","./misc-nodes-legacy-BqmxbYL3.js"],function(e,n){"use strict";var r,o,s,i,a,l,c,d,u,h,y,x,p,g,f,m,b,v,w,j,N,k,A,M,P,$,D,E,C,S,z,_,I,O,W,T,B,L,R,H,K,X,V,Y,F,U,q,Z,Q,J,G,ee,te,ne,re,oe,se,ie,ae,le,ce,de,ue,he,ye,xe,pe,ge,fe,me,be,ve,we,je,Ne,ke,Ae,Me,Pe,$e,De,Ee;return{setters:[e=>{r=e.a,o=e.j,s=e.P,i=e.B,a=e.D,l=e.ad,c=e.a2},e=>{d=e.c,u=e.e,h=e.a7,y=e.z,x=e.ay,p=e.az,g=e.aA,f=e.a4,m=e.w,b=e.x,v=e.y,w=e.F,j=e.Y,N=e.aB,k=e.X,A=e.aC,M=e.p,P=e.aD,$=e.aE,D=e.L,E=e.aF,C=e.aG,S=e.aH,z=e.n,_=e.aI,I=e.d,O=e.r,W=e.E,T=e.q,B=e.aJ,L=e.aK,R=e.aL,H=e.aM,K=e.aN,X=e.t,V=e.v,Y=e.aO,F=e.aP,U=e.aQ,q=e.o,Z=e.aR,Q=e.S,J=e.aS,G=e.aT,ee=e.aU,te=e.aV,ne=e.aW,re=e.aX,oe=e.aY,se=e.aZ,ie=e.G,ae=e.H,le=e.a_,ce=e.a$,de=e.b0,ue=e.b1,he=e.b2,ye=e.ag,xe=e.av,pe=e.aw,ge=e.a9,fe=e.a5},e=>{me=e.s,be=e.f,ve=e.c,we=e.e},e=>{je=e.b,Ne=e.k,ke=e.u,Ae=e.r},e=>{Me=e.u,Pe=e.e,$e=e.i},e=>{De=e.v,Ee=e.m}],execute:function(){const n={[h.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[h.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},Ce=Ne("runtime/getStationNames",async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:o}=t().account;if(!o)return void n(x({cityName:e,names:[]}));const s=await fetch(`${p}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o}`}});if(!s.ok)return y.warn("Failed to fetch random station names",s.statusText),r(s.statusText);const i=await s.json();n(x({cityName:e,names:i}))}),Se=Ne("runtime/getOneStationName",async(e,{getState:t,dispatch:r})=>{var o;const{stationNames:s}=t().runtime,i=s[e];if(0==(null!==(o=null==i?void 0:i.length)&&void 0!==o?o:0))return y.debug("No random station names in cache, using fallback"),r(Ce({cityName:e})),Object.values((e=>{const t=n[e];return t.at(Math.floor(Math.random()*t.length))})(e));const a=structuredClone(i),l=a.shift();return r(x({cityName:e,names:a})),a.length<3&&r(Ce({cityName:e})),Object.values(l)}),ze=()=>{const e=d(),{activeSubscriptions:t}=u(e=>e.account),{preference:{randomStationsNames:n}}=u(e=>e.app),r=!t.RMP_CLOUD||"none"===n;return je.useCallback(async t=>{const n=me[t].defaultAttrs.names;if(!r){const t=await e(Se(h.Shmetro));if(Se.fulfilled.match(t)){const e=t.payload;return n.length>e.length?e.push(...Array(n.length-e.length).fill(e.at(-1))):n.length<e.length&&e.splice(n.length),e}}return structuredClone(n)},[e,r])},_e=({isOpen:e,position:t,onClose:n})=>{const{t:l}=ke(),c=d(),h=je.useRef(window.graph),{selected:y,count:{masters:x,lines:p}}=u(e=>e.runtime),{svgViewBoxZoom:A,svgViewBoxMin:M}=u(e=>e.param),{activeSubscriptions:P}=u(e=>e.account),$=!P.RMP_CLOUD&&x+1>g,D=!P.RMP_CLOUD&&p+1>f,E=y.size>0,C=je.useRef(null);r({ref:C,handler:n,enabled:e});const S=je.useCallback(()=>{c(m(h.current.export())),c(b()),c(v())},[c]),z=Me(()=>{if(y.size>0){const e=Pe(h.current,y);navigator.clipboard.writeText(e)}}),_=Me(()=>{if(y.size>0){const e=Pe(h.current,y);navigator.clipboard.writeText(e),c(w()),y.forEach(e=>{h.current.hasNode(e)?h.current.dropNode(e):h.current.hasEdge(e)&&h.current.dropEdge(e)}),S()}}),I=Me(async()=>{try{const e=await navigator.clipboard.readText(),{x:n,y:r}=j(t.x,t.y,A,M),{nodes:o,edges:s}=$e(e,h.current,$,D,N(n,5),N(r,5));S();const i=structuredClone(o);s.forEach(e=>i.add(e)),c(k(i))}catch(e){console.warn("Failed to read clipboard:",e)}}),O=Me(()=>{y.size>0&&(c(w()),y.forEach(e=>{h.current.hasNode(e)?h.current.dropNode(e):h.current.hasEdge(e)&&h.current.dropEdge(e)}),S())}),W=Me(()=>{c(b()),c(v())}),T=Me(e=>{if(y.size>0){const t=Math.min(Math.max(e,-10),10);y.forEach(e=>{h.current.hasNode(e)&&h.current.setNodeAttribute(e,"zIndex",t),h.current.hasEdge(e)&&h.current.setEdgeAttribute(e,"zIndex",t)}),S()}}),B=Me(()=>{if(y.size>0){const[e]=y,t=h.current.hasNode(e)?h.current.getNodeAttribute(e,"zIndex"):h.current.hasEdge(e)?h.current.getEdgeAttribute(e,"zIndex"):0;T(t+1)}}),L=Me(()=>{if(y.size>0){const[e]=y,t=h.current.hasNode(e)?h.current.getNodeAttribute(e,"zIndex"):h.current.hasEdge(e)?h.current.getEdgeAttribute(e,"zIndex"):0;T(t-1)}});return e?o.jsx(s,{children:o.jsxs(i,{ref:C,position:"fixed",left:t.x,top:t.y,zIndex:1e3,bg:"white",border:"1px solid",borderColor:"gray.200",borderRadius:"md",boxShadow:"lg",py:1,minW:"150px",_dark:{bg:"gray.700",borderColor:"gray.600"},children:[o.jsx(Ie,{onClick:()=>{W(),n()},children:l("contextMenu.refresh")}),o.jsx(a,{}),o.jsx(Ie,{onClick:()=>{z(),n()},isDisabled:!E,children:l("contextMenu.copy")}),o.jsx(Ie,{onClick:()=>{_(),n()},isDisabled:!E,children:l("contextMenu.cut")}),o.jsx(Ie,{onClick:()=>{I(),n()},children:l("contextMenu.paste")}),o.jsx(Ie,{onClick:()=>{O(),n()},isDisabled:!E,children:l("contextMenu.delete")}),o.jsx(a,{}),o.jsx(Ie,{onClick:()=>{T(10),n()},isDisabled:!E,children:l("contextMenu.placeTop")}),o.jsx(Ie,{onClick:()=>{T(-10),n()},isDisabled:!E,children:l("contextMenu.placeBottom")}),o.jsx(Ie,{onClick:()=>{T(0),n()},isDisabled:!E,children:l("contextMenu.placeDefault")}),o.jsx(Ie,{onClick:()=>{B(),n()},isDisabled:!E,children:l("contextMenu.placeUp")}),o.jsx(Ie,{onClick:()=>{L(),n()},isDisabled:!E,children:l("contextMenu.placeDown")})]})}):null},Ie=({children:e,onClick:t,isDisabled:n=!1})=>o.jsx(i,{px:3,py:2,cursor:n?"not-allowed":"pointer",opacity:n?.5:1,_hover:n?{}:{bg:"gray.100",_dark:{bg:"gray.600"}},onClick:n?void 0:t,fontSize:"sm",children:e}),Oe=je.memo(e=>{const{svgViewBoxMin:t,svgViewBoxZoom:n,svgWidth:r,svgHeight:s}=e,{preference:{toolsPanel:{expand:i}}}=u(e=>e.app),a="light"===l().colorMode?"#666464":"#D3D3D4",c=A(t,n,r,s),d=i?410*n/100:0,h=n>30?n>120?50:25:5,y=n/200,x={startX:N(c.xMin+d-h,h),endX:N(c.xMax+d+h,h),startY:N(c.yMin-h,h),endY:N(c.yMax+h,h)},p=Array.from({length:(x.endX-x.startX)/h+1},(e,t)=>{const n=x.startX+t*h,r=n%(5*h)==0?2*y:y;return o.jsx("line",{x1:n,y1:x.startY,x2:n,y2:x.endY,strokeWidth:r,stroke:a,opacity:"0.5"},`grid_vl_${n}`)}),g=Array.from({length:(x.endY-x.startY)/h+1},(e,t)=>{const n=x.startY+t*h,r=n%(5*h)==0?2*y:y;return o.jsx("line",{x1:x.startX,y1:n,x2:x.endX,y2:n,strokeWidth:r,stroke:a,opacity:"0.5"},`grid_hl_${n}`)}),f=Array.from({length:(x.endX-x.startX)/h/5+1},(e,t)=>{const r=N(x.startX,5*h)+5*t*h;return o.jsx("text",{x:r,y:c.yMin+n/5,fontSize:25*y,fill:a,textAnchor:"middle",opacity:"0.5",children:r},`grid_vc_${r}`)}),m=Array.from({length:(x.endY-x.startY)/h/5+1},(e,t)=>{const r=N(x.startY,5*h)+5*t*h;return o.jsx("text",{x:c.xMin+n/8+d,y:r,fontSize:25*y,fill:a,textAnchor:"start",opacity:"0.5",children:r},`grid_hc_${r}`)});return o.jsxs("g",{id:"grid-lines",className:"removeMe",children:[p,g,f,m]})},(e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight),We=De.component,Te=P.generatePath,Be=$.component,Le=()=>{var e;const n=d(),{telemetry:{project:r},preference:{autoParallel:s}}=u(e=>e.app),{selected:i,theme:a,count:{mostFrequentStationType:l}}=u(e=>e.runtime),c=ze(),h=i.keys().next().value;if(!h.startsWith("stn")&&!h.startsWith("misc_node"))return;if(!window.graph.hasNode(h))return;const y=window.graph.neighbors(h);if(0===y.length)return;const x=window.graph.getNodeAttributes(h),p=y.reduce((e,t)=>{const n=window.graph.getNodeAttributes(t);return{x:e.x+n.x,y:e.y+n.y}},{x:0,y:0}),g=p.x/y.length,f=p.y/y.length,w={x:x.x-g,y:x.y-f},j=x.x+w.x,N=x.y+w.y,A=Math.sign(w.x)===Math.sign(w.y),$={x:j-10,y:N+10*(A?1:-1)},L={x:j+10,y:N+10*(A?-1:1)},R=h.startsWith("stn_")?window.graph.getNodeAttribute(h,"type"):l,H=me[R].component,K={visible:!0,zIndex:0,x:L.x,y:L.y,type:R,[R]:me[R].defaultAttrs},X=window.graph.reduceEdges(h,(e,t)=>{const n=window.graph.getEdgeAttributes(t),{style:r}=n;if(r===M.SingleColor){const t=JSON.stringify(n[r].color);t in e?e[t]+=1:e[t]=1}return e},{}),V=null!==(e=Object.entries(X).filter(([e,t])=>t%2!=0).reduce((e,[t,n])=>n>e.count?{color:JSON.parse(t),count:n}:e,{color:null,count:0}).color)&&void 0!==e?e:a,Y=w.x>0?!(w.x>Math.abs(w.y)):-w.x>Math.abs(w.y),F=Y?"from":"to",U=Te(x.x,$.x,x.y,$.y,t(t({},P.defaultAttrs),{},{startFrom:F})),q=Y?"to":"from",Z=Te(x.x,L.x,x.y,L.y,t(t({},P.defaultAttrs),{},{startFrom:q})),Q=async(e,o)=>{o.stopPropagation();const{x:i,y:l}=C(o);n(S({x:i,y:l}));const d=z(10),u=_.has(e),y=u?`stn_${d}`:`misc_node_${d}`,x=structuredClone(t(t({},me),Ee)[e].defaultAttrs);I.has(e)&&(x.color=a),u&&(x.names=await c(e)),window.graph.addNode(y,{visible:!0,zIndex:0,x:u?L.x:$.x,y:u?L.y:$.y,type:e,[e]:x}),r&&O.event(W.ADD_STATION,{type:e});const p=D.Diagonal,g=`line_${z(10)}`,[f,w]=[h,y],j=s?0:-1,N=u?q:F;window.graph.addDirectedEdgeWithKey(g,f,w,{visible:!0,zIndex:0,type:p,[p]:t(t({},structuredClone(T[p].defaultAttrs)),{},{startFrom:N}),style:M.SingleColor,[M.SingleColor]:{color:V},reconcileId:"",parallelIndex:j}),r&&O.event(W.ADD_LINE,{type:p}),n(m(window.graph.export())),n(b()),n(v()),n(B(y)),n(k(new Set([y])))};return o.jsxs("g",{id:"prediction",opacity:"0.5",className:"removeMe",children:[o.jsx(Be,{id:"line_prediction_1",type:D.Diagonal,path:U,styleAttrs:{color:V},newLine:!0,handlePointerDown:()=>{}}),o.jsx(Be,{id:"line_prediction_2",type:D.Diagonal,path:Z,styleAttrs:{color:V},newLine:!0,handlePointerDown:()=>{}}),o.jsx(We,{id:"misc_node_virtual_prediction_1",attrs:{},x:$.x,y:$.y,handlePointerDown:(e,t)=>{Q(E.Virtual,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}}),o.jsx(H,{id:"stn_virtual_prediction_2",attrs:K,x:L.x,y:L.y,handlePointerDown:(e,t)=>{Q(l,t)},handlePointerMove:()=>{},handlePointerUp:()=>{}})]})},Re=(e,t)=>e.startsWith("stn")||e.startsWith("misc_node")&&t.getNodeAttribute(e,"type")===E.Virtual||e.startsWith("misc_node")&&t.getNodeAttribute(e,"type")===E.Master&&"Station"===t.getNodeAttributes(e)[E.Master].nodeType,He=(e,t,n)=>Math.abs(e.a*t+e.b*n+e.c)/Math.sqrt(e.a**2+e.b**2),Ke=(e,t,n,r,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s))return;if(Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return Ve(e,t,n,r,o)?{x1:t,y1:n,x2:r,y2:o,offset:s.offsetFrom}:void 0;const[i,a]=[s.offsetFrom,s.offsetTo];for(let l=0;l<Math.PI;l+=Math.PI/8)for(let s=l,c=0;c<2;c++,s+=Math.PI){const[c,d,u,h]=[Math.sin(l)*i,Math.cos(l)*i,Math.sin(s)*a,Math.cos(s)*a];if(Ve(e,t+c,n+d,r+u,o+h))return{x1:t+c,y1:n+d,x2:r+u,y2:o+h,offset:0}}},Xe=(e,t,n,r,o,s)=>e===n?{x1:e+5*s,y1:t,x2:n+5*s,y2:r,offset:o}:t===r?{x1:e,y1:t+5*s,x2:n,y2:r+5*s,offset:o}:{x1:e+5*Math.SQRT1_2*s,y1:t+5*Math.SQRT1_2*s,x2:n+5*Math.SQRT1_2*s,y2:r+5*Math.SQRT1_2*s,offset:o},Ve=(e,t,n,r,o)=>!(t!==r&&n!==o||![D.Diagonal,D.Perpendicular].includes(e))||!(1!==Math.abs((o-n)/(r-t))||![D.Diagonal,D.RotatePerpendicular].includes(e)),Ye=(e,t)=>{if(!t.every(t=>e.hasEdge(t)))return;const n=t.map(t=>{var n,r,o;const[s,i]=e.extremities(t),a=e.getNodeAttributes(s),l=e.getNodeAttributes(i),{type:c}=e.getEdgeAttributes(t),d=null!==(n=e.getEdgeAttribute(t,c))&&void 0!==n?n:T[c].defaultAttrs,u=Ke(c,a.x,a.y,l.x,l.y,d);if(u){const{x1:e,y1:t,x2:n,y2:r,offset:o}=u;return T[D.Simple].generatePath(e,n,t,r,{offset:o})}return null!==(r=null===(o=T[c])||void 0===o?void 0:o.generatePath(a.x,l.x,a.y,l.y,d))&&void 0!==r?r:`M ${a.x} ${a.y} L ${l.x} ${l.y}`});let r=`${n[0]} `;for(let o=1;o<t.length;o+=1)r+=n[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},Fe=e=>[...e.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Ue=e=>{const t={},n={},r=[],o={},s=[];for(const c of e.edgeEntries()){const[e,t,r,o]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y],s=c.attributes[c.attributes.type],i=Ke(c.attributes.type,e,t,r,o,s);n[c.edge]=i}for(const c of e.edgeEntries()){let i=n[c.edge];const{parallelIndex:a}=c.attributes;if(a>=0){const t=n[L(e,c.attributes.type,c.edge)];if(!t){r.push(c);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:o,offset:s}=t;i=Xe(e,n,r,o,s,a)}}if(""!==c.attributes.reconcileId){const e=c.attributes.reconcileId;e in o?o[e].push(c):o[e]=[c];continue}if(i){const e=c.edge,n=c.attributes,{x1:r,y1:o,x2:s,y2:a,offset:l}=i;t[e]={attr:n,path:T[D.Simple].generatePath(r,s,o,a,{offset:l})};continue}s.push(c)}const i=new Set;for(;r.length;){const n=r.pop();if(i.has(n.edge))continue;const{parallel:o}=R(e,n);if(!o.length)continue;o.forEach(e=>i.add(e.edge));const s=H(o);for(const e of o){const n=e.edge;t[n]={attr:e.attributes,path:s[n]}}}const{allReconciledLines:a,danglingLines:l}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach(t=>{if(1===t.length)return void r.push(...t.map(e=>e.edge));const o=e.getEdgeAttribute(t.at(0),"type");if(!t.every(t=>e.getEdgeAttribute(t,"type")===o))return void r.push(...t.map(e=>e.edge));const s=e.getEdgeAttribute(t.at(0),"style");if(!t.every(t=>e.getEdgeAttribute(t,"style")===s))return void r.push(...t.map(e=>e.edge));const i={},a=new Set,l=new Set,c=Object.fromEntries(t.map(t=>{var n,r;const[o,s]=e.extremities(t);return i[o]=(null!==(n=i[o])&&void 0!==n?n:0)+1,i[s]=(null!==(r=i[s])&&void 0!==r?r:0)+1,a.add(o),l.add(s),[o,[t.edge,s]]})),d=Array.from(a).filter(e=>1===i[e]),u=Array.from(l).filter(e=>1===i[e]);if(1!==d.length||1!==u.length)return void r.push(...t.map(e=>e.edge));const h=d[0],y=u[0];if(h===y)return void r.push(...t.map(e=>e.edge));const x=[c[h][0]];let p=c[h][1];for(let e=1;e<t.length;e+=1){var g;const e=null===(g=c[p])||void 0===g?void 0:g.at(1);if(!e)return void r.push(...t.map(e=>e.edge));x.push(c[p][0]),p=e}p===y&&x.length===t.length?n.push(x):r.push(...t.map(e=>e.edge))}),{allReconciledLines:n,danglingLines:r}})(e,o);for(const c of a){const n=Ye(e,c);if(!n)continue;const r=c[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const c of l){const n=e.getEdgeAttributes(c),[r,o]=e.extremities(c),s=e.getNodeAttributes(r),i=e.getNodeAttributes(o);t[c]={attr:n,path:T[D.Simple].generatePath(s.x,i.x,s.y,i.y,T[D.Simple].defaultAttrs)}}for(const c of s){const e=c.edge,n=c.attributes.type,r=c.attributes,[o,s,i,a]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y];n in T?t[e]={attr:r,path:T[n].generatePath(o,i,s,a,r[n])}:t[e]={attr:r,path:`M ${o} ${s} L ${i} ${a}`}}return Object.entries(t).map(([e,t])=>({id:e,type:"line",line:t}))},qe=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=u(e=>e.param),{original:r,offset:s,rotate:i}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map(e=>({x:e.x,y:e.y+10})),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map(e=>({x:e.x+10,y:e.y})),rotate:90};{const e=10,r=-1/n,o=e/Math.sqrt(r*r+1),s=e*r/Math.sqrt(r*r+1);return{original:t,offset:t.map(e=>({x:e.x+o,y:e.y+s})),rotate:-Math.atan(r)*(180/Math.PI)}}})(t),a=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${`${-e/2},${t}`} ${`${e/2},${t}`}`},l=n/75,c=8*l,d="#FC8181",h=`${5*l} ${2*l}`;return o.jsxs(o.Fragment,{children:[o.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:d,strokeWidth:l,strokeDasharray:h}),o.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:d,strokeWidth:l,strokeDasharray:h}),o.jsx("line",{x1:r[0].x,y1:r[0].y,x2:s[0].x,y2:s[0].y,stroke:d,strokeWidth:l,strokeDasharray:h}),o.jsx("line",{x1:r[1].x,y1:r[1].y,x2:s[1].x,y2:s[1].y,stroke:d,strokeWidth:l,strokeDasharray:h}),o.jsx("line",{x1:r[2].x,y1:r[2].y,x2:s[2].x,y2:s[2].y,stroke:d,strokeWidth:l,strokeDasharray:h}),o.jsx("polygon",{points:a(c),transform:`translate(${s[0].x},${s[0].y}) rotate(${(i+270)%360})`,fill:d}),o.jsx("polygon",{points:a(c),transform:`translate(${s[1].x},${s[1].y}) rotate(${(i+270)%360})`,fill:d}),o.jsx("polygon",{points:a(c),transform:`translate(${s[1].x},${s[1].y}) rotate(${(i+90)%360})`,fill:d}),o.jsx("polygon",{points:a(c),transform:`translate(${s[2].x},${s[2].y}) rotate(${(i+90)%360})`,fill:d})]})},Ze=e=>{const{id:t,x:n,y:r,handlePointerDown:s,handlePointerMove:i,handlePointerUp:a}=e,l=je.useCallback(e=>s(t,e),[t,s]),c=je.useCallback(e=>i(t,e),[t,i]),d=je.useCallback(e=>a(t,e),[t,a]);return o.jsx("g",{id:t,transform:`translate(${n-6.4} ${r-6.4})scale(0.025)`,onPointerDown:l,onPointerMove:c,onPointerUp:d,style:{cursor:"move"},children:o.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Qe=e=>{const{id:t,path:n,handlePointerDown:r}=e,s=je.useCallback(e=>r(t,e),[t,r]);return o.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},Je=je.memo(e=>{const{elements:t,handlePointerDown:n,handlePointerMove:r,handlePointerUp:s,handleEdgePointerDown:i}=e,a=Object.fromEntries(Array.from({length:21},(e,t)=>[t-10,{pre:[],main:[],post:[]}]));for(const v of t)if("line"===v.type){var l,c,d,u;const e=v.line.attr.type,t=v.line.attr.style,n=v.line.attr[t],r=null===(l=K[t])||void 0===l?void 0:l.preComponent;r&&a[v.line.attr.zIndex].pre.push(o.jsx(r,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${v.id}.pre`));const s=null!==(c=null===(d=K[t])||void 0===d?void 0:d.component)&&void 0!==c?c:Qe;a[v.line.attr.zIndex].main.push(o.jsx(s,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},v.id));const h=null===(u=K[t])||void 0===u?void 0:u.postComponent;h&&a[v.line.attr.zIndex].post.push(o.jsx(h,{id:v.id,type:e,path:v.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${v.id}.post`))}else if("station"===v.type){var h,y,x,p;const e=v.station,t=e.type,i=null===(h=me[t])||void 0===h?void 0:h.preComponent;i&&a[v.station.zIndex].pre.push(o.jsx(i,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},`${v.id}.pre`));const l=null!==(y=null===(x=me[t])||void 0===x?void 0:x.component)&&void 0!==y?y:Ze;a[v.station.zIndex].main.push(o.jsx(l,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},v.id));const c=null===(p=me[t])||void 0===p?void 0:p.postComponent;c&&a[v.station.zIndex].post.push(o.jsx(c,{id:v.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},`${v.id}.post`))}else if("misc-node"===v.type){var g,f,m,b;const e=v.miscNode,t=e.type,i=null===(g=Ee[t])||void 0===g?void 0:g.preComponent;i&&a[v.miscNode.zIndex].pre.push(o.jsx(i,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},`${v.id}.pre`));const l=null!==(f=null===(m=Ee[t])||void 0===m?void 0:m.component)&&void 0!==f?f:Ze;a[v.miscNode.zIndex].main.push(o.jsx(l,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},v.id));const c=null===(b=Ee[t])||void 0===b?void 0:b.postComponent;c&&a[v.miscNode.zIndex].post.push(o.jsx(c,{id:v.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:s},`${v.id}.post`))}return Array.from({length:21},(e,t)=>(t-10).toString()).map(e=>[...a[e].pre,...a[e].main,...a[e].post]).flat()},(e,t)=>e.elements===t.elements),Ge=[...Object.values(Q),E.Virtual,E.Master,E.Fill,E.LondonArrow,E.ChongqingRTNumLineBadge2021,E.ChongqingRTTextLineBadge2021,E.ChengduRTLineBadge,E.GzmtrLineBadge],et=()=>{const e=d(),n=je.useRef(window.graph),{telemetry:{project:r},preference:{autoParallel:s,gridLines:i,snapLines:a}}=u(e=>e.app),{svgViewBoxZoom:l,svgViewBoxMin:c}=u(e=>e.param),{selected:h,pointerPosition:y,active:x,refresh:{nodes:p,edges:g},mode:f,keepLastPath:P,theme:E}=u(e=>e.runtime),_=X(),{height:I,width:L}=V(_),[R,H]=je.useState({dx:0,dy:0}),[K,Q]=je.useState([]),[J,G]=je.useState([]),[ee,te]=je.useState([]);je.useEffect(()=>{if(!y||!a)return;const e=A(c,l,L,I),t=be(n.current,...Object.values(e));G(t),Q(((e,t)=>{const n=[];return t.filter(t=>Re(t,e)).forEach(t=>{const r=e.getNodeAttribute(t,"x"),o=e.getNodeAttribute(t,"y");n.push({a:1,b:0,c:-r,node:t,x:r,y:o}),n.push({a:0,b:1,c:-o,node:t,x:r,y:o}),n.push({a:1,b:-1,c:-r+o,node:t,x:r,y:o}),n.push({a:1,b:1,c:-r-o,node:t,x:r,y:o})}),n})(n.current,t))},[c,l,L,I,y]);const[ne,re]=je.useState(void 0),oe=Me((t,n)=>{n.stopPropagation(),n.currentTarget.setPointerCapture(n.pointerId);const{x:r,y:o}=C(n);"select"===f&&e(Y("free")),te([]),re(void 0),e(S({x:r,y:o})),e(B(t)),n.shiftKey?h.has(t)?e(F(t)):e(U(t)):h.has(t)||e(k(new Set([t])))}),se=Me((r,o)=>{const{x:s,y:i}=C(o);if(o.currentTarget.setPointerCapture(o.pointerId),"free"===f&&x===r){if(!o.altKey&&a){const e=n.current.getNodeAttribute(r,"x"),o=n.current.getNodeAttribute(r,"y"),a=e-(y.x-s)*l/100,c=o-(y.y-i)*l/100;let d=a,u=c;if(Re(r,n.current)){let e=ee,t=ne;if(0!==e.length&&(e=e.filter(e=>He(e,a,c)<=6)),t&&(0===e.length||Math.hypot(a-t.x,c-t.y)>6)&&(t=void 0),!t&&1===e.length){const r=e[0],{snapPoint:o,distance:s}=((e,t,n,r,o)=>{const s=t.filter(t=>{const n=e.getNodeAttribute(t,"x"),r=e.getNodeAttribute(t,"y");return Math.abs(o.a*n+o.b*r+o.c)<=.01}),i=[(e,t,n,r)=>[(e+n)/2,(t+r)/2],(e,t,n,r)=>[2*e-n,2*t-r],(e,t,n,r)=>[2*n-e,2*r-t]];let a=1/0,l={x:0,y:0,originalNodesPos:[{x:0,y:0},{x:0,y:0}]};for(let c=0;c<s.length;c++){const t=s[c],o=e.getNodeAttribute(t,"x"),d=e.getNodeAttribute(t,"y");for(let u=c+1;u<s.length;u++){const t=s[u],c=e.getNodeAttribute(t,"x"),h=e.getNodeAttribute(t,"y");i.forEach(e=>{const[t,s]=e(o,d,c,h),i=Math.hypot(n-t,r-s);i<a&&(a=i,l={x:t,y:s,originalNodesPos:[{x:o,y:d},{x:c,y:h}]})})}}return{snapPoint:l,distance:a}})(n.current,J.filter(e=>!h.has(e)),a,c,r);s<=3&&(t=o)}if(1===e.length&&!t||0===e.length){const{l:t,d:n}=((e,t,n,r)=>{let o=1/0,s={a:0,b:0,c:0,node:"stn_null",x:0,y:0};return n.filter(e=>r.includes(e.node)).forEach(n=>{const r=He(n,e,t);r<o&&(o=r,s=n)}),{l:s,d:o}})(a,c,K,J.filter(t=>!h.has(t)&&!e.some(e=>e.node===t))),r=0===e.length||!e.some(e=>e.a===t.a&&e.b===t.b);n<3&&e.length<2&&r&&e.push(t)}if(1===e.length)if(t)d=t.x,u=t.y;else{const t=e[0];if(0==t.a)u=-t.c/t.b;else if(0==t.b)d=-t.c/t.a;else{u=-t.a/t.b*d+-t.c/t.b}}else if(2===e.length){const t=e[0],n=e[1],r=t.a*n.b-n.a*t.b;0!==r&&(d=-(t.c*n.b-n.c*t.b)/r,u=-(t.a*n.c-n.a*t.c)/r)}te(e),re(t)}const x=d-e,p=u-o;h.forEach(e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,e=>t(t({},e),{},{x:N(e.x+x,.01),y:N(e.y+p,.01)}))})}else te([]),re(void 0),h.forEach(e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,e=>t(t({},e),{},{x:N(e.x-(y.x-s)*l/100,o.altKey?.01:5),y:N(e.y-(y.y-i)*l/100,o.altKey?.01:5)}))});e(b()),e(v())}else f.startsWith("line")&&x&&H({dx:(y.x-s)*l/100,dy:(y.y-i)*l/100})}),ie=Me((t,o)=>{if(o.currentTarget.releasePointerCapture(o.pointerId),f.startsWith("line")){var i;P||e(Y("free"));const t=n.current.hasNode(x)&&Ge.includes(n.current.getNodeAttribute(x,"type")),a=["stn_core_","virtual_circle_","misc_node_connectable_"],l=null===(i=document.elementsFromPoint(o.clientX,o.clientY).at(0))||void 0===i||null===(i=i.attributes)||void 0===i||null===(i=i.getNamedItem("id"))||void 0===i?void 0:i.value,c=a.find(e=>null==l?void 0:l.startsWith(e));if(t&&c){const t=f.slice(5),o=`line_${z(10)}`,[i,a]=[x,l.slice(c.length)];if(i!==a){const l=s?q(n.current,t,i,a,"from"):-1;n.current.addDirectedEdgeWithKey(o,i,a,{visible:!0,zIndex:0,type:t,[t]:structuredClone(T[t].defaultAttrs),style:M.SingleColor,[M.SingleColor]:{color:E},reconcileId:"",parallelIndex:l}),e(k(new Set([o]))),r&&O.event(W.ADD_LINE,{type:t}),e(m(n.current.export())),e(v())}}}else if("free"===f&&x){const{x:t,y:r}=C(o);y.x-t===0&&y.y-r===0||(e(m(n.current.export())),e(b()))}te([]),re(void 0),S(void 0),e(B(void 0))}),ae=Me((t,o)=>{if(o.stopPropagation(),o.shiftKey||e(w()),o.shiftKey&&h.has(t)?e(F(t)):e(U(t)),f.startsWith("station")||f.startsWith("misc-node-virtual")||f.startsWith("misc-node-master")){const i=o.clientX-document.getElementById("canvas").getBoundingClientRect().left,a=o.clientY-document.getElementById("canvas").getBoundingClientRect().top,d=f.startsWith("station"),u=z(10),h=d?`stn_${u}`:`misc_node_${u}`,y=d?f.slice(8):f.slice(10),{x:x,y:p}=j(i,a,l,c),g=d?structuredClone(me[y].defaultAttrs):structuredClone(Ee[y].defaultAttrs);"color"in g&&(g.color=E),n.current.addNode(h,{visible:!0,zIndex:0,x:N(x,5),y:N(p,5),type:y,[y]:g});const w=n.current.getEdgeAttributes(t),{zIndex:A,type:M,style:P}=w,$=w[M],D=w[P],[C,S]=n.current.extremities(t),_=s?0:-1;n.current.addDirectedEdgeWithKey(`line_${z(10)}`,C,h,{visible:!0,zIndex:A,type:M,[M]:structuredClone($),style:P,[P]:structuredClone(D),reconcileId:"",parallelIndex:_}),n.current.addDirectedEdgeWithKey(`line_${z(10)}`,h,S,{visible:!0,zIndex:A,type:M,[M]:structuredClone($),style:P,[P]:structuredClone(D),reconcileId:"",parallelIndex:_}),n.current.dropEdge(t),e(m(n.current.export())),e(b()),e(v()),r&&(O.event(W.ADD_STATION,{type:y}),O.event(W.ADD_LINE,{type:M})),e(Y("free")),e(k(new Set([h])))}}),le=je.useMemo(()=>[...Ue(n.current),...Fe(n.current)],[g,p]),ce=$.component;return o.jsxs(o.Fragment,{children:[o.jsx(Je,{elements:le,handlePointerDown:oe,handlePointerMove:se,handlePointerUp:ie,handleEdgePointerDown:ae}),f.startsWith("line")&&x&&"background"!==x&&o.jsx(ce,{id:"line_create_in_progress___no_use",type:f.slice(5),path:T[f.slice(5)].generatePath(n.current.getNodeAttribute(x,"x"),n.current.getNodeAttribute(x,"x")-R.dx,n.current.getNodeAttribute(x,"y"),n.current.getNodeAttribute(x,"y")-R.dy,T[f.slice(5)].defaultAttrs),styleAttrs:{color:E},newLine:!0,handlePointerDown:()=>{}}),0!==ee.length&&ee.map(e=>o.jsx("path",{d:T[D.Simple].generatePath(...Z(e,A(c,l,L,I)),T[D.Simple].defaultAttrs),stroke:"cyan",strokeWidth:l/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`)),ne&&o.jsx(qe,{activeSnapPoint:ne})]})};var tt=(e=>(e.STATION="station",e.MISC_NODE="misc-node",e.LINE="line",e.OPERATION="operation",e))(tt||{});const nt={station:[],"misc-node":[],line:[],operation:[]},rt=({data:e,position:t,onClose:n,visible:r})=>{const{svgViewBoxZoom:s}=u(e=>e.param),i=[...e[tt.STATION],...e[tt.MISC_NODE],...e[tt.LINE]];if(!r||0===i.length)return null;return o.jsxs("g",{transform:`translate(${t.x}, ${t.y})scale(${.8*s/100})`,children:[Object.entries(e).map(([e,t])=>{if(!t||0===t.length)return null;let r,s;switch(e){case tt.STATION:r=Math.PI,s="hsl(220, 30%, 85%)";break;case tt.LINE:r=Math.PI/2,s="hsl(120, 30%, 85%)";break;case tt.MISC_NODE:r=3*Math.PI/2,s="hsl(60, 30%, 85%)";break;case tt.OPERATION:r=2*Math.PI,s="hsl(0, 30%, 85%)";break;default:return null}const i=r+Math.PI/2;return o.jsx("g",{children:t.slice(0,6).map((e,t)=>{const a=30+40*t,l=30+40*(t+1),c=a*Math.cos(r),d=a*Math.sin(r),u=a*Math.cos(i),h=a*Math.sin(i),y=`M ${c} ${d}\n                                     L ${l*Math.cos(r)} ${l*Math.sin(r)}\n                                     A ${l} ${l} 0 0 1 ${l*Math.cos(i)} ${l*Math.sin(i)}\n                                     L ${u} ${h}\n                                     A ${a} ${a} 0 0 0 ${c} ${d}`,x=30+40*(t+.5),p=`M ${x*Math.cos(r)} ${x*Math.sin(r)} A ${x} ${x} 0 0 1 ${x*Math.cos(i)} ${x*Math.sin(i)}`;return o.jsxs("g",{onPointerDown:t=>((e,t)=>{e.stopPropagation(),t(),n()})(t,e.action),children:[o.jsx("path",{d:y,fill:s,stroke:"rgba(0,0,0,0.1)",strokeWidth:"1",fillRule:"evenodd"}),o.jsx("defs",{children:o.jsx("path",{id:e.label,d:p})}),o.jsx("text",{textAnchor:"middle",dominantBaseline:"middle",fontSize:"10",fill:"#333",style:{pointerEvents:"none",userSelect:"none"},children:o.jsx("textPath",{startOffset:"50%",href:`#${e.label}`,children:e.label})})]},e.elementId)})},e)}),o.jsx("circle",{cx:0,cy:0,r:30,fill:"rgba(255, 255, 255, 0.3)",stroke:"rgba(0,0,0,0.2)",strokeWidth:"1",onPointerDown:n})]})},ot=()=>{const e=d(),t=je.useRef(window.graph),{svgViewBoxZoom:n,svgViewBoxMin:r}=u(e=>e.param),{selected:s}=u(e=>e.runtime),i=X(),{height:a,width:l}=V(i),c=je.useCallback(()=>{e(m(t.current.export())),e(b()),e(v())},[e]),h=je.useCallback((e,n,r)=>{e.stopPropagation(),s.size>0&&(s.forEach(e=>{t.current.hasNode(e)&&(t.current.updateNodeAttribute(e,"x",e=>(null!=e?e:0)+10*n),t.current.updateNodeAttribute(e,"y",e=>(null!=e?e:0)+10*r))}),c())},[s,c]),y=je.useCallback(e=>h(e,0,-1),[h]),x=je.useCallback(e=>h(e,0,1),[h]),p=je.useCallback(e=>h(e,-1,0),[h]),g=je.useCallback(e=>h(e,1,0),[h]),f=je.useCallback(()=>{if(s.size>0){const e=Pe(t.current,s);navigator.clipboard.writeText(e)}},[s]),j=je.useCallback(()=>{s.size>0&&(e(w()),s.forEach(e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)}),c())},[s,e,c]),N=r.x+l*n/200,k=r.y+(a-100)*n/100;return o.jsxs("g",{transform:`translate(${N}, ${k})scale(${1.5*n/100})`,children:[o.jsxs("g",{transform:"translate(0, -40)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:y}),o.jsx(ee,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(0, 40)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:x}),o.jsx(te,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(-40, 0)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:p}),o.jsx(ne,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(40, 0)",children:[o.jsx("circle",{r:20,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:g}),o.jsx(re,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(40, 40)",children:[o.jsx("circle",{r:16,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(0, 0, 0, 0.3)",strokeWidth:"1",onPointerDown:f}),o.jsx(oe,{x:-8,y:-8,fill:"rgba(0, 0, 0, 0.7)",style:{pointerEvents:"none"}})]}),o.jsxs("g",{transform:"translate(-40, 40)",children:[o.jsx("circle",{r:16,fill:"rgba(255, 255, 255, 0.9)",stroke:"rgba(255, 0, 0, 0.5)",strokeWidth:"1",onPointerDown:j}),o.jsx(se,{x:-8,y:-8,fill:"rgba(255, 0, 0, 0.7)",style:{pointerEvents:"none"}})]})]})},st=()=>{const e=d(),{svgViewBoxZoom:t,svgViewBoxMin:n}=u(e=>e.param),{selected:r}=u(e=>e.runtime),s=je.useRef(window.graph),[i,a]=je.useState(0),l=X(),{height:c,width:h}=V(l),[y,x]=Ae.useState({visible:!1,position:{x:0,y:0},data:nt}),p=Me(r=>{if(1==r.touches.length){var o;if(a(0),y.visible)return void m();const i=r.touches[0],l=null===(o=document.getElementById("canvas"))||void 0===o?void 0:o.getBoundingClientRect();if(!l)return;const c=i.clientX-l.left,d=i.clientY-l.top,u=j(c,d,t,n),h=((e,t,n)=>{const r=structuredClone(nt),o=e.filterNodes((e,n)=>!!e.startsWith("stn")&&Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))<=30),s=e.filterNodes((e,n)=>!!e.startsWith("misc")&&Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))<=30),i=[...o,...s],a=[];if(i.length>0&&e.forEachEdge((e,t,n,r)=>{(i.includes(n)||i.includes(r))&&a.push(e)}),o.length>0){const t=o.slice(0,8).map(t=>{const r=e.getNodeAttribute(t,"type");return{label:e.getNodeAttribute(t,r).names[0],elementId:t,action:()=>n(k(new Set([t])))}});r.station=t}if(s.length>0){const t=s.slice(0,8).map(t=>{const r=e.getNodeAttribute(t,"type"),o=J(r);return{label:G.t(`panel.details.nodes.${o}.displayName`),elementId:t,action:()=>n(k(new Set([t])))}});r["misc-node"]=t}if(a.length>0){const t=a.slice(0,6).map(t=>{const[r,o]=e.extremities(t),s=e.getNodeAttribute(r,"type"),i=e.getNodeAttribute(o,"type");let a="",l="";return a=r.startsWith("stn")?e.getNodeAttribute(r,s).names[0]:G.t(`panel.details.nodes.${J(s)}.displayName`),l=o.startsWith("stn")?e.getNodeAttribute(o,i).names[0]:G.t(`panel.details.nodes.${J(i)}.displayName`),{label:`${a} - ${l}`,elementId:t,action:()=>n(k(new Set([t])))}});r.line=t}const l=[];return l.push({label:G.t("contextMenu.paste"),action:async()=>{try{const n=await navigator.clipboard.readText();$e(n,e,!1,!1,t.x,t.y)}catch(n){console.error("Failed to paste from clipboard:",n)}},elementId:"operation-paste"}),r.operation=l,r})(s.current,u,e);[...h[tt.STATION],...h[tt.MISC_NODE],...h[tt.LINE]].length>0?x({visible:!0,position:u,data:h}):(e(w()),m())}else if(2==r.touches.length){e(B(void 0));const[t,n]=[r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY];a(t*t+n*n)}}),g=Me(r=>{if(2==r.touches.length&&i>0){const[o,s]=[r.touches[0].clientX-r.touches[1].clientX,r.touches[0].clientY-r.touches[1].clientY],l=o*o+s*s;let d=t;l-i<0&&t+10<=390?d=t+10:l-i>0&&t-10>=10&&(d=t-10),e(ie(d)),a(l);const u=r.currentTarget.getBoundingClientRect(),[y,x]=[(r.touches[0].clientX+r.touches[1].clientX)/2-u.left,(r.touches[0].clientY+r.touches[1].clientY)/2-u.top],[p,g]=[y/u.width,x/u.height];e(ae({x:n.x+y*t/100-h*d/100*p,y:n.y+x*t/100-c*d/100*g}))}}),f=Me(e=>{a(0)}),m=Ae.useCallback(()=>{x({visible:!1,position:{x:0,y:0},data:nt})},[]);return o.jsxs("g",{className:"removeMe",children:[[...r].some(e=>e.startsWith("stn_")||e.startsWith("misc_node_"))?o.jsx(ot,{}):o.jsx("rect",{x:n.x,y:n.y,width:h*t/100,height:c*t/100,fill:y.visible?"rgba(0,0,0,0.3)":"transparent",onTouchStart:p,onTouchMove:g,onTouchEnd:f}),o.jsx(rt,{data:y.data,position:y.position,onClose:m,visible:y.visible})]})};e("default",()=>{const e=d(),n=je.useRef(window.graph),r=je.useCallback(()=>{e(m(n.current.export())),e(b()),e(v())},[e]),{activeSubscriptions:s}=u(e=>e.account),{telemetry:{project:i},preference:{gridLines:a,snapLines:l,predictNextNode:h,autoParallel:y}}=u(e=>e.app),{svgViewBoxZoom:x,svgViewBoxMin:p}=u(e=>e.param),{selected:A,active:M,isDetailsOpen:P,mode:$,lastTool:E,keepLastPath:S,theme:_,count:{masters:T,lines:L}}=u(e=>e.runtime),R=X(),{height:H,width:K}=V(R),F=!s.RMP_CLOUD&&T+1>g,U=!s.RMP_CLOUD&&L+1>f,Z=ze();le();const[Q,J]=je.useState({x:0,y:0}),[G,ee]=je.useState({x:0,y:0}),[te,ne]=je.useState({isOpen:!1,position:{x:0,y:0}}),[re,oe]=je.useState({x:0,y:0}),[se,Ne]=je.useState({x:0,y:0}),ke=Me(async o=>{te.isOpen&&ne({isOpen:!1,position:{x:0,y:0}});const{x:s,y:a}=C(o);if($.startsWith("station")||$.startsWith("misc-node")){e(Y("free"));const o=z(10),{x:l,y:c}=j(s,a,x,p),d=$.startsWith("station"),u=d?`stn_${o}`:`misc_node_${o}`,h=d?$.slice(8):$.slice(10),y=structuredClone(t(t({},me),Ee)[h].defaultAttrs);I.has(h)&&(y.color=_),d&&(y.names=await Z(h)),n.current.addNode(u,{visible:!0,zIndex:0,x:N(l,5),y:N(c,5),type:h,[h]:y}),i&&O.event(W.ADD_STATION,{type:h}),r(),e(k(new Set([u])))}else"free"===$||$.startsWith("line")?($.startsWith("line")&&(e(Y("free")),S&&e(fe(!1))),oe({x:s,y:a}),Ne(p),o.shiftKey||(e(B("background")),e(w()))):"select"===$&&(J(j(s,a,x,p)),ee(j(s,a,x,p)))}),Ae=Me(t=>{if("select"===$){if(0!=Q.x&&0!=Q.y){const{x:e,y:n}=C(t);ee(j(e,n,x,p))}}else if("background"===M){const{x:n,y:r}=C(t);e(ae({x:se.x+(re.x-n)*x/100,y:se.y+(re.y-r)*x/100}))}}),De=Me(t=>{if("select"===$){const{x:r,y:o}=C(t),{x:s,y:i}=j(r,o,x,p),a=be(n.current,Q.x,Q.y,s,i),l=we(n.current,new Set(a));e(k(new Set([...t.shiftKey?A:[],...a,...l]))),e(Y("free")),J({x:0,y:0}),ee({x:0,y:0})}"background"!==M||t.shiftKey||e(B(void 0))}),Ce=Me(t=>{let n=x;t.deltaY>0&&x+10<400?n=x+10:t.deltaY<0&&x-10>0&&(n=x-10),e(ie(n));const{x:r,y:o}=C(t),s=t.currentTarget.getBoundingClientRect(),[i,a]=[r/s.width,o/s.height];e(ae({x:p.x+r*x/100-K*n/100*i,y:p.y+o*x/100-H*n/100*a}))}),Se=Me(e=>{e.preventDefault(),C(e),ne({isOpen:!0,position:{x:e.clientX,y:e.clientY}})}),Ie=Me(()=>{ne({isOpen:!1,position:{x:0,y:0}});const e=document.getElementById("canvas");e&&e.focus()}),We=Me(async o=>{if(ye?"Backspace"===o.key:"Delete"===o.key)A.size>0&&(A.forEach(e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)}),e(w()),r());else if(o.key.startsWith("Arrow")){const t=100,n=o.key.endsWith("Left")?-1:o.key.endsWith("Right")?1:0,r=o.key.endsWith("Up")?-1:o.key.endsWith("Down")?1:0;e(ae(j(t*n,t*r,x,p)))}else if("i"===o.key||"j"===o.key||"k"===o.key||"l"===o.key){const e=10,t=("j"===o.key?-1:"l"===o.key?1:0)*e,s=("i"===o.key?-1:"k"===o.key?1:0)*e;A.size>0&&A.forEach(e=>{n.current.hasNode(e)&&(n.current.updateNodeAttribute(e,"x",e=>(null!=e?e:0)+t),n.current.updateNodeAttribute(e,"y",e=>(null!=e?e:0)+s),r())})}else if("f"===o.key&&E)e(Y(E));else if("z"===o.key&&(ye?o.metaKey&&!o.shiftKey:o.ctrlKey))ye&&o.preventDefault(),e(xe()),e(b()),e(v());else if("s"===o.key)e(Y("select"));else if("c"!==o.key&&"x"!==o.key||!(ye?o.metaKey&&!o.shiftKey:o.ctrlKey)){if("v"===o.key&&(ye?o.metaKey&&!o.shiftKey:o.ctrlKey)){const t=await navigator.clipboard.readText(),{x:o,y:s}=j(K/2,H/2,x,p),{nodes:i,edges:a}=$e(t,n.current,F,U,N(o,5),N(s,5));r();const l=structuredClone(i);a.forEach(e=>l.add(e)),e(k(l))}else if(ye&&"z"===o.key&&o.metaKey&&o.shiftKey||!ye&&"y"===o.key&&o.ctrlKey)e(pe());else if("c"===o.key)e(ge(!l));else if("e"===o.key){const[e]=A;if(1===A.size&&n.current.hasEdge(e)){const o=n.current.getEdgeAttributes(e),{type:s}=o;if(s!==D.Simple&&o[s]){const i=o[s],a="from"===(i.startFrom||"from")?"to":"from";let l=o.parallelIndex;if(y){const[t,r]=n.current.extremities(e);l=q(n.current,s,t,r,a)}const c=t(t({},i),{},{startFrom:a});n.current.mergeEdgeAttributes(e,{[s]:c,parallelIndex:l}),r()}}}}else{const t=Pe(n.current,A);navigator.clipboard.writeText(t),"x"===o.key&&(e(w()),A.forEach(e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)}),r())}}),[Te,Be]=je.useState({sx:0,sy:0,ex:0,ey:0});return je.useEffect(()=>{Be({sx:Q.x<=G.x?Q.x:G.x,ex:Q.x>G.x?Q.x:G.x,sy:Q.y<=G.y?Q.y:G.y,ey:Q.y>G.y?Q.y:G.y})},[G.x,G.y]),o.jsxs(o.Fragment,{children:[o.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:H,width:K,viewBox:`${p.x} ${p.y} ${K*x/100} ${H*x/100}`,onPointerDown:ke,onPointerMove:Ae,onPointerUp:De,onWheel:Ce,onContextMenu:Se,tabIndex:0,onKeyDown:We,children:[o.jsx("defs",{children:o.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[o.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),o.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})}),a&&o.jsx(Oe,{svgViewBoxMin:p,svgViewBoxZoom:x,svgWidth:K,svgHeight:H}),h&&1===A.size&&"free"===$&&o.jsx(Le,{}),o.jsx(ve.SvgAssetsContextProvider,{children:o.jsx(et,{})}),"select"===$&&0!=Q.x&&0!=Q.y&&o.jsx("rect",{x:Te.sx,y:Te.sy,width:Te.ex-Te.sx,height:Te.ey-Te.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),de()&&"select"!==$&&!$.startsWith("line-")&&o.jsx(st,{})]}),o.jsx(_e,{isOpen:te.isOpen,position:te.position,onClose:Ie}),ce()&&"hide"===P&&o.jsx(c,{"aria-label":"open details panel",icon:o.jsx(he,{style:{transform:"rotate(180deg)"}}),onClick:()=>e(ue()),style:{position:"fixed",bottom:140,right:0,borderTopRightRadius:0,borderBottomRightRadius:0},colorScheme:"blue",size:"lg",isRound:!0})]})})}}})}();

import{j as E}from"./chakra-594c63ee.js";import{t as W,N as ie,q as R,j as me,d as U,af as K,ag as J,ah as Z,ai as ye,aj as ne,y as ve,z as ce,S as ke,e as Ee,p as ae,v as X,r as de,E as le,A as ue,D as Y,Q as Ne,K as re,J as Ce,a4 as Le,a6 as Pe}from"./index-71d7eb53.js";import{r as fe,b as A}from"./react-2c0b8364.js";import{u as M,e as je,i as Ie}from"./clipboard-f63c12f7.js";import{b as B,r as $,F as G,p as D,a as O}from"./helpers-70102f36.js";import{f as _e,a as Me,b as We}from"./graph-682f233d.js";import{m as Ae}from"./misc-nodes-e8fa4095.js";import{s as be}from"./stations-4ea8a15b.js";const ze=()=>{const[t,e]=fe.useState({width:void 0,height:void 0});return fe.useEffect(()=>{function n(){e({width:window.innerWidth,height:window.innerHeight})}return window.addEventListener("resize",n),n(),()=>window.removeEventListener("resize",n)},[]),t},ge=t=>t.filterNodes((e,n)=>e.startsWith("stn")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,n])=>n.visible).sort((e,n)=>e[1].zIndex-n[1].zIndex).map(([e,n])=>({node:e,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),xe=t=>t.filterDirectedEdges((e,n,a,r,x,h,y)=>e.startsWith("line")&&n.visible&&n.reconcileId==="").sort((e,n)=>t.getEdgeAttribute(e,"zIndex")-t.getEdgeAttribute(n,"zIndex")).map(e=>{const n=t.getEdgeAttribute(e,"type"),a=t.getEdgeAttribute(e,n),r=t.getEdgeAttribute(e,"style"),x=t.getEdgeAttribute(e,r),[h,y]=t.extremities(e),l=t.getNodeAttributes(h),p=t.getNodeAttributes(y);return{edge:e,x1:l.x,y1:l.y,x2:p.x,y2:p.y,type:n,attr:a,style:r,styleAttr:x}}),pe=t=>t.filterNodes((e,n)=>e.startsWith("misc_node")).map(e=>[e,t.getNodeAttributes(e)]).filter(([e,n])=>n.visible).sort((e,n)=>e[1].zIndex-n[1].zIndex).map(([e,n])=>({node:e,visible:n.visible,zIndex:n.zIndex,x:n.x,y:n.y,type:n.type,[n.type]:n[n.type]})),De=t=>{const e=t.filterDirectedEdges((a,r,x,h,y,l,p)=>a.startsWith("line")&&r.reconcileId!==""),n={};for(const a of e){const r=t.getEdgeAttribute(a,"reconcileId");r in n?n[r].push(a):n[r]=[a]}return n},Ke=t=>{const e=De(t),n=[],a=[];return Object.values(e).forEach(r=>{var L;if(r.length===1){a.push(...r);return}const x=t.getEdgeAttribute(r.at(0),"type");if(!r.every(f=>t.getEdgeAttribute(f,"type")===x)){a.push(...r);return}const h=t.getEdgeAttribute(r.at(0),"style");if(!r.every(f=>t.getEdgeAttribute(f,"style")===h)){a.push(...r);return}const y={},l=new Set,p=new Set,b=Object.fromEntries(r.map(f=>{var V,T;const[P,_]=t.extremities(f);return y[P]=((V=y[P])!=null?V:0)+1,y[_]=((T=y[_])!=null?T:0)+1,l.add(P),p.add(_),[P,[f,_]]})),w=Array.from(l).filter(f=>y[f]===1),j=Array.from(p).filter(f=>y[f]===1);if(w.length!==1||j.length!==1){a.push(...r);return}const N=w[0],I=j[0];if(N===I){a.push(...r);return}const C=[b[N][0]];let m=b[N][1];for(let f=1;f<r.length;f=f+1){const P=(L=b[m])==null?void 0:L.at(1);if(!P){a.push(...r);return}C.push(b[m][0]),m=P}if(m!==I||C.length!==r.length){a.push(...r);return}n.push(C)}),{allReconciledLines:n,danglingLines:a}},$e=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const n=e.map(r=>{var w,j,N;const[x,h]=t.extremities(r),y=t.getNodeAttributes(x),l=t.getNodeAttributes(h),p=t.getEdgeAttribute(r,"type"),b=(w=t.getEdgeAttribute(r,p))!=null?w:W[p].defaultAttrs;return(N=(j=W[p])==null?void 0:j.generatePath(y.x,l.x,y.y,l.y,b))!=null?N:`M ${y.x},${y.y} L ${l.x},${l.y}`});let a=`${n[0]} `;for(let r=1;r<e.length;r=r+1)a+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return a},he=t=>{const{id:e,x:n,y:a,handlePointerDown:r,handlePointerMove:x,handlePointerUp:h}=t,y=A.useCallback(b=>r(e,b),[e,r]),l=A.useCallback(b=>x(e,b),[e,x]),p=A.useCallback(b=>h(e,b),[e,h]);return E.jsx("g",{id:e,transform:`translate(${n-6.4},${a-6.4})scale(0.025)`,onPointerDown:y,onPointerMove:l,onPointerUp:p,style:{cursor:"move"},children:E.jsx("path",{id:`stn_core_${e}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Se=t=>{const{id:e,path:n,handleClick:a}=t,r=A.useCallback(x=>a(e,x),[e,a]);return E.jsx("path",{id:e,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onClick:r})},oe=t=>{var C,m;const{id:e,type:n,attrs:a=W[n].defaultAttrs,styleType:r,styleAttrs:x=ie[r].defaultAttrs,newLine:h,handleClick:y}=t,{x1:l,y1:p,x2:b,y2:w}=t,[j,N]=A.useState("M 0,0 L 0,0");A.useEffect(()=>{let L="M 0,0 L 0,0";if(!(n in W))L=`M ${l},${p} L ${b},${w}`;else if(["offsetFrom","offsetTo"].every(f=>Object.keys(a).includes(f))&&!Number.isNaN(a.offsetFrom)&&!Number.isNaN(a.offsetTo)&&a.offsetFrom===a.offsetTo&&((l===b||p===w)&&[R.Diagonal,R.Perpendicular].includes(n)||Math.abs((w-p)/(b-l))===1&&[R.Diagonal,R.RotatePerpendicular].includes(n))){const f=a.offsetFrom;L=W[R.Simple].generatePath(l,b,p,w,{offset:f})}else L=W[n].generatePath(l,b,p,w,a);N(L)},[n,JSON.stringify(a),l,b,p,w]);const I=(m=(C=ie[r])==null?void 0:C.component)!=null?m:Se;return A.useMemo(()=>E.jsx(I,{id:e,type:n,path:j,styleAttrs:x,newLine:h,handleClick:y}),[e,n,j,r,JSON.stringify(x),h,y])},Be=()=>{const t=me(),e=A.useRef(window.graph),{telemetry:{project:n}}=U(i=>i.app),{svgViewBoxZoom:a}=U(i=>i.param),{selected:r,refresh:{nodes:x,edges:h},mode:y,active:l,keepLastPath:p,theme:b}=U(i=>i.runtime),[w,j]=A.useState({x:0,y:0}),[N,I]=A.useState({x:0,y:0}),C=M((i,g)=>{g.stopPropagation(),y==="select"&&t(K("free"));const v=g.currentTarget,{x:S,y:s}=B(g);v.setPointerCapture(g.pointerId),j({x:S,y:s}),t(J(i)),g.shiftKey?r.includes(i)?t(ye(i)):t(ne(i)):r.includes(i)||t(Z([i]))}),m=M((i,g)=>{const{x:v,y:S}=B(g);y==="free"&&l===i?(r.filter(s=>e.current.hasNode(s)).forEach(s=>{e.current.updateNodeAttributes(s,o=>({...o,x:$(o.x-(w.x-v)*a/100,g.altKey?1:5),y:$(o.y-(w.y-S)*a/100,g.altKey?1:5)}))}),t(ve()),t(ce())):y.startsWith("line")&&I({x:(w.x-v)*a/100,y:(w.y-S)*a/100})}),L=M((i,g)=>{if(y.startsWith("line")){p||t(K("free"));const v=[...Object.values(ke),Ee.Virtual],S=e.current.hasNode(l)&&v.includes(e.current.getNodeAttribute(l,"type"));["stn_core_","virtual_circle_"].forEach(o=>{var k,z;const u=(z=(k=document.elementsFromPoint(g.clientX,g.clientY)[0].attributes)==null?void 0:k.getNamedItem("id"))==null?void 0:z.value,d=u==null?void 0:u.startsWith(o);if(S&&d){const F=y.slice(5),we=`line_${ae(10)}`;e.current.addDirectedEdgeWithKey(we,l,u.slice(o.length),{visible:!0,zIndex:0,type:F,[F]:structuredClone(W[F].defaultAttrs),style:X.SingleColor,[X.SingleColor]:{color:b},reconcileId:""}),n&&de.event(le.ADD_LINE,{type:F})}}),t(ce()),t(ue(e.current.export()))}else if(y==="free")if(l){const{x:v,y:S}=B(g);w.x-v===0&&w.y-S===0||t(ue(e.current.export()))}else t(ne(i));t(J(void 0))}),f=M((i,g)=>{g.shiftKey||t(Y()),g.shiftKey&&r.includes(i)?t(ye(i)):t(ne(i))}),[P,_]=A.useState(ge(e.current)),[V,T]=A.useState(pe(e.current)),[q,H]=A.useState(xe(e.current)),[Q,ee]=A.useState([]),[te,se]=A.useState([]);return A.useEffect(()=>{_(ge(e.current)),T(pe(e.current))},[x]),A.useEffect(()=>{H(xe(e.current));const{allReconciledLines:i,danglingLines:g}=Ke(e.current);ee(i),se(g)},[h]),E.jsxs(E.Fragment,{children:[te.map(i=>{const[g,v]=e.current.extremities(i),S=e.current.getNodeAttributes(g),s=e.current.getNodeAttributes(v);return E.jsx(oe,{id:i,x1:S.x,y1:S.y,x2:s.x,y2:s.y,newLine:!1,type:R.Simple,attrs:W[R.Simple].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:["","","#c0c0c0","#fff"]},handleClick:f},i)}),Q.map(i=>{var u,d;const g=$e(e.current,i);if(!g)return E.jsx(E.Fragment,{});const v=i.at(0),S=e.current.getEdgeAttribute(v,"type"),s=e.current.getEdgeAttribute(v,"style"),o=e.current.getEdgeAttribute(v,s),c=(d=(u=ie[s])==null?void 0:u.component)!=null?d:Se;return E.jsx(c,{id:v,type:S,path:g,styleAttrs:o,newLine:!1,handleClick:f},v)}),q.map(({edge:i,x1:g,y1:v,x2:S,y2:s,type:o,attr:c,style:u,styleAttr:d})=>E.jsx(oe,{id:i,x1:g,y1:v,x2:S,y2:s,newLine:!1,type:o,attrs:c,styleType:u,styleAttrs:d,handleClick:f},i)),V.map(i=>{var c,u;const{node:g,x:v,y:S,type:s}=i,o=(u=(c=Ae[s])==null?void 0:c.component)!=null?u:he;return E.jsx(o,{id:g,x:v,y:S,attrs:i[s],handlePointerDown:C,handlePointerMove:m,handlePointerUp:L},g)}),P.map(i=>{var c,u;const{node:g,x:v,y:S,type:s}=i,o=(u=(c=be[s])==null?void 0:c.component)!=null?u:he;return E.jsx(o,{id:g,x:v,y:S,attrs:{[s]:i[s]},handlePointerDown:C,handlePointerMove:m,handlePointerUp:L},g)}),y.startsWith("line")&&l&&E.jsx(oe,{id:"create_in_progress___no_use",x1:e.current.getNodeAttribute(l,"x"),y1:e.current.getNodeAttribute(l,"y"),x2:e.current.getNodeAttribute(l,"x")-N.x,y2:e.current.getNodeAttribute(l,"y")-N.y,newLine:!0,type:y.slice(5),attrs:W[y.slice(5)].defaultAttrs,styleType:X.SingleColor,styleAttrs:{color:b}})]})},Ge=()=>{var v,S;const t=me(),e=A.useRef(window.graph),n=()=>{t(ve()),t(ce()),t(ue(e.current.export()))},{telemetry:{project:a}}=U(s=>s.app),{svgViewBoxZoom:r,svgViewBoxMin:x}=U(s=>s.param),{mode:h,lastTool:y,active:l,selected:p,keepLastPath:b,theme:w,refresh:{nodes:j}}=U(s=>s.runtime),N=ze(),I=((v=N.height)!=null?v:1280)-40,C=((S=N.width)!=null?S:720)-40;A.useEffect(()=>{const s=_e(e.current);Object.entries(s).filter(([o,c])=>c&&o in G).map(([o,c])=>o).filter(o=>G[o]&&document.getElementById(G[o].cssName)===null).map(o=>G[o].cssName).filter((o,c,u)=>c===u.findIndex(d=>d===o)).forEach(o=>{const c=document.createElement("link");c.rel="stylesheet",c.id=o,c.href=`/rmp/styles/${o}.css`,document.head.append(c)})},[j]);const[m,L]=A.useState({x:0,y:0}),[f,P]=A.useState({x:0,y:0}),[_,V]=A.useState({x:0,y:0}),[T,q]=A.useState({x:0,y:0}),H=M(s=>{const{x:o,y:c}=B(s);if(h.startsWith("station")){t(K("free"));const u=ae(10),d=h.slice(8),k=structuredClone(be[d].defaultAttrs);"color"in k&&(k.color=w);const{x:z,y:F}=D(o,c,r,x);e.current.addNode(`stn_${u}`,{visible:!0,zIndex:0,x:$(z,5),y:$(F,5),type:d,[d]:k}),n(),a&&de.event(le.ADD_STATION,{type:d})}else if(h.startsWith("misc-node")){t(K("free"));const u=ae(10),d=h.slice(10),{x:k,y:z}=D(o,c,r,x);e.current.addNode(`misc_node_${u}`,{visible:!0,zIndex:0,x:$(k,5),y:$(z,5),type:d,[d]:structuredClone(Ae[d].defaultAttrs)}),n(),a&&de.event(le.ADD_STATION,{type:d})}else h==="free"||h.startsWith("line")?(h.startsWith("line")&&(t(K("free")),b&&t(Ne(!1))),V({x:o,y:c}),q(x),s.shiftKey||(t(J("background")),t(Y()))):h==="select"&&(L(D(o,c,r,x)),P(D(o,c,r,x)))}),Q=M(s=>{if(h==="select"){if(m.x!=0&&m.y!=0){const{x:o,y:c}=B(s);P(D(o,c,r,x))}}else if(l==="background"){const{x:o,y:c}=B(s);t(re({x:T.x+(_.x-o)*r/100,y:T.y+(_.y-c)*r/100}))}}),ee=M(s=>{if(h==="select"){const{x:o,y:c}=B(s),{x:u,y:d}=D(o,c,r,x),k=Me(e.current,m.x,m.y,u,d);s.shiftKey?t(Z([...new Set([...p,...k])])):t(Z(k)),t(K("free")),L({x:0,y:0}),P({x:0,y:0})}l==="background"&&!s.shiftKey&&t(J(void 0))}),te=M(s=>{let o=r;s.deltaY>0&&r+10<400?o=r+10:s.deltaY<0&&r-10>0&&(o=r-10),t(Ce(o));const{x:c,y:u}=B(s),d=s.currentTarget.getBoundingClientRect(),[k,z]=[c/d.width,u/d.height];t(re({x:x.x+c*r/100-C*o/100*k,y:x.y+u*r/100-I*o/100*z}))}),se=M(async s=>{if(O?s.key==="Backspace":s.key==="Delete")p.length>0&&p.filter(o=>e.current.hasNode(o)||e.current.hasEdge(o)).forEach(o=>{t(Y()),e.current.hasNode(o)?e.current.dropNode(o):e.current.dropEdge(o),n()});else if(s.key.startsWith("Arrow")){const c=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,u=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;t(re(D(100*c,100*u,r,x)))}else if(s.key==="i"||s.key==="j"||s.key==="k"||s.key==="l"){const c=(s.key==="j"?-1:s.key==="l"?1:0)*10,u=(s.key==="i"?-1:s.key==="k"?1:0)*10;p.length>0&&p.filter(d=>e.current.hasNode(d)).forEach(d=>{e.current.updateNodeAttribute(d,"x",k=>(k!=null?k:0)+c),e.current.updateNodeAttribute(d,"y",k=>(k!=null?k:0)+u),n()})}else if(s.key==="f"&&y)t(K(y));else if(s.key==="z"&&(O?s.metaKey&&!s.shiftKey:s.ctrlKey))O&&s.preventDefault(),t(Le());else if(s.key==="s")t(K("select"));else if((s.key==="c"||s.key==="x")&&(O?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=new Set(p),c=We(e.current,o),u=je(e.current,o,new Set(c));navigator.clipboard.writeText(u),s.key==="x"&&(t(Y()),p.forEach(d=>{e.current.hasNode(d)?e.current.dropNode(d):e.current.hasEdge(d)&&e.current.dropEdge(d)}),n())}else if(s.key==="v"&&(O?s.metaKey&&!s.shiftKey:s.ctrlKey)){const o=await navigator.clipboard.readText(),{x:c,y:u}=D(C/2,I/2,r,x),{nodes:d}=Ie(o,e.current,$(c,5),$(u,5));n(),t(Y()),t(Z(d))}else(O&&s.key==="z"&&s.metaKey&&s.shiftKey||!O&&s.key==="y"&&s.ctrlKey)&&t(Pe())}),[i,g]=A.useState({sx:0,sy:0,ex:0,ey:0});return A.useEffect(()=>{g({sx:m.x<=f.x?m.x:f.x,ex:m.x>f.x?m.x:f.x,sy:m.y<=f.y?m.y:f.y,ey:m.y>f.y?m.y:f.y})},[f.x,f.y]),E.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none"},height:I,width:C,viewBox:`${x.x} ${x.y} ${C*r/100} ${I*r/100}`,onPointerDown:H,onPointerMove:Q,onPointerUp:ee,onWheel:te,tabIndex:0,onKeyDown:se,children:[E.jsx(Be,{}),h==="select"&&m.x!=0&&m.y!=0&&E.jsx("rect",{x:i.sx,y:i.sy,width:i.ex-i.sx,height:i.ey-i.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"})]})};export{Ge as default};

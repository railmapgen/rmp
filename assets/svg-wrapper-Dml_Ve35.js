import{ad as Ot,j as v}from"./chakra-CSR0Uih-.js";import{x as Wt,at as Lt,au as Ft,a4 as _t,e as Q,L as Z,p as F,av as Ut,aw as qt,ax as Gt,ay as Ct,c as Rt,q as Ht,az as tt,aA as ft,V as ct,aB as jt,aC as zt,v as lt,w as dt,aD as it,n as ht,m as Zt,o as Dt,r as xt,E as mt,t as vt,B as St,aE as Qt,S as Jt,aF as te,a1 as ee,aG as ne,F as pt,aq as se,ar as oe,a6 as ie,D as Nt,d as re,a2 as ae}from"./index-B3PR7s8h.js";import{b as Et,r as H,s as yt,g as Xt,f as Kt,e as ce,h as et,j as le,k as de,l as ue,n as he,p as J,o as fe,q as ye,i as rt,t as ge}from"./master-manager-DOB3-_IJ.js";import{k as Yt,b as $}from"./react-eFT_xHYJ.js";import{u as q,e as pe,i as xe}from"./clipboard-CSPdnXqV.js";import{m as gt}from"./misc-nodes-5uNdxfXW.js";const me={[_t.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[_t.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ve=t=>{const e=me[t];return e.at(Math.floor(Math.random()*e.length))},$t=Yt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:d,rejectWithValue:u})=>{const{token:r}=e().account;if(!r){d(Lt({cityName:t,names:[]}));return}const a=await fetch("".concat(Ft,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(r)}});if(!a.ok)return Wt.warn("Failed to fetch random station names",a.statusText),u(a.statusText);const w=await a.json();d(Lt({cityName:t,names:w}))}),Bt=Yt("runtime/getOneStationName",async(t,{getState:e,dispatch:d})=>{var p;const{stationNames:u}=e().runtime,r=u[t];if(((p=r==null?void 0:r.length)!=null?p:0)==0)return Wt.debug("No random station names in cache, using fallback"),d($t({cityName:t})),Object.values(ve(t));const a=structuredClone(r),w=a.shift();return d(Lt({cityName:t,names:a})),a.length<3&&d($t({cityName:t})),Object.values(w)}),Se=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:d,svgWidth:u,svgHeight:r}=t,{preference:{toolsPanel:{expand:a}}}=Q(L=>L.app),p=Ot().colorMode==="light"?"#666464":"#D3D3D4",c=Et(e,d,u,r),s=a?410*d/100:0,o=d>30?d>120?50:25:5,x=d/200,i={startX:H(c.xMin+s-o,o),endX:H(c.xMax+s+o,o),startY:H(c.yMin-o,o),endY:H(c.yMax+o,o)},h=Array.from({length:(i.endX-i.startX)/o+1},(L,f)=>{const y=i.startX+f*o,l=y%(o*5)===0?2*x:x;return v.jsx("line",{x1:y,y1:i.startY,x2:y,y2:i.endY,strokeWidth:l,stroke:p,opacity:"0.5"},"grid_vl_".concat(y))}),S=Array.from({length:(i.endY-i.startY)/o+1},(L,f)=>{const y=i.startY+f*o,l=y%(o*5)===0?2*x:x;return v.jsx("line",{x1:i.startX,y1:y,x2:i.endX,y2:y,strokeWidth:l,stroke:p,opacity:"0.5"},"grid_hl_".concat(y))}),_=Array.from({length:(i.endX-i.startX)/o/5+1},(L,f)=>{const y=H(i.startX,5*o)+f*5*o;return v.jsx("text",{x:y,y:c.yMin+d/5,fontSize:x*25,fill:p,textAnchor:"middle",opacity:"0.5",children:y},"grid_vc_".concat(y))}),C=Array.from({length:(i.endY-i.startY)/o/5+1},(L,f)=>{const y=H(i.startY,5*o)+f*5*o;return v.jsx("text",{x:c.xMin+d/8+s,y,fontSize:x*25,fill:p,textAnchor:"start",opacity:"0.5",children:y},"grid_hc_".concat(y))});return v.jsxs("g",{id:"grid-lines",className:"removeMe",children:[h,S,_,C]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Vt=(t,e,d,u,r,a)=>{if(!("offsetFrom"in a)||!("offsetTo"in a)||Number.isNaN(a.offsetFrom)||Number.isNaN(a.offsetTo))return;if(a.offsetFrom===a.offsetTo)return Tt(t,e,d,u,r)?{x1:e,y1:d,x2:u,y2:r,offset:a.offsetFrom}:void 0;const[w,p]=[a.offsetFrom,a.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let s=c,o=0;o<2;o++,s+=Math.PI){const[x,i,h,S]=[Math.sin(c)*w,Math.cos(c)*w,Math.sin(s)*p,Math.cos(s)*p];if(Tt(t,e+x,d+i,u+h,r+S))return{x1:e+x,y1:d+i,x2:u+h,y2:r+S,offset:0}}},be=(t,e,d,u,r,a)=>t===d?{x1:t+5*a,y1:e,x2:d+5*a,y2:u,offset:r}:e===u?{x1:t,y1:e+5*a,x2:d,y2:u+5*a,offset:r}:{x1:t+5*Math.SQRT1_2*a,y1:e+5*Math.SQRT1_2*a,x2:d+5*Math.SQRT1_2*a,y2:u+5*Math.SQRT1_2*a,offset:r},Tt=(t,e,d,u,r)=>!!((e===u||d===r)&&[Z.Diagonal,Z.Perpendicular].includes(t)||Math.abs((r-d)/(u-e))===1&&[Z.Diagonal,Z.RotatePerpendicular].includes(t)),Ae=(t,e)=>{const d=[],u=[];return Object.values(e).forEach(r=>{var L;if(r.length===1){u.push(...r.map(f=>f.edge));return}const a=t.getEdgeAttribute(r.at(0),"type");if(!r.every(f=>t.getEdgeAttribute(f,"type")===a)){u.push(...r.map(f=>f.edge));return}const w=t.getEdgeAttribute(r.at(0),"style");if(!r.every(f=>t.getEdgeAttribute(f,"style")===w)){u.push(...r.map(f=>f.edge));return}const p={},c=new Set,s=new Set,o=Object.fromEntries(r.map(f=>{var M,B;const[y,l]=t.extremities(f);return p[y]=((M=p[y])!=null?M:0)+1,p[l]=((B=p[l])!=null?B:0)+1,c.add(y),s.add(l),[y,[f.edge,l]]})),x=Array.from(c).filter(f=>p[f]===1),i=Array.from(s).filter(f=>p[f]===1);if(x.length!==1||i.length!==1){u.push(...r.map(f=>f.edge));return}const h=x[0],S=i[0];if(h===S){u.push(...r.map(f=>f.edge));return}const _=[o[h][0]];let C=o[h][1];for(let f=1;f<r.length;f=f+1){const y=(L=o[C])==null?void 0:L.at(1);if(!y){u.push(...r.map(l=>l.edge));return}_.push(o[C][0]),C=y}if(C!==S||_.length!==r.length){u.push(...r.map(f=>f.edge));return}d.push(_)}),{allReconciledLines:d,danglingLines:u}},we=(t,e)=>{if(!e.every(r=>t.hasEdge(r)))return;const d=e.map(r=>{var i,h,S;const[a,w]=t.extremities(r),p=t.getNodeAttributes(a),c=t.getNodeAttributes(w),{type:s}=t.getEdgeAttributes(r),o=(i=t.getEdgeAttribute(r,s))!=null?i:F[s].defaultAttrs,x=Vt(s,p.x,p.y,c.x,c.y,o);if(x){const{x1:_,y1:C,x2:L,y2:f,offset:y}=x;return F[Z.Simple].generatePath(_,L,C,f,{offset:y})}return(S=(h=F[s])==null?void 0:h.generatePath(p.x,c.x,p.y,c.y,o))!=null?S:"M ".concat(p.x," ").concat(p.y," L ").concat(c.x," ").concat(c.y)});let u="".concat(d[0]," ");for(let r=1;r<e.length;r=r+1)u+=d[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return u},Pe=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ke=t=>{const e={},d={},u=[],r={},a=[];for(const s of t.edgeEntries()){const[o,x,i,h]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y],S=s.attributes[s.attributes.type],_=Vt(s.attributes.type,o,x,i,h,S);d[s.edge]=_}for(const s of t.edgeEntries()){let o=d[s.edge];const{parallelIndex:x}=s.attributes;if(x>=0){const i=Ut(t,s.attributes.type,s.edge),h=d[i];if(!h){u.push(s);continue}if(x>0){const{x1:S,y1:_,x2:C,y2:L,offset:f}=h;o=be(S,_,C,L,f,x)}}if(s.attributes.reconcileId!==""){const i=s.attributes.reconcileId;i in r?r[i].push(s):r[i]=[s];continue}if(o){const i=s.edge,h=s.attributes,{x1:S,y1:_,x2:C,y2:L,offset:f}=o;e[i]={attr:h,path:F[Z.Simple].generatePath(S,C,_,L,{offset:f})};continue}a.push(s)}const w=new Set;for(;u.length;){const s=u.pop();if(w.has(s.edge))continue;const{parallel:o}=qt(t,s);if(!o.length)continue;o.forEach(i=>w.add(i.edge));const x=Gt(o);for(const i of o){const h=i.edge;e[h]={attr:i.attributes,path:x[h]}}}const{allReconciledLines:p,danglingLines:c}=Ae(t,r);for(const s of p){const o=we(t,s);if(!o)continue;const x=s[0];e[x]={attr:t.getEdgeAttributes(x),path:o}}for(const s of c){const o=t.getEdgeAttributes(s),[x,i]=t.extremities(s),h=t.getNodeAttributes(x),S=t.getNodeAttributes(i);e[s]={attr:o,path:F[Z.Simple].generatePath(h.x,S.x,h.y,S.y,F[Z.Simple].defaultAttrs)}}for(const s of a){const o=s.edge,x=s.attributes.type,i=s.attributes,[h,S,_,C]=[s.sourceAttributes.x,s.sourceAttributes.y,s.targetAttributes.x,s.targetAttributes.y];if(!(x in F)){e[o]={attr:i,path:"M ".concat(h," ").concat(S," L ").concat(_," ").concat(C)};continue}e[o]={attr:i,path:F[x].generatePath(h,_,S,C,i[x])}}return Object.entries(e).map(([s,o])=>({id:s,type:"line",line:o}))},Me=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:d}=Q(i=>i.param),u=i=>{const S=[{x:i.x,y:i.y},...i.originalNodesPos].sort((C,L)=>C.x===L.x?C.y-L.y:C.x-L.x),_=(S[1].y-S[0].y)/(S[1].x-S[0].x);if(Math.abs(_)<=.01)return{original:S,offset:S.map(C=>({x:C.x,y:C.y+10})),rotate:0};if(Math.abs(_)>=1e10)return{original:S,offset:S.map(C=>({x:C.x+10,y:C.y})),rotate:90};{const L=-1/_,f=10/Math.sqrt(L*L+1),y=10*L/Math.sqrt(L*L+1);return{original:S,offset:S.map(l=>({x:l.x+f,y:l.y+y})),rotate:-Math.atan(L)*(180/Math.PI)}}},{original:r,offset:a,rotate:w}=u(e),p=i=>{const h=Math.sqrt(3)/2*i,S="0,0",_="".concat(-i/2,",").concat(h),C="".concat(i/2,",").concat(h);return"".concat(S," ").concat(_," ").concat(C)},c=d/75,s=8*c,o="#FC8181",x="".concat(c*5," ").concat(c*2);return v.jsxs(v.Fragment,{children:[v.jsx("line",{x1:a[0].x,y1:a[0].y,x2:a[1].x,y2:a[1].y,stroke:o,strokeWidth:c,strokeDasharray:x}),v.jsx("line",{x1:a[1].x,y1:a[1].y,x2:a[2].x,y2:a[2].y,stroke:o,strokeWidth:c,strokeDasharray:x}),v.jsx("line",{x1:r[0].x,y1:r[0].y,x2:a[0].x,y2:a[0].y,stroke:o,strokeWidth:c,strokeDasharray:x}),v.jsx("line",{x1:r[1].x,y1:r[1].y,x2:a[1].x,y2:a[1].y,stroke:o,strokeWidth:c,strokeDasharray:x}),v.jsx("line",{x1:r[2].x,y1:r[2].y,x2:a[2].x,y2:a[2].y,stroke:o,strokeWidth:c,strokeDasharray:x}),v.jsx("polygon",{points:p(s),transform:"translate(".concat(a[0].x,",").concat(a[0].y,") rotate(").concat((w+270)%360,")"),fill:o}),v.jsx("polygon",{points:p(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((w+270)%360,")"),fill:o}),v.jsx("polygon",{points:p(s),transform:"translate(".concat(a[1].x,",").concat(a[1].y,") rotate(").concat((w+90)%360,")"),fill:o}),v.jsx("polygon",{points:p(s),transform:"translate(".concat(a[2].x,",").concat(a[2].y,") rotate(").concat((w+90)%360,")"),fill:o})]})},It=t=>{const{id:e,x:d,y:u,handlePointerDown:r,handlePointerMove:a,handlePointerUp:w}=t,p=$.useCallback(o=>r(e,o),[e,r]),c=$.useCallback(o=>a(e,o),[e,a]),s=$.useCallback(o=>w(e,o),[e,w]);return v.jsx("g",{id:e,transform:"translate(".concat(d-6.4," ").concat(u-6.4,")scale(0.025)"),onPointerDown:p,onPointerMove:c,onPointerUp:s,style:{cursor:"move"},children:v.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},Ce=t=>{const{id:e,path:d,handlePointerDown:u}=t,r=$.useCallback(a=>u(e,a),[e,u]);return v.jsx("path",{id:e,d,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:r})},Le=$.memo(t=>{var c,s,o,x,i,h,S,_,C,L,f,y;const{elements:e,handlePointerDown:d,handlePointerMove:u,handlePointerUp:r,handleEdgePointerDown:a}=t,w=Object.fromEntries(Array.from({length:21},(l,M)=>[M-10,{pre:[],main:[],post:[]}]));for(const l of e)if(l.type==="line"){const M=l.line.attr.type,B=l.line.attr.style,Y=l.line.attr[B],D=(c=Ct[B])==null?void 0:c.preComponent;D&&w[l.line.attr.zIndex].pre.push(v.jsx(D,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},"".concat(l.id,".pre")));const V=(o=(s=Ct[B])==null?void 0:s.component)!=null?o:Ce;w[l.line.attr.zIndex].main.push(v.jsx(V,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},l.id));const X=(x=Ct[B])==null?void 0:x.postComponent;X&&w[l.line.attr.zIndex].post.push(v.jsx(X,{id:l.id,type:M,path:l.line.path,styleAttrs:Y,newLine:!1,handlePointerDown:a},"".concat(l.id,".post")))}else if(l.type==="station"){const M=l.station,B=M.type,Y=(i=yt[B])==null?void 0:i.preComponent;Y&&w[l.station.zIndex].pre.push(v.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},"".concat(l.id,".pre")));const D=(S=(h=yt[B])==null?void 0:h.component)!=null?S:It;w[l.station.zIndex].main.push(v.jsx(D,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},l.id));const V=(_=yt[B])==null?void 0:_.postComponent;V&&w[l.station.zIndex].post.push(v.jsx(V,{id:l.id,x:M.x,y:M.y,attrs:M,handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},"".concat(l.id,".post")))}else if(l.type==="misc-node"){const M=l.miscNode,B=M.type,Y=(C=gt[B])==null?void 0:C.preComponent;Y&&w[l.miscNode.zIndex].pre.push(v.jsx(Y,{id:l.id,x:M.x,y:M.y,attrs:M[B],handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},"".concat(l.id,".pre")));const D=(f=(L=gt[B])==null?void 0:L.component)!=null?f:It;w[l.miscNode.zIndex].main.push(v.jsx(D,{id:l.id,x:M.x,y:M.y,attrs:M[B],handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},l.id));const V=(y=gt[B])==null?void 0:y.postComponent;V&&w[l.miscNode.zIndex].post.push(v.jsx(V,{id:l.id,x:M.x,y:M.y,attrs:M[B],handlePointerDown:d,handlePointerMove:u,handlePointerUp:r},"".concat(l.id,".post")))}return Array.from({length:21},(l,M)=>(M-10).toString()).map(l=>[...w[l].pre,...w[l].main,...w[l].post]).flat()},(t,e)=>t.elements===e.elements),_e=[...Object.values(Jt),it.Virtual,it.Master,it.LondonArrow,it.ChongqingRTNumLineBadge2021,it.ChongqingRTTextLineBadge2021,it.ChengduRTLineBadge,it.GzmtrLineBadge],Ee=()=>{const t=Rt(),e=$.useRef(window.graph),d=()=>{t(vt(e.current.export())),t(lt()),t(dt())},{telemetry:{project:u},preference:{autoParallel:r,gridLines:a,snapLines:w}}=Q(k=>k.app),{svgViewBoxZoom:p,svgViewBoxMin:c}=Q(k=>k.param),{selected:s,refresh:{nodes:o,edges:x},mode:i,active:h,keepLastPath:S,theme:_}=Q(k=>k.runtime),C=Ht(),{height:L,width:f}=Xt(C),[y,l]=$.useState(),[M,B]=$.useState({dx:0,dy:0}),[Y,D]=$.useState([]),[V,X]=$.useState([]),[nt,st]=$.useState([]);$.useEffect(()=>{if(!y||!w)return;const k=Et(c,p,f,L),j=Kt(e.current,...Object.values(k));X(j),D(ce(e.current,j))},[c,p,f,L,y]);const[ut,ot]=$.useState(void 0),bt=q((k,j)=>{j.stopPropagation(),i==="select"&&t(tt("free"));const O=j.currentTarget,{x:U,y:R}=et(j);O.setPointerCapture(j.pointerId),st([]),ot(void 0),l({x:U,y:R}),t(ft(k)),j.shiftKey?s.has(k)?t(jt(k)):t(zt(k)):s.has(k)||t(ct(new Set([k])))}),At=q((k,j)=>{const{x:O,y:U}=et(j);if(i==="free"&&h===k){if(!j.altKey&&w){const R=e.current.getNodeAttribute(k,"x"),I=e.current.getNodeAttribute(k,"y"),W=R-(y.x-O)*p/100,n=I-(y.y-U)*p/100;let m=W,b=n;if(le(k,e.current)){let g=nt,P=ut;if(g.length!==0&&(g=g.filter(A=>de(A,W,n)<=6)),P&&(g.length===0||Math.hypot(W-P.x,n-P.y)>6)&&(P=void 0),!P&&g.length===1){const A=g[0],{snapPoint:N,distance:T}=ue(e.current,V.filter(K=>!s.has(K)),W,n,A);T<=3&&(P=N)}if(g.length===1&&!P||g.length===0){const{l:A,d:N}=he(W,n,Y,V.filter(K=>!s.has(K)&&!g.some(at=>at.node===K))),T=g.length===0||!g.some(K=>K.a===A.a&&K.b===A.b);N<3&&g.length<2&&T&&g.push(A)}if(g.length===1)if(P)m=P.x,b=P.y;else{const A=g[0];if(A.a==0)b=-A.c/A.b;else if(A.b==0)m=-A.c/A.a;else{const N=-A.a/A.b,T=-A.c/A.b;b=N*m+T}}else if(g.length===2){const A=g[0],N=g[1],T=A.a*N.b-N.a*A.b;T!==0&&(m=-(A.c*N.b-N.c*A.b)/T,b=-(A.a*N.c-N.a*A.c)/T)}st(g),ot(P)}const E=m-R,z=b-I;s.forEach(g=>{e.current.hasNode(g)&&e.current.updateNodeAttributes(g,P=>({...P,x:H(P.x+E,.01),y:H(P.y+z,.01)}))})}else st([]),ot(void 0),s.forEach(R=>{e.current.hasNode(R)&&e.current.updateNodeAttributes(R,I=>({...I,x:H(I.x-(y.x-O)*p/100,j.altKey?.01:5),y:H(I.y-(y.y-U)*p/100,j.altKey?.01:5)}))});t(lt()),t(dt())}else i.startsWith("line")&&B({dx:(y.x-O)*p/100,dy:(y.y-U)*p/100})}),wt=q((k,j)=>{if(i.startsWith("line")){S||t(tt("free"));const O=e.current.hasNode(h)&&_e.includes(e.current.getNodeAttribute(h,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(R=>{var m,b;const W=(b=(m=document.elementsFromPoint(j.clientX,j.clientY)[0].attributes)==null?void 0:m.getNamedItem("id"))==null?void 0:b.value,n=W==null?void 0:W.startsWith(R);if(O&&n){const E=i.slice(5),z="line_".concat(ht(10)),[g,P]=[h,W.slice(R.length)],A=r?Zt(e.current,E,g,P,"from"):-1;e.current.addDirectedEdgeWithKey(z,g,P,{visible:!0,zIndex:0,type:E,[E]:structuredClone(F[E].defaultAttrs),style:Dt.SingleColor,[Dt.SingleColor]:{color:_},reconcileId:"",parallelIndex:A}),t(ct(new Set([z]))),u&&xt.event(mt.ADD_LINE,{type:E})}}),t(vt(e.current.export())),t(dt())}else if(i==="free"&&h){const{x:O,y:U}=et(j);y.x-O===0&&y.y-U===0||(t(vt(e.current.export())),t(lt()))}st([]),ot(void 0),l(void 0),t(ft(void 0))}),Pt=q((k,j)=>{if(j.stopPropagation(),j.shiftKey||t(St()),j.shiftKey&&s.has(k)?t(jt(k)):t(zt(k)),i.startsWith("station")||i.startsWith("misc-node-virtual")||i.startsWith("misc-node-master")){const O=j.clientX-document.getElementById("canvas").getBoundingClientRect().left,U=j.clientY-document.getElementById("canvas").getBoundingClientRect().top,R=i.startsWith("station"),I=ht(10),W=R?"stn_".concat(I):"misc_node_".concat(I),n=R?i.slice(8):i.slice(10),{x:m,y:b}=J(O,U,p,c),E=R?structuredClone(yt[n].defaultAttrs):structuredClone(gt[n].defaultAttrs);"color"in E&&(E.color=_),e.current.addNode(W,{visible:!0,zIndex:0,x:H(m,5),y:H(b,5),type:n,[n]:E});const z=e.current.getEdgeAttributes(k),{zIndex:g,type:P,style:A}=z,N=z[P],T=z[A],[K,at]=e.current.extremities(k),G=r?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),K,W,{visible:!0,zIndex:g,type:P,[P]:structuredClone(N),style:A,[A]:structuredClone(T),reconcileId:"",parallelIndex:G}),e.current.addDirectedEdgeWithKey("line_".concat(ht(10)),W,at,{visible:!0,zIndex:g,type:P,[P]:structuredClone(N),style:A,[A]:structuredClone(T),reconcileId:"",parallelIndex:G}),e.current.dropEdge(k),d(),u&&(xt.event(mt.ADD_STATION,{type:n}),xt.event(mt.ADD_LINE,{type:P})),t(tt("free")),t(ct(new Set([W])))}}),kt=$.useMemo(()=>[...ke(e.current),...Pe(e.current)],[x,o]),Mt=Qt.component;return v.jsxs(v.Fragment,{children:[v.jsx(Le,{elements:kt,handlePointerDown:bt,handlePointerMove:At,handlePointerUp:wt,handleEdgePointerDown:Pt}),i.startsWith("line")&&h&&h!=="background"&&v.jsx(Mt,{id:"line_create_in_progress___no_use",type:i.slice(5),path:F[i.slice(5)].generatePath(e.current.getNodeAttribute(h,"x"),e.current.getNodeAttribute(h,"x")-M.dx,e.current.getNodeAttribute(h,"y"),e.current.getNodeAttribute(h,"y")-M.dy,F[i.slice(5)].defaultAttrs),styleAttrs:{color:_},newLine:!0,handlePointerDown:()=>{}}),nt.length!==0&&nt.map(k=>v.jsx("path",{d:F[Z.Simple].generatePath(...fe(k,Et(c,p,f,L)),F[Z.Simple].defaultAttrs),stroke:"cyan",strokeWidth:p/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),ut&&v.jsx(Me,{activeSnapPoint:ut})]})},Te=()=>{const t=Rt(),e=$.useRef(window.graph),d=()=>{t(vt(e.current.export())),t(lt()),t(dt())},{activeSubscriptions:u}=Q(n=>n.account),{telemetry:{project:r},preference:{randomStationsNames:a,gridLines:w,snapLines:p}}=Q(n=>n.app),{svgViewBoxZoom:c,svgViewBoxMin:s}=Q(n=>n.param),{mode:o,lastTool:x,active:i,selected:h,keepLastPath:S,theme:_,count:{masters:C,lines:L}}=Q(n=>n.runtime),f=Ht(),{height:y,width:l}=Xt(f),M=!u.RMP_CLOUD&&C+1>te,B=!u.RMP_CLOUD&&L+1>ee,Y=!u.RMP_CLOUD||a==="none";ne();const[D,V]=$.useState({x:0,y:0}),[X,nt]=$.useState({x:0,y:0}),[st,ut]=$.useState({x:0,y:0}),[ot,bt]=$.useState({x:0,y:0}),At=q(async n=>{const{x:m,y:b}=et(n);if(o.startsWith("station")||o.startsWith("misc-node")){t(tt("free"));const E=ht(10),{x:z,y:g}=J(m,b,c,s),P=o.startsWith("station"),A=P?"stn_".concat(E):"misc_node_".concat(E),N=P?o.slice(8):o.slice(10),T=structuredClone({...yt,...gt}[N].defaultAttrs);if(re.has(N)&&(T.color=_),P&&!Y){const K=T.names,at=await t(Bt(_t.Shmetro));if(Bt.fulfilled.match(at)){const G=at.payload;K.length>G.length?G.push(...Array(K.length-G.length).fill(G.at(-1))):K.length<G.length&&G.splice(K.length,G.length-K.length),T.names=G}}e.current.addNode(A,{visible:!0,zIndex:0,x:H(z,5),y:H(g,5),type:N,[N]:T}),d(),r&&xt.event(mt.ADD_STATION,{type:N}),t(ct(new Set([A])))}else o==="free"||o.startsWith("line")?(o.startsWith("line")&&(t(tt("free")),S&&t(ae(!1))),ut({x:m,y:b}),bt(s),n.shiftKey||(t(ft("background")),t(St()))):o==="select"&&(V(J(m,b,c,s)),nt(J(m,b,c,s)))}),wt=q(n=>{if(o==="select"){if(D.x!=0&&D.y!=0){const{x:m,y:b}=et(n);nt(J(m,b,c,s))}}else if(i==="background"){const{x:m,y:b}=et(n);t(pt({x:ot.x+(st.x-m)*c/100,y:ot.y+(st.y-b)*c/100}))}}),Pt=q(n=>{if(o==="select"){const{x:m,y:b}=et(n),{x:E,y:z}=J(m,b,c,s),g=Kt(e.current,D.x,D.y,E,z),P=ge(e.current,new Set(g));t(ct(new Set([...n.shiftKey?h:[],...g,...P]))),t(tt("free")),V({x:0,y:0}),nt({x:0,y:0})}i==="background"&&!n.shiftKey&&t(ft(void 0))}),kt=q(n=>{let m=c;n.deltaY>0&&c+10<400?m=c+10:n.deltaY<0&&c-10>0&&(m=c-10),t(Nt(m));const{x:b,y:E}=et(n),z=n.currentTarget.getBoundingClientRect(),[g,P]=[b/z.width,E/z.height];t(pt({x:s.x+b*c/100-l*m/100*g,y:s.y+E*c/100-y*m/100*P}))}),Mt=q(async n=>{if(rt?n.key==="Backspace":n.key==="Delete")h.size>0&&(h.forEach(m=>{e.current.hasNode(m)?e.current.dropNode(m):e.current.hasEdge(m)&&e.current.dropEdge(m)}),t(St()),d());else if(n.key.startsWith("Arrow")){const b=n.key.endsWith("Left")?-1:n.key.endsWith("Right")?1:0,E=n.key.endsWith("Up")?-1:n.key.endsWith("Down")?1:0;t(pt(J(100*b,100*E,c,s)))}else if(n.key==="i"||n.key==="j"||n.key==="k"||n.key==="l"){const b=(n.key==="j"?-1:n.key==="l"?1:0)*10,E=(n.key==="i"?-1:n.key==="k"?1:0)*10;h.size>0&&h.forEach(z=>{e.current.hasNode(z)&&(e.current.updateNodeAttribute(z,"x",g=>(g!=null?g:0)+b),e.current.updateNodeAttribute(z,"y",g=>(g!=null?g:0)+E),d())})}else if(n.key==="f"&&x)t(tt(x));else if(n.key==="z"&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey))rt&&n.preventDefault(),t(se()),t(lt()),t(dt());else if(n.key==="s")t(tt("select"));else if((n.key==="c"||n.key==="x")&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const m=pe(e.current,h);navigator.clipboard.writeText(m),n.key==="x"&&(t(St()),h.forEach(b=>{e.current.hasNode(b)?e.current.dropNode(b):e.current.hasEdge(b)&&e.current.dropEdge(b)}),d())}else if(n.key==="v"&&(rt?n.metaKey&&!n.shiftKey:n.ctrlKey)){const m=await navigator.clipboard.readText(),{x:b,y:E}=J(l/2,y/2,c,s),{nodes:z,edges:g}=xe(m,e.current,M,B,H(b,5),H(E,5));d();const P=structuredClone(z);g.forEach(A=>P.add(A)),t(ct(P))}else rt&&n.key==="z"&&n.metaKey&&n.shiftKey||!rt&&n.key==="y"&&n.ctrlKey?(t(oe()),t(lt()),t(dt())):n.key==="c"&&t(ie(!p))}),[k,j]=$.useState(0),O=q(n=>{if(n.touches.length===2){t(ft(void 0));const[m,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY];j(m*m+b*b)}}),U=q(n=>{if(k!==0&&n.touches.length===2){const[m,b]=[n.touches[0].clientX-n.touches[1].clientX,n.touches[0].clientY-n.touches[1].clientY],E=m*m+b*b;let z=c;E-k<0&&c+10<=390?z=c+10:E-k>0&&c-10>=10&&(z=c-10),t(Nt(z)),j(E);const g=n.currentTarget.getBoundingClientRect(),[P,A]=[(n.touches[0].clientX+n.touches[1].clientX)/2-g.left,(n.touches[0].clientY+n.touches[1].clientY)/2-g.top],[N,T]=[P/g.width,A/g.height];t(pt({x:s.x+P*c/100-l*z/100*N,y:s.y+A*c/100-y*z/100*T}))}}),R=q(n=>{k!==0&&j(0)}),[I,W]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{W({sx:D.x<=X.x?D.x:X.x,ex:D.x>X.x?D.x:X.x,sy:D.y<=X.y?D.y:X.y,ey:D.y>X.y?D.y:X.y})},[X.x,X.y]),v.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:y,width:l,viewBox:"".concat(s.x," ").concat(s.y," ").concat(l*c/100," ").concat(y*c/100),onPointerDown:At,onPointerMove:wt,onPointerUp:Pt,onTouchStart:O,onTouchMove:U,onTouchEnd:R,onWheel:kt,tabIndex:0,onKeyDown:Mt,children:[w&&v.jsx(Se,{svgViewBoxMin:s,svgViewBoxZoom:c,svgWidth:l,svgHeight:y}),v.jsx(ye.SvgAssetsContextProvider,{children:v.jsx(Ee,{})}),o==="select"&&D.x!=0&&D.y!=0&&v.jsx("rect",{x:I.sx,y:I.sy,width:I.ex-I.sx,height:I.ey-I.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),v.jsx("defs",{children:v.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[v.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),v.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{Te as default};

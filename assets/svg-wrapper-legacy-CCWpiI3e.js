!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-BwGWQky_.js","./index-legacy-UkXgvZ7x.js","./master-manager-legacy-ure1Hi80.js","./react-legacy-B-tEtBDe.js","./clipboard-legacy-CU6Ebd-O.js","./misc-nodes-legacy-BXi60l-D.js"],(function(e,n){"use strict";var r,o,s,i,a,l,c,d,u,h,y,x,g,p,f,m,v,b,w,j,P,k,A,M,N,$,z,S,D,E,_,C,W,I,O,H,T,B,L,R,K,X,Y,U,V,F,q,Z,Q,J,G,ee,te,ne,re,oe,se,ie,ae,le,ce,de,ue,he;return{setters:[e=>{r=e.j,o=e.ad},e=>{s=e.N,i=e.ar,a=e.as,l=e.a3,c=e.k,d=e.o,u=e.at,h=e.au,y=e.av,x=e.aw,g=e.d,p=e.c,f=e.p,m=e.ax,v=e.ay,b=e.az,w=e.aA,j=e.T,P=e.aB,k=e.aC,A=e.aD,M=e.q,N=e.t,$=e.aE,z=e.n,S=e.m,D=e.l,E=e.r,_=e.E,C=e.v,W=e.y,I=e.U,O=e.aF,H=e.aG,T=e.S,B=e.aH,L=e.a0,R=e.ab,K=e.A,X=e.ao,Y=e.ap,U=e.z,V=e.a1},e=>{F=e.s,q=e.u,Z=e.f,Q=e.g,J=e.b,G=e.c,ee=e.e,te=e.h,ne=e.j,re=e.F,oe=e.l,se=e.S,ie=e.k},e=>{ae=e.j,le=e.b},e=>{ce=e.u,de=e.e,ue=e.i},e=>{he=e.m}],execute:function(){const n={[l.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[l.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ye=ae("runtime/getStationNames",(async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:o}=t().account;if(!o)return void n(i({cityName:e,names:[]}));const l=await fetch(`${a}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${o}`}});if(!l.ok)return s.warn("Failed to fetch random station names",l.statusText),r(l.statusText);const c=await l.json();n(i({cityName:e,names:c}))})),xe=ae("runtime/getOneStationName",(async(e,{getState:t,dispatch:r})=>{var o;const{stationNames:a}=t().runtime,l=a[e];if(0==(null!==(o=null==l?void 0:l.length)&&void 0!==o?o:0))return s.debug("No random station names in cache, using fallback"),r(ye({cityName:e})),Object.values((e=>{const t=n[e];return t.at(Math.floor(Math.random()*t.length))})(e));const c=structuredClone(l),d=c.shift();return r(i({cityName:e,names:c})),c.length<3&&r(ye({cityName:e})),Object.values(d)})),ge=(e,t,n,r,o,s)=>{if(!("offsetFrom"in s)||!("offsetTo"in s))return;if(Number.isNaN(s.offsetFrom)||Number.isNaN(s.offsetTo))return;if(s.offsetFrom===s.offsetTo)return fe(e,t,n,r,o)?{x1:t,y1:n,x2:r,y2:o,offset:s.offsetFrom}:void 0;const[i,a]=[s.offsetFrom,s.offsetTo];for(let l=0;l<Math.PI;l+=Math.PI/8)for(let s=l,c=0;c<2;c++,s+=Math.PI){const[c,d,u,h]=[Math.sin(l)*i,Math.cos(l)*i,Math.sin(s)*a,Math.cos(s)*a];if(fe(e,t+c,n+d,r+u,o+h))return{x1:t+c,y1:n+d,x2:r+u,y2:o+h,offset:0}}},pe=(e,t,n,r,o,s)=>e===n?{x1:e+5*s,y1:t,x2:n+5*s,y2:r,offset:o}:t===r?{x1:e,y1:t+5*s,x2:n,y2:r+5*s,offset:o}:{x1:e+5*Math.SQRT1_2*s,y1:t+5*Math.SQRT1_2*s,x2:n+5*Math.SQRT1_2*s,y2:r+5*Math.SQRT1_2*s,offset:o},fe=(e,t,n,r,o)=>!(t!==r&&n!==o||![c.Diagonal,c.Perpendicular].includes(e))||!(1!==Math.abs((o-n)/(r-t))||![c.Diagonal,c.RotatePerpendicular].includes(e)),me=(e,t)=>{if(!t.every((t=>e.hasEdge(t))))return;const n=t.map((t=>{var n,r,o;const[s,i]=e.extremities(t),a=e.getNodeAttributes(s),l=e.getNodeAttributes(i),{type:u}=e.getEdgeAttributes(t),h=null!==(n=e.getEdgeAttribute(t,u))&&void 0!==n?n:d[u].defaultAttrs,y=ge(u,a.x,a.y,l.x,l.y,h);if(y){const{x1:e,y1:t,x2:n,y2:r,offset:o}=y;return d[c.Simple].generatePath(e,n,t,r,{offset:o})}return null!==(r=null===(o=d[u])||void 0===o?void 0:o.generatePath(a.x,l.x,a.y,l.y,h))&&void 0!==r?r:`M ${a.x} ${a.y} L ${l.x} ${l.y}`}));let r=`${n[0]} `;for(let o=1;o<t.length;o+=1)r+=n[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},ve=e=>[...e.nodeEntries()].map((e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes})),be=e=>{const t={},n={},r=[],o={},s=[];for(const c of e.edgeEntries()){const[e,t,r,o]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y],s=c.attributes[c.attributes.type],i=ge(c.attributes.type,e,t,r,o,s);n[c.edge]=i}for(const h of e.edgeEntries()){let i=n[h.edge];const{parallelIndex:a}=h.attributes;if(a>=0){const t=n[u(e,h.attributes.type,h.edge)];if(!t){r.push(h);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:o,offset:s}=t;i=pe(e,n,r,o,s,a)}}if(""===h.attributes.reconcileId)if(i){const e=h.edge,n=h.attributes,{x1:r,y1:o,x2:s,y2:a,offset:l}=i;t[e]={attr:n,path:d[c.Simple].generatePath(r,s,o,a,{offset:l})}}else s.push(h);else{const e=h.attributes.reconcileId;e in o?o[e].push(h):o[e]=[h]}}const i=new Set;for(;r.length;){const n=r.pop();if(i.has(n.edge))continue;const{parallel:o}=h(e,n);if(!o.length)continue;o.forEach((e=>i.add(e.edge)));const s=y(o);for(const e of o){const n=e.edge;t[n]={attr:e.attributes,path:s[n]}}}const{allReconciledLines:a,danglingLines:l}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach((t=>{if(1===t.length)return void r.push(...t.map((e=>e.edge)));const o=e.getEdgeAttribute(t.at(0),"type");if(!t.every((t=>e.getEdgeAttribute(t,"type")===o)))return void r.push(...t.map((e=>e.edge)));const s=e.getEdgeAttribute(t.at(0),"style");if(!t.every((t=>e.getEdgeAttribute(t,"style")===s)))return void r.push(...t.map((e=>e.edge)));const i={},a=new Set,l=new Set,c=Object.fromEntries(t.map((t=>{var n,r;const[o,s]=e.extremities(t);return i[o]=(null!==(n=i[o])&&void 0!==n?n:0)+1,i[s]=(null!==(r=i[s])&&void 0!==r?r:0)+1,a.add(o),l.add(s),[o,[t.edge,s]]}))),d=Array.from(a).filter((e=>1===i[e])),u=Array.from(l).filter((e=>1===i[e]));if(1!==d.length||1!==u.length)return void r.push(...t.map((e=>e.edge)));const h=d[0],y=u[0];if(h===y)return void r.push(...t.map((e=>e.edge)));const x=[c[h][0]];let g=c[h][1];for(let e=1;e<t.length;e+=1){var p;const e=null===(p=c[g])||void 0===p?void 0:p.at(1);if(!e)return void r.push(...t.map((e=>e.edge)));x.push(c[g][0]),g=e}g===y&&x.length===t.length?n.push(x):r.push(...t.map((e=>e.edge)))})),{allReconciledLines:n,danglingLines:r}})(e,o);for(const c of a){const n=me(e,c);if(!n)continue;const r=c[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const u of l){const n=e.getEdgeAttributes(u),[r,o]=e.extremities(u),s=e.getNodeAttributes(r),i=e.getNodeAttributes(o);t[u]={attr:n,path:d[c.Simple].generatePath(s.x,i.x,s.y,i.y,d[c.Simple].defaultAttrs)}}for(const c of s){const e=c.edge,n=c.attributes.type,r=c.attributes,[o,s,i,a]=[c.sourceAttributes.x,c.sourceAttributes.y,c.targetAttributes.x,c.targetAttributes.y];n in d?t[e]={attr:r,path:d[n].generatePath(o,i,s,a,r[n])}:t[e]={attr:r,path:`M ${o} ${s} L ${i} ${a}`}}return Object.entries(t).map((([e,t])=>({id:e,type:"line",line:t})))},we=e=>{const{id:t,x:n,y:o,handlePointerDown:s,handlePointerMove:i,handlePointerUp:a}=e,l=le.useCallback((e=>s(t,e)),[t,s]),c=le.useCallback((e=>i(t,e)),[t,i]),d=le.useCallback((e=>a(t,e)),[t,a]);return r.jsx("g",{id:t,transform:`translate(${n-6.4} ${o-6.4})scale(0.025)`,onPointerDown:l,onPointerMove:c,onPointerUp:d,style:{cursor:"move"},children:r.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},je=e=>{const{id:t,path:n,handlePointerDown:o}=e,s=le.useCallback((e=>o(t,e)),[t,o]);return r.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:s})},Pe=le.memo((e=>{const{elements:t,handlePointerDown:n,handlePointerMove:o,handlePointerUp:s,handleEdgePointerDown:i}=e,a=Object.fromEntries(Array.from({length:21},((e,t)=>[t-10,{pre:[],main:[],post:[]}])));for(const w of t)if("line"===w.type){var l,c,d,u;const e=w.line.attr.type,t=w.line.attr.style,n=w.line.attr[t],o=null===(l=x[t])||void 0===l?void 0:l.preComponent;o&&a[w.line.attr.zIndex].pre.push(r.jsx(o,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${w.id}.pre`));const s=null!==(c=null===(d=x[t])||void 0===d?void 0:d.component)&&void 0!==c?c:je;a[w.line.attr.zIndex].main.push(r.jsx(s,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},w.id));const h=null===(u=x[t])||void 0===u?void 0:u.postComponent;h&&a[w.line.attr.zIndex].post.push(r.jsx(h,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${w.id}.post`))}else if("station"===w.type){var h,y,g,p;const e=w.station,t=e.type,i=null===(h=F[t])||void 0===h?void 0:h.preComponent;i&&a[w.station.zIndex].pre.push(r.jsx(i,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},`${w.id}.pre`));const l=null!==(y=null===(g=F[t])||void 0===g?void 0:g.component)&&void 0!==y?y:we;a[w.station.zIndex].main.push(r.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},w.id));const c=null===(p=F[t])||void 0===p?void 0:p.postComponent;c&&a[w.station.zIndex].post.push(r.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},`${w.id}.post`))}else if("misc-node"===w.type){var f,m,v,b;const e=w.miscNode,t=e.type,i=null===(f=he[t])||void 0===f?void 0:f.preComponent;i&&a[w.miscNode.zIndex].pre.push(r.jsx(i,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},`${w.id}.pre`));const l=null!==(m=null===(v=he[t])||void 0===v?void 0:v.component)&&void 0!==m?m:we;a[w.miscNode.zIndex].main.push(r.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},w.id));const c=null===(b=he[t])||void 0===b?void 0:b.postComponent;c&&a[w.miscNode.zIndex].post.push(r.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:o,handlePointerUp:s},`${w.id}.post`))}return Array.from({length:21},((e,t)=>(t-10).toString())).map((e=>[...a[e].pre,...a[e].main,...a[e].post])).flat()}),((e,t)=>e.elements===t.elements)),ke=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=g((e=>e.param)),{original:o,offset:s,rotate:i}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort(((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x)),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map((e=>({x:e.x,y:e.y+10}))),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map((e=>({x:e.x+10,y:e.y}))),rotate:90};{const e=10,r=-1/n,o=e/Math.sqrt(r*r+1),s=e*r/Math.sqrt(r*r+1);return{original:t,offset:t.map((e=>({x:e.x+o,y:e.y+s}))),rotate:-Math.atan(r)*(180/Math.PI)}}})(t),a=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${`${-e/2},${t}`} ${`${e/2},${t}`}`},l=n/75,c=8*l,d="#FC8181",u=`${5*l} ${2*l}`;return r.jsxs(r.Fragment,{children:[r.jsx("line",{x1:s[0].x,y1:s[0].y,x2:s[1].x,y2:s[1].y,stroke:d,strokeWidth:l,strokeDasharray:u}),r.jsx("line",{x1:s[1].x,y1:s[1].y,x2:s[2].x,y2:s[2].y,stroke:d,strokeWidth:l,strokeDasharray:u}),r.jsx("line",{x1:o[0].x,y1:o[0].y,x2:s[0].x,y2:s[0].y,stroke:d,strokeWidth:l,strokeDasharray:u}),r.jsx("line",{x1:o[1].x,y1:o[1].y,x2:s[1].x,y2:s[1].y,stroke:d,strokeWidth:l,strokeDasharray:u}),r.jsx("line",{x1:o[2].x,y1:o[2].y,x2:s[2].x,y2:s[2].y,stroke:d,strokeWidth:l,strokeDasharray:u}),r.jsx("polygon",{points:a(c),transform:`translate(${s[0].x},${s[0].y}) rotate(${(i+270)%360})`,fill:d}),r.jsx("polygon",{points:a(c),transform:`translate(${s[1].x},${s[1].y}) rotate(${(i+270)%360})`,fill:d}),r.jsx("polygon",{points:a(c),transform:`translate(${s[1].x},${s[1].y}) rotate(${(i+90)%360})`,fill:d}),r.jsx("polygon",{points:a(c),transform:`translate(${s[2].x},${s[2].y}) rotate(${(i+90)%360})`,fill:d})]})},Ae=[...Object.values(T),$.Virtual,$.Master,$.LondonArrow,$.ChongqingRTNumLineBadge2021,$.ChongqingRTTextLineBadge2021,$.ChengduRTLineBadge],Me=()=>{const e=p(),n=le.useRef(window.graph),{telemetry:{project:o},preference:{autoParallel:s,gridLines:i,snapLines:a}}=g((e=>e.app)),{svgViewBoxZoom:l,svgViewBoxMin:u}=g((e=>e.param)),{selected:h,refresh:{nodes:y,edges:x},mode:$,active:T,keepLastPath:B,theme:L}=g((e=>e.runtime)),R=q(),{height:K,width:X}=f(R),[Y,U]=le.useState(),[V,ne]=le.useState({dx:0,dy:0}),[re,oe]=le.useState([]),[se,ie]=le.useState([]),[ae,de]=le.useState([]);le.useEffect((()=>{if(!Y||!a)return;const e=m(u,l,X,K),t=Z(n.current,...Object.values(e));ie(t),oe(Q(n.current,t))}),[u,l,X,K,Y]);const[ue,ye]=le.useState(void 0),xe=ce(((t,n)=>{n.stopPropagation(),"select"===$&&e(v("free"));const r=n.currentTarget,{x:o,y:s}=b(n);r.setPointerCapture(n.pointerId),de([]),ye(void 0),U({x:o,y:s}),e(w(t)),n.shiftKey?h.has(t)?e(P(t)):e(k(t)):h.has(t)||e(j(new Set([t])))})),ge=ce(((r,o)=>{const{x:s,y:i}=b(o);if("free"===$&&T===r){if(!o.altKey&&a){const e=n.current.getNodeAttribute(r,"x"),o=n.current.getNodeAttribute(r,"y"),a=e-(Y.x-s)*l/100,c=o-(Y.y-i)*l/100;let d=a,u=c;if(J(r,n.current)){let e=ae,t=ue;if(0!==e.length&&(e=e.filter((e=>G(e,a,c)<=6))),t&&(0===e.length||Math.hypot(a-t.x,c-t.y)>6)&&(t=void 0),!t&&1===e.length){const r=e[0],{snapPoint:o,distance:s}=ee(n.current,se.filter((e=>!h.has(e))),a,c,r);s<=3&&(t=o)}if(1===e.length&&!t||0===e.length){const{l:t,d:n}=te(a,c,re,se.filter((t=>!h.has(t)&&!e.some((e=>e.node===t))))),r=0===e.length||!e.some((e=>e.a===t.a&&e.b===t.b));n<3&&e.length<2&&r&&e.push(t)}if(1===e.length)if(t)d=t.x,u=t.y;else{const t=e[0];if(0==t.a)u=-t.c/t.b;else if(0==t.b)d=-t.c/t.a;else{u=-t.a/t.b*d+-t.c/t.b}}else if(2===e.length){const t=e[0],n=e[1],r=t.a*n.b-n.a*t.b;0!==r&&(d=-(t.c*n.b-n.c*t.b)/r,u=-(t.a*n.c-n.a*t.c)/r)}de(e),ye(t)}const y=d-e,x=u-o;h.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:A(e.x+y,.01),y:A(e.y+x,.01)})))}))}else de([]),ye(void 0),h.forEach((e=>{n.current.hasNode(e)&&n.current.updateNodeAttributes(e,(e=>t(t({},e),{},{x:A(e.x-(Y.x-s)*l/100,o.altKey?.01:5),y:A(e.y-(Y.y-i)*l/100,o.altKey?.01:5)})))}));e(M()),e(N())}else $.startsWith("line")&&ne({dx:(Y.x-s)*l/100,dy:(Y.y-i)*l/100})})),pe=ce(((t,r)=>{if($.startsWith("line")){B||e(v("free"));const t=n.current.hasNode(T)&&Ae.includes(n.current.getNodeAttribute(T,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach((i=>{var a;const l=null===(a=document.elementsFromPoint(r.clientX,r.clientY)[0].attributes)||void 0===a||null===(a=a.getNamedItem("id"))||void 0===a?void 0:a.value,c=null==l?void 0:l.startsWith(i);if(t&&c){const t=$.slice(5),r=`line_${z(10)}`,[a,c]=[T,l.slice(i.length)],u=s?S(n.current,t,a,c,"from"):-1;n.current.addDirectedEdgeWithKey(r,a,c,{visible:!0,zIndex:0,type:t,[t]:structuredClone(d[t].defaultAttrs),style:D.SingleColor,[D.SingleColor]:{color:L},reconcileId:"",parallelIndex:u}),e(j(new Set([r]))),o&&E.event(_.ADD_LINE,{type:t})}})),e(N()),e(C(n.current.export()))}else if("free"===$&&T){const{x:t,y:o}=b(r);Y.x-t==0&&Y.y-o==0||e(C(n.current.export()))}de([]),ye(void 0),U(void 0),e(w(void 0))})),fe=ce(((t,r)=>{if(r.stopPropagation(),r.shiftKey||e(W()),r.shiftKey&&h.has(t)?e(P(t)):e(k(t)),$.startsWith("station")||$.startsWith("misc-node-virtual")||$.startsWith("misc-node-master")){const i=r.clientX-document.getElementById("canvas").getBoundingClientRect().left,a=r.clientY-document.getElementById("canvas").getBoundingClientRect().top,c=$.startsWith("station"),d=z(10),h=c?`stn_${d}`:`misc_node_${d}`,y=c?$.slice(8):$.slice(10),{x:x,y:g}=I(i,a,l,u),p=c?structuredClone(F[y].defaultAttrs):structuredClone(he[y].defaultAttrs);"color"in p&&(p.color=L),n.current.addNode(h,{visible:!0,zIndex:0,x:A(x,5),y:A(g,5),type:y,[y]:p});const f=n.current.getEdgeAttributes(t),{zIndex:m,type:b,style:w}=f,P=f[b],k=f[w],[S,D]=n.current.extremities(t),W=s?0:-1;n.current.addDirectedEdgeWithKey(`line_${z(10)}`,S,h,{visible:!0,zIndex:m,type:b,[b]:structuredClone(P),style:w,[w]:structuredClone(k),reconcileId:"",parallelIndex:W}),n.current.addDirectedEdgeWithKey(`line_${z(10)}`,h,D,{visible:!0,zIndex:m,type:b,[b]:structuredClone(P),style:w,[w]:structuredClone(k),reconcileId:"",parallelIndex:W}),n.current.dropEdge(t),e(M()),e(N()),e(C(n.current.export())),o&&(E.event(_.ADD_STATION,{type:y}),E.event(_.ADD_LINE,{type:b})),e(v("free")),e(j(new Set([h])))}})),me=le.useMemo((()=>[...be(n.current),...ve(n.current)]),[x,y]),we=O.component;return r.jsxs(r.Fragment,{children:[r.jsx(Pe,{elements:me,handlePointerDown:xe,handlePointerMove:ge,handlePointerUp:pe,handleEdgePointerDown:fe}),$.startsWith("line")&&T&&"background"!==T&&r.jsx(we,{id:"line_create_in_progress___no_use",type:$.slice(5),path:d[$.slice(5)].generatePath(n.current.getNodeAttribute(T,"x"),n.current.getNodeAttribute(T,"x")-V.dx,n.current.getNodeAttribute(T,"y"),n.current.getNodeAttribute(T,"y")-V.dy,d[$.slice(5)].defaultAttrs),styleAttrs:{color:L},newLine:!0,handlePointerDown:()=>{}}),0!==ae.length&&ae.map((e=>r.jsx("path",{d:d[c.Simple].generatePath(...H(e,m(u,l,X,K)),d[c.Simple].defaultAttrs),stroke:"cyan",strokeWidth:l/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`))),ue&&r.jsx(ke,{activeSnapPoint:ue})]})},Ne=le.memo((e=>{const{svgViewBoxMin:t,svgViewBoxZoom:n,svgWidth:s,svgHeight:i}=e,{preference:{toolsPanel:{expand:a}}}=g((e=>e.app)),l="light"===o().colorMode?"#666464":"#D3D3D4",c=m(t,n,s,i),d=a?410*n/100:0,u=n>30?n>120?50:25:5,h=n/200,y={startX:A(c.xMin+d-u,u),endX:A(c.xMax+d+u,u),startY:A(c.yMin-u,u),endY:A(c.yMax+u,u)},x=Array.from({length:(y.endX-y.startX)/u+1},((e,t)=>{const n=y.startX+t*u,o=n%(5*u)==0?2*h:h;return r.jsx("line",{x1:n,y1:y.startY,x2:n,y2:y.endY,strokeWidth:o,stroke:l,opacity:"0.5"},`grid_vl_${n}`)})),p=Array.from({length:(y.endY-y.startY)/u+1},((e,t)=>{const n=y.startY+t*u,o=n%(5*u)==0?2*h:h;return r.jsx("line",{x1:y.startX,y1:n,x2:y.endX,y2:n,strokeWidth:o,stroke:l,opacity:"0.5"},`grid_hl_${n}`)})),f=Array.from({length:(y.endX-y.startX)/u/5+1},((e,t)=>{const o=A(y.startX,5*u)+5*t*u;return r.jsx("text",{x:o,y:c.yMin+n/5,fontSize:25*h,fill:l,textAnchor:"middle",opacity:"0.5",children:o},`grid_vc_${o}`)})),v=Array.from({length:(y.endY-y.startY)/u/5+1},((e,t)=>{const o=A(y.startY,5*u)+5*t*u;return r.jsx("text",{x:c.xMin+n/8+d,y:o,fontSize:25*h,fill:l,textAnchor:"start",opacity:"0.5",children:o},`grid_hc_${o}`)}));return r.jsxs("g",{id:"grid-lines",className:"removeMe",children:[x,p,f,v]})}),((e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight));e("default",(()=>{const e=p(),n=le.useRef(window.graph),o=()=>{e(M()),e(N()),e(C(n.current.export()))},{activeSubscriptions:s}=g((e=>e.account)),{telemetry:{project:i},preference:{randomStationsNames:a,gridLines:c}}=g((e=>e.app)),{svgViewBoxZoom:d,svgViewBoxMin:u}=g((e=>e.param)),{mode:h,lastTool:y,active:x,selected:m,keepLastPath:P,theme:k,refresh:{nodes:$},masterNodesCount:S,parallelLinesCount:D}=g((e=>e.runtime)),O=q(),{height:H,width:T}=f(O),Q=!s.RMP_CLOUD&&S+1>B,J=!s.RMP_CLOUD&&D+1>L,G=!s.RMP_CLOUD||"none"===a;le.useEffect((()=>{const e=ne(n.current);Object.entries(e).filter((([e,t])=>t&&e in re)).forEach((([e])=>oe(e)))}),[$]);const[ee,te]=le.useState({x:0,y:0}),[ae,ye]=le.useState({x:0,y:0}),[ge,pe]=le.useState({x:0,y:0}),[fe,me]=le.useState({x:0,y:0}),ve=ce((async r=>{const{x:s,y:a}=b(r);if(h.startsWith("station")||h.startsWith("misc-node")){e(v("free"));const r=z(10),{x:c,y:y}=I(s,a,d,u),x=h.startsWith("station"),g=x?`stn_${r}`:`misc_node_${r}`,p=x?h.slice(8):h.slice(10),f=structuredClone(t(t({},F),he)[p].defaultAttrs);if("color"in f&&(f.color=k),x&&!G){const t=f.names,n=await e(xe(l.Shmetro));if(xe.fulfilled.match(n)){const e=n.payload;t.length>e.length?e.push(...Array(t.length-e.length).fill(e.at(-1))):t.length<e.length&&e.splice(t.length,e.length-t.length),f.names=e}}n.current.addNode(g,{visible:!0,zIndex:0,x:A(c,5),y:A(y,5),type:p,[p]:f}),o(),i&&E.event(_.ADD_STATION,{type:p}),e(j(new Set([g])))}else"free"===h||h.startsWith("line")?(h.startsWith("line")&&(e(v("free")),P&&e(V(!1))),pe({x:s,y:a}),me(u),r.shiftKey||(e(w("background")),e(W()))):"select"===h&&(te(I(s,a,d,u)),ye(I(s,a,d,u)))})),be=ce((t=>{if("select"===h){if(0!=ee.x&&0!=ee.y){const{x:e,y:n}=b(t);ye(I(e,n,d,u))}}else if("background"===x){const{x:n,y:r}=b(t);e(K({x:fe.x+(ge.x-n)*d/100,y:fe.y+(ge.y-r)*d/100}))}})),we=ce((t=>{if("select"===h){const{x:r,y:o}=b(t),{x:s,y:i}=I(r,o,d,u),a=Z(n.current,ee.x,ee.y,s,i),l=ie(n.current,new Set(a));e(j(new Set([...t.shiftKey?m:[],...a,...l]))),e(v("free")),te({x:0,y:0}),ye({x:0,y:0})}"background"!==x||t.shiftKey||e(w(void 0))})),je=ce((t=>{let n=d;t.deltaY>0&&d+10<400?n=d+10:t.deltaY<0&&d-10>0&&(n=d-10),e(U(n));const{x:r,y:o}=b(t),s=t.currentTarget.getBoundingClientRect(),[i,a]=[r/s.width,o/s.height];e(K({x:u.x+r*d/100-T*n/100*i,y:u.y+o*d/100-H*n/100*a}))})),Pe=ce((async t=>{if(R?"Backspace"===t.key:"Delete"===t.key)m.size>0&&(m.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),e(W()),o());else if(t.key.startsWith("Arrow")){const n=100,r=t.key.endsWith("Left")?-1:t.key.endsWith("Right")?1:0,o=t.key.endsWith("Up")?-1:t.key.endsWith("Down")?1:0;e(K(I(n*r,n*o,d,u)))}else if("i"===t.key||"j"===t.key||"k"===t.key||"l"===t.key){const e=10,r=("j"===t.key?-1:"l"===t.key?1:0)*e,s=("i"===t.key?-1:"k"===t.key?1:0)*e;m.size>0&&m.forEach((e=>{n.current.hasNode(e)&&(n.current.updateNodeAttribute(e,"x",(e=>(null!=e?e:0)+r)),n.current.updateNodeAttribute(e,"y",(e=>(null!=e?e:0)+s)),o())}))}else if("f"===t.key&&y)e(v(y));else if("z"===t.key&&(R?t.metaKey&&!t.shiftKey:t.ctrlKey))R&&t.preventDefault(),e(X()),e(M()),e(N());else if("s"===t.key)e(v("select"));else if("c"!==t.key&&"x"!==t.key||!(R?t.metaKey&&!t.shiftKey:t.ctrlKey))if("v"===t.key&&(R?t.metaKey&&!t.shiftKey:t.ctrlKey)){const t=await navigator.clipboard.readText(),{x:r,y:s}=I(T/2,H/2,d,u),{nodes:i,edges:a}=ue(t,n.current,Q,J,A(r,5),A(s,5));o();const l=structuredClone(i);a.forEach((e=>l.add(e))),e(j(l))}else(R&&"z"===t.key&&t.metaKey&&t.shiftKey||!R&&"y"===t.key&&t.ctrlKey)&&(e(Y()),e(M()),e(N()));else{const r=de(n.current,m);navigator.clipboard.writeText(r),"x"===t.key&&(e(W()),m.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),o())}})),[ke,Ae]=le.useState(0),$e=ce((t=>{if(2===t.touches.length){e(w(void 0));const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];Ae(n*n+r*r)}})),ze=ce((t=>{if(0!==ke&&2===t.touches.length){const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],o=n*n+r*r;let s=d;o-ke<0&&d+10<=390?s=d+10:o-ke>0&&d-10>=10&&(s=d-10),e(U(s)),Ae(o);const i=t.currentTarget.getBoundingClientRect(),[a,l]=[(t.touches[0].clientX+t.touches[1].clientX)/2-i.left,(t.touches[0].clientY+t.touches[1].clientY)/2-i.top],[c,h]=[a/i.width,l/i.height];e(K({x:u.x+a*d/100-T*s/100*c,y:u.y+l*d/100-H*s/100*h}))}})),Se=ce((e=>{0!==ke&&Ae(0)})),[De,Ee]=le.useState({sx:0,sy:0,ex:0,ey:0});return le.useEffect((()=>{Ee({sx:ee.x<=ae.x?ee.x:ae.x,ex:ee.x>ae.x?ee.x:ae.x,sy:ee.y<=ae.y?ee.y:ae.y,ey:ee.y>ae.y?ee.y:ae.y})}),[ae.x,ae.y]),r.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,left:40,userSelect:"none",touchAction:"none"},height:H,width:T,viewBox:`${u.x} ${u.y} ${T*d/100} ${H*d/100}`,onPointerDown:ve,onPointerMove:be,onPointerUp:we,onTouchStart:$e,onTouchMove:ze,onTouchEnd:Se,onWheel:je,tabIndex:0,onKeyDown:Pe,children:[c&&r.jsx(Ne,{svgViewBoxMin:u,svgViewBoxZoom:d,svgWidth:T,svgHeight:H}),r.jsx(se,{children:r.jsx(Me,{})}),"select"===h&&0!=ee.x&&0!=ee.y&&r.jsx("rect",{x:De.sx,y:De.sy,width:De.ex-De.sx,height:De.ey-De.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),r.jsx("defs",{children:r.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[r.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),r.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})}))}}}))}();
